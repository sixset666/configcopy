
////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ СЕРВЕР

&НаСервере
Процедура ИзменитьПараметрыИзбранного(СтруктураПараметров)
	
	ОтчетОбъект = РеквизитФормыВЗначение("Отчет");
	//Избранное = Обработки.Избранное.Создать();
	Менеджер = "Отчеты." + ОтчетОбъект.Метаданные().Имя;
	СтруктураПараметров.Вставить("ИмяОтчета", ОтчетОбъект.Метаданные().Имя);
	
	НаименованиеОтчета = ЗаголовокОтчета;
	Если ЕстьНачалоПериода И ЕстьКонецПериода Тогда
		ПериодСтрокой = ПредставлениеПериода(НачалоПериода, КонецДня(КонецПериода), "ФП=Истина");
		НаименованиеОтчета = "Отчет - " + НаименованиеОтчета + " (" + ПериодСтрокой + ")";
	ИначеЕсли ЕстьКонецПериода Тогда
		ПериодСтрокой = Формат(КонецПериода, "ДЛФ=DD");
		НаименованиеОтчета = "Отчет - " + НаименованиеОтчета + " (" + ПериодСтрокой + ")";
	Иначе
		НаименованиеОтчета = "Отчет - " + НаименованиеОтчета;
	КонецЕсли;
	
	СтруктураПараметров.Вставить("Наименование", НаименованиеОтчета);
	СтруктураПараметров.Вставить("Менеджер",     Менеджер);
	
КонецПроцедуры // ИзменитьПараметрыИзбранного()

&НаСервереБезКонтекста
// Процедура сохраняет настройки формы.
//
Процедура СохранитьНастройкиФормы(ИмяФормы, СтруктураНастроек)
	
	ХранилищеНастроекДанныхФорм.Сохранить(ИмяФормы, "СтруктураНастроек", СтруктураНастроек);
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗаполнитьНастройку(Элемент, СтруктураНастроек, ИмяПоля)
	
	Если СтруктураНастроек.Свойство(ИмяПоля) Тогда
		Элемент = СтруктураНастроек[ИмяПоля];
	КонецЕсли;
	
КонецПроцедуры

// Процедура загружает настройки формы.
//
&НаСервере
Процедура ЗагрузитьНастройкиФормы()
	
	СтруктураНастроек = ХранилищеНастроекДанныхФорм.Загрузить(ИмяФормыОтчета, "СтруктураНастроек");
	Если ТипЗнч(СтруктураНастроек) = Тип("Структура") Тогда
		
		ЗаполнитьНастройку(ЭтаФорма.КлючТекущегоВарианта,  СтруктураНастроек, "КлючТекущегоВарианта");
		ЗаполнитьНастройку(ЭтаФорма.ТекстВариантНастройки, СтруктураНастроек, "ТекстВариантНастройки");
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ИнициализироватьСКД()
	
	Отчет.КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СхемаКомпоновки));
	
КонецПроцедуры

//////////////////////////////////////////////////////////////////////////////////
//// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ КЛИЕНТ

&НаСервере
Процедура ОбновитьОтображениеФормы()
	
	СтруктураОграничений = Неопределено;
	ОтчетОбъект = РеквизитФормыВЗначение("Отчет");
	
	Попытка
		СтруктураОграничений = ОтчетОбъект.ПолучениеОграниченийНастроек();
	Исключение
	КонецПопытки;
	
	Если ТипЗнч(СтруктураОграничений) = Тип("Структура") Тогда
		
		ОграниченияНастроек.Очистить();
		Для Каждого ТекЭлемент Из СтруктураОграничений Цикл
			ОграниченияНастроек.Добавить(ТекЭлемент.Ключ);
		КонецЦикла;
		
		Если СтруктураОграничений.Свойство("Группировки") Тогда
			Элементы.ГруппаСтроки.Видимость            = Ложь;
			Элементы.ГруппаКолонки.Видимость           = Ложь;
			Элементы.КоманднаяПанельТаблицы.Видимость  = Ложь;
			Элементы.КоманднаяПанельСтраницы.Видимость = Ложь;
			Элементы.ДобавитьТаблицу.Видимость         = Ложь;
			Элементы.СтруктураТаблицы.Видимость        = Ложь;
		КонецЕсли;
		
		Если СтруктураОграничений.Свойство("Показатели") Тогда
			Элементы.ГруппаПоказатели.Видимость = Ложь;
		КонецЕсли;
		
		Если СтруктураОграничений.Свойство("Порядок") Тогда
			Элементы.КомпоновщикНастроекНастройкиПорядок.Видимость = Ложь;
		КонецЕсли;
		
		Если СтруктураОграничений.Свойство("РежимВыводаОтчета") Тогда
			Элементы.ГруппаВидТаблицы.Видимость = Ложь;
		КонецЕсли;
		
		Если СтруктураОграничений.Свойство("Колонки") Тогда
			Элементы.ГруппаКолонки.Видимость = Ложь;
			ОтключеныКолонки                 = Истина;
		КонецЕсли;
		
		//Если СтруктураОграничений.Свойство("ДопГруппировки") Тогда
		//	/Элементы.ИзмеренияСтрокиГруппировки.Видимость = Ложь;
		//КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// КОМАНДЫ ПАНЕЛЕЙ ФОРМЫ

&НаСервереБезКонтекста
Функция ПолучитьВариант(КлючОтчета, КлючВарианта)
	
	Результат = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьВариантОтчета(КлючОтчета, КлючВарианта);
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура КомандаСоздатьРассылку(Команда)
	
	ФормаРассылки = ПолучитьФорму("Справочник.РассылкиОтчетов.Форма.ФормаЭлемента", ,ЭтаФорма);
	ВариантОтчета = ПолучитьВариант(ЭтаФорма.КлючОтчета, ЭтаФорма.КлючТекущегоВарианта);
	ФормаРассылки.ДобавитьНовыйОтчет(ВариантОтчета);
	ФормаРассылки.Открыть();
	
КонецПроцедуры


//////////////////////////////////////////////////////////////////////////////////
//// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ФОРМЫ ОТЧЕТА

////&НаКлиенте
////Процедура КомпоновщикНастроекНастройкиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
////	
////	Если Поле.Имя = "ДопПоля" ИЛИ Поле.Имя = "Порядок" ИЛИ Поле.Имя = "УсловноеОформление" ИЛИ Поле.Имя = "ПараметрыВывода" Тогда
////		
////		СтандартнаяОбработка = Ложь;
////		
////		СтруктураПараметров = Новый Структура();
////		СтруктураПараметров.Вставить("Событие",         Поле.Имя);
////		СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
////		СтруктураПараметров.Вставить("НастройкиОтчета", ОтчетыСервер.КомпоновщикПолучитьНастройки(Отчет.КомпоновщикНастроек));
////		СтруктураПараметров.Вставить("ТекущаяСтрока",   Элемент.ТекущаяСтрока);
////		
////		ФормаВыбора = ПолучитьФорму("ОбщаяФорма.ОтчетРедактированиеВыбранныхПолей", СтруктураПараметров, Элемент);
////		
////		Рез = ФормаВыбора.ОткрытьМодально();
////		Если Рез = КодВозвратаДиалога.ОК Тогда
////			Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(ФормаВыбора.КомпоновщикНастроек.Настройки);
////		КонецЕсли;
////		
////	КонецЕсли;
////	
////КонецПроцедуры

//&НаКлиенте
//Процедура ТекстВариантНастройкиНачалоВыбораИзСписка(Элемент, СтандартнаяОбработка)
//	
//	СтандартнаяОбработка = Ложь;
//	ТекПозиция = Элемент.СписокВыбора.НайтиПоЗначению(ЭтаФорма.КлючТекущегоВарианта);
//	ВыбранноеЗначение = ВыбратьИзСписка(Элемент.СписокВыбора, Элемент, ТекПозиция);
//	Если НЕ ВыбранноеЗначение = Неопределено Тогда
//		ЭтаФорма.КлючТекущегоВарианта          = ВыбранноеЗначение.Значение;
//		ЭтаФорма.ТекстВариантНастройки         = ВыбранноеЗначение.Представление;
//		ЭтаФорма.ПредставлениеТекущегоВарианта = ВыбранноеЗначение.Представление;
//		ИзменитьВариантОтчета();
//		ПолучитьДанныеИзСКД(Ложь);
//	КонецЕсли;
//	
//КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии()
	
	СтруктураНастроек = Новый Структура;
	СтруктураНастроек.Вставить("КлючТекущегоВарианта",  ЭтаФорма.КлючТекущегоВарианта);
	СтруктураНастроек.Вставить("ТекстВариантНастройки", ЭтаФорма.ТекстВариантНастройки);
	
	СохранитьНастройкиФормы(ИмяФормыОтчета, СтруктураНастроек);
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	Модифицированность   = Ложь;
	Попытка
		ВариантМодифицирован = Ложь;
	Исключение
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСправка(Команда)
	
	//ОткрытьСправку(Отчет.
	//СтрЗаменить(ЭтаФорма.ИмяФормыОтчета, ".Форма", "")
	ОткрытьСправку(СтрЗаменить(ЭтаФорма.ИмяФормыОтчета, ".Форма", ""));
	//ава = 3;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаДобавитьВИзбранное(Команда)
	
	ОбновитьНастройкиСКД();
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("КлючВарианта",          ЭтаФорма.КлючТекущегоВарианта);
	СтруктураПараметров.Вставить("ПредставлениеВарианта", ЭтаФорма.ПредставлениеТекущегоВарианта);
	СтруктураПараметров.Вставить("Вариант",               ОтчетыСервер.КомпоновщикПолучитьНастройки(Отчет.КомпоновщикНастроек));
	СтруктураПараметров.Вставить("ИмяФормыОтчета",        ЭтаФорма.ИмяФормыОтчета);
	ИзменитьПараметрыИзбранного(СтруктураПараметров);
	
	Форма = ПолучитьФорму("Обработка.Избранное.Форма.ДобавитьВИзбранное");
	Форма.ПараметрОбъект   = СтруктураПараметров;
	Форма.ПараметрТип      = СтруктураПараметров.Менеджер;
	Форма.ПараметрИмяФормы = СтруктураПараметров.ИмяФормыОтчета;
	
	Форма.ОткрытьМодально();
	
КонецПроцедуры

&НаКлиенте
Процедура ОформлениеТаблицы(Команда)
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ВременныеНастройки = Отчет.КомпоновщикНастроек.ПолучитьНастройки();
	
	ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ВременныеНастройки.УсловноеОформление.Элементы, ТекущиеДанные.УсловноеОформление.Элементы);
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	СтруктураПараметров.Вставить("НастройкиОтчета", ВременныеНастройки);
	
	ФормаНастройки = ПолучитьФорму("ОбщаяФорма.ОтчетНастройкаУсловногоОформления", СтруктураПараметров, ЭтаФорма);
	
	Рез = ФормаНастройки.ОткрытьМодально();
	Если Рез = КодВозвратаДиалога.ОК Тогда
		//Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(ФормаНастройки.КомпоновщикНастроек.Настройки);
		ТекущиеДанные.УсловноеОформление = ФормаНастройки.КомпоновщикНастроек.Настройки.УсловноеОформление;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПользовательскиеПоля(Команда)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	СтруктураПараметров.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
	
	ФормаНастройки = ПолучитьФорму("ОбщаяФорма.ОтчетНастройкаПользовательскихПолей", СтруктураПараметров, ЭтаФорма);
	
	Рез = ФормаНастройки.ОткрытьМодально();
	Если Рез = КодВозвратаДиалога.ОК Тогда
		Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(ФормаНастройки.КомпоновщикНастроек.Настройки);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПараметрыТаблицы(Команда)
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ВременныеНастройки = Отчет.КомпоновщикНастроек.ПолучитьНастройки();
	ВременныеНастройки.Структура.Очистить();
	
	Если ТекущиеДанные.ВидТаблицы = "Таблица" Тогда
		ТаблицаСКД = ВременныеНастройки.Структура.Добавить(Тип("ТаблицаКомпоновкиДанных"));
	ИначеЕсли ТекущиеДанные.ВидТаблицы = "Диаграмма" Тогда
		ТаблицаСКД = ВременныеНастройки.Структура.Добавить(Тип("ДиаграммаКомпоновкиДанных"));
	Иначе
		ТаблицаСКД = ВременныеНастройки.Структура.Добавить(Тип("ТаблицаКомпоновкиДанных"));
	КонецЕсли;
	
	ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ТаблицаСКД.ПараметрыВывода.Элементы, ТекущиеДанные.ПараметрыВывода.ПолучитьЭлементы());
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	СтруктураПараметров.Вставить("НастройкиОтчета", ВременныеНастройки);
	//СтруктураПараметров.Вставить("ВидТаблицы",      ТекущиеДанные.ВидТаблицы);
	СтруктураПараметров.Вставить("ЭтоТаблица",      Истина);
	
	ФормаНастройки = ПолучитьФорму("ОбщаяФорма.ОтчетНастройкаПараметровВывода", СтруктураПараметров, ЭтаФорма);
	
	Рез = ФормаНастройки.ОткрытьМодально();
	Если Рез = КодВозвратаДиалога.ОК Тогда
		ПараметрыВывода = ФормаНастройки.КомпоновщикНастроек.Настройки.Структура[0].ПараметрыВывода;
		
		ОтчетыКлиентСервер.ЗаполнитьНастройкиОтчета(ЭтаФорма, ТекущиеДанные.ПараметрыВывода.ПолучитьЭлементы(), ПараметрыВывода, Отчет.КомпоновщикНастроек.Настройки.ПараметрыВывода.ДоступныеПараметры);
		
		ПараметрОформления = ПараметрыВывода.Элементы.Найти("РасположениеРеквизитов");
		Если (НЕ ПараметрОформления = Неопределено) И ПараметрОформления.Использование Тогда
			ТекущиеДанные.РеквизитыОтдельно = Истина;
			Элементы.ТаблицаРеквизитыОтдельно.Пометка = Истина;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаДобавитьПользовательскоеПоле(Команда)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("СхемаКомпоновки",               СхемаКомпоновки);
	СтруктураПараметров.Вставить("НастройкиОтчета",               Отчет.КомпоновщикНастроек.ПолучитьНастройки());
	СтруктураПараметров.Вставить("ЗакрыватьПриВыборе",            Истина);
	СтруктураПараметров.Вставить("ЗакрыватьПриЗакрытииВладельца", Истина);
	
	ФормаНастройки = ПолучитьФорму("ОбщаяФорма.ОтчетНастройкаПользовательскихПолей", СтруктураПараметров, Элементы.КомпоновщикНастроекНастройкиВыбор);
	
	Рез = ФормаНастройки.ОткрытьМодально();
	Если Рез = КодВозвратаДиалога.ОК Тогда
		ТекущаяСтрока = ФормаНастройки.Элементы.ПользовательскиеПоля.ТекущаяСтрока;
		Если ТипЗнч(ТекущаяСтрока) = Тип("ИдентификаторКомпоновкиДанных") Тогда
			ПользовательскоеПоле = Отчет.КомпоновщикНастроек.Настройки.ПользовательскиеПоля.ПолучитьОбъектПоИдентификатору(ТекущаяСтрока);
			Если ПользовательскоеПоле = Неопределено Тогда
				// Значит еще не перетянули настройки СКД
				Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(ФормаНастройки.КомпоновщикНастроек.Настройки);
				ПользовательскоеПоле = Отчет.КомпоновщикНастроек.Настройки.ПользовательскиеПоля.ПолучитьОбъектПоИдентификатору(ТекущаяСтрока);
			КонецЕсли;
			НовыйПоказатель = Отчет.КомпоновщикНастроек.Настройки.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
			НовыйПоказатель.Использование = Истина;
			НовыйПоказатель.Поле          = Новый ПолеКомпоновкиДанных(ПользовательскоеПоле.ПутьКДанным);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриСохраненииВариантаНаСервере(Настройки)
	
	ОбновитьНастройкиСКД();
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьНастройкиПоУмолчаниюНаСервере(КлючВариантаОтчета)
	
	Если КлючВариантаОтчета = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СхемаКомпоновкиДанных = ПолучитьИзВременногоХранилища(СхемаКомпоновки);
	
	РежимТолькоЭксперт = Ложь;
	ТиповойВариантНастроек = СхемаКомпоновкиДанных.ВариантыНастроек.Найти(КлючВариантаОтчета);
	
	Если ТиповойВариантНастроек = Неопределено Тогда
		// Пользовательский вариант настроек
		Настройки = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьНастройки(КлючОтчета, КлючВариантаОтчета);
		Если НЕ Настройки = Неопределено Тогда
			Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
			ОбновитьНастройкиОтчета(Отчет.КомпоновщикНастроек.Настройки);
		КонецЕсли;
	Иначе
		Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(ТиповойВариантНастроек.Настройки);
		ОбновитьНастройкиОтчета(Отчет.КомпоновщикНастроек.Настройки);
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ВариантПредопределенный(ВариантОтчета)
	
	Возврат ВариантОтчета.ЭтоПредопределенный;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьСписокПредопределенныхВариантовОтчета(КлючОтчета)
	
	Результат = Новый СписокЗначений;
	
	СписокВариантов = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьСписок(КлючОтчета,,,Истина);
	Для Каждого ТекЭлемент Из СписокВариантов Цикл
		Результат.Добавить(ТекЭлемент.Значение, ТекЭлемент.Представление);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура КомандаЗагрузитьНастройкиПоУмолчанию(Команда)
	
	ВариантОтчета = ПолучитьВариант(ЭтаФорма.КлючОтчета, ЭтаФорма.КлючТекущегоВарианта);
	
	Если ВариантПредопределенный(ВариантОтчета) Тогда
		КлючВариантаОтчета = ВариантОтчета.КлючВарианта;
	Иначе
		СписокВариантов = ПолучитьСписокПредопределенныхВариантовОтчета(ЭтаФорма.КлючОтчета);
		ВариантОтчета = СписокВариантов.ВыбратьЭлемент("Предопределенные настройки");
		Если ВариантОтчета = Неопределено Тогда
			Возврат;
		Иначе
			КлючВариантаОтчета = ВариантОтчета.Значение;
		КонецЕсли;
	КонецЕсли;
	
	ЗагрузитьНастройкиПоУмолчаниюНаСервере(КлючВариантаОтчета);
	
КонецПроцедуры

&НаКлиенте
Процедура КомпоновщикНастроекНастройкиОтборПриАктивизацииСтроки(Элемент)
	
	ПодключитьОбработчикОжидания("ОбработчикОжиданияКомпоновщикНастроекНастройкиОтборПриАктивизацииСтроки",0.1, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура КомпоновщикНастроекНастройкиОтборЛевоеЗначениеПриИзменении(Элемент)
	
	ОбработчикОжиданияКомпоновщикНастроекНастройкиОтборПриАктивизацииСтроки();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработчикОжиданияКомпоновщикНастроекНастройкиОтборПриАктивизацииСтроки()
	
	ТекущиеДанные = Элементы.КомпоновщикНастроекНастройкиОтбор.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено ИЛИ ТекущиеДанные.ЛевоеЗначение = Неопределено ИЛИ СокрЛП(ТекущиеДанные.ЛевоеЗначение) = "" Тогда
		Возврат;
	КонецЕсли;
	
	Если ИдентификаторОтбора = Строка(Элементы.КомпоновщикНастроекНастройкиОтбор.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	
	ИдентификаторОтбора = Элементы.КомпоновщикНастроекНастройкиОтбор.ТекущаяСтрока;
	
	ДоступноеПолеОтбора = Отчет.КомпоновщикНастроек.Настройки.Отбор.ДоступныеПоляОтбора.НайтиПоле(ТекущиеДанные.ЛевоеЗначение);
	
	Если ДоступноеПолеОтбора = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ДоступноеПолеОтбора.ТипЗначения.СодержитТип(Тип("СправочникСсылка.ЗначенияСвойств")) Тогда
		
		ЗначениеВладельца = ОтчетыСервер.ПолучитьВладельцаЗначенияСвойств(ТекущиеДанные.ЛевоеЗначение);
		
		НовыйПараметр = Новый ПараметрВыбора("Отбор.Владелец", ЗначениеВладельца);
		НовыйМассив = Новый Массив();
		НовыйМассив.Добавить(НовыйПараметр);
		Элементы.КомпоновщикНастроекНастройкиОтборПравоеЗначение.ПараметрыВыбора = Новый ФиксированныйМассив(НовыйМассив);
		
	Иначе
		
		ТипЗначенияОтбора = ДоступноеПолеОтбора.ТипЗначения.Типы()[0];
		СписокВладельцев  = ОтчетыСервер.ПолучитьСписокВладельцев(Отчет.КомпоновщикНастроек.ПолучитьНастройки(), ТипЗначенияОтбора);
		
		Если СписокВладельцев.Количество()=0 Тогда
			Возврат;
		КонецЕсли;
		
		НовыйПараметр = Новый ПараметрВыбора("Отбор.Владелец", СписокВладельцев[0].Значение);
		НовыйМассив = Новый Массив();
		НовыйМассив.Добавить(НовыйПараметр);
		Элементы.КомпоновщикНастроекНастройкиОтборПравоеЗначение.ПараметрыВыбора = Новый ФиксированныйМассив(НовыйМассив);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КомпоновщикНастроекНастройкиОтборПравоеЗначениеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ТекущаяСтрока = Элементы.КомпоновщикНастроекНастройкиОтбор.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные = Отчет.КомпоновщикНастроек.Настройки.Отбор.ПолучитьОбъектПоИдентификатору(ТекущаяСтрока);
	
	Если ОтчетыСервер.ОтборПоСписку(ТекущиеДанные.ВидСравнения) И Элемент.ПараметрыВыбора.Количество()>0 Тогда
		
		ЗначениеВладельца = Неопределено;
		Для Каждого ЭлементМассива Из Элемент.ПараметрыВыбора Цикл
			Если ЭлементМассива.Имя = "Отбор.Владелец" Тогда
				ЗначениеВладельца = ЭлементМассива.Значение;
			КонецЕсли;
		КонецЦикла;
		
		Если ЗначениеВладельца = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		СтандартнаяОбработка = Ложь;
		Если ТекущиеДанные.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСпискеПоИерархии ИЛИ
			ТекущиеДанные.ВидСравнения = ВидСравненияКомпоновкиДанных.НеВСпискеПоИерархии Тогда
			ТолькоГруппы = Истина;
		Иначе
			ТолькоГруппы = Ложь;
		КонецЕсли;
		
		ДоступноеПолеОтбора = Отчет.КомпоновщикНастроек.Настройки.Отбор.ДоступныеПоляОтбора.НайтиПоле(ТекущиеДанные.ЛевоеЗначение);
		
		СтруктураПараметров = Новый Структура("СписокВыбора, ТипЗначения, ДоступныеЗначения, ТолькоГруппы, ПараметрОтборПоВладельцу", ТекущиеДанные.ПравоеЗначение, ДоступноеПолеОтбора.ТипЗначения, ДоступноеПолеОтбора.ДоступныеЗначения, ТолькоГруппы, ЗначениеВладельца);
		
		ФормаВыбора = ПолучитьФорму("ОбщаяФорма.ОтчетВыборЗначенияОтбораИзСписка", СтруктураПараметров, Элемент);
		Рез = ФормаВыбора.ОткрытьМодально();
		
		Если НЕ Рез = Неопределено Тогда
			ТекущиеДанные.ПравоеЗначение = Рез;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФормуЭксперта()
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("КлючОтчета",     КлючОтчета);
	СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	СтруктураПараметров.Вставить("ЗаголовокОтчета", Заголовок);
	СтруктураПараметров.Вставить("КлючВарианта",          СокрЛП(ЭтаФорма.КлючТекущегоВарианта));
	СтруктураПараметров.Вставить("ПредставлениеВарианта", СокрЛП(ЭтаФорма.ПредставлениеТекущегоВарианта));
	СтруктураПараметров.Вставить("Вариант",               ОтчетыСервер.КомпоновщикПолучитьНастройки(Отчет.КомпоновщикНастроек));
	//СтруктураПараметров.Вставить("ЗаполнитьНастроки",     Ложь);
	//СтруктураПараметров.Вставить("СхемаКомпоновки",        СхемаКомпоновки);
	СтруктураПараметров.Вставить("НачалоПериода",         НачалоПериода);
	СтруктураПараметров.Вставить("КонецПериода",          КонецДня(КонецПериода));
	СтруктураПараметров.Вставить("ВидПериода",            ВидПериода);
	
	ОписаниеОповещенияИзмененияНастроек = Новый ОписаниеОповещения("ОповещениеИзмененияНастроек", ЭтаФорма.ВладелецФормы);
	
	ОткрытьФорму(СтрЗаменить(ИмяФормы, ".ФормаНастроек", ".ФормаВарианта"), СтруктураПараметров, Этаформа.ВладелецФормы,,,, ОписаниеОповещенияИзмененияНастроек, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
	Закрыть();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьНастройкиОтчета(НастройкиОтчета, ИзменениеВарианта = Истина)
	
	ЕстьНачалоПериода = Ложь;
	ЕстьКонецПериода  = Ложь;
	
	Счетчик = 0;
	Для Каждого ТекущийПараметр Из НастройкиОтчета.ПараметрыДанных.Элементы Цикл
		
		ИмяПараметра = СокрЛП(ТекущийПараметр.Параметр);
		Если ИмяПараметра = "ДатаНачала" ИЛИ ИмяПараметра = "НачалоПериода" Тогда
			ЕстьНачалоПериода = (ТекущийПараметр.Использование ИЛИ ЕстьНачалоПериода);
			Продолжить;
		КонецЕсли;
		
		Если ИмяПараметра = "ДатаОкончания" ИЛИ ИмяПараметра = "ДатаОкончанияГраница" ИЛИ ИмяПараметра = "Период" ИЛИ ИмяПараметра = "КонецПериода" Тогда
			// Начальная дата не бывает без конечной
			ЕстьКонецПериода = (ТекущийПараметр.Использование ИЛИ ЕстьКонецПериода ИЛИ ЕстьНачалоПериода);
			Продолжить;
		КонецЕсли;
		
		Счетчик = Счетчик + 1;
		
	КонецЦикла;
	
	Элементы.ПараметрыДанных.Видимость = (Счетчик>0);
	
	Если ИзменениеВарианта Тогда
		ВидПериода = "Произвольный";
		
		ВариантЗагрузкиПериода = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьВариантПериода(КлючОтчета, КлючТекущегоВарианта);
		
		Если ВариантЗагрузкиПериода = "" Тогда
			Попытка
				МенеджерОтчета = Отчеты[СтрЗаменить(КлючОтчета, "Отчет.", "")];
				Результат = МенеджерОтчета.ПолучитьВариантПериода();
				Если ТипЗнч(Результат) = Тип("ВариантСтандартногоПериода") Тогда
					Если Результат = ВариантСтандартногоПериода.ПроизвольныйПериод Тогда
						Результат = "ВариантСтандартногоПериода.ЭтотМесяц";
					Иначе
						Результат = ПолучитьПолноеИмяПредопределенногоЗначения(Результат);
					КонецЕсли;
				КонецЕсли;
				ВариантЗагрузкиПериода = Результат;
			Исключение
				ВариантЗагрузкиПериода = "ВариантСтандартногоПериода.ЭтотМесяц";
			КонецПопытки;
		КонецЕсли;
		
		Если НЕ ВариантЗагрузкиПериода = "ВариантСтандартногоПериода.ПроизвольныйПериод" Тогда
			СтандартныйПериодОтчета = Новый СтандартныйПериод(ПредопределенноеЗначение(ВариантЗагрузкиПериода));
			НачалоПериода = СтандартныйПериодОтчета.ДатаНачала;
			КонецПериода  = СтандартныйПериодОтчета.ДатаОкончания;
		КонецЕсли;
		
		Если Элементы.ПараметрыДанных.Видимость Тогда
			ОтчетОбъект = РеквизитФормыВЗначение("Отчет");
			Попытка
				ОтчетОбъект.ПриИзмененииВарианта(ЭтаФорма);
			Исключение
			КонецПопытки;
		КонецЕсли;
		
		ОтчетыКлиентСервер.ОбновитьВариантыПериодов(ЭтаФорма);
		ОтчетыКлиентСервер.УстановитьПометкуНаПериод(ЭтаФорма, "Период"+ВидПериода);
	КонецЕсли;
	
	ОтчетыСервер.ОбновитьНастройкиОтчета(Этаформа, НастройкиОтчета, РежимТолькоЭксперт);
	
КонецПроцедуры

&НаКлиенте
Процедура РежимЭксперта(Команда)
	
	ОбновитьНастройкиСКД();
	ОткрытьФормуЭксперта();
	
КонецПроцедуры

&НаСервере
Процедура ВыбратьВидТаблицы(ВидТаблицы, НомерТаблицы)
	
	ОтчетыСервер.ВыбратьВидТаблицы(ЭтаФорма, ВидТаблицы, НомерТаблицы);
	
КонецПроцедуры // ВыбратьВидТаблицы()

Процедура СтраницыПриСменеСтраницыНаСервере()
	
	ТекущаяСтраница = Элементы.Страницы.ТекущаяСтраница;
	
	Если ТекущаяСтраница = Элементы.ДобавитьТаблицу Тогда
		ОтчетыСервер.ДобавитьТаблицуОтчета(ЭтаФорма);
	Иначе
		ИдентификаторТаблицы = Элементы.Страницы.ТекущаяСтраница.Имя;
		Если ИдентификаторТаблицы = "СтраницаШаблон" Тогда
			ИдентификаторТаблицы = "";
		КонецЕсли;
		ИндексСтраницы = Элементы.Страницы.ПодчиненныеЭлементы.Индекс(ТекущаяСтраница);
		ОтчетыСервер.ПереместитьТаблицуОтчета(ЭтаФорма, ИндексСтраницы);
	КонецЕсли;
	
	СтрокиТаблицы = СписокТаблиц.НайтиСтроки(Новый Структура("Идентификатор", ИдентификаторТаблицы));
	Если СтрокиТаблицы.Количество()>0 Тогда
		ТекущаяСтрока = СтрокиТаблицы[0];
		Элементы.СписокТаблиц.ТекущаяСтрока = ТекущаяСтрока.ПолучитьИдентификатор();
		ВыбратьВидТаблицы(ТекущаяСтрока.ВидТаблицы, ТекущаяСтрока.НомерТаблицы);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ВыбратьВариантНаСервере(ИмяВарианта)
	
	ОтчетыСервер.УстановитьЗаголовокВарианта(ЭтаФорма, ИмяВарианта);
	
	СхемаКомпоновкиДанных = ПолучитьИзВременногоХранилища(СхемаКомпоновки);
	
	//ВидПериода = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьВидПериода(КлючОтчета, КлючТекущегоВарианта);
	//ВидПериода = "Произвольный";
	
	РежимТолькоЭксперт = Ложь;
	ТиповойВариантНастроек = СхемаКомпоновкиДанных.ВариантыНастроек.Найти(ЭтаФорма.КлючТекущегоВарианта);
	Если ТиповойВариантНастроек = Неопределено Тогда
		// Пользовательский вариант настроек
		Настройки = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьНастройки(КлючОтчета, КлючТекущегоВарианта);
		Если НЕ Настройки = Неопределено Тогда
			Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
			ОбновитьНастройкиОтчета(Отчет.КомпоновщикНастроек.Настройки);
		КонецЕсли;
	Иначе
		Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(ТиповойВариантНастроек.Настройки);
		ОбновитьНастройкиОтчета(Отчет.КомпоновщикНастроек.Настройки);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьВариант(Команда)
	
	КлючВарианта = КлючТекущегоВарианта;
	
	ИмяВарианта = СтрЗаменить(Команда.Имя, Команда.Действие, "");
	
	ВариантНастроек = ТаблицаВариантов.НайтиСтроки(Новый Структура("Имя", ИмяВарианта));
	Если ВариантНастроек.Количество()>0 Тогда
		КлючТекущегоВарианта          = ВариантНастроек[0].Идентификатор;
		ПредставлениеТекущегоВарианта = ВариантНастроек[0].Представление;
	КонецЕсли;
	
	ВыбратьВариантНаСервере(ИмяВарианта);
	
	//Если РежимТолькоЭксперт Тогда
	//	
	//	ДополнительныеПараметры = Новый Структура;
	//	ДополнительныеПараметры.Вставить("КлючВарианта", КлючВарианта);
	//	
	//	Оповещение = Новый ОписаниеОповещения("ВопросВыбораВариантаЗавершение", ЭтаФорма, ДополнительныеПараметры);
	//	ПоказатьВопрос(Оповещение, "Данный вариант отчета доступен только в режиме ""Эксперт"". 
	//	|Перейти в форму эксперта?", РежимДиалогаВопрос.ДаНет,,КодВозвратаДиалога.Нет);
	//	
	//КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВопросВыбораВариантаЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		ОткрытьФормуЭксперта();
	Иначе
		КлючТекущегоВарианта = ДополнительныеПараметры.КлючВарианта;
		
		ВариантНастроек = ТаблицаВариантов.НайтиСтроки(Новый Структура("Идентификатор", КлючТекущегоВарианта));
		Если ВариантНастроек.Количество()>0 Тогда
			ПредставлениеТекущегоВарианта = ВариантНастроек[0].Представление;
			ИмяВарианта                   = ВариантНастроек[0].Имя;
			
			ВыбратьВариантНаСервере(ИмяВарианта);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;
	КонецЕсли;
	
	Если Параметры.Свойство("КлючОтчета") Тогда
		
		КлючОтчета = Параметры.КлючОтчета;
		СхемаКомпоновки     = Параметры.СхемаКомпоновки;
		Заголовок       = "Настройки отчета: " + Параметры.ЗаголовокОтчета;
		ЗаголовокОтчета = Параметры.ЗаголовокОтчета;
		
	Иначе
		
		ОтчетОбъект           = РеквизитФормыВЗначение("Отчет");
		ОтчетМетаданные       = ОтчетОбъект.Метаданные();
		КлючОтчета            = ОтчетМетаданные.ПолноеИмя();
		СхемаКомпоновкиДанных = ОтчетОбъект.СхемаКомпоновкиДанных;
		СхемаКомпоновки       = ПоместитьВоВременноеХранилище(СхемаКомпоновкиДанных, УникальныйИдентификатор);
		
		Попытка
			ОтчетОбъект.ЗаполнитьНачальныеНастройки();
		Исключение
			ОтчетыСервер.ЗаполнитьНачальныеОстатки(ОтчетОбъект);
		КонецПопытки;
		
		Заголовок       = "Настройки отчета: " + СокрЛП(ОтчетМетаданные.Представление());
		ЗаголовокОтчета = СокрЛП(ОтчетМетаданные.Представление());
		
	КонецЕсли;
	
	Если ИмяФормы = "ОбщаяФорма.ОтчетФормаНастройки" Тогда
		ИмяФормыОтчета = КлючОтчета + ".Форма";
	Иначе
		ИмяФормыОтчета = ИмяФормы;
	КонецЕсли;
	
	Если обПраво("ПроверкаДоступаКСправочникамИДокументам") Тогда
		СправочникИмя = Метаданные.Справочники.ВариантыОтчетов.Имя;
		ПравоДоступа = обПраво("Право доступа "+СправочникИмя);
		Если ПравоДоступа=Перечисления.ВидыПравДляСправочников.НетДоступа ИЛИ ПравоДоступа=Перечисления.ВидыПравДляСправочников.Чтение Тогда
			Элементы.СохранитьНастройкиОтчета.Доступность = Ложь;
		КонецЕсли;
		
		СправочникИмя=Метаданные.Справочники.РассылкиОтчетов.Имя;
		ПравоДоступа = обПраво("Право доступа "+СправочникИмя);
		Если ПравоДоступа=Перечисления.ВидыПравДляСправочников.НетДоступа ИЛИ ПравоДоступа=Перечисления.ВидыПравДляСправочников.Чтение Тогда
			Элементы.ФормаКомандаСоздатьРассылку.Доступность = Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Если Параметры.Свойство("ПредставлениеСформировать") Тогда
		//Элементы.ОсновныеДействияСформировать.Заголовок = Параметры.ПредставлениеСформировать;
		Команды.СформироватьОтчет.Заголовок = Параметры.ПредставлениеСформировать.Заголовок;
		Команды.СформироватьОтчет.Подсказка = Параметры.ПредставлениеСформировать.Подсказка;
		//СтруктураПараметров.Вставить("ПредставлениеСформировать", Новый Структура("Заголовок, Подсказка", "Изменить", "Изменить"));
		
	КонецЕсли;
	
	Параметры.Свойство("НачалоПериода", НачалоПериода);
	Параметры.Свойство("КонецПериода",  КонецПериода);
	Параметры.Свойство("ВидПериода",    ВидПериода);
	
	ИнициализироватьСКД();
	
	ОтчетыКлиентСервер.ОбновитьВариантыПериодов(ЭтаФорма);
	ОтчетыКлиентСервер.УстановитьПометкуНаПериод(ЭтаФорма, "Период"+ВидПериода);
	
	СписокВыбора = Элементы.ТипДиаграммыОтчета.СписокВыбора;
	Для Каждого ТекущийТипДиаграммы Из ТипДиаграммы Цикл
		
		ИмяТипаДиаграммы = СтрЗаменить(ПолучитьПолноеИмяПредопределенногоЗначения(ТекущийТипДиаграммы), "ТипДиаграммы.", "");
		
		Попытка
			ТекущаяКартинка = БиблиотекаКартинок[ИмяТипаДиаграммы];
		Исключение
			ТекущаяКартинка = БиблиотекаКартинок.Диаграмма;
		КонецПопытки;
		
		СписокВыбора.Добавить(ИмяТипаДиаграммы, СокрЛП(ТекущийТипДиаграммы),, ТекущаяКартинка);
		
	КонецЦикла;
	
	Для Каждого ТекМакет Из БиблиотекаМакетовОформленияКомпоновкиДанных Цикл
		
		НоваяКоманда = Команды.Найти("ТаблицаОформлениеТаблицы"+ТекМакет.Имя);
		Если НоваяКоманда = Неопределено Тогда
			НоваяКоманда = Команды.Добавить("ТаблицаОформлениеТаблицы"+ТекМакет.Имя);
			НоваяКоманда.Действие = "ТаблицаОформлениеТаблицы";
		КонецЕсли;
		
		НовоеОформление = Элементы.Добавить("Оформление"+ТекМакет.Имя, Тип("КнопкаФормы"), Элементы.ГруппаОформлениеТаблицы);
		НовоеОформление.ИмяКоманды = НоваяКоманда.Имя;
		НовоеОформление.Заголовок  = ТекМакет.Представление;
		НовоеОформление.Вид        = ВидКнопкиФормы.КнопкаКоманднойПанели;
		
	КонецЦикла;
	
	СписокВыбора = Элементы.ВидПодписей.СписокВыбора;
	Для Каждого ВидПодписи Из ВидПодписейКДиаграмме Цикл
		
		ИмяВидПодписи = ПолучитьПолноеИмяПредопределенногоЗначения(ВидПодписи);
		СписокВыбора.Добавить(ИмяВидПодписи, СокрЛП(ВидПодписи));
		
	КонецЦикла;
	
	ОбновитьОтображениеФормы();
	
КонецПроцедуры

&НаСервере
Процедура ПриЗагрузкеВариантаНаСервере(Настройки)
	
	ОбновитьНастройкиОтчета(Отчет.КомпоновщикНастроек.ПолучитьНастройки(), Ложь);
	
	ОтчетыСервер.ОбновитьСписокВариантовОтчета(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Если СокрЛП(КлючУникальности) = "" Тогда
		КлючУникальности = УникальныйИдентификатор;
	КонецЕсли;
	
	//Если РежимТолькоЭксперт Тогда
	//	ОткрытьФормуЭксперта();
	//КонецЕсли;
	
	ОграниченияИспользованияПолей = Элементы.ПараметрыДанных.ОграниченияИспользования;
	
	НовоеОграничение = ОграниченияИспользованияПолей.Добавить();
	НовоеОграничение.Параметр    = Новый ПараметрКомпоновкиДанных("ДатаНачала");
	НовоеОграничение.Доступность = Ложь;
	
	НовоеОграничение = ОграниченияИспользованияПолей.Добавить();
	НовоеОграничение.Параметр    = Новый ПараметрКомпоновкиДанных("ДатаОкончания");
	НовоеОграничение.Доступность = Ложь;
	
	НовоеОграничение = ОграниченияИспользованияПолей.Добавить();
	НовоеОграничение.Параметр    = Новый ПараметрКомпоновкиДанных("ДатаОкончанияГраница");
	НовоеОграничение.Доступность = Ложь;
	
КонецПроцедуры

#КонецОбласти

&НаСервере
// Процедура заполняет коллекцию формы из временного хранилища
//
Процедура ЗаполнитьКоллекциюИзХранилища(АдресТаблицы, МассивПутей, ИмяТаблицы = Неопределено)
	
	КоллекцияФормы = ПолучитьТекущиеДанныеПоСтруктуре(ЭтаФорма, МассивПутей);
	
	Если НЕ ИмяТаблицы = Неопределено Тогда
		КоллекцияФормы = КоллекцияФормы[ИмяТаблицы];
	КонецЕсли;
	
	Если ТипЗнч(КоллекцияФормы) = Тип("ДанныеФормыДерево") ИЛИ ТипЗнч(КоллекцияФормы) = Тип("ДанныеФормыЭлементДерева") Тогда
		КоллекцияФормы = КоллекцияФормы.ПолучитьЭлементы();
	КонецЕсли;
	
	КоллекцияФормы.Очистить();
	
	Если Не ЭтоАдресВременногоХранилища(АдресТаблицы) Тогда
		Возврат;
	КонецЕсли;
	
	ОбъектКоллекции = ПолучитьИзВременногоХранилища(АдресТаблицы);
	
	Если ТипЗнч(ОбъектКоллекции) = Тип("ДеревоЗначений") Тогда
		ОбъектКоллекции = ОбъектКоллекции.Строки;
	КонецЕсли;
	
	ОтчетыКлиентСервер.ЗаполнитьНастройкиОтчета(ЭтаФорма, КоллекцияФормы, ОбъектКоллекции);
	
КонецПроцедуры // ЗаполнитьКоллекциюИзХранилища()

&НаКлиенте
Процедура Подключаемый_ОбработкаРезультатаОповещения(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	
	Если НЕ ТипЗнч(РезультатЗакрытия) = Тип("Структура") Тогда
		Возврат;
	КонецЕсли;
	
	Если ДополнительныеПараметры = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ДополнительныеПараметры.Свойство("МассивПутей") Тогда
		ТекущиеДанные = ПолучитьТекущиеДанныеПоСтруктуре(ЭтаФорма, ДополнительныеПараметры.МассивПутей);
	Иначе
		ТекущиеДанные = Неопределено
	КонецЕсли;
	
	Если ДополнительныеПараметры.Событие = "ПоляГруппировки" Тогда
		
		ОтчетыКлиентСервер.ЗаполнитьНастройкиОтчета(ЭтаФорма, ТекущиеДанные.ПоляГруппировки, РезультатЗакрытия.ПоляГруппировки.Элементы, Отчет.КомпоновщикНастроек.Настройки.ДоступныеПоляГруппировок, ТекущиеДанные);
		
	ИначеЕсли ДополнительныеПараметры.Событие = "НоваяГруппировка" Тогда
		
		ТекущиеДанные = ТекущиеДанные[ТекущиеДанные.Количество()-1];
		
		ОтчетыКлиентСервер.ЗаполнитьНастройкиОтчета(ЭтаФорма, ТекущиеДанные.ПоляГруппировки, РезультатЗакрытия.ПоляГруппировки.Элементы, Отчет.КомпоновщикНастроек.Настройки.ДоступныеПоляГруппировок, ТекущиеДанные);
		ТекущиеДанные.КартинкаПоля  = БиблиотекаКартинок.Реквизит;
		ТекущиеДанные.Использование = Истина;
		
		//МассивПутей.Вставить("ГруппировкиКолонок", Элементы.СписокТаблиц.ТекущиеДанные.ГруппировкиКолонок.Количество());
		
		//ОбъектФормы.СписокТаблиц[0].ГруппировкиСтрок[Элементы.СписокТаблиц.ТекущиеДанные.ГруппировкиСтрок.Количество()-2].ПолучитьИдентификатор()
	//СписокТаблиц[0].ГруппировкиСтрок[Элементы.СписокТаблиц.ТекущиеДанные.ГруппировкиСтрок.Количество()-].ПолучитьИдентификатор()
		
		
	ИначеЕсли ДополнительныеПараметры.Событие = "Точки" Тогда
		
		ТекущиеДанные.ТочкиЗаголовок = РезультатЗакрытия.Заголовок;
		ТекущиеДанные.Точки          = РезультатЗакрытия.Поле;
		
	ИначеЕсли ДополнительныеПараметры.Событие = "Серии" Тогда
		
		ТекущиеДанные.СерииЗаголовок = РезультатЗакрытия.Заголовок;
		ТекущиеДанные.Серии          = РезультатЗакрытия.Поле;
		
	ИначеЕсли ДополнительныеПараметры.Событие = "Выбор" Тогда
		
		ОтчетыКлиентСервер.ЗаполнитьНастройкиОтчета(ЭтаФорма, ТекущиеДанные.Выбор, РезультатЗакрытия.Выбор.Элементы, Отчет.КомпоновщикНастроек.Настройки.ДоступныеПоляВыбора, ТекущиеДанные);
		
	ИначеЕсли ДополнительныеПараметры.Событие = "Порядок" Тогда
		
		Если ТекущиеДанные = Неопределено Тогда
			ОтчетыКлиентСервер.ЗаполнитьНастройкиОтчета(ЭтаФорма, Отчет.КомпоновщикНастроек.Настройки.Порядок, РезультатЗакрытия.Порядок.Элементы, Отчет.КомпоновщикНастроек.Настройки.ДоступныеПоляПорядка, ТекущиеДанные);
		Иначе
			ОтчетыКлиентСервер.ЗаполнитьНастройкиОтчета(ЭтаФорма, ТекущиеДанные.Порядок, РезультатЗакрытия.Порядок.Элементы, Отчет.КомпоновщикНастроек.Настройки.ДоступныеПоляПорядка, ТекущиеДанные);
		КонецЕсли;
		
	ИначеЕсли ДополнительныеПараметры.Событие = "ПорядокОтчета" Тогда
		
		Если НЕ РезультатЗакрытия.Папка Тогда
			ТекущиеДанные = Отчет.КомпоновщикНастроек.Настройки.Порядок.ПолучитьОбъектПоИдентификатору(ДополнительныеПараметры.ТекущаяСтрока);
			ТекущиеДанные.Поле          = РезультатЗакрытия.Поле;
			ТекущиеДанные.Использование = Истина;
		КонецЕсли;
		
	ИначеЕсли ДополнительныеПараметры.Событие = "Ресурсы" Тогда
		
		ТекущиеДанные.Заголовок     = РезультатЗакрытия.Заголовок;
		ТекущиеДанные.Поле          = РезультатЗакрытия.Поле;
		ТекущиеДанные.Папка         = РезультатЗакрытия.Папка;
		ТекущиеДанные.Использование = Истина;
		
		Если РезультатЗакрытия.Папка Тогда
			ЗаполнитьКоллекциюИзХранилища(РезультатЗакрытия.АдресТаблицы, ДополнительныеПараметры.МассивПутей);
		КонецЕсли;
		
	ИначеЕсли ДополнительныеПараметры.Событие = "Показатель" Тогда
		
		Если РезультатЗакрытия.Папка Тогда
			ТекущиеДанные.ПоказательЗаголовок = "";
			ТекущиеДанные.Показатель          = Новый ПолеКомпоновкиДанных("");
		Иначе
			ТекущиеДанные.ПоказательЗаголовок = РезультатЗакрытия.Заголовок;
			ТекущиеДанные.Показатель          = РезультатЗакрытия.Поле;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // Подключаемый_ОбработкаРезультатаОповещения()

&НаКлиенте
Процедура ОповещениеИзменениеОтбора(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	
	Если НЕ ТипЗнч(РезультатЗакрытия) = Тип("Структура") Тогда
		Возврат;
	КонецЕсли;
	
	Если (НЕ ДополнительныеПараметры = Неопределено) И ДополнительныеПараметры.Свойство("ТекущиеДанные") Тогда
		ТекущиеДанные = ДополнительныеПараметры.ТекущиеДанные;
	Иначе
		ТекущиеДанные = ЭтаФорма.ТекущийЭлемент.ТекущиеДанные;
	КонецЕсли;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если РезультатЗакрытия.Событие = "Отбор" Тогда
		
		ТекущиеДанные = Элементы.Отбор.ТекущиеДанные;
		ТекущиеДанные.Заголовок     = РезультатЗакрытия.Заголовок;
		ТекущиеДанные.Использование = Истина;
		ТекущиеДанные.ЛевоеЗначение = РезультатЗакрытия.Поле;
		ТекущиеДанные.ВидСравнения  = ПредопределенноеЗначение(РезультатЗакрытия.ВидСравнения);
		ТекущиеДанные.Папка         = Ложь;
		
		ДоступноеПоле = Отчет.КомпоновщикНастроек.Настройки.ДоступныеПоляОтбора.НайтиПоле(РезультатЗакрытия.Поле);
		Если ДоступноеПоле = Неопределено ИЛИ 
			ТекущиеДанные.ВидСравнения = ВидСравненияКомпоновкиДанных.Заполнено ИЛИ 
			ТекущиеДанные.ВидСравнения = ВидСравненияКомпоновкиДанных.НеЗаполнено Тогда
			ТекущиеДанные.ПравоеЗначение = Неопределено;
		Иначе
			
			ТекущееЗначение = ТекущиеДанные.ПравоеЗначение;
			// Если старый вид сравнения был в списке
			Если НЕ ОтборПоСписку(ТекущиеДанные.ВидСравнения) И ТипЗнч(ТекущееЗначение) = Тип("СписокЗначений") Тогда
				Если ТекущееЗначение.Количество() = 0 Тогда
					ТекущееЗначение = Неопределено;
				Иначе
					ТекущееЗначение = ТекущееЗначение[0].Значение;
				КонецЕсли;
				// Если новый вид сравнения стал в списке
			ИначеЕсли ОтборПоСписку(ТекущиеДанные.ВидСравнения) И (НЕ ТипЗнч(ТекущееЗначение) = Тип("СписокЗначений")) Тогда
				ВременныйСписок = Новый СписокЗначений;
				ВременныйСписок.Добавить(ТекущееЗначение);
				ТекущееЗначение = ВременныйСписок;
			КонецЕсли;
			
			Если ТипЗнч(ТекущееЗначение) = Тип("СписокЗначений") Тогда
				КоличествоЭлементов = ТекущееЗначение.Количество()-1;
				Пока КоличествоЭлементов>=0 Цикл
					
					ПоследнийЭлемент = ТекущееЗначение[КоличествоЭлементов];
					ПоследнийЭлемент.Значение = ДоступноеПоле.ТипЗначения.ПривестиЗначение(ПоследнийЭлемент.Значение);
					
					Если НЕ ЗначениеЗаполнено(ПоследнийЭлемент.Значение) Тогда
						ТекущееЗначение.Удалить(ПоследнийЭлемент);
					КонецЕсли;
					
					КоличествоЭлементов = КоличествоЭлементов - 1;
					
				КонецЦикла;
			Иначе
				ТекущееЗначение = ДоступноеПоле.ТипЗначения.ПривестиЗначение(ТекущееЗначение);
			КонецЕсли;
			
			ТекущиеДанные.ПравоеЗначение = ТекущееЗначение;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ВидимостьПериода()
	
	ОтчетыСервер.ВидимостьПериода(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ПериодПроизвольный(Команда)
	
	ВидПериода = "Произвольный";
	
	ОтчетыКлиентСервер.УстановитьПометкуНаПериод(ЭтаФорма, Команда.Имя);
	
	ВидимостьПериода();
	
КонецПроцедуры

&НаКлиенте
Процедура ПериодДень(Команда)
	
	ВидПериода = "День";
	
	ОтчетыКлиентСервер.ОбновитьВариантыПериодов(ЭтаФорма);
	
	ОтчетыКлиентСервер.УстановитьПометкуНаПериод(ЭтаФорма, Команда.Имя);
	
	ВидимостьПериода();
	
КонецПроцедуры

&НаКлиенте
Процедура ПериодНеделя(Команда)
	
	ВидПериода = "Неделя";
	
	ОтчетыКлиентСервер.ОбновитьВариантыПериодов(ЭтаФорма);
	
	ОтчетыКлиентСервер.УстановитьПометкуНаПериод(ЭтаФорма, Команда.Имя);
	
	ВидимостьПериода();
	
КонецПроцедуры

&НаКлиенте
Процедура ПериодМесяц(Команда)
	
	ВидПериода = "Месяц";
	
	ОтчетыКлиентСервер.ОбновитьВариантыПериодов(ЭтаФорма);
	
	ОтчетыКлиентСервер.УстановитьПометкуНаПериод(ЭтаФорма, Команда.Имя);
	
	ВидимостьПериода();
	
КонецПроцедуры

&НаКлиенте
Процедура ПериодКвартал(Команда)
	
	ВидПериода = "Квартал";
	
	ОтчетыКлиентСервер.ОбновитьВариантыПериодов(ЭтаФорма);
	
	ОтчетыКлиентСервер.УстановитьПометкуНаПериод(ЭтаФорма, Команда.Имя);
	
	ВидимостьПериода();
	
КонецПроцедуры

&НаКлиенте
Процедура ПериодГод(Команда)
	
	ВидПериода = "Год";
	
	ОтчетыКлиентСервер.ОбновитьВариантыПериодов(ЭтаФорма);
	
	ОтчетыКлиентСервер.УстановитьПометкуНаПериод(ЭтаФорма, Команда.Имя);
	
	ВидимостьПериода();
	
КонецПроцедуры

&НаКлиенте
Процедура ПериодНазад(Команда)
	
	Направление = -1;
	ОтчетыКлиентСервер.СместитьПериод(ЭтаФорма, Направление);
	
КонецПроцедуры

&НаКлиенте
Процедура ПериодВперед(Команда)
	
	Направление = +1;
	ОтчетыКлиентСервер.СместитьПериод(ЭтаФорма, Направление);
	
КонецПроцедуры

&НаКлиенте
Процедура ВариантПериодаПриИзменении(Элемент)
	
	КонецПериода = ВариантПериода;
	ОтчетыКлиентСервер.ОбновитьВариантыПериодов(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура СтраницыПриСменеСтраницы(Элемент, ТекущаяСтраница)
	
	СтраницыПриСменеСтраницыНаСервере();
	
	ДеревоПоказателей = Показатели.ПолучитьЭлементы();
	Для Каждого СтрокаДерева Из ДеревоПоказателей Цикл
		ИдентификаторСтроки = СтрокаДерева.ПолучитьИдентификатор();
		Элементы.Показатели.Развернуть(ИдентификаторСтроки, Истина);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура УдалитьТаблицу()
	
	ТекущаяСтраница = Элементы.Страницы.ТекущаяСтраница;
	ИндексСтраницы  = Элементы.Страницы.ПодчиненныеЭлементы.Индекс(ТекущаяСтраница);
	ИндексСтраницы = ?(ИндексСтраницы = 1, 2, ИндексСтраницы-1);
	
	ОтчетыСервер.ПереместитьТаблицуОтчета(ЭтаФорма, ИндексСтраницы);
	
	Элементы.Удалить(ТекущаяСтраница);
	
КонецПроцедуры

&НаСервере
Процедура СдвинутьТаблицу(СмещениеВлево = Истина)
	
	ТекущаяСтраница       = Элементы.Страницы.ТекущаяСтраница;
	ИндексСтроки          = Элементы.Страницы.ПодчиненныеЭлементы.Индекс(ТекущаяСтраница);
	ПоследнийИндексСтроки = Элементы.Страницы.ПодчиненныеЭлементы.Количество()-2;
	
	Если СмещениеВлево Тогда
		
		Если ИндексСтроки < 2 Тогда
			Элементы.Переместить(ТекущаяСтраница, Элементы.Страницы, Элементы.Страницы.ПодчиненныеЭлементы[ПоследнийИндексСтроки+1]);
		Иначе
			Элементы.Переместить(ТекущаяСтраница, Элементы.Страницы, Элементы.Страницы.ПодчиненныеЭлементы[ИндексСтроки-1]);
		КонецЕсли;
		
		ТекущаяСтрока = СписокТаблиц.НайтиПоИдентификатору(Элементы.СписокТаблиц.ТекущаяСтрока);
		Если НЕ ТекущаяСтрока = Неопределено Тогда
			
			ИндексСтроки          = СписокТаблиц.Индекс(ТекущаяСтрока);
			ПоследнийИндексСтроки = СписокТаблиц.Количество()-1;
			Если ИндексСтроки=0 Тогда
				СписокТаблиц.Сдвинуть(ИндексСтроки, ПоследнийИндексСтроки);
			Иначе
				СписокТаблиц.Сдвинуть(ИндексСтроки, -1);
			КонецЕсли;
			
		КонецЕсли;
		
	Иначе
		
		Если ИндексСтроки = ПоследнийИндексСтроки Тогда
			Элементы.Переместить(ТекущаяСтраница, Элементы.Страницы, Элементы.Страницы.ПодчиненныеЭлементы[1]);
		Иначе
			Элементы.Переместить(ТекущаяСтраница, Элементы.Страницы, Элементы.Страницы.ПодчиненныеЭлементы[ИндексСтроки+2]);
		КонецЕсли;
		
		ТекущаяСтрока = СписокТаблиц.НайтиПоИдентификатору(Элементы.СписокТаблиц.ТекущаяСтрока);
		Если НЕ ТекущаяСтрока = Неопределено Тогда
			
			ИндексСтроки          = СписокТаблиц.Индекс(ТекущаяСтрока);
			ПоследнийИндексСтроки = СписокТаблиц.Количество()-1;
			Если ИндексСтроки=ПоследнийИндексСтроки Тогда
				СписокТаблиц.Сдвинуть(ИндексСтроки, -ПоследнийИндексСтроки);
			Иначе
				СписокТаблиц.Сдвинуть(ИндексСтроки, 1);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаСдвинутьВлево(Команда)
	
	СдвинутьТаблицу();
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаСдвинутьВправо(Команда)
	
	СдвинутьТаблицу(Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаУдалить(Команда)
	
	// Должно быть не меньше трух страниц: Шаблон, первая таблица и добавление новых таблиц
	Если Элементы.Страницы.ПодчиненныеЭлементы.Количество() = 3 Тогда
		Возврат;
	КонецЕсли;
	
	НайденныеСтроки = СписокТаблиц.НайтиСтроки(Новый Структура("Идентификатор", ИдентификаторТаблицы));
	Если НайденныеСтроки.Количество()> 0 Тогда
		ИндексСтраницы = Элементы.Страницы.ПодчиненныеЭлементы.Индекс(Элементы.Страницы.ТекущаяСтраница)-1;
		
		ИндексСтраницы = ?(ИндексСтраницы = 0, 2, ИндексСтраницы);
		
		СписокТаблиц.Удалить(НайденныеСтроки[0]);
		
		СледующаяСтраница = Элементы.Страницы.ПодчиненныеЭлементы[ИндексСтраницы];
		
		ИдентификаторТаблицы = СледующаяСтраница.Имя;
		Если ИдентификаторТаблицы = "СтраницаШаблон" Тогда
			ИдентификаторТаблицы = "";
		КонецЕсли;
		
		УдалитьТаблицу();
		
		Элементы.Страницы.ТекущаяСтраница = СледующаяСтраница;
		
		//ИдентификаторТаблицы = Элементы.Страницы.ТекущаяСтраница.Имя;
		//Если ИдентификаторТаблицы = "СтраницаШаблон" Тогда
		//	ИдентификаторТаблицы = "";
		//КонецЕсли;
		
		СтрокиТаблицы = СписокТаблиц.НайтиСтроки(Новый Структура("Идентификатор", ИдентификаторТаблицы));
		Если СтрокиТаблицы.Количество()>0 Тогда
			ТекущаяСтрока = СтрокиТаблицы[0];
			Элементы.СписокТаблиц.ТекущаяСтрока = ТекущаяСтрока.ПолучитьИдентификатор();
			ВыбратьВидТаблицы(ТекущаяСтрока.ВидТаблицы, ТекущаяСтрока.НомерТаблицы);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаРеквизитыОтдельно(Команда)
	
	Элементы.ТаблицаРеквизитыОтдельно.Пометка = (НЕ Элементы.ТаблицаРеквизитыОтдельно.Пометка);
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если НЕ ТекущиеДанные = Неопределено Тогда
		ТекущиеДанные.РеквизитыОтдельно = Элементы.ТаблицаРеквизитыОтдельно.Пометка;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВидДиаграммы(Команда)
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные.ВидТаблицы = "Диаграмма";
	
	ВыбратьВидТаблицы("Диаграмма", ТекущиеДанные.НомерТаблицы);
	
КонецПроцедуры

&НаКлиенте
Процедура ВидТаблицы(Команда)
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные.ВидТаблицы = "Таблица";
	
	ВыбратьВидТаблицы("Таблица", ТекущиеДанные.НомерТаблицы);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиКолонокДобавить(Команда)
	
	Элементы.ГруппировкиКолонок.ДобавитьСтроку();
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиКолонокИзменить(Команда)
	
	ТекущиеДанные = Элементы.ГруппировкиКолонок.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиКолонокВыбор(Элементы.ГруппировкиКолонок, ТекущиеДанные, Элементы.ГруппировкиКолонок.ТекущийЭлемент);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиКолонокПереместитьВверх(Команда)
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные = Элементы.ГруппировкиКолонок.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиКолонок = СписокТаблиц.НайтиПоИдентификатору(ТекущаяСтрока).ГруппировкиКолонок;
	
	ИндексСтроки       = ГруппировкиКолонок.Индекс(ТекущиеДанные);
	
	Смещение = ?(ИндексСтроки = 0, ГруппировкиКолонок.Количество()-1, -1);
	
	ГруппировкиКолонок.Сдвинуть(ИндексСтроки, Смещение);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиКолонокПереместитьВниз(Команда)
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные = Элементы.ГруппировкиКолонок.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиКолонок = СписокТаблиц.НайтиПоИдентификатору(ТекущаяСтрока).ГруппировкиКолонок;
	
	ИндексСтроки       = ГруппировкиКолонок.Индекс(ТекущиеДанные);
	
	Смещение = ?(ИндексСтроки = ГруппировкиКолонок.Количество()-1, -ИндексСтроки, 1);
	
	ГруппировкиКолонок.Сдвинуть(ИндексСтроки, Смещение);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиКолонокУдалить(Команда)
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные = Элементы.ГруппировкиКолонок.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиКолонок = СписокТаблиц.НайтиПоИдентификатору(Элементы.СписокТаблиц.ТекущаяСтрока).ГруппировкиКолонок;
	
	ИндексСтроки       = ГруппировкиКолонок.Индекс(ТекущиеДанные);
	
	ГруппировкиКолонок.Удалить(ИндексСтроки);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиСтрокДобавить(Команда)
	
	Элементы.ГруппировкиСтрок.ДобавитьСтроку();
	
КонецПроцедуры

&НаСервере
// Функция помещает коллекцию формы во временное хранилище и возвращает адрес 
//
Функция ПоместитьКоллекциюВХранилище(МассивПутей, ИмяТаблицы)
	
	СтрокаТаблицы = ПолучитьТекущиеДанныеПоСтруктуре(ЭтаФорма, МассивПутей);
	
	КоллекцияФормы = СтрокаТаблицы[ИмяТаблицы];
	
	Результат = Неопределено;
	
	ОбъектКоллекции = Неопределено;
	Если ТипЗнч(КоллекцияФормы) = Тип("ДанныеФормыДерево") Тогда
		ОбъектКоллекции = ДанныеФормыВЗначение(КоллекцияФормы, Тип("ДеревоЗначений"));
	Иначе
		ОбъектКоллекции = ДанныеФормыВЗначение(КоллекцияФормы, Тип("ТаблицаЗначений"));
	КонецЕсли;
	
	Результат = ПоместитьВоВременноеХранилище(ОбъектКоллекции, УникальныйИдентификатор);
	
	Возврат Результат;
	
КонецФункции // ПоместитьКоллекциюВХранилище()

&НаКлиентеНаСервереБезКонтекста 
Функция ПолучитьТекущиеДанныеПоСтруктуре(ОбъектФормы, МассивПутей)
	
	ТекущийОбъект = ОбъектФормы;
	Для Каждого ПутьКДанным Из МассивПутей Цикл
		Если ПутьКДанным.Значение = Неопределено Тогда
			ТекущийОбъект = ТекущийОбъект[ПутьКДанным.Ключ];
		Иначе
			ТекущийОбъект = ТекущийОбъект[ПутьКДанным.Ключ].НайтиПоИдентификатору(ПутьКДанным.Значение);
		КонецЕсли;
	КонецЦикла;
	
	Возврат ТекущийОбъект;
	
КонецФункции

&НаКлиенте
Процедура ГруппировкиСтрокВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка = Истина)
	
	ИмяПоля = Поле.Имя;
	
	ТекущиеДанные = Элементы.ГруппировкиСтрок.ТекущиеДанные;;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	МассивПутей = Новый Структура;
	МассивПутей.Вставить("СписокТаблиц",     Элементы.СписокТаблиц.ТекущаяСтрока);
	МассивПутей.Вставить("ГруппировкиСтрок", Элементы.ГруппировкиСтрок.ТекущаяСтрока);
	
	Если ИмяПоля = "ГруппировкиСтрокЗаголовок" Тогда
		
		СтандартнаяОбработка = Ложь;
		
		ПараметрыВыбора = Новый Структура;
		ПараметрыВыбора.Вставить("СхемаКомпоновки",        СхемаКомпоновки);
		ПараметрыВыбора.Вставить("Событие",                "ПоляГруппировки");
		ПараметрыВыбора.Вставить("ПоляГруппировки",        ТекущиеДанные.ПоляГруппировки);
		ПараметрыВыбора.Вставить("НастройкиОтчета",        Отчет.КомпоновщикНастроек.ПолучитьНастройки());
		
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
		ДополнительныеПараметры.Вставить("Событие",     "ПоляГруппировки");
		
		ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
		ОткрытьФорму("ОбщаяФорма.ФормаПодбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	ИначеЕсли ИмяПоля = "ГруппировкиСтрокПредставлениеПорядка" Тогда
		
		СтандартнаяОбработка = Ложь;
		
		// Если нет группировок, то сортировать не будем
		Если ТекущиеДанные.ПоляГруппировки.Элементы.Количество()=0 Тогда
			Возврат;
		КонецЕсли;
		
		ПараметрыВыбора = Новый Структура;
		ПараметрыВыбора.Вставить("СхемаКомпоновки",        СхемаКомпоновки);
		ПараметрыВыбора.Вставить("Событие",                "Порядок");
		ПараметрыВыбора.Вставить("НастройкиОтчета",        Отчет.КомпоновщикНастроек.ПолучитьНастройки());
		
		Если ТекущиеДанные.ПоляГруппировки.Элементы.Количество()>0 Тогда
			// Поля группировки
			МассивГруппировок = Новый Массив;
			Для Каждого ПолеГруппировки Из ТекущиеДанные.ПоляГруппировки.Элементы Цикл
				МассивГруппировок.Добавить(ПолеГруппировки.Поле);
			КонецЦикла;
			
			ПараметрыВыбора.Вставить("ГруппировкиСтруктуры", МассивГруппировок);
			ПараметрыВыбора.Вставить("ПоляПорядка",          ТекущиеДанные.Порядок);
			
		КонецЕсли;
		
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
		ДополнительныеПараметры.Вставить("Событие",     "Порядок");
		
		ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
		ОткрытьФорму("ОбщаяФорма.ФормаПодбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	ИначеЕсли ИмяПоля = "ГруппировкиСтрокПредставлениеПолей" Тогда
		
		СтандартнаяОбработка = Ложь;
		
		ПараметрыВыбора = Новый Структура;
		ПараметрыВыбора.Вставить("СхемаКомпоновки",        СхемаКомпоновки);
		ПараметрыВыбора.Вставить("Событие",                "Выбор");
		ПараметрыВыбора.Вставить("ПоляВыбора",             ТекущиеДанные.Выбор);
		ПараметрыВыбора.Вставить("НастройкиОтчета",        Отчет.КомпоновщикНастроек.ПолучитьНастройки());
		Если ТекущиеДанные.ПоляГруппировки.Элементы.Количество()>0 Тогда
			// Поля группировки
			МассивГруппировок = Новый Массив;
			Для Каждого ПолеГруппировки Из ТекущиеДанные.ПоляГруппировки.Элементы Цикл
				МассивГруппировок.Добавить(ПолеГруппировки.Поле);
			КонецЦикла;
			
			//Если ТекущиеДанные.Выбор.ПолучитьЭлементы().Количество()>0 Тогда
			//	АдресТаблицы = ПоместитьКоллекциюВХранилище(МассивПутей, "Выбор");
			//	ПараметрыВыбора.Вставить("АдресТаблицы", АдресТаблицы);
			//КонецЕсли;
			ПараметрыВыбора.Вставить("ГруппировкиСтруктуры", МассивГруппировок);
		КонецЕсли;
		
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
		ДополнительныеПараметры.Вставить("Событие",     "Выбор");
		
		ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
		ОткрытьФорму("ОбщаяФорма.ФормаПодбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиСтрокИзменить(Команда)
	
	ТекущиеДанные = Элементы.ГруппировкиСтрок.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиСтрокВыбор(Элементы.ГруппировкиСтрок, ТекущиеДанные, Элементы.ГруппировкиСтрок.ТекущийЭлемент);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиСтрокПереместитьВверх(Команда)
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные = Элементы.ГруппировкиСтрок.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиСтрок = СписокТаблиц.НайтиПоИдентификатору(ТекущаяСтрока).ГруппировкиСтрок;
	
	ИндексСтроки       = ГруппировкиСтрок.Индекс(ТекущиеДанные);
	
	Смещение = ?(ИндексСтроки = 0, ГруппировкиСтрок.Количество()-1, -1);
	
	ГруппировкиСтрок.Сдвинуть(ИндексСтроки, Смещение);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиСтрокПереместитьВниз(Команда)
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные = Элементы.ГруппировкиСтрок.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиСтрок = СписокТаблиц.НайтиПоИдентификатору(ТекущаяСтрока).ГруппировкиСтрок;
	
	ИндексСтроки     = ГруппировкиСтрок.Индекс(ТекущиеДанные);
	
	Смещение = ?(ИндексСтроки = ГруппировкиСтрок.Количество()-1, -ИндексСтроки, 1);
	
	ГруппировкиСтрок.Сдвинуть(ИндексСтроки, Смещение);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиСтрокУдалить(Команда)
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные = Элементы.ГруппировкиСтрок.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиСтрок = СписокТаблиц.НайтиПоИдентификатору(Элементы.СписокТаблиц.ТекущаяСтрока).ГруппировкиСтрок;
	
	ИндексСтроки     = ГруппировкиСтрок.Индекс(ТекущиеДанные);
	
	ГруппировкиСтрок.Удалить(ИндексСтроки);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиСтрокСнятьПометки(Команда)
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиСтрок = СписокТаблиц.НайтиПоИдентификатору(Элементы.СписокТаблиц.ТекущаяСтрока).ГруппировкиСтрок;
	
	Для Каждого ТекущаяСтрока Из ГруппировкиСтрок Цикл
		ТекущаяСтрока.Использование = Ложь;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиСтрокУстановитьПометки(Команда)
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиСтрок = СписокТаблиц.НайтиПоИдентификатору(Элементы.СписокТаблиц.ТекущаяСтрока).ГруппировкиСтрок;
	
	Для Каждого ТекущаяСтрока Из ГруппировкиСтрок Цикл
		ТекущаяСтрока.Использование = Истина;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиСтрокПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Если Копирование Тогда
		Возврат;
	КонецЕсли;
	
	Отказ = Истина;
	
	Если Элементы.СписокТаблиц.ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НоваяСтрока = Элементы.СписокТаблиц.ТекущиеДанные.ГруппировкиСтрок.Добавить();
	НоваяСтрока.Использование        = Истина;
	НоваяСтрока.Заголовок            = "Детальные записи";
	НоваяСтрока.ПредставлениеПорядка = "Авто";
	НоваяСтрока.КартинкаПоля         = БиблиотекаКартинок.Реквизит;
	
	Элементы.ГруппировкиСтрок.ТекущаяСтрока = НоваяСтрока.ПолучитьИдентификатор();
	
	//
	//ПараметрыВыбора = Новый Структура;
	//ПараметрыВыбора.Вставить("СхемаКомпоновки",        СхемаКомпоновки);
	//ПараметрыВыбора.Вставить("Событие",                "ПоляГруппировки");
	//
	//МассивПутей = Новый Структура;
	//МассивПутей.Вставить("СписокТаблиц", Элементы.СписокТаблиц.ТекущаяСтрока);
	//МассивПутей.Вставить("ГруппировкиСтрок");
	//
	//ДополнительныеПараметры = Новый Структура;
	//ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
	//ДополнительныеПараметры.Вставить("Событие",     "НоваяГруппировка");
	//
	//ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
	//ОткрытьФорму("ОбщаяФорма.ФормаПодбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиСтрокПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	
	Если НоваяСтрока Тогда
		ТекущиеДанные = Элементы.ГруппировкиСтрок.ТекущиеДанные;
		Если ТекущиеДанные = Неопределено Тогда
			Возврат;
		КонецЕсли;
		ТекущиеДанные.Использование = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиКолонокВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка = Истина)
	
	ИмяПоля = Поле.Имя;
	
	ТекущиеДанные = Элементы.ГруппировкиКолонок.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	МассивПутей = Новый Структура;
	МассивПутей.Вставить("СписокТаблиц",     Элементы.СписокТаблиц.ТекущаяСтрока);
	МассивПутей.Вставить("ГруппировкиКолонок", Элементы.ГруппировкиКолонок.ТекущаяСтрока);
	
	Если ИмяПоля = "ГруппировкиКолонокЗаголовок" Тогда
		
		СтандартнаяОбработка = Ложь;
		
		ПараметрыВыбора = Новый Структура;
		ПараметрыВыбора.Вставить("СхемаКомпоновки", СхемаКомпоновки);
		ПараметрыВыбора.Вставить("Событие",         "ПоляГруппировки");
		ПараметрыВыбора.Вставить("ПоляГруппировки", ТекущиеДанные.ПоляГруппировки);
		ПараметрыВыбора.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
		
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
		ДополнительныеПараметры.Вставить("Событие",     "ПоляГруппировки");
		
		ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
		ОткрытьФорму("ОбщаяФорма.ФормаПодбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	ИначеЕсли ИмяПоля = "ГруппировкиКолонокПредставлениеПорядка" Тогда
		
		СтандартнаяОбработка = Ложь;
		
		// Если нет группировок, то сортировать не будем
		Если ТекущиеДанные.ПоляГруппировки.Элементы.Количество()=0 Тогда
			Возврат;
		КонецЕсли;
		
		ПараметрыВыбора = Новый Структура;
		ПараметрыВыбора.Вставить("СхемаКомпоновки", СхемаКомпоновки);
		ПараметрыВыбора.Вставить("Событие",         "Порядок");
		ПараметрыВыбора.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
		
		Если ТекущиеДанные.ПоляГруппировки.Элементы.Количество()>0 Тогда
			// Поля группировки
			МассивГруппировок = Новый Массив;
			Для Каждого ПолеГруппировки Из ТекущиеДанные.ПоляГруппировки.Элементы Цикл
				МассивГруппировок.Добавить(ПолеГруппировки.Поле);
			КонецЦикла;
			
			ПараметрыВыбора.Вставить("ГруппировкиСтруктуры", МассивГруппировок);
			ПараметрыВыбора.Вставить("ПоляПорядка",          ТекущиеДанные.Порядок);
			
		КонецЕсли;
		
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
		ДополнительныеПараметры.Вставить("Событие",     "Порядок");
		
		ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
		ОткрытьФорму("ОбщаяФорма.ФормаПодбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиКолонокПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Если Копирование Тогда
		Возврат;
	КонецЕсли;
	
	Отказ = Истина;
	
	Если Элементы.СписокТаблиц.ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НоваяСтрока = Элементы.СписокТаблиц.ТекущиеДанные.ГруппировкиКолонок.Добавить();
	НоваяСтрока.Использование        = Истина;
	НоваяСтрока.Заголовок            = "Детальные записи";
	НоваяСтрока.ПредставлениеПорядка = "Авто";
	НоваяСтрока.КартинкаПоля         = БиблиотекаКартинок.Реквизит;
	
	Элементы.ГруппировкиКолонок.ТекущаяСтрока = НоваяСтрока.ПолучитьИдентификатор();
	
	//ПараметрыВыбора = Новый Структура;
	//ПараметрыВыбора.Вставить("СхемаКомпоновки",        СхемаКомпоновки);
	//ПараметрыВыбора.Вставить("Событие",                "ПоляГруппировки");
	//
	//МассивПутей = Новый Структура;
	//МассивПутей.Вставить("СписокТаблиц", Элементы.СписокТаблиц.ТекущаяСтрока);
	//МассивПутей.Вставить("ГруппировкиКолонок");
	//
	//ДополнительныеПараметры = Новый Структура;
	//ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
	//ДополнительныеПараметры.Вставить("Событие",     "НоваяГруппировка");
	//
	//ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
	//ОткрытьФорму("ОбщаяФорма.ФормаПодбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиКолонокПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	
	Если НоваяСтрока Тогда
		ТекущиеДанные = Элементы.ГруппировкиКолонок.ТекущиеДанные;
		Если ТекущиеДанные = Неопределено Тогда
			Возврат;
		КонецЕсли;
		ТекущиеДанные.Использование = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборУстановитьПометки(Команда)
	
	//УстановитьПометки(Отбор.ПолучитьЭлементы(), Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборСнятьПометки(Команда)
	
	//УстановитьПометки(Отбор.ПолучитьЭлементы(), Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаОтображатьТаблицуДанных(Команда)
	
	Элементы.ТаблицаОтображатьТаблицуДанных.Пометка = (НЕ Элементы.ТаблицаОтображатьТаблицуДанных.Пометка);
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если НЕ ТекущиеДанные = Неопределено Тогда
		ТекущиеДанные.ОтображатьТаблицуДанных = Элементы.ТаблицаОтображатьТаблицуДанных.Пометка;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиКолонокСнятьПометки(Команда)
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиКолонок = СписокТаблиц.НайтиПоИдентификатору(Элементы.СписокТаблиц.ТекущаяСтрока).ГруппировкиКолонок;
	
	Для Каждого ТекущаяСтрока Из ГруппировкиКолонок Цикл
		ТекущаяСтрока.Использование = Ложь;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ГруппировкиКолонокУстановитьПометки(Команда)
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ГруппировкиКолонок = СписокТаблиц.НайтиПоИдентификатору(Элементы.СписокТаблиц.ТекущаяСтрока).ГруппировкиКолонок;
	
	Для Каждого ТекущаяСтрока Из ГруппировкиКолонок Цикл
		ТекущаяСтрока.Использование = Истина;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказателиДобавить(Команда)
	
	Элементы.Показатели.ДобавитьСтроку();
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказателиДобавитьГруппу(Команда)
	
	ТекущиеДанные = Элементы.Показатели.ТекущиеДанные;
	
	ТекущиеДанныеТаблицы = Элементы.СписокТаблиц.ТекущиеДанные;
	Если ТекущиеДанныеТаблицы = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЭлементыПоказателей = ОтчетыТонкийКлиент.ПолучитьЭлементыДляДерева(ТекущиеДанные, Показатели);
	
	НоваяГруппаПоказателей = ЭлементыПоказателей.Добавить();
	НоваяГруппаПоказателей.Использование = Истина;
	НоваяГруппаПоказателей.Заголовок     = "";
	НоваяГруппаПоказателей.Папка         = Истина;
	НоваяГруппаПоказателей.КартинкаПоля  = БиблиотекаКартинок.СправочникГруппа;
	
	Элементы.Показатели.ТекущаяСтрока = НоваяГруппаПоказателей.ПолучитьИдентификатор();
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьПометки(ТаблицаЭлементов, Флаг)
	
	Для Каждого ЭлементТаблицы Из ТаблицаЭлементов Цикл
		
		ЭлементТаблицы.Использование = Флаг;
		
		Если ЭлементТаблицы.Папка Тогда
			УстановитьПометки(ЭлементТаблицы.ПолучитьЭлементы(), Флаг);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказателиУстановитьПометки(Команда)
	
	УстановитьПометки(Показатели.ПолучитьЭлементы(), Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказателиСнятьПометки(Команда)
	
	УстановитьПометки(Показатели.ПолучитьЭлементы(), Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказателиПереместитьВверх(Команда)
	
	ТекущиеДанные = Элементы.Показатели.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЭлементыПоказателей = ОтчетыТонкийКлиент.ПолучитьЭлементыДляДерева(ТекущиеДанные, Показатели);
	
	ИндексСтроки = ЭлементыПоказателей.Индекс(ТекущиеДанные);
	
	Смещение = ?(ИндексСтроки = 0, ЭлементыПоказателей.Количество()-1, -1);
	
	ЭлементыПоказателей.Сдвинуть(ИндексСтроки, Смещение);
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказателиПереместитьВниз(Команда)
	
	ТекущиеДанные = Элементы.Показатели.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЭлементыПоказателей = ОтчетыТонкийКлиент.ПолучитьЭлементыДляДерева(ТекущиеДанные, Показатели);
	
	ИндексСтроки = ЭлементыПоказателей.Индекс(ТекущиеДанные);
	
	Смещение = ?(ИндексСтроки = ЭлементыПоказателей.Количество()-1, -ИндексСтроки, 1);
	
	ЭлементыПоказателей.Сдвинуть(ИндексСтроки, Смещение);
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказателиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ИмяПоля = Поле.Имя;
	
	ТекущиеДанные = Элементы.Показатели.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ИмяПоля = "ПоказателиЗаголовок" И (НЕ ТекущиеДанные.Папка) Тогда
		
		СтандартнаяОбработка = Ложь;
		
		ПараметрыВыбора = Новый Структура;
		ПараметрыВыбора.Вставить("СхемаКомпоновки", СхемаКомпоновки);
		ПараметрыВыбора.Вставить("Событие",         "Ресурсы");
		ПараметрыВыбора.Вставить("ТекущееПоле",     ТекущиеДанные.Поле);
		ПараметрыВыбора.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
		
		МассивПутей = Новый Структура;
		МассивПутей.Вставить("Показатели", Элементы.Показатели.ТекущаяСтрока);
		
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
		ДополнительныеПараметры.Вставить("Событие",     "Ресурсы");
		
		ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
		ОткрытьФорму("ОбщаяФорма.ФормаВыбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказателиПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Если Копирование Тогда
		Возврат;
	КонецЕсли;
	
	Отказ = Истина;
	
	ПараметрыВыбора = Новый Структура;
	ПараметрыВыбора.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	ПараметрыВыбора.Вставить("Событие",         "Ресурсы");
	ПараметрыВыбора.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
	
	ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("ОповещениеНовыйПоказатель", ЭтаФорма);
	ОткрытьФорму("ОбщаяФорма.ФормаВыбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеНовыйПоказатель(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	
	Если НЕ ТипЗнч(РезультатЗакрытия) = Тип("Структура") Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные = Элементы.Показатели.ТекущиеДанные;
	
	ЭлементыПоказателей = ОтчетыТонкийКлиент.ПолучитьЭлементыДляДерева(ТекущиеДанные, Показатели);
	
	НовыйПоказатель = ЭлементыПоказателей.Добавить();
	НовыйПоказатель.Использование = Истина;
	НовыйПоказатель.Заголовок     = РезультатЗакрытия.Заголовок;
	НовыйПоказатель.Поле          = РезультатЗакрытия.Поле;
	НовыйПоказатель.Папка         = РезультатЗакрытия.Папка;
	НовыйПоказатель.КартинкаПоля  = ?(РезультатЗакрытия.Папка, БиблиотекаКартинок.СправочникГруппа, БиблиотекаКартинок.Ресурс);
	
	ТекущаяСтрока = НовыйПоказатель.ПолучитьИдентификатор();
	
	МассивПутей = Новый Структура;
	МассивПутей.Вставить("Показатели", ТекущаяСтрока);
	
	Если РезультатЗакрытия.Папка Тогда
		ЗаполнитьКоллекциюИзХранилища(РезультатЗакрытия.АдресТаблицы, МассивПутей);
	КонецЕсли;
	
	Элементы.Показатели.ТекущаяСтрока = ТекущаяСтрока;
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Если Копирование Тогда
		Возврат;
	КонецЕсли;
	
	Отказ = Истина;
	
	ПараметрыВыбора = Новый Структура;
	ПараметрыВыбора.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	ПараметрыВыбора.Вставить("Событие",         "Отбор");
	ПараметрыВыбора.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
	
	ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("ОповещениеНовыйОтбор", ЭтаФорма);
	ОткрытьФорму("ОбщаяФорма.ФормаВыбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеНовыйОтбор(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	
	//Если НЕ ТипЗнч(РезультатЗакрытия) = Тип("Структура") Тогда
	//	Возврат;
	//КонецЕсли;
	//
	//ТекущиеДанные = ЭтаФорма.ТекущийЭлемент.ТекущиеДанные;
	//
	//ЭлементыОтбора = ОтчетыКлиент.ПолучитьЭлементыДляДерева(ТекущиеДанные, Отбор);
	//
	//НовыйОтбор = ЭлементыОтбора.Добавить();
	//НовыйОтбор.Использование = Истина;
	//НовыйОтбор.Заголовок     = РезультатЗакрытия.Заголовок;
	//НовыйОтбор.ЛевоеЗначение = РезультатЗакрытия.Поле;
	//НовыйОтбор.ВидСравнения  = ПредопределенноеЗначение(РезультатЗакрытия.ВидСравнения);
	////НовыйОтбор.ПравоеЗначение
	//НовыйОтбор.Папка         = Ложь;
	//
	//Элементы.Отбор.ТекущаяСтрока = НовыйОтбор.ПолучитьИдентификатор();
	
КонецПроцедуры

&НаКлиенте
Функция ОтборПоСписку(ВидСравненияОтбора)
	
	Результат = Ложь;
	Если ВидСравненияОтбора = ВидСравненияКомпоновкиДанных.ВСписке ИЛИ 
		ВидСравненияОтбора = ВидСравненияКомпоновкиДанных.ВСпискеПоИерархии ИЛИ
		ВидСравненияОтбора = ВидСравненияКомпоновкиДанных.НеВСписке ИЛИ 
		ВидСравненияОтбора= ВидСравненияКомпоновкиДанных.НеВСпискеПоИерархии Тогда
		
		Результат = Истина;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура ОтборПравоеЗначениеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ТекущиеДанные = Элементы.Отбор.ТекущиеДанные;
		
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
		
	Если ТекущиеДанные.ВидСравнения = ВидСравненияКомпоновкиДанных.Заполнено ИЛИ 
		ТекущиеДанные.ВидСравнения = ВидСравненияКомпоновкиДанных.НеЗаполнено Тогда
		
		СтандартнаяОбработка = Истина;
		
	КонецЕсли;
	
	Если ОтборПоСписку(ТекущиеДанные.ВидСравнения) Тогда
		
		СтандартнаяОбработка = Ложь;
		ДоступноеПоле = Отчет.КомпоновщикНастроек.Настройки.ДоступныеПоляОтбора.НайтиПоле(ТекущиеДанные.ЛевоеЗначение);
		
		Если ТекущиеДанные.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСпискеПоИерархии ИЛИ
			 ТекущиеДанные.ВидСравнения = ВидСравненияКомпоновкиДанных.НеВСпискеПоИерархии Тогда
			ТолькоГруппы = Истина;
		Иначе
			ТолькоГруппы = Ложь;
		КонецЕсли;
		
		СтруктураПараметров = Новый Структура("СписокВыбора, ТипЗначения, ДоступныеЗначения, ТолькоГруппы", ТекущиеДанные.ПравоеЗначение, ДоступноеПоле.ТипЗначения, ДоступноеПоле.ДоступныеЗначения, ТолькоГруппы);
		
		ОписаниеОповещенияВыбораЗначения = Новый ОписаниеОповещения("ОповещениеВыбораЗначенияОтбора", ЭтаФорма);
		ОткрытьФорму("ОбщаяФорма.ОтчетВыборЗначенияОтбораИзСписка", СтруктураПараметров, Элемент,,,, ОписаниеОповещенияВыбораЗначения, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеВыбораЗначенияОтбора(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	
	Если ТипЗнч(РезультатЗакрытия) = Тип("СписокЗначений") Тогда
		
		ТекущиеДанные = Элементы.Отбор.ТекущиеДанные;
		
		Если ТекущиеДанные = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		ТекущиеДанные.ПравоеЗначение = РезультатЗакрытия;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьФормуВыбора(Элемент, ФормаВыбора)
	
	Элемент.ФормаВыбора = ФормаВыбора;
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборПередНачаломИзменения(Элемент, Отказ)
	
	Поле = Элементы.Отбор.ТекущийЭлемент;
	Если Поле.Имя = "ОтборПравоеЗначение" ИЛИ Поле.Имя = "ОтборВидСравнения" Тогда
		
		СтандартнаяОбработка = Истина;
		ВыбраннаяСтрока      = Неопределено;
		ОтборВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекущиеДанные = Элементы.Отбор.ТекущиеДанные;
	
	Если Поле.Имя = "ОтборЗаголовок" Тогда
		
		СтандартнаяОбработка = Ложь;
		
		Если ТекущиеДанные = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		ПараметрыВыбора = Новый Структура;
		ПараметрыВыбора.Вставить("СхемаКомпоновки", СхемаКомпоновки);
		ПараметрыВыбора.Вставить("Событие",         "Отбор");
		ПараметрыВыбора.Вставить("ТекущееПоле",     ТекущиеДанные.ЛевоеЗначение);
		ПараметрыВыбора.Вставить("ВидСравнения",    ПолучитьПолноеИмяПредопределенногоЗначения(ТекущиеДанные.ВидСравнения));
		ПараметрыВыбора.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
		
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("ТекущиеДанные", ТекущиеДанные);
		
		ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("ОповещениеИзменениеОтбора", ЭтаФорма, ДополнительныеПараметры);
		ОткрытьФорму("ОбщаяФорма.ФормаВыбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	ИначеЕсли Поле.Имя = "ОтборВидСравнения" Тогда
		
		Если ТекущиеДанные = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		СписокВыбора = Элементы.ОтборВидСравнения.СписокВыбора;
		СписокВыбора.Очистить();
		
		ДоступноеПолеОтбора = Отчет.КомпоновщикНастроек.Настройки.ДоступныеПоляОтбора.НайтиПоле(ТекущиеДанные.ЛевоеЗначение);
		Если НЕ ДоступноеПолеОтбора = Неопределено Тогда
			Для Каждого ДоступноеСравнения Из ДоступноеПолеОтбора.ДоступныеВидыСравнения Цикл
				СписокВыбора.Добавить(ДоступноеСравнения.Значение, Строка(ДоступноеСравнения.Значение));
			КонецЦикла;
		КонецЕсли;
		
	ИначеЕсли Поле.Имя = "ОтборПравоеЗначение" Тогда
		
		Если ТекущиеДанные = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		Если ТекущиеДанные.Папка Тогда
			Возврат;
		КонецЕсли;
		
		ДоступноеПоле = Отчет.КомпоновщикНастроек.Настройки.ДоступныеПоляОтбора.НайтиПоле(ТекущиеДанные.ЛевоеЗначение);
		
		Если ДоступноеПоле = Неопределено Тогда
			Элементы.ОтборПравоеЗначение.ОграничениеТипа = Новый ОписаниеТипов("Неопределено");
		Иначе
			
			Если ТекущиеДанные.ВидСравнения = ВидСравненияКомпоновкиДанных.ВИерархии ИЛИ 
				ТекущиеДанные.ВидСравнения = ВидСравненияКомпоновкиДанных.НеВИерархии Тогда
				Элементы.ОтборПравоеЗначение.ВыборГруппИЭлементов = ГруппыИЭлементы.Группы;
			ИначеЕсли ДоступноеПоле.ВыборГруппИЭлементов = ИспользованиеГруппИЭлементов.ГруппыИЭлементы Тогда
				Элементы.ОтборПравоеЗначение.ВыборГруппИЭлементов = ГруппыИЭлементы.ГруппыИЭлементы;
			ИначеЕсли ДоступноеПоле.ВыборГруппИЭлементов = ИспользованиеГруппИЭлементов.Элементы Тогда
				Элементы.ОтборПравоеЗначение.ВыборГруппИЭлементов = ГруппыИЭлементы.Элементы;
			Иначе
				Элементы.ОтборПравоеЗначение.ВыборГруппИЭлементов = ГруппыИЭлементы.Группы;
			КонецЕсли;
			
			//Элементы.ОтборПравоеЗначение.КнопкаСпискаВыбора
			//Элементы.ОтборПравоеЗначение.РежимВыбораИзСписка = Истина;
			
			Элементы.ОтборПравоеЗначение.БыстрыйВыбор         = ДоступноеПоле.БыстрыйВыбор;
			Элементы.ОтборПравоеЗначение.Маска                = ДоступноеПоле.Маска;
			//Элементы.ОтборПравоеЗначение.СвязьПоТипу          = ДоступноеПоле.СвязьПоТипу;
			Элементы.ОтборПравоеЗначение.ФорматРедактирования = ДоступноеПоле.ФорматРедактирования;
			
			Если НЕ ДоступноеПоле.ФормаВыбора = "" Тогда
				УстановитьФормуВыбора(Элементы.ОтборПравоеЗначение, ДоступноеПоле.ФормаВыбора);
			КонецЕсли;
			
			//Элементы.ОтборПравоеЗначение.ТипЗначения          = ДоступноеПоле.ТипЗначения;
			
			//Элементы.ОтборПравоеЗначение.ДоступныеВидыСравнения = //ДоступноеПоле.ДоступныеВидыСравнения
			//ТекущиеДанные.ВидСравнения
			
			Элементы.ОтборПравоеЗначение.ОграничениеТипа      = ДоступноеПоле.ТипЗначения;
			
			Элементы.ОтборПравоеЗначение.КнопкаВыбора = Истина;
			МассивТипов = ДоступноеПоле.ТипЗначения.Типы();
			Если МассивТипов.Количество()> 0 Тогда
				Если МассивТипов[0] = Тип("Строка") Тогда
					Элементы.ОтборПравоеЗначение.КнопкаВыбора = Ложь;
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборДобавить(Команда)
	
	//Элементы.Отбор.ДобавитьСтроку();
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборДобавитьГруппу(Команда)
	
	//ТекущиеДанные = Элементы.Отбор.ТекущиеДанные;
	//
	//ЭлементыОтбора = ОтчетыКлиент.ПолучитьЭлементыДляДерева(ТекущиеДанные, Отбор);
	//
	//НоваяГруппаОтборов = ЭлементыОтбора.Добавить();
	//НоваяГруппаОтборов.Использование = Истина;
	//НоваяГруппаОтборов.Папка         = Истина;
	//НоваяГруппаОтборов.ТипГруппы     = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИли;
	//
	//Элементы.Отбор.ТекущаяСтрока = НоваяГруппаОтборов.ПолучитьИдентификатор();
	//
КонецПроцедуры

&НаКлиенте
Процедура ОтборУдалить(Команда)
	
	//ТекущиеДанные = Элементы.Отбор.ТекущиеДанные;
	//Если ТекущиеДанные = Неопределено Тогда
	//	Возврат;
	//КонецЕсли;
	//
	//ЭлементыОтбора = Отбор.ПолучитьЭлементы();
	//
	//ИндексСтроки = ЭлементыОтбора.Индекс(ТекущиеДанные);
	//ЭлементыОтбора.Удалить(ИндексСтроки);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборПереместитьВверх(Команда)
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаКлиенте
Процедура ТочкиНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	СтруктураПараметров.Вставить("ТекущееПоле",     ТекущиеДанные.Точки);
	СтруктураПараметров.Вставить("Событие",         "Точки");
	СтруктураПараметров.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
	
	МассивПутей = Новый Структура;
	МассивПутей.Вставить("СписокТаблиц", Элементы.СписокТаблиц.ТекущаяСтрока);
	//МассивПутей.Вставить("Точки");
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
	ДополнительныеПараметры.Вставить("Событие",     "Точки");
	
	ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
	ОткрытьФорму("ОбщаяФорма.ФормаВыбораПолейОтчета", СтруктураПараметров, Элемент,,,, ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура СерииНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	СтруктураПараметров.Вставить("ТекущееПоле",     ТекущиеДанные.Серии);
	СтруктураПараметров.Вставить("Событие",         "Серии");
	СтруктураПараметров.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
	
	МассивПутей = Новый Структура;
	МассивПутей.Вставить("СписокТаблиц", Элементы.СписокТаблиц.ТекущаяСтрока);
	//МассивПутей.Вставить("Серии");
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
	ДополнительныеПараметры.Вставить("Событие",     "Серии");
	
	ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
	ОткрытьФорму("ОбщаяФорма.ФормаВыбораПолейОтчета", СтруктураПараметров, Элемент,,,, ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказательНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	СтруктураПараметров.Вставить("ТекущееПоле",     ТекущиеДанные.Показатель);
	СтруктураПараметров.Вставить("Событие",         "Показатель");
	СтруктураПараметров.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
	
	МассивПутей = Новый Структура;
	МассивПутей.Вставить("СписокТаблиц", Элементы.СписокТаблиц.ТекущаяСтрока);
	//МассивПутей.Вставить("Показатель");
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
	ДополнительныеПараметры.Вставить("Событие",     "Показатель");
	
	ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
	ОткрытьФорму("ОбщаяФорма.ФормаВыбораПолейОтчета", СтруктураПараметров, Элемент,,,, ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ТипДиаграммыОтчетаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	//СтандартнаяОбработка = Ложь;
	//
	//ОписаниеОповещенияОВыборе = Новый ОписаниеОповещения("ОповещениеВыбораТипаДиаграммы", ЭтаФорма);
	//ОткрытьФорму("ОбщаяФорма.ФормаВыбораТипаДиаграммы", , ЭтаФорма, ЭтаФорма, , , ОписаниеОповещенияОВыборе, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ТипДиаграммыОтчетаНачалоВыбораИзСписка(Элемент, СтандартнаяОбработка)
	
	//СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеВыбораТипаДиаграммы(ВыбранныйТипДиаграммы, ДополнительныеПараметры) Экспорт
	
	ТекДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если ТекДанные <> Неопределено И ВыбранныйТипДиаграммы <> Неопределено Тогда
		Элементы.СписокТаблиц.ТекущиеДанные.ТипДиаграммы = ВыбранныйТипДиаграммы;
		
		ЭтоДвухмернаяДиаграмма = ОтчетыКлиентСервер.ДвухмернаяДиаграмма(ВыбранныйТипДиаграммы);
		Элементы.Точки.Доступность                  = ЭтоДвухмернаяДиаграмма;
		Элементы.КоличествоЗаписейТочек.Доступность = ЭтоДвухмернаяДиаграмма;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТипДиаграммыОтчетаПриИзменении(Элемент)
	
	// Устанавливаем картинку типа диаграммы.
	Попытка
		Элементы.ДекорацияТипДиаграммы.Картинка = БиблиотекаКартинок[Элементы.СписокТаблиц.ТекущиеДанные.ТипДиаграммы];
	Исключение
		Элементы.ДекорацияТипДиаграммы.Картинка = БиблиотекаКартинок.Диаграмма;
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура ДекорацияТипДиаграммыНажатие(Элемент)
	
	//ОписаниеОповещенияОВыборе = Новый ОписаниеОповещения("ОповещениеВыбораТипаДиаграммы", ЭтаФорма);
	//ОткрытьФорму("ОбщаяФорма.ФормаВыбораТипаДиаграммы", , ЭтаФорма, ЭтаФорма, , , ОписаниеОповещенияОВыборе, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборПравоеЗначениеПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Отбор.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	ТекущиеДанные.Использование = ЗначениеЗаполнено(ТекущиеДанные.ПравоеЗначение);
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеПодбора(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	
	Если НЕ ТипЗнч(РезультатЗакрытия) = Тип("Структура") Тогда
		Возврат;
	КонецЕсли;
		
	Если РезультатЗакрытия.Событие = "Точки" ИЛИ РезультатЗакрытия.Событие = "Серии" ИЛИ РезультатЗакрытия.Событие = "Показатель" Тогда
		
		ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
		
	Иначе
		
		ТекущиеДанные = ЭтаФорма.ТекущийЭлемент.ТекущиеДанные;
		
	КонецЕсли;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если РезультатЗакрытия.Событие = "ПоляГруппировки" Тогда
		
		ТекущиеДанные.Заголовок = ?(РезультатЗакрытия.Заголовок = "", "Детальные записи", РезультатЗакрытия.Заголовок);
		ТекущиеДанные.ПоляГруппировки.Очистить();
		Для Каждого ПолеГруппировки Из РезультатЗакрытия.ПоляГруппировки Цикл
			
			НоваяСтрока = ТекущиеДанные.ПоляГруппировки.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ПолеГруппировки);
			
		КонецЦикла;
		
	ИначеЕсли РезультатЗакрытия.Событие = "Точки" Тогда
		
		ТекущиеДанные.ТочкиЗаголовок = РезультатЗакрытия.Заголовок;
		ТекущиеДанные.Точки          = РезультатЗакрытия.Поле;
		
	ИначеЕсли РезультатЗакрытия.Событие = "Серии" Тогда
		
		ТекущиеДанные.СерииЗаголовок = РезультатЗакрытия.Заголовок;
		ТекущиеДанные.Серии          = РезультатЗакрытия.Поле;
		
	ИначеЕсли РезультатЗакрытия.Событие = "Выбор" Тогда
		
		ТекущиеДанные.ПредставлениеПолей = РезультатЗакрытия.Заголовок;
		РеквизитыГруппировки = ТекущиеДанные.Выбор.ПолучитьЭлементы();
		РеквизитыГруппировки.Очистить();
		Для Каждого ПолеВыбора Из РезультатЗакрытия.ПоляВыбора Цикл
			
			НоваяСтрока = РеквизитыГруппировки.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ПолеВыбора);
			
		КонецЦикла;
		
	ИначеЕсли РезультатЗакрытия.Событие = "Порядок" Тогда
		
		ТекущиеДанные.ПредставлениеПорядка = ?(РезультатЗакрытия.Заголовок = "", "Авто", РезультатЗакрытия.Заголовок);
		ТекущиеДанные.Порядок.Очистить();
		Для Каждого ПолеПорядка Из РезультатЗакрытия.ПоляПорядка Цикл
			
			НоваяСтрока = ТекущиеДанные.Порядок.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ПолеПорядка);
			
		КонецЦикла;
		
	ИначеЕсли РезультатЗакрытия.Событие = "Ресурсы" Тогда
		
		ТекущиеДанные.Заголовок = РезультатЗакрытия.Заголовок;
		ТекущиеДанные.Поле      = РезультатЗакрытия.Поле;
		
	КонецЕсли;
		
КонецПроцедуры

&НаСервере
// Функция помещает список работ во временное хранилище и возвращает адрес 
//
Функция ПоместитьРесурсыВХранилище()
	
	ТекущаяСтрока = Элементы.СписокТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ДанныеТаблицы = СписокТаблиц.НайтиПоИдентификатору(ТекущаяСтрока);
	
	Возврат ПоместитьВоВременноеХранилище(ДанныеТаблицы.Показатели.Выгрузить(), УникальныйИдентификатор);
	
КонецФункции // ПоместитьРесурсыВХранилище()

&НаСервере
Процедура ЗагрузитьНастройкиНаСервере(ТекстXML)
	
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.УстановитьСтроку(ТекстXML);
	
	НастройкиОтчета = СериализаторXDTO.ПрочитатьXML(ЧтениеXML);
	
	Отчет.КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СхемаКомпоновки));
	Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(НастройкиОтчета);
	
	ОбновитьНастройкиОтчета(Отчет.КомпоновщикНастроек.Настройки);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьНастройки(Команда)
	
	ВыборФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ВыборФайла.МножественныйВыбор = Ложь;
	//ВыборФайла.ПолноеИмяФайла = ИмяСРасширением;
	//Фильтр = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
	//НСтр("ru = 'Все файлы (*.%1)|*.%1'"), "xml", "xml");
	
	Фильтр = НСтр("ru = 'Все файлы (*.xml)|*.xml'");
	
	ВыборФайла.Фильтр = Фильтр;
	//ВыборФайла.Каталог = ПутьВыбора;
	
	Если НЕ ВыборФайла.Выбрать() Тогда
		Возврат;
	КонецЕсли;
	
	//ТекстXML = ОбщегоНазначения.ЗначениеВСтрокуXML(Отчет.КомпоновщикНастроек.Настройки);
	
	ТД = Новый ТекстовыйДокумент;
	ТД.Прочитать(ВыборФайла.ПолноеИмяФайла, КодировкаТекста.UTF8);
	ТекстXML = ТД.ПолучитьТекст();
	
	ЗагрузитьНастройкиНаСервере(ТекстXML);
	
	//Если РежимТолькоЭксперт Тогда
	//	ОткрытьФормуЭксперта();
	//КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ВыгрузитьНастройкиНаСервере()
	
	ОбновитьНастройкиСКД();
	
	Настройки = Отчет.КомпоновщикНастроек.Настройки;
	
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку();
	СериализаторXDTO.ЗаписатьXML(ЗаписьXML, Настройки, НазначениеТипаXML.Явное);
	
	ТекстXML = ЗаписьXML.Закрыть();
	
	Возврат ТекстXML;
	
КонецФункции

&НаКлиенте
Процедура ВыгрузитьНастройки(Команда)
	
	ВыборФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
	ВыборФайла.МножественныйВыбор = Ложь;
	//ВыборФайла.ПолноеИмяФайла = ИмяСРасширением;
	Фильтр = НСтр("ru = 'Все файлы (*.xml)|*.xml'");
	ВыборФайла.Фильтр = Фильтр;
	
	Если НЕ ВыборФайла.Выбрать() Тогда
		Возврат;
	КонецЕсли;
	
	ТекстXML = ВыгрузитьНастройкиНаСервере();
	
	ТД = Новый ТекстовыйДокумент;
	ТД.УстановитьТекст(ТекстXML);
	ТД.Записать(ВыборФайла.ПолноеИмяФайла, КодировкаТекста.UTF8);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьНастройкиСКД()
	
	ОтчетыСервер.ЗаполнитьНастройкиТаблицыИзСтраницы(ЭтаФорма);
	
	НастройкиСКД = Отчет.КомпоновщикНастроек.Настройки;
	
	// Начало периода
	ДоступныйПараметр = НастройкиСКД.ПараметрыДанных.ДоступныеПараметры.НайтиПараметр(Новый ПараметрКомпоновкиДанных("ДатаНачала"));
	Если НЕ ДоступныйПараметр = Неопределено Тогда
		НастройкиСКД.ПараметрыДанных.УстановитьЗначениеПараметра("ДатаНачала", НачалоПериода);
	КонецЕсли;
	
	// Конец периода
	ЗначениеПериода = ?(КонецПериода = Дата(1, 1, 1), КонецДня(ТекущаяДата()), КонецДня(КонецПериода));
	
	ДоступныйПараметр = НастройкиСКД.ПараметрыДанных.ДоступныеПараметры.НайтиПараметр(Новый ПараметрКомпоновкиДанных("ДатаОкончания"));
	Если НЕ ДоступныйПараметр = Неопределено Тогда
		НастройкиСКД.ПараметрыДанных.УстановитьЗначениеПараметра("ДатаОкончания", ЗначениеПериода);
	КонецЕсли;
	
	// Конец периода с границей
	ДоступныйПараметр = НастройкиСКД.ПараметрыДанных.ДоступныеПараметры.НайтиПараметр(Новый ПараметрКомпоновкиДанных("ДатаОкончанияГраница"));
	Если НЕ ДоступныйПараметр = Неопределено Тогда
		НастройкиСКД.ПараметрыДанных.УстановитьЗначениеПараметра("ДатаОкончанияГраница", Новый Граница(ЗначениеПериода, ВидГраницы.Включая));
	КонецЕсли;
	
	//// Параметры
	//ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(НастройкиСКД.ПараметрыДанных.Элементы, ПараметрыДанных.ПолучитьЭлементы());
	
	//// Отбор отчета
	//ДеревоОтбор = Отбор.ПолучитьЭлементы();
	//ОтборСКД    = НастройкиСКД.Отбор.Элементы;
	//ОтборСКД.Очистить();
	//
	//ОтчетыСервер.ЗаполнитьНастройкиСКД(ОтборСКД, ДеревоОтбор);
	
	// Показатели отчета
	ПоказателиСКД = НастройкиСКД.Выбор;
	ПоказателиСКД.Элементы.Очистить();
	
	Если СписокТаблиц.Количество() > 1 Тогда
		НовоеПоле = ПоказателиСКД.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
		НовоеПоле.Использование = Истина;
	КонецЕсли;
	
	// Структура отчета
	СтруктураСКД = НастройкиСКД.Структура;
	СтруктураСКД.Очистить();
	
	Для Каждого ТекущаяТаблица Из СписокТаблиц Цикл
		
		Если ТекущаяТаблица.ВидТаблицы = "Таблица" Тогда
			ТаблицаСКД = СтруктураСКД.Добавить(Тип("ТаблицаКомпоновкиДанных"));
			ТаблицаСКД.Использование = ТекущаяТаблица.Использование;
			
			НовоеПоле = ТаблицаСКД.Выбор.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
			НовоеПоле.Использование = Истина;
			
			ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ТаблицаСКД.Строки,  ТекущаяТаблица.ГруппировкиСтрок);
			ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ТаблицаСКД.Колонки, ТекущаяТаблица.ГруппировкиКолонок);
			
			// Заполнение Условного оформления таблицы
			ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ТаблицаСКД.УсловноеОформление.Элементы, ТекущаяТаблица.УсловноеОформление.Элементы);
			// Заполнение Параметров вывода
			ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ТаблицаСКД.ПараметрыВывода.Элементы, ТекущаяТаблица.ПараметрыВывода.ПолучитьЭлементы());
			
			Если СписокТаблиц.Количество() = 1 Тогда
				ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ПоказателиСКД.Элементы, ТекущаяТаблица.Показатели.Элементы);
				//НастройкиСКД.ПараметрыВывода.УстановитьЗначениеПараметра("МакетОформления", ТекущаяТаблица.ОформлениеТаблицы);
			Иначе
				ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ТаблицаСКД.Выбор.Элементы, ТекущаяТаблица.Показатели.Элементы);
			КонецЕсли;
			
			//ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ТаблицаСКД.Порядок.Элементы, ТекущаяТаблица.Порядок.Элементы);
			
			ТаблицаСКД.ПараметрыВывода.УстановитьЗначениеПараметра("МакетОформления", ТекущаяТаблица.ОформлениеТаблицы);
			
			Если ТекущаяТаблица.РеквизитыОтдельно Тогда
				ТаблицаСКД.ПараметрыВывода.УстановитьЗначениеПараметра("РасположениеРеквизитов", РасположениеРеквизитовКомпоновкиДанных.Отдельно);
			Иначе
				ПараметрОформления = ТаблицаСКД.ПараметрыВывода.Элементы.Найти("РасположениеРеквизитов");
				Если (НЕ ПараметрОформления = Неопределено) И ПараметрОформления.Использование И ПараметрОформления.Значение = РасположениеРеквизитовКомпоновкиДанных.Отдельно Тогда
					ТаблицаСКД.ПараметрыВывода.УстановитьЗначениеПараметра("РасположениеРеквизитов", РасположениеРеквизитовКомпоновкиДанных.ВместеСВладельцем);
				КонецЕсли;
			КонецЕсли;
			
			//Если ТекущаяТаблица.ОформлениеТаблицы = "" Тогда
			//	МакетОформления = БиблиотекаМакетовОформленияКомпоновкиДанных[1];
			//Иначе
			//	МакетОформления = БиблиотекаМакетовОформленияКомпоновкиДанных[ТекущаяТаблица.ОформлениеТаблицы];
			//КонецЕсли;
			
			//ТаблицаСКД.ПараметрыВывода.УстановитьЗначениеПараметра("МакетОформления", ТекущаяТаблица.ОформлениеТаблицы);
				
		//	ПараметрОформления = Отчет.КомпоновщикНастроек.Настройки.ПараметрыВывода.Элементы.Найти("МакетОформления");
		//Если НЕ ПараметрОформления = Неопределено Тогда
		//	ПараметрОформления.Значение = ИмяОформления;
		//	ПараметрОформления.Использование = Истина;
		//КонецЕсли;
			
		ИначеЕсли ТекущаяТаблица.ВидТаблицы = "Диаграмма" Тогда
			
			ДиаграммаСКД = СтруктураСКД.Добавить(Тип("ДиаграммаКомпоновкиДанных"));
			ДиаграммаСКД.Использование = ТекущаяТаблица.Использование;
			
			НовоеПоле = ДиаграммаСКД.Выбор.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
			НовоеПоле.Использование = Истина;
			
			// Заполнение Условного оформления таблицы
			ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ДиаграммаСКД.УсловноеОформление.Элементы, ТекущаяТаблица.УсловноеОформление.Элементы);
			// Заполнение Параметров вывода
			ОтчетыКлиентСервер.ЗаполнитьНастройкиСКД(ДиаграммаСКД.ПараметрыВывода.Элементы, ТекущаяТаблица.ПараметрыВывода.ПолучитьЭлементы());
			
			// Добавим точки диаграммы
			Если ОтчетыКлиентСервер.ДвухмернаяДиаграмма(ТекущаяТаблица.ТипДиаграммы) Тогда
				
				ОтчетыСервер.ДобавитьГруппировкуДиаграммы(ДиаграммаСКД.Точки, ТекущаяТаблица.Точки, НастройкиСКД.ДоступныеПоляГруппировок, ТекущаяТаблица.КоличествоЗаписейТочек);
				
			КонецЕсли;
			
			// Добавим серии диаграммы
			ОтчетыСервер.ДобавитьГруппировкуДиаграммы(ДиаграммаСКД.Серии, ТекущаяТаблица.Серии, НастройкиСКД.ДоступныеПоляГруппировок, ТекущаяТаблица.КоличествоЗаписейСерий);
			
			// Добавим показатель диаграммы
			Если СписокТаблиц.Количество() = 1 Тогда
				Показатель = ПоказателиСКД.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
			Иначе
				Показатель = ДиаграммаСКД.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
			КонецЕсли;
			Показатель.Использование = Истина;
			Показатель.Поле          = ТекущаяТаблица.Показатель;
			
			Если НЕ ТекущаяТаблица.ТипДиаграммы = "" Тогда
				ТипДиаграммыЗначение = ТипДиаграммы[ТекущаяТаблица.ТипДиаграммы];
				ДиаграммаСКД.ПараметрыВывода.УстановитьЗначениеПараметра("ТипДиаграммы", ТипДиаграммыЗначение);
			КонецЕсли;
			
			Если НЕ ТекущаяТаблица.ВидПодписей = "" Тогда
				ВидПодписейЗначение = ПредопределенноеЗначение(ТекущаяТаблица.ВидПодписей);
				ДиаграммаСКД.ПараметрыВывода.УстановитьЗначениеПараметра("ТипДиаграммы.ВидПодписей", ВидПодписейЗначение);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура СформироватьОтчет(Команда)
	
	ОбновитьНастройкиСКД();
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("КлючВарианта",          СокрЛП(ЭтаФорма.КлючТекущегоВарианта));
	СтруктураПараметров.Вставить("ПредставлениеВарианта", СокрЛП(ЭтаФорма.ПредставлениеТекущегоВарианта));
	СтруктураПараметров.Вставить("Вариант",               ОтчетыСервер.КомпоновщикПолучитьНастройки(Отчет.КомпоновщикНастроек));
	СтруктураПараметров.Вставить("НачалоПериода",         НачалоПериода);
	СтруктураПараметров.Вставить("КонецПериода",          КонецДня(КонецПериода));
	СтруктураПараметров.Вставить("ВидПериода",            ВидПериода);
	
	Закрыть(СтруктураПараметров);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборВидСравненияПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Отбор.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущиеДанные.Папка Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущиеДанные.ВидСравнения = ПредопределенноеЗначение("ВидСравненияКомпоновкиДанных.Заполнено") ИЛИ 
		ТекущиеДанные.ВидСравнения = ПредопределенноеЗначение("ВидСравненияКомпоновкиДанных.НеЗаполнено") Тогда
		ТекущиеДанные.ВыводитьТолькоЗаголовок = Истина;
	Иначе
		ТекущиеДанные.ВыводитьТолькоЗаголовок = Ложь;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаОформлениеТаблицы(Команда)
	
	ИмяОформления = СтрЗаменить(Команда.Имя, Команда.Действие, "");
	ТекОформление = ОтчетыВызовСервера.ПолучитьОформление(ИмяОформления);
	Если Не ТекОформление = Неопределено Тогда
		
		//ПараметрОформления = Отчет.КомпоновщикНастроек.Настройки.ПараметрыВывода.Элементы.Найти("МакетОформления");
		//Если НЕ ПараметрОформления = Неопределено Тогда
		//	ПараметрОформления.Значение = ИмяОформления;
		//	ПараметрОформления.Использование = Истина;
		//КонецЕсли;
		
		ИмяЭлемента = "Оформление"+ИмяОформления;
		Для Каждого ТекЭлемент Из Элементы.ГруппаОформлениеТаблицы.ПодчиненныеЭлементы Цикл
			ТекЭлемент.Пометка = (ТекЭлемент.Имя = ИмяЭлемента);
		КонецЦикла;
		
		Элементы.ГруппаОформлениеТаблицы.Заголовок = ТекОформление.Представление;
		
	КонецЕсли;
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	Если НЕ ТекущиеДанные = Неопределено Тогда
		ТекущиеДанные.ОформлениеТаблицы = ИмяОформления;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПараметрыДанныхВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекущиеДанные = Элементы.ПараметрыДанных.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ДоступныйПараметр = Отчет.КомпоновщикНастроек.Настройки.ПараметрыДанных.ДоступныеПараметры.НайтиПараметр(ТекущиеДанные.Параметр);
	
	Если ДоступныйПараметр = Неопределено Тогда
		Элементы.ПараметрыДанныхЗначение.ОграничениеТипа = Новый ОписаниеТипов("Неопределено");
	Иначе
		
		Если ДоступныйПараметр.ВыборГруппИЭлементов = ИспользованиеГруппИЭлементов.ГруппыИЭлементы Тогда
			Элементы.ПараметрыДанныхЗначение.ВыборГруппИЭлементов = ГруппыИЭлементы.ГруппыИЭлементы;
		ИначеЕсли ДоступныйПараметр.ВыборГруппИЭлементов = ИспользованиеГруппИЭлементов.Элементы Тогда
			Элементы.ПараметрыДанныхЗначение.ВыборГруппИЭлементов = ГруппыИЭлементы.Элементы;
		Иначе
			Элементы.ПараметрыДанныхЗначение.ВыборГруппИЭлементов = ГруппыИЭлементы.Группы;
		КонецЕсли;
		
		Элементы.ПараметрыДанныхЗначение.БыстрыйВыбор         = ДоступныйПараметр.БыстрыйВыбор;
		Элементы.ПараметрыДанныхЗначение.Маска                = ДоступныйПараметр.Маска;
		//Элементы.ПараметрыДанныхЗначение.СвязьПоТипу          = ДоступныйПараметр.СвязьПоТипу;
		Элементы.ПараметрыДанныхЗначение.ФорматРедактирования = ДоступныйПараметр.ФорматРедактирования;
		
		Если НЕ ДоступныйПараметр.ФормаВыбора = "" Тогда
			ОтчетыВызовСервера.УстановитьФормуВыбора(Элементы.ПараметрыДанныхЗначение, ДоступныйПараметр.ФормаВыбора);
		КонецЕсли;
		
		Элементы.ПараметрыДанныхЗначение.ОграничениеТипа      = ДоступныйПараметр.ТипЗначения;
		Элементы.ПараметрыДанныхЗначение.КнопкаВыбора         = Истина;
		МассивТипов = ДоступныйПараметр.ТипЗначения.Типы();
		Если МассивТипов.Количество()> 0 Тогда
			Если МассивТипов[0] = Тип("Строка") Тогда
				Элементы.ПараметрыДанныхЗначение.КнопкаВыбора = Ложь;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПараметрыДанныхЗначениеПриИзмененииНаСервере()
	
	//ТекущаяСтрока = Элементы.ПараметрыДанных.ТекущаяСтрока;
	//ОтчетОбъект = РеквизитФормыВЗначение("Отчет");
	//ДанныеСтроки = ПараметрыДанных.НайтиПоИдентификатору(ТекущаяСтрока);
	//
	//Попытка
	//	ОтчетОбъект.ПриИзмененииПараметра(ЭтаФорма, ДанныеСтроки);
	//Исключение
	//КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура ПараметрыДанныхЗначениеПриИзменении(Элемент)
	
	//ТекущаяСтрока = Элементы.ПараметрыДанных.ТекущаяСтрока;
	//Если ТекущаяСтрока = Неопределено Тогда
	//	Возврат;
	//КонецЕсли;
	//
	//ПараметрыДанныхЗначениеПриИзмененииНаСервере();
	//
КонецПроцедуры

&НаСервере
Процедура ОбновитьСписокВариантовОтчета()
	
	ОтчетыСервер.ОбновитьСписокВариантовОтчета(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "ВариантыОтчетов.ИзменениеВарианта" И ТипЗнч(Параметр) = Тип("Структура") Тогда
		ПредставлениеТекущегоВарианта = Параметр.НаименованиеВарианта;
		КлючТекущегоВарианта          = Параметр.КлючВарианта;
		// Если изменился список вариантов
		Если Параметр.ВариантЭтоНовый Тогда
			ОбновитьСписокВариантовОтчета();
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СписокТаблицПорядокНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если Элементы.СписокТаблиц.ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	МассивПутей = Новый Структура;
	МассивПутей.Вставить("СписокТаблиц",    Элементы.СписокТаблиц.ТекущаяСтрока);
	//МассивПутей.Вставить("Порядок");
	
	ПараметрыВыбора = Новый Структура;
	ПараметрыВыбора.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	ПараметрыВыбора.Вставить("Событие",         "Порядок");
	//ПараметрыВыбора.Вставить("ТекущееПоле",     ТекущиеДанные.Поле);
	ПараметрыВыбора.Вставить("ТолькоРесурсы",   Истина);
	ПараметрыВыбора.Вставить("ПоляПорядка",     Элементы.СписокТаблиц.ТекущиеДанные.Порядок);
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("МассивПутей", МассивПутей);
	ДополнительныеПараметры.Вставить("Событие",     "Порядок");
	
	ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
	ОткрытьФорму("ОбщаяФорма.ФормаПодбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура СписокТаблицПорядокОчистка(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ТекущиеДанные = Элементы.СписокТаблиц.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные.Порядок.Элементы.Очистить();
	ТекущиеДанные.ПредставлениеПорядка = "";
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьИнтервал(Команда)
	
	Период = Новый СтандартныйПериод;
	Если ЕстьНачалоПериода Тогда
		Период.ДатаНачала = НачалоПериода;
	КонецЕсли;
	Период.ДатаОкончания = КонецПериода;
	Период.Вариант = ВариантСтандартногоПериода.ПроизвольныйПериод;
	
	ДиалогРедактирования = Новый ДиалогРедактированияСтандартногоПериода;
	ДиалогРедактирования.Период = Период;
	Если ДиалогРедактирования.Редактировать() Тогда
		Если ЕстьНачалоПериода Тогда
			НачалоПериода = ДиалогРедактирования.Период.ДатаНачала;
		КонецЕсли;
		КонецПериода = ДиалогРедактирования.Период.ДатаОкончания;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказателиПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	
	Если НЕ ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Число") Тогда
		СтандартнаяОбработка = Ложь;
		ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
		Возврат;
	КонецЕсли;
	
	Если Строка = Неопределено Тогда
		СтандартнаяОбработка = Ложь;
		ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Перемещение;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказателиПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	
	Значение = ПараметрыПеретаскивания.Значение;
	
	СтандартнаяОбработка = Ложь;
	
	Если НЕ ТипЗнч(Значение) = Тип("Число") Тогда
		Возврат;
	КонецЕсли;
	
	СтрокаИсточник = Показатели.НайтиПоИдентификатору(Значение);
	
	ДеревоПоказателей = Показатели.ПолучитьЭлементы();
	
	Если Строка = Неопределено Тогда
		
		НоваяСтрока = ДеревоПоказателей.Добавить();
		
	ИначеЕсли ТипЗнч(Строка) = Тип("Число") Тогда
		
		СтрокаПриемник = Показатели.НайтиПоИдентификатору(Строка);
		
		// Нельзя перетаскивать группу в собственную ветку
		Если СтрокаИсточник.Папка Тогда
			ТекущийРодитель = СтрокаПриемник.ПолучитьРодителя();
			Пока НЕ ТекущийРодитель = Неопределено Цикл
				Если ТекущийРодитель = СтрокаИсточник Тогда
					Возврат;
				КонецЕсли;
				ТекущийРодитель = ТекущийРодитель.ПолучитьРодителя();
			КонецЦикла;
		КонецЕсли;
		
		Если СтрокаПриемник.Папка Тогда
			
			НоваяСтрока = СтрокаПриемник.ПолучитьЭлементы().Добавить();
			
		Иначе
			
			РодительПриемника = СтрокаПриемник.ПолучитьРодителя();
			Если РодительПриемника = Неопределено Тогда
				КоллекцияПриемника = ДеревоПоказателей;
			Иначе
				КоллекцияПриемника = РодительПриемника.ПолучитьЭлементы();
			КонецЕсли;
			ИндексПриемника = КоллекцияПриемника.Индекс(СтрокаПриемник);
			НоваяСтрока = КоллекцияПриемника.Вставить(ИндексПриемника+1);
			
		КонецЕсли;
		
	Иначе
		
		Возврат;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаИсточник);
	
	ОтчетыКлиентСервер.ЗаполнитьНастройкиОтчета(Этаформа, НоваяСтрока.ПолучитьЭлементы(), СтрокаИсточник.ПолучитьЭлементы());
	
	РодительИсточника = СтрокаИсточник.ПолучитьРодителя();
	Если РодительИсточника = Неопределено Тогда
		ДеревоПоказателей.Удалить(СтрокаИсточник);
	Иначе
		РодительИсточника.ПолучитьЭлементы().Удалить(СтрокаИсточник);
	КонецЕсли;
	
	Элементы.Показатели.Развернуть(НоваяСтрока.ПолучитьИдентификатор(), Истина);
	
	Элементы.Показатели.ТекущаяСтрока = НоваяСтрока.ПолучитьИдентификатор();
	
КонецПроцедуры

&НаКлиенте
Процедура КомпоновщикНастроекНастройкиПорядокПолеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ТекущиеДанные = Элементы.КомпоновщикНастроекНастройкиПорядок.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыВыбора = Новый Структура;
	ПараметрыВыбора.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	ПараметрыВыбора.Вставить("Событие",         "Ресурсы");
	ПараметрыВыбора.Вставить("ТекущееПоле",     ТекущиеДанные.Поле);
	ПараметрыВыбора.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("ТекущаяСтрока", Элементы.КомпоновщикНастроекНастройкиПорядок.ТекущаяСтрока);
	ДополнительныеПараметры.Вставить("Событие",       "ПорядокОтчета");
	
	ОписаниеОповещенияВыбораПоля = Новый ОписаниеОповещения("Подключаемый_ОбработкаРезультатаОповещения", ЭтаФорма, ДополнительныеПараметры);
	ОткрытьФорму("ОбщаяФорма.ФормаВыбораПолейОтчета", ПараметрыВыбора, ЭтаФорма,,,,ОписаниеОповещенияВыбораПоля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ОформлениеОтчета(Команда)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	СтруктураПараметров.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
	
	ФормаНастройки = ПолучитьФорму("ОбщаяФорма.ОтчетНастройкаУсловногоОформления", СтруктураПараметров, ЭтаФорма);
	
	Рез = ФормаНастройки.ОткрытьМодально();
	Если Рез = КодВозвратаДиалога.ОК Тогда
		Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(ФормаНастройки.КомпоновщикНастроек.Настройки);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПараметрыОтчета(Команда)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	СтруктураПараметров.Вставить("НастройкиОтчета", Отчет.КомпоновщикНастроек.ПолучитьНастройки());
	//СтруктураПараметров.Вставить("ВидТаблицы",      ТекущиеДанные.ВидТаблицы);
	
	ФормаНастройки = ПолучитьФорму("ОбщаяФорма.ОтчетНастройкаПараметровВывода", СтруктураПараметров, ЭтаФорма);
	
	Рез = ФормаНастройки.ОткрытьМодально();
	Если Рез = КодВозвратаДиалога.ОК Тогда
		Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(ФормаНастройки.КомпоновщикНастроек.Настройки);
	КонецЕсли;
	
КонецПроцедуры
