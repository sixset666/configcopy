Перем Соединение; 
Перем Заголовки;

Процедура Сформировать() Экспорт
	
	Если Остатки тогда 
		Остатки();
	КонецЕсли;	
	
	Если Реализации тогда 
		Реализации();
	КонецЕсли;	
	
	Если ЗаказНаряды тогда 
		Если Не ЗначениеЗаполнено(ЗаказНарядЛайт) Тогда
			ЗаказНаряды();
		Иначе
			Если ЗаказНарядЛайт.Автомобиль.БТ_МаркаАвто.Код = "000000022" Тогда  
				ВыгрузитьЗНЛайтПоТочке(400, "ОПТИМА КУБАНЬ Краснодар", Неопределено); 
			ИначеЕсли ЗаказНарядЛайт.Автомобиль.БТ_МаркаАвто.Код = "000000049" Тогда  
				ВыгрузитьЗНЛайтПоТочке(612, "Оптима Краснодар (OMODA)", справочники.БТ_ПрофилиПодключенияHTTP.НайтиПоНаименованию("Logic OMODA"));
			ИначеЕсли ЗаказНарядЛайт.Автомобиль.БТ_МаркаАвто.Код = "000000079" Тогда  
				ВыгрузитьЗНЛайтПоТочке(878, "Оптима Краснодар (JAECOO)", справочники.БТ_ПрофилиПодключенияHTTP.НайтиПоНаименованию("Logic Jaecoo"));	
			КонецЕсли;	
		КонецЕсли;	
		
	КонецЕсли;	

КонецПроцедуры   

Процедура ВыгрузитьЗНЛайтПоТочке(идТочки, ИмяТочки, Профиль) 
	
	Док = ЗаказНарядЛайт;
	
	//Если 1 = 2 Тогда
	//	Док = Документы.ЗаказНаряд.ПустаяСсылка();
	//КонецЕсли;	

	Структ = Новый Структура;
	Структ.Вставить("DealerCode", ?(идТочки = 371, "3038500","2340200"));
	Структ.Вставить("DealerDescr", ИмяТочки);
    Структ.Вставить("DealerPointId", ИдТочки);
	структ.Вставить("DocumentTypeId", 1);
	структ.Вставить("WorkorderNumber", док.номер);
	структ.Вставить("Vin", док.Автомобиль.VIN);
	структ.Вставить("CarBrand", СокрЛП(док.Автомобиль.БТ_МаркаАвто));
	структ.Вставить("CarModel", СокрЛП(док.Автомобиль.Модель));
	ГосНомер = СокрЛП(док.Автомобиль.ГосНомер);
	ГосНомер = ?(ПустаяСтрока(ГосНомер),"TRANSIT", СокрЛП(ГосНомер));
	структ.Вставить("LicencePlate", ГосНомер);
	
	_Контрагент =  Док.Контрагент;
	
	Пробег = док.Пробег;
	структ.Вставить("Odometer", ?(не ЗначениеЗаполнено(Пробег), 0, Пробег));
	структ.Вставить("ClientDescr", СокрЛП(_Контрагент));
	структ.Вставить("ClientType", ?(_Контрагент.ФормаСобственности = перечисления.ФормыСобственности.ЧастноеЛицо,1,2));
	структ.Вставить("ClientPhone", _Контрагент.Телефон);
	
	структ.Вставить("ClientInn", ?(_Контрагент.ФормаСобственности <> перечисления.ФормыСобственности.ЧастноеЛицо, _Контрагент.ИНН,""));
	структ.Вставить("ContactPersonDescr", "");
	структ.Вставить("ContactPersonPhone", _Контрагент.Телефон);
	структ.Вставить("ContactPersonEmail", "");
	структ.Вставить("IsContactPersonalDataAgreement", true);
	структ.Вставить("IsContactAgreementPhone", false);
	структ.Вставить("IsContactAgreementEmail", false);
	структ.Вставить("IsContactAgreementSms", false);
	структ.Вставить("Reason", СокрЛП(?(не ПустаяСтрока(док.ПричинаОбращения), Док.ПричинаОбращения, Док.ВидРемонта)));
	структ.Вставить("Recommendation", Док.Рекомендации);
	структ.Вставить("DateAccess", формат(док.ДатаОткрытия, "ДФ=dd.MM.yyyy"));
	структ.Вставить("DateOpen", формат(док.ДатаОткрытия, "ДФ=dd.MM.yyyy"));
	структ.Вставить("DateStart", формат(док.ДатаОткрытия,  "ДФ=dd.MM.yyyy"));
	структ.Вставить("DateFinish", формат(док.ДатаЗакрытия, "ДФ=dd.MM.yyyy"));
	структ.Вставить("DateClose", формат(док.ДатаЗакрытия, "ДФ=dd.MM.yyyy"));
	структ.Вставить("RepairTypeId",ТипРемонта(Док.ВидРемонта));
	структ.Вставить("HasMaintenance", док.ВидРемонта.код = "ЦБ000037");//ЗначениеЗаполнено(Док.БТ_НомерТО));
	структ.Вставить("HasServiceEvent", false);
	структ.Вставить("HasGoodwill", false);
	структ.Вставить("HasBenchRepair", Док.ВидРемонта.Код <> "ЦБ000042" И Док.ВидРемонта.Код <> "ЦБ000037" И Док.ВидРемонта.Код <> "ЦБ000010"); // Истина, если вид ремонта НЕ Кузовной И НЕ ТО И НЕ Гарантийный      
	структ.Вставить("HasBodyRepair", Док.ВидРемонта.Код = "ЦБ000042");
	структ.Вставить("HasPromotion", false);
	структ.Вставить("HasAddEquip", найти(нрег(док.ВидРемонта), "дополнительное оборуд") > 0);
	структ.Вставить("IsPresale", найти(док.ВидРемонта, "Предпродажная подготовка") > 0);
	структ.Вставить("IsCheck", false);
	структ.Вставить("IsCarWash", false);
	структ.Вставить("ExternalCodeEmpOpen", "");
	структ.Вставить("ExternalCodeEmpWork", "");
	структ.Вставить("ExternalCodeEmpClose", "");
	
	сч = 0;
	масдеталей = новый массив;    
	Для Каждого стрдок Из Док.Товары цикл
		
		структдетали = новый структура;
		сч = сч + 1;
		структдетали.Вставить("PositionNumber", сч);
		
		структдетали.Вставить("PostionCode", стрдок.Номенклатура.Артикул);
		
		структдетали.Вставить("PostionDescr", бтНаименование(стрдок.Номенклатура.Наименование));
		
		структдетали.Вставить("ItemOrderNumber", "");
		
		структдетали.Вставить("Qnt", стрдок.Количество);
		
		структдетали.Вставить("TotalGrossSum", стрдок.Сумма);
		
		структдетали.Вставить("IsAdditional", false);
		
		структдетали.Вставить("IsItemOnStock", true);
		
		масдеталей.Добавить(структдетали);
		
	КонецЦикла;  
	  
	структ.Вставить("DetailsRows", масдеталей);  
	
	сч = 0;
	масРабот = новый массив;    
	Для Каждого стрдок Из Док.Работы цикл
		
		структдетали = новый структура;
		сч = сч + 1;
		структдетали.Вставить("PositionNumber", сч);
		
		структдетали.Вставить("PostionCode", ?(Не ПустаяСтрока(стрдок.Работа.Артикул),стрдок.работа.Артикул, стрДок.работа.Код));
		
		структдетали.Вставить("PostionDescr", бтНаименование(стрдок.Работа.Наименование));
		
		структдетали.Вставить("ItemOrderNumber", "");
		
		структдетали.Вставить("Qnt", стрдок.Количество);
		
		структдетали.Вставить("TotalGrossSum", стрдок.Сумма);
		
		структдетали.Вставить("IsAdditional", false);
		
		структдетали.Вставить("IsItemOnStock", true);
		
		масРабот.Добавить(структдетали);
		
	КонецЦикла;  
	  
	структ.Вставить("WorkRows", масРабот);
	
	Ошибки = "";
	Успех = ОтправитьЗапрос("v1/Service/UploadRepairInfo", Структ, Ошибки,, Профиль); 
	
	Мен = РегистрыСведений.БТ_ЛогированиеИнфообменаЧери.СоздатьМенеджерЗаписи();
	мен.период = ТекущаяДатаСеанса();
	Мен.ИдТочки = ИдТочки;
	мен.ИмяТочки = ИмяТочки;
	мен.Успех = успех;   
	Мен.Документ = док;
	мен.ОтветСервиса = Ошибки;
	мен.Записать(); 

КонецПроцедуры

Процедура Остатки()
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение1 КАК идТочки,
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение2 КАК Склады, 
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение4 КАК Профиль,
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение КАК ИмяТочки
		|ИЗ
		|	Справочник.БТ_СписокКонстантныхЗначений.ТаблицаДанных КАК БТ_СписокКонстантныхЗначенийТаблицаДанных
		|ГДЕ
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Ссылка.Наименование = ""ВыгрузкаОстатковChery""";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если ПустаяСтрока(ВыборкаДетальныеЗаписи.Склады) Тогда 
			Продолжить;
		КонецЕсли;	
		
		ВыгрузитьОстаткиПоТочке(ВыборкаДетальныеЗаписи.ИдТочки, ВыборкаДетальныеЗаписи.ИмяТочки, ВыборкаДетальныеЗаписи.Склады, ВыборкаДетальныеЗаписи.Профиль);
	КонецЦикла;
	
КонецПроцедуры  

Функция ОтправитьЗапрос(Метод, Структура, Ошибка, ВызываемыйМетод = "POST", Профиль)
	УстановитьСоединение(Профиль);
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Структура);
			
	СтрокаДанных = ЗаписьJSON.Закрыть();
	
	Запрос = Новый HTTPЗапрос(Метод, Заголовки);
	Запрос.УстановитьТелоИзСтроки(СтрокаДанных, КодировкаТекста.UTF8);
	
    Ответ = Соединение.ВызватьHTTPМетод(ВызываемыйМетод, Запрос); 

	Если Ответ.КодСостояния = 200 Тогда 
		Стр = Ответ.ПолучитьТелоКакСтроку();
		
		Ошибка = Стр;   
				
		Чтение = Новый ЧтениеJSON;
		Чтение.УстановитьСтроку(стр);
		СтруктураJSON = ПрочитатьJSON(Чтение,,, ФорматДатыJSON.ISO);
		Чтение.Закрыть();
		
		Попытка
			Если Не Остатки Тогда
				Ошибка = СтруктураJSON.ErrorInfo;
				ЕстьОшибка = Не ПустаяСтрока(ошибка);
				Если Не ЕстьОшибка Тогда 
					Сообщить("Данные успешно выгружены");
				Иначе
					Сообщить("При выгрузке данных произошла ошибка: " + Ошибка)
				КонецЕсли; 
			Иначе
				ошибка = СтруктураJSON.UserInfo;
				Возврат СтруктураJSON.IsOk; 
			КонецЕсли;	
			Возврат Не ЕстьОшибка;
		Исключение       
			Ошибка = ОписаниеОшибки();
			Возврат Ложь;
		КонецПопытки;	

	Иначе	
		Ошибка = "Код ответа " + Ответ.КодСостояния + ": " + Ответ.ПолучитьТелоКакСтроку(); 
		
		Возврат ложь;
		
		Возврат 0;
	КонецЕсли;	
	
КонецФункции

Процедура УстановитьСоединение(Профиль = Неопределено) Экспорт

	Если Не ЗначениеЗаполнено(Профиль) тогда
		ПрофильПодключения = Справочники.БТ_ПрофилиПодключенияHTTP.Logic;    
	Иначе
		ПрофильПодключения = профиль;
	КонецЕсли;	
	URL = ПрофильПодключения.URL;
	ИмяДоступа = ПрофильПодключения.ИмяПользователя;
	ПарольДоступа = ПрофильПодключения.ПарольПользователя;
	
	//Соединение = Новый HTTPСоединение(URL, ,
	//            ИмяДоступа,
	//            ПарольДоступа,,
	//            ,
	//            ?(ПрофильПодключения.HTTPS, Новый ЗащищенноеСоединениеOpenSSL, Неопределено));
				
	Соединение = Новый HTTPСоединение(URL, ,
                ,
                ,,
                ,
                ?(ПрофильПодключения.HTTPS, Новый ЗащищенноеСоединениеOpenSSL, Неопределено));
				
    
    Заголовки = Новый Соответствие;
	
	//СтрокаАвторизации = ПолучитьBase64СтрокуИзДвоичныхДанных(
	//	ПолучитьДвоичныеДанныеИзСтроки(
	//		СокрЛП(ИмяДоступа) + ":" + ПарольДоступа, КодировкаТекста.UTF8, Ложь));
			
	СтрокаАвторизации = ПолучитьBase64СтрокуИзДвоичныхДанных(
		ПолучитьДвоичныеДанныеИзСтроки(
			ПрофильПодключения.Authorization, КодировкаТекста.UTF8, Ложь));
	
	
	
	Заголовки.Вставить("Content-Type", "application/json;charset=utf-8");
	Заголовки.Вставить("Connection", "keep-alive");
	Заголовки.Вставить("Accept", "application/json");
	Заголовки.Вставить("Authorization", ПрофильПодключения.Authorization);
	
КонецПроцедуры	

Процедура ВыгрузитьОстаткиПоТочке(ИдТочки, ИмяТочки, Склады, Профиль)
	
	МасСкладов = Новый Массив;
	Стр = СтрРазделить(Склады, ";");
	
	Для Каждого Элем Из Стр Цикл  
		
		Склад = Справочники.СкладыКомпании.НайтиПоКоду(Элем);
		Если Не Склад.Пустая() Тогда 
			МасСкладов.Добавить(Склад);
		КонецЕсли;
		
	КонецЦикла;	
	
	Структ = Новый Структура;
	Структ.Вставить("DealerPointId", ИдТочки);   
	Структ.Вставить("PartsStock", СтруктураОстатков(идТочки, МасСкладов)); 

	Ошибки = "";
	Успех = ОтправитьЗапрос("v1/Parts/UploadPartsStock", Структ, Ошибки,, Профиль);
	
	Мен = РегистрыСведений.БТ_ЛогированиеИнфообменаЧери.СоздатьМенеджерЗаписи();
	мен.период = ТекущаяДатаСеанса();
	Мен.ИдТочки = ИдТочки;
	мен.ИмяТочки = ИмяТочки;
	мен.Успех = успех;
	мен.Остатки = истина;
	мен.ОтветСервиса = Ошибки;
	мен.Записать(); 
	
КонецПроцедуры	

Функция НужнаяСтрока(ОтправляемыеДанные)   
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ПараметрыJSON = Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Авто, "", Истина);
	ЗаписьJSON.УстановитьСтроку(ПараметрыJSON);
	ЗаписатьJSON(ЗаписьJSON, ОтправляемыеДанные); // ОтправляемыеДанные обязательны в этом случае
	Возврат ЗаписьJSON.Закрыть();

КонецФункции

Функция СтруктураОстатков(идТочки, МасСкладов)  
	
	Мас = Новый Массив;
	
	Производитель = Справочники.Производители.НайтиПоКоду("ЦБ000305");
    
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПартииТоваровКомпанииОстатки.Номенклатура КАК Номенклатура,
		|	ПартииТоваровКомпанииОстатки.КоличествоОстаток КАК КоличествоОстаток,
		|	ПартииТоваровКомпанииОстатки.СуммаОстаток КАК СуммаОстаток
		|ИЗ
		|	РегистрНакопления.ПартииТоваровКомпании.Остатки(
		|			,
		|			Номенклатура.Производитель = &Производитель
		|				И СкладКомпании В (&Склады)) КАК ПартииТоваровКомпанииОстатки
		|ГДЕ
		|	ПартииТоваровКомпанииОстатки.КоличествоОстаток > 0";
	
	Запрос.УстановитьПараметр("Производитель", Производитель);
	Запрос.УстановитьПараметр("Склады", МасСкладов);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Если Не ПустаяСтрока(ВыборкаДетальныеЗаписи.Номенклатура.Артикул) Тогда
			Мас.Добавить(Новый Структура("Item,Qnt,Price", Строка(ВыборкаДетальныеЗаписи.Номенклатура.Артикул), ВыборкаДетальныеЗаписи.КоличествоОстаток, Окр(ВыборкаДетальныеЗаписи.СуммаОстаток/ВыборкаДетальныеЗаписи.КоличествоОстаток, 2)));
		КонецЕсли;	

	КонецЦикла;
	
	Возврат Мас;
КонецФункции	

Процедура Реализации()
	
КонецПроцедуры

Процедура ЗаказНаряды()
	
	ИмяОбработки = ЭтотОбъект.Метаданные().ПолноеИмя();
	СохраненныеНастройки = ХранилищеОбщихНастроек.Загрузить(ИмяОбработки+"/Общие",,,ИмяОбработки+"/Общие");
	НастройкиСопоставления = СохраненныеНастройки.СопоставленияДанных;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение1 КАК идТочки,
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение2 КАК Цеха,    
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение3 КАК Марки,
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение4 КАК Профиль,
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение КАК ИмяТочки
		|ИЗ
		|	Справочник.БТ_СписокКонстантныхЗначений.ТаблицаДанных КАК БТ_СписокКонстантныхЗначенийТаблицаДанных
		|ГДЕ
		|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Ссылка.Наименование = ""ВыгрузкаЗаказНарядовChery""";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если ПустаяСтрока(ВыборкаДетальныеЗаписи.Цеха) Тогда 
			Продолжить;
		КонецЕсли;
		ЦехЗН = Справочники.Цеха.НайтиПоКоду(ВыборкаДетальныеЗаписи.Цеха);
		Если Не (ЗначениеЗаполнено(ЦехЗН) И Найти(ЦехЗН.Наименование,"О2") > 0 И ВыполняетсяРегламентом = Истина) Тогда
		    ВыгрузитьЗаказНарядыПоТочке(ВыборкаДетальныеЗаписи.ИдТочки, ВыборкаДетальныеЗаписи.ИмяТочки, ВыборкаДетальныеЗаписи.Цеха, ВыборкаДетальныеЗаписи.Марки, ВыборкаДетальныеЗаписи.Профиль);
		КонецЕсли;
	КонецЦикла;			
КонецПроцедуры

Функция ТипРемонта(ВидРемонта)
	
	Если найти(нрег(ВидРемонта), "гарант") > 0 Тогда
		Возврат 3;  
	ИначеЕсли найти(нрег(ВидРемонта), "страхов") > 0 Тогда
		Возврат 2;
	ИначеЕсли ВидРемонта.ТипРемонта = Перечисления.ТипыРемонта.Бесплатный Тогда
		Возврат 4
	Иначе
		Возврат 1;
	КонецЕсли;
	
КонецФункции	

Процедура ВыгрузитьЗаказНарядыПоТочке(ИдТочки, ИмяТочки, Цеха, Марки, Профиль) 
	
		
	Если ЗначениеЗаполнено(ЗаказНаряд) Тогда
		НачПериода = НачалоДня(ЗаказНаряд.ДатаЗакрытия);
		КонПериода = КонецДня(ЗаказНаряд.ДатаЗакрытия);	 
	Иначе
		НачПериода = ДатаНачала; 
	
		Если Не ЗначениеЗаполнено(НачПериода) Тогда   
			НачПериода = НачалоДня(ТекущаяДата());
		КонецЕсли;	
		
		КонПериода = ДатаОкончания; 
		
		Если Не ЗначениеЗаполнено(КонПериода) Тогда   
			КонПериода = КонецДня(ТекущаяДата());
		КонецЕсли;

	КонецЕсли;	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаказНаряд.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.ЗаказНаряд КАК ЗаказНаряд
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.БТ_ЛогированиеИнфообменаЧери.СрезПоследних КАК БТ_ЛогированиеИнфообменаЧериСрезПоследних
		|		ПО БТ_ЛогированиеИнфообменаЧериСрезПоследних.Документ = ЗаказНаряд.Ссылка
		|ГДЕ
		|	ЗаказНаряд.Проведен
		|	И ЗаказНаряд.Состояние = &Состояние
		|	И ЗаказНаряд.Автомобиль.Модель В ИЕРАРХИИ(&БТ_МаркаАвто)
		|	И ЗаказНаряд.Цех В(&Цех)
		|	И ЗаказНаряд.ДатаЗакрытия МЕЖДУ &Дата1 И &Дата2
		|	И (ЗаказНаряд.Ссылка = &Ссылка
		|			ИЛИ &ВсеЗН)
		|	И ЕСТЬNULL(БТ_ЛогированиеИнфообменаЧериСрезПоследних.Успех, ЛОЖЬ) = ЛОЖЬ";
	
	МасЦехов = Новый Массив;
	Стр = СтрРазделить(Цеха, ";");
	
	Для Каждого Элем Из Стр Цикл  
		
		Цех = Справочники.Цеха.НайтиПоКоду(Элем);
		Если Не Цех.Пустая() Тогда 
			МасЦехов.Добавить(Цех);
		КонецЕсли;
		
	КонецЦикла;	     
	
	МасМарок = Новый Массив;
	Стр = СтрРазделить(Марки, ";");
	
	Для Каждого Элем Из Стр Цикл  
		
		Марка = Справочники.Модели.НайтиПоКоду(Элем);
		Если Не Марка.Пустая() Тогда 
			МасМарок.Добавить(Марка);
		КонецЕсли;
		
	КонецЦикла;	

  	Запрос.УстановитьПараметр("БТ_МаркаАвто", МасМарок);
	Запрос.УстановитьПараметр("Дата1", НачПериода);
	Запрос.УстановитьПараметр("Дата2", КонецДня(КонПериода));
	Запрос.УстановитьПараметр("Состояние", Справочники.ВидыСостоянийЗаказНарядов.Закрыт);
	Запрос.УстановитьПараметр("Цех", МасЦехов);
    Запрос.УстановитьПараметр("Ссылка", ЗаказНаряд);
	Запрос.УстановитьПараметр("ВсеЗН", ЗаказНаряд.Пустая());
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	//БИЗТЕХ МАМОНОВ 08.12.2025 ++
	//Фикс ошибки связанной с кол-вом запросов в секунду
	Если ВыполняетсяРегламентом Тогда
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			ВыгрузитьЗНПоТочке(идТочки, ИмяТочки, ВыборкаДетальныеЗаписи.Ссылка, Профиль);
			ВызватьПаузу(1000);
		КонецЦикла;
	Иначе
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			ВыгрузитьЗНПоТочке(идТочки, ИмяТочки, ВыборкаДетальныеЗаписи.Ссылка, Профиль);
		КонецЦикла;
	КонецЕсли;
	//БИЗТЕХ МАМОНОВ 08.12.2025 --
КонецПроцедуры

Процедура ВыгрузитьЗНПоТочке(идТочки, ИмяТочки, Док, Профиль) 
	
	Если 1 = 2 Тогда
		Док = Документы.ЗаказНаряд.ПустаяСсылка();
	КонецЕсли;	

	Структ = Новый Структура;
	Структ.Вставить("DealerCode", ?(идТочки = 371, "3038500","2340200"));
	Структ.Вставить("DealerDescr", ИмяТочки);
    Структ.Вставить("DealerPointId", ИдТочки);
	структ.Вставить("DocumentTypeId", 1);
	структ.Вставить("WorkorderNumber", док.номер);
	структ.Вставить("Vin", док.Автомобиль.VIN);
	структ.Вставить("CarBrand",СокрЛП(?(ЗначениеЗаполнено(док.Автомобиль.БТ_МаркаАвто), док.Автомобиль.БТ_МаркаАвто, док.Автомобиль.Модель.Родитель)));
	структ.Вставить("CarModel", СокрЛП(док.Автомобиль.Модель));
	ГосНомер = СокрЛП(Справочники.Автомобили.ЧтениеЗначенияРегистраСведения(Док.Автомобиль, Перечисления.ДополнительнаяИнформацияАвтомобилей.ГосНомер));
	ГосНомер = ?(ПустаяСтрока(ГосНомер),"TRANSIT", СокрЛП(ГосНомер));
	структ.Вставить("LicencePlate", ГосНомер);
	
	_Контрагент = ?(ЗначениеЗаполнено(Док.Контрагент), Док.Контрагент, Док.Заказчик);
	
	//БИЗТЕХ КОВАЛЬ 27.10.2025 ++
	// Правка пробега на пробег из документа
	// Пробег = Справочники.Автомобили.ЧтениеЗначенияРегистраСведения(Док.Автомобиль, Перечисления.ДополнительнаяИнформацияАвтомобилей.Пробег);
	Пробег = док.Пробег;
	//БИЗТЕХ КОВАЛЬ 27.10.2025 --
	
	структ.Вставить("Odometer", ?(не ЗначениеЗаполнено(Пробег), 0, Пробег));
	структ.Вставить("ClientDescr", ?(не пустаяСтрока(_Контрагент.НаименованиеПолное), _Контрагент.НаименованиеПолное, СокрЛП(_Контрагент)));
	структ.Вставить("ClientType", ?(_Контрагент.ФормаСобственности = перечисления.ФормыСобственности.ЧастноеЛицо,1,2));
	структ.Вставить("ClientPhone", киПолучитьПредставлениеКИ(_Контрагент,перечисления.ТипыКонтактнойИнформации.Телефон));
	
	структ.Вставить("ClientInn", ?(_Контрагент.ФормаСобственности <> перечисления.ФормыСобственности.ЧастноеЛицо, _Контрагент.ИНН,""));
	структ.Вставить("ContactPersonDescr", "");
	структ.Вставить("ContactPersonPhone", киПолучитьПредставлениеКИ(_Контрагент,перечисления.ТипыКонтактнойИнформации.Телефон));
	структ.Вставить("ContactPersonEmail", "");
	структ.Вставить("IsContactPersonalDataAgreement", _Контрагент.СогласиеНаОбработкуПерсональныхДанных = перечисления.ВариантыОтветов.Да);
	структ.Вставить("IsContactAgreementPhone", _Контрагент.СогласиеНаОбработкуПерсональныхДанных = перечисления.ВариантыОтветов.Да);
	структ.Вставить("IsContactAgreementEmail", _Контрагент.СогласиеНаОбработкуПерсональныхДанных = перечисления.ВариантыОтветов.Да);
	структ.Вставить("IsContactAgreementSms", _Контрагент.СогласиеНаОбработкуПерсональныхДанных = перечисления.ВариантыОтветов.Да);
	структ.Вставить("Reason", СокрЛП(?(не ПустаяСтрока(док.ПричинаОбращения), Док.ПричинаОбращения, Док.ВидРемонта)));
	структ.Вставить("Recommendation", Док.Рекомендации);
	структ.Вставить("DateAccess", формат(док.ДатаНачала, "ДФ=dd.MM.yyyy"));
	структ.Вставить("DateOpen", формат(док.ДатаНачала, "ДФ=dd.MM.yyyy"));
	структ.Вставить("DateStart", формат(док.ДатаНачала, "ДФ=dd.MM.yyyy"));
	структ.Вставить("DateFinish", формат(док.ДатаОкончания, "ДФ=dd.MM.yyyy"));
	структ.Вставить("DateClose", формат(док.ДатаЗакрытия, "ДФ=dd.MM.yyyy"));
	структ.Вставить("RepairTypeId",ТипРемонта(Док.ВидРемонта));
	структ.Вставить("HasMaintenance", док.ВидРемонта.код = "ЦБ000037");//ЗначениеЗаполнено(Док.БТ_НомерТО));
	структ.Вставить("HasServiceEvent", false);
	структ.Вставить("HasGoodwill", false);
	структ.Вставить("HasBenchRepair", Док.ВидРемонта.Код <> "ЦБ000042" И Док.ВидРемонта.Код <> "ЦБ000037" И Док.ВидРемонта.Код <> "ЦБ000010"); // Истина, если вид ремонта НЕ Кузовной И НЕ ТО И НЕ Гарантийный      
	структ.Вставить("HasBodyRepair", Док.ВидРемонта.Код = "ЦБ000042");
	структ.Вставить("HasPromotion", false);
	структ.Вставить("HasAddEquip", найти(нрег(док.ВидРемонта), "дополнительное оборуд") > 0);
	структ.Вставить("IsPresale", найти(док.ВидРемонта, "Предпродажная подготовка") > 0);
	структ.Вставить("IsCheck", false);
	структ.Вставить("IsCarWash", false);
	структ.Вставить("ExternalCodeEmpOpen", "");
	структ.Вставить("ExternalCodeEmpWork", "");
	структ.Вставить("ExternalCodeEmpClose", "");
	
	сч = 0;
	масдеталей = новый массив;    
	Для Каждого стрдок Из Док.Товары цикл
		
		структдетали = новый структура;
		сч = сч + 1;
		структдетали.Вставить("PositionNumber", сч);
		
		структдетали.Вставить("PostionCode", бтНаименование(стрдок.Номенклатура.Артикул));
		
		структдетали.Вставить("PostionDescr", бтНаименование(стрдок.Номенклатура.Наименование));
		
		структдетали.Вставить("ItemOrderNumber", "");
		
		структдетали.Вставить("Qnt", стрдок.Количество);
		
		структдетали.Вставить("TotalGrossSum", стрдок.Сумма);
		
		структдетали.Вставить("IsAdditional", false);
		
		структдетали.Вставить("IsItemOnStock", true);
		
		масдеталей.Добавить(структдетали);
		
	КонецЦикла;  
	  
	структ.Вставить("DetailsRows", масдеталей);  
	
	сч = 0;
	масРабот = новый массив;    
	Для Каждого стрдок Из Док.Работы цикл
		
		структдетали = новый структура;
		сч = сч + 1;
		структдетали.Вставить("PositionNumber", сч);
		
		структдетали.Вставить("PostionCode", бтНаименование(?(Не ПустаяСтрока(стрдок.Работа.Артикул),стрдок.работа.Артикул, стрДок.работа.Код)));
		
		структдетали.Вставить("PostionDescr", бтНаименование(стрдок.Работа.Наименование));
		
		структдетали.Вставить("ItemOrderNumber", "");
		
		структдетали.Вставить("Qnt", стрдок.Количество*СтрДок.Коэффициент);
		
		структдетали.Вставить("TotalGrossSum", стрдок.Сумма);
		
		структдетали.Вставить("IsAdditional", false);
		
		структдетали.Вставить("IsItemOnStock", true);
		
		масРабот.Добавить(структдетали);
		
	КонецЦикла;  
	  
	структ.Вставить("WorkRows", масРабот);
	
	Ошибки = "";
	Успех = ОтправитьЗапрос("v1/Service/UploadRepairInfo", Структ, Ошибки,, Профиль); 
	
	Мен = РегистрыСведений.БТ_ЛогированиеИнфообменаЧери.СоздатьМенеджерЗаписи();
	мен.период = ТекущаяДатаСеанса();
	Мен.ИдТочки = ИдТочки;
	мен.ИмяТочки = ИмяТочки;
	мен.Успех = успех;   
	Мен.Документ = док;
	мен.ОтветСервиса = Ошибки;
	мен.Записать(); 

КонецПроцедуры 

Функция бтНаименование(наименование)
	тмп = СтрЗаменить(наименование, символы.таб, " ");
	тмп = СтрЗаменить(тмп, "/", "-"); 
	тмп = СокрЛП(СтрЗаменить(тмп, """", "-"));
	возврат тмп;
КонецФункции	

Функция ПолучитьСписокЦеховО2()
	Запрос = Новый Запрос;
	Запрос.Текст =  "ВЫБРАТЬ
	                |	Цеха.Ссылка КАК Ссылка
	                |ИЗ
	                |	Справочник.Цеха КАК Цеха
	                |ГДЕ
	                |	Цеха.Наименование ПОДОБНО ""%О2%""
	                |	И Цеха.Родитель <> &ПустойЦех";
	Запрос.УстановитьПараметр("ПустойЦех", Справочники.Цеха.ПустаяСсылка());
	РезультатЗапроса = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
	Возврат РезультатЗапроса;
КонецФункции

#Область НастройкиОбработки
Функция ЗаполнитьСтруктуруНастроек()
	СтруктураНастроек = Новый Структура;
	
	Для Каждого РеквизитОбработки из ЭтотОбъект.Метаданные().Реквизиты Цикл
		СтруктураНастроек.Вставить(РеквизитОбработки.Имя, ?(ЗначениеЗаполнено(ЭтотОбъект[РеквизитОбработки.Имя]),ЭтотОбъект[РеквизитОбработки.Имя],Неопределено)); 
	КонецЦикла;
	
	СтруктураНастроек.Вставить("ПодменяемыеДанные", ЭтотОбъект.ПодменяемыеДанные.Выгрузить()); 
	СтруктураНастроек.Вставить("СопоставленияДанных", ЭтотОбъект.СопоставленияДанных.Выгрузить());
	СтруктураНастроек.Вставить("СписокТочек", ЭтотОбъект.СписокТочек.Выгрузить());
	
	Возврат СтруктураНастроек;
КонецФункции
Процедура СохранитьНастройки() Экспорт
	
	СтруктураНастроек = ЗаполнитьСтруктуруНастроек();
	ИмяОбработки = ЭтотОбъект.Метаданные().ПолноеИмя();
	ХранилищеОбщихНастроек.Сохранить(ИмяОбработки+"/Общие",, СтруктураНастроек,,ИмяОбработки+"/Общие");
	
КонецПроцедуры
Процедура ВосстановитьНастройки() Экспорт
	
	ИмяОбработки = ЭтотОбъект.Метаданные().ПолноеИмя();
	СохраненныеНастройки = ХранилищеОбщихНастроек.Загрузить(ИмяОбработки+"/Общие",,,ИмяОбработки+"/Общие");
	Если СохраненныеНастройки = Неопределено ИЛИ ТипЗнч(СохраненныеНастройки) <> Тип("Структура") Тогда
		СохраненныеНастройки = новый Структура;
	КонецЕсли;
	
	Для Каждого ТекНастройка Из СохраненныеНастройки Цикл
		Если СохраненныеНастройки.Свойство(ТекНастройка.Ключ) Тогда
			СохраненнаяНастройка = СохраненныеНастройки[ТекНастройка.Ключ];
		КонецЕсли;
		Попытка
			Если ТипЗнч(СохраненнаяНастройка) = Тип("ТаблицаЗначений") Тогда
				ЭтотОбъект[ТекНастройка.Ключ].Загрузить(СохраненнаяНастройка);
			Иначе
				ЭтотОбъект[ТекНастройка.Ключ] = ?(ЗначениеЗаполнено(СохраненнаяНастройка),СохраненнаяНастройка,Неопределено);
			КонецЕсли;
		Исключение	
		КонецПопытки;
	КонецЦикла;
	
	
КонецПроцедуры
Функция ВсеЛиОбязательныеРеквизитыЗаполнены() Экспорт
	
	Для Каждого РеквизитОбработки из ЭтотОбъект.Метаданные().Реквизиты Цикл
		Если РеквизитОбработки.ПроверкаЗаполнения = ПроверкаЗаполнения.ВыдаватьОшибку Тогда
			Если НЕ ЗначениеЗаполнено(ЭтотОбъект[РеквизитОбработки.Имя]) Тогда
				Возврат Ложь;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	Возврат Истина;
	
КонецФункции
#КонецОбласти
