&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ВидПоказателяПриИзменении();
	
КонецПроцедуры

&НаКлиенте
Процедура ВидПоказателяПриИзменении(Элемент = Неопределено)
	
	ПодчиненныеЭлементыПанели = ЭтаФорма.Элементы.Панель.ПодчиненныеЭлементы;
	
	Если Объект.ВидПоказателя = ПредопределенноеЗначение("Перечисление.БТ_ВидПоказателя.Запрос") Тогда
		
		ПодчиненныеЭлементыПанели.Запрос.Видимость					= Истина;
		ПодчиненныеЭлементыПанели.стрПараметры.Видимость			= Истина;
	   	ПодчиненныеЭлементыПанели.стрПроизвольныйМодуль.Видимость	= Ложь;
		
	ИначеЕсли Объект.ВидПоказателя = ПредопределенноеЗначение("Перечисление.БТ_ВидПоказателя.Модуль") Тогда
		
	    ПодчиненныеЭлементыПанели.Запрос.Видимость					= Ложь;
		ПодчиненныеЭлементыПанели.стрПараметры.Видимость			= Истина;
	   	ПодчиненныеЭлементыПанели.стрПроизвольныйМодуль.Видимость	= истина;
		
	Иначе
		
		ПодчиненныеЭлементыПанели.Запрос.Видимость					= Ложь;
		ПодчиненныеЭлементыПанели.стрПараметры.Видимость			= Ложь;
	   	ПодчиненныеЭлементыПанели.стрПроизвольныйМодуль.Видимость	= Ложь;
		
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Проверить(Команда)
	
	Результат = ПроверитьНаСервере();
	
	Если типЗнч(Результат) = Тип("Строка") Тогда
		
		Сообщить(Результат);
		
	Иначе
		
		Результат.Показать();
		
	КонецЕсли;
	//ПоказатьЗначение(,Результат);
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПреобразоватьИмяПоляГруппировки(п_Поле)
	
	Возврат СокрЛП(СтрЗаменить(п_Поле,".",""));
	
КонецФункции

Функция ПроверитьНаСервере(ТекстЗапроса = Неопределено)
	
	Возврат Справочники.БТ_Показатели.ПроверитьНаСервере(ТекстЗапроса,Объект);
	
КонецФункции	

&НаКлиенте
Процедура ТЗапросаПриИзменении(Элемент = Неопределено)
	
	Запрос = Новый Запрос(ОБъект.ТекстЗапроса);
		
	Попытка
		ПараметрыЗапроса = Запрос.НайтиПараметры();
	Исключение
		Предупреждение(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	Для Каждого ПараметрЗапроса Из ПараметрыЗапроса Цикл
		
		ИмяПараметра =  ПараметрЗапроса.Имя;
		СтрокиПараметров = Объект.Параметры.НайтиСтроки(Новый Структура("ИмяПараметра",ИмяПараметра));
		
		Если СтрокиПараметров.Количество() = 0 Тогда
			
			СтрокаПараметров = Объект.Параметры.Добавить();
			СтрокаПараметров.ИмяПараметра = ИмяПараметра;
		Иначе
			
			СтрокаПараметров = СтрокиПараметров[0];
			
		КонецЕсли; 
		
		СтрокаПараметров.ЗначениеПараметра = ПараметрЗапроса.ТипЗначения.ПривестиЗначение(СтрокаПараметров.ЗначениеПараметра);
		
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура КонструкторЗапросов(Команда)
	
	ОткрытьКонстракторЗапроса("ТекстЗапроса");

КонецПроцедуры

&НаКлиенте
Процедура ВыполнитьВводКонструктора(Результат, ДопПараметры) Экспорт
	
	Если не Результат = Неопределено и не ПустаяСтрока(Результат) Тогда
		
		Объект[ДопПараметры.Реквизит] = Результат;
		ТЗапросаПриИзменении();
		Элементы.Панель.ТекущаяСтраница = Элементы.стрПараметры;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Для каждого Док из Метаданные.Документы Цикл
		
		СписокМетаданных.Добавить(Док.Имя);
		
	КонецЦикла;
	
	Элементы.ЗависимостьОтМетаданныхДокумент.СписокВыбора.ЗагрузитьЗначения(СписокМетаданных.ВыгрузитьЗначения());
	
	
	Если Объект.Ссылка.Пустая() Тогда
		
		Объект.Включен 	= Ложь;   
		Объект.ID 		= УзнатьID();
		
	КонецЕсли;
КонецПроцедуры      

&НаСервереБезКонтекста
Функция УзнатьID()  
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	МАКСИМУМ(БТ_Показатели.ID) КАК ID
		|ИЗ
		|	Справочник.БТ_Показатели КАК БТ_Показатели";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл 
		
		Возврат ВыборкаДетальныеЗаписи.ID + 1;  
		
	КонецЦикла;
	
	Возврат 1;
	
КонецФункции


&НаКлиенте
Процедура Заполнить(Команда)
	ЗаполнитьНаСервере();
КонецПроцедуры


&НаСервере
Процедура ЗаполнитьНаСервере()
	
	СпМет=Новый СписокЗначений;
	
	Для Каждого Док из Метаданные.Документы Цикл
		
		Нов=СпМет.Добавить(Док.Имя);
		
	КонецЦИкла;
	
	Объект.ЗависимостьОтМетаданных.Очистить();
	
	Если Объект.ВидПоказателя = Перечисления.БТ_ВидПоказателя.Запрос Тогда
		
		Текст = Объект.ТекстЗапроса;
		
	ИначеЕсли Объект.ВидПоказателя = Перечисления.БТ_ВидПоказателя.Модуль Тогда
		
		Текст = Объект.ПроизвольныйМодуль;
		
	Иначе
		
		Сообщить("Не выбран вид показателя!");
		
	КонецЕсли;
		
	Для Каждого ТекЭл из СпМет Цикл
		
		Если Найти(Текст,ТекЭл.Значение) Тогда
			
			Объект.ЗависимостьОтМетаданных.Добавить().Документ=ТекЭл.Значение;
			
		КонецЕсли;	
		
		Док = Метаданные.Документы[ТекЭл.Значение];
		
		Для Каждого ТекДв из Док.Движения Цикл
			
			Если Найти(Текст,"."+ТекДв.Имя+".") Тогда
				
				Если Объект.ЗависимостьОтМетаданных.НайтиСтроки(Новый Структура("Документ",ТекЭл.Значение)).Количество() = 0 Тогда
					
					Объект.ЗависимостьОтМетаданных.Добавить().Документ = ТекЭл.Значение;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;	
		
	КонецЦикла;
КонецПроцедуры


&НаКлиенте
Процедура ЗаполнитьАналитику(Команда)
	ЗаполнитьАналитикуНаСервере();
КонецПроцедуры


&НаСервере
Процедура ЗаполнитьАналитикуНаСервере()
	
	Если Объект.ВидПоказателя = Перечисления.БТ_ВидПоказателя.Запрос Тогда
		
		Объект.Аналитика.Очистить();
		Построитель=Новый ПостроительОтчета;
		
		Попытка
			
			Построитель.Текст=Объект.ТекстЗапроса;
			Построитель.ЗаполнитьНастройки();
			
			Изм=Построитель.ДоступныеПоля;
			
			Для Каждого ТекИзм из Изм Цикл
				Если Строка(ТекИзм.ТипЗначения)="Число" Тогда
					
						ЗначениеПоказателя=ТекИзм.Имя;
						
					Продолжить;
					
				КонецЕсли;
				
				ВА=Справочники.БТ_ВидыАналитики.НайтиПоНаименованию(ТекИзм.Имя);
				
				Если Не ПустаяСтрока(ВА) Тогда
					
					Объект.Аналитика.Добавить().Аналитика=ВА;
					
				КонецЕсли;
				
			КонецЦикла;
			
		Исключение
			
		КонецПопытки;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьКонстракторЗапроса(Реквизит)
	ТЗапроса = Объект[Реквизит];
	КонструкторЗапроса = Новый КонструкторЗапроса;
	КонструкторЗапроса.АвтодобавлениеПредставлений = Ложь;
	Попытка
		
		
		Если не ПустаяСтрока(ТЗапроса) Тогда
			
			КонструкторЗапроса.Текст = ТЗапроса;
			
		КонецЕсли;
		ОписаниеОповещения = Новый ОписаниеОповещения("ВыполнитьВводКонструктора", ЭтаФорма,Новый Структура("Реквизит",Реквизит));
		КонструкторЗапроса.Показать(ОписаниеОповещения);
			
	Исключение
		
		ПоказатьПредупреждение(,ОписаниеОшибки(),30);
		
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура КонструкторЗапросовРасшифровка(Команда)
	ОткрытьКонстракторЗапроса("ТекстЗапросаРасшифровки");
КонецПроцедуры


&НаКлиенте
Процедура СформироватьРасшифровку(Команда)
	
	Если ПустаяСтрока(Объект.ТекстЗапросаРасшифровки) Тогда
		
		Сообщить("Не указан текст запроса расшифроки");
		Возврат;
		
	КонецЕсли;
	
	Результат = ПроверитьНаСервере(Объект.ТекстЗапросаРасшифровки);
	Результат.Показать();
КонецПроцедуры


&НаКлиенте
Процедура ВключенПриИзменении(Элемент)
	
	Если не ЗначениеЗаполнено(Объект.ТипРасчета) Тогда
		
		Объект.Включен = Ложь;
		Сообщить("Необходимо выбрать тип расчета");
		
	КонецЕсли;
	
	Если не ЗначениеЗаполнено(Объект.ID) Тогда
		
		Объект.ID = Ложь;
		Сообщить("Необходимо указать ID показателя");
		
	КонецЕсли;
	
	Если не ЗначениеЗаполнено(Объект.ВидПоказателя) Тогда
		
		Объект.ID = Ложь;
		Сообщить("Необходимо указать Вид Показателя показателя");
		
	КонецЕсли;
	
	Если не ЗначениеЗаполнено(Объект.ЗначениеПоказателя) Тогда
		
		Объект.ID = Ложь;
		Сообщить("Необходимо указать Значение Показателя");
		
	КонецЕсли;
	
	Если не ЗначениеЗаполнено(Объект.НаправлениеДеятельности) Тогда
		
		Объект.ID = Ложь;
		Сообщить("Необходимо указать Направление деятельности");
		
	КонецЕсли;
	
	Если не ЗначениеЗаполнено(Объект.ЕдиницаИзмерения) Тогда
		
		Объект.ID = Ложь;
		Сообщить("Необходимо указать Единицу измерения");
		
	КонецЕсли;
		
КонецПроцедуры


&НаКлиенте
Процедура ОчиститьЗначения(Команда)
	ОчиститьЗначенияНаСервере();
КонецПроцедуры


&НаСервере
Процедура ОчиститьЗначенияНаСервере()
	
	ДатаНачалаОчистки = НачалоДня(РегистрыСведений.БТ_КонстантныеЗначения.ПолучитьЗначение("ДатаНачалаРасчетаПоказателей"));
	
	Пока ДатаНачалаОчистки <= ТекущаяДата() Цикл
	
		Значения = РегистрыСведений.БТ_ЗначенияПоказателей.СоздатьНаборЗаписей();
		Значения.Отбор.Показатель.Установить(Объект.Ссылка);
		Значения.Отбор.План.Установить(Ложь);   
		Значения.Отбор.Период.Установить(ДатаНачалаОчистки);
		Значения.Записать();  
		
		ДатаНачалаОчистки = ДатаНачалаОчистки + 86400;
		
	КонецЦикла;
	
КонецПроцедуры


&НаКлиенте
Процедура НаправлениеДеятельностиПриИзменении(Элемент)
	
    Объект.Сортировка = ПолучитьСортировку(Объект.НаправлениеДеятельности);
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьСортировку(НаправлениеДеятельности)

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	МАКСИМУМ(БТ_Показатели.Сортировка) КАК Сортировка
		|ИЗ
		|	Справочник.БТ_Показатели КАК БТ_Показатели
		|ГДЕ
		|	БТ_Показатели.НаправлениеДеятельности = &НаправлениеДеятельности";
	Запрос.УстановитьПараметр("НаправлениеДеятельности", НаправлениеДеятельности);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл    
		
		Возврат ВыборкаДетальныеЗаписи.Сортировка + 1;  
		
	КонецЦикла;
	
	Возврат 1;
	
КонецФункции

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	Справочники.БТ_Показатели.ВыгрузитьПоказатели(Объект.Ссылка);
	
КонецПроцедуры
