
Функция ЗаполнитьНомерДоговора(Договор,Отказ = ЛОЖЬ) Экспорт

	ПрефиксОрганизации = обПолучитьЗначениеСвойства(Договор.Организация,"ПрефиксДоговоров","99");
	Если ПрефиксОрганизации = "99" Тогда
		Сообщить("Заполните свойство ПрефиксДоговоров для организации " + Строка(Договор.Организация));
		Отказ = Истина;
		Возврат Отказ;
	КонецЕсли;
	ПрефиксГода = Формат(Договор.ДатаНачала,"ДФ=yy");
	Если ЗначениеЗаполнено(Договор.тт_ВидДоговора) Тогда
		ПрефиксВида = Договор.тт_ВидДоговора.Префикс;
	Иначе
		Сообщить("Заполните поле ""Для префикса"" в договоре " + Строка(Договор.Наименование));
		Отказ = Истина;
		Возврат Отказ;
	КонецЕсли;
	ПрефиксДоговора = ПрефиксОрганизации + "-" + ПрефиксГода + "-" + ПрефиксВида + "-";
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	МАКСИМУМ(ДоговорыВзаиморасчетов.НомерДоговора) КАК НомерДоговора
		|ИЗ
		|	Справочник.ДоговорыВзаиморасчетов КАК ДоговорыВзаиморасчетов
		|ГДЕ
		|	ДоговорыВзаиморасчетов.НомерДоговора ПОДОБНО &ПрефиксДоговора
		|	И ДоговорыВзаиморасчетов.ДатаНачала МЕЖДУ &ДатаНачала И &ДатаОкончания";
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоГода(Договор.ДатаНачала));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецГода(Договор.ДатаНачала));
	Запрос.УстановитьПараметр("ПрефиксДоговора", ПрефиксДоговора + "%");
	
	РезультатЗапроса = Запрос.Выполнить().Выбрать();
	
	Если РезультатЗапроса.Следующий() Тогда
		Если РезультатЗапроса.НомерДоговора = Null Тогда
			СтарыйНомер = 0;
		Иначе	
			СтарыйНомер = Число(Прав(РезультатЗапроса.НомерДоговора,5));
		КонецЕсли;	
		НовыйНомер = ПрефиксДоговора + Формат(СтарыйНомер+1,"ЧЦ=5; ЧВН=; ЧГ=0");
		Договор.НомерДоговора = НовыйНомер;
		Если Договор.тт_ВидДоговора = Справочники.тт_ВидыДоговоров.НайтиПоКоду("000000001") Тогда  // продажа авто
			Договор.Наименование = "Договор купли-продажи а/м № " + Договор.НомерДоговора + " от " + Лев(Договор.ДатаНачала,10);
		ИначеЕсли Договор.тт_ВидДоговора = Справочники.тт_ВидыДоговоров.НайтиПоКоду("000000002") Тогда // услуги сервиса
			Договор.Наименование = "Договор ТО и ремонта";
		КонецЕсли;			
	Иначе
		Сообщить("Что-то пошло не так. Префикс договора " + ПрефиксДоговора);
		//misha
		Отказ = ЛОЖЬ;
		Возврат Отказ;
	КонецЕсли;	
	
	Возврат Отказ;

КонецФункции

