//Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	УстановитьПроверкуЗаполненияНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Элементы.Category.СписокВыбора.ЗагрузитьЗначения(ns_ДляДомаИДачиФормы.ПолучитьСписокКатегорий());
	УстановитьВидимостьРеквизитов();
КонецПроцедуры
 
//КонецОбласти

//Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура CategoryПриИзменении(Элемент)                                                                                
	СброситьРеквизитыЗаполнения(Истина);
	//Элементы.GoodsType.СписокВыбора.ЗагрузитьЗначения(ns_ДляДомаИДачиФормы.ПолучитьСписокПодкатегорий(Объект.Category));
	ОбновитьРеквизиты();
	УстановитьПроверкуЗаполненияНаСервере();
	УстановитьВидимостьРеквизитов();
КонецПроцедуры

&НаКлиенте
Процедура GoodsTypeПриИзменении(Элемент)
	СброситьРеквизитыЗаполнения();
	УстановитьВидимостьРеквизитов();
КонецПроцедуры

//КонецОбласти

//Область ОбработчикиКомандФормы

&НаКлиенте
Процедура СформироватьTitle(Команда)
	Объект.Title = СформироватьTitleНаСервере(Объект.ШаблонЗаголовка, Объект.Title, Объект.Номенклатура, Объект.Характеристика);
КонецПроцедуры

//КонецОбласти

//Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьПроверкуЗаполненияНаСервере()
	ОбязательныеПоля = ns_ДляДомаИДачиВалидация.ПолучитьОбязательныеПоля();
	Для каждого ИмяПоля Из ОбязательныеПоля Цикл
		Элементы[ИмяПоля].АвтоОтметкаНезаполненного = Истина;
	КонецЦикла; 
	
	ДополнительныеОбязательныеПоля = ns_ДляДомаИДачиВалидация.ПолучитьДополнительныеОбязательныеПоля(Объект.Category, Объект.GoodsType);
	Для каждого ИмяПоля Из ДополнительныеОбязательныеПоля Цикл
		Элементы[ИмяПоля].АвтоОтметкаНезаполненного = Истина;
	КонецЦикла; 
КонецПроцедуры

&НаСервере
Процедура ОбновитьРеквизиты()
	Для каждого Реквизит Из Метаданные.Справочники.ns_ДляДомаИДачи.Реквизиты Цикл
		Если НЕ Элементы.Найти(Реквизит.Имя) = Неопределено Тогда
			Попытка
				Если Реквизит.ПроверкаЗаполнения = ПроверкаЗаполнения.ВыдаватьОшибку Тогда
					Элементы[Реквизит.Имя].АвтоОтметкаНезаполненного = Истина;
					Элементы[Реквизит.Имя].ОтметкаНезаполненного = Истина;
				Иначе
					Элементы[Реквизит.Имя].АвтоОтметкаНезаполненного = Ложь;
					Элементы[Реквизит.Имя].ОтметкаНезаполненного = Ложь;
				КонецЕсли;
				Элементы[Реквизит.Имя].Видимость = Истина;	
			Исключение
			КонецПопытки;
		КонецЕсли; 
	КонецЦикла; 
КонецПроцедуры

&НаСервереБезКонтекста
Функция СформироватьTitleНаСервере(ШаблонЗаголовка, Заголовок, Номенклатура, Характеристика)
	Возврат ns_ШаблонизаторСервер.СформироватьTitle(ШаблонЗаголовка, Заголовок, Номенклатура, Характеристика);
КонецФункции

&НаКлиенте
Процедура СброситьРеквизитыЗаполнения(ОчищатьGoodsType = Ложь)
	Если ОчищатьGoodsType Тогда
		Объект.GoodsType = Неопределено;
	КонецЕсли;
	Объект.GoodsSubType = Неопределено;
	Объект.Availability = Неопределено;
КонецПроцедуры

&НаКлиенте
Процедура УстановитьВидимостьРеквизитов()
	Если НЕ ЗначениеЗаполнено(Объект.Category) Тогда
		Элементы.GoodsType.Видимость = Ложь;
	Иначе
		Элементы.GoodsType.Видимость = ns_ДляДомаИДачиВалидация.УстановитьВидимость_GoodsType(Объект.Category);
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(Объект.GoodsType) Тогда
		Элементы.GoodsSubType.Видимость = Ложь;
		Элементы.Availability.Видимость = Ложь;
		Возврат;
	КонецЕсли;
	
	Элементы.GoodsSubType.Видимость = ns_ДляДомаИДачиВалидация.УстановитьВидимость_GoodsSubType(Объект.Category, Объект.GoodsType);
	Элементы.Availability.Видимость = ns_ДляДомаИДачиВалидация.УстановитьВидимость_Availability(Объект.Category, Объект.GoodsType);
	
КонецПроцедуры

//КонецОбласти 














