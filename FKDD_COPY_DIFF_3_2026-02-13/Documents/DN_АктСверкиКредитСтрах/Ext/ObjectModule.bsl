
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Если НЕ Отказ тогда
		Если ЭтоНовый() тогда
			АвторДокумента = ПараметрыСеанса.Пользователь.Сотрудник; 			
		КонецЕсли;
		АвторПоледнейЗаписи = ПараметрыСеанса.Пользователь.Сотрудник;
	КонецЕсли;
	//БизТех Аляль 04.06.2024г. ТЗ 282 <<
	Если РабочиеЛисты.Найти(Ложь, "Удержание") = Неопределено и ХозОперация = Справочники.ХозОперации.АктСверкиСтраховой Тогда
		БТ_СУдержанием = Истина;
	Иначе
		БТ_СУдержанием = Ложь;
	КонецЕсли; 
	//БизТех Аляль >>
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)

	Если НЕ (ХозОперация = Справочники.ХозОперации.АктСверкиКредитный_ПоРетроБонусу
		или ХозОперация = Справочники.ХозОперации.АктСверкиСтраховой_ПоРетроБонусу) тогда

		Если НЕ Отказ тогда
			
			Движение = РегистрыСведений.DN_АВ_КредитноСтраховыеСделки;
		    Записи = Движение.СоздатьНаборЗаписей();
			
			Для Каждого Строка из РабочиеЛисты Цикл
				Если Строка.Проверено тогда
					Отказ = ПроверимМодифицированностьЛиста(Строка);
					
					Если Отказ тогда
						Прервать;
					КонецЕсли;
					
					Записи.Отбор.Регистратор.Установить(Строка.СсылкаНаРабочийЛист);
					Записи.Прочитать();
					Если Записи.Количество() тогда
						Для Каждого СтрокаЗаписи из Записи цикл
							Если ХозОперация = Справочники.ХозОперации.АктСверкиДоп_АВ_КВ_Страховой
									и ЗначениеЗаполнено(СтрокаЗаписи.АктСверки) 
										и Строка.Проверено и Строка.Расхождение < 0 тогда
								СтрокаЗаписи.УчтеноДопКВ = Истина;			
							ИначеЕсли Не ЗначениеЗаполнено(СтрокаЗаписи.АктСверки) 
									и СовпадениеПоАкту(СтрокаЗаписи) и Строка.Проверено 
										и (ХозОперация = Справочники.ХозОперации.АктСверкиКредитный 
											или ХозОперация = Справочники.ХозОперации.АктСверкиСтраховой)   тогда
								СтрокаЗаписи.АктСверки = Ссылка;
								СтрокаЗаписи.АВАкта = Строка.АВПоАкту;
								СтрокаЗаписи.Расхождение = Строка.Расхождение; 
								СтрокаЗаписи.УчтеноДопКВ = Ложь;			
							КонецЕсли;
						КонецЦикла;
						Записи.Записать();
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;		
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Функция СовпадениеПоАкту(Строка)

	Если Строка.Организация = Организация 
		//и Строка.ПодразделенияКомпании = ПодразделенияКомпании
			и Строка.Контрагент = Контрагент
				и Строка.ДоговорыВзаиморасчетов = ДоговорВзаиморасчетов тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
КонецФункции // СовпадениеПоАкту()

Функция ПроверимМодифицированностьЛиста(СтрокаАкта)

	РабочийЛист = СтрокаАкта.СсылкаНаРабочийЛист;
	
	Если ХозОперация = Справочники.ХозОперации.АктСверкиКредитный тогда
		
		Если НЕ СтрокаАкта.Статус = РабочийЛист.Статус тогда
			Сообщить("Кредитный лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
			Возврат Истина;
		КонецЕсли;
		
		Если НЕ СтрокаАкта.ОбщаяСуммаАВ = РабочийЛист.ОбщаяСуммаАВ тогда
			Сообщить("Кредитный лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
			Возврат Истина;
		КонецЕсли;
		
		Если НЕ Организация = РабочийЛист.Организация тогда
			Сообщить("Кредитный лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
			Возврат Истина;
		КонецЕсли;
		
		//Если НЕ ПодразделенияКомпании = РабочийЛист.ПодразделениеКомпании тогда
		Если НЕ СтрокаАкта.Подразделение = РабочийЛист.ПодразделениеКомпании тогда
			Сообщить("Кредитный лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
			Возврат Истина;
		КонецЕсли;
		
		Если НЕ Контрагент = РабочийЛист.КредитнаяПрограмма.БанкКонтрагент тогда
			Сообщить("Кредитный лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
			Возврат Истина;
		КонецЕсли;
		
		Если НЕ ДоговорВзаиморасчетов = РабочийЛист.КредитнаяПрограмма.DN_ДоговорВзаиморсчетов тогда
			Сообщить("Кредитный лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
			Возврат Истина;
		КонецЕсли;
	//////////////////////////////////////////////////////////////////////////////////////////////////////
	ИначеЕсли ХозОперация = Справочники.ХозОперации.АктСверкиСтраховой тогда
		
		Если НЕ СтрокаАкта.Статус = РабочийЛист.Статус тогда
			Сообщить("Страховой лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
			Возврат Истина;
		КонецЕсли;
		
		Если НЕ Организация = РабочийЛист.Организация тогда
			Сообщить("Страховой лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
			Возврат Истина;
		КонецЕсли;
		
		//Если НЕ ПодразделенияКомпании = РабочийЛист.ПодразделениеКомпании тогда 
		Если НЕ СтрокаАкта.Подразделение = РабочийЛист.ПодразделениеКомпании тогда
			Сообщить("Страховой лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
			Возврат Истина;
		КонецЕсли;
		
		Отбор = Новый Структура("ОбъектСтрахования,ПрограммаСтрахования,СуммаКомиссии,БланкПолиса",
			СтрокаАкта.Автомобиль,СтрокаАкта.Программа,СтрокаАкта.ОбщаяСуммаАВ,СтрокаАкта.БланкКСО);
		СтрокаРабочегоЛиста = РабочийЛист.ВариантыСтрахования.НайтиСтроки(Отбор);
		
		Если СтрокаРабочегоЛиста.Количество() тогда
			СтрокаРабочегоЛиста = СтрокаРабочегоЛиста[0];
			
			Если НЕ СтрокаАкта.ОбщаяСуммаАВ = СтрокаРабочегоЛиста.СуммаКомиссии тогда
				Сообщить("Страховой лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
				Возврат Истина;
			КонецЕсли;
			
			Если НЕ Контрагент = СтрокаРабочегоЛиста.Страховщик тогда
				Сообщить("Страховой лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
				Возврат Истина;
			КонецЕсли;
			
			Если НЕ ДоговорВзаиморасчетов = СтрокаРабочегоЛиста.ПрограммаСтрахования.Договор тогда
				Сообщить("Страховой лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе.
							|Не совпадает договор в Акте с договором в Программе страхования рабочего листа!");
				Возврат Истина;
			КонецЕсли;
		Иначе
			Сообщить("Страховой лист " + РабочийЛист.Номер + " от " + РабочийЛист.Дата + " был модифицирован, необходимо перезаполнить табличную часть в данном документе");
			Возврат Истина;
		КонецЕсли;		
	КонецЕсли;

	
	Возврат Ложь;
КонецФункции // ПроверимМодифицированностьЛиста()

Функция НайтиДокументы() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	РеализацияТоваров.Ссылка КАК Ссылка,
		|	ЗаявкаНаРасходДС.Ссылка КАК Ссылка1
		|ИЗ
		|	Документ.РеализацияТоваров КАК РеализацияТоваров,
		|	Документ.ЗаявкаНаРасходДС КАК ЗаявкаНаРасходДС
		|ГДЕ
		|	РеализацияТоваров.ДокументОснование = &ДокументОснование
		|	И ЗаявкаНаРасходДС.ДокументОснование = &ДокументОснование
		|	И РеализацияТоваров.Проведен = ИСТИНА
		|	И ЗаявкаНаРасходДС.Проведен = ИСТИНА";
	
	Запрос.УстановитьПараметр("ДокументОснование", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Возврат Истина;
	КонецЦикла;
	
	Возврат Ложь;

КонецФункции // НайтиДокументы()

Процедура ПриКопировании(ОбъектКопирования)
	РабочиеЛисты.Очистить();
	ИтогоРасхождение = 0;
	Итого_АВ_КВ_ПО_Акту = 0;
	ОбщаяСумма_АВ_КВ = 0;
	ДатаАкта = "010101";
	НомерАкта = "";
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ)
	
	Если НЕ (ХозОперация = Справочники.ХозОперации.АктСверкиКредитный_ПоРетроБонусу
		или ХозОперация = Справочники.ХозОперации.АктСверкиСтраховой_ПоРетроБонусу) тогда
		Если НайтиДокументы() тогда
			Отказ = Истина;
			Сообщить("На основании данного документа, есть проведенные документы. Сначала распроведите их");
		КонецЕсли;
		
		Движение = РегистрыСведений.DN_АВ_КредитноСтраховыеСделки;
	    Записи = Движение.СоздатьНаборЗаписей();
		
		Для Каждого Строка из РабочиеЛисты Цикл
			Записи.Отбор.Регистратор.Установить(Строка.СсылкаНаРабочийЛист);
			Записи.Прочитать();
			Если Записи.Количество() тогда
				Для Каждого СтрокаЗаписи из Записи цикл
					Если ЗначениеЗаполнено(СтрокаЗаписи.АктСверки) 
							и (ХозОперация = Справочники.ХозОперации.АктСверкиКредитный 
								или ХозОперация = Справочники.ХозОперации.АктСверкиСтраховой)   тогда
						Если НЕ СтрокаЗаписи.УчтеноДопКВ тогда
							СтрокаЗаписи.АктСверки = Документы.DN_АктСверкиКредитСтрах.ПустаяСсылка();
							СтрокаЗаписи.АВАкта = 0;
							СтрокаЗаписи.Расхождение = 0;   
						Иначе
							Отказ = Истина;
							Сообщить("Существуют Акты Сверки Доп КВ по этому документу, сначала распроведите эти Акты");
						КонецЕсли;
					ИначеЕсли ХозОперация = Справочники.ХозОперации.АктСверкиДоп_АВ_КВ_Страховой тогда
						СтрокаЗаписи.УчтеноДопКВ = Ложь;
					КонецЕсли;				
				КонецЦикла;
				Записи.Записать();
			КонецЕсли;
		КонецЦикла; 
	КонецЕсли;	
КонецПроцедуры
