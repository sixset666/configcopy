#Область ИнформацияОДокументе

//************************//
// ИНФОРМАЦИЯ О ДОКУМЕНТЕ //
//************************//


// Возвращает доступные варианты печати документа
// Параметры:
//	ДокументСсылка - Ссылка на документ печати
// Возвращаемое значение:
//	Структура, каждая строка которой соответствует одному из вариантов печати. Первый элемент структуры - форма по умолчанию
Функция ПолучитьСписокПечатныхФорм(ДокументСсылка) Экспорт
	
	СтруктураМакетов = Новый Структура();
	
	СтруктураМакетов.Вставить("СчетФактура", "Счет-фактура");
	
	Если ДокументСсылка.ХозОперация = Справочники.ХозОперации.СчетФактураПолученныйКорректировка Тогда
			
		СтруктураМакетов.Вставить("КорректировочныйСчетФактура", "Корректировочный счет-фактура");
		СтруктураМакетов.Вставить("УКД", "Универсальный корректировочный документ");
	КонецЕсли;
	
	Возврат СтруктураМакетов;
	
КонецФункции // ПолучитьСписокПечатныхФорм()

Функция ТоварыДляПечатиУКД(ДокументОбъект) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ТипЗнч(ДокументОбъект) = Тип("ДокументСсылка.КорректировкаПоступления") Тогда

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументОбъект.Ссылка);
	
	МассивОбъектов = Новый Массив;
	МассивОбъектов.Добавить(ДокументОбъект.Ссылка);
	ПроверяемыйДокумент = ДокументОбъект.Ссылка;
	Пока Истина Цикл
		ПроверяемыйДокумент = ПроверяемыйДокумент.ДокументОснование;
		Если ЗначениеЗаполнено(ПроверяемыйДокумент) Тогда
			МассивОбъектов.Добавить(ПроверяемыйДокумент);
		Иначе
			Прервать;
		КонецЕсли;
	КонецЦикла;
	Запрос.УстановитьПараметр("МассивОбъектов", МассивОбъектов);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КорректировкаПоступленияТовары.Номенклатура КАК Номенклатура,
	|	КорректировкаПоступленияТовары.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	КорректировкаПоступленияТовары.Количество КАК Количество,
	|	КорректировкаПоступленияТовары.КоличествоРазница КАК КоличествоРазница,
	|	КорректировкаПоступленияТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	КорректировкаПоступленияТовары.Коэффициент КАК Коэффициент,
	|	КорректировкаПоступленияТовары.СтавкаНДС КАК СтавкаНДС,
	|	КорректировкаПоступленияТовары.СуммаНДС КАК СуммаНДС,
	|	КорректировкаПоступленияТовары.СуммаНДСРазница КАК СуммаНДСРазница,
	|	КорректировкаПоступленияТовары.СуммаРозничная КАК СуммаРозничная,
	|	КорректировкаПоступленияТовары.СуммаРозничнаяРазница КАК СуммаРозничнаяРазница,
	|	КорректировкаПоступленияТовары.СуммаВсего КАК СуммаВсего,
	|	КорректировкаПоступленияТовары.СуммаВсегоРазница КАК СуммаВсегоРазница,
	|	КорректировкаПоступленияТовары.ГТД КАК ГТД,
	|	КорректировкаПоступленияТовары.ЕдиницаИзмеренияПоДокументуПоступления КАК ЕдиницаИзмеренияПоДокументуПоступления,
	|	КорректировкаПоступленияТовары.КоличествоПоДокументуПоступления КАК КоличествоПоДокументуПоступления,
	|	КорректировкаПоступленияТовары.КоэффициентПоДокументуПоступления КАК КоэффициентПоДокументуПоступления,
	|	КорректировкаПоступленияТовары.СуммаНДСПоДокументуПоступления КАК СуммаНДСПоДокументуПоступления,
	|	КорректировкаПоступленияТовары.СуммаВсегоПоДокументуПоступления КАК СуммаВсегоПоДокументуПоступления
	|ПОМЕСТИТЬ ТЧКорректировки
	|ИЗ
	|	Документ.КорректировкаПоступления.Товары КАК КорректировкаПоступленияТовары
	|ГДЕ
	|	КорректировкаПоступленияТовары.Ссылка = &Ссылка
	|	И (КорректировкаПоступленияТовары.Количество <> КорректировкаПоступленияТовары.КоличествоПоДокументуПоступления
	|			ИЛИ КорректировкаПоступленияТовары.ЕдиницаИзмерения <> КорректировкаПоступленияТовары.ЕдиницаИзмеренияПоДокументуПоступления
	|			ИЛИ КорректировкаПоступленияТовары.Коэффициент <> КорректировкаПоступленияТовары.КоэффициентПоДокументуПоступления
	|			ИЛИ КорректировкаПоступленияТовары.СтавкаНДС <> КорректировкаПоступленияТовары.СтавкаНДСПоДокументуПоступления
	|			ИЛИ КорректировкаПоступленияТовары.СуммаНДС <> КорректировкаПоступленияТовары.СуммаНДСПоДокументуПоступления
	|			ИЛИ КорректировкаПоступленияТовары.СуммаРозничная <> КорректировкаПоступленияТовары.СуммаРозничнаяПоДокументуПоступления
	|			ИЛИ КорректировкаПоступленияТовары.СуммаВсего <> КорректировкаПоступленияТовары.СуммаВсегоПоДокументуПоступления)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ГТДПартийТоваровКомпании.Номенклатура КАК Номенклатура,
	|	ГТДПартийТоваровКомпании.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	ГТДПартийТоваровКомпании.ГТД КАК ГТД,
	|	СУММА(ГТДПартийТоваровКомпании.Количество) КАК КоличествоДо
	|ПОМЕСТИТЬ втГТДДоИзменения
	|ИЗ
	|	РегистрНакопления.ГТДПартийТоваровКомпании КАК ГТДПартийТоваровКомпании
	|ГДЕ
	|	ГТДПартийТоваровКомпании.Регистратор В(&МассивОбъектов)
	|	И ГТДПартийТоваровКомпании.Регистратор <> &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ГТДПартийТоваровКомпании.Номенклатура,
	|	ГТДПартийТоваровКомпании.ХарактеристикаНоменклатуры,
	|	ГТДПартийТоваровКомпании.ГТД
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ГТДПартийТоваровКомпании.Номенклатура КАК Номенклатура,
	|	ГТДПартийТоваровКомпании.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	ГТДПартийТоваровКомпании.ГТД КАК ГТД,
	|	СУММА(ГТДПартийТоваровКомпании.Количество) КАК КоличествоПосле
	|ПОМЕСТИТЬ втГТДПослеИзменения
	|ИЗ
	|	РегистрНакопления.ГТДПартийТоваровКомпании КАК ГТДПартийТоваровКомпании
	|ГДЕ
	|	ГТДПартийТоваровКомпании.Регистратор В(&МассивОбъектов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ГТДПартийТоваровКомпании.Номенклатура,
	|	ГТДПартийТоваровКомпании.ХарактеристикаНоменклатуры,
	|	ГТДПартийТоваровКомпании.ГТД
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(втГТДДоИзменения.Номенклатура, втГТДПослеИзменения.Номенклатура) КАК Номенклатура,
	|	ЕСТЬNULL(втГТДДоИзменения.ХарактеристикаНоменклатуры, втГТДПослеИзменения.ХарактеристикаНоменклатуры) КАК ХарактеристикаНоменклатуры,
	|	ЕСТЬNULL(втГТДДоИзменения.ГТД, втГТДПослеИзменения.ГТД) КАК ГТД,
	|	СУММА(ЕСТЬNULL(втГТДДоИзменения.КоличествоДо, 0)) КАК КоличествоДо,
	|	СУММА(ЕСТЬNULL(втГТДПослеИзменения.КоличествоПосле, 0)) КАК КоличествоПосле
	|ПОМЕСТИТЬ втГТДДанныеДоПосле
	|ИЗ
	|	втГТДДоИзменения КАК втГТДДоИзменения
	|		ПОЛНОЕ СОЕДИНЕНИЕ втГТДПослеИзменения КАК втГТДПослеИзменения
	|		ПО втГТДДоИзменения.Номенклатура = втГТДПослеИзменения.Номенклатура
	|			И втГТДДоИзменения.ХарактеристикаНоменклатуры = втГТДПослеИзменения.ХарактеристикаНоменклатуры
	|			И втГТДДоИзменения.ГТД = втГТДПослеИзменения.ГТД
	|
	|СГРУППИРОВАТЬ ПО
	|	ЕСТЬNULL(втГТДДоИзменения.Номенклатура, втГТДПослеИзменения.Номенклатура),
	|	ЕСТЬNULL(втГТДДоИзменения.ХарактеристикаНоменклатуры, втГТДПослеИзменения.ХарактеристикаНоменклатуры),
	|	ЕСТЬNULL(втГТДДоИзменения.ГТД, втГТДПослеИзменения.ГТД)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТЧКорректировки.Номенклатура КАК Номенклатура,
	|	ТЧКорректировки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	ТЧКорректировки.Количество КАК Количество,
	|	ТЧКорректировки.КоличествоРазница КАК КоличествоРазница,
	|	ТЧКорректировки.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ТЧКорректировки.Коэффициент КАК Коэффициент,
	|	ТЧКорректировки.СтавкаНДС КАК СтавкаНДС,
	|	ТЧКорректировки.СуммаНДС КАК СуммаНДС,
	|	ТЧКорректировки.СуммаНДСРазница КАК СуммаНДСРазница,
	|	ТЧКорректировки.СуммаРозничная КАК СуммаРозничная,
	|	ТЧКорректировки.СуммаРозничнаяРазница КАК СуммаРозничнаяРазница,
	|	ТЧКорректировки.СуммаВсего КАК СуммаВсего,
	|	ТЧКорректировки.СуммаВсегоРазница КАК СуммаВсегоРазница,
	|	ТЧКорректировки.ГТД КАК ГТД,
	|	ТЧКорректировки.ЕдиницаИзмеренияПоДокументуПоступления КАК ЕдиницаИзмеренияПоДокументуПоступления,
	|	ТЧКорректировки.КоличествоПоДокументуПоступления КАК КоличествоПоДокументуПоступления,
	|	ТЧКорректировки.КоэффициентПоДокументуПоступления КАК КоэффициентПоДокументуПоступления,
	|	ТЧКорректировки.СуммаНДСПоДокументуПоступления КАК СуммаНДСПоДокументуПоступления,
	|	ТЧКорректировки.СуммаВсегоПоДокументуПоступления КАК СуммаВсегоПоДокументуПоступления,
	|	ЕСТЬNULL(втГТДДанныеДоПосле.КоличествоДо, 0) КАК ГТДКоличествоДо,
	|	ЕСТЬNULL(втГТДДанныеДоПосле.КоличествоПосле, 0) КАК ГТДКоличествоПосле,
	|	0 КАК НомерИсходнойСтроки
	|ИЗ
	|	ТЧКорректировки КАК ТЧКорректировки
	|		ЛЕВОЕ СОЕДИНЕНИЕ втГТДДанныеДоПосле КАК втГТДДанныеДоПосле
	|		ПО ТЧКорректировки.Номенклатура = втГТДДанныеДоПосле.Номенклатура
	|			И ТЧКорректировки.ХарактеристикаНоменклатуры = втГТДДанныеДоПосле.ХарактеристикаНоменклатуры
	|			И ТЧКорректировки.ГТД = втГТДДанныеДоПосле.ГТД";

	
	ТаблицаТоваров = Запрос.Выполнить().Выгрузить();
	ИначеЕсли ТипЗнч(ДокументОбъект) = Тип("ДокументСсылка.КорректировкаПоступленияАвтомобилей") Тогда
		
		ТаблицаТоваров = ПолучитьВыборку(ДокументОбъект.ССылка);
		
	КонецЕсли;
		
    ТаблицаТоваров = ЗаполнитьНомераСтрокВТаблице(ТаблицаТоваров, ДокументОбъект.Ссылка);
	
	Возврат ТаблицаТоваров;
	
КонецФункции

Функция ПолучитьВыборку(ДокументОснование ) Экспорт
	Запрос = Новый Запрос;
	Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.КорректировкаПоступления") Тогда
		Запрос.Текст =
		"ВЫБРАТЬ
		|	КорректировкаПоступленияТовары.Номенклатура КАК Номенклатура,
		|	КорректировкаПоступленияТовары.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
		|	КорректировкаПоступленияТовары.Количество КАК Количество,
		|	КорректировкаПоступленияТовары.КоличествоПоДокументуПоступления КАК КоличествоПоДокументуПоступления,
		|	КорректировкаПоступленияТовары.КоличествоРазница КАК КоличествоРазница,
		|	КорректировкаПоступленияТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	КорректировкаПоступленияТовары.ЕдиницаИзмеренияПоДокументуПоступления КАК ЕдиницаИзмеренияПоДокументуПоступления,
		|	КорректировкаПоступленияТовары.Коэффициент КАК Коэффициент,
		|	КорректировкаПоступленияТовары.КоэффициентПоДокументуПоступления КАК КоэффициентПоДокументуПоступления,
		|	КорректировкаПоступленияТовары.Цена КАК Цена,
		|	КорректировкаПоступленияТовары.Сумма КАК Сумма,
		|	КорректировкаПоступленияТовары.СтавкаНДС КАК СтавкаНДС,
		|	КорректировкаПоступленияТовары.СуммаНДС КАК СуммаНДС,
		|	КорректировкаПоступленияТовары.СуммаНДСПоДокументуПоступления КАК СуммаНДСПоДокументуПоступления,
		|	КорректировкаПоступленияТовары.СуммаНДСРазница КАК СуммаНДСРазница,
		|	КорректировкаПоступленияТовары.СуммаВсего КАК СуммаВсего,
		|	КорректировкаПоступленияТовары.СуммаВсегоПоДокументуПоступления КАК СуммаВсегоПоДокументуПоступления,
		|	КорректировкаПоступленияТовары.СуммаВсегоРазница КАК СуммаВсегоРазница,
		|	КорректировкаПоступленияТовары.ГТД КАК ГТД
		|ИЗ
		|	Документ.КорректировкаПоступления.Товары КАК КорректировкаПоступленияТовары
		|ГДЕ
		|	КорректировкаПоступленияТовары.Ссылка = &Ссылка
		|	И (КорректировкаПоступленияТовары.Количество <> КорректировкаПоступленияТовары.КоличествоПоДокументуПоступления
		|			ИЛИ КорректировкаПоступленияТовары.ЕдиницаИзмерения <> КорректировкаПоступленияТовары.ЕдиницаИзмеренияПоДокументуПоступления
		|			ИЛИ КорректировкаПоступленияТовары.Коэффициент <> КорректировкаПоступленияТовары.КоэффициентПоДокументуПоступления
		|			ИЛИ КорректировкаПоступленияТовары.СтавкаНДС <> КорректировкаПоступленияТовары.СтавкаНДСПоДокументуПоступления
		|			ИЛИ КорректировкаПоступленияТовары.СуммаНДС <> КорректировкаПоступленияТовары.СуммаНДСПоДокументуПоступления
		|			ИЛИ КорректировкаПоступленияТовары.СуммаРозничная <> КорректировкаПоступленияТовары.СуммаРозничнаяПоДокументуПоступления
		|			ИЛИ КорректировкаПоступленияТовары.СуммаВсего <> КорректировкаПоступленияТовары.СуммаВсегоПоДокументуПоступления)";
	ИначеЕсли ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.КорректировкаПоступленияАвтомобилей") Тогда
		Запрос.Текст =
		"ВЫБРАТЬ
		|	КорректировкаПоступленияАвтомобилейАвтомобили.Автомобиль КАК Номенклатура,
		|	1 КАК Количество,
		|	1 КАК КоличествоПоДокументуПоступления,
		|	0 КАК КоличествоРазница,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.Цена КАК Цена,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.Сумма КАК Сумма,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДС КАК СтавкаНДС,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДС КАК СуммаНДС,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДСПоДокументуПоступления КАК СуммаНДСПоДокументуПоступления,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДСРазница КАК СуммаНДСРазница,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсего КАК СуммаВсего,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоПоДокументуПоступления КАК СуммаВсегоПоДокументуПоступления,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоРазница КАК СуммаВсегоРазница,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.ГТД КАК ГТД,
		|	0 КАК НомерИсходнойСтроки
		|ИЗ
		|	Документ.КорректировкаПоступленияАвтомобилей.Автомобили КАК КорректировкаПоступленияАвтомобилейАвтомобили
		|ГДЕ
		|	КорректировкаПоступленияАвтомобилейАвтомобили.Ссылка = &Ссылка
		|	И (КорректировкаПоступленияАвтомобилейАвтомобили.Сумма <> КорректировкаПоступленияАвтомобилейАвтомобили.СуммаПоДокументуПоступления
		|			ИЛИ КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДС <> КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДСПоДокументуПоступления
		|			ИЛИ КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДС <> КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДСПоДокументуПоступления
		|			ИЛИ КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсего <> КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоПоДокументуПоступления)";
	КонецЕсли;
	Запрос.УстановитьПараметр("Ссылка",ДокументОснование);
	
	Возврат Запрос.Выполнить().Выгрузить();
КонецФункции

Функция ЗаполнитьНомераСтрокВТаблице(ТаблицаИзменений, Ссылка)
	
	Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.КорректировкаПоступленияАвтомобилей") Тогда
		СтруктураПоиска = Новый Структура("Номенклатура,ГТД");
	Иначе
		СтруктураПоиска = Новый Структура("Номенклатура,ЕдиницаИзмерения,ХарактеристикаНоменклатуры,ГТД");
	КонецЕсли;
	 	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СчетФактураПолученныйТовары.Номенклатура КАК Номенклатура,
		|	СчетФактураПолученныйТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	СчетФактураПолученныйТовары.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
		|	СчетФактураПолученныйТовары.ГТД КАК ГТД,
		|	СчетФактураПолученныйТовары.НомерИсходнойСтроки КАК НомерИсходнойСтроки
		|ИЗ
		|	Документ.СчетФактураПолученный.Товары КАК СчетФактураПолученныйТовары
		|ГДЕ
		|	СчетФактураПолученныйТовары.Ссылка.ДокументОснование = &ССылка";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	ДанныеСФ = Запрос.Выполнить().Выгрузить();
	
	Для каждого ТекущаяСтрока Из ТаблицаИзменений Цикл
		
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, ТекущаяСтрока);
		
		НайденныеСтроки = ДанныеСФ.НайтиСтроки(СтруктураПоиска);
		Если НайденныеСтроки.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		ТекущаяСтрока.НомерИсходнойСтроки = НайденныеСтроки[0].НомерИсходнойСтроки; 
		
	КонецЦикла;
	
	Возврат ТаблицаИзменений;

	
КонецФункции


#КонецОбласти