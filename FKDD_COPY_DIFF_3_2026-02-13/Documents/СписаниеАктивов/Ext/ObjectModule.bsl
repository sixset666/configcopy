// Модуль документа СписаниеАктивов

////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ ОБЪЕКТА

Перем Права Экспорт;				// Переменная объекта - ссылка на коллекцию прав, настроек и переменных окружения
Перем РезультатОбработки Экспорт;	// Переменная для накопления результатов проведения по модулям наборов записей
Перем ВалютаКурсДок Экспорт;        // Кэш валюты и курса документа
Перем тКэшСуммСписания Экспорт;		// Переменная для кэширования результатов вычисления суммы списания
Перем ФлагПерерасчет;               // Переменная для обозначения того, что ведется перерасчет суммы документа
Перем ОбработкаЗначенияСвойствОбъектов Экспорт; // Переменная для хранения значения свойств основания/объекта копирования

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ДОПОЛНИТЕЛЬНЫХ МЕТОДОВ ОБЪЕКТА

// Возвращает структуру обязательных / уникальных реквизитов документа
// Возвращаемая структура содержит строковые идентификаторы реквизитов или вложенные структуры для табличных частей
// Для реквизита значение структуры содержит число 1-Обязательный, 2-Уникальный, 3-Уникальный и обязательный
Функция ПолучитьОбязательныеРеквизиты() Экспорт
	// Обязательные поля таблицы товаров
	ОбязательныеАктивы = Новый Структура();
	ОбязательныеАктивы.Вставить("ПрочийАктив", 1);
		
	// Обязательные реквизиты документа
	ОбязательныеРеквизиты=Новый Структура();
		
	Возврат ОбязательныеРеквизиты;
КонецФункции // ПолучитьОбязательныеРеквизиты()

// Проверяет корректность заполнения объекта.
// может управляться булевыми флагами выполняемых проверок Заполнение, Уникальность
// (могут быть и другие необязательные)
// Обычно выполняется универсальным обработчиком, но могут быть добавлены доп. проверки
//
// Параметры:
//  Ошибки       - строка, в случае некорректного заполнения содержит описанием возникших ошибок, 
//  ДопРеквизиты - структура, на вход может быть передана структура с дополнительными реквизитами для проверки,
//  Заполнение   - булево, флаг проверки, 
//  Уникальность - булево, флаг проверки.
//
// Возвращаемое значение:
//  Булево - Возвращает Истина если все заполнено корректно и Ложь иначе.
// 
Функция ПроверитьКорректность(Ошибки="", ДопРеквизиты=Неопределено, Заполнение=Истина, Уникальность=Истина) Экспорт
	// Здесь могут быть определены дополнительные к стандартным обязательным реквизитам условия проверки
	// Здесь могут быть определены дополнительные к стандартным обязательным реквизитам условия проверки
	Результат = дкПроверитьКорректность(ЭтотОбъект, Ошибки, ДопРеквизиты, Заполнение, Уникальность);
	
	// проверять на корректность реквизитов по организации будем только
	// в случае если все нормально с остальными реквизитами
	//Чтение значения для определения способа ведения баланса
	СпособВеденияБаланса = Константы.СпособВеденияБаланса.Получить();
	
	// способ ведения не по организации или не прошла предыдущая проверка то и проверять ничего не будем
	Если  Результат И СпособВеденияБаланса = Перечисления.СпособВеденияБаланса.ПоОрганизации Тогда
		КонтролируемыеРеквизиты = Новый Структура();
		
		Результат = дкПроверитьКорректностьПоОрганизации(ЭтотОбъект,КонтролируемыеРеквизиты,Ошибки) И Результат;
	КонецЕсли;	
	Для Каждого ТекСтрока Из Активы Цикл
		Если НЕ (ТекСтрока.ПрочийАктив.ВидПрочегоАктива = Перечисления.ВидыПрочихАктивов.Спецодежда ИЛИ
			     ТекСтрока.ПрочийАктив.ВидПрочегоАктива = Перечисления.ВидыПрочихАктивов.Спецоснастка ИЛИ
				 ТекСтрока.ПрочийАктив.ВидПрочегоАктива = Перечисления.ВидыПрочихАктивов.Инструменты) Тогда
			Если НЕ (ТекСтрока.Количество = 1) Тогда
				ТекСтрока.Количество = 1;
				#Если Клиент Тогда
				Сообщить("Табличная часть ""Активы"" строка " + ТекСтрока.НомерСтроки + ": количество актива """ + СокрЛП(ТекСтрока.ПрочийАктив) + """ заменено на 1,000.", СтатусСообщения.Важное);
				#КонецЕсли
			КонецЕсли;	
		КонецЕсли;
	КонецЦикла;
	Возврат Результат;
КонецФункции // ПроверитьКорректность()
 
// Функция проверяет, допустимо ли изменение объекта
//
// Параметры:
//  БлокироватьРеквизиты - структура, структура блокируемых на изменение реквизитов.
//
// Возвращаемое значение:
// Булево - Возвращает Истина, если изменения возможны, ложь иначе
//          Если изменения доступны частично, возвращает ложь и структуру блокируемых на изменение реквизитов.
//
Функция ДоступностьИзменения(БлокироватьРеквизиты=Неопределено) Экспорт
    // Здесь может быть прописано определение наличия ссылок, блокирующих изменение объекта
	Возврат Истина;
КонецФункции // ДоступностьИзменения()

// Возвращает список возможных хозяйственных операций документа
// Возвращаемое значение: 
//  СписокЗначений. 
//  Строка списка: Значение - имя предопределенного элемента; 
//				   Представление - красивое его представление
// 				   "Помеченная" строка - ХО по умолчанию.
Функция ПолучитьСписокХозОпераций() Экспорт
	СписокХозОпераций = Новый СписокЗначений;
	СписокХозОпераций.Добавить("СписаниеАктивов", "Списание активов", Истина);
		
	Возврат СписокХозОпераций;
КонецФункции // ПолучитьСписокХозОпераций()

// сформирует свой результат запроса по активам
//
// Возвращаемое значение:
//  возвращает результат запроса.
//
Функция ПолучитьРезультатЗапросаПоАктивам()
	ТекстЗапроса = "ВЫБРАТЬ
	               |	СписаниеАктивовАктивы.ПрочийАктив КАК Актив,
	               |	СУММА(СписаниеАктивовАктивы.Количество) КАК Количество
	               |ИЗ
	               |	Документ.СписаниеАктивов.Активы КАК СписаниеАктивовАктивы
	               |ГДЕ
	               |	СписаниеАктивовАктивы.Ссылка = &Ссылка
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	СписаниеАктивовАктивы.ПрочийАктив";

	Запрос=Новый Запрос();
	Запрос.УстановитьПараметр("Ссылка",Ссылка);
	Запрос.Текст=ТекстЗапроса;

	Возврат Запрос.Выполнить();
КонецФункции // ПолучитьРезультатЗапросаПоАктивам()

// Расчет общей балансовой стоимости активов
Функция РассчитатьСуммуВсего() Экспорт
	СуммаВсего = дкПолучитьСуммуСписания(ЭтотОбъект, "ПрочиеАктивыВЭксплуатации", тКэшСуммСписания);
	Возврат СуммаВсего;
КонецФункции // РассчитатьСуммуВсего()

// Обработка изменения реквизитов документа
// Параметры
//  Имя			– Строка – Имя реквизита документа с полным путем (например Товары.Номенклатура).
//  ЭтаФорма	– Форма	 – Ссылка на форму документа. Если значение неопределено,
//                         производится программная обработка реквизитов.
//  ТекСтрока	– СтрокаТабличнойЧасти – Ссылка на строку табличной части документа, реквизит которой обрабатывается.
//										 Имеет смысл только для табличных частей документов.
//  ДопПараметры– Структура			– Структура, содержащая дополнительные параметры обработки реквизита.
// Возвращаемое значение:
//   Булево   – Результат выполнения обработки.
Функция ОбработкаРеквизита(Имя,ТекСтрока=Неопределено,ЭтаФорма=Неопределено,ДопПараметры=Неопределено) Экспорт
	// ОБРАБОТКА РЕКВИЗИТОВ ДОКУМЕНТА
	Если Имя = "ПодразделениеКомпании" Тогда
		Рез = дкОбработкаРеквизита(ЭтотОбъект, Имя, ТекСтрока, ЭтаФорма, ДопПараметры);
		
		//здесь будет перезаполнена ТЧ Активы
		флПерезаполнить = Ложь;
		#Если Клиент Тогда
			Если Вопрос("Перезаполнить активами текущего подразделения <"+СокрЛП(ПодразделениеКомпании)+"> ?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да Тогда
			флПерезаполнить = Истина;
		КонецЕсли;
		#КонецЕсли
	
		#Если Клиент Тогда
		Если флПерезаполнить Тогда
			Активы.Очистить();
			Результат = дкКоманднаяПанельАктивыЗаполнение(ЭтаФорма, Активы, Новый Структура("Имя", "ЗаполнитьАктивамиПодразделения"));
			// смотрим что нам вернули
			Если ТипЗнч(Результат) = Тип("ТаблицаЗначений") Тогда
				ВсегоСтрок = Результат.Количество();
				Для Каждого СтрокаАктив Из Результат Цикл
					НоваяСтрока = Активы.Добавить();
					НоваяСтрока.ПрочийАктив = СтрокаАктив.Актив;
					Состояние("Загружено " + СокрЛП(НоваяСтрока.НомерСтроки) + " из " + СокрЛП(ВсегоСтрок));
				КонецЦикла;
			КонецЕсли;
			дкВывестиЗаголовокСуммаДокумента(ЭтаФорма);
		КонецЕсли;
	    #КонецЕсли
		Возврат Истина;
				
	ИначеЕсли Имя = "ВалютаДокумента" И (ВалютаКурсДок.Валюта <> ВалютаДокумента ИЛИ ВалютаКурсДок.Курс <> КурсДокумента) Тогда
		
		ВалютаКурсДок.Валюта = ВалютаДокумента;
		ВалютаКурсДок.Курс = КурсДокумента;
		Возврат Истина;
		
	Иначе
		Возврат дкОбработкаРеквизита(ЭтотОбъект, Имя, ТекСтрока, ЭтаФорма, ДопПараметры);
	КонецЕсли;
КонецФункции // ОбработкаРеквизита()

// заполнение свойств из документа основания
Процедура ЗаполнитьСвойстваНаОсновании(Основание) Экспорт
 //зарезервировано для описания заполнения свойств из свойств основания
КонецПроцедуры


#Если Клиент Тогда
////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ПЕЧАТИ ДОКУМЕНТА

// Формирует печатную форму "Списание активов"
// 
// Параметры:
//  ТабДокумент - табличный документ.
//
// Возвращаемое значение:
//  ТабДокумент - возвращает сформированный табличный документ.
//
Функция ПечатьСписаниеАктивов(ТабДокумент) Экспорт
	Макет = ПолучитьМакет("СписаниеАктивов");
	
	//вывод заголовка документа
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
	ТекстЗаголовка = дкПолучитьПредставление(ЭтотОбъект);
	ОбластьМакета.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	
	//bz++
	Если НЕ обЗначениеНеЗаполнено(ПодразделениеКомпании) И НЕ обЗначениеНеЗаполнено(ПодразделениеКомпании.КПП) Тогда
		СтрокаПредставления = спПолучитьПредставление(Организация);
		ОбластьМакета.Параметры.ПредставлениеОрганизации = СтрЗаменить(СтрокаПредставления, Организация.КПП, ПодразделениеКомпании.КПП);
	Иначе	
	    ОбластьМакета.Параметры.ПредставлениеОрганизации = спПолучитьПредставление(Организация);
	КонецЕсли;
	
	//ДополнительныеПараметры = спСоздатьПараметрыПолученияПредставления();
	//ДополнительныеПараметры.Вставить("ИспользоватьКПППодразделения");
	//ДополнительныеПараметры.Вставить("ПодразделениеКомпании", ПодразделениеКомпании);
	//ОбластьМакета.Параметры.ПредставлениеОрганизации = спПолучитьПредставление(Организация, , ДополнительныеПараметры);
	//bz--
	
	ОбластьМакета.Параметры.ПредставлениеПодразделения	= спПолучитьНаименование(ПодразделениеКомпании);
	//вывод свойств
	СтрокаСвойств = дкПолучитьСтрокуСвойствДокумента(ЭтотОбъект);
	ОбластьМакета.Параметры.СтрокаСвойств = СтрокаСвойств;
	ТабДокумент.Вывести(ОбластьМакета);
	НомерСтраницы = 2;
	НомерСтраницыПред = НомерСтраницы;
	
	//для начала настроим макет
	ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ФорматВыводаСуммы = обПраво("ФорматВыводаСуммы",Права,,ЭтотОбъект);
	//теперь выводим шапку
	ТабДокумент.Вывести(ОбластьШапкаТаблицы);
	
	//готовим области строки
	ОбластьМакета = Макет.ПолучитьОбласть("Строка");
	
	ОбластьМакетаИтогоПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице");
	СтруктураИтоговПоСтранице = Новый Структура("ВалютаДокумента,ОстаточнаяСтоимость",ВалютаДокумента,0);
	//заполним параметры шапки таблицы для следующего листа
	ОбластьШапкаТаблицы.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
	
	Если Проведен Тогда
		ТекстЗапроса = "ВЫБРАТЬ
		|	СписаниеАктивовАктивы.НомерСтроки,
		|	ПрочиеАктивыВЭксплуатации.ПрочийАктив КАК ПрочийАктив,
		|";
		Если ВалютаДокумента=Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить() Тогда
			ТекстЗапроса=ТекстЗапроса+"
			|	ЕСТЬNULL(ПрочиеАктивыВЭксплуатации.БалансоваяСтоимость,0) КАК БалансоваяСтоимость,
			|	ЕСТЬNULL(ПрочиеАктивыВЭксплуатации.БалансоваяСтоимость,0)-ЕСТЬNULL(ПрочиеАктивыВЭксплуатации.СуммаАмортизации,0) КАК ОстаточнаяСтоимость
			|";
		Иначе
			ТекстЗапроса=ТекстЗапроса+"
			|	ВЫБОР
			|		КОГДА ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьУпр ЕСТЬ NULL 
			|			ТОГДА 0
			|		ИНАЧЕ ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьУпр * &МножительКурса
			|	КОНЕЦ КАК БалансоваяСтоимость,
			|	ВЫБОР
			|		КОГДА ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьУпр ЕСТЬ NULL 
			|			ТОГДА 0
			|		ИНАЧЕ ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьУпр * &МножительКурса
			|	КОНЕЦ - ВЫБОР
			|		КОГДА ПрочиеАктивыВЭксплуатации.СуммаАмортизацииУпр ЕСТЬ NULL 
			|			ТОГДА 0
			|		ИНАЧЕ ПрочиеАктивыВЭксплуатации.СуммаАмортизацииУпр * &МножительКурса
			|	КОНЕЦ КАК ОстаточнаяСтоимость
			|";
		КонецЕсли; 
		ТекстЗапроса=ТекстЗапроса+"
		|ИЗ
		|	Документ.СписаниеАктивов.Активы КАК СписаниеАктивовАктивы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПрочиеАктивыВЭксплуатации КАК ПрочиеАктивыВЭксплуатации
		|		ПО СписаниеАктивовАктивы.ПрочийАктив = ПрочиеАктивыВЭксплуатации.ПрочийАктив
		|ГДЕ
		|	ПрочиеАктивыВЭксплуатации.ВидДвижения = &ВидДвиженияНакопленияРасход
		|	И ПрочиеАктивыВЭксплуатации.Регистратор = &Ссылка
		|	И СписаниеАктивовАктивы.Ссылка = &Ссылка";
		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.УстановитьПараметр("Ссылка",Ссылка);
		Запрос.УстановитьПараметр("ВидДвиженияНакопленияРасход",ВидДвиженияНакопления.Расход);
		ВалютаУправленческогоУчета = Константы.ВалютаУправленческогоУчетаКомпании.Получить();
		Если обЗначениеНеЗаполнено(ЭтотОбъект.КурсВалютыУпр) Тогда
			МножительКурса = обПересчет(1, ВалютаУправленческогоУчета, Дата , ВалютаДокумента, КурсДокумента);
		Иначе
			МножительКурса = обПересчет(1, ВалютаУправленческогоУчета, КурсВалютыУпр, ВалютаДокумента, КурсДокумента);
		КонецЕсли;
		Запрос.УстановитьПараметр("МножительКурса",МножительКурса);
	Иначе
		ТЧДокумента = Активы.Выгрузить();
		ТЧДокумента.Свернуть("ПрочийАктив","Количество");
		Запрос = Новый Запрос;
		Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ПрочийАктив КАК ПрочийАктив,
		|	Количество  КАК Количество
		|ПОМЕСТИТЬ
		|	ТабДокумента
		|ИЗ
		|	&ТЧДокумента КАК ТЧДокумента
		|;
		|ВЫБРАТЬ
		|	ТабДокумента.ПрочийАктив КАК ПрочийАктив,
		|	ТабДокумента.Количество  КАК Количество,
		|	ВЫБОР
		|		КОГДА ПрочиеАктивыВЭксплуатации.КоличествоОстаток ЕСТЬ NULL ТОГДА
		|			0
		|		ИНАЧЕ
		|			(ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьУпрОстаток * &МножительКурса)/ПрочиеАктивыВЭксплуатации.КоличествоОстаток*ТабДокумента.Количество
		|	КОНЕЦ КАК БалансоваяСтоимость,
		|	ВЫБОР
		|		КОГДА ПрочиеАктивыВЭксплуатации.КоличествоОстаток ЕСТЬ NULL ТОГДА
		|			0
		|		ИНАЧЕ
		|			(ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьУпрОстаток * &МножительКурса)/ПрочиеАктивыВЭксплуатации.КоличествоОстаток*ТабДокумента.Количество
		|	КОНЕЦ - ВЫБОР
		|			КОГДА ПрочиеАктивыВЭксплуатации.СуммаАмортизацииУпрОстаток ЕСТЬ NULL 
		|				ТОГДА 0
		|			ИНАЧЕ ПрочиеАктивыВЭксплуатации.СуммаАмортизацииУпрОстаток * &МножительКурса
		|		КОНЕЦ КАК ОстаточнаяСтоимость
		|ИЗ
		|	ТабДокумента КАК ТабДокумента
		|ЛЕВОЕ СОЕДИНЕНИЕ
		|	РегистрНакопления.ПрочиеАктивыВЭксплуатации.Остатки(
		|		&Момент,
		|		ПрочийАктив В (&СписокАктивов)
		|		И ПодразделениеКомпании = &ПодразделениеКомпании)КАК ПрочиеАктивыВЭксплуатации
		|ПО
		|	ТабДокумента.ПрочийАктив = ПрочиеАктивыВЭксплуатации.ПрочийАктив";
		Запрос.УстановитьПараметр("Момент"               , ?(ЭтоНовый(), Новый Граница(ТекущаяДата(),ВидГраницы.Исключая), МоментВремени()));
		Запрос.УстановитьПараметр("СписокАктивов"        , ТЧДокумента.ВыгрузитьКолонку("ПрочийАктив"));
		Запрос.УстановитьПараметр("ПодразделениеКомпании", ПодразделениеКомпании);
		Запрос.УстановитьПараметр("ТЧДокумента"          , ТЧДокумента);
		Если обЗначениеНеЗаполнено(ЭтотОбъект.КурсВалютыУпр) Тогда
			МножительКурса = обПересчет(1, ВалютаУправленческогоУчета, Дата , ВалютаДокумента, КурсДокумента);
		Иначе
			МножительКурса = обПересчет(1, ВалютаУправленческогоУчета, КурсВалютыУпр, ВалютаДокумента, КурсДокумента);
		КонецЕсли;
		Запрос.УстановитьПараметр("МножительКурса",МножительКурса);
	КонецЕсли;
	
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	
	//перебор строк
	ВыборкаТабличнойЧасти = Запрос.Выполнить().Выгрузить();
	Для каждого СтрокаТабличнойЧасти Из ВыборкаТабличнойЧасти Цикл
		//заполняем данные строки
		ОбластьМакета.Параметры.Заполнить(СтрокаТабличнойЧасти);
		ОбластьМакета.Параметры.ПрочийАктив			= СтрокаТабличнойЧасти.ПрочийАктив;
		ОбластьМакета.Параметры.АктивНаименование	= спПолучитьНаименование(СтрокаТабличнойЧасти.ПрочийАктив);
		ОбластьМакета.Параметры.Код					= СтрокаТабличнойЧасти.ПрочийАктив.ИнвентарныйНомер;
		ОбластьМакета.Параметры.БалансоваяСтоимость	= Формат(СтрокаТабличнойЧасти.БалансоваяСтоимость,ФорматВыводаСуммы);
		ОбластьМакета.Параметры.ОстаточнаяСтоимость	= Формат(СтрокаТабличнойЧасти.ОстаточнаяСтоимость,ФорматВыводаСуммы);
		
		//доп. области
		мсвДопОбластиПодвала = Неопределено;
		Если ВыборкаТабличнойЧасти.Индекс(СтрокаТабличнойЧасти) = ВыборкаТабличнойЧасти.Количество()-1 Тогда
			мсвДопОбластиПодвала = Новый Массив;
			мсвДопОбластиПодвала.Добавить(ОбластьПодвал);
		КонецЕсли;
		
		//выводим строку, делая проверку попадания на лист
		НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьМакета, ОбластьШапкаТаблицы, ОбластьМакетаИтогоПоСтранице,
			НомерСтраницы, СтруктураИтоговПоСтранице, ЭтотОбъект, мсвДопОбластиПодвала);
		
		//инициализация итогов по странице
		Если НомерСтраницы <> НомерСтраницыПред Тогда
			СтруктураИтоговПоСтранице = Новый Структура("ВалютаДокумента,ОстаточнаяСтоимость",ВалютаДокумента,0);
			НомерСтраницыПред = НомерСтраницы;
			ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
		КонецЕсли;
		
		//добавляем итоги
		дкДобавитьИтогиПоСтранице(СтрокаТабличнойЧасти,СтруктураИтоговПоСтранице);
	КонецЦикла;
	
	//выводим последний подвал, если страниц больше единицы
	Если НомерСтраницы > 2 Тогда
		дкВывестиИтогиПоСтранице(ТабДокумент,ОбластьМакетаИтогоПоСтранице,СтруктураИтоговПоСтранице,ЭтотОбъект);
	КонецЕсли;
	
	//итоги
	ОбластьПодвал.Параметры.ВалютаДокумента = ВалютаДокумента;
	СуммаВсего = ВыборкаТабличнойЧасти.Итог("ОстаточнаяСтоимость");
	ОбластьПодвал.Параметры.СуммаВсего = Формат(СуммаВсего,ФорматВыводаСуммы);
	ОбластьПодвал.Параметры.СуммаПрописью = "Всего наименований "+ВыборкаТабличнойЧасти.Количество()+" на сумму " + обЧислоПрописью(СуммаВсего,ЭтотОбъект.ВалютаДокумента);
	
	// Выводим представления и расшифровки подписей
	Отпустил = дкОтветственноеЛицо(ЭтотОбъект,"Отпустил");
	Отпустил.ОтпустилПредставление = ?(обЗначениеНеЗаполнено(Отпустил.Отпустил),"","/ "+ Отпустил.ОтпустилПредставление);
	ОбластьПодвал.Параметры.Заполнить(Отпустил);
	Получил  = дкОтветственноеЛицо(ЭтотОбъект,"Получил");
	Получил.ПолучилПредставление = ?(обЗначениеНеЗаполнено(Получил.Получил),"","/ "+ Получил.ПолучилПредставление);
	ОбластьПодвал.Параметры.Заполнить(Получил);
	
	НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьПодвал, , , НомерСтраницы,,ЭтотОбъект);
	
	Возврат ТабДокумент;
КонецФункции // ПечатьСписаниеАктивов()

// Формирует печатную форму "ОС-4"
// 
// Параметры:
//  ТабДокумент - табличный документ.
//
// Возвращаемое значение:
//  ТабДокумент - возвращает сформированный табличный документ.
//
Функция ПечатьОС4(ТабДокумент) Экспорт
	ТекстЗаголовка = дкПолучитьПредставление(ЭтотОбъект);
	ФорматВыводаСуммы = обПраво("ФорматВыводаСуммы",Права,,ЭтотОбъект);
	
	ТабДокумент.ОриентацияСтраницы  = ОриентацияСтраницы.Ландшафт;
	
	Если Проведен Тогда
		// возьмем данные из движений документа
		ТекстЗапроса = "ВЫБРАТЬ
		|	ПрочиеАктивыВЭксплуатации.ПрочийАктив КАК Актив,
		|	//ПрочиеАктивыВЭксплуатации.МОЛ,
		|	ПрочиеАктивыВЭксплуатации.ТипЭксплуатации,
		|	ПрочиеАктивыВЭксплуатации.БалансоваяСтоимость,
		|	ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьУпр,
		|	ПрочиеАктивыВЭксплуатации.СуммаАмортизации,
		|	ПрочиеАктивыВЭксплуатации.СуммаАмортизацииУпр
		|ИЗ
		|	Документ.СписаниеАктивов.Активы КАК СписаниеАктивовАктивы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПрочиеАктивыВЭксплуатации КАК ПрочиеАктивыВЭксплуатации
		|		ПО СписаниеАктивовАктивы.ПрочийАктив = ПрочиеАктивыВЭксплуатации.ПрочийАктив
		|ГДЕ
		|	ПрочиеАктивыВЭксплуатации.Регистратор = &Ссылка
		|	И СписаниеАктивовАктивы.Ссылка = &Ссылка";
		
		Запрос = Новый Запрос();
		Запрос.Текст = ТекстЗапроса;
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		РезЗапроса = Запрос.Выполнить();
	Иначе
		ТЧДокумента = Активы.Выгрузить();
		ТЧДокумента.Свернуть("ПрочийАктив","Количество");
		Запрос = Новый Запрос;
		Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ПрочийАктив КАК ПрочийАктив,
		|	Количество  КАК Количество
		|ПОМЕСТИТЬ
		|	ТабДокумента
		|ИЗ
		|	&ТЧДокумента КАК ТЧДокумента
		|;
		|ВЫБРАТЬ
		|	ТабДокумента.ПрочийАктив КАК Актив,
		|	ТабДокумента.Количество  КАК Количество,
		|	ЕСТЬNULL(ПрочиеАктивыВЭксплуатации.ТипЭксплуатации, ЗНАЧЕНИЕ(Справочник.ТипыЭксплуатации.ПустаяСсылка)) КАК ТипЭксплуатации,
		|	ВЫБОР
		|		КОГДА ПрочиеАктивыВЭксплуатации.КоличествоОстаток ЕСТЬ NULL ТОГДА
		|			0
		|		ИНАЧЕ
		|			(ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьУпрОстаток)/ПрочиеАктивыВЭксплуатации.КоличествоОстаток*ТабДокумента.Количество
		|	КОНЕЦ КАК БалансоваяСтоимостьУпр,
		|	ВЫБОР
		|			КОГДА ПрочиеАктивыВЭксплуатации.СуммаАмортизацииУпрОстаток ЕСТЬ NULL 
		|				ТОГДА 0
		|			ИНАЧЕ ПрочиеАктивыВЭксплуатации.СуммаАмортизацииУпрОстаток
		|		КОНЕЦ КАК СуммаАмортизацииУпр,
		|	ВЫБОР
		|		КОГДА ПрочиеАктивыВЭксплуатации.КоличествоОстаток ЕСТЬ NULL ТОГДА
		|			0
		|		ИНАЧЕ
		|			(ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьОстаток)/ПрочиеАктивыВЭксплуатации.КоличествоОстаток*ТабДокумента.Количество
		|	КОНЕЦ КАК БалансоваяСтоимость,
		|	ВЫБОР
		|			КОГДА ПрочиеАктивыВЭксплуатации.СуммаАмортизацииОстаток ЕСТЬ NULL 
		|				ТОГДА 0
		|			ИНАЧЕ ПрочиеАктивыВЭксплуатации.СуммаАмортизацииОстаток
		|		КОНЕЦ КАК СуммаАмортизации
		|ИЗ
		|	ТабДокумента КАК ТабДокумента
		|ЛЕВОЕ СОЕДИНЕНИЕ
		|	РегистрНакопления.ПрочиеАктивыВЭксплуатации.Остатки(
		|		&Момент,
		|		ПрочийАктив В (&СписокАктивов)
		|		И ПодразделениеКомпании = &ПодразделениеКомпании)КАК ПрочиеАктивыВЭксплуатации
		|ПО
		|	ТабДокумента.ПрочийАктив = ПрочиеАктивыВЭксплуатации.ПрочийАктив";
		Запрос.УстановитьПараметр("Момент"               , ?(ЭтоНовый(), Новый Граница(ТекущаяДата(),ВидГраницы.Исключая), МоментВремени()));
		Запрос.УстановитьПараметр("СписокАктивов"        , ТЧДокумента.ВыгрузитьКолонку("ПрочийАктив"));
		Запрос.УстановитьПараметр("ПодразделениеКомпании", ПодразделениеКомпании);
		Запрос.УстановитьПараметр("ТЧДокумента"          , ТЧДокумента);
		РезЗапроса=Запрос.Выполнить();
	КонецЕсли;
	
	ВыборкаАктивы = РезЗапроса.Выбрать();
	ВыборкаАктивы.Следующий();
	
	//Чтение значения для директора
	ГлавныйБухгалтер	= дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.ГлавныйБухгалтер);
	Руководитель		= дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.Руководитель);
	МОЛ					= дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.МОЛ);
	ПредседательКомиссии= дкОтветственноеЛицо(ЭтотОбъект,"ПредседательКомиссии");
	ЧленКомиссии1		= дкОтветственноеЛицо(ЭтотОбъект,"ЧленКомиссии1");
	ЧленКомиссии2		= дкОтветственноеЛицо(ЭтотОбъект,"ЧленКомиссии2");
	
	ВРегламентированнойВалюте=(ВалютаДокумента=Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить());
	ВалютаУпр = Константы.ВалютаУправленческогоУчетаКомпании.Получить();
	ВалютаРегл = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	
	Если ВыборкаАктивы.Количество() = 1 Тогда //актив один - печать ОС-1
        Макет = ПолучитьМакет("ОС4");
		
		ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
		ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
		ОбластьМакета.Параметры.Организация   = Организация;
		ОбластьМакета.Параметры.ПредставлениеОрганизации   = спПолучитьНаименование(Организация);
		ОбластьМакета.Параметры.Подразделение = ПодразделениеКомпании;
		ОбластьМакета.Параметры.ПредставлениеПодразделения = спПолучитьНаименование(ПодразделениеКомпании);
		ОбластьМакета.Параметры.Заполнить(МОЛ);
		ОбластьМакета.Параметры.КодОКПО       = Организация.КодПоОКПО;
		//ОбластьМакета.Параметры.ТабНомерМОЛ = 
		ОбластьМакета.Параметры.НомерДок      = дкПолучитьНомерДляПечати(ЭтотОбъект);
		ОбластьМакета.Параметры.ДатаДок       = Дата;
		ОбластьМакета.Параметры.Заполнить(Руководитель);
		//ОбластьМакета.Параметры.ПричинаСписания = 
		ОбластьМакета.Параметры.НаимОС         = ВыборкаАктивы.Актив;
		ОбластьМакета.Параметры.ИнвНомер       = ВыборкаАктивы.Актив.ИнвентарныйНомер;
		ОбластьМакета.Параметры.ЗаводскойНомер = ВыборкаАктивы.Актив.СерийныйНомер;
		//ОбластьМакета.Параметры.ГодВыпуска = 
		ОбластьМакета.Параметры.ПринятоКУчету  = ВыборкаАктивы.Актив.ДатаВводаВЭксплуатацию;
		ОбластьМакета.Параметры.СрокЭкспл      = ВыборкаАктивы.Актив.СрокПолезногоИспользования;
		ОбластьМакета.Параметры.НачСтоимость   = Формат(обПересчет(ВыборкаАктивы.Актив.ПервоначальнаяСтоимость, Константы.ВалютаУправленческогоУчетаКомпании.Получить(), ?(обЗначениеНеЗаполнено(ЭтотОбъект.КурсВалютыУпр), Дата, ЭтотОбъект.КурсВалютыУпр), Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить(), Дата),ФорматВыводаСуммы);
		Если ВРегламентированнойВалюте Тогда
			ОбластьМакета.Параметры.НачАмортизация = Формат(ВыборкаАктивы.СуммаАмортизации,ФорматВыводаСуммы);
			ОбластьМакета.Параметры.ОстСтоимость   = Формат(ВыборкаАктивы.БалансоваяСтоимость - ВыборкаАктивы.СуммаАмортизации,ФорматВыводаСуммы);
		Иначе
			ОбластьМакета.Параметры.НачАмортизация = Формат(обПересчет(ВыборкаАктивы.СуммаАмортизацииУпр, Константы.ВалютаУправленческогоУчетаКомпании.Получить(), ?(обЗначениеНеЗаполнено(ЭтотОбъект.КурсВалютыУпр), Дата, ЭтотОбъект.КурсВалютыУпр), Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить(), Дата),ФорматВыводаСуммы);
			ОбластьМакета.Параметры.ОстСтоимость   = Формат(обПересчет(ВыборкаАктивы.БалансоваяСтоимостьУпр - ВыборкаАктивы.СуммаАмортизацииУпр, Константы.ВалютаУправленческогоУчетаКомпании.Получить(), ?(обЗначениеНеЗаполнено(ЭтотОбъект.КурсВалютыУпр), Дата, ЭтотОбъект.КурсВалютыУпр), Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить(), Дата),ФорматВыводаСуммы);
		КонецЕсли; 
		
		ОбластьМакета.Параметры.Заполнить(ПредседательКомиссии);
		ОбластьМакета.Параметры.Заполнить(ЧленКомиссии1);
		ОбластьМакета.Параметры.Заполнить(ЧленКомиссии2);
		ОбластьМакета.Параметры.Заполнить(ГлавныйБухгалтер);
		
		ТабДокумент.Вывести(ОбластьМакета);
						
	Иначе //активов много - групповая печать (ОС-4б)
        Макет = ПолучитьМакет("ОС4б");
				
		ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
		ОбластьМакета.Параметры.Организация   = Организация;
		ОбластьМакета.Параметры.ПредставлениеОрганизации   = спПолучитьНаименование(Организация);
		ОбластьМакета.Параметры.Подразделение = ПодразделениеКомпании;
		ОбластьМакета.Параметры.ПредставлениеПодразделения = спПолучитьНаименование(ПодразделениеКомпании);
		ОбластьМакета.Параметры.Заполнить(МОЛ);
		ОбластьМакета.Параметры.КодОКПО       = Организация.КодПоОКПО;
		//ОбластьМакета.Параметры.ТабНомерМОЛ = 
		ОбластьМакета.Параметры.НомерДок      = дкПолучитьНомерДляПечати(ЭтотОбъект);
		ОбластьМакета.Параметры.ДатаДок       = Дата;
		ОбластьМакета.Параметры.Заполнить(Руководитель);
		ТабДокумент.Вывести(ОбластьМакета);

		ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("Шапка1");
		
		СтруктураИтоговПоСтранице = Новый Структура("НачСтоимость, НачАмортизация, ОстСтоимость", 0, 0, 0);
	
		//сразу два, т.к. выводим на второй странице только
		НомерСтраницы = 2;
		НомерСтраницыПред = НомерСтраницы;
		
		ТабДокумент.Вывести(ОбластьШапкаТаблицы);
		
		//заполним параметры шапки таблицы для следующего листа
		ОбластьШапкаТаблицы.Параметры.ТекстЗаголовка = ТекстЗаголовка;
		ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
		
		ОбластьИтогиПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице");
		ОбластьИтоги = Макет.ПолучитьОбласть("Итого");
		ОбластьПодвал = Макет.ПолучитьОбласть("Шапка2");
		
		//преобразуем таблицу данных
		тблВывода = РезЗапроса.Выгрузить();
		тблВывода.Колонки.Добавить("НачСтоимость");
		тблВывода.Колонки.Добавить("НачАмортизация");
		тблВывода.Колонки.Добавить("ОстСтоимость");
		Для Каждого ТекСтрока Из тблВывода Цикл
			ТекСтрока.НачСтоимость = обПересчет(ТекСтрока.Актив.ПервоначальнаяСтоимость, ВалютаУпр,
				?(обЗначениеНеЗаполнено(КурсВалютыУпр), Дата, КурсВалютыУпр), ВалютаРегл, Дата);
				
			Если ВРегламентированнойВалюте Тогда	
				ТекСтрока.НачАмортизация = ТекСтрока.СуммаАмортизации;
				ТекСтрока.ОстСтоимость = ТекСтрока.БалансоваяСтоимость - ТекСтрока.СуммаАмортизации
			Иначе
				ТекСтрока.НачАмортизация = обПересчет(ТекСтрока.СуммаАмортизацииУпр, ВалютаУпр,
					?(обЗначениеНеЗаполнено(КурсВалютыУпр), Дата, КурсВалютыУпр), ВалютаРегл, Дата);
				ТекСтрока.ОстСтоимость = обПересчет(ТекСтрока.БалансоваяСтоимостьУпр - ТекСтрока.СуммаАмортизацииУпр,
					ВалютаУпр, ?(обЗначениеНеЗаполнено(КурсВалютыУпр), Дата, КурсВалютыУпр),
					ВалютаРегл, Дата);
			КонецЕсли;
		КонецЦикла;
		
		ОбластьМакета = Макет.ПолучитьОбласть("Строка1");
		Нп = 1;
		Для Каждого ТекСтрока Из тблВывода Цикл
			ОбластьМакета.Параметры.Нп             = Нп;
			ОбластьМакета.Параметры.НаимОС         = ТекСтрока.Актив;
			ОбластьМакета.Параметры.ИнвНомер       = ТекСтрока.Актив.ИнвентарныйНомер;
			ОбластьМакета.Параметры.СрокЭкспл      = ТекСтрока.Актив.СрокПолезногоИспользования;
			
			ОбластьМакета.Параметры.НачСтоимость 		= Формат(ТекСтрока.НачСтоимость,ФорматВыводаСуммы);
			ОбластьМакета.Параметры.НачАмортизация 		= Формат(ТекСтрока.НачАмортизация,ФорматВыводаСуммы);
			ОбластьМакета.Параметры.ОстСтоимость 		= Формат(ТекСтрока.ОстСтоимость,ФорматВыводаСуммы);
			
			//доп. области
			мсвДопОбластиПодвала = Неопределено;
			Если Нп = тблВывода.Количество() Тогда
				мсвДопОбластиПодвала = Новый Массив;
				мсвДопОбластиПодвала.Добавить(ОбластьИтоги);
			КонецЕсли;
			
			//выводим строку, делая проверку попадания на лист
			НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьМакета, ОбластьШапкаТаблицы, ОбластьИтогиПоСтранице,
				НомерСтраницы, СтруктураИтоговПоСтранице, ЭтотОбъект, мсвДопОбластиПодвала);
			
			//инициализация итогов по странице
			Если НомерСтраницы <> НомерСтраницыПред Тогда
				СтруктураИтоговПоСтранице = Новый Структура("НачСтоимость, НачАмортизация, ОстСтоимость", 0, 0, 0);
				НомерСтраницыПред = НомерСтраницы;
				ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
			КонецЕсли;
			//добавляем итоги
			дкДобавитьИтогиПоСтранице(ТекСтрока, СтруктураИтоговПоСтранице);
		
			Нп = Нп + 1;
		КонецЦикла;
		
		//выводим последний подвал, если страниц больше единицы
		Если НомерСтраницы > 2 Тогда
			дкВывестиИтогиПоСтранице(ТабДокумент, ОбластьИтогиПоСтранице, СтруктураИтоговПоСтранице, ЭтотОбъект);
		КонецЕсли;
			
		// Выводим итоги по документу в целом
		ОбластьИтоги.Параметры.НачСтоимость = Формат(тблВывода.Итог("НачСтоимость"), ФорматВыводаСуммы);
		ОбластьИтоги.Параметры.НачАмортизация = Формат(тблВывода.Итог("НачАмортизация"), ФорматВыводаСуммы);
		ОбластьИтоги.Параметры.ОстСтоимость = Формат(тблВывода.Итог("ОстСтоимость"), ФорматВыводаСуммы);
		ТабДокумент.Вывести(ОбластьИтоги);
		
		ОбластьПодвал.Параметры.Заполнить(ПредседательКомиссии);
		ОбластьПодвал.Параметры.Заполнить(ЧленКомиссии1);
		ОбластьПодвал.Параметры.Заполнить(ЧленКомиссии2);
		ОбластьПодвал.Параметры.Заполнить(ГлавныйБухгалтер);
		ТабДокумент.Вывести(ОбластьПодвал);
	КонецЕсли;
	
	Возврат ТабДокумент;		
КонецФункции // ПечатьОС4()

// Формирует печатную форму "МБ-4"
// 
// Параметры:
//  ТабДокумент - табличный документ.
//
// Возвращаемое значение:
//  ТабДокумент - возвращает сформированный табличный документ.
//
Функция ПечатьМБ4(ТабДокумент) Экспорт
	ТекстЗаголовка = дкПолучитьПредставление(ЭтотОбъект);
	
	ФорматВыводаСуммы = обПраво("ФорматВыводаСуммы",Права,,ЭтотОбъект);
	ФорматВыводаКоличества = обПраво("ФорматВыводаКоличества",Права,,ЭтотОбъект);
	
	ТабДокумент.ОриентацияСтраницы  = ОриентацияСтраницы.Ландшафт;
	
	Если Проведен Тогда
		//если проведен возьмем данные из движений документа
		ТекстЗапроса = "ВЫБРАТЬ
		|	ПрочиеАктивыВЭксплуатации.ПрочийАктив КАК Актив,
		|	ПрочиеАктивыВЭксплуатации.МОЛ,
		|	ПрочиеАктивыВЭксплуатации.ТипЭксплуатации,
		|	ПрочиеАктивыВЭксплуатации.БалансоваяСтоимость,
		|	ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьУпр,
		|	ПрочиеАктивыВЭксплуатации.СуммаАмортизации,
		|	ПрочиеАктивыВЭксплуатации.СуммаАмортизацииУпр,
		|	ПрочиеАктивыВЭксплуатации.ПрочийАктив.Номенклатура.СтавкаНДС.Ставка КАК Ставка,
		|	ПрочиеАктивыВЭксплуатации.ПрочийАктив.ИнвентарныйНомер КАК ИнвентарныйНомер,
		|	ПрочиеАктивыВЭксплуатации.ПрочийАктив.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК БазоваяЕдиницаИзмеренияКод,
		|	ПрочиеАктивыВЭксплуатации.ПрочийАктив.Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаИзмеренияНаименование
		|ИЗ
		|	Документ.СписаниеАктивов.Активы КАК СписаниеАктивовАктивы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПрочиеАктивыВЭксплуатации КАК ПрочиеАктивыВЭксплуатации
		|		ПО СписаниеАктивовАктивы.ПрочийАктив = ПрочиеАктивыВЭксплуатации.ПрочийАктив
		|ГДЕ
		|	ПрочиеАктивыВЭксплуатации.Регистратор = &Ссылка
		|	И СписаниеАктивовАктивы.Ссылка = &Ссылка";
		Запрос = Новый Запрос();
		Запрос.Текст = ТекстЗапроса;
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		РезЗапроса =  Запрос.Выполнить();
	Иначе
		// найдем значения сами
		ТЧДокумента = Активы.Выгрузить();
		ТЧДокумента.Свернуть("ПрочийАктив","Количество");
		Запрос = Новый Запрос;
		Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ПрочийАктив КАК ПрочийАктив,
		|	Количество  КАК Количество
		|ПОМЕСТИТЬ
		|	ТабДокумента
		|ИЗ
		|	&ТЧДокумента КАК ТЧДокумента
		|;
		|ВЫБРАТЬ
		|	ТабДокумента.ПрочийАктив КАК Актив,
		|	ТабДокумента.ПрочийАктив.Номенклатура.СтавкаНДС.Ставка КАК Ставка,
		|	ТабДокумента.ПрочийАктив.ИнвентарныйНомер КАК ИнвентарныйНомер,
		|	ТабДокумента.ПрочийАктив.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК БазоваяЕдиницаИзмеренияКод,
		|	ТабДокумента.ПрочийАктив.Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаИзмеренияНаименование,
		|	ТабДокумента.Количество  КАК Количество,
		|	ЕСТЬNULL(ПрочиеАктивыВЭксплуатации.ТипЭксплуатации, ЗНАЧЕНИЕ(Справочник.ТипыЭксплуатации.ПустаяСсылка)) КАК ТипЭксплуатации,
		|	ЕСТЬNULL(ПрочиеАктивыВЭксплуатации.МОЛ, ЗНАЧЕНИЕ(Справочник.Сотрудники.ПустаяСсылка)) КАК МОЛ,
		|	ВЫБОР
		|		КОГДА ПрочиеАктивыВЭксплуатации.КоличествоОстаток ЕСТЬ NULL ТОГДА
		|			0
		|		ИНАЧЕ
		|			(ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьУпрОстаток)/ПрочиеАктивыВЭксплуатации.КоличествоОстаток*ТабДокумента.Количество
		|	КОНЕЦ КАК БалансоваяСтоимостьУпр,
		|	ВЫБОР
		|			КОГДА ПрочиеАктивыВЭксплуатации.СуммаАмортизацииУпрОстаток ЕСТЬ NULL 
		|				ТОГДА 0
		|			ИНАЧЕ ПрочиеАктивыВЭксплуатации.СуммаАмортизацииУпрОстаток
		|		КОНЕЦ КАК СуммаАмортизацииУпр,
		|	ВЫБОР
		|		КОГДА ПрочиеАктивыВЭксплуатации.КоличествоОстаток ЕСТЬ NULL ТОГДА
		|			0
		|		ИНАЧЕ
		|			(ПрочиеАктивыВЭксплуатации.БалансоваяСтоимостьОстаток)/ПрочиеАктивыВЭксплуатации.КоличествоОстаток*ТабДокумента.Количество
		|	КОНЕЦ КАК БалансоваяСтоимость,
		|	ВЫБОР
		|			КОГДА ПрочиеАктивыВЭксплуатации.СуммаАмортизацииОстаток ЕСТЬ NULL 
		|				ТОГДА 0
		|			ИНАЧЕ ПрочиеАктивыВЭксплуатации.СуммаАмортизацииОстаток
		|		КОНЕЦ КАК СуммаАмортизации
		|ИЗ
		|	ТабДокумента КАК ТабДокумента
		|ЛЕВОЕ СОЕДИНЕНИЕ
		|	РегистрНакопления.ПрочиеАктивыВЭксплуатации.Остатки(
		|		&Момент,
		|		ПрочийАктив В (&СписокАктивов)
		|		И ПодразделениеКомпании = &ПодразделениеКомпании)КАК ПрочиеАктивыВЭксплуатации
		|ПО
		|	ТабДокумента.ПрочийАктив = ПрочиеАктивыВЭксплуатации.ПрочийАктив";
		Запрос.УстановитьПараметр("Момент"               , ?(ЭтоНовый(), Новый Граница(ТекущаяДата(),ВидГраницы.Исключая), МоментВремени()));
		Запрос.УстановитьПараметр("СписокАктивов"        , ТЧДокумента.ВыгрузитьКолонку("ПрочийАктив"));
		Запрос.УстановитьПараметр("ПодразделениеКомпании", ПодразделениеКомпании);
		Запрос.УстановитьПараметр("ТЧДокумента"          , ТЧДокумента);
		РезЗапроса=Запрос.Выполнить();
	КонецЕсли;
	ВыборкаАктивы = РезЗапроса.Выбрать();
	ВыборкаАктивы.Следующий();
	
	//Чтение значения для директора
		
	//Запоминаем кладовщика
	МОЛ = ВыборкаАктивы.МОЛ;
	
	//Заполнение макета
	Макет = ПолучитьМакет("МБ4");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
	ОбластьМакета.Параметры.НомерДок						= дкПолучитьНомерДляПечати(ЭтотОбъект);
	ОбластьМакета.Параметры.Организация						= Организация;
	ОбластьМакета.Параметры.ОрганизацияПредставление		= спПолучитьНаименование(Организация);
	ОбластьМакета.Параметры.ПодразделениеКомпании			= ПодразделениеКомпании;
	ОбластьМакета.Параметры.Подразделение					= спПолучитьНаименование(ПодразделениеКомпании);
	ОбластьМакета.Параметры.КодОКПО							= Организация.КодПоОКПО;
	ОбластьМакета.Параметры.ДатаДок							= Дата;
	//КодВидаОперации
	//ВидДеятельности
	//Счет
	//КодУчета
	//УчетнаяЕдиница
	ТабДокумент.Вывести(ОбластьМакета);
	
	ВРегламентированнойВалюте = (ВалютаДокумента = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить());
	ВалютаУпр = Константы.ВалютаУправленческогоУчетаКомпании.Получить();
	ВалютаРегл = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	
	ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьМакета = Макет.ПолучитьОбласть("СтрокаТаблицы");
	ОбластьИтогиПоСтранице = Макет.ПолучитьОбласть("ПодвалТаблицы");
	ОбластьИтоги = Макет.ПолучитьОбласть("ПодвалОбщиеИтоги");
	ОбластьИтогиПричиныВыбытия = Макет.ПолучитьОбласть("ТаблицаПричинаВыбытия");
	ОбластьИтогиМастер = Макет.ПолучитьОбласть("ТаблицаМастер");
	
	СтруктураИтоговПоСтранице = Новый Структура("НачАмортизация, ОстСтоимость", 0, 0);
	
	//сразу два, т.к. выводим на второй странице только
	НомерСтраницы = 2;
	НомерСтраницыПред = НомерСтраницы;
	
	ОбластьШапкаТаблицы.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	ТабДокумент.Вывести(ОбластьШапкаТаблицы);
	
	//заполним параметры шапки таблицы для следующего листа
	ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
	
	//преобразуем таблицу данных
	тблВывода = РезЗапроса.Выгрузить();
	тблВывода.Колонки.Добавить("НачАмортизация");
	тблВывода.Колонки.Добавить("ОстСтоимость");
	Для Каждого ТекСтрока Из тблВывода Цикл
		Если ВРегламентированнойВалюте Тогда	
			ТекСтрока.НачАмортизация = ТекСтрока.СуммаАмортизации;
			ТекСтрока.ОстСтоимость = ТекСтрока.БалансоваяСтоимость - ТекСтрока.СуммаАмортизации;
		Иначе
			ТекСтрока.НачАмортизация = обПересчет(ТекСтрока.СуммаАмортизацииУпр, ВалютаУпр,
				?(обЗначениеНеЗаполнено(КурсВалютыУпр), Дата, КурсВалютыУпр), ВалютаРегл, Дата);
			ТекСтрока.ОстСтоимость = обПересчет(ТекСтрока.БалансоваяСтоимостьУпр - ТекСтрока.СуммаАмортизацииУпр,
				ВалютаУпр, ?(обЗначениеНеЗаполнено(КурсВалютыУпр), Дата, КурсВалютыУпр),
				ВалютаРегл, Дата);
		КонецЕсли;
	КонецЦикла;
	
	Нп = 1;
	Для Каждого ТекСтрока Из тблВывода Цикл
		ОбластьМакета.Параметры.НаимОС = ТекСтрока.Актив;
		ОбластьМакета.Параметры.ИнвНомер = ТекСтрока.ИнвентарныйНомер;
		ОбластьМакета.Параметры.ЕдиницаИзмеренияКод = ТекСтрока.БазоваяЕдиницаИзмеренияКод;
		ОбластьМакета.Параметры.ЕдиницаИзмеренияНаименование = ТекСтрока.БазоваяЕдиницаИзмеренияНаименование;
		ОбластьМакета.Параметры.Количество = Формат(1,ФорматВыводаКоличества);
		//ВыборкаАктивы.Актив.ПервоначальнаяСтоимость
		//ПричинаКод                                         
		//ПричинаНаименование
		ОбластьМакета.Параметры.НачАмортизация = Формат(ТекСтрока.НачАмортизация,ФорматВыводаСуммы);
		ОбластьМакета.Параметры.ОстСтоимость = Формат(ТекСтрока.ОстСтоимость,ФорматВыводаСуммы);
		
		//доп. области
		мсвДопОбластиПодвала = Неопределено;
		Если Нп = тблВывода.Количество() Тогда
			мсвДопОбластиПодвала = Новый Массив;
			мсвДопОбластиПодвала.Добавить(ОбластьИтоги);
			мсвДопОбластиПодвала.Добавить(ОбластьИтогиПричиныВыбытия);
			мсвДопОбластиПодвала.Добавить(ОбластьИтогиМастер);
		КонецЕсли;
		
		//выводим строку, делая проверку попадания на лист
		НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьМакета, ОбластьШапкаТаблицы, ОбластьИтогиПоСтранице,
			НомерСтраницы, СтруктураИтоговПоСтранице, ЭтотОбъект, мсвДопОбластиПодвала);
		
		//инициализация итогов по странице
		Если НомерСтраницы <> НомерСтраницыПред Тогда
			СтруктураИтоговПоСтранице = Новый Структура("НачАмортизация, ОстСтоимость", 0, 0);
			НомерСтраницыПред = НомерСтраницы;
			ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
		КонецЕсли;
		
		//добавляем итоги
		дкДобавитьИтогиПоСтранице(ТекСтрока, СтруктураИтоговПоСтранице);
		
		Нп = Нп + 1;
	КонецЦикла;
	
	//выводим последний подвал, если страниц больше единицы
	Если НомерСтраницы > 2 Тогда
		дкВывестиИтогиПоСтранице(ТабДокумент, ОбластьИтогиПоСтранице, СтруктураИтоговПоСтранице, ЭтотОбъект);
	КонецЕсли;
	
	// Выводим итоги по документу в целом
	ОбластьИтоги.Параметры.НачАмортизация = Формат(тблВывода.Итог("НачАмортизация"), ФорматВыводаСуммы);
	ОбластьИтоги.Параметры.ОстСтоимость = Формат(тблВывода.Итог("ОстСтоимость"), ФорматВыводаСуммы);
	ТабДокумент.Вывести(ОбластьИтоги);
	
	ОбластьИтогиПричиныВыбытия.Параметры.Заполнить(ЭтотОбъект);
	ТабДокумент.Вывести(ОбластьИтогиПричиныВыбытия);
	
	Мастер = дкОтветственноеЛицо(ЭтотОбъект, "Мастер");
	ОбластьИтогиМастер.Параметры.Заполнить(Мастер);
	ТабДокумент.Вывести(ОбластьИтогиМастер);
	
	//Оборотная сторона
	ТабДокумент.ВывестиГоризонтальныйРазделительСтраниц();
	
	ОбластьМакета = Макет.ПолучитьОбласть("ШапкаВиновник");
	ТабДокумент.Вывести(ОбластьМакета);
	
	ОбластьМакета = Макет.ПолучитьОбласть("СтрокаВиновник");
	//ФИО
	//ТабельныйНомер
	//ДатаВыдачи
	//ПроцентАмортизации
	//ОстаточнаяСтоимость
	//РазмерУдержания
	//СуммаУдержания
	//СуммаЕжемесячногоВзноса
	ТабДокумент.Вывести(ОбластьМакета);
	
	ОбластьМакета = Макет.ПолучитьОбласть("ПодвалВиновник");
	ТабДокумент.Вывести(ОбластьМакета);
	
	ОбластьМакета = Макет.ПолучитьОбласть("ТаблицаРуководитель");
	
	Руководитель = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.Руководитель);
	ГлавныйБухгалтер = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.ГлавныйБухгалтер);
	МОЛ = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.МОЛ);
	ОбластьМакета.Параметры.Заполнить(Руководитель);
	ОбластьМакета.Параметры.Заполнить(ГлавныйБухгалтер);
	ОбластьМакета.Параметры.Заполнить(МОЛ);
	
	ТабДокумент.Вывести(ОбластьМакета);
	
	ОбластьМакета = Макет.ПолучитьОбласть("Дата");
	ТабДокумент.Вывести(ОбластьМакета);
	
	Возврат ТабДокумент;		
КонецФункции // ПечатьОС4()

// Функция осуществляет печать произвольного документа.
// Можно направить печать на экран или принтер, а также распечатать необходимое количество копий.
//
// Параметры:
//	ЭтотОбъект							- ДокументОбъект	- Документ для печати
//	НазваниеПечатнойФормы 				- Строка			- Название печатной формы, если пусто, то по умолчанию
//	КоличествоЭкземпляров				- Число				- Количество экземпляров документа
//	НаПринтер							- Булево			- Признак отправки документа на принтер без отображения его на экране
//  Документ 	  						- ТабличныйДокумент	- Макет печатной формы
//
// Возвращаемое значение:
//   ТабличныйДокумент	- Сформированная печатная форма
//
Функция Печать(НазваниеПечатнойФормы="", КоличествоЭкземпляров=0, НаПринтер=Ложь, Документ=Неопределено) Экспорт
	Возврат дкПечать(ЭтотОбъект, НазваниеПечатнойФормы, КоличествоЭкземпляров, НаПринтер, Документ);
КонецФункции // Печать()

#КонецЕсли
// Если Клиент Тогда - завершена клиентская часть


////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ПриУстановкеНовогоНомера(СтандартнаяОбработка, Префикс)
	Если НЕ дкПриУстановкеНовогоНомера(ЭтотОбъект, СтандартнаяОбработка, Префикс) Тогда Возврат; КонецЕсли;
КонецПроцедуры // ПриУстановкеНовогоНомера()

// Процедура - обработчик ввода на основании
Процедура ОбработкаЗаполнения(Основание)
	Если НЕ дкОбработкаЗаполнения(ЭтотОбъект, Основание) Тогда Возврат; КонецЕсли;
	
	// заполним статью доходов и расходов
	СтатьяДоходовИРасходов=Справочники.СтатьиДоходовИРасходов.СписаниеАктивов;
КонецПроцедуры // ОбработкаЗаполнения()

Процедура ПриКопировании(ОбъектКопирования)
	Если НЕ дкПриКопировании(ЭтотОбъект, ОбъектКопирования) Тогда Возврат; КонецЕсли;
	
	// Заполним статью доходов и расходов
	СтатьяДоходовИРасходов=ОбъектКопирования.СтатьяДоходовИРасходов;
КонецПроцедуры // ПриКопировании()

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Результат = Истина;
	Если Не ФлагПерерасчет Тогда
		Результат = дкПередЗаписью(ЭтотОбъект, Отказ, РежимЗаписи, РежимПроведения);
	КонецЕсли;
	ФлагПерерасчет = Ложь;
	Если НЕ Результат Тогда Возврат; КонецЕсли; 
КонецПроцедуры // ПередЗаписью()

Процедура ПриЗаписи(Отказ)
	Если НЕ дкПриЗаписи(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
КонецПроцедуры // ПриЗаписи()

Процедура ПередУдалением(Отказ)
	Если НЕ дкПередУдалением(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
КонецПроцедуры // ПередУдалением()

Процедура ОбработкаУдаленияПроведения(Отказ)
	Если НЕ дкОбработкаУдаленияПроведения(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
	Если Не Отказ Тогда
		тКэшСуммСписания = Неопределено;
		СуммаДокумента = 0;
	КонецЕсли;	
КонецПроцедуры // ОбработкаУдаленияПроведения()

Процедура ОбработкаПроведения(Отказ, Режим)
	Если НЕ дкОбработкаПроведения(ЭтотОбъект, Отказ, Режим) Тогда Возврат; КонецЕсли;
	
	РезультатЗапросаПоАктивам = ПолучитьРезультатЗапросаПоАктивам();
	
	// спишем из "Активы в эксплуатации"
	НаборЗаписейЭксплуатация = Движения.ПрочиеАктивыВЭксплуатации;
	НаборЗаписейЭксплуатация.ДокументОбъект            = ЭтотОбъект;
	НаборЗаписейЭксплуатация.ПодразделениеКомпании     = ПодразделениеКомпании;
	НаборЗаписейЭксплуатация.ЭтоВыбытие                = Истина;
	НаборЗаписейЭксплуатация.РезультатЗапросаПоАктивам = РезультатЗапросаПоАктивам;
	Отказ = НЕ НаборЗаписейЭксплуатация.Расход() ИЛИ Отказ;
			
	
	// 2) Проведем по ТестДрайву
	НаборЗаписейТестДрайв = Движения.АвтомобилиДляТестДрайва;
	НаборЗаписейТестДрайв.ДокументОбъект = ЭтотОбъект;
	НаборЗаписейТестДрайв.ПодразделениеКомпании = ПодразделениеКомпании;
	НаборЗаписейТестДрайв.РезультатЗапросаПоАвтомобилям = НаборЗаписейЭксплуатация.Выгрузить();
	НаборЗаписейТестДрайв.Расход();

	// Доходы и расходы
	ИтогРасходПоСписаннымАктивам = НаборЗаписейЭксплуатация.Итог("БалансоваяСтоимостьУпр") - НаборЗаписейЭксплуатация.Итог("СуммаАмортизацииУпр");
	Если Окр(обМод(ИтогРасходПоСписаннымАктивам), 2, РежимОкругления.Окр15как20) >= 0.01 Тогда
		НаборЗаписейДиР = Движения.ДоходыИРасходы;
		НаборЗаписейДиР.ДокументОбъект         = ЭтотОбъект;
		НаборЗаписейДиР.СтатьяДоходовИРасходов = ?(обЗначениеНеЗаполнено(СтатьяДоходовИРасходов),Справочники.СтатьиДоходовИРасходов.СписаниеАктивов,СтатьяДоходовИРасходов);
		НаборЗаписейДиР.Подразделение		   = ПодразделениеКомпании;
		НаборЗаписейДиР.ВУпрВалюте             = Истина;
		НаборЗаписейДиР.Расход                 = ИтогРасходПоСписаннымАктивам;
		Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;
	КонецЕсли;
	
	Если Не Отказ Тогда
		тКэшСуммСписания = Неопределено;
		СуммаДокумента = РассчитатьСуммуВсего();
		ФлагПерерасчет = Истина;
		Записать();
	КонецЕсли;
	
	// Возможно расхождение баланса на "копейки" из-за округления. Возникшую разницу
	// необходимо списать на доходы и расходы.
	Отказ = НЕ дкСписаниеКопейкиПриОкругленииВалютныхСчетов(ЭтотОбъект) ИЛИ Отказ;
	
	// выведем сообщения об ошибках и предупреждениях
	дкВыводРезультатовОбработки(ЭтотОбъект,Отказ);
КонецПроцедуры // ОбработкаПроведения()


////////////////////////////////////////////////////////////////////////////////
// ИСПОЛНЯЕМАЯ ЧАСТЬ МОДУЛЯ

// сохранение ссылки на коллекцию прав, настроек и окружения
Права = Неопределено;
#Если Клиент Тогда
Права = глПрава;
#КонецЕсли
// инициализация кэша валюты и курса документа
ВалютаКурсДок = Новый Структура("Валюта, Курс", ВалютаДокумента, КурсДокумента);
ФлагПерерасчет = Ложь;