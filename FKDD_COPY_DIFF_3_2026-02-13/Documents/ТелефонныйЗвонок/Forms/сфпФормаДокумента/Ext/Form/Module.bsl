
#Область СлужебныеПроцедурыИФункции

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ.

// В этой конфигурации CoMagic не используется

//&НаСервере
//// Процедура пытается найти контакт по ID CoMagic и заполнить в Событии.
////
//// Параметры:
////	Нет.
////
//Процедура сфпЗаполнитьПартнераИКонтактноеЛицоИзCoMagic()
//	Контакт = сфпСофтФонПроСервер.сфпНайтиКонтактПоIDИзCoMagic(сфпСтруктураВнешнихДанных.comagic_context.visitor_id);
//	Если ЗначениеЗаполнено(Контакт) Тогда
//		Объект.АбонентКонтакт = Контакт.Ссылка;
//	КонецЕсли;
//КонецПроцедуры // сфпЗаполнитьПартнераИКонтактноеЛицоИзCoMagic()	

&НаСервере
// Процедура заполняет таблицу истории звонка.
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьИсториюЗвонка()
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Звонок", Объект.Ссылка);
	Запрос.Текст = "ВЫБРАТЬ
	               |	РегистрСведенийсфпИсторияЗвонков.ДатаНачала КАК ДатаНачала,
	               |	РегистрСведенийсфпИсторияЗвонков.ДатаОтвета,
	               |	РегистрСведенийсфпИсторияЗвонков.ВнутреннийНомер,
	               |	ВЫБОР
	               |		КОГДА РегистрСведенийсфпИсторияЗвонков.ДатаОтвета = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	               |			ТОГДА ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(РегистрСведенийсфпИсторияЗвонков.ДатаНачала, ДЕНЬ), СЕКУНДА, РАЗНОСТЬДАТ(РегистрСведенийсфпИсторияЗвонков.ДатаНачала, РегистрСведенийсфпИсторияЗвонков.ДатаОкончания, СЕКУНДА))
	               |		ИНАЧЕ ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(РегистрСведенийсфпИсторияЗвонков.ДатаНачала, ДЕНЬ), СЕКУНДА, РАЗНОСТЬДАТ(РегистрСведенийсфпИсторияЗвонков.ДатаОтвета, РегистрСведенийсфпИсторияЗвонков.ДатаОкончания, СЕКУНДА))
	               |	КОНЕЦ КАК Длительность,
	               |	РегистрСведенийсфпИсторияЗвонков.ИдентификаторЗаписи,
	               |	РегистрСведенийсфпИсторияЗвонков.Ответственный,
	               |	РегистрСведенийсфпИсторияЗвонков.Входящий,
	               |	РегистрСведенийсфпИсторияЗвонков.ДатаОкончания,
	               |	РегистрСведенийсфпИсторияЗвонков.НомерТелефона,
	               |	РегистрСведенийсфпИсторияЗвонков.Звонок,
	               |	РегистрСведенийсфпИсторияЗвонков.ИдентификаторЗвонка
	               |ИЗ
	               |	РегистрСведений.сфпИсторияЗвонков КАК РегистрСведенийсфпИсторияЗвонков
	               |ГДЕ
	               |	РегистрСведенийсфпИсторияЗвонков.Звонок = &Звонок
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ДатаНачала";
	сфпИсторияЗвонка.Очистить();
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = сфпИсторияЗвонка.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	КонецЦикла;
	КоличествоЗвонковИстории = сфпИсторияЗвонка.Количество();
	Если КоличествоЗвонковИстории = 2 Тогда
		ТекЗвонок = сфпИсторияЗвонка[КоличествоЗвонковИстории-2].Звонок;
		Если ТекЗвонок.сфпСостояниеЗвонка = Перечисления.сфпСостоянияЗвонков.Пропущенный Тогда
			ТекЗвонок = сфпИсторияЗвонка[КоличествоЗвонковИстории-1].Звонок;
			Если ТекЗвонок.сфпСостояниеЗвонка = Перечисления.сфпСостоянияЗвонков.Пропущенный 
			И НЕ Объект.сфпСостояниеЗвонка = Перечисления.сфпСостоянияЗвонков.Пропущенный Тогда
				Объект.сфпСостояниеЗвонка = Перечисления.сфпСостоянияЗвонков.Пропущенный;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры // ЗаполнитьИсториюЗвонка()

&НаКлиенте
// Процедура заполняет значения реквизитов истории звонка.
//
// Параметры:
//	Нет.
//
Процедура УстановитьДоступностьРеквизитовЗвонка()
	Элементы.ПредыдущаяЗапись.Доступность	= Ложь;
	Элементы.СледущаяЗапись.Доступность		= Ложь;
	Элементы.ОписаниеЗвонка.Гиперссылка		= Ложь;
	КоличествоСтрок = сфпИсторияЗвонка.Количество();
	Если КоличествоСтрок > 0 Тогда
		Если КоличествоСтрок > 1 Тогда
			Элементы.ОписаниеЗвонка.Гиперссылка = Истина;
		КонецЕсли;	
		Если сфпНомерСтроки > 0 Тогда
			Элементы.ПредыдущаяЗапись.Доступность = Истина;
		КонецЕсли;
		Если сфпНомерСтроки < КоличествоСтрок - 1 Тогда
			Элементы.СледущаяЗапись.Доступность	= Истина;
		КонецЕсли;
		Элементы.ОписаниеЗвонка.Заголовок = Нстр("ru='Разговор ('") + Строка(сфпНомерСтроки + 1) + Нстр("ru=' из '") + Строка(КоличествоСтрок) + ") ";
		Если ПустаяСтрока(сфпИсторияЗвонка[сфпНомерСтроки].ИдентификаторЗаписи) Тогда
			Если сфпСофтФонПроСервер.сфпИспользоватьCLON() Тогда
				Элементы.ПрослушатьЗаписьРазговора.Видимость = Истина;
			Иначе	
				Элементы.ПрослушатьЗаписьРазговора.Видимость = Ложь;
			КонецЕсли;	
		Иначе
			Элементы.ПрослушатьЗаписьРазговора.Видимость = Истина;
		КонецЕсли;	
	КонецЕсли;
КонецПроцедуры // УстановитьДоступностьРеквизитовЗвонка()

&НаКлиенте
// Процедура заполняет значения реквизитов истории звонка.
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьЗначенияРеквизитовЗвонка()
	КоличествоСтрок = сфпИсторияЗвонка.Количество();
	Если (КоличествоСтрок > 0) И (сфпНомерСтроки < КоличествоСтрок) Тогда
		сфпОтветственный		= сфпИсторияЗвонка[сфпНомерСтроки].Ответственный;
		сфпЛиния				= сфпИсторияЗвонка[сфпНомерСтроки].ВнутреннийНомер;
		сфпДатаОтвета			= сфпИсторияЗвонка[сфпНомерСтроки].ДатаОтвета;
		сфпДлительностьЗвонка	= сфпИсторияЗвонка[сфпНомерСтроки].Длительность;
		Если (КоличествоСтрок = 1) И (сфпДлительностьЗвонка = Дата('00010101')) Тогда
			сфпДлительностьЗвонка	= сфпДлительность;
		КонецЕсли;	
	КонецЕсли;	
КонецПроцедуры // ЗаполнитьЗначенияРеквизитовЗвонка()

&НаКлиенте
// Процедура - обработчик выбора разговора из меню.
//
// Параметры:
//	ВыбранныйЭлемент		- ЭлементСпискаЗначений	- Выбранный разговор.
//	ДополнительныеПараметры	- Структура				- Структура дополнительных параметров.
//
Процедура ОбработкаВыбораРазговора(ВыбранныйЭлемент, ДополнительныеПараметры) Экспорт
	Если ВыбранныйЭлемент = Неопределено Тогда Возврат; КонецЕсли;
	сфпНомерСтроки	= ВыбранныйЭлемент.Значение;	
	ЗаполнитьЗначенияРеквизитовЗвонка();
	УстановитьДоступностьРеквизитовЗвонка();
КонецПроцедуры // ОбработкаВыбораРазговора()	

&НаСервере
// Процедура управляет видимостью кнопок "Создать Партнера" и "Добавить телефон"
//
Процедура сфпУправлениеВидомостьюКнопокДобавления()
	Если НЕ ЗначениеЗаполнено(Объект.АбонентКонтакт) Тогда
		Элементы.СоздатьКонтакт.Видимость = Истина;
	Иначе
		Элементы.СоздатьКонтакт.Видимость = Ложь;
	КонецЕсли;		
	Элементы.ДобавитьТелефон.Видимость = сфпСофтФонПроСервер.сфпПроверитьНаличиеНомераТелефонаУАбонента(Объект.АбонентКонтакт, Объект.АбонентКакСвязаться);
КонецПроцедуры

&НаСервере
Процедура сфпРазрешеныИзмененияВДокументе()
	ТекПользователь = сфпСофтФонПроСервер.сфпТекущийПользователь();
	Если ТекПользователь <> Объект.Ответственный И Не (РольДоступна("ПолныеПрава") ИЛИ РольДоступна("сфпУправлениеМаршрутизацией")) Тогда
		ТолькоПросмотр = Истина;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ФОРМЫ.

&НаКлиенте
// Процедура - обработчик события "Нажатие" элемента формы "ОписаниеЗвонка".
//
Процедура ОписаниеЗвонкаНажатие(Элемент)
	СписокРазговоров = Новый СписокЗначений;
	текНомерСтроки = 0;
	Для Каждого СтрокаЗвонка Из сфпИсторияЗвонка Цикл
		ОписаниеРазговора = Строка(текНомерСтроки + 1) + ". " + Строка(СтрокаЗвонка.Ответственный) 
		+ " (" + Строка(СтрокаЗвонка.ВнутреннийНомер) + "): " 
		+ Формат(СтрокаЗвонка.Длительность, "ДЛФ=T; ДП=0:00:00");
		Если ПустаяСтрока(СтрокаЗвонка.ИдентификаторЗаписи) Тогда
			Если сфпСофтФонПроСервер.сфпИспользоватьCLON() Тогда
				СписокРазговоров.Добавить(текНомерСтроки, ОписаниеРазговора, , БиблиотекаКартинок.ЖурналРегистрации);
			Иначе	
				СписокРазговоров.Добавить(текНомерСтроки, ОписаниеРазговора);
			КонецЕсли;	
		Иначе
			СписокРазговоров.Добавить(текНомерСтроки, ОписаниеРазговора, , БиблиотекаКартинок.ЖурналРегистрации);
		КонецЕсли;	
	КонецЦикла;	
	ВыбранныйЭлемент = ВыбратьИзМеню(СписокРазговоров, Элемент);
	Если ВыбранныйЭлемент = Неопределено Тогда Возврат; КонецЕсли;
	сфпНомерСтроки	= ВыбранныйЭлемент.Значение;	
	ЗаполнитьЗначенияРеквизитовЗвонка();
	УстановитьДоступностьРеквизитовЗвонка();	
КонецПроцедуры // ОписаниеЗвонкаНажатие()

&НаКлиенте
Процедура АбонентКонтактПриИзменении(Элемент)
	сфпУправлениеВидомостьюКнопокДобавления();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ КОМАНД ФОРМЫ.

&НаКлиенте
// Процедура - обработчик команды формы "ПредыдущаяЗапись".
//
Процедура ПредыдущаяЗапись(Команда)
	Если сфпНомерСтроки > 0 Тогда
		сфпНомерСтроки = сфпНомерСтроки - 1;
		ЗаполнитьЗначенияРеквизитовЗвонка();
	КонецЕсли;
КонецПроцедуры // ПредыдущаяЗапись()

&НаКлиенте
// Процедура - обработчик команды формы "ПрослушатьЗаписьРазговора".
//
Процедура ПрослушатьЗаписьРазговора(Команда)
	
	ТД = сфпИсторияЗвонка[сфпНомерСтроки];
		
	ПараметрыЗвонка = Новый Структура("ИдентификаторЗвонка, ИдентификаторЗаписи, Ответственный, Входящий, НомерТелефона, ВнутреннийНомер, ДатаНачала, ДатаОкончания, Звонок",
		Объект.сфпИдентификаторЗвонка, ТД.ИдентификаторЗаписи, Объект.Ответственный, Объект.Входящий, Объект.АбонентКакСвязаться, ТД.ВнутреннийНомер, ТД.ДатаНачала, ТД.ДатаОкончания, Объект.Ссылка);
	сфпСофтФонПроКлиент.НачатьПрослушиваниеЗаписиРазговора(ПараметрыЗвонка, ЭтаФорма, Элементы.ПрослушатьЗаписьРазговора);

КонецПроцедуры // ПрослушатьЗаписьРазговора()

&НаКлиенте
// Процедура - обработчик команды формы "СледущаяЗапись".
//
Процедура СледущаяЗапись(Команда)
	КоличествоСтрок = сфпИсторияЗвонка.Количество() - 1;
	Если сфпНомерСтроки < КоличествоСтрок Тогда
		сфпНомерСтроки = сфпНомерСтроки + 1;
		ЗаполнитьЗначенияРеквизитовЗвонка();
		УстановитьДоступностьРеквизитовЗвонка();
	КонецЕсли;
КонецПроцедуры // СледущаяЗапись()

&НаКлиенте
Процедура сфпЗагрузитьИсториюЗвонков(Команда)
	Если НЕ сфпСофтФонПроСервер.сфпРолиДоступны("ПолныеПрава, сфпУправлениеМаршрутизацией") Тогда
		Сообщить(НСтр("ru='Недостаточно прав для загрузки истории звонков!'"));
		Возврат;
	КонецЕсли;
	сфпСофтФонПроСервер.сфпПолучитьИсториюЗвонков();
КонецПроцедуры

&НаКлиенте
Процедура ВвестиСобытиеНаОсновании(Команда)
	ОткрытьФорму("Документ.Событие.ФормаОбъекта", Новый Структура("Основание", Объект.Ссылка));
КонецПроцедуры

&НаКлиенте
// Процедура - обработчик команды формы "ДобавитьТелефон".
//
Процедура ДобавитьТелефон(Команда)
	ДобавитьТелефонНаСервер(Объект.АбонентКонтакт, Объект.АбонентКакСвязаться);
	Элементы.ДобавитьТелефон.Видимость = Ложь;
КонецПроцедуры

&НаСервереБезКонтекста
// Процедура добавляет номер телефона из поля "Как связаться" в объект из поля "Контакт"
//
//   Параметры:
//    СсылкаКИ 		- СправочникСсылка 	- Объект, к которому добавляется телефон
//	  НомерТелефона - Строка			- Добавляемый номер телефона
//
Процедура ДобавитьТелефонНаСервер(СсылкаКИ, НомерТелефона)
	НомерТелефона = СокрЛП(НомерТелефона);
	Если ТипЗнч(СсылкаКИ) = Тип("СправочникСсылка.Контрагенты") Тогда
		СтруктураНомера	= сфпСофтФонПроСервер.сфпЗаполнитьСтруктуруПолейПоПредставлениюТелефон(НомерТелефона);
		НаборЗаписейКИ = РегистрыСведений.КонтактнаяИнформация.СоздатьНаборЗаписей();
		НаборЗаписейКИ.Отбор.Объект.Установить(СсылкаКИ);
		НаборЗаписейКИ.Отбор.Тип.Установить(Перечисления.ТипыКонтактнойИнформации.Телефон);
		НаборЗаписейКИ.Отбор.Вид.Установить(Справочники.ВидыКонтактнойИнформации.ТелефонКонтактный);
		НоваяЗапись 		= НаборЗаписейКИ.Добавить();
		НоваяЗапись.Вид    	= Справочники.ВидыКонтактнойИнформации.ТелефонКонтактный;
		НоваяЗапись.Тип    	= Перечисления.ТипыКонтактнойИнформации.Телефон;
		НоваяЗапись.Объект 	= СсылкаКИ;
		НоваяЗапись.Поле1  	= СтруктураНомера.КодСтраны;
		НоваяЗапись.Поле3  	= СтруктураНомера.НомерТелефона;
		НоваяЗапись.Поле4  	= СтруктураНомера.Добавочный;
		НоваяЗапись.Поле2  	= СтруктураНомера.КодГорода;
		сфпСформироватьПредставлениеТелефонаИзНабораПолей(НоваяЗапись);
		НаборЗаписейКИ.Записать();
	ИначеЕсли ТипЗнч(СсылкаКИ) = Тип("СправочникСсылка.Организации") Тогда
		СтруктураНомера	= сфпСофтФонПроСервер.сфпЗаполнитьСтруктуруПолейПоПредставлениюТелефон(НомерТелефона);
		НаборЗаписейКИ = РегистрыСведений.КонтактнаяИнформация.СоздатьНаборЗаписей();
		НаборЗаписейКИ.Отбор.Объект.Установить(СсылкаКИ);
		НаборЗаписейКИ.Отбор.Тип.Установить(Перечисления.ТипыКонтактнойИнформации.Телефон);
		НаборЗаписейКИ.Отбор.Вид.Установить(Справочники.ВидыКонтактнойИнформации.ТелефонКонтактный);
		НоваяЗапись 		= НаборЗаписейКИ.Добавить();
		НоваяЗапись.Вид    	= Справочники.ВидыКонтактнойИнформации.ТелефонКонтактный;
		НоваяЗапись.Тип    	= Перечисления.ТипыКонтактнойИнформации.Телефон;
		НоваяЗапись.Объект 	= СсылкаКИ;
		НоваяЗапись.Поле1  	= СтруктураНомера.КодСтраны;
		НоваяЗапись.Поле3  	= СтруктураНомера.НомерТелефона;
		НоваяЗапись.Поле4  	= СтруктураНомера.Добавочный;
		НоваяЗапись.Поле2  	= СтруктураНомера.КодГорода;
		сфпСформироватьПредставлениеТелефонаИзНабораПолей(НоваяЗапись);
		НаборЗаписейКИ.Записать();		
	ИначеЕсли ТипЗнч(СсылкаКИ) = Тип("СправочникСсылка.Сотрудники") Тогда
		СтруктураНомера	= сфпСофтФонПроСервер.сфпЗаполнитьСтруктуруПолейПоПредставлениюТелефон(НомерТелефона);
		Если Найти(СтруктураНомера.КодГорода, "9") = 1 Тогда
			ВидТелефона = Справочники.ВидыКонтактнойИнформации.ТелефонСотовый;
		Иначе
			ВидТелефона = Справочники.ВидыКонтактнойИнформации.ТелефонКонтактный;
		КонецЕсли;
		НаборЗаписейКИ = РегистрыСведений.КонтактнаяИнформация.СоздатьНаборЗаписей();
		НаборЗаписейКИ.Отбор.Объект.Установить(СсылкаКИ);
		НаборЗаписейКИ.Отбор.Тип.Установить(Перечисления.ТипыКонтактнойИнформации.Телефон);
		НаборЗаписейКИ.Отбор.Вид.Установить(ВидТелефона);
		НоваяЗапись 		= НаборЗаписейКИ.Добавить();
		НоваяЗапись.Вид    	= ВидТелефона;
		НоваяЗапись.Тип    	= Перечисления.ТипыКонтактнойИнформации.Телефон;
		НоваяЗапись.Объект 	= СсылкаКИ;
		НоваяЗапись.Поле1  	= СтруктураНомера.КодСтраны;
		НоваяЗапись.Поле3  	= СтруктураНомера.НомерТелефона;
		НоваяЗапись.Поле4  	= СтруктураНомера.Добавочный;
		НоваяЗапись.Поле2  	= СтруктураНомера.КодГорода;
		сфпСформироватьПредставлениеТелефонаИзНабораПолей(НоваяЗапись);
		НаборЗаписейКИ.Записать();
	ИначеЕсли ТипЗнч(СсылкаКИ) = Тип("СправочникСсылка.ПодразделенияКомпании") Тогда
		СтруктураНомера	= сфпСофтФонПроСервер.сфпЗаполнитьСтруктуруПолейПоПредставлениюТелефон(НомерТелефона);
		Если Найти(СтруктураНомера.КодГорода, "9") = 1 Тогда
			ВидТелефона = Справочники.ВидыКонтактнойИнформации.ТелефонСотовый;
		Иначе
			ВидТелефона = Справочники.ВидыКонтактнойИнформации.ТелефонКонтактный;
		КонецЕсли;			
		НаборЗаписейКИ = РегистрыСведений.КонтактнаяИнформация.СоздатьНаборЗаписей();
		НаборЗаписейКИ.Отбор.Объект.Установить(СсылкаКИ);
		НаборЗаписейКИ.Отбор.Тип.Установить(Перечисления.ТипыКонтактнойИнформации.Телефон);
		НаборЗаписейКИ.Отбор.Вид.Установить(ВидТелефона);
		НоваяЗапись 		= НаборЗаписейКИ.Добавить();
		НоваяЗапись.Вид    	= ВидТелефона;
		НоваяЗапись.Тип    	= Перечисления.ТипыКонтактнойИнформации.Телефон;
		НоваяЗапись.Объект 	= СсылкаКИ;
		НоваяЗапись.Поле1  	= СтруктураНомера.КодСтраны;
		НоваяЗапись.Поле3  	= СтруктураНомера.НомерТелефона;
		НоваяЗапись.Поле4  	= СтруктураНомера.Добавочный;
		НоваяЗапись.Поле2  	= СтруктураНомера.КодГорода;
		сфпСформироватьПредставлениеТелефонаИзНабораПолей(НоваяЗапись);
		НаборЗаписейКИ.Записать();
	КонецЕсли;
КонецПроцедуры	

&НаСервереБезКонтекста
// Процедура формирует строковое представление телефона.
Процедура сфпСформироватьПредставлениеТелефонаИзНабораПолей(НаборПолей) Экспорт
	
	// {{{ СофтФон, Проф }}} НАЧАЛО Код встраивания в произвольную конфигурацию	
	// Если внутренний номер заполнен и не заполнен основной, то сохраним его как внутренний
	// а поля кодов страны и города автоматом скинем
	Если ЗначениеЗаполнено(НаборПолей.Поле4) И НЕ ЗначениеЗаполнено (НаборПолей.Поле3) Тогда
		НаборПолей.Поле1 = "";
		НаборПолей.Поле2 = "";
		НаборПолей.Представление = СокрЛП(НаборПолей.Поле4);
		Возврат;
	КонецЕсли;
	// {{{ СофтФон, Проф }}} КОНЕЦ
	
	НаборПолей.Представление = НаборПолей.Поле1;
	НаборПолей.Представление = НаборПолей.Представление + ?((Не ПустаяСтрока(НаборПолей.Поле2)),(CRMПроверкаПустойСтроки(НаборПолей.Представление, Ложь)+"(" + НаборПолей.Поле2 + ")"),"");
	НаборПолей.Представление = НаборПолей.Представление + ?((Не ПустаяСтрока(НаборПолей.Поле3)),(CRMПроверкаПустойСтроки(НаборПолей.Представление, ПустаяСтрока(НаборПолей.Поле2)) + НаборПолей.Поле3),"");
	Если НЕ ПустаяСтрока(НаборПолей.Представление) Тогда
		НаборПолей.Представление = НаборПолей.Представление + ?((Не ПустаяСтрока(НаборПолей.Поле4)),(CRMПроверкаПустойСтроки(НаборПолей.Представление) + "доб. " + НаборПолей.Поле4),"");
	Иначе
		НаборПолей.Представление = НаборПолей.Поле4;
	КонецЕсли; 
	
	//CRM+
	
	// сформируем числовое представление номера телефона
	Попытка
		НаборПолей.CRM_ПолеХраненияНомера = сфпСофтФонПроСервер.сфпУбратьИзНомераТелефонаВсеПрефиксы(НаборПолей.Представление);
	Исключение
	КонецПопытки;	
	
	//CRM-
	
КонецПроцедуры // СформироватьПредставление()

&НаКлиенте
// Процедура - обработчик команды формы "СоздатьПартнера".
//
Процедура СоздатьКонтакт(Команда)
	
	СписокВыбора = Новый СписокЗначений;
	СписокВыбора.Добавить(ПредопределенноеЗначение("Справочник.Контрагенты.ПустаяСсылка"), Нстр("ru = 'Контрагент'"));
	СписокВыбора.Добавить(ПредопределенноеЗначение("Справочник.Сотрудники.ПустаяСсылка"), Нстр("ru = 'Сотрудник'"));	
	СписокВыбора.Добавить(ПредопределенноеЗначение("Справочник.ПодразделенияКомпании.ПустаяСсылка"), Нстр("ru = 'Подразделение компании'"));		
	СписокВыбора.Добавить(ПредопределенноеЗначение("Справочник.Организации.ПустаяСсылка"), Нстр("ru = 'Организация'"));	
	
	ВыбранныйЭлемент = ВыбратьИзМеню(СписокВыбора, Элементы.АбонентКонтакт);
	СоздатьПартнераПослеВыбораТипаКонтакта(ВыбранныйЭлемент, Новый Структура());
	
КонецПроцедуры

&НаКлиенте
// Процедура, вызываемая после ответа пользователя по выбору создания типа контакта
// 
// Параметры:
//   Результат 					- ЭлементСпискаЗначений - Тип выбранного контакта для создания
//   ДополнительныеПараметры 	- Структура - Структура с передаваемыми доп. параметрами
//
Процедура СоздатьПартнераПослеВыбораТипаКонтакта(Результат, ДополнительныеПараметры) Экспорт
	Если Результат = Неопределено Тогда Возврат КонецЕсли;
	Телефон = сфпСофтФонПроСервер.сфпУбратьИзНомераТелефонаВсеПрефиксы(Объект.АбонентКакСвязаться);
	Если ТипЗнч(Результат.Значение) = Тип("СправочникСсылка.Контрагенты") Тогда
		ФормаКонтакта = ПолучитьФорму("Справочник.Контрагенты.ФормаОбъекта",,ЭтаФорма);
		ФормаКонтакта.CRM_Основание = Объект.Ссылка;
		ФормаКонтакта.Открыть();
	ИначеЕсли ТипЗнч(Результат.Значение) = Тип("СправочникСсылка.Сотрудники") Тогда
		ФормаКонтакта = ПолучитьФорму("Справочник.Сотрудники.ФормаОбъекта",,ЭтаФорма);
		ФормаКонтакта.CRM_Основание = Объект.Ссылка;
		ФормаКонтакта.Открыть();
	ИначеЕсли ТипЗнч(Результат.Значение) = Тип("СправочникСсылка.ПодразделенияКомпании") Тогда	
		ФормаКонтакта = ПолучитьФорму("Справочник.ПодразделенияКомпании.ФормаОбъекта",,ЭтаФорма);
		ФормаКонтакта.CRM_Основание = Объект.Ссылка;
		ФормаКонтакта.Открыть();
	ИначеЕсли ТипЗнч(Результат.Значение) = Тип("СправочникСсылка.Организации") Тогда
		ФормаКонтакта = ПолучитьФорму("Справочник.Организации.ФормаОбъекта",,ЭтаФорма);
		ФормаКонтакта.CRM_Основание = Объект.Ссылка;
		ФормаКонтакта.Открыть();
	КонецЕсли;
КонецПроцедуры


#КонецОбласти

#Область ОбработчикиСобытийФормы

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ.

&НаСервере
// Процедура - обработчик события формы "ПриСозданииНаСервере"
//
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Объект.Ссылка.Пустая() Тогда
		Объект.Автор			= сфпСофтФонПроСервер.сфпТекущийПользователь();
		Объект.Ответственный	= сфпСофтФонПроСервер.сфпТекущийПользователь();
		Объект.Дата				= сфпСофтФонПроСервер.сфпТекущаяДата();
		Объект.Важность			= Перечисления.Важность.Средняя;
	КонецЕсли;
	Если Параметры.Свойство("АбонентКонтакт") И ЗначениеЗаполнено(Параметры.АбонентКонтакт) Тогда
		Объект.АбонентКонтакт = Параметры.АбонентКонтакт;
		Объект.АбонентПредставление = Строка(Объект.АбонентКонтакт);
	КонецЕсли;	
КонецПроцедуры // ПриСозданииНаСервере()

&НаКлиенте
// Процедура - обработчик события формы "ПриОткрытии".
//
Процедура ПриОткрытии(Отказ)
	сфпДлительность = Дата('00010101') + Объект.сфпДлительностьЗвонка;
	Заголовок = НСтр("ru='Звонок'");
	Если Объект.Входящий Тогда
		Если Объект.сфпСостояниеЗвонка = ПредопределенноеЗначение("Перечисление.сфпСостоянияЗвонков.Пропущенный") Тогда
			Заголовок = Заголовок + НСтр("ru=' входящий '") + "(" + НСтр("ru='пропущенный'") + ")";
			Элементы.ДекорацияСостояниеЗвонка.Заголовок = Нстр("ru = 'Состояние: пропущенный'");
			Элементы.ДекорацияСостояниеЗвонка.ЦветТекста = WebЦвета.Красный;
		Иначе	
			Заголовок = Заголовок + НСтр("ru=' входящий '") + "(" + НСтр("ru='отвеченный'") + ")";
			Элементы.ДекорацияСостояниеЗвонка.Заголовок = Нстр("ru = 'Состояние: отвеченный'");
			Элементы.ДекорацияСостояниеЗвонка.ЦветТекста = WebЦвета.Зеленый;
		КонецЕсли;	
	Иначе
		Если Объект.сфпСостояниеЗвонка = ПредопределенноеЗначение("Перечисление.сфпСостоянияЗвонков.Пропущенный") Тогда
			Заголовок = Заголовок + НСтр("ru=' исходящий '") + "(" + НСтр("ru='не дозвонились'") + ")";
			Элементы.ДекорацияСостояниеЗвонка.Заголовок = Нстр("ru = 'Состояние: не дозвонились'");
			Элементы.ДекорацияСостояниеЗвонка.ЦветТекста = WebЦвета.Красный;
		Иначе	
			Заголовок = Заголовок + НСтр("ru=' исходящий '") + "(" + НСтр("ru='отвеченный'") + ")";
			Элементы.ДекорацияСостояниеЗвонка.Заголовок = Нстр("ru = 'Состояние: отвеченный'");
			Элементы.ДекорацияСостояниеЗвонка.ЦветТекста = WebЦвета.Зеленый;
		КонецЕсли;	
	КонецЕсли;
	Заголовок = Заголовок + ", " + Объект.АбонентПредставление + ", " + Формат(Объект.Дата, "ДЛФ=D") + "/" 
		+ Формат(Объект.Дата, "ДЛФ=T; ДП=0:00:00") + "/" + Формат(Дата('00010101') + Объект.сфпДлительностьЗвонка, "ДЛФ=T; ДП=0:00:00");
	сфпНомерСтроки	= 0;	
	ЗаполнитьИсториюЗвонка();
	ЗаполнитьЗначенияРеквизитовЗвонка();
	УстановитьДоступностьРеквизитовЗвонка();
	сфпУправлениеВидомостьюКнопокДобавления();
	сфпРазрешеныИзмененияВДокументе();
КонецПроцедуры // ПриОткрытии()

&НаКлиенте
// Процедура - обработчик события формы "ОбработкаОповещения".
//
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	Если (ИмяСобытия = "СофтФон_КонецРазговора") И Параметр.Свойство("Звонок") Тогда
		Если (Параметр.Звонок = Объект.Ссылка) Тогда
			Объект.сфпДлительностьЗвонка = сфпСофтФонПроСервер.сфпТекущаяДата() - Объект.Дата;
			сфпДлительность		= Дата('00010101') + Объект.сфпДлительностьЗвонка;
			Объект.Описание		= сфпСофтФонПроСервер.сфпЗаполнитьОписаниеТелефонногоЗвонка(Объект.сфпДлительностьЗвонка);
			Если Параметр.Свойство("НовыйОтветственный") Тогда
				Объект.Ответственный = Параметр.НовыйОтветственный;
			КонецЕсли;
			Модифицированность = Истина;
			
			Попытка
				ЭтаФорма.Записать();
			Исключение КонецПопытки;
			
			ЗаполнитьИсториюЗвонка();
			ЗаполнитьЗначенияРеквизитовЗвонка();
			УстановитьДоступностьРеквизитовЗвонка();
		КонецЕсли;
	ИначеЕсли (ИмяСобытия = "Софтфон_CoMagic") И Параметр.Свойство("Звонок") Тогда
		Если Параметр.Звонок = Объект.Ссылка Тогда
			Если (Объект.сфпДлительностьЗвонка = 0) И (сфпСтруктураВнешнихДанных = Неопределено) Тогда
				// Заполняем документ данными из CoMagic
				сфпСтруктураВнешнихДанных	= Параметр.СтруктураCoMagic;
				Объект.сфпCoMagicID			= сфпСтруктураВнешнихДанных.comagic_context.visitor_id;
				Объект.Описание = Объект.Описание + ?(ПустаяСтрока(Объект.Описание), "", Символы.ПС) 
					+ НСтр("ru='Кампания: '") + сфпСтруктураВнешнихДанных.comagic_context.campaign + Символы.ПС 
					+ НСтр("ru='Сайт: '") + сфпСтруктураВнешнихДанных.comagic_context.site + Символы.ПС
					+ НСтр("ru='Ключевые слова: '") + сфпСтруктураВнешнихДанных.comagic_context.search_query; 
				// В этой конфигурации CoMagic не используется
				//Если НЕ ЗначениеЗаполнено(Объект.АбонентКонтакт) Тогда
				//	сфпЗаполнитьПартнераИКонтактноеЛицоИзCoMagic();
				//КонецЕсли;			
				Модифицированность	= Истина;
				
				Попытка
					ЭтаФорма.Записать();
				Исключение КонецПопытки;
			КонецЕсли;	
		КонецЕсли;	
	ИначеЕсли (ИмяСобытия = "ЗаполнитьКонтактВТелефонномЗвонке") И Параметр.Свойство("Звонок") Тогда
		Если Параметр.Звонок = Объект.Ссылка Тогда
			Объект.АбонентКонтакт 				= Параметр.Контакт;
			Объект.АбонентПредставление 		= Строка(Объект.АбонентКонтакт);
			Элементы.СоздатьКонтакт.Видимость 	= Ложь;
			Модифицированность					= Истина;
			
			Попытка
				ЭтаФорма.Записать();
			Исключение КонецПопытки;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры // ОбработкаОповещения()

&НаКлиенте
// Процедура - обработчик события формы "ПослеЗаписи".
//
Процедура ПослеЗаписи(ПараметрыЗаписи)
	// В этой конфигурации CoMagic не используется
	//Если НЕ ПустаяСтрока(Объект.сфпCoMagicID) Тогда
	//	Если ЗначениеЗаполнено(Объект.АбонентКонтакт) Тогда
	//		Если ТипЗнч(Объект.АбонентКонтакт) = Тип("СправочникСсылка.КонтактныеЛицаКонтрагентов") Тогда
	//			сфпСофтФонПроСервер.сфпЗаписатьIDCoMagic(Объект.АбонентКонтакт, Объект.сфпCoMagicID);
	//			Объект.сфпCoMagicID = "";
	//		ИначеЕсли ТипЗнч(Объект.АбонентКонтакт) = Тип("СправочникСсылка.КонтактныеЛица") Тогда
	//			сфпСофтФонПроСервер.сфпЗаписатьIDCoMagic(Объект.АбонентКонтакт, Объект.сфпCoMagicID);
	//			Объект.сфпCoMagicID = "";				
	//		ИначеЕсли ТипЗнч(Объект.АбонентКонтакт) = Тип("СправочникСсылка.Контрагенты") Тогда
	//			сфпСофтФонПроСервер.сфпЗаписатьIDCoMagic(Объект.АбонентКонтакт, Объект.сфпCoMagicID);
	//			Объект.сфпCoMagicID = "";
	//		КонецЕсли;	
	//	КонецЕсли;	
	//КонецЕсли;	
КонецПроцедуры // ПослеЗаписи()

&НаКлиенте
// Процедура - обработчик события формы "ОбработкаЗаписиНового"
//
Процедура ОбработкаЗаписиНового(НовыйОбъект, Источник, СтандартнаяОбработка)
	Если ТипЗнч(Источник) = Тип("Форма") И Источник.ВладелецФормы = ЭтаФорма И НЕ (ТипЗнч(НовыйОбъект) = Тип("ФормаКлиентскогоПриложения")) Тогда
		Объект.АбонентКонтакт 				= НовыйОбъект.Ссылка;
		Объект.АбонентПредставление 		= Строка(Объект.АбонентКонтакт);
		Элементы.СоздатьКонтакт.Видимость 	= Ложь;
		Модифицированность					= Истина;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти
