Перем Права Экспорт;				// Переменная объекта - ссылка на коллекцию прав, настроек и переменных окружения
Перем РезультатОбработки Экспорт;                 // Переменная для накопления результатов проведения по модулям наборов записей
Перем СообщениеОбОшибке Экспорт;                  // Переменная для накопления результатов записи. Если = неопределено, то вывод будет на экран, иначе тут сообщения об ошибках.


// Обработка изменения реквизитов документа
// Параметры
//  Имя			– Строка – Имя реквизита документа с полным путем (например Товары.Номенклатура).
//  ЭтаФорма	– Форма	 – Ссылка на форму документа. Если значение неопределено,
//                         производится программная обработка реквизитов.
//  ТекСтрока	– СтрокаТабличнойЧасти – Ссылка на строку табличной части документа, реквизит которой обрабатывается.
//										 Имеет смысл только для табличных частей документов.
//  ДопПараметры– Структура			– Структура, содержащая дополнительные параметры обработки реквизита.
// Возвращаемое значение:
//   Булево   – Результат выполнения обработки.
Функция ОбработкаРеквизита(Имя,ТекСтрока=Неопределено,ЭтаФорма=Неопределено,ДопПараметры=Неопределено) Экспорт
	Если ДопПараметры = Неопределено Тогда
		ДопПараметры = Новый Структура();
	КонецЕсли;
	
	Возврат дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры);
КонецФункции // ОбработкаРеквизита()

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	//KamikadZe begin add 01.08.2020 12:51:49
	// регистр ТТ_УПР_ЗП Приход
	Движения.ТТ_УПР_ЗП.Записывать = Истина;
	Движения.ТТ_УПР_ЗП.Очистить();
	ДатаДвижения = КонецДня(КонецПериода);
	Для Каждого ТекСтрокаДанныеЗУП Из РасчетЗарплаты Цикл
		Движение = Движения.ТТ_УПР_ЗП.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = ДатаДвижения;
		Движение.Сотрудник = ТекСтрокаДанныеЗУП.Сотрудник;
		Движение.Должность = Движение.Сотрудник.Должность;
		Движение.Подразделение = ПодразделениеКомпании;
		Движение.Организация = Организация;
		Движение.Бренд = ТекСтрокаДанныеЗУП.Бренд;
		Движение.МаркетингЗП = ТекСтрокаДанныеЗУП.Премия;
	КонецЦикла;
	//KamikadZe end add
КонецПроцедуры

// Возвращает список возможных хозяйственных операций документа
// Вовращаемое значение: СписокЗначений. 
// Строка списка: Значение - имя предопределенного элемента; 
//				  Представление - красивое его представление
// 				  "Помеченная" строка - ХО по умолчанию.
Функция ПолучитьСписокХозОпераций() Экспорт
	СписокХозОпераций = Новый СписокЗначений;
	СписокХозОпераций.Добавить("Факт","Факт",Истина);
	
	Возврат СписокХозОпераций;
КонецФункции


#Если Клиент Тогда
////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ПЕЧАТИ ДОКУМЕНТА

// Формирует печатную форму "СчетНаОплату"
// 
// Параметры:
//  ТабДокумент - табличный документ.
//
// Возвращаемое значение:
//  ТабДокумент - возвращает сформированный табличный документ.
//
Функция ПечатьРасчет(ТабДокумент) Экспорт
	//Макет = ПолучитьМакет("Расчет");
	//
	////для начала настроим макет
	////ОбластьШапкаТаблицы = дкПривестиМакетПечатнойФормы(ЭтотОбъект,Макет);
	//ФорматВыводаСуммы = обПраво("ФорматВыводаСуммы",Права,,ЭтотОбъект);
	//
	////вывод образца заполнения платёжного поручения
	//ОбластьМакета = Макет.ПолучитьОбласть("Заголовок"); 
	//
	//ТабДокумент.Вывести(ОбластьМакета);
	//
	//Возврат ТабДокумент;
КонецФункции // ПечатьСчетНаОплату()


// Процедура осуществляет печать документа. Можно направить печать на 
// экран или принтер, а также распечатать необходмое количество копий.
// Параметры: НазваниеМакета - строка, название макета, если пусто - то по умолчанию,
//   Документ - сюда можно передать уже созданный табличный документ для заполнения
Функция Печать(НазваниеПечатнойФормы="", КоличествоЭкземпляров=1, НаПринтер=Ложь, Документ=Неопределено) Экспорт
	// Вызов конкретно печатной формы и печать результата прописано в общем модуле
	// здесь могут быть вставлены дополнительные механизмы
	Возврат дкПечать(ЭтотОбъект, НазваниеПечатнойФормы, КоличествоЭкземпляров, НаПринтер, Документ);
КонецФункции

#КонецЕсли
// Если Клиент Тогда - завершена клиентская часть

Процедура ПриУстановкеНовогоНомера(СтандартнаяОбработка, Префикс)
	Если НЕ дкПриУстановкеНовогоНомера(ЭтотОбъект, СтандартнаяОбработка, Префикс) Тогда Возврат; КонецЕсли;
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	Если НЕ дкПриЗаписи(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
КонецПроцедуры

Процедура ПередУдалением(Отказ)
	Если НЕ дкПередУдалением(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ)
	Если НЕ дкОбработкаУдаленияПроведения(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
КонецПроцедуры

Процедура ПриКопировании(ОбъектКопирования)
	Если НЕ дкПриКопировании(ЭтотОбъект, ОбъектКопирования) Тогда Возврат; КонецЕсли;
КонецПроцедуры


// Возвращает структуру обязательных / уникальных реквизитов документа
// Возвращаемая структура содержит строковые идентификаторы реквизитов или вложенные структуры для табличных частей
// Для реквизита значение структуры содержит число 1-Обязательный, 2-Уникальный, 3-Уникальный и обязательный
Функция ПолучитьОбязательныеРеквизиты() Экспорт
	
	// Обязательные реквизиты документа
	ОбязательныеРеквизиты=Новый Структура();
	ОбязательныеРеквизиты.Вставить("Организация",1);
	ОбязательныеРеквизиты.Вставить("ПодразделениеКомпании",1);
	ОбязательныеРеквизиты.Вставить("Автор",1);
	
	Возврат ОбязательныеРеквизиты;
КонецФункции

// Проверяет корректность заполнения объекта.
// Возвращает Истина если все заполнено корректно и Ложь иначе.
// В случае некорректного заполнения формирует строку описанием возникших ошибок "Ошибки"
// На вход может быть передана структура ДопРеквизиты с дополнительными реквизитами для проверки
// может управляться булевыми флагами выполняемых проверок Заполнение, Уникальность
// (могут быть и другие необязательные)
// Обычно выполняется универсальным обработчиком, но могут быть добавлены доп. проверки
Функция ПроверитьКорректность(Ошибки="", ДопРеквизиты=Неопределено, Заполнение=Истина, Уникальность=Истина) Экспорт
	// Здесь могут быть определены дополнительные к стандартным обязательным реквизитам условия проверки
	Результат = дкПроверитьКорректность(ЭтотОбъект, Ошибки, ДопРеквизиты, Заполнение, Уникальность);
	
	// Проведем проверку соотвествия организации документа организациям некоторых реквизитов документа.
	// Такую проверку необходимо осуществлять, если баланс в системе ведется по организации, или если установлен способ контроля корректности
	// договора и склада документа. Причем, если способ контроля выбран "Контроль по организации и подразделению", то
	// дополнительно осуществляется проверка соотвествия подразделений.
	Если Результат Тогда
		//dmim rarus{
		//СпособКонтроляКорректности = обПраво("КонтрольКорректностиДоговораИСкладаДокумента", Права);
		СпособКонтроляКорректности=Перечисления.СпособКонтроляКорректностиДоговораИСкладаДокумента.КонтрольОтсутствует;
		
		КонтрольОтсутствует        = (СпособКонтроляКорректности=Перечисления.СпособКонтроляКорректностиДоговораИСкладаДокумента.КонтрольОтсутствует);
		БалансВедетсяПоОрганизации = (Константы.СпособВеденияБаланса.Получить()=Перечисления.СпособВеденияБаланса.ПоОрганизации);

		Если БалансВедетсяПоОрганизации Или Не КонтрольОтсутствует Тогда
			КонтрольПоПодразделению = (СпособКонтроляКорректности=Перечисления.СпособКонтроляКорректностиДоговораИСкладаДокумента.КонтрольПоОрганизацииИПодразделению);
			
			КонтролируемыеРеквизиты = Новый Структура();
			
			КонтролируемыеРеквизитыШапки = Новый Структура();
			КонтролируемыеРеквизитыШапки.Вставить("ДоговорВзаиморасчетов",КонтрольПоПодразделению);
			КонтролируемыеРеквизиты.Вставить("КонтролируемыеРеквизитыШапки",КонтролируемыеРеквизитыШапки);
		
			Результат = дкПроверитьКорректностьПоОрганизации(ЭтотОбъект,КонтролируемыеРеквизиты,Ошибки) и Результат;
		КонецЕсли;  		
	КонецЕсли;	
	
	Возврат Результат;
КонецФункции

Процедура ОбработкаЗаполнения(Основание) Экспорт
	Если НЕ дкОбработкаЗаполнения(ЭтотОбъект, Основание) Тогда Возврат; КонецЕсли;
КонецПроцедуры


// Вывод заголовка формы документа
//
// Параметры:
// ЭтаФорма - форма, форма переданного документа
//
Процедура ВывестиЗаголовокФормы(ЭтаФорма) Экспорт
	// обновим заголовок формы
	стНомер = " № " + СокрЛП(ЭтаФорма.Номер); стДата = " от " + Формат(ЭтаФорма.Дата,"ДФ = dd.MM.yyyy");
	Попытка	ПраваПользователя = ЭтаФорма.ЭтотОбъект.Права; Исключение ПраваПользователя = НЕОПРЕДЕЛЕНО; КонецПопытки; 
	Если обПраво("ПредставлениеАвторовПоПолномуНаименованию",ПраваПользователя,,ЭтаФорма) Тогда
		Если обЗначениеНеЗаполнено(ЭтаФорма.Автор.Сотрудник) Тогда
			стАвтор = " (" + СокрЛП(ЭтаФорма.Автор.Наименование) + ")";	
		Иначе
			стАвтор = " (" + СокрЛП(ЭтаФорма.Автор.Сотрудник.Наименование) + ")";
		КонецЕсли;
	Иначе
		стАвтор = " (" + СокрЛП(ЭтаФорма.Автор.Код) + ")";
	КонецЕсли;
	Если ЭтаФорма.ЭтотОбъект.Проведен Тогда
		СостояниеДокумента = " Проведен";
	ИначеЕсли ЭтаФорма.ЭтотОбъект.ПометкаУдаления Тогда
		СостояниеДокумента = " Удален";
	ИначеЕсли НЕ ЭтаФорма.ЭтотОбъект.ЭтоНовый() Тогда
		СостояниеДокумента = " Записан";
	Иначе
		СостояниеДокумента = " Новый";
	КонецЕсли;
	Попытка ЭтаФорма.Заголовок = ЭтаФорма.ЭтотОбъект.Метаданные().Синоним + стНомер + стДата + стАвтор + СостояниеДокумента ;
	Исключение ЭтаФорма.Заголовок = ЭтаФорма.ЭтотОбъект.Метаданные().Представление() + стНомер + стДата + стАвтор + СостояниеДокумента;
	КонецПопытки;
КонецПроцедуры // дкВывестиЗаголовокФормы()


////////////////////////////////////////////////////////////////////////////////
// ИСПОЛНЯЕМАЯ ЧАСТЬ МОДУЛЯ

// сохранение ссылки на коллекцию прав, настроек и окружения
Права = Неопределено;
#Если Клиент Тогда
Права = глПрава;
#КонецЕсли

СообщениеОбОшибке=Неопределено;