
// Получение данных о прослеживаемых товаров
//
// Параметры:
//  Объект	 - ДокументОбъект.КорректировкаРеализацииАвтомобилей - Документ, на основании которого произошла операция с товаром
// 
// Возвращаемое значение:
//  ТаблицаЗначений - Список прослеживаемых товаров
//
Функция ОперацииСПрослеживаемымиТоварами(Объект) Экспорт
	
	// TODO: На данный момент сделано только для формирования отчета об операциях
	
	// Получим таблицу для формирования данных по операции
	ТаблицаОперацииПрослеживаемости = ПрослеживаемостьТоваровСервер.ИнициализацияТаблицыОпераций();
	
	ОсвобождентОтНДС = Объект.ПодразделениеКомпании.ОсвобожденОтНДС ИЛИ Объект.Организация.ОсвобожденОтНДС;
	
	// Проверим есть ли ставка НДС в документе
	ТаблицаНДС = Объект.Автомобили.Выгрузить();
	ТаблицаНДС.Свернуть("СтавкаНДС");
	ЕстьНДС = НЕ (ТаблицаНДС.Количество() = 1 И ТаблицаНДС[0].СтавкаНДС = Справочники.СтавкиНДС.БезНДС);
	
	// Операцию об отчете не выводим если есть ставка НДС в документе и организация плательщик НДС
	Если ЕстьНДС И НЕ ОсвобождентОтНДС Тогда
		Возврат ТаблицаОперацииПрослеживаемости;
	КонецЕсли;
	
	Если Объект.ХозОперация = Справочники.ХозОперации.КорректировкаРеализацииАвтомобилейИсправлениеВПервичныхДокументах Тогда
		ТекстЗапроса = "ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ДокументыОтображенияОпераций.ОтчетОбОперациях) КАК ОтчетностьОперации,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыДокументов.УПД) КАК ВидДокумента,
		|	ЗНАЧЕНИЕ(Справочник.КодыОперацийПрослеживаемости.РеализацияТоваров) КАК КодОперации,
		|	КорректировкаРеализацииАвтомобилейАвтомобили.Автомобиль КАК Номенклатура,
		|	ОстаткиАвтомобилейОстатки.ГТД КАК РНПТ,
		|	КорректировкаРеализацииАвтомобилейАвтомобили.Количество КАК КоличествоПрослеживаемости,
		|	КорректировкаРеализацииАвтомобилейАвтомобили.СуммаВсего - КорректировкаРеализацииАвтомобилейАвтомобили.СуммаНДС КАК СуммаБезНДС
		|ИЗ
		|	Документ.КорректировкаРеализацииАвтомобилей.Автомобили КАК КорректировкаРеализацииАвтомобилейАвтомобили
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиАвтомобилей.Остатки(&Момент, ) КАК ОстаткиАвтомобилейОстатки
		|		ПО КорректировкаРеализацииАвтомобилейАвтомобили.Автомобиль = ОстаткиАвтомобилейОстатки.Автомобиль
		|ГДЕ
		|	КорректировкаРеализацииАвтомобилейАвтомобили.Ссылка = &Ссылка
		|	И ОстаткиАвтомобилейОстатки.ГТД.РНПТ";
		Документ = Объект.Сделка;
		Если ЗначениеЗаполнено(Объект.Сделка) Тогда
			ДанныеРеализации = Новый Структура("Дата,Номер", Объект.Сделка.Дата, Объект.Сделка.Номер);
			ПериодОтчета = НачалоКвартала(ДанныеРеализации.Дата);
			НомерДокумента = дкПолучитьНомерДляПечати(Объект.Сделка);
			ДатаДокумента = ДанныеРеализации.Дата;
		Иначе
			ПериодОтчета = НачалоКвартала(Объект.Дата);
		КонецЕсли;
	Иначе
		ТекстЗапроса = "ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ДокументыОтображенияОпераций.ОтчетОбОперациях) КАК ОтчетностьОперации,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыДокументов.УКД) КАК ВидДокумента,
		|	ВЫБОР
		|		КОГДА КорректировкаРеализацииАвтомобилейАвтомобили.СуммаВсегоРазница > 0
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.КодыОперацийПрослеживаемости.УКДУвеличение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КодыОперацийПрослеживаемости.УКДУменьшение)
		|	КОНЕЦ КАК КодОперации,
		|	КорректировкаРеализацииАвтомобилейАвтомобили.Автомобиль КАК Номенклатура,
		|	ОстаткиАвтомобилейОстатки.ГТД КАК РНПТ,
		|	КорректировкаРеализацииАвтомобилейАвтомобили.КоличествоРазница * ВЫБОР
		|		КОГДА КорректировкаРеализацииАвтомобилейАвтомобили.КоличествоРазница < 0
		|			ТОГДА -1
		|		ИНАЧЕ 1
		|	КОНЕЦ КАК КоличествоПрослеживаемости,
		|	КорректировкаРеализацииАвтомобилейАвтомобили.СуммаВсегоРазница * ВЫБОР
		|		КОГДА КорректировкаРеализацииАвтомобилейАвтомобили.СуммаВсегоРазница < 0
		|			ТОГДА -1
		|		ИНАЧЕ 1
		|	КОНЕЦ - КорректировкаРеализацииАвтомобилейАвтомобили.СуммаНДСРазница * ВЫБОР
		|		КОГДА КорректировкаРеализацииАвтомобилейАвтомобили.СуммаНДСРазница < 0
		|			ТОГДА -1
		|		ИНАЧЕ 1
		|	КОНЕЦ КАК СуммаБезНДС
		|ИЗ
		|	Документ.КорректировкаРеализацииАвтомобилей.Автомобили КАК КорректировкаРеализацииАвтомобилейАвтомобили
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиАвтомобилей.Остатки(&Момент, ) КАК ОстаткиАвтомобилейОстатки
		|		ПО КорректировкаРеализацииАвтомобилейАвтомобили.Автомобиль = ОстаткиАвтомобилейОстатки.Автомобиль
		|ГДЕ
		|	КорректировкаРеализацииАвтомобилейАвтомобили.Ссылка = &Ссылка
		|	И ОстаткиАвтомобилейОстатки.ГТД.РНПТ
		|	И КорректировкаРеализацииАвтомобилейАвтомобили.СуммаВсегоРазница <> 0";
		Документ = Объект.Ссылка;
		ПериодОтчета = НачалоКвартала(Объект.Дата);
		НомерДокумента = дкПолучитьНомерДляПечати(Объект.Ссылка);
		ДатаДокумента = Объект.Дата;
	КонецЕсли;
	
	// Сформируем запрос из документа
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	Запрос.УстановитьПараметр("Момент", Новый Граница(Объект.МоментВремени(), ВидГраницы.Исключая));
	РезультатЗапроса = Запрос.Выполнить();
	
	// Проверим есть РНПТ у документа
	Если РезультатЗапроса.Пустой() Тогда
		Возврат ТаблицаОперацииПрослеживаемости;
	КонецЕсли;
	
	ТаблицаРНПТ = РезультатЗапроса.Выгрузить();
	
	// Зафиксируем данные для заполнения
	Организация = Объект.Организация;
	КонтрагентОперации = Объект.Контрагент;
	
	// Для пересчета валюты в рубли
	ВалютаРегл = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	ВалютаДокумента = Объект.ВалютаДокумента;
	КурсДокумента = Объект.КурсДокумента;
	ВалютаНеРегл = (ВалютаДокумента <> ВалютаРегл);
	
	Для Каждого ТекущаяСтрока Из ТаблицаРНПТ Цикл
		
		НоваяСтрока = ТаблицаОперацииПрослеживаемости.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекущаяСтрока);
		НоваяСтрока.Организация = Организация;
		НоваяСтрока.ПериодОтчета = ПериодОтчета;
		НоваяСтрока.Документ = Документ;
		НоваяСтрока.НомерДокумента = НомерДокумента;
		НоваяСтрока.ДатаДокумента = ДатаДокумента;
		НоваяСтрока.Контрагент = КонтрагентОперации;
		
		// Пересчет суммы
		Если ВалютаНеРегл Тогда
			НоваяСтрока.СуммаБезНДС = Окр(обПересчет(НоваяСтрока.СуммаБезНДС, ВалютаДокумента,
					КурсДокумента, ВалютаРегл, Объект.Дата), 2);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат ТаблицаОперацииПрослеживаемости;
	
КонецФункции

Функция ЗаполнитьНомераСтрокВТаблице(Знач Таблица)
	
	НомераСтрок = Новый Массив();
	НомерСтроки = 1;
	
	Пока НомерСтроки <= Таблица.Количество() Цикл
		
		НомераСтрок.Добавить(НомерСтроки);
		НомерСтроки = НомерСтроки + 1;
		
	КонецЦикла;
	
	Таблица.ЗагрузитьКолонку(НомераСтрок, "НомерСтроки");
	
	Возврат Таблица;
	
КонецФункции

// Определяет возможен ли ввод корректировки на основании данного документа основания.
//
// Параметры:
//	Основание - документ реализации автомобилей или корректировки реализации автомобилей.
//
Функция КорректировкаНеДоступна(Основание) Экспорт
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ИСТИНА КАК ЕстьВозврат
	|ИЗ
	|	Документ.ВозвратОтПокупателяАвтомобилей КАК ТаблицаОбъекта
	|ГДЕ
	|	ТаблицаОбъекта.ДокументОснование = &Основание
	|	И ТаблицаОбъекта.Проведен
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ИСТИНА
	|ИЗ
	|	Документ.ВозвратОтПокупателяАвтомобилей.Автомобили КАК ТаблицаОбъекта
	|ГДЕ
	|	ТаблицаОбъекта.ДокументПродажи = &Основание
	|	И ТаблицаОбъекта.Ссылка.Проведен
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("Основание", Основание);
	
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции // КорректировкаНеДоступна()

#Область ИнформацияОДокументе

//************************//
// ИНФОРМАЦИЯ О ДОКУМЕНТЕ //
//************************//


// Возвращает доступные варианты печати документа
// Параметры:
//	ДокументСсылка - Ссылка на документ печати
// Возвращаемое значение:
//	Структура, каждая строка которой соответствует одному из вариантов печати. Первый элемент структуры - форма по умолчанию
Функция ПолучитьСписокПечатныхФорм(ДокументСсылка) Экспорт
	
	СтруктураМакетов = Новый Структура();
	
	СтруктураМакетов.Вставить("РеализацияАвтомобилей" , "Расходная наклодная");
	СтруктураМакетов.Вставить("УПД"                   , "Универсальный передаточный документ");
	СтруктураМакетов.Вставить("УКД"                   , "Универсальный корректировочный документ");
	
	Возврат СтруктураМакетов;
	
КонецФункции // ПолучитьСписокПечатныхФорм()


#КонецОбласти