Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	ХозОперация=Справочники.ХозОперации.ОплатаВозмещенияПоставщиком;
	Автор=ПараметрыСеанса.Пользователь;
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	НаборЗаписей = РегистрыСведений.тт_Возмещения.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Регистратор.Установить(ЭтотОбъект.Ссылка);
	НаборЗаписей.Очистить();
	
	Для каждого Стр из Скидки Цикл
		
		Если обЗначениеНеЗаполнено(Стр.Автомобиль) Тогда
			Сообщить("В строке № "+Стр.НомерСтроки+" не заполнен Автомобиль! Запись прервана.");
			Отказ=Истина;
		КонецЕсли;
		
		Если обЗначениеНеЗаполнено(Стр.Скидка) Тогда
			Сообщить("В строке № "+Стр.НомерСтроки+" не заполнен Тип скидки! Запись прервана.");
			Отказ=Истина;
		КонецЕсли;
		
		//Проверка, на наличие необходимости оплаты
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	СУММА(ТТ_ОстаткиОплатВозмещенийОстатки.СуммаОстаток) КАК СуммаОстаток
		|ИЗ
		|	РегистрНакопления.ТТ_ОстаткиОплатВозмещений.Остатки(
		|			&Момент,
		|			Автомобиль = &Автомобиль
		|				И ТипСкидки = &ТипСкидки) КАК ТТ_ОстаткиОплатВозмещенийОстатки";
		
		Запрос.УстановитьПараметр("Автомобиль", Стр.Автомобиль);
		Запрос.УстановитьПараметр("Момент", Новый Граница(ЭтотОбъект.Дата, ВидГраницы.Исключая));
		Запрос.УстановитьПараметр("ТипСкидки", Стр.Скидка);
		
		РезультатЗапроса = Запрос.Выполнить();
		Если РезультатЗапроса.Пустой() ИЛИ РезультатЗапроса.Выгрузить()[0].Суммаостаток = 0 Тогда
			Сообщить("Нет остатков сумм к оплате по программе "+Стр.Скидка+". Автомобиль: "+Стр.Автомобиль);
			Отказ=Истина;
			Продолжить;
		КонецЕсли;
		
		Движения.ТТ_ОстаткиОплатВозмещений.Записывать=Истина;
		
		Движ=Движения.ТТ_ОстаткиОплатВозмещений.Добавить();
		Движ.Период=ЭтотОбъект.Дата;
		дВиж.ВидДвижения=ВидДвиженияНакопления.Расход;
		Движ.Автомобиль=Стр.Автомобиль;
		Движ.ТипСкидки=Стр.Скидка;
		Движ.Сумма=Стр.Сумма;
		Движ.СуммаНДС=Стр.СуммаНДС;
		
		
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.Автомобиль = Стр.Автомобиль;
		НоваяЗапись.СтатусВозмещения = Справочники.ТТ_СтатусыВозмещений.Оплата;
		НоваяЗапись.Скидка = Стр.Скидка;
		НоваяЗапись.Период = Ссылка.Дата;
		НоваяЗапись.СуммаВозмещения = Стр.Сумма;
		НоваяЗапись.СуммаНДС = Стр.СуммаНДС;		
		
	КонецЦикла;
	
	НаборЗаписей.Записать(ИСТИНА);

	
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	ХозОперация=Справочники.ХозОперации.ОплатаВозмещенияПоставщиком;
	
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ПодтверждениеВозмещенияПоставщиком")  
		Тогда
		// Заполнение шапки
		Комментарий = ДанныеЗаполнения.Комментарий;
		Контрагент = ДанныеЗаполнения.Контрагент;
		Организация = ДанныеЗаполнения.Организация;
		ПодразделениеКомпании = ДанныеЗаполнения.ПодразделениеКомпании;
		ДокументОснование=ДанныеЗаполнения;
		
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПодтверждениеВозмещенияПоставщикомСкидки.Автомобиль,
		|	ПодтверждениеВозмещенияПоставщикомСкидки.Скидка КАК Скидка,
		|	ПодтверждениеВозмещенияПоставщикомСкидки.Сумма КАК Сумма,
		|	ПодтверждениеВозмещенияПоставщикомСкидки.СуммаНДС КАК СуммаНДС,
		|	ПодтверждениеВозмещенияПоставщикомСкидки.НомерСтроки КАК НомерСтроки
		|ИЗ
		|	Документ.ПодтверждениеВозмещенияПоставщиком.Скидки КАК ПодтверждениеВозмещенияПоставщикомСкидки
		|ГДЕ
		|	ПодтверждениеВозмещенияПоставщикомСкидки.Ссылка = &ДанныеЗаполнения
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки";
		
		Запрос.УстановитьПараметр("ДанныеЗаполнения", ДанныеЗаполнения);
		                                                                                   
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			НоваяСтрока = Скидки.Добавить();
		    ЗаполнитьЗначенияСвойств(НоваяСтрока,ВыборкаДетальныеЗаписи);			
		КонецЦикла;

	КонецЕсли;
	
КонецПроцедуры

