Функция ПроверитьИзменения(Док) Экспорт
	
	Если Док.Ссылка.Пустая() Тогда
		Возврат истина;
	КонецЕсли;
	
	Для Каждого ТекРек из Док.Ссылка.Метаданные().Реквизиты Цикл
		Если Док[ТекРек.Имя]<>Док.Ссылка[ТекРек.Имя] Тогда
			Возврат истина;
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого ТекТЧ из Док.Ссылка.Метаданные().ТабличныеЧасти Цикл
		Если Док[ТекТЧ.Имя].Количество()<>Док.Ссылка[ТекТЧ.Имя].Количество() Тогда
			Возврат истина;
		КонецЕсли;
		Для Каждого ТекСтр из Док[ТекТЧ.Имя] Цикл
			Для Каждого ТекРек из Док.Ссылка.Метаданные().ТабличныеЧасти[ТекТЧ.Имя].Реквизиты Цикл
				Если ТекСтр[ТекРек.Имя]<>Док.Ссылка[ТекТЧ.Имя][ТекСтр.НомерСтроки-1][ТекРек.Имя] Тогда
					Возврат истина;
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
	Возврат ложь;
	
Конецфункции

Функция ПолучитьПлан(ТекПериод,ТекПериодичность,KPI,Сотрудник,Должность,ПК=Неопределено) Экспорт
	
	Если ТипЗнч(KPI)=ТипЗнч(Справочники.KPI.ПустаяСсылка()) Тогда
		Если KPI.НетПлана Тогда
			Возврат 0;
		КонецЕсли;
	Иначе
		Возврат 0;
	КонецЕсли;
	
	Категория = Справочники.КатегорииДолжностейСотрудников.ПустаяСсылка(); 
	Если ТипЗнч(Сотрудник) = Тип("СправочникСсылка.Сотрудники") И не Сотрудник = Справочники.Сотрудники.ПустаяСсылка() Тогда
		Категория = Сотрудник.КатегорияДолжности;
	КонецЕсли;
		
	Запрос=Новый Запрос("ВЫБРАТЬ           
	|	ПлановыеЗначенияKPI.План
	|ИЗ
	|	РегистрСведений.ПлановыеЗначенияKPI.СрезПоследних(&Период, ) КАК ПлановыеЗначенияKPI
	|ГДЕ
	|	ПлановыеЗначенияKPI.Должность = &Должность
	|	И ПлановыеЗначенияKPI.Категория = &Категория
	|	И ПлановыеЗначенияKPI.KPI = &KPI
	|	И ПлановыеЗначенияKPI.Периодичность = &Периодичность
	|	И (ПлановыеЗначенияKPI.ПодразделениеКомпании = &ПодразделениеКомпании
	|			ИЛИ &Все)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ПлановыеЗначенияKPI.Период УБЫВ");
	
	Запрос.УстановитьПараметр("Период",ТекПериод);
	Запрос.УстановитьПараметр("Должность",Сотрудник);
	Запрос.УстановитьПараметр("Категория",Категория);
	Запрос.УстановитьПараметр("KPI",KPI);
	Запрос.УстановитьПараметр("Периодичность",ТекПериодичность);
	
	Если ПК=Неопределено Тогда
		Запрос.УстановитьПараметр("Все",истина);
	Иначе
		Запрос.УстановитьПараметр("Все",ложь);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ПодразделениеКомпании",ПК);
	
	ТЗ=Запрос.Выполнить().Выгрузить();
	
	Если ТЗ.Количество()=0 Тогда
		
		Запрос.УстановитьПараметр("Период",ТекПериод);
		Запрос.УстановитьПараметр("Должность",Должность);
		Запрос.УстановитьПараметр("Категория",Категория);
		Запрос.УстановитьПараметр("KPI",KPI);
		Запрос.УстановитьПараметр("Периодичность",ТекПериодичность);
		Запрос.УстановитьПараметр("ПодразделениеКомпании",ПК);
		
	КонецЕсли;
	
	Выб=Запрос.Выполнить().Выбрать();
	Если Выб.Следующий() ТОгда
		Возврат Выб.План;
	Иначе
		Возврат 0;
	КонецЕсли;
	
КонецФункции
