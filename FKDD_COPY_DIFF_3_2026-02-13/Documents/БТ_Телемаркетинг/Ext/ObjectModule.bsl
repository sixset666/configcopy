
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	БТ_ТелемаркетингКлиенты.Автомобиль КАК Автомобиль,
	                      |	БТ_ТелемаркетингКлиенты.Контрагент КАК Контрагент
	                      |ПОМЕСТИТЬ ВТ_Автомобили
	                      |ИЗ
	                      |	Документ.БТ_Телемаркетинг.Клиенты КАК БТ_ТелемаркетингКлиенты
	                      |ГДЕ
	                      |	БТ_ТелемаркетингКлиенты.Ссылка = &Ссылка
	                      |	И БТ_ТелемаркетингКлиенты.Результат В
	                      |			(ВЫБРАТЬ
	                      |				БТ_СобытияПоРезультатамТМ.Результат КАК Результат
	                      |			ИЗ
	                      |				РегистрСведений.БТ_СобытияПоРезультатамТМ КАК БТ_СобытияПоРезультатамТМ)
	                      |	И НЕ БТ_ТелемаркетингКлиенты.БольшеНеВладелец
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ВТ_Автомобили.Автомобиль КАК Автомобиль,
	                      |	ВТ_Автомобили.Контрагент КАК Контрагент,
	                      |	СобытиеТМ_Автомобили.Ссылка КАК Ссылка
	                      |ИЗ
	                      |	ВТ_Автомобили КАК ВТ_Автомобили
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Событие.ТМ_Автомобили КАК СобытиеТМ_Автомобили
	                      |		ПО ВТ_Автомобили.Автомобиль = СобытиеТМ_Автомобили.Автомобиль
	                      |			И (СобытиеТМ_Автомобили.Ссылка.ДокументОснование = &Ссылка)
	                      |ГДЕ
	                      |	СобытиеТМ_Автомобили.Ссылка ЕСТЬ NULL");
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Пустой", Перечисления.БТ_РезультатыТелемаркетинга.ПустаяСсылка());
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл  
		
		Событие = Документы.Событие.СоздатьДокумент();
		Событие.Автор = автор;
		Событие.Организация = Организация;
		Событие.ПодразделениеКомпании = ПодразделениеКомпании;
		Событие.Автомобиль = Выборка.АВтомобиль;
		Событие.ДокументОснование = Ссылка;
		Событие.ТипСообщения = Перечисления.ТипыСообщений.Исходящее;
		Событие.ВидСобытия = Перечисления.ВидыСобытий.ТелефонныйЗвонок;
		Событие.Контрагент = Выборка.Контрагент;
		Событие.Состояние = Перечисления.СостоянияСобытий.Запланировано;
		Событие.Тема = Ссылка;
		Событие.Дата = ТекущаяДатаСеанса();      
		Событие.Приоритет = Перечисления.Важность.Средняя;
		Событие.ДатаНачала = ДАта + 86400;                
		Событие.ХозОперация = Справочники.ХозОперации.Событие;
		
		СтруктураПоиска = Новый Структура("Автомобиль", Выборка.АВтомобиль);
		
		Если ИспользоватьАР Тогда
			
			АМСтроки = АктивныеРекомендации.НайтиСтроки(СтруктураПоиска);
			
			Для Каждого Строка Из АМСтроки Цикл
				
				НоваяСтрока = Событие.ТМ_АктивныеРекомендации.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);
			КонеЦЦикла;	
			
		КонецЕсли;	
		
		Если ИспользоватьСМ Тогда
			
			СервисныеМероприятияСтроки = СервисныеМероприятия.НайтиСтроки(СтруктураПоиска);
			
			Для Каждого Строка Из СервисныеМероприятияСтроки Цикл
				
				НоваяСтрока = Событие.ТМ_СервисныеМероприятия.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);
				
			КонеЦЦикла;	
		КонецЕсли;	
		
		Если ИспользоватьТО Тогда
			
			СтрокаПоиска = Клиенты.Найти(Выборка.Автомобиль);
			Если СтрокаПоиска <> Неопределено Тогда
				
				НоваяСтрока = Событие.ТМ_Автомобили.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаПоиска);
				НоваяСтрока.БылКонтакт = Истина;
				НоваяСтрока.РезультатКонтакта = СтрокаПоиска.Результат;    
				НоваяСтрока.Пробег = СтрокаПоиска.ПробегПриПоследнемВизите;
				
				ТОСтроки = ТО.НайтиСтроки(СтруктураПоиска);
			
				Для Каждого Строка Из ТОСтроки Цикл
					
					НоваяСтрока = Событие.ТМ_ТО.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);
					
				КонеЦЦикла;	
				
			КонецЕсли;	
		КонецЕсли;	
		
		Событие.Записать(); 
		Сообщить(Событие);
		
	КонецЦикла;	
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	БТ_ТелемаркетингКлиенты.Автомобиль КАК Автомобиль
	                      |ПОМЕСТИТЬ ВТ_Автомобили
	                      |ИЗ
	                      |	Документ.БТ_Телемаркетинг.Клиенты КАК БТ_ТелемаркетингКлиенты
	                      |ГДЕ
	                      |	БТ_ТелемаркетингКлиенты.БольшеНеВладелец
	                      |	И БТ_ТелемаркетингКлиенты.Ссылка = &Ссылка
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	АвтомобилиСрезПоследних.Автомобиль КАК Автомобиль
	                      |ИЗ
	                      |	РегистрСведений.Автомобили.СрезПоследних(
	                      |			,
	                      |			ВидЗначения = &Хозяин
	                      |				И Автомобиль В
	                      |					(ВЫБРАТЬ
	                      |						ВТ_Автомобили.Автомобиль КАК Автомобиль
	                      |					ИЗ
	                      |						ВТ_Автомобили КАК ВТ_Автомобили)) КАК АвтомобилиСрезПоследних
	                      |ГДЕ
	                      |	АвтомобилиСрезПоследних.Значение <> &ПустойКонтрагент");
	Запрос.УстановитьПараметр("Хозяин", Перечисления.ДополнительнаяИнформацияАвтомобилей.Хозяин);
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ПустойКонтрагент", Справочники.Контрагенты.ПустаяСсылка());
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		Мен = РегистрыСведений.Автомобили.СоздатьМенеджерЗаписи();
		Мен.Автомобиль = Выборка.Автомобиль;
		Мен.ВидЗначения = Перечисления.ДополнительнаяИнформацияАвтомобилей.Хозяин;
		Мен.Значение = Справочники.Контрагенты.ПустаяСсылка();
		Мен.Период = ТекущаяДатаСеанса();
		Мен.Записать();
		
	КонецЦикла;	   
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	БТ_ТелемаркетингКлиенты.Автомобиль КАК Автомобиль,
	                      |	БТ_ТелемаркетингКлиенты.ТекущийПробег КАК ТекущийПробег
	                      |ПОМЕСТИТЬ ВТ_Автомобили
	                      |ИЗ
	                      |	Документ.БТ_Телемаркетинг.Клиенты КАК БТ_ТелемаркетингКлиенты
	                      |ГДЕ
	                      |	БТ_ТелемаркетингКлиенты.ТекущийПробег <> 0
	                      |	И БТ_ТелемаркетингКлиенты.Ссылка = &Ссылка
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	АвтомобилиСрезПоследних.Автомобиль КАК Автомобиль,
	                      |	ВТ_Автомобили.ТекущийПробег КАК ТекущийПробег
	                      |ИЗ
	                      |	ВТ_Автомобили КАК ВТ_Автомобили
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Автомобили.СрезПоследних(
	                      |				&Дата,
	                      |				ВидЗначения = &Пробег
	                      |					И Автомобиль В
	                      |						(ВЫБРАТЬ
	                      |							ВТ_Автомобили.Автомобиль КАК Автомобиль
	                      |						ИЗ
	                      |							ВТ_Автомобили КАК ВТ_Автомобили)) КАК АвтомобилиСрезПоследних
	                      |		ПО ВТ_Автомобили.Автомобиль = АвтомобилиСрезПоследних.Автомобиль
	                      |ГДЕ
	                      |	ЕСТЬNULL(АвтомобилиСрезПоследних.Значение, 0) <= ВТ_Автомобили.ТекущийПробег");
	Запрос.УстановитьПараметр("Пробег", Перечисления.ДополнительнаяИнформацияАвтомобилей.Пробег);
	Запрос.УстановитьПараметр("Ссылка", Ссылка);  
	Запрос.УстановитьПараметр("Дата", Дата);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		Мен = РегистрыСведений.Автомобили.СоздатьМенеджерЗаписи();
		Мен.Автомобиль = Выборка.Автомобиль;
		Мен.ВидЗначения = Перечисления.ДополнительнаяИнформацияАвтомобилей.Пробег;
		Мен.Значение = Выборка.ТекущийПробег;
		Мен.Период = НачалоДня(Дата);
		Мен.Записать();
		
	КонецЦикла;	

	
КонецПроцедуры
