//Документы
Процедура ТТ_ПередЗаписьюДокументаПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения) Экспорт
	
	//anton
	//Возврат;	
	//anton
	//Если ТекущаяДата() < Дата(2020,1,1) И НЕ РольДоступна("ПолныеПрава") Тогда
	//	Отказ=Истина;
	//	Сообщить("Работа возможна только с 1 января.");
	//КонецЕсли;
	
	//->Diginova _Настройка базы_ 03.01.2022
	Если Источник.ОбменДанными.Загрузка = Истина тогда
		Возврат;
	КонецЕсли;
	//<-Diginova _FlaiM_ 
	
	//=>Diginova 18.01.22
	Если НЕ Источник.Метаданные().Реквизиты.Найти("ВнешнийОбъект") = Неопределено тогда
		Возврат;
	КонецЕсли;  
	//<= Diginova

	ИмяДокумента=Источник.Метаданные().Имя;
	
	Если ИмяДокумента="ПоступлениеДопРасходовНаАвтомобили" Тогда
		
		ПроверкаДатыДействияДоговораВПоступлениях(Источник, Отказ, РежимЗаписи, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="Выписка" Тогда
		
		ПроверкаЗаполненияВыписка(Источник, Отказ, РежимЗаписи, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ПлатежноеПоручение" Тогда
		
		ПроверкаЗаполненияПлатежноеПоручение(Источник, Отказ, РежимЗаписи, РежимПроведения)
		
	ИначеЕсли ИмяДокумента="ПоступлениеАвтомобилей" Тогда
		
		//ПроверкаЗаполненияПоступлениеАвтомобилей(Источник, Отказ, РежимЗаписи, РежимПроведения);
		
		ПроверкаДатыДействияДоговораВПоступлениях(Источник, Отказ, РежимЗаписи, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ПоступлениеДопРасходов" Тогда
		
		ПроверкаДатыДействияДоговораВПоступлениях(Источник, Отказ, РежимЗаписи, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ПоступлениеТоваров" Тогда
		
		ПроверкаДатыДействияДоговораВПоступлениях(Источник, Отказ, РежимЗаписи, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="Инвентаризация" Тогда
		
		ИнвентаризацияПереопределениеСтатьиСписания(Источник, Отказ, РежимЗаписи, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ЗаявкаНаРасходДС" Тогда
		
		ЗаявкаНаРасходПроверкаЗаполнения(Источник, Отказ, РежимЗаписи, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="РабочийЛистКредитногоОтдела" Тогда
		
		ПроверкаЗаполненияРабочийЛистКредит(Источник, Отказ, РежимЗаписи, РежимПроведения);	
		
	ИначеЕсли ИмяДокумента="РабочийЛистОтделаСтрахования" Тогда
		
		ПроверкаЗаполненияРабочийЛистКредит(Источник, Отказ, РежимЗаписи, РежимПроведения);	
		
	ИначеЕсли ИмяДокумента="ЗаказНаряд" Тогда
		
		Если обПраво("ЗаказНарядАнкетаКИА") Тогда
			Если Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Выполнен Тогда
				Если Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000033") ИЛИ //СКЗ
					Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000034") ИЛИ //СКЗ
					Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000038") ИЛИ //то
					Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000037") Тогда // то
					Если Источник.Автомобиль.Модель.ПринадлежитЭлементу(Справочники.Модели.НайтиПоКоду("ЦБ00000196")) Тогда
						АнкетаКИАОтправлена=обПолучитьЗначениеСвойства(Источник, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Анкета КИА отправлена"),Ложь);
						Если НЕ АнкетаКИАОтправлена Тогда
							обОбщие.АнкетаVoc(Неопределено,Источник,Ложь);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		ПроверкаЗаполненияЗаказНарядПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения);				
		
	ИначеЕсли ИмяДокумента="ЗаявкаНаРемонт" Тогда
		ПроверкаЗаполненияЗаявкаНаРемонтПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения);
	ИначеЕсли ИмяДокумента="РеализацияТоваров" Тогда
		ПроверкаЗаполненияРеализацияТоваровПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения);	
	ИначеЕсли ИмяДокумента="ЧекНаОплату" Тогда
		ПроверкаЗаполненияЧекНаОплату(Источник, Отказ, РежимЗаписи, РежимПроведения);	
	ИначеЕсли ИмяДокумента="Соллерс_АктДистрибьютораПоГарантии" Тогда
		Если НЕ Источник.ЭтоНовый() И Источник.Ссылка.Проведен И НЕ обПраво("РедПроведенногоАктаДистрибьютора") Тогда
			Отказ=Истина;
			Сообщить("Нет прав на редактирование проведенных актов дистрибьютора!");
		КонецЕсли;
	//KamikadZe begin add 12.08.2020 23:02:38
	ИначеЕсли ИмяДокумента="ЗаказПокупателя" Тогда
		обОбщие.обЗаполнитьПользователейДляОповещения(Источник, Отказ, РежимЗаписи, РежимПроведения);	
	//KamikadZe end add	
		
	//<<Павличенко 31.08.2020	
	ИначеЕсли ИмяДокумента = "ПеремещениеТоваровВПроизводство" тогда
		ПроверкаЗаполненияСкладскогоДокумента(Источник, Отказ, РежимЗаписи, РежимПроведения);	
	ИначеЕсли ИмяДокумента = "ИзвлечениеТоваровИзПроизводства" тогда
		ПроверкаЗаполненияСкладскогоДокумента(Источник, Отказ, РежимЗаписи, РежимПроведения);	
	ИначеЕсли ИмяДокумента = "ПеремещениеТоваров" тогда
		ПроверкаЗаполненияСкладскогоДокумента(Источник, Отказ, РежимЗаписи, РежимПроведения);	
	//>>Павличенко 31.08.2020	
	КонецЕсли;
	
	ПроверкаНаГоловныеПодразделения(Источник, Отказ);

КонецПроцедуры

Процедура ТТ_ПриЗаписиДокументаПриЗаписи(Источник, Отказ) Экспорт
	
	//anton
	//Возврат;	
	//anton
	
	ИмяДокумента=Источник.Метаданные().Имя;
	
	//=>Diginova 18.01.22
	Если НЕ Источник.Метаданные().Реквизиты.Найти("ВнешнийОбъект") = Неопределено тогда
		Возврат;
	КонецЕсли;   
	//<= Diginova
	
	//->Diginova _Настройка базы_ 03.01.2022
	Если Источник.ОбменДанными.Загрузка = Истина тогда
		
		Если ИмяДокумента="ЗаказНаряд" И Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт Тогда //<<БАА
			
			АвтодилерВыгрузкаВCRM(Источник, Отказ);
		КонецЕсли;	
		
		Возврат;
	КонецЕсли;
	//<-Diginova _FlaiM_

	
	
	Если ИмяДокумента="РеализацияТоваров" Тогда
		
		ПроверкаЗаполненияРеализацияТоваров(Источник, Отказ);
		
	ИначеЕсли ИмяДокумента="ЗаказНаряд" Тогда
		
		Если Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт Тогда
			
			ПроверкаНаОтбитиеРабот(Источник, Отказ);
			
			УстановкаСкидокПоДК(Источник, Отказ);
			
			ПроверкаДоговораТАС(Источник, Отказ);
			
			ПроверкаНДС(Источник, Отказ);
			
			ПроверкаЗаполненияИРедактирования(Источник, Отказ);
			
			//ПроверкаНомераЗНОрганизация(Источник, Отказ);
			
			АвтодилерВыгрузкаВCRM(Источник, Отказ);
			
		ИначеЕсли Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Заявка Тогда
			
			#Если Клиент Тогда
				Если Источник.ДоговорВзаиморасчетов.ПроцентПредоплаты = 100 Тогда
					Сообщить("У контрагента установлена 100 % предоплата услуг! Проверьте взаиморасчеты на наличие задолженности!");
				КонецЕсли;
			#КонецЕсли
			
		ИначеЕсли Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Выполнен Тогда
			
			Если Источник.ДатаОкончания = Дата(1,1,1) Тогда
				Источник.ДатаОкончания= ТекущаяДата();
			КонецЕсли;
			
		ИначеЕсли Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.НайтиПоКоду("ЦБ00000007") Тогда
	
			Если НЕ РольДоступна("ПолныеПрава")Тогда
				Сообщить("Нет прав на изменение заказ-наряда.");
				Отказ=Истина;
			КонецЕсли;	

			
			
		КонецЕсли;	
		
	ИначеЕсли ИмяДокумента="ЗаявкаНаРемонт" Тогда
		
		Возврат;
		АвтодилерВыгрузкаВCRM(Источник, Отказ);
		
		//Переделать
		//ОповещениеОЗаписиНаРемонт(Источник, Отказ);
		//Переделать
		
	ИначеЕсли ИмяДокумента="ПриходныйКассовыйОрдер" Тогда
		
		ПроверкаПодразделенияТАС(Источник, Отказ);	
		
	ИначеЕсли ИмяДокумента="РасходныйКассовыйОрдер" Тогда
		
		ПроверкаПодразделенияТАС(Источник, Отказ);	
		
	ИначеЕсли ИмяДокумента="РеализацияАвтомобилей" Тогда
		
		ОповещениеОПроведеннойУстановкеДопОборудования(Источник, Отказ);
		
	ИначеЕсли ИмяДокумента="СчетНаОплатуЗаАвтомобили" Тогда
		
		ПроверкаВидДДССчетаНаОплату(Источник, Отказ);
		
	ИначеЕсли ИмяДокумента="СчетНаОплату" Тогда
		
		//ПроверкаВидДДССчетаНаОплату(Источник, Отказ);
		
	ИначеЕсли ИмяДокумента="ЗаказНаАвтомобиль" Тогда
		
		ЗаказНаАвтомобильВозможностьРедактирования(Источник, Отказ);
		
		//Очищаем скидки у удаленных
		Если НЕ Отказ И НЕ Источник.ЭтоНовый() И Источник.ПометкаУдаления Тогда
			РС=РегистрыСведений.тт_СкидкиНаАвтомобиль.СоздатьНаборЗаписей();
			РС.Отбор.Объект.Установить(Источник.Ссылка);
			РС.Записать();
		КонецЕсли;
		
	ИначеЕсли ИмяДокумента="РабочийЛист" Тогда
		
		РабочийЛистПроверкаЗаполнения(Источник, Отказ);
		
	ИначеЕсли ИмяДокумента="РабочийЛистОтделаСтрахования" Тогда
		
		УстановкаДоговораПриЗаписиРабЛистаСтрах(Источник, Отказ);
		
	ИначеЕсли ИмяДокумента="Событие" Тогда
		
		ПроверкаДатыПланирования(Источник, Отказ);	
		
	//bizteh+ 24.05.22г.убрали всё что касается статусов авто.
	//ИначеЕсли ИмяДокумента="ПоступлениеАвтомобилей" Тогда
	//	ИзменениеПраваСобственности(Источник, Отказ);
	//bizteh-
		
	КонецЕсли;
	
	
	
КонецПроцедуры

Процедура ТТ_ОбработкаПроведенияОбработкаПроведения(Источник, Отказ, РежимПроведения) Экспорт

	//=>Diginova 18.01.22
	Если НЕ Источник.Метаданные().Реквизиты.Найти("ВнешнийОбъект") = Неопределено тогда
		Возврат;
	КонецЕсли;  
	//<= Diginova
	
	//anton
	//Возврат;	
	//anton
	
	ИмяДокумента=Источник.Метаданные().Имя;
	
	Если ИмяДокумента="ПоступлениеАвтомобилей" Тогда
		//bizteh+ Закомментировала проверку статуса авто и тд.
		//ИзменениеПраваСобственностиПроверка(Источник, Отказ, РежимПроведения); 
		//bizteh-
		ПроверитьНаУстановкуЦенПоTradeIn(Источник, Отказ, РежимПроведения);		
		ПоступАвтПриПроведПСО(Источник, Отказ, РежимПроведения);
		//ПроверитьЗаполнениеКвоты(Источник, Отказ, РежимПроведения);	
		ПроверкаВладельцаАвтоКомиссия(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ПеремещениеАвтомобилей" Тогда
		
		//ИзменениеПраваСобственности(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ЗаявкаНаРасходДС" Тогда		
		
		ПроверкаПроведенияЗаявкаНаРасходДС(Источник, Отказ, РежимПроведения);
		
		ОтразитьДвиженияТТ_ФактПоУтвержденнымЗаявкамДС(Источник, Отказ, РежимПроведения);
		//bizteh+ Закомментировала всё, что касается статусов авто
		//УстановитьСтатусОплатыАвтомобиля(Источник, Отказ, РежимПроведения);
		//bizteh-
	ИначеЕсли ИмяДокумента="ЗаявкаНаРемонт" Тогда
		
		СозданиеДоговораЗаявкаНаРемонт(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ЗаказНаряд" Тогда
		//<<Павличенко 14.09.2020
		ПроверкаДопТАКТАС(Источник, Отказ, РежимПроведения);
		//>>Павличенко 14.09.2020
		
		ПроверкаТиповРемонта(Источник, Отказ, РежимПроведения);
		
		ПроверкаНаВнутреннегоКонтрагента(Источник, Отказ, РежимПроведения);
		
		ПроверкаДолгаКонтрагента(Источник, Отказ, РежимПроведения);
		
		//<<Павличенко 30.03.2020
		ПроверкаВидовРемонтаБесплатных(Источник,Отказ, РежимПроведения);
		//>>Павличенко 30.03.2020
		СоздатьПоступлениеДопРасходовНаАвтомобили(Источник, Отказ, РежимПроведения);
		
		СоздатьУслугиСтороннихОрганизаций(Источник, Отказ, РежимПроведения);
		
		ПроверкаОрганизацииЗНПеремещение(Источник, Отказ, РежимПроведения);
		
		ПроверкаОбязательногоТюнинга(Источник, Отказ, РежимПроведения);
		
		ПроверкаНомераАктаГР(Источник, Отказ, РежимПроведения);
		//Выгрузка в Автодилер - отключено до разделения по организацям.
		АвтодилерВыгрузкаВCRM_Дилерский(Источник, Отказ, РежимПроведения);
		
		ПроверкаНаНДС(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ПоступлениеДопРасходовНаАвтомобили" Тогда
		
		//ПроверкаНаСтатусВыкуплен(Источник, Отказ, РежимПроведения); //Переделать на новый механизм
		
		ПроверкаЗаполненияПоступлениеДопРасходовНаАвтомобили(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ПоступлениеДопРасходов" Тогда
		
		ПроверкаСпособаРаспределения(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="Выписка" Тогда
		
		//ПроверкаСтатьиДиР(Источник, Отказ, РежимПроведения);	
		УстановкаВидДоговораДДСКредитСтрахование(Источник, Отказ, РежимПроведения); 
		//БизТех 10.11.2022г. добавляем создание Взаимозачета по КСО <<
		Если Источник.ДоговорВзаиморасчетов.ТипДоговора = Перечисления.ТипыДоговоров.ВиртуальныйДоговор и Источник.Дата > Дата('20221001') Тогда
			Создать_Записать_Взаимозачет(Источник,1);
		КонецЕсли;
		//БизТех 10.11.2022г.  >>		
	ИначеЕсли ИмяДокумента="РеализацияАвтомобилей" Тогда	
		//<<Павличенко 30.03.2020 : письмо Ситникова, заявка Черкашиной
		Если НЕ РольДоступна("ПроведениеРеализацииАвто") тогда
			сообщить("Право на  проведение документов Реализация Автомобилей отсутствует!");
			Отказ = Истина;
			Возврат;
		КонецЕсли;	
		//>>Павличенко 30.03.2020
		ДвиженияПоВозмещению(Источник, Отказ, РежимПроведения);		
		
		НеПроверятьЗаказ = Ложь;
		Если НЕ Источник.ДополнительныеСвойства.Свойство("НеПроверятьЗаказ",НеПроверятьЗаказ) Тогда
			НеПроверятьЗаказ = Ложь;
		КонецЕсли;
		
		Если НЕ НеПроверятьЗаказ Тогда
			
			ПроверкаНеЗакрытыхЗН(Источник, Отказ, РежимПроведения);
			
			ПроверкаДолга(Источник, Отказ, РежимПроведения);
			
			ДвиженияПоСтатусам(Источник, Отказ);
			
			ПроверкаНаЛизинг (Источник, Отказ);
			
		КонецЕсли;
		
		//ПроверкаПСО(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ПеремещениеТоваров" Тогда
		
		ПроверкаКорректностиПеремещения(Источник, Отказ, РежимПроведения);
		
		ПроверкаОстатковПоОрганизации(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ПеремещениеТоваровВПроизводство" Тогда
		
		ПроверкаОстатковПоОрганизации(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="РеализацияТоваров" Тогда
		
		ПроверкаОстатковПоОрганизации(Источник, Отказ, РежимПроведения);
		
		ПроверкаРабЛистКСО(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ПоступлениеТоваров" Тогда
		
		
		ПроверкаПоступленияНеликвидов(Источник, Отказ, РежимПроведения);
		
		ПроверкаЗаполненияЯчейки(Источник, Отказ, РежимПроведения);
		
	ИначеЕсли ИмяДокумента="ВозвратОтПокупателяАвтомобилей" Тогда
		
		//ИзменениеПраваСобственностиПроверкаВозврат(Источник, Отказ, РежимПроведения);
		ДвиженияПоСтатусам(Источник, Отказ);
		
		//<<Павличенко 17.09.2020
	ИначеЕсли ИмяДокумента = "ПриходныйКассовыйОрдер" и Источник.Дата > Дата('20221102') тогда
		Если ТипЗНЧ(Источник.ДокументОснование) = ТИП("ДокументСсылка.РабочийЛистОтделаСтрахования") 
			//БизТех 02.11.2022г. добавлено для Реализации фин услуг <<
			ИЛИ (ТипЗНЧ(Источник.ДокументОснование) = ТИП("ДокументСсылка.РеализацияТоваров") 
			ИЛИ ТипЗНЧ(Источник.ДокументОснование) = ТИП("ДокументСсылка.СчетНаОплату")      //БизТех Аляль 29.07.2025г.
			и ТипЗНЧ(Источник.ДокументОснование.ДокументОснование) = ТИП("ДокументСсылка.РабочийЛистОтделаСтрахования"))  тогда
			//БизТех >>
			Создать_Записать_Взаимозачет(Источник,1);
		КонецЕсли;
		//>>Павличенко 17.09.2020
	//<<Павличенко 21.09.2020
	ИначеЕсли ИмяДокумента = "ЧекНаОплату" и Источник.Дата > Дата('20221102') тогда
		Если ТипЗНЧ(Источник.ДокументОснование) = ТИП("ДокументСсылка.РабочийЛистОтделаСтрахования") 
			//БизТех 02.11.2022г. добавлено для Реализации фин услуг <<
			ИЛИ (ТипЗНЧ(Источник.ДокументОснование) = ТИП("ДокументСсылка.РеализацияТоваров") 
			и ТипЗНЧ(Источник.ДокументОснование.ДокументОснование) = ТИП("ДокументСсылка.РабочийЛистОтделаСтрахования"))  
			ИЛИ (ТипЗНЧ(Источник.ДокументОснование) = ТИП("ДокументСсылка.ЧекНаОплату") 
			И ТипЗНЧ(Источник.ДокументОснование.ДокументОснование) = ТИП("ДокументСсылка.РеализацияТоваров")) Тогда //БизТех 30.06.2025г. отменить предыдущий взаимозачеттогда
			//БизТех >>
			Создать_Записать_Взаимозачет(Источник,1); 
		КонецЕсли;  
		//>>Павличенко 21.09.2020 
	КонецЕсли;
	
	
	//----------------Общие проверки-----начало-----
	
	ПроверкаСоответствияОрганизации(Источник, Отказ, РежимПроведения);	
	
	Если ТТ_Общий.ЕстьРеквизитОбъекта("ДоговорВзаиморасчетов", Источник) 
		И НЕ обЗначениеНеЗаполнено(Источник.ДоговорВзаиморасчетов) 
		И ИмяДокумента <> "ЗаявкаНаРемонт" Тогда
		ПроверкаВидДоговораДДС(Источник, Отказ, РежимПроведения, Источник.ДоговорВзаиморасчетов);
	ИначеЕсли Источник.Метаданные().Имя = "Взаимозачет" тогда
		Для каждого Стр из Источник.Состав цикл
			ПроверкаВидДоговораДДС(Источник, Отказ, РежимПроведения, Стр.ДоговорВзаиморасчетовДебитор);
			ПроверкаВидДоговораДДС(Источник, Отказ, РежимПроведения, Стр.ДоговорВзаиморасчетовКредитор);
		КонецЦикла;
	ИначеЕсли Источник.Метаданные().Имя = "КорректировкаДолга" тогда	
		Для каждого Стр из Источник.Состав цикл
			ПроверкаВидДоговораДДС(Источник, Отказ, РежимПроведения, Стр.ДоговорВзаиморасчетов);
		КонецЦикла;
	КонецЕсли;
	
	//ПроверкаЗаполненияСтатьиДДСУпр(Источник, Отказ, РежимПроведения);	
	
	ПроверкаЗаполненияЦФО(Источник, Отказ, РежимПроведения); 
	
	ДокПродажиПроверкаТипаДоговора(Источник, Отказ, РежимПроведения);
	
	//----------------Общие проверки-----конец-----
	
	
КонецПроцедуры

Процедура ТТ_ОбработкаУдаленияПроведенияОбработкаУдаленияПроведения(Источник, Отказ) Экспорт

	//=>Diginova 18.01.22
	Если НЕ Источник.Метаданные().Реквизиты.Найти("ВнешнийОбъект") = Неопределено тогда
		Возврат;
	КонецЕсли;   
	//<= Diginova
	
	ИмяДокумента=Источник.Метаданные().Имя;
	
	Если ИмяДокумента="ЗаявкаНаРасходДС" Тогда
		Источник.СтатусТТ = Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.Заявка;
		
	//<<Павличенко 30.03.2020: письмо Ситникова, заявка Черкашиной	
	ИначеЕсли ИмяДокумента="РеализацияАвтомобилей" Тогда	
		
		Если НЕ РольДоступна("ПроведениеРеализацииАвто") тогда
			сообщить("Право на снятие проведения документов Реализация Автомобилей отсутствует!");
			Отказ = Истина;
			Возврат;
		КонецЕсли;	
	//>>30.03.2020
	//<<Павличенко 17.09.2020
	ИначеЕсли ИмяДокумента = "ПриходныйКассовыйОрдер" и Источник.Дата > Дата('20221102') тогда
		Если ТипЗНЧ(Источник.ДокументОснование) = ТИП("ДокументСсылка.РабочийЛистОтделаСтрахования") 
			ИЛИ  ЗначениеЗаполнено(Источник.ДокументОснование) и ТипЗНЧ(Источник.ДокументОснование.ДокументОснование) =  ТИП("ДокументСсылка.РабочийЛистОтделаСтрахования") тогда
			Создать_Записать_Взаимозачет(Источник,2);
		КонецЕсли;
	//>>Павличенко 17.09.2020
	//<<Павличенко 21.09.2020
	ИначеЕсли ИмяДокумента = "ЧекНаОплату" и Источник.Дата > Дата('20221102') тогда
		Если ТипЗНЧ(Источник.ДокументОснование) = ТИП("ДокументСсылка.РабочийЛистОтделаСтрахования") 
			ИЛИ ЗначениеЗаполнено(Источник.ДокументОснование) и ТипЗНЧ(Источник.ДокументОснование.ДокументОснование) =  ТИП("ДокументСсылка.РабочийЛистОтделаСтрахования") тогда
			Создать_Записать_Взаимозачет(Источник,2);
		КонецЕсли;
	//>>Павличенко 21.09.2020 
	//Бизтех 10.11.2022г. <<
	ИначеЕсли ИмяДокумента = "Выписка" и Источник.Дата > Дата('20221102') тогда
		Если Источник.ДоговорВзаиморасчетов.ТипДоговора = Перечисления.ТипыДоговоров.ВиртуальныйДоговор тогда
			Создать_Записать_Взаимозачет(Источник,2);
		КонецЕсли;  
	//Бизтех 10.11.2022г. >>
	КонецЕсли;
КонецПроцедуры

Процедура ТТ_ОбработкаЗаполненияОбработкаЗаполнения(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина) Экспорт

	//=>Diginova 18.01.22
	Если НЕ Источник.Метаданные().Реквизиты.Найти("ВнешнийОбъект") = Неопределено тогда
		Возврат;
	КонецЕсли;   
	//<= Diginova
	
	ИмяДокумента=Источник.Метаданные().Имя;
	
	//Если ДанныеЗаполнения = Неопределено Тогда Возврат; КонецЕсли;
	
	Если ИмяДокумента="РеализацияТоваров" Тогда
		
		ОбработкаЗаполненияРеализацияТоваров(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		
	ИначеЕсли ИмяДокумента="ПоступлениеАвтомобилей" Тогда
		
		ОбработкаЗаполненияПоступлениеАвтомобилей(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		
	ИначеЕсли ИмяДокумента="ПлатежноеПоручение" Тогда
		
		ОбработкаЗаполненияПлатежноеПоручение(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		
	ИначеЕсли ИмяДокумента="ПриходныйКассовыйОрдер" Тогда
		
		ОбработкаЗаполненияПКО(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		ОбработкаЗаполненияККМ(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		
	ИначеЕсли ИмяДокумента="РасходныйКассовыйОрдер" Тогда
		
		ОбработкаЗаполненияРКО(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		ОбработкаЗаполненияККМ(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		
	ИначеЕсли ИмяДокумента="ЗаказНаряд" Тогда
		
		ОбработкаЗаполненияЗаказНаряд(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		
	ИначеЕсли ИмяДокумента="СчетНаОплату" Тогда
		
		ОбработкаЗаполненияСчетНаОплату(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		
	ИначеЕсли ИмяДокумента="Событие" Тогда
		
		Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.Опрос") Тогда
			Источник.Содержание =ДанныеЗаполнения.Комментарий; 	
		КонецЕсли;	
		
		Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.РабочийЛист")
			И ЗначениеЗаполнено(ДанныеЗаполнения.Автомобиль)
			Тогда
			НовСтр=Источник.Автомобили.Добавить();
			НовСтр.Автомобиль=ДанныеЗаполнения.Автомобиль;
			НовСтр.Количество=1;
		КонецЕсли;	
		
	ИначеЕсли ИмяДокумента="РабочийЛистКредитногоОтдела" Тогда
		
		ОбработкаЗаполненияРабочийЛистКредитногоОтдела(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);	
		
	ИначеЕсли ИмяДокумента="РабочийЛистОтделаСтрахования" Тогда
		
		ОбработкаЗаполненияРабочийЛистОтделаСтрахования(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);	
		
	ИначеЕсли ИмяДокумента="ЧекНаОплату" Тогда
		
		ОбработкаЗаполненияЧекНаОплату(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);	
		
	ИначеЕсли ИмяДокумента="Выписка" Тогда		
		
		ОбработкаЗаполненияККМ(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		
	ИначеЕсли ИмяДокумента="СчетФактураПолученный" Тогда		
		
		ОбработкаЗаполненияСчетФактураПолученный(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
		
	ИначеЕсли ИмяДокумента="РабочийЛист" Тогда
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ТТ_ПриКопированииДокументыПриКопировании(Источник, ОбъектКопирования) Экспорт
	Попытка
		Источник.ОбработкаЗначенияСвойствОбъектов = Неопределено;
	Исключение
	КонецПопытки;
КонецПроцедуры

Процедура ТТ_ПередЗаписьюСправочникаПередЗаписью(Источник, Отказ) Экспорт
	
	//anton
	//Возврат;	
	//anton

	//=>Diginova 18.01.22
	Если НЕ Источник.Метаданные().Реквизиты.Найти("ВнешнийОбъект") = Неопределено тогда
		Возврат;
	КонецЕсли;  
	//<= Diginova
	
	ИмяСправочника=Источник.Метаданные().Имя;
	
	Если ИмяСправочника="ДоговорыВзаиморасчетов" Тогда
		
		ПроверкаОрганизацииДоговор(Источник, Отказ);
		
		РедактированиеДоговоровПоставка(Источник, Отказ);
		
		ЗаполнениеНомераДоговора(Источник, Отказ);
		
		//<<Павличенко 21.07.2020
		ПроверкаСоответствияВидаДвиженияСДДС(Источник, Отказ);
		//>>Павличенко 21.07.2020
		
	ИначеЕсли ИмяСправочника="Контрагенты" Тогда
		
		ПроверкаНаДубли(Источник, Отказ);
		
	КонецЕсли;
	
	ПроверкаНаГоловныеПодразделения(Источник, Отказ);
	
КонецПроцедуры

//Справочники
Процедура ТТ_ПриЗаписиСправочникаПриЗаписи(Источник, Отказ) Экспорт

	//=>Diginova 18.01.22
	Если НЕ Источник.Метаданные().Реквизиты.Найти("ВнешнийОбъект") = Неопределено тогда
		Возврат;
	КонецЕсли;   
	//<= Diginova
	
	//->Diginova _Настройка базы_ 03.01.2022
	Если Источник.ОбменДанными.Загрузка = Истина тогда
		Возврат;
	КонецЕсли;
	//<-Diginova _FlaiM_

	ИмяСправочника=Источник.Метаданные().Имя;
	
	ПроверкаНаНаличиеРодителя(Источник, Отказ);	
	
	Если ИмяСправочника="Номенклатура" Тогда
		
		НоменклатураПроверкаЗаполнения(Источник, Отказ);
		
	ИначеЕсли ИмяСправочника="ДоговорыВзаиморасчетов" Тогда
		
		ПроверкаЗаполненияГИ(Источник, Отказ);	
		
	ИначеЕсли ИмяСправочника="Карточки" Тогда
		
		УстановкаРодителяДК(Источник, Отказ);	
		
	КонецЕсли;
	
КонецПроцедуры

//Регистры сведений
Процедура ТТ_ПередЗаписьюРегистрыСведенийПередЗаписью(Источник, Отказ, Замещение) Экспорт
	
	//->Diginova _Настройка базы_ 03.01.2022
	Если Источник.ОбменДанными.Загрузка = Истина тогда
		Возврат;
	КонецЕсли;
	//<-Diginova _FlaiM_

	ИмяРС=Источник.Метаданные().Имя;
	
	Если ИмяРС="ЗначенияСвойствОбъектов" Тогда 
		Для Каждого Запись Из Источник Цикл
			Если Запись.Свойство = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Гарантийное письмо") Тогда
				СтароеЗначение=обПолучитьЗначениеСвойства(Запись.Объект, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Гарантийное письмо"), 0);
				Если Запись.Значение <> СтароеЗначение И НЕ обПраво("РедСвойстваГарантийноеПисьмо") Тогда
					Сообщить("Нет прав на редактирование свойства ""Гарантийное письмо""");
					Отказ=Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Если ИмяРС="ГраницыАвтомобили" Тогда
		Для Каждого Запись Из Источник Цикл
			Запись.Организация=Запись.СкладКомпании.Организация;
			Источник.Отбор.Организация.Установить(Запись.Организация);
		КонецЦикла;
	ИначеЕсли ИмяРС="ГраницыАвтомобилиОрдерныйСклад" Тогда
		Для Каждого Запись Из Источник Цикл
			Запись.Организация=Запись.СкладКомпании.Организация;		
			Источник.Отбор.Организация.Установить(Запись.Организация);
		КонецЦикла;
	ИначеЕсли ИмяРС="ГраницыВзаиморасчетов" Тогда
		Для Каждого Запись Из Источник Цикл
			Запись.Организация=Запись.ДоговорВзаиморасчетов.Организация;		
			Источник.Отбор.Организация.Установить(Запись.Организация);
		КонецЦикла;
	ИначеЕсли ИмяРС="ГраницыЗаказы" Тогда
		Для Каждого Запись Из Источник Цикл
			Запись.Организация=Запись.Заказ.Организация;		
			Источник.Отбор.Организация.Установить(Запись.Организация);
		КонецЦикла;
		//ИначеЕсли ИмяРС="ГраницыЗаказыНаАвтомобили" Тогда
		//	Для Каждого Запись Из Источник Цикл
		//		Если ЗначениеЗаполнено(Запись.ДокументСсылка) Тогда
		//			Запись.Организация=Запись.ДокументСсылка.Организация;		
		//			Источник.Отбор.Организация.Установить(Запись.Организация);
		//		КонецЕсли;
		//	КонецЦикла;
		//ИначеЕсли ИмяРС="ГраницыКомплектация" Тогда
		//	Для Каждого Запись Из Источник Цикл
		//		Если ЗначениеЗаполнено(Запись.ДокументСсылка) Тогда
		//			Запись.Организация=Запись.ДокументСсылка.Организация;		
		//			Источник.Отбор.Организация.Установить(Запись.Организация);
		//		КонецЕсли;
		//	КонецЦикла;
	ИначеЕсли ИмяРС="ГраницыОрдерныйСклад" Тогда
		Для Каждого Запись Из Источник Цикл
			Запись.Организация=Запись.СкладКомпании.Организация;		
			Источник.Отбор.Организация.Установить(Запись.Организация);
		КонецЦикла;
	ИначеЕсли ИмяРС="ГраницыПартий" Тогда
		Для Каждого Запись Из Источник Цикл
			Запись.Организация=Запись.СкладКомпании.Организация;		
			Источник.Отбор.Организация.Установить(Запись.Организация);
		КонецЦикла;
	ИначеЕсли ИмяРС="ГраницыПроизводство" Тогда
		Для Каждого Запись Из Источник Цикл
			Запись.Организация=Запись.ЗаказНаряд.Организация;		
			Источник.Отбор.Организация.Установить(Запись.Организация);
		КонецЦикла;  
	//БИЗТЕХ 22.11.2023++ 
	ИначеЕсли ИмяРС="СостоянияКодовМаркировки" Тогда
		Для Каждого Запись Из Источник Цикл
			Запись.Организация=Запись.ДокументОснование.Организация;		
			Источник.Отбор.Организация.Установить(Запись.Организация);
		КонецЦикла; 
	//БИЗТЕХ 22.11.2023--
	КонецЕсли;
	
	//anton
	Возврат;	
	//anton
	
	
КонецПроцедуры


//-----------Вспомогательные процедуры-------------
//<<Павличенко 31.08.2020
Процедура ПроверкаЗаполненияСкладскогоДокумента(Источник, Отказ, РежимЗаписи, РежимПроведения)
	ГибкиеНастройки = Справочники.тт_СписокПараметров.НайтиПоКоду("000013705");
	Если ГибкиеНастройки= Неопределено тогда
		Возврат;
	КонецЕсли;
	ПараметрыОтбора = Новый Структура();
	ПараметрыОтбора.Вставить("Параметр1", Источник.Метаданные().Имя);
	ПараметрыОтбора.Вставить("ЗначениеПараметра", Источник.СкладКомпании);
	ПараметрыОтбора.Вставить("Параметр2", ПараметрыСеанса.Пользователь);
	МассивВозвратПоИмени = ГибкиеНастройки.СписокПараметров.НайтиСтроки(ПараметрыОтбора);
	
	МассивВозвратПеремещениеТоваровНаСклад = Новый Массив();
	
	Если Источник.Метаданные().Имя = "ПеремещениеТоваров"тогда
		ПараметрыОтбора = Новый Структура();
		ПараметрыОтбора.Вставить("Параметр1", "ПеремещениеТоваровНаСклад");
		ПараметрыОтбора.Вставить("ЗначениеПараметра", Источник.СкладПолучатель);
		ПараметрыОтбора.Вставить("Параметр2", ПараметрыСеанса.Пользователь);
		МассивВозвратПеремещениеТоваровНаСклад = ГибкиеНастройки.СписокПараметров.НайтиСтроки(ПараметрыОтбора);
	КонецЕсли;	
	
	Если (МассивВозвратПоИмени.Количество() = 0) И (МассивВозвратПеремещениеТоваровНаСклад.Количество() = 0) тогда
		Возврат;
	КонецЕсли;
	
	Для каждого ЭлементМассив из МассивВозвратПоИмени цикл
		Если НЕ ЭлементМассив.Параметр3 тогда
		    Сообщить("У Вас недостаточно прав для работы со складом компании " + Источник.СкладКомпании);
			Отказ = Истина;
		КонецЕсли;
		
	КонецЦикла;
	Для каждого ЭлементМассив из МассивВозвратПеремещениеТоваровНаСклад цикл
		Если НЕ ЭлементМассив.Параметр3 тогда
			Сообщить("У Вас недостаточно прав для работы со складом компании " + Источник.СкладПолучатель);
			Отказ = Истина;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
//>>Павличенко 31.08.2020

//<<Павличенко 21.07.2020
Процедура ПроверкаСоответствияВидаДвиженияСДДС(Источник, Отказ)
		Если НЕ обЗначениеНеЗаполнено(Источник.СтатьяДДС) Тогда
			Если Источник.СтатьяДДС.ВидДвижения <> Перечисления.ВидыДвижений.Расход тогда
				Сообщить("В статье ДДС расход должна быть указана статья с видом движения ден. средств расход!" );
				Отказ = Истина;
			КонеЦесли;
		КонецЕсли;
		
		Если НЕ обЗначениеНеЗаполнено(Источник.СтатьяДДСПриход) Тогда
			Если Источник.СтатьяДДСПриход.ВидДвижения <> Перечисления.ВидыДвижений.Приход тогда
				Сообщить("В статье ДДС приход должна быть указана статья с видом движения ден. средств приход!" );
				Отказ = Истина;
			КонеЦесли;
		КонецЕсли;

КонецПроцедуры


//-----------Вспомогательные процедуры-------------

Процедура ПроверкаСтатьиДиР(Источник, Отказ, РежимПроведения)
	#Если Клиент Тогда
		Если обЗначениеНеЗаполнено(Источник.СтатьяДоходовИРасходов) Тогда
			Сообщить("Запись прервана! Не заполнена Статья доходов и расходов.");
			Отказ=Истина;
		КонецЕсли;
	#КонецЕсли
КонецПроцедуры

Процедура УстановкаРодителяДК(Источник, Отказ)
	#Если Клиент Тогда
		
		Если РольДоступна("ПолныеПрава") ИЛИ  обПраво("ИзменениеДискКарт") Тогда	
			Если Источник.Родитель = Справочники.Карточки.НайтиПоНаименованию("Чистые карты")И НЕ обЗначениеНеЗаполнено( Источник.Объект) Тогда
				Источник.Родитель = Справочники.Карточки.НайтиПоНаименованию("Выданные карты");
			ИначеЕсли Источник.Родитель = Справочники.Карточки.НайтиПоНаименованию("Золотые карты")И НЕ обЗначениеНеЗаполнено( Источник.Объект) Тогда
				Источник.Родитель = Справочники.Карточки.НайтиПоНаименованию("Золотые картыВ",,Справочники.Карточки.НайтиПоНаименованию("Выданные карты"));
			КонецЕсли;
		Иначе	
			Отказ=Истина;
			Сообщить("Нет прав на редактирование.");
		КонецЕсли;
		
	#КонецЕсли
	
КонецПроцедуры


//-----------Вспомогательные процедуры-------------
Процедура ПроверкаНаГоловныеПодразделения(Источник, Отказ)
	
	Если ТТ_Общий.ЕстьРеквизитОбъекта("ПодразделениеКомпании", Источник) Тогда
		Если Источник.ПодразделениеКомпании = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000151")
			ИЛИ Источник.ПодразделениеКомпании = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000171")
			ИЛИ Источник.ПодразделениеКомпании = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000100")
			Тогда      
			Сообщить("Нельзя выбирать головное подразделение! Выберите конкретное.");
			Отказ=Истина;
		КонецЕсли;	
	КонецЕсли;
	
	Если ТТ_Общий.ЕстьРеквизитОбъекта("Подразделение", Источник) Тогда
		Если Источник.Подразделение = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000151")
			ИЛИ Источник.Подразделение = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000171")
			ИЛИ Источник.Подразделение = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000100")
			Тогда      
			Сообщить("Нельзя выбирать головное подразделение! Выберите конкретное.");
			Отказ=Истина;
		КонецЕсли;	
	КонецЕсли;

КонецПроцедуры

Процедура АвтодилерВыгрузкаВCRM_Дилерский(Источник, Отказ, РежимПроведения)
	//Возврат;
	Если Отказ Тогда 
		Возврат;
	КонецЕсли;
	РодительМодели = ТТ_Общий.ПолучитьБрэнд(Источник.Автомобиль.Модель);
	Если Найти(РодительМодели, "FORD")>0 или Найти(РодительМодели, "FORD") тогда
		Если обПраво("АвтодилерВыгрузкаВCRM_FORD") Тогда
			Если Источник.Организация.ИНН = "2312205455"  тогда //ФКДД
				УспешноОтправлен=АСРМ_DSFСервис_ПротоколПодключения.ПередатьЗаказНаряд(Источник.Ссылка, Перечисления.ACPM_Портал.FORD);
				Если НЕ УспешноОтправлен Тогда
					Сообщить("Произошла ошибка при отправке заказ наряда в DSF. Попробуйте отправить его позже " + Строка(ТекущаяДата()));
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли   Найти(РодительМодели, "UAZ")>0 или Найти(РодительМодели, "УАЗ")  тогда
		Если обПраво("АвтодилерВыгрузкаВCRM_УАЗ") Тогда
			УспешноОтправлен=АСРМ_DSFСервис_ПротоколПодключения.ПередатьЗаказНаряд(Источник.Ссылка, Перечисления.ACPM_Портал.УАЗ);
			Если НЕ УспешноОтправлен Тогда
				Сообщить("Произошла ошибка при отправке заказ наряда в DSF. Попробуйте отправить его позже " + Строка(ТекущаяДата()));
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры

Процедура ЗаполнениеНомераДоговора(Источник, Отказ)
	
	Если Источник.ЭтоНовый() Тогда
		Если обПраво("СистемаНумерацииДоговоровТТ") Тогда
			Отказ = Справочники.тт_ВидыДоговоров.ЗаполнитьНомерДоговора(Источник,Отказ);
		КонецЕсли;	
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьЗначениеСкидки(Карточка,ДатаДокумента)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	|	СкидкиШапкиСрезПоследних.ЗначениеСкидки
	|ИЗ
	|	РегистрСведений.СкидкиШапки.СрезПоследних(&ДатаДокумента, ДисконтнаяКарта = &ДисконтнаяКарта) КАК СкидкиШапкиСрезПоследних";
	Запрос.УстановитьПараметр("ДисконтнаяКарта", Карточка);
	Запрос.УстановитьПараметр("ДатаДокумента", ДатаДокумента);	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда 	
		Возврат Выборка.ЗначениеСкидки;
	КонецЕсли;
	
	Возврат 0;
	
КонецФункции

Процедура СоздатьДокументСкидок(ДатаНачала,Скидка,ДискКарта,ЗначениеСкидки)
	
	Док = Документы.НазначениеСкидокШапки.СоздатьДокумент();
	Док.ОбработкаЗаполнения(Неопределено);
	Док.ДатаНачалаДействия = ДатаНачала;// дата начала скидки
	Док.ХозОперация=Справочники.ХозОперации.УстановкаСкидкиНаДокумент;	
	Док.Дата = ТекущаяДата();
	
	НоваяСтрока = Док.Скидки.Добавить();
	
	НоваяСТрока.Скидка = Скидка;// ссылка на тип скидки
	НоваяСтрока.ДисконтнаяКарта = ДискКарта;// ссылка на карту
	НоваяСтрока.ЗначениеСкидки = ЗначениеСкидки;//  числовое значение
	НоваяСтрока.СкидкаНаРаботы = Истина;
	НоваяСтрока.СкидкаНаТовары = Истина;
	НоваяСтрока.НачВремя = ДАТА(1,1,1); 
	НоваяСтрока.КонВремя = ДАТА(1,1,1,23,59,59);
	НоваяСтрока.ДниНедели = "1111111";	
	
	Попытка	
		Док.Записать(РежимЗаписиДокумента.Проведение);
	Исключение
		Сообщить(ОписаниеОшибки());		
	КонецПопытки;
КонецПроцедуры

Процедура ПроверкаВидДДССчетаНаОплату(Источник, Отказ) Экспорт
		
	Если Источник.Дата < Дата(2014, 1, 1) Тогда 
		Возврат;
	КонецЕсли;	
	
	Если РольДоступна("ПолныеПрава") Тогда 
		Возврат;
	КонецЕсли;	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЗначенияСвойствОбъектов.Объект,
	|	ЗначенияСвойствОбъектов.Свойство,
	|	ЗначенияСвойствОбъектов.Значение
	|ИЗ
	|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|ГДЕ
	|	ЗначенияСвойствОбъектов.Объект = &Объект
	|	И ЗначенияСвойствОбъектов.Свойство = &Свойство";
	
	
	СвойствоДДС = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Вид договора ДДС");	
	СвойствоАвто = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Авто", Истина,, СвойствоДДС);
	СвойствоСервис = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Сервис", Истина,, СвойствоДДС);
	СвойствоЗапчасти = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Запчасти", Истина,, СвойствоДДС);
	СвойствоНеИсп = Справочники.ЗначенияСвойств.НайтиПоНаименованию("не используется", Истина,, СвойствоДДС);
	СвойствоМКУ = Справочники.ЗначенияСвойств.НайтиПоНаименованию("МКУ", Истина,, СвойствоДДС);	
	СвойствоСубаренда = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Субаренда", Истина,, СвойствоДДС);	
	СвойствоГарантия = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Гарантия", Истина,, СвойствоДДС); 
	СвойствоТрансПоврежд = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Транспортные повреждения", Истина,, СвойствоДДС);
	
	Запрос.УстановитьПараметр("Объект", Источник.ДоговорВзаиморасчетов);
	Запрос.УстановитьПараметр("Свойство", СвойствоДДС);
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда		
		
		НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(Источник.ДоговорВзаиморасчетов);
		НаборЗаписей.Отбор.Свойство.Установить(СвойствоДДС);
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.Объект = Источник.ДоговорВзаиморасчетов;
		НоваяЗапись.Свойство = СвойствоДДС;
		
		
		Если  ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.СчетНаОплатуЗаАвтомобили") Тогда 
			НоваяЗапись.Значение = СвойствоАвто;
		КонецЕсли;	
		
		//Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.СчетНаОплату") Тогда 
		//	
		//	ЗапросСч = Новый Запрос;
		//	ЗапросСч.Текст = 
		//	"ВЫБРАТЬ
		//	|	СУММА(ВЫБОР
		//	|			КОГДА ТИПЗНАЧЕНИЯ(СчетНаОплатуТовары.Номенклатура) = ТИП(Справочник.Номенклатура)
		//	|				ТОГДА 1
		//	|			ИНАЧЕ 0
		//	|		КОНЕЦ) КАК Запчасти,
		//	|	СУММА(ВЫБОР
		//	|			КОГДА ТИПЗНАЧЕНИЯ(СчетНаОплатуТовары.Номенклатура) = ТИП(Справочник.Автоработы)
		//	|				ТОГДА 1
		//	|			ИНАЧЕ 0
		//	|		КОНЕЦ) КАК Услуги
		//	|ИЗ
		//	|	Документ.СчетНаОплату.Товары КАК СчетНаОплатуТовары
		//	|ГДЕ
		//	|	СчетНаОплатуТовары.Ссылка = &Ссылка";
		//	
		//	ЗапросСч.УстановитьПараметр("Ссылка", Источник.Ссылка);				
		//	ТЗСч = ЗапросСч.Выполнить().Выгрузить();
		//	Если ТЗСч[0].Услуги > 0 Тогда 
		//		НоваяЗапись.Значение = СвойствоСервис;
		//	Иначе 	
		//		НоваяЗапись.Значение = СвойствоАвто;
		//	КонецЕсли;	
		//КонецЕсли;	
		
		НаборЗаписей.Записать();
		Возврат;
	КонецЕсли;			
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	//
	////Разрешить свойство ДДС - "не используется"  для контрагентов Кунова, ТТ, ТАС
	//Кунова = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "090103290098");
	//ТТ = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2312127750");
	//ТАС = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2311152514");
	//
	//Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.СчетНаОплату") И
	//	(Выборка.Значение = СвойствоМКУ ИЛИ Выборка.Значение = СвойствоНеИсп) И
	//	( Источник.Контрагент = Кунова ИЛИ Источник.Контрагент = ТТ ИЛИ Источник.Контрагент = ТАС ) Тогда	
	//	Возврат;
	//КонецЕсли;
	
	Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.СчетНаОплатуЗаАвтомобили") И Выборка.Значение <> СвойствоАвто Тогда 
		Сообщить("Документ не проведен!" + Символы.ПС + "В договоре дополнительное свойство ""Вид договора ДДС"" должно быть ""Авто""");
		Отказ = Истина;
		Возврат;
	КонецЕсли;	
	
	//Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.СчетНаОплату") И Выборка.Значение <> СвойствоСервис И 
	//	Выборка.Значение <> СвойствоАвто И Выборка.Значение <> СвойствоЗапчасти И Выборка.Значение <> СвойствоМКУ И
	//	Выборка.Значение <> СвойствоГарантия И Выборка.Значение <> СвойствоСубаренда И Выборка.Значение <> СвойствоТрансПоврежд Тогда 
	//	Сообщить("Документ не проведен!" + Символы.ПС + "В договоре дополнительное свойство ""Вид договора ДДС"" должны быть ""Авто"" или ""Сервис"",""Гарантия"",""Запчасти"" или ""МКУ""");
	//	Отказ = Истина;
	//	Возврат;
	//КонецЕсли;	
	
	
	
КонецПроцедуры

Процедура ПроверкаВидДоговораДДС(Источник, Отказ, РежимПроведения, Договор)
	
	Если Источник.Дата < Дата(2014, 1, 1) Тогда 
		Возврат;
	КонецЕсли;	
	
	//Если РольДоступна("ПолныеПрава") И Не РольДоступна("ВосстПослед") Тогда 
	//	Возврат;
	//КонецЕсли;	
	
	Если НЕ ЗначениеЗаполнено(Договор) И ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ЗаказНаряд") Тогда 
		Возврат;
	КонецЕсли;	
	
	//Если Источник.Организация=Справочники.Организации.НайтиПоРеквизиту("ИНН", "010605195087")    //Лопатинский
	//	или Источник.Организация=Справочники.Организации.НайтиПоРеквизиту("ИНН", "262512827249") //Ладная Мороз 
	//	Тогда
	//	Возврат;
	//КонецЕсли;
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЗначенияСвойствОбъектов.Объект,
	|	ЗначенияСвойствОбъектов.Свойство,
	|	ЗначенияСвойствОбъектов.Значение
	|ИЗ
	|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|ГДЕ
	|	ЗначенияСвойствОбъектов.Объект = &Объект
	|	И ЗначенияСвойствОбъектов.Свойство = &Свойство";
	
	
	СвойствоДДС = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Вид договора ДДС");	
	СвойствоАвто = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Авто", Истина,, СвойствоДДС);
	СвойствоГарантия = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Гарантия", Истина,, СвойствоДДС);
	СвойствоСервис = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Сервис", Истина,, СвойствоДДС);
	СвойствоЗапчасти = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Запчасти", Истина,, СвойствоДДС);
	//KamikadZe begin add 22.11.2016 16:39:03
	СвойствоМатериалы = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Материалы", Истина,, СвойствоДДС);
	//KamikadZe end add
	СвойствоНеИсп = Справочники.ЗначенияСвойств.НайтиПоНаименованию("не используется", Истина,, СвойствоДДС);
	СвойствоПрочее = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Прочее", Истина,, СвойствоДДС);
	СвойствоМКУ = Справочники.ЗначенияСвойств.НайтиПоНаименованию("МКУ", Истина,, СвойствоДДС);	
	СвойствоСубподряд = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Субподряд", Истина,, СвойствоДДС);
	СвойствоТрансПоврежд = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Транспортные повреждения", Истина,, СвойствоДДС);
	СвойствоРасходыПоАвто = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Расходы по авто", Истина,, СвойствоДДС);
	СвойствоРеклама = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Реклама", Истина,, СвойствоДДС);
	
	Запрос.УстановитьПараметр("Объект", Договор);
	Запрос.УстановитьПараметр("Свойство", СвойствоДДС);
	
	Результат = Запрос.Выполнить();		
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Если (Результат.Пустой() ИЛИ Выборка.Значение = Неопределено) И Не РольДоступна("ВосстПослед") Тогда
		Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.Выписка") И Источник.ХозОперация = Справочники.ХозОперации.БанковскаяВыписка Тогда 
			Возврат;   
		КонецЕсли;	
		
		Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ПриходныйКассовыйОрдер") ИЛИ  
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.Выписка") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.РасходныйКассовыйОрдер") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ЧекНаОплату") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ПоступлениеДопРасходов") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ПоступлениеТоваров") ИЛИ 		
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.РеализацияТоваров") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.РеализацияАвтомобилей") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ЗаказПоставщику") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ЗаказПоставщикуНаАвтомобиль") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ЗаказНаАвтомобиль") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.Взаимозачет") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ОтчетКомитенту") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ОтчетКомитентуЗаАвтомобили") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ОтчетКомиссионера") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ОтчетКомиссионераЗаАвтомобили") ИЛИ
			ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.КорректировкаДолга") 

			Тогда 
			
			//Сообщить("Документ не проведен!" + Символы.ПС + "Заполните в договоре дополнительное свойство - Вид договора ДДС");
			//Отказ = Истина;
			//Возврат;
		КонецЕсли;	
		
		
		НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьМенеджерЗаписи();
		НаборЗаписей.Объект = Договор;
		НаборЗаписей.Свойство = СвойствоДДС;
		
		Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ЗаказНаряд") Тогда	
			НаборЗаписей.Значение = СвойствоСервис;
		КонецЕсли;	
		
		Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ПоступлениеАвтомобилей") ИЛИ ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.РеализацияАвтомобилей") Тогда 
			НаборЗаписей.Значение = СвойствоАвто;
		КонецЕсли;		
		
		Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ПоступлениеДопРасходовНаАвтомобили") Тогда 
			НаборЗаписей.Значение = СвойствоРасходыПоАвто;
		КонецЕсли;	
		
		НаборЗаписей.Записать();
		Возврат;
	КонецЕсли;		
	
//<<Павличенко	
	Если РольДоступна("ПолныеПрава") И Не РольДоступна("ВосстПослед") Тогда 
		Возврат;
	КонецЕсли;	
	Если Источник.Организация=Справочники.Организации.НайтиПоРеквизиту("ИНН", "010605195087")    //Лопатинский
		или Источник.Организация=Справочники.Организации.НайтиПоРеквизиту("ИНН", "262512827249") //Ладная Мороз 
		Тогда
		Возврат;
	КонецЕсли;
	//>Павличенко

	////Разрешить для з-н и запчастей свойство ДДС - "не используется"  для контрагентов Кунова, ТТ, ТАС
	//Кунова = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "090103290098");
	//ТТ = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2312127750");
	//ТАС = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2311152514");
	//Если ( ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ЗаказНаряд") ИЛИ
	//	ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ПоступлениеТоваров") ИЛИ
	//	ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.РеализацияТоваров") ) И
	//	(Выборка.Значение = СвойствоМКУ ИЛИ Выборка.Значение = СвойствоНеИсп) И
	//	( Источник.Контрагент = Кунова ИЛИ Источник.Контрагент = ТТ ИЛИ Источник.Контрагент = ТАС ) Тогда	
	//	Возврат;
	//КонецЕсли;	
	//-------------------------------------------------------------------	
	
	//Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ЗаказНаряд") И Выборка.Значение <> СвойствоСервис И Выборка.Значение <> СвойствоГарантия  И Выборка.Значение <> СвойствоМКУ Тогда 
	//	Сообщить("Документ не проведен!" + Символы.ПС + "В договоре дополнительное свойство ""Вид договора ДДС"" должно быть ""Сервис"",""Гарантия"", или ""МКУ""");
	//	Отказ = Истина;
	//	Возврат;
	//КонецЕсли;	
	//
	//Если (ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ПоступлениеАвтомобилей") ИЛИ ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.РеализацияАвтомобилей")) И Выборка.Значение <> СвойствоАвто Тогда 
	//	Сообщить("Документ не проведен!" + Символы.ПС + "В договоре дополнительное свойство ""Вид договора ДДС"" должно быть ""Авто""");
	//	Отказ = Истина;
	//	Возврат;
	//КонецЕсли;	 	
	//
	//Если ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.РеализацияТоваров") И Источник.Хозоперация=Справочники.ХозОперации.РеализацияТоваров Тогда 
	//	Если Выборка.Значение <> СвойствоЗапчасти 
	//		И Выборка.Значение <> СвойствоРасходыПоАвто
	//		И Выборка.Значение <> СвойствоМКУ 
	//		И Выборка.Значение <> СвойствоМатериалы
	//		И Выборка.Значение <> СвойствоРеклама
	//		Тогда
	//			Сообщить("Документ не проведен!" + Символы.ПС + "В договоре дополнительное свойство ""Вид договора ДДС"" должно быть ""Запчасти"", ""Расходы по авто"", ""МКУ"", ""Материалы"" или ""Реклама""" );
	//			Отказ = Истина;
	//			Возврат;			
	//		КонецЕсли;			
	//КонецЕсли;	
	
КонецПроцедуры

Процедура ИзменениеПраваСобственности(Источник, Отказ)
	#Если Клиент Тогда
		Если Источник.ХозОперация=Справочники.ХозОперации.ПоступлениеАвтомобилейКомиссия Тогда
			Возврат;
		КонецЕсли;
		
		Если РольДоступна("ВосстПослед") Тогда
			Возврат;
		КонецЕсли;
				
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ИзменениеСтатусаВыкупаАвтомобилей.Ссылка
		|ИЗ
		|	Документ.ИзменениеСтатусаВыкупаАвтомобилей КАК ИзменениеСтатусаВыкупаАвтомобилей
		|ГДЕ
		|	ИзменениеСтатусаВыкупаАвтомобилей.ДокументОснование = &ДокументОснование
		|	И ИзменениеСтатусаВыкупаАвтомобилей.ПометкаУдаления = ЛОЖЬ
		|	И ИзменениеСтатусаВыкупаАвтомобилей.Проведен";
		
		Запрос.УстановитьПараметр("ДокументОснование", Источник.Ссылка);			
		РезультатЗапроса = Запрос.Выполнить();
		
		//<<Павличенко 06.10.2020
		//Если РезультатЗапроса.Пустой() Тогда
		//	Режим = РежимДиалогаВопрос.ДаНет;
		//	Ответ = Вопрос("Изменить финансовый статус Автомобилей? Перед этим необходимо записать Поступление автомобилей.", Режим, 0);
		//	Если Ответ = КодВозвратаДиалога.Да Тогда				
		//		Док=документы.ИзменениеСтатусаВыкупаАвтомобилей.СоздатьДокумент();
		//		Док.Заполнить(Источник.Ссылка);
		//		Док.ПолучитьФорму("ФормаДокумента").Открыть();
		//	КонецЕсли;
		//КонецЕсли;
		Если РезультатЗапроса.Пустой() Тогда
			Если НЕ обПраво("СозданиеИзмененийСтатусовПрограммно",глПрава) тогда
				Режим = РежимДиалогаВопрос.ДаНет;
				Ответ = Вопрос("Изменить финансовый статус Автомобилей? Перед этим необходимо записать Поступление автомобилей.", Режим, 0);
				Если Ответ = КодВозвратаДиалога.Да Тогда				
					Док=документы.ИзменениеСтатусаВыкупаАвтомобилей.СоздатьДокумент();
					Док.Заполнить(Источник.Ссылка);
					Док.ПолучитьФорму("ФормаДокумента").Открыть();
				КонецЕсли;
			Иначе
				Док=документы.ИзменениеСтатусаВыкупаАвтомобилей.СоздатьДокумент();
				Док.Заполнить(Источник.Ссылка);
			КонецЕсли;
		КонецЕсли;
		//>>Павличенко 06.10.2020
	#КонецЕсли 
КонецПРоцедуры

Процедура ПроверкаВладельцаАвтоКомиссия(Источник, Отказ, РежимПроведения)
	
	#Если Клиент Тогда
		Если РольДоступна("ПолныеПрава") ИЛИ РольДоступна("ВосстПослед") 
			или ПараметрыСеанса.Пользователь.Наименование = "Погодина Полина Евгеньевна" //ЧалапАю БизТех 28.12.2024
			Тогда 
			Возврат;
		КонецЕсли;
		
		Если Источник.ХозОперация=Справочники.ХозОперации.ПоступлениеАвтомобилейКомиссия Тогда
			Для каждого Стр из Источник.Автомобили Цикл
				Если обЗначениеНеЗаполнено(Стр.Автомобиль.Поставщик) Тогда
					Продолжить;
				КонецЕсли;
				Владелец = Справочники.Автомобили.ЧтениеЗначенияРегистраСведения(Стр.Автомобиль, Перечисления.ДополнительнаяИнформацияАвтомобилей.Хозяин);
				Если Стр.Автомобиль.Поставщик <> Владелец Тогда
					Сообщить("У комиссионного автомобиля "+Стр.Автомобиль+", владелец должен быть "+Стр.Автомобиль.Поставщик);
					Отказ=Истина;
				КонецЕсли;				
			КонецЦикла;
		КонецЕсли;
	#КонецЕсли 
	
КонецПРоцедуры

Процедура ИзменениеПраваСобственностиПроверка(Источник, Отказ, РежимПроведения)
	#Если Клиент Тогда
		ЭтоБУ=Ложь;
		
		Для Каждого Стр Из Источник.Автомобили Цикл
			Если Стр.АвтомобильБУ Тогда
				ЭтоБУ=Истина;
			КонецЕсли;
		КонецЦикла;
		
		ЭтоВнутр = ТТ_Общий.ВнутрКонтрагент(Источник.Контрагент);
		
		Если (Источник.ХозОперация=Справочники.ХозОперации.ПоступлениеАвтомобилейКомиссия или
			Источник.ХозОперация=Справочники.ХозОперации.ПоступлениеАвтомобилей) и ЭтоБУ и НЕ ЭтоВнутр Тогда
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ИзменениеСтатусаВыкупаАвтомобилей.Ссылка
			|ИЗ
			|	Документ.ИзменениеСтатусаВыкупаАвтомобилей КАК ИзменениеСтатусаВыкупаАвтомобилей
			|ГДЕ
			|	ИзменениеСтатусаВыкупаАвтомобилей.ДокументОснование = &ДокументОснование
			|	И ИзменениеСтатусаВыкупаАвтомобилей.ПометкаУдаления = ЛОЖЬ
			|	И ИзменениеСтатусаВыкупаАвтомобилей.Проведен";
			
			Запрос.УстановитьПараметр("ДокументОснование", Источник.Ссылка);			
			РезультатЗапроса = Запрос.Выполнить();
			
			Если РезультатЗапроса.Пустой() Тогда
				
				Док=документы.ИзменениеСтатусаВыкупаАвтомобилей.СоздатьДокумент();
				Док.Дата = КонецДня(Источник.Дата);
				Док.Заполнить(Источник.Ссылка);
				
				Для Каждого Стр ИЗ Док.Автомобили Цикл
					Если Источник.ХозОперация=Справочники.ХозОперации.ПоступлениеАвтомобилейКомиссия Тогда
						Стр.Статус = Справочники.ТТ_СтатусАвтомобиля.НайтиПоКоду("37");//Справочники.ТТ_СтатусАвтомобиля.НайтиПоКоду("000000051");
					ИначеЕсли Источник.ХозОперация=Справочники.ХозОперации.ПоступлениеАвтомобилей Тогда
						Стр.Статус = Справочники.ТТ_СтатусАвтомобиля.НайтиПоКоду("35");//Справочники.ТТ_СтатусАвтомобиля.НайтиПоКоду("000000043");
					КонецЕсли;
				КонецЦикла;
				
				Попытка
					Док.Записать(РежимЗаписиДокумента.Проведение);
					Сообщить("Автоматически создан документ установки фин. статуса "+Док.Ссылка);
				Исключение
					Док.Записать(РежимЗаписиДокумента.Запись);
					Сообщить("Не удалось автоматически создать документ изменения фин. статуса!",СтатусСообщения.Важное);
				КонецПопытки;
			КонецЕсли;
			
		ИначеЕсли НЕ ЭтоВнутр Тогда	
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ИзменениеСтатусаВыкупаАвтомобилей.Ссылка
			|ИЗ
			|	Документ.ИзменениеСтатусаВыкупаАвтомобилей КАК ИзменениеСтатусаВыкупаАвтомобилей
			|ГДЕ
			|	ИзменениеСтатусаВыкупаАвтомобилей.ДокументОснование = &ДокументОснование
			|	И ИзменениеСтатусаВыкупаАвтомобилей.ПометкаУдаления = ЛОЖЬ
			|	И ИзменениеСтатусаВыкупаАвтомобилей.Проведен";
			
			Запрос.УстановитьПараметр("ДокументОснование", Источник.Ссылка);			
			РезультатЗапроса = Запрос.Выполнить();
			
			Если РезультатЗапроса.Пустой() Тогда
				Отказ=Истина;
				Предупреждение("Не назначен фин. статус автомобилю! Перед проведением необходимо записать Поступление автомобилей, затем ввести на основании документ ""Изменение статуса оплаты автомобиля""");
				//Режим = РежимДиалогаВопрос.ДаНет;
				//Ответ = Вопрос("Изменить финансовый статус Автомобилей? Перед этим необходимо записать Поступление автомобилей.", Режим, 0);
				//Если Ответ = КодВозвратаДиалога.Да Тогда				
				//	Док=документы.ИзменениеСтатусаВыкупаАвтомобилей.СоздатьДокумент();
				//	Док.Дата = КонецДня(Источник.Дата);
				//	Док.Заполнить(Источник.Ссылка);
				//	Док.ПолучитьФорму("ФормаДокумента").Открыть();
				//КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	#КонецЕсли 
КонецПРоцедуры

Процедура ИзменениеПраваСобственностиПроверкаВозврат(Источник, Отказ, РежимПроведения)
	#Если Клиент Тогда
		
		ЭтоВнутр = ТТ_Общий.ВнутрКонтрагент(Источник.Контрагент);
		
		Если НЕ ЭтоВнутр Тогда	
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ИзменениеСтатусаВыкупаАвтомобилей.Ссылка
			|ИЗ
			|	Документ.ИзменениеСтатусаВыкупаАвтомобилей КАК ИзменениеСтатусаВыкупаАвтомобилей
			|ГДЕ
			|	ИзменениеСтатусаВыкупаАвтомобилей.ДокументОснование = &ДокументОснование
			|	И ИзменениеСтатусаВыкупаАвтомобилей.ПометкаУдаления = ЛОЖЬ
			|	И ИзменениеСтатусаВыкупаАвтомобилей.Проведен";
			
			Запрос.УстановитьПараметр("ДокументОснование", Источник.Ссылка);			
			РезультатЗапроса = Запрос.Выполнить();
			
			Если РезультатЗапроса.Пустой() Тогда
				Отказ=Истина;
				Предупреждение("Не назначен фин. статус автомобилю! Перед проведением необходимо записать Поступление автомобилей, затем ввести на основании документ ""Изменение статуса оплаты автомобиля""");
				//Режим = РежимДиалогаВопрос.ДаНет;
				//Ответ = Вопрос("Изменить финансовый статус Автомобилей? Перед этим необходимо записать Поступление автомобилей.", Режим, 0);
				//Если Ответ = КодВозвратаДиалога.Да Тогда				
				//	Док=документы.ИзменениеСтатусаВыкупаАвтомобилей.СоздатьДокумент();
				//	Док.Дата = КонецДня(Источник.Дата);
				//	Док.Заполнить(Источник.Ссылка);
				//	Док.ПолучитьФорму("ФормаДокумента").Открыть();
				//КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	#КонецЕсли 
КонецПРоцедуры

Процедура ПроверкаПроведенияЗаявкаНаРасходДС(Источник, Отказ, РежимПроведения)
	
	//Если НЕ ОбПраво("ПроведениеЗаявокНаРасходДС") Тогда
	//	Сообщить("У Вас недостаточно прав для проведения этого документа.");
	//	Отказ = Истина;
	//КонецЕсли;

	Если не РегистрыСведений.БТ_КонстантныеЗначения.ПолучитьЗначение("ВключитьПлатежныйКалендарь") = Истина Тогда
		Если Источник.СтатусТТ = Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.Заявка или
			Источник.СтатусТТ = Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.НеВплане или
			Источник.СтатусТТ = Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.Отклонена Тогда
			Сообщить("Документ можно провести только со статусом - Резерв ДС или Заявка к оплате!");
			Отказ = Истина;
			Возврат;
		КонецЕсли;   
	КонецЕсли;
	
КонецПроцедуры

Процедура ОтразитьДвиженияТТ_ФактПоУтвержденнымЗаявкамДС(Источник, Отказ, РежимПроведения)
	
	Источник.Движения.ТТ_ФактПоУтвержденнымЗаявкамДС.Очистить();
	
	НаборЗаписей = Источник.Движения.ТТ_ФактПоУтвержденнымЗаявкамДС.ДобавитьПриход();
	
	Для Каждого Стр Из Источник.Платежи Цикл
		НаборЗаписей.Организация = ИСточник.Организация;
		НаборЗаписей.Период = Стр.ДатаПлатежа;
		НаборЗаписей.Подразделение = Источник.ПодразделениеКомпании;
		НаборЗаписей.Регистратор = Источник.Ссылка;
		
		//СтатьяДДС = обПолучитьЗначениеСвойства(Источник,ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Статья ДДС Упр"));
		//НаборЗаписей.СтатьяДДСУпр = СтатьяДДС;
		//НаборЗаписей.Сумма	= Стр.Сумма;
	КонецЦикла;
	
КонецПроцедуры

Процедура СоздатьУслугиСтороннихОрганизаций(Источник, Отказ, РежимПроведения)
	
	ОргТАС=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");
	Если Источник.Организация <> ОргТас ИЛИ Источник.Контрагент <> Справочники.Контрагенты.НайтиПоКоду("ЦБ000433") Тогда //на техно-темп
		Возврат;
	КонецЕсли;
	
	Если Источник.ДоговорВзаиморасчетов=Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ180029") Тогда	//Договор ТО и ремонта	
		ЦФОПодразделение=Справочники.ЦФО.НайтиПоНаименованию("ТАС Сервис 160/3");
	ИначеЕсли Источник.ДоговорВзаиморасчетов=Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ055360") Тогда//Договор ТО и ремонта	ГАЗ ТАС
		ЦФОПодразделение=Справочники.ЦФО.НайтиПоНаименованию("ТАС Сервис ГАЗ (сервис)");
	ИначеЕсли Источник.ДоговорВзаиморасчетов=Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ017983") Тогда//Сервисный контракт
		Если обПраво("ЗакрытиеСервисногоКонтракта") Тогда
			ЦФОПодразделение=Справочники.ЦФО.НайтиПоНаименованию("ТАС Сервис ГАЗ (сервис)");
		Иначе
			Сообщить("Нет прав, для закрытия заказ-наряда с договором
			|Сервисный контракт   код ЦБ017983 обращаться в бухгалтерию или к оператору сервиса!");
			Отказ=Истина;
			Возврат;
		КонецЕсли;
	Иначе
		Сообщить("Запись документа невозможна!
		|В заказ-нарядах, плательщиком в которых указано ООО «Техно-Темп», допустимы к использованию только договоры
		|Договор ТО и ремонта ГАЗ ТАС  код ЦБ055360
		|И
		|Договор ТО и ремонта ТАС  код ЦБ180029
		|И
		|Сервисный контракт   код ЦБ017983");
		Отказ=Истина;
		Возврат;
	КонецЕсли;
	
	МассивВР=Новый СписокЗначений();
	МассивВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000004"));
	МассивВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000003"));
	МассивВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000008"));
	МассивВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000013"));
	МассивВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000022"));
	МассивВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000024"));
	МассивВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000027"));
	МассивВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000032"));
	МассивВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000041"));
	
	Если МассивВР.НайтиПоЗначению(Источник.ВидРемонта) = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Запрос=Новый Запрос();
	Запрос.текст=
	"ВЫБРАТЬ
	| 	ПоступлениеТоваров.Ссылка
	| ИЗ
	| 	Документ.ПоступлениеТоваров КАК ПоступлениеТоваров
	| ГДЕ
	| 	ПоступлениеТоваров.Проведен
	| 	И ПоступлениеТоваров.ДокументОснование=&ДокОсн
	| 	И ПоступлениеТоваров.ПометкаУдаления = ЛОЖЬ
	| 	И ПоступлениеТоваров.ХозОперация = &ХозОперация";
	
	Запрос.УстановитьПараметр("ДокОсн", Источник.Ссылка);
	Запрос.УстановитьПараметр("ХозОперация",Справочники.Хозоперации.УслугиСтороннихОрганизаций);
	
	Выборка=Запрос.Выполнить().Выбрать();
	
	ЭтоНовыйДокумент=Ложь;
	Если Выборка.Следующий() Тогда       //Обновляем
		ЭтоНовыйДокумент=Ложь;
		ТекущийОбъект=Выборка.Ссылка.ПолучитьОбъект();
		Если Источник.Состояние <> Справочники.ВидыСостоянийЗаказНарядов.Закрыт Тогда
			ТекущийОбъект.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			Сообщить("Распроведено "+ТекущийОбъект);
			Возврат;
		Иначе
			Сообщить("Обновлено "+ТекущийОбъект);			
		КонецЕсли;
	ИначеЕсли Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт Тогда	//Техно-Темп	
		ТекущийОбъект=Документы.ПоступлениеТоваров.СоздатьДокумент();  //Создаем		
		ЭтоНовыйДокумент=Истина;
	Иначе
		Возврат;
	КонецЕсли;	
	
	ТекущийОбъект.Заполнить(Неопределено);
	
	ТекущийОбъект.ХозОперация=Справочники.ХозОперации.УслугиСтороннихОрганизаций;
	ТекущийОбъект.ДокументОснование=Источник.Ссылка;	
	ТекущийОбъект.Дата=Источник.ДатаЗакрытия+1;
		
	ТекущийОбъект.ВхДокНомер = Источник.Номер;
	ТекущийОбъект.ВхДокДата = Источник.ДатаЗакрытия;
	
	ТекущийОбъект.Контрагент=Справочники.Контрагенты.НайтиПоКоду("ЦБ002188");
	ТекущийОбъект.ПодразделениеКомпании=Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000123");
	ТекущийОбъект.Организация=ТекущийОбъект.ПодразделениеКомпании.Организация;
	ТекущийОбъект.ДоговорВзаиморасчетов=Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ028629");		
	
	Если ЭтоНовыйДокумент Тогда
		ТекущийОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	
	ТекущийОбъект.Товары.Очистить();
	НоваяСтрока=ТекущийОбъект.Товары.Добавить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Наименование = &Наименование
	|	И Номенклатура.ТипНоменклатуры = &ТипНоменклатуры
	|	И Номенклатура.ПометкаУдаления = ЛОЖЬ";
	
	Запрос.УстановитьПараметр("Наименование", СокрЛП(Источник.ВидРемонта.Наименование));
	Запрос.УстановитьПараметр("ТипНоменклатуры", Справочники.ТипыНоменклатуры.Услуга);
	
	ВыборкаДетальныеЗаписи = Запрос.Выполнить().Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Следующий() Тогда
		Спр = ВыборкаДетальныеЗаписи.Ссылка;	
		//Сообщить("Найдена "+Спр);
	Иначе
		Спр=Справочники.Номенклатура.СоздатьЭлемент();
		Спр.Заполнить(неопределено);
		Спр.Наименование=СокрЛП(Источник.ВидРемонта.Наименование);
		Спр.НаименованиеПолное=Спр.Наименование;
		Спр.Родитель=Справочники.Номенклатура.НайтиПоНаименованию("Внутренние услуги",Истина);
		Спр.ТипНоменклатуры=Справочники.ТипыНоменклатуры.Услуга;
		Спр.ВидНоменклатуры=Перечисления.ВидыНоменклатуры.Услуга;
		Спр.БазоваяЕдиницаИзмерения	= Спр.ТипНоменклатуры.ОсновнаяБазоваяЕдиницаИзмерения;
		
		Спр.СпособРаспределенияДопРасходов=Перечисления.СпособыРаспределенияДопРасходов.НаДоходыИРасходы;
		Спр.ОбменДанными.Загрузка=Истина;
		Спр.Записать();
		
		ЕдИзм=Справочники.ЕдиницыИзмерения.СоздатьЭлемент();
		ЕдИзм.УстановитьНовыйКод();
		ЕдИзм.ЕдиницаПоКлассификатору=Спр.БазоваяЕдиницаИзмерения;
		ЕдИзм.Коэффициент=1;
		ЕдИзм.СформироватьНаименование();
		ЕдИзм.Владелец=Спр.Ссылка;
		ЕдИзм.Записать();
		
		Спр.ОсновнаяЕдиницаИзмерения = ЕдИзм.Ссылка;
		Спр.ОбменДанными.Загрузка=Истина;
		Спр.Записать();
		
		//Сообщить("Создана "+Спр);
		
	КонецЕсли;
	
	НоваяСтрока.Номенклатура=Спр.Ссылка;
	НоваяСтрока.ЕдиницаИзмерения=Спр.ОсновнаяЕдиницаИзмерения;
	НоваяСтрока.Количество=1;
	НоваяСтрока.Коэффициент=1;
	
	Если Источник.Работы.Количество() > 0 Тогда
		СтавкаНДС = Источник.Работы[0].СтавкаНДС;			
	ИначеЕсли Источник.Товары.Количество() > 0 Тогда
		СтавкаНДС = Источник.Товары[0].СтавкаНДС;
	Иначе
		СтавкаНДС = Справочники.СтавкиНДС.БезНДС;
	КонецЕсли;
	
	НоваяСтрока.СтавкаНДС=СтавкаНДС;
	
	НоваяСтрока.СуммаВсего=Источник.СуммаДокумента;
		
	ТекущийОбъект.ОбработкаРеквизита("Товары.СуммаВсего", НоваяСтрока);
	
	
	ТекущийОбъект.Записать();
	
	//---Подразделение---
	РС=РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьМенеджерЗаписи();
	РС.Объект=ТекущийОбъект.Ссылка;
	РС.Свойство=ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("ЦФОПодразделение");
	РС.Значение=ЦФОПодразделение;
	РС.Записать();
	
	
	//---Бренд---
	Бренд=ТТ_Общий.ПолучитьБрэнд(Источник.Автомобиль.Модель);
	
	РС=РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьМенеджерЗаписи();
	РС.Объект=ТекущийОбъект.Ссылка;
	РС.Свойство=ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("ЦФОБренд");
	
	Значение=Справочники.ЗначенияСвойств.НайтиПоНаименованию(Бренд,,,РС.Свойство);
	
	Если НЕ Значение.Пустая() Тогда
		РС.Значение=Значение;
	Иначе
		РС.Значение=Справочники.ЗначенияСвойств.НайтиПоНаименованию("Общие затраты",,,РС.Свойство);
	КонецЕсли;
	
	РС.Записать();
	
	Попытка
		ТекущийОбъект.Записать(РежимЗаписиДокумента.Проведение);
		Сообщить("Проведено "+ТекущийОбъект);
	Исключение
		Сообщить("Не удалось создать "+ТекущийОбъект+" по причине: " + ОписаниеОшибки() );
	КонецПопытки;
	
КонецПроцедуры


//<<Павличенко 30.03.2020
Процедура ПроверкаВидовРемонтаБесплатных (Источник, Отказ, РежимПроведения)
	Если РольДоступна("ВосстПослед")  тогда
		возврат;
	КонецЕсли;
	ОргТТ = Источник.Организация;
	
	
	Если Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт
		//И Источник.Заказчик = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2312127750")    //ТТ
		И (
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000017") ИЛИ  // Комплектация автомобиля К		
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000018") ИЛИ  // Комплектация автомобиля П	
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000045") ИЛИ  // Детейлинг		
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000015")   // Доработка автомобиля		

		) Тогда   		 
		
		//проверяем, может это тест-драйв автомобиль
		ЗапросТД = Новый Запрос;
		ЗапросТД.Текст = 
		"ВЫБРАТЬ
		|	АвтомобилиДляТестДрайваОстатки.Автомобиль
		|ИЗ
		|	РегистрНакопления.АвтомобилиДляТестДрайва.Остатки(&Период, Автомобиль = &Автомобиль) КАК АвтомобилиДляТестДрайваОстатки";
		
		ЗапросТД.УстановитьПараметр("Автомобиль", Источник.Автомобиль);
		ЗапросТД.УстановитьПараметр("Период", Источник.ДатаЗакрытия);
		
		РезультатТД = ЗапросТД.Выполнить();
		АвтомобильТестДрайв = Ложь;
		Если НЕ РезультатТД.Пустой() Тогда 
			АвтомобильТестДрайв = Истина;					
		КонецЕсли;	
		
		//Проверяем, есть ли на остатках этот автомобиль
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ОстаткиАвтомобилейОстатки.Автомобиль,
		|	ОстаткиАвтомобилейОстатки.КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.ОстаткиАвтомобилей.Остатки(
		|			&Период,
		|			Автомобиль = &Автомобиль
		|				И СтатусПартии = &Купленный
		|				И Партия.Организация = &Организация) КАК ОстаткиАвтомобилейОстатки";
		
		Запрос.УстановитьПараметр("Организация", ОргТТ);
		Запрос.УстановитьПараметр("Автомобиль", Источник.Автомобиль);
		Запрос.УстановитьПараметр("Период", Источник.ДатаЗакрытия);
		Запрос.УстановитьПараметр("Купленный", Перечисления.СтатусыПартий.ТоварКупленный);
		
		РезультатОст = Запрос.Выполнить();
		Если РезультатОст.Пустой() И 
			НЕ АвтомобильТестДрайв
			Тогда 
			Сообщить("Не проведен " + Источник + " Автомобиля " + Источник.Автомобиль + " нет на остатках!");
			Отказ = Истина;
			Возврат;
		КонецЕсли;	
	КонецЕсли;		
	КонецПроцедуры
//>>Павличенко 30.30.2020

Процедура СоздатьПоступлениеДопРасходовНаАвтомобили(Источник, Отказ, РежимПроведения)
	
	ОргТАС=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");
	ОргКунова=Справочники.Организации.НайтиПоРеквизиту("ИНН", "090103290098");
	ОргТТ=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2312127750");
	
	Если (Источник.Организация <> ОргТАС) И
		(Источник.Организация <> ОргКунова) тогда       //только темп авто сервис  и кунова
		Возврат;
	КонецЕсли;
	
	Если Источник.ДатаЗакрытия <= Дата(2013, 11, 1) Тогда 
		Возврат;	
	КонецЕсли;	
	Запрос = Новый Запрос;                                       
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПоступлениеДопРасходовНаАвтомобили.Ссылка КАК ДопРасход
	|ИЗ
	|	Документ.ПоступлениеДопРасходовНаАвтомобили КАК ПоступлениеДопРасходовНаАвтомобили
	|ГДЕ
	|	ПоступлениеДопРасходовНаАвтомобили.ДокументОснование = &ЗаказНаряд
	|	И НЕ ПоступлениеДопРасходовНаАвтомобили.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("ЗаказНаряд", Источник.Ссылка);
	Результат = Запрос.Выполнить();
	
	Если Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт
		И Источник.Заказчик = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2312127750")    //ТТ
		И (
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000046") ИЛИ  // Детейлинг автомобилей для ОПА 		
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000016") ИЛИ  // Комплектация автомобиля для ОПА		
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000019")
		) Тогда  // Комплектация автомобиля П для ОПА 		 
		
		//проверяем, может это тест-драйв автомобиль
		ЗапросТД = Новый Запрос;
		ЗапросТД.Текст = 
		"ВЫБРАТЬ
		|	АвтомобилиДляТестДрайваОстатки.Автомобиль
		|ИЗ
		|	РегистрНакопления.АвтомобилиДляТестДрайва.Остатки(&Период, Автомобиль = &Автомобиль) КАК АвтомобилиДляТестДрайваОстатки";
		
		ЗапросТД.УстановитьПараметр("Автомобиль", Источник.Автомобиль);
		ЗапросТД.УстановитьПараметр("Период", Источник.ДатаЗакрытия);
		
		РезультатТД = ЗапросТД.Выполнить();
		АвтомобильТестДрайв = Ложь;
		Если НЕ РезультатТД.Пустой() Тогда 
			АвтомобильТестДрайв = Истина;					
		КонецЕсли;	
		
		//Проверяем, есть ли на остатках этот автомобиль
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ОстаткиАвтомобилейОстатки.Автомобиль,
		|	ОстаткиАвтомобилейОстатки.КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.ОстаткиАвтомобилей.Остатки(
		|			&Период,
		|			Автомобиль = &Автомобиль
		|				И СтатусПартии = &Купленный
		|				И Партия.Организация = &Организация) КАК ОстаткиАвтомобилейОстатки";
		
		Запрос.УстановитьПараметр("Организация", ОргТТ);
		Запрос.УстановитьПараметр("Автомобиль", Источник.Автомобиль);
		Запрос.УстановитьПараметр("Период", Источник.ДатаЗакрытия);
		Запрос.УстановитьПараметр("Купленный", Перечисления.СтатусыПартий.ТоварКупленный);
		
		РезультатОст = Запрос.Выполнить();
		Если РезультатОст.Пустой() И 
			НЕ АвтомобильТестДрайв
			Тогда 
			Сообщить("Автомобиля " + Источник.Автомобиль + " нет на остатках!");
			Отказ = Истина;
			Возврат;
		КонецЕсли;	
		// ***		
		
		Если Результат.Пустой() Тогда 
			ДопРасход = Документы.ПоступлениеДопРасходовНаАвтомобили.СоздатьДокумент();
			НовыйДок = Истина;
			ДопРасход.Заполнить(Источник.Ссылка);
			ДопРасход.УстановитьНовыйНомер();
		Иначе 
			Выборка = Результат.Выбрать();
			Выборка.Следующий();
			ДопРасходСсылка = Выборка.ДопРасход;
			ДопРасход = ДопРасходСсылка.ПолучитьОбъект();
			НовыйДок = Ложь;
			ДопРасход.Заполнить(Источник.Ссылка);
		КонецЕсли;	
		
		ДопРасход.Записать(РежимЗаписиДокумента.Проведение);
		
		Если НовыйДок Тогда 
			Сообщить("Создан и проведен документ " + ДопРасход.Ссылка);
		Иначе	
			Сообщить("Обновлен и проведен документ " + ДопРасход.Ссылка);
		КонецЕсли;	
		
		
	Иначе
		Если НЕ Результат.Пустой() Тогда 
			Выборка = Результат.Выбрать();
			Выборка.Следующий();
			ДопРасходСсылка = Выборка.ДопРасход;
			ДопРасход = ДопРасходСсылка.ПолучитьОбъект();			
			ДопРасход.Записать(РежимЗаписиДокумента.ОтменаПроведения);
		КонецЕсли;	
	КонецЕсли;		
КонецПроцедуры

Процедура ПроверкаНаСтатусВыкуплен(Источник, Отказ, РежимПроведения)
	
	//Запрет на невыкупленные Авто при незаполненном виде ремонта
	Если РольДоступна("ПолныеПрава") Тогда
		Возврат;	
	КонецЕсли;
	
	Если Источник.ВидРемонта = Справочники.ВидыРемонта.ПустаяСсылка() Тогда   
		Для Каждого Стр Из Источник.Автомобили Цикл
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
			|	ОстаткиАвтомобилейОстаткиИОбороты.Автомобиль,
			|	ОстаткиАвтомобилейОстаткиИОбороты.СтатусПартии КАК Статус
			|ИЗ
			|	РегистрНакопления.ОстаткиАвтомобилей.ОстаткиИОбороты(, &Дата, , , Автомобиль = &Авто) КАК ОстаткиАвтомобилейОстаткиИОбороты";
			Запрос.УстановитьПараметр("Авто",Стр.Автомобиль);
			Запрос.УстановитьПараметр("Дата",Источник.Дата);
			Результат = Запрос.Выполнить();
			Если Не Результат.Пустой() Тогда
				Выборка = Результат.Выбрать();
				Пока Выборка.Следующий() Цикл
					Статус = Выборка.Статус;
				КонецЦикла;
				Если Статус <> Перечисления.СтатусыПартий.ТоварКупленный Тогда
					Сообщить("Автомобиль "+Стр.Автомобиль+" не выкуплен. Проведение невозможно!");
					Отказ=Истина;
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли
КонецПроцедуры

Процедура УстановкаВидДоговораДДСКредитСтрахование(Источник, Отказ, РежимПроведения)
	Если Источник.ХозОперация <> Справочники.ХозОперации.БанковскаяВыписка Тогда 
		Возврат;
	КонецЕсли;	
	
	СвойствоДДС = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Вид договора ДДС");	
	СвойствоКредит = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Кредит", Истина,, СвойствоДДС);
	СвойствоСтрахование = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Фин.продукт", Истина,, СвойствоДДС);
	
	Для Каждого Стр Из Источник.Состав Цикл
		НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();	
		НаборЗаписей.Отбор.Объект.Установить(Стр.ДоговорВзаиморасчетов);
		НаборЗаписей.Отбор.Свойство.Установить(СвойствоДДС);
		Запись = НаборЗаписей.Добавить();
		Запись.Объект = Стр.ДоговорВзаиморасчетов;
		Запись.Свойство = СвойствоДДС;
		Если ЗначениеЗаполнено(Стр.Сделка) Тогда
			Если ТипЗнч(Стр.Сделка.ДокументОснование) = Тип("ДокументСсылка.РабочийЛистКредитногоОтдела") Тогда 
				Запись.Значение = СвойствоКредит;
				НаборЗаписей.Записать();
			ИначеЕсли ТипЗнч(Стр.Сделка.ДокументОснование) = Тип("ДокументСсылка.РабочийЛистОтделаСтрахования") Тогда 
				Запись.Значение = СвойствоСтрахование;
				НаборЗаписей.Записать();
			КонецЕсли;
		КонецЕсли;	
	КонецЦикла;
КонецПроцедуры

Процедура ПроверкаДолгаКонтрагента(Источник, Отказ, РежимПроведения) Экспорт
	
	Если Источник.Дата <= Дата(2013, 12, 10) Тогда 
		Возврат;
	КонецЕсли;	
	
	//// 15.02.19 Ульянов Не даем записать сервисный клиентский з-н если есть долг более 2 мес
	//Если Источник.Видремонта <> Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000014") Тогда 
	//	Возврат;
	//КонецЕсли;
	
	Если РольДоступна("ПолныеПрава") Тогда
		Возврат;
	КонецЕсли;
	
	Если РольДоступна("ВосстПослед") тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =" 
	|ВЫБРАТЬ
	|СУММА(ВзаиморасчетыКомпанииОстатки.СуммаОстаток) КАК Сумма
	|ИЗ
	|РегистрНакопления.ВзаиморасчетыКомпании.Остатки(&Период, Контрагент = &Контрагент) КАК ВзаиморасчетыКомпанииОстатки
	|ГДЕ
	|ВзаиморасчетыКомпанииОстатки.Сделка.Дата < ДОБАВИТЬКДАТЕ(&Период, МЕСЯЦ, -2)
	//|И ВзаиморасчетыКомпанииОстатки.ДоговорВзаиморасчетов.ВидДоговора = &ВидДоговора
	|И ВзаиморасчетыКомпанииОстатки.ДоговорВзаиморасчетов.ДляАвтосервиса = ИСТИНА";	
	
	Запрос.УстановитьПараметр("Контрагент", Источник.Заказчик);
	Запрос.УстановитьПараметр("Период", Источник.Дата);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если ЗначениеЗаполнено(Выборка.Сумма) Тогда
			Если Выборка.Сумма > 0 Тогда 
				Сообщить("У контрагента " + Источник.Заказчик + " есть долг в размере " + Выборка.Сумма + " руб. сроком более двух месяцев." );
				//Отказ = Истина;
				Возврат;
			КонецЕсли;	
		КонецЕсли;	
	КонецЦикла;
	
КонецПроцедуры
//>>Павличенко 14.09.2020

Процедура ПроверкаТиповРемонта(Источник, Отказ, РежимПроведения)
	
	ОргТАС=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");
	ОргКунова=Справочники.Организации.НайтиПоРеквизиту("ИНН", "090103290098");
	
	Если Источник.Организация<>ОргТАС И Источник.Организация<>ОргКунова Тогда
		Возврат;
	КонецЕсли;
	
	СписокПлатных=Новый СписокЗначений;
	СписокПлатных.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000026"));   //ПСО по контрактам с НДС
	СписокПлатных.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000034"));   //Сервисный клиентский заказ с НДС
	СписокПлатных.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000038"));   //Техническое обслуживание (ТО) с НДС
	СписокПлатных.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000014"));   //Дополнительное оборудование с НДС
	СписокПлатных.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000006"));   //Возмещение ТУ с НДС

	Если СписокПлатных.НайтиПоЗначению(Источник.ВидРемонта) <> Неопределено Тогда
		Сообщить("Запись прервана! Вид ремонта "+Источник.ВидРемонта+" недоступен для данной организации.");
		Отказ=Истина;
	КонецЕсли;
	
	СписокБесплатных=Новый СписокЗначений;
	СписокБесплатных.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000029"));   //Рекламация Сервис
	
	Если Источник.ВидРемонта.ТипРемонта=Перечисления.ТипыРемонта.Бесплатный 
		И СписокБесплатных.НайтиПоЗначению(Источник.ВидРемонта) = Неопределено Тогда
		Сообщить("Запись прервана! Бесплатный вид ремонта "+Источник.ВидРемонта+" недоступен для данной организации.");
		Отказ=Истина;
	КонецЕсли;

	
КонецПроцедуры

Процедура ПроверкаНаВнутреннегоКонтрагента(Источник, Отказ, РежимПроведения)
	
	СписокВнутреннихРемонтов=Новый СписокЗначений;
	СписокВнутреннихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000004"));   //"Акция для ОПА"
	СписокВнутреннихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000003"));   //"Акция (ТО) для ОПА"
	СписокВнутреннихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000008"));   //Восстановление товарных а/м для ОПА
	СписокВнутреннихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000016"));   //Комплектация автомобиля для ОПА
	СписокВнутреннихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000019"));   //Комплектация автомобиля П для ОПА
	СписокВнутреннихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000022"));   //Мойка товарных автомобилей для ОПА
	СписокВнутреннихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000024"));   //Предпродажная подготовка для ОПА
	//СписокВнутреннихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000027"));   //Рекламация для ОПА
	СписокВнутреннихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000032"));   //Ремонт автомобилей тест-драйв для ОПА
	СписокВнутреннихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000041"));   //ТО и ремонт служебных автомобилей ОПА
	
	Если НЕ обЗначениеНеЗаполнено(Источник.Контрагент) И 
		НЕ ТТ_Общий.ВнутрКонтрагент(Источник.Контрагент) И 
		СписокВнутреннихРемонтов.НайтиПоЗначению(Источник.ВидРемонта) <> Неопределено Тогда
		Сообщить("Запись прервана! Вид ремонта "+Источник.ВидРемонта+" применяется только к внутренним контрагентам.");
		Отказ=Истина;
	КонецЕсли;
	
	СписокВнешнихРемонтов=Новый СписокЗначений;
	СписокВнешнихРемонтов.Добавить(Справочники.ВидыРемонта.ДополнительноеОборудование);  //ДополнительноеОборудование
	СписокВнешнихРемонтов.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000014"));     //Дополнительное оборудование с НДС
	
	Если НЕ обЗначениеНеЗаполнено(Источник.Контрагент) И 
		ТТ_Общий.ВнутрКонтрагент(Источник.Контрагент) И 
		СписокВнешнихРемонтов.НайтиПоЗначению(Источник.ВидРемонта) <> Неопределено Тогда
		Сообщить("Запись прервана! Вид ремонта "+Источник.ВидРемонта+" применяется только к внешним контрагентам.");
		Отказ=Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверкаНаОтбитиеРабот(Источник, Отказ)
	
	Если ОбПраво("ПроверятьНаОтбитиеРабот") И  Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт тогда
		Запрос = Новый Запрос;
		//Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ЗаказНарядРаботы.ПакетРабот,
		|	ЗаказНарядРаботы.НомерПакета
		|ПОМЕСТИТЬ ТаблРабот
		|ИЗ
		|	&ТаблРабот КАК ЗаказНарядРаботы
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗаказНарядРаботы.ПакетРабот,
		|	ЗаказНарядРаботы.НомерПакета КАК НомерПакета
		|ИЗ
		|	ТаблРабот КАК ЗаказНарядРаботы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РегистрацияВремениРабот КАК РегистрацияВремениРабот
		|		ПО ЗаказНарядРаботы.ПакетРабот = РегистрацияВремениРабот.ПакетРабот
		|ГДЕ
		|	ЗаказНарядРаботы.НомерПакета <> 0
		|	И РегистрацияВремениРабот.Продолжительность ЕСТЬ NULL 
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗаказНарядРаботы.ПакетРабот,
		|	ЗаказНарядРаботы.НомерПакета
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерПакета";
		Запрос.УстановитьПараметр("ТаблРабот",Источник.Работы.Выгрузить());
		КэшПакетов = Запрос.Выполнить().Выбрать();
		пока КэшПакетов.Следующий() цикл
			Отказ = истина;
			Сообщить("Работы по пакету работ №" + КэшПакетов.НомерПакета + " не выполнены!");
		конецЦикла;
	конецЕсли;
	
КонецПроцедуры

Процедура УстановкаСкидокПоДК(Источник, Отказ)
	
	//Присвоение скидки по дисконтным картам
	Если ЗначениеЗаполнено(Источник.Карточка) Тогда
		Если Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.ВРаботе Тогда
			
			пробег = Источник.Пробег;		
			Если пробег <> неопределено И пробег <> NULL Тогда
				Если 29000 <= пробег И пробег <= 31000 Тогда
					Если ПолучитьЗначениеСкидки(Источник.Карточка, Источник.Дата) <> 5 Тогда
						СоздатьДокументСкидок(Источник.Дата-3600,Справочники.ТипыСкидок.НайтиПоНаименованию("Скидка по дисконтной карте 5%"),Источник.Карточка,5);
						Источник.ОбработкаРеквизита("Карточка");
					КонецЕсли;
				ИначеЕсли 45000 <= пробег И пробег <= 47000 Тогда
					Если ПолучитьЗначениеСкидки(Источник.Карточка, Источник.Дата) <> 7 Тогда
						СоздатьДокументСкидок(Источник.Дата-3600,Справочники.ТипыСкидок.НайтиПоНаименованию("Скидка по дисконтной карте 7%"),Источник.Карточка,7);
						Источник.ОбработкаРеквизита("Карточка");
					КонецЕсли;
				ИначеЕсли 59000 <= пробег И пробег <= 61000 Тогда
					Если ПолучитьЗначениеСкидки(Источник.Карточка, Источник.Дата) <> 10 Тогда
						СоздатьДокументСкидок(Источник.Дата-3600,Справочники.ТипыСкидок.НайтиПоНаименованию("Скидка по дисконтной карте 10%"),Источник.Карточка,10);
						Источник.ОбработкаРеквизита("Карточка");
					КонецЕсли;
				КонецЕсли;	
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверкаДоговораТАС(Источник, Отказ) 
	
	//Включить после прогрузки 
	Возврат;
	
	ТТ=Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2312127750");
	ОргТАС=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");
	
	//<<Павличенко 27.11.17
	//заявка Куновой О. проверка для Темп-Авто Сервиса, с видами ремонта "для ТТ" на нужного контрагента и нужные договора для ЗН выполнен/закрыт 
	Если (Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Выполнен) ИЛИ (Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт) тогда
		Если Источник.Дата > Дата(2017, 10, 31) тогда
			Если (Источник.Организация = ОргТАС )
				И (СтрНайти(Источник.ВидРемонта.Наименование, "для ОПА") <> 0) тогда
				СписокДоговоров = Новый СписокЗначений();
				СписокДоговоров.Добавить(Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ053231"));   //Договор ТО и ремонта ТАС
				СписокДоговоров.Добавить(Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ055360"));   //Договор ТО и ремонта ТАС ГАЗ
				
				Если (Источник.Контрагент <> ТТ)
					ИЛИ СписокДоговоров.НайтиПоЗначению(Источник.ДоговорВзаиморасчетов) = Неопределено тогда 
					сообщить ("" + Источник + " записать невозможно! ");
					сообщить ("Для организации " + ОргТАС + " с видом ремонта " + Источник.ВидРемонта.Наименование); 
					сообщить ("возможен выбор плательщиком лишь " + ТТ + " с договорами " +
					Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ053231") + ", либо "
					+ СписокДоговоров.Добавить(Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ055360")));
					Отказ = Истина;
				КонецЕсли;	
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	//>>Павличенко 27.11.17
	
КонецПроцедуры

Процедура ПроверкаНДС(Источник, Отказ)
	Возврат;
	
	//Проверка НДС для организации Техно-Темп
	
	//<<Павличенко 09.04.19
	Если (Источник.Организация = Справочники.Организации.ОсновнаяОрганизация) И (Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт)
		И (Источник.ДатаЗакрытия >= Дата(2019, 4,1)) И (Источник.ВидРемонта.ТипРемонта = Перечисления.ТипыРемонта.Платный) тогда
		НетНДС = ложь;
		Для каждого СтрЗапчасти из Источник.Товары цикл
			Если СтрЗапчасти.СтавкаНДС <> справочники.СтавкиНДС.ОсновнаяСтавкаНДС Тогда
				НетНДС = Истина;
				Прервать;
			КонецЕсли;
			Если СтрЗапчасти.СуммаНДС <> Окр((СтрЗапчасти.СуммаВсего * СтрЗапчасти.СтавкаНДС.Ставка)/(100 + СтрЗапчасти.СтавкаНДС.Ставка),2) тогда
				Отказ=Истина;
				Сообщить("Неверный расчет НДС по номенклатуре " + СтрЗапчасти.Номенклатура.Наименование);
			КонецЕсли;
			
		конеццикла;
		Для каждого СтрРаботы из Источник.Работы цикл
			Если СтрРаботы.СтавкаНДС <> справочники.СтавкиНДС.ОсновнаяСтавкаНДС Тогда
				НетНДС = Истина;
				Прервать;
			КонецЕсли;
		конеццикла;
		Если СтрРаботы.СуммаНДС <> Окр((СтрРаботы.СуммаВсего * СтрРаботы.СтавкаНДС.Ставка)/(100 + СтрРаботы.СтавкаНДС.Ставка),2) тогда
			Отказ=Истина;
			Сообщить("Неверный расчет НДС по работе " + СтрРаботы.Работа.Наименование);
		КонецЕсли;
		Если  НетНДС тогда
			Отказ=Истина;
			Сообщить("Все закрытые заказ-наряды с 01.01.26 для организации Техно-Темп должны быть с НДС 22%! По всем работам и по всем запчастям");
		КонецЕсли;	
	КонецЕсли;
	
	Если (Источник.Организация = Справочники.Организации.ОсновнаяОрганизация)
		И (Источник.ДатаЗакрытия >= Дата(2019, 4,1)) И (Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000010")) тогда
		СписокКонтрагентов = Новый СписокЗначений();
		СписокКонтрагентов.Добавить(Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "6320002223"));
		СписокКонтрагентов.Добавить(Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "6320013659"));
		Если СписокКонтрагентов.НайтиПоЗначению(Источник.Контрагент) = Неопределено тогда
			Отказ=Истина;
			Сообщить("На вкладке ""Дополнительно"" поле ""Плательщик"" указан неверно! Необходимо указывать Джи Эм-Автоваз, ПАО АвтоВАЗ.");
		КонецЕсли;
	КонецЕсли;
	
	//>>Павличенко 09.04.19
КонецПроцедуры

Процедура ПроверкаЗаполненияИРедактирования(Источник, Отказ)
	
	ОргТАС=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");
	ОргКунова=Справочники.Организации.НайтиПоРеквизиту("ИНН", "090103290098");
	
	//<<Павличенко 07.11.17
	Если Источник.Состояние <> Справочники.ВидыСостоянийЗаказНарядов.Закрыт и Источник.ДатаЗакрытия <> Дата(1,1,1) тогда
		сообщить("Заказ-Наряд с установленной Датой Закрытия должен быть записан только в состоянии ЗАКРЫТ!");
		Отказ=Истина;
	КонецЕсли;
	//>>Павличенко 07.11.17
	
	//<<Павличенко 28.11.17
	//заявка Куновой О.
	Если  Источник.Организация = ОргТАС ИЛИ Источник.Организация = ОргКунова  тогда
		Если НЕ РольДоступна("ВосстПослед") тогда
			Если (Источник.ДоговорВзаиморасчетов.ДатаКонца <> Дата(1,1,1)) И (Источник.ДоговорВзаиморасчетов.ДатаКонца < НачалоДня(Источник.ДатаЗакрытия)) тогда
				сообщить ("Дата окончания договора меньше даты закрытия ЗН! Документ не может быть записан");
				Отказ = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	//>>Павличенко 28.11.17	
	
	
	Если РольДоступна("ПолныеПрава") Тогда
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Источник.ДатаЗакрытия) и НЕ обПраво("РедактированиеДокументовВЗакрытомПериоде") Тогда
		
		ДатаЗапретаРедактирования = КонецДня(обПолучитьПраваИНастройкиПользователя(Источник.Организация,"ДатаЗапретаРедактирования",Источник));
		
		Если Источник.ДатаЗакрытия <= ДатаЗапретаРедактирования Тогда
			Сообщить("Операция не выполнена. Выбранное значение реквизита ""Дата закрытия"" меньше даты запрета редактирования.");
			Отказ = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если ОбПраво("ОтключитьПроверкуЗаполненияЗаказНаряда") Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ РольДоступна(Метаданные.Роли.ПолныеПрава) Тогда
		//Проверка дат
		Если НЕ ЗначениеЗаполнено(Источник.Мастер) Тогда
			Сообщить("Не заполнено поле ""Мастер""! Закрытие заказа невозможно!");
			Отказ = Истина;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Источник.Диспетчер) Тогда
			Сообщить("Не заполнено поле ""Диспетчер""! Закрытие заказа невозможно!");
			Отказ = Истина;
		КонецЕсли;
		//Заполнение рекомендации
		Если НЕ РольДоступна("ВосстПослед") И СокрЛП(источник.Рекомендации)="" Тогда
			Сообщить("Не заполнены рекомендации! Закрытие заказа невозможно!");
			Отказ = Истина;
		КонецЕсли;
		// Подразделение договора = подразделение организации   
		//Bizteh 15.09.2022г. закомментировали это условие <<
		//Если Источник.ВидРемонта.ТипРемонта = перечисления.ТипыРемонта.Платный 
		//	И Источник.ПодразделениеКомпании <> Источник.ДоговорВзаиморасчетов.Подразделение Тогда 
		//	Сообщить("Подразделение договора должно соответствовать подразделению организации! Процедура записи была отменена.");
		//	Отказ=Истина;
		//КонецЕсли;
		//Bizteh >>
		
	КонецЕсли;
	
	//Закрывают гарантию сервиса, дилера, автосалона только сервис-менеджеры
	Если НЕ ОбПраво("ЗакрытиеГарантии") И 
		Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт И
		(Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000028") ИЛИ  //Рекламация ОПА
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000029")) Тогда   //Рекламация сервис
		Сообщить("Для закрытия обратитесь к сервис-менеджеру(руководителю).");
		Отказ=Истина;
	КонецЕсли;
	
	ОргТТ=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2312127750");
	
	Если НЕ РольДоступна("ПолныеПрава") И  Источник.Организация =ОргТТ И  //.Организации.НайтиПоКоду("00001   ")
		Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт И
		(Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000008") ИЛИ   //Восстановление товарных а/м для ТТ
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000027") ИЛИ    //Гарантия диллера для ТТ
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("00000001") ИЛИ    //Дополнительное оборудование
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000019") ИЛИ    //Дополнительное оборудование П
		//Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000022") ИЛИ    //Кузовной ремонт
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000022") ИЛИ    //Мойка автомобилей для тест-драйва для ТТ
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000022") ИЛИ    //Мойка автомобилей для ТТ
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000024") ИЛИ    //ПСО для ТТ
		//Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000024") ИЛИ    //ПСО по возмещению (крайслер)
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000025") ИЛИ    //ПСО по контрактам 
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000026") ИЛИ    //ПСО по контрактам с НДС
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000032") ИЛИ    //Ремонт автомобилей для тест-драйва для ТТ
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000033") ИЛИ    //Сервисный клиентский заказ
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000027") ИЛИ    //Сервисный клиентский заказ для ТТ
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000035") ИЛИ    //Страховой ремонт
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000038") ИЛИ    //Техническое обслуживание c НДС
		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000037")) Тогда    //Техническое обслуживание
		
		
		Сообщить("Данный тип ремонта - Платный. Для закрытия обратитесь к бухгалтеру.");
		Отказ=Истина;
	КонецЕсли;
	
	//+anton 29\05\2019  Не используется
	////Проверка таблицы распределения
	//Запрос = Новый Запрос;
	//Запрос.Текст = 
	//"ВЫБРАТЬ
	//|	РаспределениеМатериаловПоРаботамЗН.Номенклатура,
	//|	РаспределениеМатериаловПоРаботамЗН.Работа
	//|ИЗ
	//|	РегистрСведений.РаспределениеМатериаловПоРаботамЗН КАК РаспределениеМатериаловПоРаботамЗН
	//|ГДЕ
	//|	РаспределениеМатериаловПоРаботамЗН.ЗаказНаряд = &ЗаказНаряд";
	//
	//Запрос.УстановитьПараметр("ЗаказНаряд", Источник.Ссылка);
	//
	//Результат = Запрос.Выполнить().Выбрать();
	//Пока Результат.Следующий() Цикл
	//	
	//	СтрИсточник = Источник.Работы.Найти(Результат.Работа,"Работа");
	//	Если СтрИсточник = Неопределено Тогда
	//		Сообщить("Неверно распределены запчасти в работе: "+Результат.Работа);
	//		Отказ = Истина;
	//	КонецЕсли;
	//	
	//	СтрИсточник = Источник.Товары.Найти(Результат.Номенклатура,"Номенклатура");
	//	Если СтрИсточник = Неопределено Тогда
	//		Сообщить("Неверно распределена запчасть "+Результат.Номенклатура+" в работе: "+Результат.Работа);
	//		Отказ = Истина;
	//	КонецЕсли;
	//КонецЦикла;
	//
	//Если Источник.ВидРемонта <> Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000013") И 
	//	Источник.ВидРемонта <> Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000035") И 
	//	Источник.ВидРемонта <> Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000026") Тогда	
	//	Для Каждого СтрТоваров Из Источник.Товары Цикл
	//		
	//		Запрос = Новый Запрос;
	//		Запрос.Текст = 
	//		"ВЫБРАТЬ
	//		|	РаспределениеМатериаловПоРаботамЗН.Номенклатура
	//		|ИЗ
	//		|	РегистрСведений.РаспределениеМатериаловПоРаботамЗН КАК РаспределениеМатериаловПоРаботамЗН
	//		|ГДЕ
	//		|	РаспределениеМатериаловПоРаботамЗН.ЗаказНаряд = &ЗаказНаряд
	//		|	И РаспределениеМатериаловПоРаботамЗН.Номенклатура = &Номенклатура";
	//		
	//		Запрос.УстановитьПараметр("ЗаказНаряд", Источник.Ссылка);
	//		Запрос.УстановитьПараметр("Номенклатура", СтрТоваров.Номенклатура);
	//		
	//		Результат = Запрос.Выполнить().Выбрать();
	//		
	//		Если Результат.Количество()=0 Тогда
	//			Сообщить("В заказ-наряде, есть нераспределенные запчасти, закрытие невозможно!");
	//			Отказ = Истина;
	//		КонецЕсли;
	//	КонецЦикла;
	//КонецЕсли;
	//-anton 29\05\2019
	
	
	//отключено по запросу
	//Проверка хозяина авто 
	//Если НЕ ОбПраво("НеПроверятьВладельцаАвто") и Источник.ВидРемонта <> Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000005") Тогда 
	//	Хозяин = Справочники.Автомобили.ЧтениеЗначенияРегистраСведения(Источник.Автомобиль, Перечисления.ДополнительнаяИнформацияАвтомобилей.Хозяин);
	//	Если Хозяин <> Источник.Заказчик Тогда	
	//		сообщить("Заказчик не является Владельцем Автомобиля. Проведение невозможно. Измените Владельца в Автомобиле.");
	//		Отказ= Истина;
	//	КонецЕсли;
	//КонецЕсли;
	
КонецПроцедуры

Процедура ОповещениеОПроведеннойУстановкеДопОборудования(Источник, Отказ)
	
	#Если Клиент Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаказНаряд.Ссылка
		|ИЗ
		|	Документ.ЗаказНаряд КАК ЗаказНаряд
		|ГДЕ
		|	ЗаказНаряд.Автомобиль = &Автомобиль
		|	И (ЗаказНаряд.ВидРемонта.Код = ""00000001""    
		|			ИЛИ ЗаказНаряд.ВидРемонта.Код = ""ЦБ000017"")";	    //Доп. обор. и Комплектация К
		
		Для Каждого стр из Источник.Автомобили цикл
			
			Запрос.УстановитьПараметр("Автомобиль", стр.Автомобиль);
			выборка = запрос.Выполнить().Выбрать();
			Если выборка.Количество()> 0 тогда 
				Сообщить("Для " + стр.Автомобиль + " были проведены работы по установке доп.оборудования");
			КонецЕсли;
			
		конеццикла;
		
	#КонецЕсли
	
КонецПроцедуры

Процедура ПроверкаСоответствияОрганизации(Источник, Отказ, РежимПроведения)
	
	ИмяДокумента=Источник.Метаданные().Имя;
	
	Если ТТ_Общий.ЕстьРеквизитТабЧастиДокумента("СкладКомпании", Источник, "Товары") И ИмяДокумента <> "Выписка" Тогда		
		Для каждого СтрокаТоваров из Источник.Товары Цикл
			Если СтрокаТоваров.СкладКомпании.Организация <> Источник.Организация Тогда    // ТЧ Товары в Заказ-Наряде
				Сообщить("Склад в табличной части Товары не соотвествует организации в заказ-наряде!");
				Отказ=Истина;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Если ТТ_Общий.ЕстьРеквизитОбъекта("Цех", Источник) И ТТ_Общий.ЕстьРеквизитОбъекта("Организация", Источник) Тогда
		Если Источник.Цех.Организация <> Источник.Организация И ЗначениеЗаполнено(Источник.Цех) Тогда 
			Сообщить("Организация Цеха не соответствует организации документа!");
			Отказ=Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если ТТ_Общий.ЕстьРеквизитОбъекта("ПодразделениеКомпании", Источник) И ТТ_Общий.ЕстьРеквизитОбъекта("Организация", Источник) Тогда
		//БизТех Горковенко П.А. 22.10.25 <<
		//Если Источник.ПодразделениеКомпании.Организация <> Источник.Организация Тогда      //Подразделение
		//	Сообщить("Организация Подразделения не соответствует организации документа!");
		//	Отказ=Истина;
		//КонецЕсли;	 
		Если НЕ ИмяДокумента = "ПодтверждениеВозмещенияПоставщиком" И НЕ ИмяДокумента = "ОтветПоставщикаПоВозмещениям"
			И НЕ ИмяДокумента = "ОтчетДистрибьютораОПродажеАвтомобилей" Тогда
			Если Источник.ПодразделениеКомпании.Организация <> Источник.Организация Тогда      //Подразделение
				Сообщить("Организация Подразделения не соответствует организации документа!");
				Отказ=Истина;
			КонецЕсли;
		КонецЕсли;
		
		//БизТех Горковенко П.А. 22.10.25 >>

	КонецЕсли;
	
	Если ТТ_Общий.ЕстьРеквизитОбъекта("СкладКомпании", Источник) И НЕ (ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.ИзменениеЦен") или ТипЗнч(Источник.Ссылка) = Тип("ДокументСсылка.Выписка")) Тогда
		Если НЕ обЗначениеНеЗаполнено(Источник.СкладКомпании) И Источник.СкладКомпании.Организация <> Источник.Организация Тогда     //Склад
			Сообщить("Организация Склада не соответствует организации документа!");
			Отказ=Истина;				
		КонецЕсли;
		
		Если ТТ_Общий.ЕстьРеквизитОбъекта("СкладПолучатель", Источник) И 
			Источник.СкладКомпании.Организация <> Источник.СкладПолучатель.Организация Тогда			
			Сообщить("Организация Склада-отправителя не соответствует организации Склада-получателя документа!");
			Отказ=Истина;				
		КонецЕсли;
		
	КонецЕсли;	
	
	Если ТТ_Общий.ЕстьРеквизитОбъекта("ДоговорВзаиморасчетов", Источник) И ТТ_Общий.ЕстьРеквизитОбъекта("Организация", Источник)
		И Источник.Метаданные().Имя <> "ЗаявкаНаРемонт" Тогда		
		//->Diginova _Акт сверки кред,страх_ 30.11.2021
		//Стало
		Если НЕ ТипЗнч(Источник) = Тип("ДокументОбъект.DN_АктСверкиКредитСтрах") тогда
			Если НЕ обЗначениеНеЗаполнено(Источник.ДоговорВзаиморасчетов.Организация) И Источник.ДоговорВзаиморасчетов.Организация <> Источник.Организация Тогда  //Договор Взаиморасчетов
				Сообщить("Организация Договора взаиморасчетов не соответствует организации документа!");
				Отказ=Истина;				
			КонецЕсли;
		КонецЕсли;
		//////////////БЫЛО/////////////////////////////////
		//Если НЕ обЗначениеНеЗаполнено(Источник.ДоговорВзаиморасчетов.Организация) И Источник.ДоговорВзаиморасчетов.Организация <> Источник.Организация Тогда  //Договор Взаиморасчетов
		//	Сообщить("Организация Договора взаиморасчетов не соответствует организации документа!");
		//	Отказ=Истина;				
		//КонецЕсли;
		//<-Diginova _FlaiM_		
	КонецЕсли;
	
	ИмяДокумента=Источник.Метаданные().Имя;
	
	Если ИмяДокумента="ЗаказНаряд"  Тогда
		
		Если Источник.Состояние <> Справочники.ВидыСостоянийЗаказНарядов.Закрыт Тогда 
			Возврат;
		КонецЕсли;
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПеремещениеТоваровВПроизводство.Ссылка КАК Перемещение
		|ИЗ
		|	Документ.ПеремещениеТоваровВПроизводство КАК ПеремещениеТоваровВПроизводство
		|ГДЕ
		|	ПеремещениеТоваровВПроизводство.ДокументОснование = &ЗаказНаряд";
		
		Запрос.УстановитьПараметр("ЗаказНаряд", Источник.Ссылка);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		СтрокаВывода = "Есть документы ""Перемещение в производство"", у которых организация отличается от организации в документа ""Заказ наряд"":" + Символы.ПС;
		Есть = Ложь;
		Пока Выборка.Следующий() Цикл
			Если Выборка.Перемещение.Организация <> Источник.Организация Тогда 
				Есть = Истина;
				СтрокаВывода = СтрокаВывода + Выборка.Перемещение + Символы.ПС;
			КонецЕсли;	
		КонецЦикла;	
		
		Если Есть Тогда 
			Сообщить(СтрокаВывода);
			Отказ = Истина;		
		КонецЕсли;	
		
	КонецЕсли;	
	
КонецПроцедуры

Процедура ОбработкаЗаполненияПоступлениеАвтомобилей(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	Если ТипЗнч(ДанныеЗаполнения)=Тип("ДокументСсылка.РеализацияАвтомобилей") И
		ДанныеЗаполнения.ХозОперация=Справочники.ХозОперации.РеализацияАвтомобилейКомиссия Тогда
		СвойствоКонтрагент=ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Контрагент-организация");
		
		Источник.ХозОперация=Справочники.ХозОперации.ПоступлениеАвтомобилейКомиссия;
		
		РС=РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();
		РС.Отбор.Объект.Установить(ДанныеЗаполнения.Организация);
		РС.Отбор.Свойство.Установить(СвойствоКонтрагент);
		РС.Прочитать();
		
		Если РС.Количество()>0 Тогда
			Источник.Контрагент=РС[0].Значение;	
		КонецЕсли;
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗначенияСвойствОбъектов.Объект
		|ИЗ
		|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|ГДЕ
		|	ЗначенияСвойствОбъектов.Свойство = &Свойство
		|	И ЗначенияСвойствОбъектов.Значение = &Значение";
		
		Запрос.УстановитьПараметр("Значение", ДанныеЗаполнения.Контрагент);
		Запрос.УстановитьПараметр("Свойство", СвойствоКонтрагент);
		
		РезультатЗапроса = Запрос.Выполнить();	
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Если ВыборкаДетальныеЗаписи.Следующий() Тогда
			Источник.Организация=ВыборкаДетальныеЗаписи.Объект;
		КонецЕсли; 
		
		Для каждого Стр из Источник.Автомобили Цикл
			Стр.VIN=стр.Автомобиль.VIN;	
		КонецЦикла;
		
	КонецЕсли; 		
	//anton
	
КонецПроцедуры

Процедура ОбработкаЗаполненияРеализацияТоваров(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	// Ввод документа Реализации услуг на основании Рабочий лист кредитного отдела
	Если ТипЗнч(ДанныеЗаполнения) <> Тип("ДокументСсылка.РабочийЛистКредитногоОтдела") Тогда 
		Возврат;
	КонецЕсли;	
	Источник.ХозОперация = Справочники.ХозОперации.АктОбОказанииУслуг;
	Если ЗначениеЗаполнено(ДанныеЗаполнения.КредитнаяПрограмма.БанкКонтрагент) Тогда
		Банк = ДанныеЗаполнения.КредитнаяПрограмма.БанкКонтрагент;
	Иначе	
		Банк = Справочники.Контрагенты.НайтиПоНаименованию(ДанныеЗаполнения.Банк.Наименование);
		Если Банк = Справочники.Контрагенты.ПустаяСсылка() Тогда 
			Банк = Справочники.Контрагенты.СоздатьЭлемент();
			Банк.УстановитьНовыйКод();
			Банк.Наименование = ДанныеЗаполнения.Банк.Наименование;
			Банк.НаименованиеПолное = Банк.Наименование;
			Банк.ФормаСобственности = Перечисления.ФормыСобственности.ЮридическоеЛицо;
			Банк.ВидКонтрагента = Перечисления.ВидыКонтрагентов.Покупатель;		
			Банк.ОсвобожденОтНДС=Истина;
			Банк.Записать();
			Банк.СоздатьОсновнойДоговор();
		ИначеЕсли Банк.ОсвобожденОтНДС = Ложь Тогда
			банк = банк.ссылка.ПолучитьОбъект();
			Банк.ОсвобожденОтНДС=Истина;		
			Банк.Записать();
		КонецЕсли;
	КонецЕсли;
	
	Источник.Контрагент	= Банк.Ссылка;		
	Источник.ОбработкаРеквизита("Контрагент");
	
	НетДоговора = Ложь;
	Если Источник.ДоговорВзаиморасчетов.Организация <> Источник.Организация Тогда 
		//Поиск договора по организации в реализации
		Запрос = Новый Запрос;
		Запрос.Текст ="ВЫБРАТЬ
		|	ДоговорыВзаиморасчетов.Ссылка
		|ИЗ
		|	Справочник.ДоговорыВзаиморасчетов КАК ДоговорыВзаиморасчетов
		|ГДЕ
		|	ДоговорыВзаиморасчетов.Организация = &Организация
		|	И ДоговорыВзаиморасчетов.Владелец = &Контрагент
		|	И ДоговорыВзаиморасчетов.ПометкаУдаления = ЛОЖЬ" ;
		Запрос.УстановитьПараметр("Организация",Источник.Организация);
		Запрос.УстановитьПараметр("Контрагент",Источник.Контрагент);
		Результат=Запрос.Выполнить();
		Если Результат.Пустой() Тогда
			НетДоговора =	Истина;
		Иначе // Нашли договор
			Выборка = Результат.Выбрать();
			Пока Выборка.Следующий() Цикл
				ДоговорСсылка = Выборка.Ссылка;
			КонецЦикла;
			Источник.ДоговорВзаиморасчетов=Выборка.Ссылка;
		КонецЕсли;	
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Источник.ДоговорВзаиморасчетов) ИЛИ НетДоговора Тогда  //Создадим договор
		Права = Неопределено;
		ВидДоговора   = Перечисления.ВидыДоговоров.Продажа;
		ТипЦенПокупки = Справочники.ТипыЦен.ПустаяСсылка();
		ТипЦенПродажи = обПраво("ОсновнойТипЦенПродажи", Права);
		ТипЦенРабот   = обПраво("ОсновнойТипЦенРабот",   Права);
		НовыйДоговор = Справочники.ДоговорыВзаиморасчетов.СоздатьЭлемент();
		НовыйДоговор.УстановитьНовыйКод();
		НовыйДоговор.Владелец = Источник.Контрагент.Ссылка;
		НовыйДоговор.ВидДоговора = ВидДоговора;
		НовыйДоговор.ТипЦенПокупки = ТипЦенПокупки;
		НовыйДоговор.ТипЦенПродажи = ТипЦенПродажи;
		НовыйДоговор.ВидОплаты = Перечисления.ВидыОплаты.ПроизвольнаяОплата;
		//KamikadZe begin add 06.10.2015 23:25:56
		НовыйДоговор.Организация = Источник.Организация;
		НовыйДоговор.Подразделение = Источник.ПодразделениеКомпании;
		//KamikadZe end add
		НовыйДоговор.ОбработкаЗаполнения(Неопределено);
		НовыйДоговор.Записать(); 
		Источник.ДоговорВзаиморасчетов = НовыйДоговор.Ссылка;		
	КонецЕсли;	
	
	НоваяСтрока = Источник.Товары.Добавить();
	Если ЗначениеЗаполнено(ДанныеЗаполнения.КредитнаяПрограмма.АгентскаяУслуга) Тогда
		НоваяСтрока.Номенклатура = ДанныеЗаполнения.КредитнаяПрограмма.АгентскаяУслуга;
	Иначе	
		НоваяСтрока.Номенклатура = Справочники.Номенклатура.НайтиПоРеквизиту("Артикул","00000101");
	КонецЕсли;		
	Источник.ОбработкаРеквизита("Товары.Номенклатура", НоваяСтрока);
	//	НоваяСтрока.Цена = Окр(ДанныеЗаполнения.СуммаКредита*ДанныеЗаполнения.ПроцентнаяСтавка/100, 2);
	НоваяСтрока.Цена = ?(ДанныеЗаполнения.ОбщаяСуммаАВ=0,Окр(ДанныеЗаполнения.СуммаКредита*ДанныеЗаполнения.ПроцентнаяСтавка/100, 2),ДанныеЗаполнения.ОбщаяСуммаАВ);
	Источник.ОбработкаРеквизита("Товары.Цена", НоваяСтрока);	
	НоваяСтрока.СтатьяДоходов = справочники.СтатьиДоходовИРасходов.НайтиПоКоду("ЦБ000453");
	
	//Заполнение Свойств из документа-основания
КонецПроцедуры

Процедура ОбработкаЗаполненияПлатежноеПоручение(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	Если ТипЗнч(Источник.ДокументОснование)=Тип("ДокументСсылка.ЗаявкаНаРасходДС") Тогда
		Источник.ОчередностьПлатежа = 5;
		//Источник.НазначениеПлатежа	= СокрЛП(Источник.ДокументОснование.Платежи[0]);
		Источник.НазначениеПлатежа	= Источник.ДокументОснование.Назначение;
		Источник.СчетКонтрагента	= Источник.ДокументОснование.СчетКонтрагента;
		Источник.ВидПлатежа	= "Электронно";
	КонецЕсли;
	
	//Ненужное свойство
	
	//Запрос = Новый Запрос;
	//Запрос.Текст = 
	//"ВЫБРАТЬ
	//|	ЗначенияСвойствОбъектов.Значение
	//|ИЗ
	//|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	//|ГДЕ
	//|	ЗначенияСвойствОбъектов.Объект = &Документ
	//|	И ЗначенияСвойствОбъектов.Свойство = &Свойство";
	//
	//Источник.Записать();	
	//
	//ТекущееСвойство = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("02009");	
	//Запрос.УстановитьПараметр("Документ", Источник.ДокументОснование.Ссылка);
	//Запрос.УстановитьПараметр("Свойство", ТекущееСвойство);
	//
	//Результат = Запрос.Выполнить();
	//
	//ВыборкаДетальныеЗаписи = Результат.Выбрать();
	//
	//ВыборкаДетальныеЗаписи.Следующий();
	//СтатьяДДСУпр = ВыборкаДетальныеЗаписи.Значение;
	//
	//
	//НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей(); 
	//
	//НаборЗаписей.Отбор.Объект.Установить(Источник.Ссылка); 
	//НаборЗаписей.Отбор.Свойство.Установить(ТекущееСвойство); 
	//
	//
	//НоваяЗапись = НаборЗаписей.Добавить(); 
	//НоваяЗапись.Объект = Источник.Ссылка; 
	//НоваяЗапись.Свойство = ТекущееСвойство; 
	//НоваяЗапись.Значение = СтатьяДДСУпр; 
	//
	//НаборЗаписей.Записать();
	
	Если ТипЗнч(ДанныеЗаполнения)=Тип("ДокументСсылка.ЗаявкаНаРасходДС") Тогда
		Источник.ОчередностьПлатежа = 5;
		//Источник.НазначениеПлатежа	= СокрЛП(Источник.ДокументОснование.Платежи[0]);
		Источник.НазначениеПлатежа	= ДанныеЗаполнения.Назначение;
		Источник.СчетКонтрагента	= ДанныеЗаполнения.СчетКонтрагента;
		Источник.ВидПлатежа	= "Электронно";
	КонецЕсли;	
КонецПроцедуры

Процедура ОбработкаЗаполненияЗаказНаряд(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	//Если ДанныеЗаполнения.Организация.Код = "ЦБ000001" Тогда
	//	Источник.Организация = Справочники.Организации.ОсновнаяОрганизация;
	//	Источник.ПодразделениеКомпании = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000001");
	//	Источник.Заказчик = Справочники.Контрагенты.НайтиПоКоду("ЦБ000089");
	//	
	//	Если ДанныеЗаполнения.ВидРемонта.Код = "K       " Тогда //ПСО
	//		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("I1      ");
	//	ИначеЕсли ДанныеЗаполнения.ВидРемонта.Код = "00000001" Тогда //Доп оборудование
	//		Источник.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000019");
	//	КонецЕсли;
	//	
	//	Источник.Цех = Справочники.Цеха.НайтиПоКоду("ЦБ000002");
	//	Источник.Товары.Очистить();
	//	
	//	ЗН = ДанныеЗаполнения.Ссылка;
	//	
	//	Для Каждого СтрТоваров Из ЗН.Товары Цикл
	//		
	//		Запрос = Новый Запрос;
	//		Запрос.Текст = 
	//		"ВЫБРАТЬ
	//		|	РаспределениеМатериаловПоРаботамЗН.Номенклатура
	//		|ИЗ
	//		|	РегистрСведений.РаспределениеМатериаловПоРаботамЗН КАК РаспределениеМатериаловПоРаботамЗН
	//		|ГДЕ
	//		|	РаспределениеМатериаловПоРаботамЗН.ЗаказНаряд = &ЗаказНаряд
	//		|	И РаспределениеМатериаловПоРаботамЗН.Номенклатура = &Номенклатура";
	//		
	//		Запрос.УстановитьПараметр("ЗаказНаряд", ЗН.Ссылка);
	//		Запрос.УстановитьПараметр("Номенклатура", СтрТоваров.Номенклатура);
	//		
	//		Результат = Запрос.Выполнить().Выбрать();
	//		
	//		Если Результат.Количество()=0 Тогда
	//			Сообщить("В заказ-наряде, есть нераспределнные запчасти, ввод на основании невозможен!");
	//			Отказ = ИСТИНА;
	//			Возврат;
	//		КонецЕсли;
	//	КонецЦикла;
	//	
	//	
	//	
	//	Для Каждого СтрЗН ИЗ ЗН.Работы Цикл
	//		Запрос = Новый Запрос;
	//		Запрос.Текст = 
	//		"ВЫБРАТЬ
	//		|	РаспределениеМатериаловПоРаботамЗН.Номенклатура
	//		|ИЗ
	//		|	РегистрСведений.РаспределениеМатериаловПоРаботамЗН КАК РаспределениеМатериаловПоРаботамЗН
	//		|ГДЕ
	//		|	РаспределениеМатериаловПоРаботамЗН.ЗаказНаряд = &ЗаказНаряд
	//		|	И РаспределениеМатериаловПоРаботамЗН.Работа = &Работа";
	//		
	//		Запрос.УстановитьПараметр("ЗаказНаряд", ЗН);
	//		Запрос.УстановитьПараметр("Работа", СтрЗН.Работа);
	//		
	//		Результат = Запрос.Выполнить();
	//		ВыборкаДетальныеЗаписи = Результат.Выбрать();
	//		СуммаЗапчасти=0;
	//		
	//		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	//			Стр = ЗН.Товары.Найти(ВыборкаДетальныеЗаписи.Номенклатура, "Номенклатура");
	//			СуммаЗапчасти = СуммаЗапчасти+Стр.СуммаВсего;
	//		КонецЦикла;
	//		
	//		СтрокаРабот = Источник.Работы.Найти(СтрЗН.Работа, "Работа");
	//		
	//		СтрокаРабот.Сумма		= СтрЗН.Сумма + СуммаЗапчасти;
	//		СтрокаРабот.Количество	= СтрЗН.Количество;
	//		СтрокаРабот.Цена		= СтрокаРабот.Сумма/СтрокаРабот.Количество;
	//		СтрокаРабот.СуммаВсего  = СтрокаРабот.Сумма;
	//	КонецЦИкла;
	//	Сообщить("Заполнено на основании "+ЗН);
	//	
	//КонецЕсли;
	
	//misha   //Перенесено из модуля документа
	//галка себестоимость
	Если Источник.ЭтоНовый() Тогда			
		Если НЕ РольДоступна("ПолныеПрава") Тогда
			Если Источник.ВидРемонта.ТипРемонта=Перечисления.ТипыРемонта.Платный Тогда
				Если Источник.ВидРемонта <> Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000010")    //Гарантийный заказ
					И Источник.ВидРемонта <> Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000011")  //Гарантийный заказ с НДС
					И Источник.ВидРемонта <> Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000027") Тогда //Рекламация для ОПА
					Если Источник.СписаниеТоваровПоСебестоимости Тогда
						Источник.СписаниеТоваровПоСебестоимости = Ложь;
					КонецЕсли
					//ЭтаФорма.ЭлементыФормы.СписаниеТоваровПоСебестоимости.Доступность = Ложь;
				КонецЕсли;
			Иначе
				Если Источник.ВидРемонта <> Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000017")   //Комплектация автомобиля К
					ИЛИ Источник.ВидРемонта <> Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000018") Тогда //Комплектация автомобиля П
					Если НЕ Источник.СписаниеТоваровПоСебестоимости Тогда
						Источник.СписаниеТоваровПоСебестоимости = ИСТИНА;
					КонецЕсли;
					//ЭтаФорма.ЭлементыФормы.СписаниеТоваровПоСебестоимости.Доступность = Истина;				
				КонецЕсли;
			КонецЕсли;	
		КонецЕсли;	
	КонецЕсли;	
	
	//anton
	Если ТипЗнч(ДанныеЗаполнения) = ТИп("ДокументСсылка.ЗаявкаНаРемонт") Тогда
		Источник.ПлановаяДатаВыдачи=ДанныеЗаполнения.ДатаОкончания;
	КонецЕсли;	
	//anton
	
	//misha
	
КонецПроцедуры

Процедура ОбработкаЗаполненияСчетНаОплату(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	//#Если Клиент Тогда
	//	Если РольДоступна("ПолныеПрава") Тогда
	//		Если Вопрос("Использовать стандартный механизм заполнения счета?",РежимДиалогаВопрос.ДаНет)=КодВозвратаДиалога.Да Тогда
	//			Возврат;
	//		КонецЕсли;
	//	КонецЕсли;
	//#КонецЕсли
	//
	//Если ДанныеЗаполнения.Метаданные().Имя = "ЗаказНаряд" Тогда
	//	ЗН = ДанныеЗаполнения.Ссылка;
	//	//ЗН = Документы.ЗаказНаряд.НайтиПоНомеру("");
	//	
	//	Для Каждого СтрТоваров Из ЗН.Товары Цикл
	//		
	//		Запрос = Новый Запрос;
	//		Запрос.Текст = 
	//		"ВЫБРАТЬ
	//		|	РаспределениеМатериаловПоРаботамЗН.Номенклатура
	//		|ИЗ
	//		|	РегистрСведений.РаспределениеМатериаловПоРаботамЗН КАК РаспределениеМатериаловПоРаботамЗН
	//		|ГДЕ
	//		|	РаспределениеМатериаловПоРаботамЗН.ЗаказНаряд = &ЗаказНаряд
	//		|	И РаспределениеМатериаловПоРаботамЗН.Номенклатура = &Номенклатура";
	//		
	//		Запрос.УстановитьПараметр("ЗаказНаряд", ЗН.Ссылка);
	//		Запрос.УстановитьПараметр("Номенклатура", СтрТоваров.Номенклатура);
	//		
	//		Результат = Запрос.Выполнить().Выбрать();
	//		
	//		Если Результат.Количество()=0 Тогда
	//			Сообщить("В заказ-наряде, есть нераспределнные запчасти, печать акта невозможна!");
	//			Возврат;
	//		КонецЕсли;
	//	КонецЦикла;
	//	
	//	Источник.Товары.Очистить();
	//	Для Каждого СтрЗН ИЗ ЗН.Работы Цикл
	//		Запрос = Новый Запрос;
	//		Запрос.Текст = 
	//		"ВЫБРАТЬ
	//		|	РаспределениеМатериаловПоРаботамЗН.Номенклатура,
	//		|	РаспределениеМатериаловПоРаботамЗН.Количество
	//		|ИЗ
	//		|	РегистрСведений.РаспределениеМатериаловПоРаботамЗН КАК РаспределениеМатериаловПоРаботамЗН
	//		|ГДЕ
	//		|	РаспределениеМатериаловПоРаботамЗН.ЗаказНаряд = &ЗаказНаряд
	//		|	И РаспределениеМатериаловПоРаботамЗН.Работа = &Работа";
	//		
	//		Запрос.УстановитьПараметр("ЗаказНаряд", ЗН);
	//		Запрос.УстановитьПараметр("Работа", СтрЗН.Работа);
	//		
	//		Результат = Запрос.Выполнить();
	//		ВыборкаДетальныеЗаписи = Результат.Выбрать();
	//		СуммаЗапчасти = 0;
	//		СуммаСкидки = 0;
	//		СуммаЗапчастиБезСкидки=0;
	//		СуммаЗапчастиСоСкидкой=0;
	//		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	//			Стр = ЗН.Товары.Найти(ВыборкаДетальныеЗаписи.Номенклатура, "Номенклатура");
	//			СуммаЗапчастиБезСкидки = СуммаЗапчастиБезСкидки + Стр.Сумма;
	//			СуммаЗапчастиСоСкидкой = СуммаЗапчастиСоСкидкой + Стр.СуммаВсего;
	//			СуммаСкидки = СуммаСкидки + Стр.СуммаСкидки;
	//		КонецЦикла;
	//		
	//		НоваяСтрока=Источник.Товары.Добавить();
	//		НоваяСтрока.Номенклатура				= СтрЗН.Работа;
	//		НоваяСтрока.ЕдиницаИзмерения			= СтрЗН.Нормочас;
	//		НоваяСтрока.Количество					= 1;
	//		НоваяСтрока.Коэффициент					= 1;
	//		НоваяСтрока.СуммаСкидки					= СтрЗН.СуммаСкидки+СуммаСкидки;
	//		НоваяСтрока.ПроцентСкидки				= СтрЗН.ПроцентСкидки;
	//		НоваяСтрока.Цена						= СтрЗН.Сумма + СуммаЗапчастиБезСкидки;
	//		НоваяСтрока.Сумма						= СтрЗН.СуммаВсего + СуммаЗапчастиБезСкидки;
	//		
	//		НоваяСтрока.СтавкаНДС					= СтрЗН.СтавкаНДС;
	//		НоваяСтрока.СуммаНДС					= СтрЗН.СуммаНДС;
	//		НоваяСтрока.СуммаВсего                  = СуммаЗапчастиСоСкидкой + СтрЗН.СуммаВсего;
	//	КонецЦИкла;
	//	Сообщить("Заполнено на основании "+ЗН);
	//	
	//КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаЗаполненияРабочийЛистКредитногоОтдела(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	//Не нужно		
	//Источник.ПодразделениеКомпании = справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000013"); //   Арутюн
	//Источник.Организация = справочники.Организации.НайтиПоКоду("ЦБ000004");
	
	Если ТипЗнч(ДанныеЗаполнения)=Тип("ДокументСсылка.ЗаказНаАвтомобиль") Тогда
		Если ДанныеЗаполнения.ХозОперация = Справочники.ХозОперации.ЗаказНаАвтомобильОтмена Тогда
			СтандартнаяОбработка = Ложь;
			ТекстОшибки = "Ввод на основании Отмены заказа на автомобиль запрещен " + Строка(ДанныеЗаполнения);
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;	
		Основание = ДанныеЗаполнения;
		Источник.ДокументОснование			= Основание;
		Источник.ВалютаДокумента			= Основание.ВалютаДокумента;
		Источник.ВалютаЗаявленногоДохода	= Источник.ВалютаДокумента;
		Источник.Статус						= Справочники.СтатусыРабочегоЛиста.Создан;
		Источник.Клиент						= Основание.Контрагент;
		Источник.Банк						= Основание.Банк;
		Источник.МенеджерКредитногоОтдела	= Основание.Менеджер;
		Источник.Менеджер					= ПараметрыСеанса.Пользователь.Сотрудник;
		Источник.СтоимостьАвтомобиля		= Основание.СуммаВсегоНаАвтомобиль;
		Источник.ПервоначальныйВзнос		= Основание.СуммаПредоплаты;
		Источник.СуммаКредита				= Источник.СтоимостьАвтомобиля - Источник.ПервоначальныйВзнос;
		Источник.ДатаОтправкиАнкеты			= ТекущаяДата();
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаЗаполненияРабочийЛистОтделаСтрахования(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	//Не нужно		
	//Источник.ПодразделениеКомпании = справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000012"); // ЛОпат
	//Источник.Организация = справочники.Организации.НайтиПоКоду("ЦБ000003");		
	
	Если ТипЗнч(ДанныеЗаполнения)=Тип("ДокументСсылка.ЗаказНаАвтомобиль") Тогда
		Если ДанныеЗаполнения.ХозОперация = Справочники.ХозОперации.ЗаказНаАвтомобильОтмена Тогда
			СтандартнаяОбработка = Ложь;
			ТекстОшибки = "Ввод на основании Отмены заказа на автомобиль запрещен " + Строка(ДанныеЗаполнения);
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;	
		Основание = ДанныеЗаполнения;
		Источник.ДокументОснование			= Основание;
		Источник.ВалютаДокумента			= Основание.ВалютаДокумента;
		Источник.Статус						= Справочники.СтатусыРабочегоЛиста.Создан;
		Источник.Страхователь				= Основание.Контрагент;
		Источник.МенеджерОтделаСтрахования	= Основание.Менеджер;
		Источник.Менеджер					= ПараметрыСеанса.Пользователь.Сотрудник;
		//Источник.СтоимостьАвтомобиля		= Основание.СуммаВсегоНаАвтомобиль;
		//Источник.ПервоначальныйВзнос		= Основание.СуммаПредоплаты;
		//Источник.СуммаКредита				= Источник.СтоимостьАвтомобиля - Источник.ПервоначальныйВзнос;
		//Источник.ДатаОтправкиАнкеты			= ТекущаяДата();
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаЗаполненияЧекНаОплату(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	
	Попытка	//доп заполнение чека на оплату
		Если ТипЗнч(ДанныеЗаполнения)=Тип("ДокументСсылка.РабочийЛистОтделаСтрахования") Тогда
			Источник.ПолученоБезнал=ДанныеЗаполнения.ВариантыСтрахования.Итог("СуммаПремии");
			Источник.СуммаДокумента=ДанныеЗаполнения.ВариантыСтрахования.Итог("СуммаПремии");
		// БИЗТЕХ КОВАЛЬ 30.05.2025 ++ Добавил условия для агентских услуг
		ИначеЕсли ТипЗнч(ДанныеЗаполнения)=Тип("ДокументСсылка.РеализацияТоваров") И
			ДанныеЗаполнения.хозОперация = Справочники.ХозОперации.РеализацияАгентскихУслуг Тогда
			
			Источник.ПолученоБезнал =  ДанныеЗаполнения.СуммаДокумента;
			Источник.СуммаДокумента =  ДанныеЗаполнения.СуммаДокумента;
			
		Иначе
			// БИЗТЕХ КОВАЛЬ 28.05.2025 ++
			// Закоментил данные строки так как они мешают алгоритму оплаты через О2 QR, ну и не позволяют адекватно использовать 
			// механизм "оставшейся" суммы оплаты.
			// Если будут проблемы, то нужно добавлять исключение именно для оплат О2
			
			//Источник.ПолученоБезнал =  ДанныеЗаполнения.СуммаДокумента;
			//Источник.СуммаДокумента =  ДанныеЗаполнения.СуммаДокумента;
			
			// БИЗТЕХ КОВАЛЬ 28.05.2025 --
		КонецЕсли;	
		Источник.ДатаФР = ТекущаяДата();
		Если Источник.Оплаты.Количество()=0 Тогда
			НоваяОплата = Источник.Оплаты.Добавить();
			НоваяОплата.Сумма =  Источник.СуммаДокумента;
			НоваяОплата.ТипОплаты = Справочники.ТипыОплат.Безналичные;
			НоваяОплата.ТипПлатежнойКарты=справочники.ТипыПлатежныхКарт.Visa;
			НоваяОплата.Контрагент = обПолучитьПраваИНастройкиПользователя(Источник.ПодразделениеКомпании,"ОсновнаяПлатежнаяСистема");	
			//БИЗТЕХ КОВАЛЬ 29.08.2024
			//брать договор из значения свойств из подразделения
				Попытка
					ДоговорВзаиморасчетовКодОплаты = обПолучитьЗначениеСвойства(Источник.ПодразделениеКомпании,"Код договора для оплаты");
					Если ЗначениеЗаполнено(ДоговорВзаиморасчетовКодОплаты) тогда
						ДоговорВзаиморасчетовОплаты	= Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду(ДоговорВзаиморасчетовКодОплаты);
					КонецЕсли;
					Если ЗначениеЗаполнено(ДоговорВзаиморасчетовОплаты) тогда
						НоваяОплата.ДоговорВзаиморасчетов = ДоговорВзаиморасчетовОплаты;
					КонецЕсли;
				Исключение;
					НоваяОплата.ДоговорВзаиморасчетов = обПолучитьПраваИНастройкиПользователя(Источник.Организация,"ЭквайрингДоговорОПС");		
				КонецПопытки;
			//НоваяОплата.ДоговорВзаиморасчетов = обПолучитьПраваИНастройкиПользователя(Источник.Организация,"ЭквайрингДоговорОПС");
			//БИЗТЕХ КОВАЛЬ --
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	ОбработкаЗаполненияККМ(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина);		
	
	
КонецПроцедуры

Процедура ОбработкаЗаполненияСчетФактураПолученный(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	Если ТипЗнч(ДанныеЗаполнения)=Тип("ДокументСсылка.ПоступлениеТоваров") Тогда
		
		Источник.ВхДокНомер=ДанныеЗаполнения.ВхДокНомер;		
		Источник.ВхДокДата=ДанныеЗаполнения.ВхДокДата;
		Источник.Дата=ДанныеЗаполнения.ВхДокДата;
		
	ИначеЕсли ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ПоступлениеДопРасходовНаАвтомобили") Тогда
		
		Источник.Автор = ДанныеЗаполнения.Автор;
		Источник.ВалютаДокумента = ДанныеЗаполнения.ВалютаДокумента;
		Источник.ВхДокДата = ДанныеЗаполнения.ВхДокДата;
		Источник.ДатаИсходногоДокумента = ДанныеЗаполнения.ВхДокДата;
		Источник.ВхДокНомер = ДанныеЗаполнения.ВхДокНомер;
		Источник.НомерИсходногоДокумента = ДанныеЗаполнения.ВхДокНомер;
		Источник.ДоговорВзаиморасчетов = ДанныеЗаполнения.ДоговорВзаиморасчетов;
		Источник.Комментарий = ДанныеЗаполнения.Комментарий;
		Источник.Контрагент = ДанныеЗаполнения.Контрагент;
		Источник.Грузоотправитель = ДанныеЗаполнения.Контрагент;
		Источник.КурсДокумента = ДанныеЗаполнения.КурсДокумента;
		Источник.Организация = ДанныеЗаполнения.Организация;
		Источник.ПодразделениеКомпании = ДанныеЗаполнения.ПодразделениеКомпании;
		Источник.Проект = ДанныеЗаполнения.Проект;
		Источник.РегламентированныйУчет = ДанныеЗаполнения.РегламентированныйУчет;
		Источник.ДокументОснование = ДанныеЗаполнения.Ссылка;
		Источник.СуммаДокумента = ДанныеЗаполнения.СуммаДокумента;
		Источник.ТипЦен = ДанныеЗаполнения.ТипЦен;
		Источник.ХозОперация = ДанныеЗаполнения.ХозОперация;
		Источник.ДатаСоздания = ТекущаяДата();
		Источник.Дата=ДанныеЗаполнения.Дата;
		Для Каждого ТекСтрокаАвтомобили Из ДанныеЗаполнения.Автомобили Цикл
			НоваяСтрока = Источник.Товары.Добавить();
			НоваяСтрока.Номенклатура = ТекСтрокаАвтомобили.Автомобиль;
			НоваяСтрока.Количество = ТекСтрокаАвтомобили.Количество;
			НоваяСтрока.СтавкаНДС = ТекСтрокаАвтомобили.СтавкаНДС;
			НоваяСтрока.Сумма = ТекСтрокаАвтомобили.Сумма;
			НоваяСтрока.СуммаВсего = ТекСтрокаАвтомобили.СуммаВсего;
			НоваяСтрока.СуммаНДС = ТекСтрокаАвтомобили.СуммаНДС;
			НоваяСтрока.Цена = ТекСтрокаАвтомобили.Цена;
			НоваяСтрока.ЕдиницаИзмерения=Справочники.ЕдиницыИзмерения.НайтиПоНаименованию("-").Ссылка;
			НоваяСтрока.Коэффициент=1;
		КонецЦикла;		
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверкаЗаполненияСтатьиДДСУпр(Источник, Отказ, РежимПроведения) 
	
	Если Источник.Дата < Дата(2013, 8, 30) Тогда
		Возврат;
	КонецЕсли;	
	
	МассивПроверяемыхДокументов=Новый Массив;
	МассивПроверяемыхДокументов.Добавить("ПриходныйКассовыйОрдер");
	МассивПроверяемыхДокументов.Добавить("ПеремещениеДенежныхСредств");
	МассивПроверяемыхДокументов.Добавить("Выписка");
	МассивПроверяемыхДокументов.Добавить("РасходныйКассовыйОрдер");
	МассивПроверяемыхДокументов.Добавить("АктПриемаПередачиЦенныхБумаг");
	МассивПроверяемыхДокументов.Добавить("ПереоценкаВалютныхСредств");
	МассивПроверяемыхДокументов.Добавить("ВыплатаЗарплаты");
	
	Если МассивПроверяемыхДокументов.Найти(Источник.Метаданные().Имя) = Неопределено Тогда	
		Возврат;
	КонецЕсли;
	
	НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();	
	НаборЗаписей.Отбор.Объект.Установить(Источник.Ссылка);
	НаборЗаписей.Отбор.Свойство.Установить(ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Статья ДДС Упр"));
	НаборЗаписей.Прочитать();
	
	Если НаборЗаписей.Количество() = 0 или НаборЗаписей[0].Значение = Неопределено Тогда
		Сообщить("Необходимо указать Статью ДДС управленческого учета. Для этого сначала документ нужно записать, затем в Панели свойств указать Статью ДДС управленческого учета и после этого провести документ.");
		Отказ = Истина;
	Иначе
		
		Если РольДоступна("ВосстПослед") Тогда
			Возврат;
		КонецЕСли;	
		
		//*Проверка Статей на вид движения документа*_anton    
		СтатьяДДССсылка=НаборЗаписей[0].Значение;
		
		ГруппаПриходныхСтатей = "ПД";
		ГруппаРасходныхСтатей = "РД"; 
		ГруппаВыбраннойСтатьи = Лев(СокрЛП(СтатьяДДССсылка.Код),2);
		
		//Приходный кассовый ордер	
		Если Источник.Ссылка.Метаданные().Имя = "ПриходныйКассовыйОрдер" Тогда 
			
			Если ГруппаВыбраннойСтатьи  <> ГруппаПриходныхСтатей Тогда
				Сообщить("Вид статьи ДДС (Приход/Расход) не соответствует типу документа");
				Отказ = Истина;	
			КонецЕсли;
			
			//Расходный кассовый ордер		
		ИначеЕсли Источник.Ссылка.Метаданные().Имя = "РасходныйКассовыйОрдер" Тогда 
			
			Если ГруппаВыбраннойСтатьи  <> ГруппаРасходныхСтатей Тогда
				Сообщить("Вид статьи ДДС (Приход/Расход) не соответствует типу документа");
				Отказ = Истина;		
			КонецЕсли;
			
			//Банковская Выписка
		ИначеЕсли Источник.Ссылка.Метаданные().Имя = "Выписка" Тогда
			
			Если Источник.Ссылка.СуммаДокументаПриход > 0 И ГруппаВыбраннойСтатьи  <> ГруппаПриходныхСтатей Тогда
				Сообщить("Вид статьи ДДС (Приход/Расход) не соответствует типу документа");
				Отказ = Истина;	
			КонецЕсли;
			
			Если Источник.Ссылка.СуммаДокументаРасход > 0 И ГруппаВыбраннойСтатьи  <> ГруппаРасходныхСтатей Тогда
				Сообщить("Вид статьи ДДС (Приход/Расход) не соответствует типу документа");
				Отказ = Истина;		
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;	
	//*Проверка Статей на вид движения документа* Конец
	
КонецПроцедуры

Процедура ПроверкаНаНаличиеРодителя(Источник, Отказ) 
	
	МассивПроверяемых=Новый Массив;
	МассивПроверяемых.Добавить("Автомобили");
	МассивПроверяемых.Добавить("Номенклатура");
	МассивПроверяемых.Добавить("Контрагенты");
	МассивПроверяемых.Добавить("Модели");
	
	Если МассивПроверяемых.Найти(Источник.Метаданные().Имя) = Неопределено Тогда	
		Возврат;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Источник.Родитель) И Не Источник.ЭтоГруппа и НЕ РольДоступна(Метаданные.Роли.ПолныеПрава) Тогда
		
		#Если Клиент Тогда
			ФормаВыбора = Справочники[Источник.Метаданные().Имя].ПолучитьФормуВыбораГруппы(); 
			ФормаВыбора.Заголовок	= "Выберите группу!";
			Источник.Родитель = ФормаВыбора.ОткрытьМодально();  
		#КонецЕсли
		
		Если Не ЗначениеЗаполнено(Источник.Родитель)  Тогда
			Если ТипЗнч(Источник)  = Тип("СправочникОбъект.Автомобили") Тогда						
				Если ЗначениеЗаполнено(Источник.VIN) Тогда				
					Отказ = Истина;
				КонецЕсли;
			Иначе			
				Отказ = Истина;
			КонецЕсли;
			
		КонецЕсли;
		
		Если Отказ Тогда
			Сообщить("Операция не выполнена. Группа элемента не может быть пустой.");
		КонецЕсли;
		
	КонецЕсли;
	
	
КонецПроцедуры

Процедура ПроверкаНеЗакрытыхЗН(Источник, Отказ, РежимПроведения) 
	#Если Клиент Тогда
		
		//Если РольДоступна("ПолныеПрава") и НЕ РольДоступна("ВосстПослед") Тогда
		//	Возврат;
		//КонецЕсли;
		
		//Если НЕ РольДоступна("ВосстПослед") Тогда
			//Возврат;
		//КонецЕсли;
		
		//Отказ незакрыт ЗН 
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаказНаряд.Номер,
		|	ЗаказНаряд.Дата,
		|	ЗаказНаряд.Автомобиль
		|ИЗ
		|	Документ.ЗаказНаряд КАК ЗаказНаряд
		|ГДЕ
		|	ЗаказНаряд.Состояние <> ЗНАЧЕНИЕ(Справочник.ВидыСостоянийЗаказНарядов.Закрыт)
		|	И ЗаказНаряд.Состояние <> &Отклонен
		|	И ЗаказНаряд.Состояние <> &ДляИстории
		|	И ЗаказНаряд.Автомобиль В(&Автомобили)
		|	И (ЗаказНаряд.ВидРемонта В (&ВидРемонта))  
		|	И ЗаказНаряд.ДатаСоздания <= &РеализацияДата
		|	И НЕ ЗаказНаряд.ПометкаУдаления";
		
		ВидРемонта = Новый СписокЗначений;	
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("00000001")); //Дополнительное оборудование
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("00000002")); //Комплектация автомобиля
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000001")); //Акция
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000002")); //Акция (ТО)
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000003")); //Акция (ТО) для ОПА
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000004")); //Акция для ОПА
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000005")); //Возмещение ТУ
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000006")); //Возмещение ТУ с НДС
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000007")); //Восстановление товарных а/м
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000008")); //Восстановление товарных а/м для ОПА
		
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000012")); //Диагностика ТРЕЙД ИН
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000013")); //Диагностика ТРЕЙД ИН платный
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000014")); //Дополнительное оборудование с НДС
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000015")); //доработка автомобиля
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000016")); //Комплектация автомобиля для ОПА
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000017")); //Комплектация автомобиля_К
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000018")); //Комплектация автомобиля П
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000019")); //Комплектация автомобиля П для ОПА
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000020")); //Мойка автомобиля 
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000021")); //Мойка товарных автомобилей
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000022")); //Мойка товарных автомобилей для ОПА
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000023")); //Предпродажная подготовка
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000024")); //Предпродажная подготовка для ОПА
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000025")); //ПСО по контрактам
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000026")); //ПСО по контрактам с НДС
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000027")); //Рекламация для ОПА
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000028")); //Рекламация ОПА
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000029")); //Рекламация Сервис
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000030")); //Рекламация Сервис  (GoodWill)
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000031")); //Ремонт автомобилей для тест-драйва
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000032")); //Ремонт автомобилей для тест-драйва для ТТ
		
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000033")); //Сервисный клиентский заказ
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000034")); //Сервисный клиентский заказ с НДС
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000035")); //Страховой ремонт
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000036")); //Страховой ремонт ОСАГО
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000037")); //Техническое обслуживание (ТО)
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000038")); //Техническое обслуживание (ТО) с НДС
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000039")); //ТО и ремонт подменных автомобилей
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000040")); //ТО и ремонт служебных автомобилей
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000041")); //ТО и ремонт служебных автомобилей ОПА
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000042")); //Кузовной ремонт
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000043")); //Гарантия диллера
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000044")); //Гарантия дилера
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000045")); //Детейлинг автомобилей
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000046")); //Детейлинг автомобилей для ОПА
		ВидРемонта.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000049")); //Сервисные мероприятия

		
		Запрос.УстановитьПараметр("Автомобили", Источник.Автомобили.ВыгрузитьКолонку("Автомобиль"));
		Запрос.УстановитьПараметр("Отклонен", Справочники.ВидыСостоянийЗаказНарядов.НайтиПоКоду("ЦБ00000001"));
		Запрос.УстановитьПараметр("ДляИстории", Справочники.ВидыСостоянийЗаказНарядов.НайтиПоКоду("ЦБ00000007"));
		Запрос.УстановитьПараметр("ВидРемонта", ВидРемонта);
		Запрос.УстановитьПараметр("РеализацияДата", Источник.Дата);
		
		Результат = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = Результат.Выбрать();
		
		ПервыйРаз = Истина;
		ТекстСообщения = "";
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			Если ПервыйРаз Тогда 
				ТекстСообщения = "Есть незакрытые Заказ-наряды по автомобилю "+ВыборкаДетальныеЗаписи.Автомобиль+" : ";
				ПервыйРаз = Ложь;	
			КонецЕсли;	
			Отказ = Истина;          //Павличенко 07.10.2020
			ТекстСообщения = ТекстСообщения+"
			|Заказ-наряд №" + ВыборкаДетальныеЗаписи.Номер + " от " + Формат(ВыборкаДетальныеЗаписи.Дата, "ДЛФ=Д");				
		КонецЦикла;
		
		Если НЕ ПервыйРаз Тогда
			//Предупреждение(ТекстСообщения);
			Сообщить(ТекстСообщения);
		КонецЕсли;			
		
	#КонецЕсли	
	
КонецПроцедуры

Процедура ПроверкаНомераЗНОрганизация(Источник, Отказ) 
	
	Если НЕ ЗначениеЗаполнено(Источник.Номер) Тогда 
		Возврат;
	КонецЕсли;	
	Если Источник.Дата < Дата(2013, 12, 23) Тогда 
		Возврат;
	КонецЕсли;
	
	Если Лев(Источник.Номер, 2) = "ТТ" И Источник.Организация <> Справочники.Организации.НайтиПоРеквизиту("ИНН", "2312127750")  
		ИЛИ Лев(Источник.Номер, 2) = "ТА" И Источник.Организация <> Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514") 
		Тогда
		Источник.УстановитьНовыйНомер();
	КонецЕсли;	
	
КонецПроцедуры

Процедура ПроверкаКорректностиПеремещения(Источник, Отказ, РежимПроведения) 
	
	Возврат; //Отключено
	
	#Если Клиент Тогда
		Если РольДоступна("ПолныеПрава") И НЕ РольДоступна("ВосстПослед") Тогда
			Возврат;
		КонецЕсли;
		
		Если Источник.Товары.Количество() = 0 Тогда
			Отказ=Истина;
			Сообщить("Невозможно провести пустое перемещение в производство!");
		КонецЕсли;
		
		Если Источник.СкладКомпании = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000135")  //Товары в пути
			И НЕ ( Источник.СкладПолучатель = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000107")   //склад инструментов
			ИЛИ Источник.СкладПолучатель = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000009") ) Тогда  // Основной склад запчастей
			
			Отказ = Истина;	
			Сообщить("Нельзя перемещать товары со склада Товары в пути напрямую на указанный склад получатель !");	
		КонецЕсли;	
		
		Если Источник.СкладКомпании = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000133")  //Товар в пути ТАС
			И НЕ (( Источник.СкладПолучатель = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000099") ИЛИ Источник.СкладПолучатель = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000111"))
			//Основной склад запчастей ТАС     //Склад запчастей ТАС возврат поставщику
			
			//ИЛИ Источник.СкладПолучатель = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000099")     //Основной склад оборудования ГАЗ
			ИЛИ Источник.СкладПолучатель = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000105")     //Основной склад инструментов ТАС
			ИЛИ Источник.СкладПолучатель = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000083")     //Основной склад запчастей ГАЗ гарантия
			//ИЛИ Источник.СкладПолучатель = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000111")     //Склад запчастей ТАС возврат поставщику
			ИЛИ Источник.СкладПолучатель = справочники.СкладыКомпании.НайтиПоКоду("ЦБ000004") ) Тогда  // Основной склад запчастей ГАЗ
			
			Отказ = Истина;	
			Сообщить("Нельзя перемещать товары со склада Товары в пути ТАС напрямую на указанный склад получатель !");	
		КонецЕсли;	
		
	#КонецЕсли	
	
КонецПроцедуры

Процедура ПроверкаОстатковПоОрганизации(Источник, Отказ, РежимПроведения) 
	
	МассивПроверяемыхДокументов=Новый Массив;
	МассивПроверяемыхДокументов.Добавить("РеализацияТоваров");
	МассивПроверяемыхДокументов.Добавить("ПеремещениеТоваров");
	МассивПроверяемыхДокументов.Добавить("ПеремещениеТоваровВПроизводство");
	
	Если МассивПроверяемыхДокументов.Найти(Источник.Метаданные().Имя) = Неопределено Тогда	
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПартииТоваровКомпанииОстатки.Номенклатура,
	|	ПартииТоваровКомпанииОстатки.КоличествоОстаток КАК Количество
	|ИЗ
	|	РегистрНакопления.ПартииТоваровКомпании.Остатки(
	|			&МоментВремени,
	|			Номенклатура В (&Номенклатура)
	|				И СкладКомпании.Организация = &Организация
	|				И Номенклатура.ТипНоменклатуры <> &Услуга) КАК ПартииТоваровКомпанииОстатки";
	
	Запрос.УстановитьПараметр("МоментВремени", Источник.МоментВремени());
	Запрос.УстановитьПараметр("Номенклатура", Источник.Товары.ВыгрузитьКолонку("Номенклатура"));
	Запрос.УстановитьПараметр("Организация", Источник.Организация);
	Запрос.УстановитьПараметр("Услуга", Справочники.ТипыНоменклатуры.Услуга);
	
	ТаблицаОстатков = Запрос.Выполнить().Выгрузить();
	
	НеХватаетОстатков = Ложь;
	Для Каждого СтрДок Из Источник.Товары Цикл 
		Если СтрДок.Номенклатура.ТипНоменклатуры = Справочники.ТипыНоменклатуры.Услуга Тогда
			Продолжить;
		КонецЕсли;	
		НайденнаяСтрока = ТаблицаОстатков.Найти(СтрДок.Номенклатура, "Номенклатура");		
		Если НайденнаяСтрока = Неопределено Тогда
			Сообщить("Товара """ + СтрДок.Номенклатура + """ (строка таблицы: " + СтрДок.НомерСтроки + ") нет на остатках организации " + Источник.Организация);				
			НеХватаетОстатков = Истина;
		КонецЕсли;	
	КонецЦикла;		
	
	//<<Павличенко 30.11.17
	//корректнее так, т.к. проверка соответствия договоров-организации уже установила отказ в истину, а эта разрешила проведение, что неверно
	//Отказ = НеХватаетОстатков;
	Отказ = ?(Отказ = Ложь, НеХватаетОстатков, Отказ);
	//>>Павличенко 30.11.17
КонецПроцедуры

Процедура ПроверкаОрганизацииЗНПеремещение(Источник, Отказ, РежимПроведения) 
	Если РольДоступна("ПолныеПрава") Тогда 
		Возврат;	
	КонецЕсли;	
	
	Если Источник.Состояние <> Справочники.ВидыСостоянийЗаказНарядов.Закрыт Тогда 
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПеремещениеТоваровВПроизводство.Ссылка КАК Перемещение
	|ИЗ
	|	Документ.ПеремещениеТоваровВПроизводство КАК ПеремещениеТоваровВПроизводство
	|ГДЕ
	|	ПеремещениеТоваровВПроизводство.ДокументОснование = &ЗаказНаряд";
	
	Запрос.УстановитьПараметр("ЗаказНаряд", Источник.Ссылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	СтрокаВывода = "Есть документы ""Перемещение в производство"", у которых организация отличается от организации в документа ""Заказ наряд"":" + Символы.ПС;
	Есть = Ложь;
	Пока Выборка.Следующий() Цикл
		Если Выборка.Перемещение.Организация <> Источник.Организация Тогда 
			Есть = Истина;
			СтрокаВывода = СтрокаВывода + Выборка.Перемещение + Символы.ПС;
		КонецЕсли;	
	КонецЦикла;	
	
	Если Есть Тогда 
		Сообщить(СтрокаВывода);
		Отказ = Истина;
		Возврат;
	КонецЕсли;	
	
КонецПроцедуры

Процедура ПроверкаПСО(Источник, Отказ, РежимПроведения)  
	#Если Клиент Тогда
		
		Если РольДоступна("ПолныеПрава") ИЛИ РольДоступна("ВосстПослед") Тогда
			Возврат;
		КонецЕсли;
		
		Если Источник.Дата < Дата(2013, 12, 30) Тогда 
			Возврат;
		КонецЕсли;	
		
		Если Источник.Контрагент = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2312205455") ИЛИ  // Темп Авто ФКДД
			Источник.Контрагент = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2311093925") Тогда // Темп Авто Кубань
			Возврат;
		КонецЕсли;
		
		Если Источник.СкладКомпании = Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000164") ИЛИ
			Источник.СкладКомпании = Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000145") ИЛИ
			Источник.СкладКомпании = Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000141") ИЛИ
			Источник.СкладКомпании = Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000146") ИЛИ
			Источник.СкладКомпании = Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000147") 			
			Тогда 
			Возврат;
		КонецЕсли;;	
		//-------------------------------------allgk-------------------------------------//
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЗаказНаряд.Автомобиль КАК Автомобиль
		|ИЗ
		|	Документ.ЗаказНаряд КАК ЗаказНаряд
		|ГДЕ
		|	ЗаказНаряд.ВидРемонта В(&ВидыРемонтаПСО)
		|	И ( ЗаказНаряд.Состояние = &СостояниеОтказ
		|	ИЛИ ЗаказНаряд.Состояние = &СостояниеЗакрыт 
		|	ИЛИ ЗаказНаряд.Состояние = &ДляИстории )
		|	И ЗаказНаряд.Автомобиль В(&Автомобили)";
		
		
		ВидыРемонтаПСО = Новый СписокЗначений;	
		ВидыРемонтаПСО.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000024")); 	// ПСО для ТТ
		ВидыРемонтаПСО.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000025")); 	// ПСО по контрактам
		ВидыРемонтаПСО.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000026")); 	// ПСО по контрактам с НДС
		ВидыРемонтаПСО.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000023")); 		// ПСО, работы с парком новых автомобилей
		
		Запрос.УстановитьПараметр("Автомобили", Источник.Автомобили.ВыгрузитьКолонку("Автомобиль"));
		Запрос.УстановитьПараметр("СостояниеОтказ", Справочники.ВидыСостоянийЗаказНарядов.НайтиПоНаименованию("Отказ от ремонта"));
		Запрос.УстановитьПараметр("ДляИстории", Справочники.ВидыСостоянийЗаказНарядов.НайтиПоНаименованию("Для истории автомобиля"));
		Запрос.УстановитьПараметр("СостояниеЗакрыт", Справочники.ВидыСостоянийЗаказНарядов.Закрыт);
		Запрос.УстановитьПараметр("ВидыРемонтаПСО", ВидыРемонтаПСО);
		
		МашиныПСО = Запрос.Выполнить().Выгрузить();                                
		
		СтрокаВывода = "На машину(ы) нет заказ-нарядов ПСО!" + Символы.ПС;
		Выводить = Ложь;
		Для Каждого Стр Из Источник.Автомобили Цикл 
			Если МашиныПСО.Найти(Стр.Автомобиль) = Неопределено Тогда 
				СтрокаВывода = СтрокаВывода + Строка(Стр.Автомобиль) + Символы.ПС;
				Выводить = Истина;
			КонецЕсли;	
		КонецЦикла;
		
		Если Выводить Тогда 
			Сообщить(СтрокаВывода);
			Отказ = Истина;
		КонецЕсли;	
		
		Для каждого Строка из Источник.Автомобили Цикл
			Запрос = Новый Запрос;
			Запрос.Текст= 
			"ВЫБРАТЬ
			|	ЗаказНаАвтомобиль.Ссылка
			|ИЗ
			|	Документ.ЗаказНаАвтомобиль КАК ЗаказНаАвтомобиль
			|ГДЕ
			|	ЗаказНаАвтомобиль.Автомобиль = &Авто
			|	И ЗаказНаАвтомобиль.Проведен = ИСТИНА";
			Запрос.УстановитьПараметр("Авто",Строка.Автомобиль);
			Если Запрос.Выполнить().Пустой() Тогда
				Отказ=Истина;
				Сообщить("Невозможно провести реализацию без заказа на автомобиль: "+Строка.Автомобиль);
			КонецЕсли;
		КонецЦикла;
		
	#КонецЕсли
	
	
КонецПроцедуры

Процедура ПоступАвтПриПроведПСО(Источник, Отказ, РежимПроведения) 
	#Если Клиент Тогда
		Если РольДоступна("ПолныеПрава") Тогда
			Возврат;	
		КонецЕсли;
		
		Если НЕ Источник.ХозОперация.Код = "010400" И НЕ Источник.ХозОперация.Код = "012005" Тогда
			Возврат;
		КонецЕсли;
		
		Для каждого Стр из Источник.Автомобили Цикл	
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
			|	ЗаказНаряд.Ссылка
			|ИЗ
			|	Документ.ЗаказНаряд КАК ЗаказНаряд
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиАвтомобилей.Остатки(&Дата, ) КАК ОстаткиАвтомобилейОстатки
			|		ПО ЗаказНаряд.Автомобиль = ОстаткиАвтомобилейОстатки.Автомобиль
			|ГДЕ
			|	ЗаказНаряд.ВидРемонта = &ПСО
			|	И ЗаказНаряд.ПометкаУдаления = ЛОЖЬ
			|	И ЗаказНаряд.Автомобиль = &Авто
			|	И ЗаказНаряд.Дата >= &ТекДата";
			Запрос.УстановитьПараметр("ПСО",справочники.ВидыРемонта.НайтиПоКоду("ЦБ000024"));
			Запрос.УстановитьПараметр("Авто",Стр.Автомобиль); 
			Запрос.УстановитьПараметр("Дата",ТекущаяДата());
			Запрос.УстановитьПараметр("ТекДата", Источник.Дата);
			
			Рез = Запрос.Выполнить().Выбрать();
			
			Если рез.Количество() = 0 Тогда
				Если Вопрос("Создать Заказ-наряд ""ПСО для ТТ"" для "+Стр.Автомобиль+" ?",РежимДиалогаВопрос.ДаНет)=КодВозвратаДиалога.Да Тогда				
					Если обЗначениеНеЗаполнено(Стр.Автомобиль.Модель) Тогда  
						Сообщить("Не указана модель автомобиля "+Стр.Автомобиль+". ПСО не создан!");	
						Возврат;
					КонецЕсли;
					
					ЗапросАвторабот = Новый Запрос;
					ЗапросАвторабот.Текст ="ВЫБРАТЬ
					|	НазначениеАвторабот.Модель,
					|	НазначениеАвторабот.Авторабота,
					|	НазначениеАвторабот.Сумма,
					|	ВЫБОР
					|		КОГДА НЕ ЕСТЬNULL(НазначениеАвторабот.Модель.Родитель.Родитель.Родитель, """") = """"
					|			ТОГДА НазначениеАвторабот.Модель.Родитель.Родитель
					|		ИНАЧЕ ВЫБОР
					|				КОГДА НЕ ЕСТЬNULL(НазначениеАвторабот.Модель.Родитель.Родитель, """") = """"
					|					ТОГДА НазначениеАвторабот.Модель.Родитель
					|				ИНАЧЕ ВЫБОР
					|						КОГДА НЕ ЕСТЬNULL(НазначениеАвторабот.Модель.Родитель, """") = """"
					|							ТОГДА НазначениеАвторабот.Модель.Родитель
					|						ИНАЧЕ НазначениеАвторабот.Модель
					|					КОНЕЦ
					|			КОНЕЦ
					|	КОНЕЦ КАК Брэнд,
					|	НазначениеАвторабот.Нормочас
					|ИЗ
					|	Справочник.НазначениеАвторабот КАК НазначениеАвторабот" ;
					//ЗапросАвторабот.УстановитьПараметр("Организация",Справочники.Организации.НайтиПоКоду("ИПК00001"));
					
					БрэндАвто = ТТ_Общий.ПолучитьБрэнд(Стр.Автомобиль.Модель);
					Работы = ЗапросАвторабот.Выполнить().Выгрузить();
					//Ищем
					НайденнаяСтрока = Работы.Найти(Стр.Автомобиль.Модель,"Модель");
					Если НайденнаяСтрока = Неопределено Тогда
						НайденнаяСтрока = Работы.Найти(Стр.Автомобиль.Модель.Родитель ,"Модель");
					КонецЕсли;
					Если НайденнаяСтрока = Неопределено Тогда
						НайденнаяСтрока = Работы.Найти(БрэндАвто,"Модель");	
					КонецЕсли;
					Если НайденнаяСтрока = Неопределено Тогда
						НайденнаяСтрока = Работы.Найти(БрэндАвто,"Брэнд");	
					КонецЕсли;
					
					//создаем заказ-наряд
					
					НовыйПСО = Документы.ЗаказНаряд.СоздатьДокумент();
					НовыйПСО.ОбработкаЗаполнения(Неопределено,"",Истина);
					НовыйПСО.Автомобиль=Стр.Автомобиль;
					НовыйПСО.ВидРемонта= справочники.ВидыРемонта.НайтиПоКоду("ЦБ000024"); //ПСО для ТТ
					НовыйПСО.Заказчик = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2312127750"); //Техно-темп
					НовыйПСО.Контрагент = НовыйПСО.Заказчик;
					
					Если БрэндАвто = Справочники.Модели.НайтиПоКоду("ЦБ00000025") Или БрэндАвто = Справочники.Модели.НайтиПоКоду("ЦБ00000062") Тогда //ГАЗ, ПАЗ
						НовыйПСО.Организация= Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");  //ООО "Темп Авто Сервис"
						НовыйПСО.ПодразделениеКомпании= справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000126");  //Сервис ГАЗ ТАС			
						НовыйПСО.ДоговорВзаиморасчетов= справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ053231"); // Договор ТО и ремонта ТАС	
						НовыйПСО.Цех = Справочники.Цеха.НайтиПоКоду("ЦБ000002");
					Иначе	 //Остальные
						НовыйПСО.Организация= Справочники.Организации.НайтиПоРеквизиту("ИНН", "090103290098");  //Кунова
						НовыйПСО.ПодразделениеКомпании= справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000108");			
						НовыйПСО.ДоговорВзаиморасчетов= справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ055360");
						НовыйПСО.Цех = Справочники.Цеха.НайтиПоКоду("ЦБ000040");
					КонецЕсли;
					
					Если НЕ НайденнаяСтрока = Неопределено Тогда
						НоваяСтрока=НовыйПСО.Работы.Добавить();						
						НоваяСтрока.Работа= НайденнаяСтрока.Авторабота;
						НовыйПСО.ОбработкаРеквизита("Работы.Работа",НоваяСтрока);
						НоваяСтрока.Нормочас = НайденнаяСтрока.Нормочас;
						НовыйПСО.ОбработкаРеквизита("Работы.Нормочас",НоваяСтрока);
						НоваяСтрока.ИдентификаторРаботы = Новый УникальныйИдентификатор;
						Если обЗначениеНеЗаполнено(НоваяСтрока.Коэффициент) Тогда
							НоваяСтрока.Коэффициент = 1;
						КонецЕсли;
						Если  НайденнаяСтрока.Сумма = 0 Тогда
							НоваяСтрока.Цена = НайденнаяСтрока.Нормочас.Цена;
							НоваяСтрока.Сумма = НайденнаяСтрока.Нормочас.Цена;
						Иначе
							НоваяСтрока.Цена = НайденнаяСтрока.Сумма;
							НоваяСтрока.Сумма = НайденнаяСтрока.Сумма;
						КонецЕсли;	
					КонецЕсли;
					Попытка
						НовыйПСО.Записать();
						НовыйПСО.Записать(РежимЗаписиДокумента.Проведение);
						Сообщить("Создан Заказ-наряд с видом ремонта ПСО для ТТ: "+НовыйПСО.Ссылка+". Автомобиль: "+Стр.Автомобиль);
					Исключение
					КонецПопытки;
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
	#КонецЕсли
	
	
КонецПроцедуры

Процедура ПроверкаПоступленияНеликвидов(Источник, Отказ, РежимПроведения) 
	
	Если РольДоступна("ПолныеПрава") ИЛИ РольДоступна("ВосстПослед") Тогда 
		Возврат;
	КонецЕсли;
	
	Если Источник.Контрагент.Код = "ЦБ001303" или  Источник.Контрагент.Код = "ЦБ001314" или  Источник.Контрагент.Код = "ЦБ007393" или  Источник.Контрагент.Код = "ЦБ211345" 
		или  Источник.Контрагент.Код = "ЦБ002733" тогда
		Возврат;
	КонецЕсли;
	
	
	Если Источник.Дата < Дата(2014, 2, 20) Тогда 
		Возврат;			
	КонецЕсли;	
	
	//+Тарабанов разрешение на оприходование нелеквида
	
	//anton
	Если ОбПраво("РазрешеноОприходоватьНеликвид") Тогда
		Возврат;
	КонецЕсли;
	//anton
	
	СвйоствоНеликвид = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("СвойствоНеликвид");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЗначенияСвойствОбъектов.Объект КАК Номенклатура
	|ИЗ
	|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|ГДЕ
	|	ЗначенияСвойствОбъектов.Свойство = &СвйоствоНеликвид
	|	И (ЗначенияСвойствОбъектов.Значение = 1
	|			ИЛИ ЗначенияСвойствОбъектов.Значение = 2)
	|	И ЗначенияСвойствОбъектов.Объект В(&Номенклатура)";
	
	Запрос.УстановитьПараметр("Номенклатура", Источник.Товары.ВыгрузитьКолонку("Номенклатура"));
	Запрос.УстановитьПараметр("СвйоствоНеликвид", СвйоствоНеликвид);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	СтрокаВывода = "Запрещено ставить на приход неликвидный товар" + Символы.ПС;
	ЕстьНеликвид = Ложь;
	Пока Выборка.Следующий() Цикл
		СтрокаВывода = СтрокаВывода + Выборка.Номенклатура.Наименование + " " + Выборка.Номенклатура.Артикул + Символы.ПС;
		ЕстьНеликвид = Истина;
	КонецЦикла;
	Если ЕстьНеликвид Тогда 
		Сообщить(СтрокаВывода);
		Отказ = Истина;
	КонецЕсли;	
	
КонецПроцедуры

Процедура ПроверкаОрганизацииДоговор(Источник, Отказ) 
	
	#Если Клиент Тогда
		Если Источник.ЭтоНовый() ИЛИ РольДоступна("ПолныеПрава") ИЛИ ОбПраво("ИзменениеДоговоров") Тогда
			Возврат;
		КонецЕсли;
		Дог = Источник.Ссылка.ПолучитьОбъект();
		Если Дог.Организация <> Источник.организация ИЛИ Дог.подразделение <> Источник.подразделение ИЛИ Дог.ВидДоговора <> Источник.ВидДоговора Тогда
			Сообщить("Вы не можете менять Подразделение, Организацию и Вид договора!");
			Отказ=Истина;
		КонецЕсли;
	#КонецЕсли		
	
КонецПроцедуры

Процедура РабочийЛистПроверкаЗаполнения(Источник, Отказ)
	#Если Клиент Тогда	
		
		Если РольДоступна("ПолныеПрава") Тогда 
			Возврат;
		КонецЕсли;
		
		
		Если обЗначениеНеЗаполнено(Источник.Модель) Тогда
			Отказ=Истина;
			Предупреждение("Не заполнена Модель!");
			Возврат;		
		КонецЕсли;
		
		Если обЗначениеНеЗаполнено(Источник.ПредставлениеТелефона) Тогда
			Отказ=Истина;
			Предупреждение("Не заполнен Телефон!");
			Возврат;		
		КонецЕсли;
		
		Если  Источник.Модель.ЭтоГруппа  Тогда
			Предупреждение("Модель не можеть быть группой. Выберите конкретную модель!");			
			Отказ=Истина;		
			Возврат;
		КонецЕсли;
		
		
	#КонецЕсли
КонецПроцедуры

Процедура ЗначенияСвойствОбъектовПроверкаПрав(Источник, Отказ, Замещение) 
	#Если Клиент Тогда
		
		Если РольДоступна("ПолныеПрава") Тогда
			Возврат;
		КонецЕсли;
		
		Если НЕ обЗначениеНеЗаполнено(глФормаПанелиСвойств) Тогда	
			Если глФормаПанелиСвойств.ТекОбъект <> Неопределено И ТипЗнч(глФормаПанелиСвойств.ТекОбъект.Ссылка) = ТИП("ДокументСсылка.ЗаказНаАвтомобиль") Тогда
				//По дате запрета редактирования
				ДатаЗапретаРедактирования = КонецДня(обПолучитьПраваИНастройкиПользователя(глФормаПанелиСвойств.ТекОбъект.Организация,"ДатаЗапретаРедактирования",глФормаПанелиСвойств.ТекОбъект));
				
				Если глФормаПанелиСвойств.ТекОбъект.Дата <= ДатаЗапретаРедактирования Тогда
					
					//ОстаткиЗаказаНаАвтомобиль=РегистрыНакопления.ЗаказыАвтомобилей.Остатки(,Новый Структура("Заказ",глФормаПанелиСвойств.ТекОбъект.Ссылка));
					//Если ОстаткиЗаказаНаАвтомобиль.Итог("Количество")=0 И 
					//	ОстаткиЗаказаНаАвтомобиль.Итог("Резерв")=0 Тогда
					Предупреждение("Заказ за границами даты запрета редактирования. Для редактирования обратитесь к гл. бухгалтеру.");
					Отказ = Истина;	
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;			
		
		Если НЕ ОбПраво("ИзменениеСвойстваНеликвид") Тогда	    
			СвойствоНеликвид = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Неликвид");				
			Для Каждого Запись Из Источник Цикл		
				Если Запись.Свойство = СвойствоНеликвид Тогда
					Сообщить("Нет прав на изменение этого свойства. Обратитесь к системному администратору.");
					Отказ = Истина;					
				КонецЕсли;
			КонецЦикла;		
		КонецЕсли;
		
		//Если НЕ РольДоступна("ПринятиеСобытий") Тогда	   
		//	СвойствоСобытиеПринимается = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Событие принимается"); 				
		//	Для Каждого Запись Из Источник Цикл		
		//		Если Запись.Свойство = СвойствоСобытиеПринимается Тогда
		//			Сообщить("Нет прав на изменение этого свойства. Обратитесь к системному администратору.");
		//			Отказ = Истина;					
		//		КонецЕсли;
		//	КонецЦикла;		
		//КонецЕсли;
		
	#КонецЕсли
	
КонецПроцедуры

Процедура ОповещениеОЗаписиНаРемонт(Источник, Отказ) 
	
	Возврат;// не используется
	
	Запрос = Новый Запрос;
	Запрос.Текст =        "ВЫБРАТЬ
	|	Событие.Номер
	|ИЗ
	|	Документ.Событие КАК Событие
	|ГДЕ
	|	Событие.ДокументОснование = &ЗаявкаНаРемонт
	|	И Событие.Проведен = ИСТИНА";
	Запрос.УстановитьПараметр("ЗаявкаНаРемонт", Источник.Ссылка);
	
	Если Запрос.Выполнить().Пустой() Тогда 
		
		ДокСобытие = Документы.Событие.СоздатьДокумент();
		ДокСобытие.ОбработкаЗаполнения(Неопределено);
		ДокСобытие.ФорматТекста=Перечисления.ФорматТекста.ПростойТекст;
		ДокСобытие.Контрагент= Источник.Заказчик;
		ДокСобытие.ВидСобытия=перечисления.ВидыСобытий.ТелефонныйЗвонок;
		ДокСобытие.ТипСообщения=Перечисления.ТипыСообщений.Исходящее;
		ДокСобытие.ПредставлениеТелефона = источник.контрагент.основнойтелефон;
		ДокСобытие.ДатаНачала=Источник.ДатаНачала;
		ДокСобытие.ДатаОкончания=Источник.ДатаОкончания;
		ДокСобытие.Приоритет=Перечисления.Важность.Средняя;
		ДокСобытие.Тема = "Заявка на ремонт";
		ДокСобытие.ДокументОснование=Источник.Ссылка;
		ДокСобытие.Состояние=Перечисления.СостоянияСобытий.Запланировано;
		ДокСобытие.Содержание="Причина обращения: "+Источник.ПричинаОбращения +"; Автомобиль: "+Источник.Автомобиль;
		ДокСобытие.Дата = Источник.Дата+1;
		
		ДокСобытие.Записать(РежимЗаписиДокумента.Проведение);
		
		Если Источник.ДатаНачала  > НачалоДня(ТекущаяДата()) + 17*60*60 Тогда
			Напоминание = РегистрыСведений.Напоминания.СоздатьНаборЗаписей();
			Напоминание.Отбор.Объект.Установить(ДокСобытие);
			НовоеНапоминание = Напоминание.Добавить();
			НовоеНапоминание.Автор=Источник.Автор;
			НовоеНапоминание.Пользователь=справочники.Пользователи.НайтиПоКоду("Мельников В.");
			НовоеНапоминание.Завершено = Ложь;			
			НовоеНапоминание.РеальнаяДатаОповещения = НачалоДня(Источник.ДатаНачала - 24*60*60) + 17*60*60; 
			НовоеНапоминание.Объект = ДокСобытие;
			НовоеНапоминание.Тема = "Оповещение о записи на ремонт";
			НовоеНапоминание.Описание ="Телефон: "+источник.контрагент.основнойтелефон+"; Причина обращения: "+ Источник.ПричинаОбращения +"; Автомобиль: "+Источник.Автомобиль;
			НовоеНапоминание.ДатаАктуальности= Источник.ДатаНачала;
			НовоеНапоминание.ДатаНачала=Источник.ДатаНачала;
			НовоеНапоминание.УдалитьПоИстеченииСрока=Истина;
			Напоминание.Записать();
		КонецЕсли;
		
	КонецЕсли;
	
	
	
КонецПроцедуры

Процедура ЗаказНаАвтомобильВозможностьРедактирования(Источник, Отказ)
	
	#Если Клиент Тогда   
		//БизТех 10.07.2023г. убираем отказ <<
		
		//Если РольДоступна("ПолныеПрава") ИЛИ РольДоступна("ВосстПослед") Тогда 
		//	Возврат;
		//КонецЕсли;
		//
		//Если ЗначениеЗаполнено(Источник.Дата) Тогда
		//	
		//	ДатаЗапретаРедактирования = КонецДня(обПолучитьПраваИНастройкиПользователя(Источник.Организация,"ДатаЗапретаРедактирования",Источник));
		//	
		//	Если Источник.Дата <= ДатаЗапретаРедактирования Тогда
		//		Сообщить("Заказ за границами даты запрета редактирования.");
		//		Отказ = Истина;
		//	КонецЕсли;
		//КонецЕсли;
		//>>
	#КонецЕсли
	
КонецПроцедуры

Процедура ПроверкаДатыПланирования(Источник, Отказ) 
	
	#Если Клиент Тогда		
		
		Если РольДоступна("ПолныеПрава")  Тогда 
			Возврат;
		КонецЕсли;	
		
		Если НЕ Источник.ДокументОснование.Пустая() И ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.РабочийЛист")  Тогда
			ГрафикКалендарный =  ПолучитьГрафикКалендарный(Источник.ДокументОснование.Менеджер.ГрафикРаботы, Источник.ДатаНачала);
			УРВ_ТабельноеВремя = ПолучитьГрафикТабельноеВремя(Источник.ДокументОснование.Менеджер, Источник.ДатаНачала);
			
			Если ГрафикКалендарный <> Неопределено И ГрафикКалендарный.ВидДня = перечисления.ВидДня.Выходной Тогда
				Предупреждение("Нельзя планировать событие на выходной день по табелю рабочего времени.");
				Отказ=Истина;
			ИначеЕсли УРВ_ТабельноеВремя <>Неопределено И УРВ_ТабельноеВремя.ВидДня <> справочники.ВидыИнтервалов.Работа Тогда 
				Предупреждение("Нельзя планировать событие на выходной день по табелю рабочего времени.");
				Отказ=Истина;				
			КонецЕсли;
		КонецЕсли;
		
	#КонецЕсли	
	
КонецПроцедуры

Функция ПолучитьГрафикКалендарный(График,Дата);
	
	НаборЗаписей = РегистрыСведений.ГрафикРаботКалендарный.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.График.Установить(График);
	НаборЗаписей.Отбор.Дата.Установить(Дата);	
	НаборЗаписей.Прочитать();
	Если НаборЗаписей.Количество() > 0 Тогда
		ГрафикКалендарный = Новый Структура();
		ГрафикКалендарный.Вставить("ВидДня", НаборЗаписей[0].ВидДня );
		
		Возврат ГрафикКалендарный;		
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция ПолучитьГрафикТабельноеВремя(Сотрудник, Дата);
	
	//НаборЗаписей = РегистрыСведений.УРВ_ТабельноеВремя.СоздатьНаборЗаписей();
	//НаборЗаписей.Отбор.Сотрудник.Установить(Сотрудник);
	//НаборЗаписей.Отбор.Период.Установить(Дата);	
	//НаборЗаписей.Прочитать();
	//Если НаборЗаписей.Количество() > 0 Тогда
	//	ГрафикКалендарный = Новый Структура();
	//	ГрафикКалендарный.Вставить("ВидДня", НаборЗаписей[0].ВидИнтервала );
	//	
	//	Возврат ГрафикКалендарный;		
	//КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Процедура АвтомобилиПроверкаЗаполнения(Источник, Отказ) 
	
	
	#Если Клиент Тогда
		Если Источник.ОбменДанными.Загрузка Тогда
			Возврат;
		КонецЕсли;
	#КонецЕсли
	
	
КонецПроцедуры

Процедура НоменклатураПроверкаЗаполнения(Источник, Отказ) 
	
	
	#Если Клиент Тогда
		Если Источник.ОбменДанными.Загрузка Тогда
			Возврат;
		КонецЕсли;
		
		//БизТех 20.03.2025г. Тихонов Р. просит убрать эту проверку для группы номенклатуры <<
		Если обЗначениеНеЗаполнено(Источник.ТипНоменклатуры) и не Источник.ЭтоГруппа Тогда
		//БизТех 20.03.2025г. >>			
			Отказ=Истина;
			Сообщить("Не заполнено значение ""ТипНоменклатуры"".");
			Возврат;
		КонецЕсли;		
		Если РольДоступна("ПолныеПрава") 
			ИЛИ Источник.ТипНоменклатуры.ВидНоменклатуры=Перечисления.ВидыНоменклатуры.Услуга
			ИЛИ Источник.ТипНоменклатуры.ВидНоменклатуры=Перечисления.ВидыНоменклатуры.Шины Тогда 
			Возврат;
		КонецЕсли;
		
		//БизТех 20.03.2025г. Тихонов Р. убираем эту проверку <<
		//Если не Источник.ЭтоГруппа Тогда
		//	Если обЗначениеНеЗаполнено(Источник.Производитель) Тогда
		//		Сообщить("Не заполнено значение ""Производитель"".");
		//		Отказ=Истина;
		//	КонецЕсли;
		//	
		//	Если обЗначениеНеЗаполнено(Источник.СтранаПроисхождения) Тогда
		//		Сообщить("Не заполнено значение ""Страна"".");
		//		Отказ=Истина;
		//	КонецЕсли;
		//КонецЕсли;
		//БизТех 20.03.2025г.>>
		
		//<<Павличенко 15.12.17\     временно отключено
		//Если ПараметрыСеанса.Пользователь.ШаблонПрав = Справочники.Пользователи.НайтиПоКоду("Шаблон_Кладовщик") тогда
		//	Если Источник.Ссылка.Родитель<> Источник.Родитель тогда
		//		 сообщить("У Вас нет прав доступа на изменение справочника Номенклатура!");
		//		 Отказ = Истина;
		//	КонецЕсли;
		//КонецЕсли;
		//>>Павличенко 15.12.17
		
		
	#КонецЕсли
	
	
КонецПроцедуры

Процедура СозданиеДоговораЗаявкаНаРемонт(Источник, Отказ, РежимПроведения) 
	
	ОрганизацияТАС= Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");
	
	Если Источник.Организация <> ОрганизацияТАС Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Источник.Контрагент) Тогда 
		Возврат;
	КонецЕсли;	
	
	Если ТипЗнч(Источник.Контрагент) = Тип("Строка") Тогда 
		Возврат;
	КонецЕсли;	
	
	Подразделение = ПараметрыСеанса.ПодразделениеКомпании;
	
	СвойствоДДС = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Вид договора ДДС");	
	СвойствоСервис = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Сервис", Истина,, СвойствоДДС);
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДоговорыВзаиморасчетов.Ссылка КАК Договор
	|ИЗ
	|	Справочник.ДоговорыВзаиморасчетов КАК ДоговорыВзаиморасчетов
	|ГДЕ
	|	ДоговорыВзаиморасчетов.Владелец = &Контрагент
	|	И ДоговорыВзаиморасчетов.Организация = &Организация
	|	И ДоговорыВзаиморасчетов.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоров.Продажа)
	|	И ДоговорыВзаиморасчетов.Подразделение = &Подразделение";
	
	Запрос.УстановитьПараметр("Контрагент", Источник.Контрагент);
	Запрос.УстановитьПараметр("Организация", Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514"));
	Запрос.УстановитьПараметр("Подразделение", Подразделение);
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда 
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		ТекДоговор = Выборка.Договор;
		
		Источник.ДоговорВзаиморасчетов = ТекДоговор;
		//Источник.Записать(РежимЗаписиДокумента.Проведение);
		Возврат;
	КонецЕсли;	
	
	Права = Неопределено;
	Если Источник.Контрагент.ВидКонтрагента = Перечисления.ВидыКонтрагентов.Покупатель Тогда
		ВидДоговора   = Перечисления.ВидыДоговоров.Продажа;
		ТипЦенПокупки = Справочники.ТипыЦен.ПустаяСсылка();
		ТипЦенПродажи = обПраво("ОсновнойТипЦенПродажи", Права);
		ТипЦенРабот   = обПраво("ОсновнойТипЦенРабот",   Права);
	ИначеЕсли Источник.Контрагент.ВидКонтрагента = Перечисления.ВидыКонтрагентов.Поставщик Тогда	
		ВидДоговора   = Перечисления.ВидыДоговоров.Покупка;
		ТипЦенПокупки = обПраво("ОсновнойТипЦенЗакупки", Права);
		ТипЦенПродажи = Справочники.ТипыЦен.ПустаяСсылка();
		ТипЦенРабот   = Справочники.ТипыЦен.ПустаяСсылка();
	Иначе
		ВидДоговора   = Перечисления.ВидыДоговоров.Прочее;
		ТипЦенПокупки = Справочники.ТипыЦен.ПустаяСсылка();
		ТипЦенПродажи = обПраво("ОсновнойТипЦенПродажи", Права);
		ТипЦенРабот   = обПраво("ОсновнойТипЦенРабот",   Права);
	КонецЕсли;
	НовыйДоговор = Справочники.ДоговорыВзаиморасчетов.СоздатьЭлемент();
	НовыйДоговор.УстановитьНовыйКод();
	НовыйДоговор.Заполнить(Неопределено);
	Если Подразделение = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000127") Тогда// ТАС 160 
		НовыйДоговор.Наименование = "Договор ТО и ремонта ТАС";	
	ИначеЕсли Подразделение = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000126") Тогда//  ГАЗ ТАС
		НовыйДоговор.Наименование = "Договор ТО и ремонта ГАЗ ТАС";	
	Иначе
		НовыйДоговор.Наименование = "Договор ТО и ремонта";	
	КонецЕсли;
	
	НовыйДоговор.Владелец = Источник.Контрагент.Ссылка;
	НовыйДоговор.ВидДоговора = ВидДоговора;
	НовыйДоговор.ТипЦенПокупки = ТипЦенПокупки;
	НовыйДоговор.ТипЦенПродажи = ТипЦенПродажи;
	НовыйДоговор.ВидОплаты = Перечисления.ВидыОплаты.ПроизвольнаяОплата;	
	НовыйДоговор.Организация = ОрганизацияТАС;
	НовыйДоговор.Подразделение = Подразделение ;
	НовыйДоговор.тт_ВидДоговора = Справочники.тт_ВидыДоговоров.НайтиПоКоду("000000002");
	НовыйДоговор.ЕдиницаИзмеренияАвтоработВПечатныхФормах = Перечисления.ЕдиницаИзмеренияАвтоработВПечатныхФормах.ЕдиницаИзмеренияЧас;
	НовыйДоговор.Записать();
	
	НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Объект.Установить(НовыйДоговор.Ссылка);
	НаборЗаписей.Отбор.Свойство.Установить(СвойствоДДС);
	Запись = НаборЗаписей.Добавить();
	Запись.Объект = НовыйДоговор.Ссылка;
	Запись.Свойство = СвойствоДДС;
	Запись.Значение = СвойствоСервис;
	НаборЗаписей.Записать();
	
	Источник.ДоговорВзаиморасчетов = НовыйДоговор;
	//Источник.Записать(РежимЗаписиДокумента.Проведение);
	
КонецПроцедуры

Процедура ПроверкаЗаполненияЯчейки(Источник, Отказ, РежимПроведения) 
	
	Если Источник.ХозОперация=Справочники.ХозОперации.УслугиПоСубподряду ИЛИ Источник.ХозОперация=Справочники.ХозОперации.УслугиСтороннихОрганизаций ИЛИ
		РольДоступна("ПолныеПрава") ИЛИ ОбПраво("РазрешитьПоступлениеБезЯчейки") Тогда
		Возврат;		
	КонецЕсли;	
	
	Для Каждого Стр Из Источник.Товары Цикл
		
		Если ЗначениеЗаполнено(Стр.Ячейка) Тогда
			
			//Если Лев(Стр.Ячейка.Код, 1) <> "а" Тогда
			//	Сообщить("В строке № " + Стр.НомерСтроки + " выбрана неверная ячейка! Проведение документа невозможно.");
			//	Отказ = Истина;
			//КонецЕсли;
		Иначе
			Отказ = Истина;
			Сообщить("В строке № " + Стр.НомерСтроки + " не заполнено поле ячейка! Проведение документа невозможно.");
		КонецЕсли;		
		
	КонецЦикла;
	
КонецПроцедуры

Процедура АвтодилерВыгрузкаВCRM(Источник, Отказ) 
	Попытка
		Если обПраво("АвтодилерВыгрузкаВCRM") Тогда
			//<<Павличенко 10.03.2020
			Организация = Справочники.CRM_НастройкиПодключенияПоСалонам.НайтиПоРеквизиту("Организация", Источник.Организация);
			Если Организация = Справочники.CRM_НастройкиПодключенияПоСалонам.ПустаяСсылка() тогда
				//сообщить("В справочнике CRM_НастройкиПодключенияПоСалонам не найдена " + Источник.Организация + "! Обратитесь к программисту");
				//Сообщить("_Произошла ошибка! Не удалось передать документ в CRM-систему!!!");
				Возврат;
			КонецЕсли;	
			Если НЕ Организация.ВыгружатьЗНВCRM тогда
				//сообщить("В справочнике CRM_НастройкиПодключенияПоСалонам для организации " + Источник.Организация + " не указано разрешение выгружать заказ-наряды! Обратитесь к программисту");
				//Сообщить("_Произошла ошибка! Не удалось передать документ в CRM-систему!!!");
				Возврат;
			КонецЕсли;
			
			//БИЗТЕХ КОВАЛЬ 07.03.2025 СДК 000000768++
			Если Источник.НеВыгружатьИмпортеру Тогда
				Возврат;
			КонецЕсли;
			//БИЗТЕХ КОВАЛЬ 07.03.2025 СДК 000000768--
			
			
			//Если Справочники.CRM_НастройкаПодключения.ВыгружатьЗНВCRM.ДопЗначение Тогда
			//по видам ремонта
			
			ЗапросВР = Новый запрос();
			ЗапросВР.УстановитьПараметр("парВидРемонта",Источник.ВидРемонта);  
			ЗапросВР.УстановитьПараметр("Подразделение",Источник.ПодразделениеКомпании);
			ЗапросВР.Текст = "ВЫБРАТЬ
			                 |	CRM_НастройкиПодключенияПоСалонамПодразделения.ВидРемонта КАК ВидРемонта,
			                 |	CRM_НастройкиПодключенияПоСалонамПодразделения.Ссылка КАК Ссылка
			                 |ИЗ
			                 |	Справочник.CRM_НастройкиПодключенияПоСалонам.Подразделения КАК CRM_НастройкиПодключенияПоСалонамПодразделения
			                 |ГДЕ
			                 |	CRM_НастройкиПодключенияПоСалонамПодразделения.ВидРемонта = &парВидРемонта
			                 |	И НЕ CRM_НастройкиПодключенияПоСалонамПодразделения.Ссылка.ПометкаУдаления
			                 |	И CRM_НастройкиПодключенияПоСалонамПодразделения.Подразделение = &Подразделение";
			
			РезультатВР = ЗапросВР.Выполнить().Выбрать();
			Если РезультатВР.Следующий() Тогда
				Попытка
					ВыгруженЛи = црмРаботаСсоединением.СуществуетЛиЗаказНаряд(РезультатВР.Ссылка, Источник.Ссылка.Номер);
				Исключение
				КонецПопытки;
				Если ВыгруженЛи = Ложь Тогда
					црмРаботаСсоединением.ОбработатьДанныеЗаказНаряда(Источник.Ссылка, Организация.CRM_Имя, РезультатВР.Ссылка);
				ИначеЕсли ВыгруженЛи = Истина Тогда
					Сообщить("Заказ-наряд уже был выгружен CRM.");
				Иначе
					Сообщить("Ошибка проверки заказ-наряда в CRM.")
				КонецЕсли;
					
				//
			//иначе
			//	ЗапросВР = Новый запрос();
			//	ЗапросВР.Текст = "ВЫБРАТЬ
			//	|	CRM_НастройкиПодключенияПоСалонамПодразделения.ВидРемонта
			//	|ИЗ
			//	|	Справочник.CRM_НастройкиПодключенияПоСалонам.Подразделения КАК CRM_НастройкиПодключенияПоСалонамПодразделения
			//	|ГДЕ
			//	|	НЕ CRM_НастройкиПодключенияПоСалонамПодразделения.Ссылка.ПометкаУдаления";
			//	
			//	РезультатВР = ЗапросВР.Выполнить().Выбрать();
			//	Если РезультатВР.Количество()=0 Тогда
			//		црмРаботаСсоединением.ОбработатьДанныеЗаказНаряда(Источник.Ссылка, Организация.CRM_Имя);
			//	КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		//КонецЕсли;
		//>>Павличенко 10.03.2020
	Исключение
		Сообщить("_Произошла ошибка! Не удалось передать документ в CRM-систему!!!");
	КонецПопытки;
КонецПроцедуры

Процедура ПроверкаЗаполненияГИ(Источник, Отказ) 
	
	ГИ = обПолучитьЗначениеСвойства(Источник,"Государственный идентификатор",Неопределено);
	
	Если ГИ = "" Тогда
		сообщить ("Не заполнен государственный идентификатор!" + Символы.ПС + "Для государственных контрактов обязательное поле!");
	КонецЕсли;
	
КонецПроцедуры

Процедура РедактированиеДоговоровПоставка(Источник, Отказ) 
	
	Массив = Новый Массив;
	Массив.Добавить(Перечисления.ВидыДоговоров.Покупка);
	Массив.Добавить(Перечисления.ВидыДоговоров.Прочее);
	
	Если Массив.Найти(Источник.ВидДоговора) = Неопределено ИЛИ
		Источник.Организация <> Справочники.Организации.ОсновнаяОрганизация ИЛИ
		ОбПраво("РедактированиеДоговоровПоставка")
		Тогда
		Возврат;
	КонецЕсли;
	
	Сообщить ("У вас нет прав доступа на изменение договоров поставка/прочее по организации ООО ""Техно-Темп""! Обратитесь в бухгалтерию");
	Отказ = Истина;
	
КонецПроцедуры

Процедура ПроверкаДатыДействияДоговораВПоступлениях(Источник, Отказ, РежимЗаписи, РежимПроведения) 
	
	Если Источник.Организация <> Справочники.Организации.НайтиПоРеквизиту("ИНН","2312127750") тогда       //только техно-темп
		Возврат;
	КонецЕсли;
	
	Если ОбПраво("НеПроверятьЗаполнениеДатыДоговораПоступлТов") Тогда
		Возврат;
	КонецЕсли;
	
	Если Источник.ДоговорВзаиморасчетов.ДатаКонца = Дата(1,1,1) тогда
		Возврат;
	ИначеЕсли  Источник.ДоговорВзаиморасчетов.ДатаКонца < Источник.Дата тогда
		сообщить ("Дата окончания договора меньше даты документа! Документ не может быть записан");
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверкаЗаполненияВыписка(Источник, Отказ, РежимЗаписи, РежимПроведения)
	
	Для Каждого Стр Из Источник.Состав Цикл
		Если Стр.ДоговорВзаиморасчетов <> Источник.ДоговорВзаиморасчетов Тогда
			Стр.ДоговорВзаиморасчетов = Источник.ДоговорВзаиморасчетов;	
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПроверкаЗаполненияЦФО(Источник, Отказ, РежимПроведения) 
	
	Если ТипЗнч(Источник) = Тип("ДокументОбъект.БТ_ПлановыеПоказатели") или 
		ТипЗнч(Источник) = Тип("ДокументОбъект.БТ_РучныеПоказатели") или 
		ТипЗнч(Источник) = Тип("ДокументОбъект.БТ_ЗаработнаяПлатаПоФормеП4") или 
		ТипЗнч(Источник) = Тип("ДокументОбъект.БТ_Трафик") или
		ТипЗнч(Источник) = Тип("ДокументОбъект.БТ_УстановкаЦенПредоплаченногоТО") ТОгда
		
		Возврат;
		
	КонецЕсли;
	
	Если Источник.Дата <= Дата(2017,1,1) или Лев(Строка(источник), 8)="Сводная " Тогда 
		Возврат; //allgk добавлено условие после или  для проведения сводной инвентаризационной ведомости 12/05/2017
	КонецЕсли;	
	
	МассивПроверяемых=Новый Массив;
	МассивПроверяемых.Добавить(Справочники.ХозОперации.АвансовыйОтчет);
	МассивПроверяемых.Добавить(Справочники.ХозОперации.АктОбОказанииУслуг);
	МассивПроверяемых.Добавить(Справочники.ХозОперации.КорректировкаДолга);
	МассивПроверяемых.Добавить(Справочники.ХозОперации.ОтчетКомиссионераЗаАвтомобили);
	МассивПроверяемых.Добавить(Справочники.ХозОперации.СписаниеВПроизводство);
	МассивПроверяемых.Добавить(Справочники.ХозОперации.СписаниеТоваров);
	МассивПроверяемых.Добавить(Справочники.ХозОперации.ИнвентаризацияТоваров);
	МассивПроверяемых.Добавить(Справочники.ХозОперации.УслугиСтороннихОрганизаций);
	МассивПроверяемых.Добавить(Справочники.ХозОперации.ВводВЭксплуатацию);	
	МассивПроверяемых.Добавить(Справочники.ХозОперации.КорректировкаРеализацииКорректировкаПоСогласованиюСторон);
	МассивПроверяемых.Добавить(Справочники.ХозОперации.КорректировкаРеализацииИсправлениеВПервичныхДокументах);
	МассивПроверяемых.Добавить(Справочники.ХозОперации.СтрокаБанковскойВыписки);  
	МассивПроверяемых.Добавить(Справочники.ХозОперации.План);
	
	//БИЗТЕХ КОВАЛЬ 08.08.2023 ++
	//Комментирование  кода который приводит к ошибке
	//
	//Если Источник.ХозОперация=Справочники.ХозОперации.АктОбОказанииУслуг И          //ЦФО не проверяем
	//	(Источник.Организация=Справочники.Организации.НайтиПоРеквизиту("ИНН","262512827249"))  //Ладная-Мороз 
	//	Тогда
	//	Возврат;
	//КонецЕсли;
	//
	//БИЗТЕХ КОВАЛЬ 08.08.2023 ++
	//Bizteh 20.01.2023 убираем эту проверку <<
	//Если МассивПроверяемых.Найти(Источник.ХозОперация) <> Неопределено Тогда
	//	
	//	ЦФОБренд = обПолучитьЗначениеСвойства(Источник,"ЦФОБренд",Неопределено);
	//	Если обЗначениеНеЗаполнено(ЦФОБренд) Тогда
	//		Сообщить("Для документа "+Строка(Источник.Ссылка)+"	не указано свойство ""ЦФО Бренд""");
	//		Попытка
	//			Если обПраво("ПроверкаЗаполненияЦФО") Тогда
	//				Отказ = Истина;
	//			КонецЕсли;	
	//		Исключение
	//		КонецПопытки;
	//	КонецЕсли;	
	//			
	//	ЦФОПодразделение = обПолучитьЗначениеСвойства(Источник,"ЦФОПодразделение",Неопределено);
	//	Если обЗначениеНеЗаполнено(ЦФОПодразделение)  Тогда
	//		Сообщить("Для документа "+Строка(Источник.Ссылка)+"	не указано свойство ""ЦФО Подразделение""");
	//		Попытка
	//			Если обПраво("ПроверкаЗаполненияЦФО") Тогда
	//				Отказ = Истина;
	//			КонецЕсли;	
	//		Исключение
	//		КонецПопытки;
	//	КонецЕсли;	
	//	
	//КонецЕсли;  
	// >>
	
	
КонецПроцедуры

Процедура ДокПродажиПроверкаТипаДоговора(Источник, Отказ, РежимПроведения) 
	
	Если Источник.Дата <= Дата(2017,1,1) Тогда 
		Возврат;	
	КонецЕсли;
	
	ТипДок=ТипЗнч(Источник);
	
	//***********************  проверка вида договора в документах продажи
	Если ТипДок=Тип("ДокументОбъект.ЗаказНаряд") И 
		( Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Закрыт ИЛИ 
		Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.Выполнен ) ИЛИ	
		ТипДок=Тип("ДокументОбъект.ЗаказПокупателя")ИЛИ		
		ТипДок=Тип("ДокументОбъект.РеализацияТоваров")		
		Тогда
		
		Если ЗначениеЗаполнено(Источник.ДоговорВзаиморасчетов) Тогда 
			ЕСли НЕ Источник.ДоговорВзаиморасчетов.ВидДоговора = Перечисления.ВидыДоговоров.Продажа Тогда
				Сообщить(Строка(Источник) + "	Вид договора должен быть Продажа!!",СтатусСообщения.Важное);
				Если обПраво("ОтменитьПроверкуТипаДоговораПродажа") Тогда
					Отказ = Истина;
				КонецЕсли;	
			КонецЕсли;	
		КонецЕсли;	
		
	ИначеЕсли ТипДок=Тип("ДокументОбъект.ЗаказНаАвтомобиль") Тогда
		
		Если ЗначениеЗаполнено(Источник.ДоговорВзаиморасчетов) И НЕ Источник.ДоговорВзаиморасчетов.ВидДоговора = Перечисления.ВидыДоговоров.Продажа И НЕ Источник.ДоговорВзаиморасчетов.ВидДоговора = Перечисления.ВидыДоговоров.СКомиссионером Тогда
			Сообщить(Строка(Источник) + "	Вид договора должен быть Продажа или С комиссионером!!",СтатусСообщения.Важное);
			Если обПраво("ОтменитьПроверкуТипаДоговораПродажа") Тогда
				Отказ = Истина;
			КонецЕсли;	
		КонецЕсли;	
		
	ИначеЕсли ТипДок=Тип("ДокументОбъект.РеализацияАвтомобилей") Тогда
		
		Если Источник.ХозОперация = Справочники.ХозОперации.РеализацияАвтомобилей Тогда
			
			Если ЗначениеЗаполнено(Источник.ДоговорВзаиморасчетов) И НЕ Источник.ДоговорВзаиморасчетов.ВидДоговора = Перечисления.ВидыДоговоров.Продажа Тогда
				Сообщить(Строка(Источник) + "	Вид договора должен быть Продажа!!",СтатусСообщения.Важное);
				
				Если обПраво("ОтменитьПроверкуТипаДоговораПродажа") Тогда
					Отказ = Истина;
				КонецЕсли;	
				
			КонецЕсли;	
			
		ИначеЕсли Источник.ХозОперация = Справочники.ХозОперации.РеализацияАвтомобилейКомиссия Тогда
			
			Если ЗначениеЗаполнено(Источник.ДоговорВзаиморасчетов) И НЕ Источник.ДоговорВзаиморасчетов.ВидДоговора = Перечисления.ВидыДоговоров.СКомиссионером Тогда
				Сообщить(Строка(Источник) + "	Вид договора должен быть С Комиссионером!!",СтатусСообщения.Важное);
				Если обПраво("ОтменитьПроверкуТипаДоговораПродажа") Тогда
					Отказ = Истина;
				КонецЕсли;	
			КонецЕсли;
			
		КонецЕсли;	
		
	КонецЕсли; 
	
КонецПроцедуры

Процедура ЗаявкаНаРасходПроверкаЗаполнения(Источник, Отказ, РежимЗаписи, РежимПроведения) 	
	
	
	Если Источник.ОбменДанными.Загрузка=Истина 
		ИЛИ Источник.Дата <= Дата(2017, 09, 09) Тогда 
		Возврат;	
	КонецЕсли;
	
	//Если Источник.СтатусТТ <> Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.Заявка И 
	//	НЕ обПраво("ИзменениеСтатусаЗаявкиНаРасходДС")
	//	Тогда
	//	Сообщить("Нет прав на установку выбранного статуса заявки!");
	//	Отказ = Истина;		
	//КонецЕсли;
	
	//<<Павличенко 21.03.19
	Если Источник.ДоговорВзаиморасчетов.Пустая() тогда
		сообщить("Не заполнен договор взаиморасчетов! Запись документа невозможна!");
		Отказ = Истина;
	КонецЕсли;
	//>>Павличенко 21.03.19
	//anton по Заявке Лукаш 	
	Если обЗначениеНеЗаполнено(Источник.СтатьяДДС) тогда
		Сообщить("Не заполнена Статья ДДС! Запись документа невозможна!");
		Отказ = Истина;
	КонецЕсли;
	
	Если ТипЗнч(Источник.СтруктурнаяЕдиница)=Тип("СправочникСсылка.БанковскиеСчета") 
		И Источник.СтруктурнаяЕдиница.Владелец <> Источник.Организация Тогда
		Сообщить("Организация Расчетного счета не соответствует организации документа! Запись документа невозможна!");
		Отказ = Истина;
	КонецЕсли;
	//Если обЗначениеНеЗаполнено(Источник.СтатьяДоходовИРасходов) Тогда
	//    Сообщить("Не заполнена Статья доходов и расходов! Запись документа невозможна!");
	//    Отказ=Истина;
	//КонецЕсли;
	//anton	
	
	//***********************  проверка заполнения Заявки на расход ДС - проверка заполненности основного банк счета контрагента
	Если Источник.ЭтоНовый() Тогда
		//Если обЗначениеНеЗаполнено(Источник.Контрагент.ОсновнойБанковскийСчет) Тогда
		//	Сообщить("У Контрагента не заполнен Основной банк счет. " + Строка(Источник.Контрагент));
		//	Отказ = Истина;
		//КонецЕсли;	
		Если обЗначениеНеЗаполнено(Источник.СчетКонтрагента) Тогда
			Сообщить("В документе не заполнен счет Контрагента. " + Строка(Источник.Контрагент));
			Отказ = Истина;
		КонецЕсли;	
	КонецЕсли;	
	//***********************  проверка заполнения Заявки на расход ДС - //дополнительные реквизиты для платежей в бюджет РФ //если расчеты с бюджетом (по налогам)
	Если Источник.ПеречислениеНалога=Истина Тогда
		ОбязательныеАтрибутыБЮДЖЕТ = Новый СписокЗначений;
		ОбязательныеАтрибутыБЮДЖЕТ.Добавить("СтатусСоставителя");
		ОбязательныеАтрибутыБЮДЖЕТ.Добавить("КодУИН");
		ОбязательныеАтрибутыБЮДЖЕТ.Добавить("КодБК");
		ОбязательныеАтрибутыБЮДЖЕТ.Добавить("КодОКТМО");
		ОбязательныеАтрибутыБЮДЖЕТ.Добавить("ПоказательОснования");
		ОбязательныеАтрибутыБЮДЖЕТ.Добавить("ПоказательПериода");
		ОбязательныеАтрибутыБЮДЖЕТ.Добавить("ПоказательНомера");
		ОбязательныеАтрибутыБЮДЖЕТ.Добавить("ПоказательДаты");
		ОбязательныеАтрибутыБЮДЖЕТ.Добавить("ПоказательТипа");
		Для ц=0 По ОбязательныеАтрибутыБЮДЖЕТ.Количество()-1 Цикл
			Значение = Источник[Строка(ОбязательныеАтрибутыБЮДЖЕТ.Получить(ц))];
			Если (Значение = Неопределено) ИЛИ (СокрЛП(Значение)="") Тогда
				Сообщить("В документе "+Источник.Ссылка+": не указано поле "+ОбязательныеАтрибутыБЮДЖЕТ.Получить(ц));
				Отказ = Истина;
			КонецЕсли;
		КонецЦикла;	
	КонецЕсли;
	
	
	
	Для Каждого Стр Из Источник.Платежи Цикл
		
		Если НЕ ЗначениеЗаполнено(Стр.ДатаПлатежа) Тогда
			Сообщить("Не заполнена дата платежа!");
			Отказ = Истина;
		КонецЕсли;
		
		Если НачалоДня(Стр.ДатаПлатежа) < НачалоДня(Источник.Дата) Тогда
			Сообщить("Дата платежа не может быть раньше даты документа!");
			Отказ = Истина;
		КонецЕсли;
		
		Источник.ДатаПлатежа=Стр.ДатаПлатежа;
		
		//anton
		Продолжить;
		
		Если Источник.СтатусТТ = Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.Оплата или
			Источник.СтатусТТ = Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.Резерв Тогда
			
			Если НачалоДня(Стр.ДатаПлатежа) = НачалоДня(ИСточник.Дата) Тогда
				Источник.СтатусТТ = Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.Оплата;
			Иначе
				Источник.СтатусТТ = Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.Резерв;
			КонецЕсли;
			
			СтатьяДДС = обПолучитьЗначениеСвойства(Источник,ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Статья ДДС Упр"));
			Если НЕ СтатьяДДС.ТТ_ПроверятьПоПлану Тогда
				Возврат;
			КонецЕсли;
			
			СуммаПлана=0;
			СуммаРезерв = 0;
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ТТ_ФактПоУтвержденнымЗаявкамДСОстатки.СтатьяДДСУпр,
			|	ТТ_ФактПоУтвержденнымЗаявкамДСОстатки.СуммаОстаток КАК Сумма
			|ИЗ
			|	РегистрНакопления.ТТ_ФактПоУтвержденнымЗаявкамДС.Остатки(&ДатаОтч, ) КАК ТТ_ФактПоУтвержденнымЗаявкамДСОстатки
			|ГДЕ
			|	ТТ_ФактПоУтвержденнымЗаявкамДСОстатки.Организация = &Организация
			|	И ТТ_ФактПоУтвержденнымЗаявкамДСОстатки.СтатьяДДСУпр = &СтатьяДДСУпр";
			
			Запрос.УстановитьПараметр("ДатаОтч", (Стр.ДатаПлатежа-1));
			Запрос.УстановитьПараметр("Организация", Источник.Организация);
			Запрос.УстановитьПараметр("СтатьяДДСУпр", СтатьяДДС);
			
			Рез = Запрос.Выполнить().Выгрузить();
			
			СуммаРезерв = Рез.Итог("Сумма");
			
			Запрос2 = Новый Запрос;
			Запрос2.Текст = 
			"ВЫБРАТЬ
			|	ПланФактПоказатели.ВидАналитикиПланирования1 КАК Статья,
			|	ПланФактПоказатели.ПоказательПлана1 КАК Сумма
			|ИЗ
			|	Документ.ПланФакт.Показатели КАК ПланФактПоказатели
			|ГДЕ
			|	ПланФактПоказатели.Ссылка.Проведен = ИСТИНА
			|	И ПланФактПоказатели.Ссылка.Организация = &Организация
			|	И ПланФактПоказатели.Ссылка.ХозОперация = &ХозОперация
			|	И ПланФактПоказатели.Ссылка.ВидПлана = &ВидПлана
			|	И ПланФактПоказатели.Ссылка.ДатаНачала = &ДатаНачала
			|	И ПланФактПоказатели.Ссылка.ДатаКонца = &ДатаКонца
			|	И ПланФактПоказатели.ВидАналитикиПланирования1 = &Статья";
			
			Запрос2.УстановитьПараметр("ВидПлана", Справочники.ВидыПлановКомпании.НайтиПоНаименованию("Упр. ДДС (расходы)",истина));
			Запрос2.УстановитьПараметр("ДатаКонца", НачалоДня(КонецМесяца(Стр.ДатаПлатежа)));
			Запрос2.УстановитьПараметр("ДатаНачала", НачалоМесяца(Стр.ДатаПлатежа));
			Запрос2.УстановитьПараметр("Организация", Источник.Организация);
			Запрос2.УстановитьПараметр("Статья", СтатьяДДС);
			Запрос2.УстановитьПараметр("ХозОперация", Справочники.ХозОперации.План);
			
			Рез2 = Запрос2.Выполнить().Выгрузить();
			
			СуммаПлана = Рез2.Итог("Сумма");
			
			Если (Стр.Сумма+СуммаРезерв) > СуммаПлана Тогда
				Сообщить("По статье "+СтатьяДДС+" в планировании расходов на "+Формат(Стр.ДатаПлатежа,"ДФ=MMMM")+" месяц, недостаточно средств! "+"План: "+СуммаПлана+" Резерв: "+СуммаРезерв+" в документе: "+Стр.Сумма);
				Источник.СтатусТТ = Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.НеВплане;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ИнвентаризацияПереопределениеСтатьиСписания(Источник, Отказ, РежимЗаписи, РежимПроведения) 
	
	Если Источник.Дата > Дата("20170101") Тогда
		
		Если Источник.СтатьяСписанияОбнаруженнойНедостачиТМЦ = Справочники.СтатьиДоходовИРасходов.СписаниеОбнаруженнойНедостачиТМЦ Тогда
			Источник.СтатьяСписанияОбнаруженнойНедостачиТМЦ = Справочники.СтатьиДоходовИРасходов.НайтиПоКоду("ЦБ000405");
		КонецЕсли;	
		
		Если Источник.СтатьяОприходованияОбнаруженныхИзлишковТМЦ = Справочники.СтатьиДоходовИРасходов.ОприходованиеОбнаруженныхИзлишковТМЦ Тогда
			Источник.СтатьяОприходованияОбнаруженныхИзлишковТМЦ = Справочники.СтатьиДоходовИРасходов.НайтиПоКоду("ЦБ000112");
		КонецЕсли;	
		
	КонецЕсли;	
	
КонецПроцедуры

Процедура ПроверкаЗаполненияПоступлениеДопРасходовНаАвтомобили(Источник, Отказ, РежимПроведения)
	
	Если Источник.Дата>Дата("20170101") Тогда
		Если Источник.ВидРемонта = Справочники.ВидыРемонта.ПустаяСсылка() Тогда
			Для каждого стрАвто ИЗ Источник.Автомобили Цикл
				Запрос = Новый Запрос;
				Запрос.Текст = 
				"ВЫБРАТЬ
				|	ОстаткиАвтомобилейОстатки.Автомобиль,
				|	ОстаткиАвтомобилейОстатки.КоличествоОстаток
				|ИЗ
				|	РегистрНакопления.ОстаткиАвтомобилей.Остатки(&НаДату, ) КАК ОстаткиАвтомобилейОстатки
				|ГДЕ
				|	ОстаткиАвтомобилейОстатки.СкладКомпании.Организация = &Организация
				|	И ОстаткиАвтомобилейОстатки.СтатусПартии = ЗНАЧЕНИЕ(Перечисление.СтатусыПартий.ТоварКупленный)
				|	И ОстаткиАвтомобилейОстатки.Автомобиль = &Автомобиль";
				Запрос.УстановитьПараметр("НаДату", Источник.Дата);
				Запрос.УстановитьПараметр("Организация", Источник.Организация);
				Запрос.УстановитьПараметр("Автомобиль", стрАвто.Автомобиль);
				Результат = Запрос.Выполнить().Выгрузить();
				
				Если Результат.Количество()=0 Тогда
					Сообщить(Строка(Источник) + " Автомобиля " + стрАвто.Автомобиль + "нет на остатках. Проведение запрещено");
					Отказ = Истина;
				КонецЕсли;
			КонецЦикла;
			//>>Павличенко 13.04.18
		Иначе
			Если (Источник.Контрагент.ИНН <> "090103290098") И (Источник.Контрагент.ИНН <> "2311152514") тогда     //не Кунова, не ТАС
				Сообщить(Строка(Источник) + " проведен не будет! Вид ремонта должен быть пустым!");
				Отказ = Истина;
			КонецЕсли;
			//<<Павличенко 13.04.18
		КонецЕсли;	
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверкаЗаполненияРабочийЛистКредит(Источник, Отказ, РежимЗаписи, РежимПроведения) 
	
	Если ЗначениеЗаполнено(Источник.ДокументОснование) Тогда
		Если Источник.ДокументОснование.ХозОперация = Справочники.ХозОперации.ЗаказНаАвтомобильОтмена Тогда
			Отказ = Истина;
			Сообщить("Ввод на основании Отмены заказа на автомобиль запрещен " + Строка(Источник));
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверкаРабЛистКСО(Источник, Отказ, РежимПроведения)   
	
	//******************* проверка РЛ КСО
	
	Для каждого Строка Из Источник.Товары Цикл
		Если ЗначениеЗаполнено(Строка.РабочийЛистКСО) Тогда
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
			|	РеализацияТоваровТовары.Ссылка КАК Акт,
			|	РеализацияТоваровТовары.РабочийЛистКСО
			|ИЗ
			|	Документ.РеализацияТоваров.Товары КАК РеализацияТоваровТовары
			|ГДЕ
			|	РеализацияТоваровТовары.РабочийЛистКСО = &РабочийЛистКСО
			|	И РеализацияТоваровТовары.Ссылка <> &ДокСсылка
			|	И РеализацияТоваровТовары.Ссылка.Проведен = ИСТИНА";
			Запрос.УстановитьПараметр("РабочийЛистКСО", Строка.РабочийЛистКСО);
			Запрос.УстановитьПараметр("ДокСсылка", Источник.Ссылка);
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			Пока Выборка.Следующий() Цикл
				Сообщить("В строке № " + Строка(Строка.НомерСтроки) + " " + Строка(Строка.РабочийЛистКСО) + "	уже заведен в " + Строка(Выборка.Акт));
				Отказ = Истина;
			КонецЦикла;
			Если ТипЗнч(Строка.РабочийЛистКСО)=Тип("ДокументСсылка.РабочийЛистКредитногоОтдела") Тогда
				Если ЗначениеЗаполнено(Строка.РабочийЛистКСО.КредитнаяПрограмма) И Строка.РабочийЛистКСО.КредитнаяПрограмма.БанкКонтрагент <> Источник.Контрагент Тогда
					Сообщить("В строке № " + Строка(Строка.НомерСтроки) + " " + Строка(Строка.РабочийЛистКСО) + "	Контрагент в Кредитной программе ОТЛИЧАЕТСЯ от контрагента в " + Строка(Источник.Ссылка));
					Отказ = Истина;
				КонецЕсли;	
			КонецЕсли;	
			Если ТипЗнч(Строка.РабочийЛистКСО)=Тип("ДокументСсылка.РабочийЛистОтделаСтрахования") Тогда
				Если Строка.РабочийЛистКСО.ВариантыСтрахования.Количество() >0 И 
					ЗначениеЗаполнено(Строка.РабочийЛистКСО.ВариантыСтрахования[0].ПрограммаСтрахования) И
					Строка.РабочийЛистКСО.ВариантыСтрахования[0].ПрограммаСтрахования.Контрагент <> Источник.Контрагент Тогда
					Сообщить("В строке № " + Строка(Строка.НомерСтроки) + " " + Строка(Строка.РабочийЛистКСО) + "	Контрагент в программе Страхования ОТЛИЧАЕТСЯ от контрагента в " + Строка(Источник.Ссылка));
					Отказ = Истина;
				КонецЕсли;	
			КонецЕсли;	
			Если Строка.РабочийЛистКСО.Организация <> Источник.Организация Тогда
				Сообщить("В строке № " + Строка(Строка.НомерСтроки) + " " + Строка(Строка.РабочийЛистКСО) + "	Организация ОТЛИЧАЕТСЯ от Организации в " + Строка(Источник.Ссылка));
				Отказ = Истина;
			КонецЕсли;	
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПроверкаЗаполненияРеализацияТоваров(Источник, Отказ)
	
	
	Если РольДоступна("ВосстПослед") тогда
		Возврат;
	КонецЕсли;	
	
	
	//проверка Дата окончания договора	
	ОргТАС=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");
	ОргКунова=Справочники.Организации.НайтиПоРеквизиту("ИНН", "090103290098");
	
	Если (Источник.Организация <> ОргТАС) И
		(Источник.Организация <> ОргКунова) тогда       //только темп авто сервис  и кунова
		Возврат;
	КонецЕсли;
	
	Если (Источник.ДоговорВзаиморасчетов.ДатаКонца <> Дата(1,1,1)) И (Источник.ДоговорВзаиморасчетов.ДатаКонца < НачалоДня(Источник.Дата)) тогда
		сообщить ("Дата окончания договора меньше даты документа! Документ не может быть записан");
		Отказ = Истина;
	КонецЕсли;
	
	Если Источник.Организация = ОргКунова тогда //дальше только для Темп Авто Сервис
		Возврат;
	КонецЕсли;
	
	
	//<<Павличенко 20.08.2020
	//заявка Куновой
	Если Источник.ХозОперация <> Справочники.ХозОперации.РеализацияТоваров тогда
		Возврат;
	КонецЕсли;	
	НастройкиТАС = Справочники.ТТ_СписокПараметров.НайтиПоКоду("000013704");
	ПараметрыОтбора = Новый Структура();
	ПараметрыОтбора.Вставить("ЗначениеПараметра", "СкладКомпании");
	Табл = НастройкиТАС.СписокПараметров.Выгрузить(ПараметрыОтбора, "Параметр1, Параметр2, Параметр3, Параметр4, Параметр5");
	Если Табл.Найти(Источник.СкладКомпании) = Неопределено тогда
		сообщить ("Документ не может быть записан! Реализация товаров по ТАС со склада " + Источник.СкладКомпании + " запрещена!");
		Отказ = Истина;
	КонецЕсли;	
	ПараметрыОтбора = Новый Структура();
	ПараметрыОтбора.Вставить("ЗначениеПараметра", "ПодразделениеКомпании");
	Табл = НастройкиТАС.СписокПараметров.Выгрузить(ПараметрыОтбора, "Параметр1, Параметр2, Параметр3, Параметр4, Параметр5");
	
	Если Табл.Найти(Источник.ПодразделениеКомпании) = Неопределено тогда
		сообщить ("Документ не может быть записан! Реализация товаров по ТАС из подразделения " + Источник.ПодразделениеКомпании + " запрещена!");
		Отказ = Истина;
	КонецЕсли;	
	//>>Павличенко 20.08.2020
	
КонецПроцедуры

Процедура ПроверкаСпособаРаспределения(Источник, Отказ, РежимПроведения) 
	
	Если РольДоступна("ВосстПослед") тогда
		Возврат;
	КонецЕсли;	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Услуги.Номенклатура КАК Услуга
	|ПОМЕСТИТЬ Услуги
	|ИЗ
	|	&Услуги КАК Услуги
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка,
	|	Услуги.Услуга,
	|	Номенклатура.СпособРаспределенияДопРасходов
	|ИЗ
	|	Услуги КАК Услуги
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
	|		ПО Услуги.Услуга = Номенклатура.Ссылка
	|ГДЕ
	|	НЕ Номенклатура.СпособРаспределенияДопРасходов В (&СписокСпособовРаспределенияДопРасходов)";
	
	
	Запрос.УстановитьПараметр("Услуги", Источник.Товары);
	СписокСпособовРаспределенияДопРасходов = Новый СписокЗначений();
	СписокСпособовРаспределенияДопРасходов.Добавить(Перечисления.СпособыРаспределенияДопРасходов.ПоКоличеству);
	СписокСпособовРаспределенияДопРасходов.Добавить(Перечисления.СпособыРаспределенияДопРасходов.ПоСумме);
	Запрос.УстановитьПараметр("СписокСпособовРаспределенияДопРасходов", СписокСпособовРаспределенияДопРасходов);
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		сообщить("Для услуги " + ВыборкаДетальныеЗаписи.Услуга + " выбран неверный способ распределения дополнительных расходов! Нужно выбрать ""по количеству"" или ""по сумме""");
		сообщить("" + Источник + " не может быть проведен!");
		Отказ = Истина;
	КонецЦикла;
	
КонецПроцедуры


//Отключено
Процедура ПроверкаЗаполненияПоступлениеАвтомобилей(Источник, Отказ, РежимЗаписи, РежимПроведения) 
	
	Если РольДоступна("ВосстПослед") тогда
		Возврат;
	КонецЕсли;	
	
	Запрос = Новый Запрос();
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПоступлениеАвтомобилейАвтомобили.Автомобиль,
	|	ПоступлениеАвтомобилейАвтомобили.Автомобиль.Модель.КатегорияТС
	|ИЗ
	|	Документ.ПоступлениеАвтомобилей.Автомобили КАК ПоступлениеАвтомобилейАвтомобили
	|ГДЕ
	|	ПоступлениеАвтомобилейАвтомобили.Ссылка = &Ссылка
	|	И ПоступлениеАвтомобилейАвтомобили.Автомобиль.Модель.КатегорияТС = &ПустаяКатегорияТС";
	
	Запрос.УстановитьПараметр("Ссылка", Источник.Ссылка);
	Запрос.УстановитьПараметр("ПустаяКатегорияТС", Справочники.КатегорииТранспортныхСредств.ПустаяСсылка());
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() тогда
		Сообщить("Запись прервана! Не указана категория ТС в Модели автомобиля.");
		Отказ = Истина;
	КонецЕсли;	
	
	
КонецПроцедуры

Процедура ПроверкаЗаполненияПлатежноеПоручение(Источник, Отказ, РежимЗаписи, РежимПроведения) 
	
	Если РольДоступна("ВосстПослед") тогда
		Возврат;
	КонецЕсли;	
	
	Если Источник.ДокументОснование = Неопределено тогда
		Сообщить ("Нельзя вводить Платежное поручение с неуказанным документом-основанием!");
		Отказ = Истина;
		Возврат;
	КонецЕсли;	
	
КонецПроцедуры

Процедура ТТ_РабочийЛистКредитногоПередЗаписьюПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения) Экспорт
	
	
	//anton
	//Переделать на свойство кредитной программы.
	//anton
	
	//// Вставить содержимое обработчика.
	//Отказ = Истина;
	//Для Каждого Стр Из Справочники.ТТ_СписокПараметров.НайтиПоКоду("000015013").СписокПараметров Цикл
	//	Если Источник.КредитнаяПрограмма = стр.ЗначениеПараметра Тогда 
	//		Если Источник.Организация=стр.Параметр1 Тогда
	//			Отказ = Ложь;
	//			Возврат;
	//		КонецЕсли;	
	//	КонецЕсли;
	//КонецЦикла;
	//
	//Если Отказ=Истина Тогда
	//	Сообщить("Для данной кредитной программы необходимо выбрать другую организацию");
	//	Возврат; 
	//КонецЕсли;
	
	
КонецПроцедуры

Процедура ПроверкаЗаполненияЗаявкаНаРемонтПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения)
	
	Если ТипЗнч(Источник.Заказчик) = Тип("Строка") Тогда 
		Источник.Контрагент=Справочники.Контрагенты.ПустаяСсылка();
		Источник.ДоговорВзаиморасчетов= Справочники.ДоговорыВзаиморасчетов.ПустаяСсылка();
		Возврат;
	КонецЕсли;	
	
	
	Если Источник.Дата > Дата("20170929") Тогда
		Если Найти(Врег(Источник.ВидРемонта.Наименование),Врег("Страховой ремонт"))>0 Тогда
			Ошибки = "";
			Если Источник.Метаданные().Реквизиты.Найти("НомерНаправленияСтраховой")<>Неопределено Тогда
				Если СокрЛП(Источник.НомерНаправленияСтраховой)="" ТОгда
					Сообщить("Для вида ремонта - Страховой ремонт - должен быть заполнен реквизит: Номер направления страховой");
					Отказ = Истина;
				КонецЕсли;	
			КонецЕсли;	
			Если Источник.Метаданные().Реквизиты.Найти("ДатаНаправленияСтраховой")<>Неопределено Тогда
				Если НЕ ЗначениеЗаполнено(Источник.ДатаНаправленияСтраховой) ТОгда
					Сообщить("Для вида ремонта - Страховой ремонт - должен быть заполнен реквизит: Дата направления страховой");
					Отказ = Истина;
				КонецЕсли;	
			КонецЕсли;	
			Если Источник.Метаданные().Реквизиты.Найти("СуммаНаправленияСтраховой")<>Неопределено Тогда
				Если Источник.СуммаНаправленияСтраховой = 0 Тогда
					Сообщить("Для вида ремонта - Страховой ремонт - должен быть заполнен реквизит: Сумма направления страховой");
					Отказ = Истина;
				КонецЕсли;	
			КонецЕсли;	
		КонецЕсли;	
	КонецЕсли;
	
	//KamikadZe begin add 11.09.2020 17:17:33
	обОбщие.обПроверитьЗаполнитьМКУ(Источник);
	//KamikadZe end add
	
КонецПроцедуры

Процедура ПроверкаЗаполненияЗаказНарядПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения)
	
	Если РольДоступна("ПолныеПрава") Тогда
		Возврат;	
	КонецЕсли;
	
	Если НЕ Источник.Состояние=Справочники.ВидыСостоянийЗаказНарядов.Закрыт Тогда
		Источник.ДатаЗакрытия = Неопределено;
	КонецЕсли;		
	
	Если НЕ Источник.ЭтоНовый() И Источник.Организация <> Источник.Ссылка.Организация Тогда
		Сообщить("Запись прервана! Нельзя менять организацию заказ-наряда.");
		Отказ=Истина;
		Возврат;
	КонецЕсли;	
	
	//anton оптимизировано 14/05/2019
	Если НЕ Источник.ЭтоНовый() И
		СтрНайти( НРег(Источник.Ссылка.ВидРемонта.Наименование),"гаранти" ) > 0 Тогда
		
		ИзменениеГарантЗаказНарядовБезОграничений = обПраво("ИзменениеГарантЗаказНарядовБезОграничений");
		
		Если НЕ ИзменениеГарантЗаказНарядовБезОграничений Тогда
			
			//+Тарабанов ограничение на ссмену вида работы гарантийных ЗН по дням		
			КолДнейИзмененияГарантии = обПраво("КолДнейИзмененияГарантии");
			Если КолДнейИзмененияГарантии > 0 И НачалоДня(ТекущаяДата()) - НачалоДня(Источник.Ссылка.Дата) > КолДнейИзмененияГарантии*24*60*60 Тогда
				Сообщить("Прошло более "+КолДнейИзмененияГарантии+" дней с моменты создания документа! Изменения запрещены.");						
				Отказ = Истина;
			КонецЕсли;
			
			//+Тарабанов Проверка на макс сумму гарантийных ЗН
			МаксСуммаГарантЗаказНарядов = обПраво("МаксСуммаГарантЗаказНарядов");
			Если МаксСуммаГарантЗаказНарядов < Источник.СуммаДокумента Тогда
				Сообщить("Запрещено создавать документ на сумму свыше " + Формат(МаксСуммаГарантЗаказНарядов, "ЧРГ="));					
				Отказ = Истина;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	//anton оптимизировано 14/05/2019	
	
	//Запрет смены организации если было перемещение в производство
	Если Источник.Организация <> Источник.Ссылка.Организация Тогда 
		Для Каждого Стр из Источник.Товары Цикл
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
			|	ПеремещениеТоваровВПроизводство.Ссылка
			|ИЗ
			|	Документ.ПеремещениеТоваровВПроизводство КАК ПеремещениеТоваровВПроизводство
			|ГДЕ
			|	ПеремещениеТоваровВПроизводство.Товары.Номенклатура.Ссылка = &Товар
			|	И ПеремещениеТоваровВПроизводство.ПометкаУдаления = ЛОЖЬ
			|	И ПеремещениеТоваровВПроизводство.Проведен = ИСТИНА
			|	И ПеремещениеТоваровВПроизводство.ДокументОснование = &ДокументОснование";
			Запрос.УстановитьПараметр("Товар", Стр.Номенклатура);
			Запрос.УстановитьПараметр("ДокументОснование", Источник.Ссылка);
			Результат = Запрос.Выполнить();
			Если НЕ Результат.Пустой() Тогда
				Отказ = Истина;
				Сообщить("Невозможно изменить организацию, т.к. есть перемещение в производство по товару """+Стр.Номенклатура.Наименование+"");
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;	
	
	// Проверка на наличие перемещений если пытаются перевести в отказ
	Если Источник.Состояние = Справочники.ВидыСостоянийЗаказНарядов.НайтиПоНаименованию("Отказ от ремонта") Тогда 
		Для Каждого Стр из Источник.Товары Цикл
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
			|	ПеремещениеТоваровВПроизводство.Ссылка
			|ИЗ
			|	Документ.ПеремещениеТоваровВПроизводство КАК ПеремещениеТоваровВПроизводство
			|ГДЕ
			|	ПеремещениеТоваровВПроизводство.Товары.Номенклатура.Ссылка = &Товар
			|	И ПеремещениеТоваровВПроизводство.ПометкаУдаления = ЛОЖЬ
			|	И ПеремещениеТоваровВПроизводство.Проведен = ИСТИНА
			|	И ПеремещениеТоваровВПроизводство.ДокументОснование = &ДокументОснование";
			Запрос.УстановитьПараметр("Товар", Стр.Номенклатура);
			Запрос.УстановитьПараметр("ДокументОснование", Источник.Ссылка);
			Результат = Запрос.Выполнить();
			Если НЕ Результат.Пустой() Тогда
				Отказ = Истина;
				Сообщить("Невозможно изменить статус, т.к. есть перемещение в производство по товару """+Стр.Номенклатура.Наименование+"");
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;	
	
	//До загрузки моделей
	Возврат;
	
	//anton оптимизировано 14/05/2019
	//	// 16/10/18 Ульянов
	////Установка цены на ПСО  ЦБ000027
	Если Источник.ВидРемонта=Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000024") и не Источник.Состояние=Справочники.ВидыСостоянийЗаказНарядов.Закрыт Тогда
		СуммаПроверки=0;
		Если Источник.Автомобиль.Модель.Родитель=Справочники.Модели.НайтиПоКоду("ЦБ00000070") Тогда  //Приора
			СуммаПроверки=1300;	
		ИначеЕсли Источник.Автомобиль.Модель.ПринадлежитЭлементу(Справочники.Модели.НайтиПоКоду("ЦБ00000010")) Тогда  //Вазы
			СуммаПроверки=1500;				
		ИначеЕсли Источник.Автомобиль.Модель.ПринадлежитЭлементу(Справочники.Модели.НайтиПоКоду("ЦБ00000301")) Тогда  //УАЗ
			СуммаПроверки=3400;				  
		ИначеЕсли Источник.Автомобиль.Модель=Справочники.Модели.НайтиПоКоду("ЦБ00000072") Тогда  // Шеви Нива		
			СуммаПроверки=3700;				 
		КонецЕсли;
		Если СуммаПроверки <> 0 И Источник.СуммаДокумента<>СуммаПроверки Тогда 
			Если Источник.Товары.Итог("СуммаВсего")<СуммаПроверки Тогда			
				Если Источник.Работы.Количество()=1 Тогда
					Стр=Источник.Работы[0];
					Стр.СуммаВсего=СуммаПроверки-Источник.Товары.Итог("СуммаВсего");
					Источник.ОбработкаРеквизита("Работы.СуммаВсего",Стр,Неопределено);
				Иначе
					Сообщить("Обнаружено больше одной работы, автоустановка суммы з-н невозможна");
				КонецЕсли;	
			КонецЕсли;	
		КонецЕсли;	
		
	КонецЕсли;	
	//anton оптимизировано 14/05/2019
	
КонецПроцедуры

Процедура ПроверкаНомераАктаГР(Источник, Отказ, РежимПроведения)   	
	
	Если РольДоступна("ПолныеПрава") ИЛИ РольДоступна("ВосстПослед") тогда
		Возврат;
	КонецЕсли; 
	
	ОргТТ=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2312127750");
	ОргТАС=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");
	
	Если (Источник.Организация = ОргТАС ИЛИ Источник.Организация =ОргТТ) И 
		Источник.Состояние=Справочники.ВидыСостоянийЗаказНарядов.Закрыт  И
		Источник.ВидРемонта=справочники.ВидыРемонта.НайтиПоКоду("ЦБ000010") Тогда //гарантия	
		НомерАкта = обПолучитьЗначениеСвойства(Источник, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Номер Акта ГР"),"");
		Если обЗначениеНеЗаполнено(НомерАкта) Тогда
			Сообщить("Перед закрытием необходимо заполнить свойство ""Номер Акта ГР""");
			Отказ=Истина;
		КонецЕсли;
	КонецЕсли; 
	
КонецПроцедуры

Процедура ПроверкаНаНДС(Источник, Отказ, РежимПроведения)
	
	Если РольДоступна("ВосстПослед") тогда
		Возврат;
	КонецЕсли;	
	
	Если  Источник.ВидРемонта=Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000017") ИЛИ
		Источник.ВидРемонта=Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000018") ИЛИ
		Источник.ВидРемонта=Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000045")  Тогда //Определить виды ремонта	
		
		Для каждого Стр из Источник.Товары Цикл
			Если НЕ Стр.СтавкаНДС=Справочники.СтавкиНДС.ОсновнаяСтавкаНДС И Источник.Дата >= Дата("20260101") Тогда
				Сообщить("В строке "+Стр.НомерСтроки+" табличной части товары неверно заполнена ставка НДС. Запись невозможна");
				Отказ=Истина;
			КонецЕсли;
			
			Запрос=Новый Запрос;
			Запрос.Текст="ВЫБРАТЬ
			//<<Павличенко 14.09.2020 не учитывались извлечения
			|ТоварыВПроизводствеОбороты.СуммаПриход - ТоварыВПроизводствеОбороты.СуммаНДСПриход - ТоварыВПроизводствеОбороты.СуммаРасход + ТоварыВПроизводствеОбороты.СуммаНДСРасход КАК БезНДС
			//|ТоварыВПроизводствеОбороты.СуммаПриход -ТоварыВПроизводствеОбороты.СуммаНДСПриход КАК БезНДС
			//>>Павличенко 14.09.2020
			|ИЗ
			|РегистрНакопления.ТоварыВПроизводстве.Обороты КАК ТоварыВПроизводствеОбороты
			|ГДЕ
			|ТоварыВПроизводствеОбороты.ЗаказНаряд = &ЗаказНаряд
			|И ТоварыВПроизводствеОбороты.Номенклатура = &Номенклатура";
			Запрос.УстановитьПараметр("ЗаказНаряд",Источник.ссылка);
			Запрос.УстановитьПараметр("Номенклатура",Стр.Номенклатура);
			Рез=Запрос.Выполнить().Выбрать();
			Пока Рез.Следующий() Цикл
				Если Рез.БезНДС	> Стр.СуммаВсего-Стр.СуммаНДС Тогда
					Сообщить("В строке "+Стр.НомерСтроки+" табличной части товары сумма меньше себестоимости. Запись невозможна");
					Если обПраво("ЗапретитьПродажуНижеСебестоимости") Тогда
						Отказ=Истина;
					КонецЕСли;	
				КонецЕсли;	
			КонецЦикла;	
			
		КонецЦикла;	
		
		Для каждого Стр из Источник.Работы Цикл
			Если НЕ Стр.СтавкаНДС=Справочники.СтавкиНДС.ОсновнаяСтавкаНДС И Источник.Дата >= Дата("20260101") Тогда
				Сообщить("В строке "+Стр.НомерСтроки+" табличной части работы неверно заполнена ставка НДС. Запись невозможна");
				Отказ=Истина;
			КонецЕсли;
		КонецЦикла;	
		
		
	КонецЕсли;
КонецПроцедуры	

Процедура ПроверкаОбязательногоТюнинга(Источник, Отказ, РежимПроведения)
	
	#Если Клиент Тогда	
		
		Если ( Источник.Состояние=Справочники.ВидыСостоянийЗаказНарядов.Выполнен ИЛИ
			Источник.Состояние=Справочники.ВидыСостоянийЗаказНарядов.Закрыт ) И
			Источник.ВидРемонта=справочники.ВидыРемонта.ДополнительноеОборудование Тогда //Определить виды ремонта	
			
			Свойство=ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Вид обязательного тюнинга");
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ЗначенияСвойств.Ссылка
			|ИЗ
			|	Справочник.ЗначенияСвойств КАК ЗначенияСвойств
			|ГДЕ
			|	ЗначенияСвойств.Владелец = &Владелец
			|	И НЕ ЗначенияСвойств.ПометкаУдаления";
			
			Запрос.УстановитьПараметр("Владелец", Свойство);
			
			МассивОбязательных=Новый Массив;
			МассивОбязательных = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
			
			ТабЗначенийСвойств=Новый ТаблицаЗначений;
			ТабЗначенийСвойств.Колонки.Добавить("Ссылка");
			
			Если МассивОбязательных.Количество() > 0 Тогда
				
				//Получим все использованные свойства в ТЧ Товары
				Для каждого Стр из Источник.Товары Цикл			
					
					ЗначениеСвойства=обПолучитьЗначениеСвойства(Стр.Номенклатура, Свойство, Неопределено);	
					
					Если НЕ обЗначениеНеЗаполнено(ЗначениеСвойства) Тогда
						НовСтр=ТабЗначенийСвойств.Добавить();
						НовСтр.Ссылка=ЗначениеСвойства;
					КонецЕсли;
					
				КонецЦикла;
				
				ТабЗначенийСвойств.Свернуть("Ссылка");
				
				СтрокаВывода="";
				//Проверим наличие каждого из обязательных
				Для каждого Стр из МассивОбязательных Цикл
					
					НайденноеЗначение=ТабЗначенийСвойств.Найти(Стр, "Ссылка");					
					Если НайденноеЗначение = Неопределено Тогда
						СтрокаВывода=СтрокаВывода+Стр+"; ";
					КонецЕсли;
					
				КонецЦикла;
				
				Если СтрокаВывода <> "" Тогда
					Предупреждение("В списке товаров нет тюнинга следующих видов: "+СтрокаВывода);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	#КонецЕсли
	
	
КонецПроцедуры

Процедура ПроверитьЗаполнениеКвоты(Источник, Отказ, РежимПроведения)
	
	#Если Клиент Тогда	
		
		Если РольДоступна("ВосстПослед") тогда
			Возврат;
		КонецЕсли;	
		
		СвойствоСток=ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Заводская квота");
		
		//Если СвойствоСток.Пустая() Тогда
		//	
		//	СвойствоСток=ПланыВидовХарактеристик.СвойстваОбъектов.СоздатьЭлемент();
		//	СвойствоСток.Наименование="Заводская квота";
		//	СвойствоСток.ТипЗначения=Тип("СправочникСсылка.ЗначенияСвойств");
		//	СвойствоСток.Записать();
		//	
		//	СпрЗнСв=Справочники.ЗначенияСвойств.СоздатьЭлемент();
		//	СпрЗнСв.Владелец=СвойствоСток.Ссылка;
		//	СпрЗнСв.Наименование="Корпоративная квота";
		//	СпрЗнСв.Записать();
		//	
		//	СпрЗнСв=Справочники.ЗначенияСвойств.СоздатьЭлемент();
		//	СпрЗнСв.Владелец=СвойствоСток.Ссылка;
		//	СпрЗнСв.Наименование="Розничная квота";
		//	СпрЗнСв.Записать();
		//	
		//КонецЕсли;
		
		ДанныеНастройки = Константы.CMExpertНастройки.Получить().Получить();
		ЭтоTradeIn=Ложь;
		Если ЗначениеЗаполнено(ДанныеНастройки) Тогда
			
			СписокСкладов = ДанныеНастройки.Склад;			
			//Если это склад трейд-ин для выгрузки в CM Expert, то установим Сток розничный
			Если СписокСкладов.НайтиПоЗначению(Источник.СкладКомпании) <> Неопределено Тогда
				ЭтоTradeIn=Истина;
			КонецЕсли;	
			
		КонецЕсли;
		
		Для каждого Стр из Источник.Автомобили Цикл
			Если ЭтоTradeIn Тогда
				РС=РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьМенеджерЗаписи();
				РС.Объект=Стр.Автомобиль;
				РС.Свойство=СвойствоСток.Ссылка;
				РС.Значение=Справочники.ЗначенияСвойств.НайтиПоНаименованию("Розничная квота");
				РС.Записать();				
			Иначе
				РС=РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();
				РС.Отбор.Объект.Установить(Стр.Автомобиль);
				РС.Отбор.Свойство.Установить(СвойствоСток.Ссылка);
				РС.Прочитать();
				Если РС.Количество()=0 ИЛИ РС[0].Значение=Справочники.ЗначенияСвойств.ПустаяСсылка() Тогда
					Сообщить("Необходимо назначить Заводскую квоту в свойствах автомобиля "+Стр.Автомобиль+". Проведение прервано.");
					Отказ=Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
	#КонецЕсли
	
КонецПроцедуры

Процедура ПроверитьНаУстановкуЦенПоTradeIn(Источник, Отказ, РежимПроведения)
	#Если Клиент Тогда	
		
		Если РольДоступна("ВосстПослед") ИЛИ Источник.Дата < Дата(2019,8,16) тогда
			Возврат;
		КонецЕсли;	
		
		ДанныеНастройки = Константы.CMExpertНастройки.Получить().Получить();
		Если ЗначениеЗаполнено(ДанныеНастройки) Тогда
			
			СписокСкладов = ДанныеНастройки.Склад;			
			
			//Если это склад трейд-ин для выгрузки в CM Expert, то проверим заполнение пробега, года выпуска и Назначение цены
			Если СписокСкладов.НайтиПоЗначению(Источник.СкладКомпании) <> Неопределено Тогда
				Для каждого Стр из Источник.Автомобили Цикл
					
					Если обЗначениеНеЗаполнено(Стр.Автомобиль.ГодВыпуска) Тогда
						Сообщить("Перед проведением документа необходимо заполнить Год выпуска автомобиля "+Стр.Автомобиль);
						Отказ=Истина;
					КонецЕсли;
					
					Пробег=справочники.Автомобили.ЧтениеЗначенияРегистраСведения(Стр.Автомобиль, Перечисления.ДополнительнаяИнформацияАвтомобилей.Пробег,ТекущаяДата());
					Если обЗначениеНеЗаполнено(Пробег) Тогда
						Сообщить("Перед проведением документа необходимо заполнить Пробег автомобиля "+Стр.Автомобиль);
						Отказ=Истина;
					КонецЕсли;
					
					//Запрос = Новый Запрос;
					//Запрос.Текст = 
					//"ВЫБРАТЬ
					//|	ЕСТЬNULL(ЦеныАвтомобилейСрезПоследних.Цена, 0) КАК Цена
					//|ИЗ
					//|	РегистрСведений.ЦеныАвтомобилей.СрезПоследних(
					//|			,
					//|			ТипЦен = &ТипЦен
					//|				И Автомобиль = &Автомобиль) КАК ЦеныАвтомобилейСрезПоследних";
					//
					//Запрос.УстановитьПараметр("Автомобиль", Стр.Автомобиль);
					//Запрос.УстановитьПараметр("ТипЦен", Справочники.ТипыЦен.ОсновнойТипЦенПродажи);
					//
					//РезультатЗапроса = Запрос.Выполнить();
					//
					//Если РезультатЗапроса.Пустой() Тогда
					//	Сообщить("Не назначена Цена продажи автомобиля "+Стр.Автомобиль+" ! Перед проведением необходимо ввести цену документом ""Изменение цен автомобиля""");
					//	Отказ=Истина;
					//КонецЕсли;
					
				КонецЦикла;
				
			КонецЕсли;
			
		КонецЕсли;		
		
	#КонецЕсли
	
КонецПроцедуры

Процедура ПроверкаЗаполненияРеализацияТоваровПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения)
	//<<Павличенко 29.06.2020 заявка Куновой 3240
	СписокОрганизаций = Новый СписокЗначений();
	СписокОрганизаций.Добавить(Справочники.Организации.НайтиПоКоду("ЦБ000002"));  //Техно-Темп
	СписокОрганизаций.Добавить(Справочники.Организации.НайтиПоКоду("ЦБ000009"));  //ФКДД
	СписокОрганизаций.Добавить(Справочники.Организации.НайтиПоКоду("ЦБ000003"));  //Меридиан
	СписокОрганизаций.Добавить(Справочники.Организации.НайтиПоКоду("ЦБ000001"));  //ТАК
	
	БЕЗНДС = ложь;
	
	Если СписокОрганизаций.НайтиПоЗначению(Источник.Организация)<> Неопределено тогда   //нашел
		Для каждого СтрЗапчасти из Источник.Товары цикл
			Если СтрЗапчасти.Номенклатура.ТипНоменклатуры = Справочники.ТипыНоменклатуры.Услуга тогда
				Продолжить;
			КонецЕсли;
			
			Если (СтрЗапчасти.СтавкаНДС = Справочники.СтавкиНДС.БезНДС) Тогда
				БЕЗНДС = Истина;
				Прервать;
			КонецЕсли;
			
			//Если СтрЗапчасти.СуммаНДС <> Окр((СтрЗапчасти.СуммаВсего * СтрЗапчасти.СтавкаНДС.Ставка)/(100 + СтрЗапчасти.СтавкаНДС.Ставка),2) тогда
			//	Отказ=Истина;
			//	Сообщить("Неверный расчет НДС по номенклатуре " + СтрЗапчасти.Номенклатура.Наименование);
			//КонецЕсли;
			
		Конеццикла;
	КонецЕсли;
	
	Если БЕЗНДС тогда
		Если НЕ РольДоступна("ВосстПослед") и НЕ ОбПраво("ПроведениеБезНДС") тогда
			Отказ=Истина;
			Сообщить("Запись невозможна, для организации " + Источник.Организация + " продажа без НДС запрещена");
		КонецЕсли;
	КонецЕсли;	
	//>>Павличенко 29.06.2020
	
	////Проверка на подразделение Магазин	
	//Если Источник.ХозОперация = Справочники.ХозОперации.РеализацияТоваров 
	//	И НЕ обЗначениеНеЗаполнено(Источник.СкладКомпании) Тогда
	//	
	//	Запрос = Новый Запрос;
	//	Запрос.Текст = 
	//	"ВЫБРАТЬ
	//	|	ПодразделенияКомпании.Ссылка
	//	|ИЗ
	//	|	Справочник.ПодразделенияКомпании КАК ПодразделенияКомпании
	//	|ГДЕ
	//	|	ПодразделенияКомпании.Организация = &Организация
	//	|	И ПодразделенияКомпании.Наименование ПОДОБНО &Наименование
	//	|	И ПодразделенияКомпании.ПометкаУдаления = ЛОЖЬ";
	//	
	//	Запрос.УстановитьПараметр("Наименование", "%Магазин "+ СокрЛП(Источник.СкладКомпании.Подразделение.Префикс)+"%" );
	//	Запрос.УстановитьПараметр("Организация", Источник.Организация);
	//	
	//	РезультатЗапроса = Запрос.Выполнить();
	//	
	//	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();	
	//	Если ВыборкаДетальныеЗаписи.Следующий() И ВыборкаДетальныеЗаписи.Ссылка <> Источник.ПодразделениеКомпании  Тогда 
	//		Источник.ПодразделениеКомпании=ВыборкаДетальныеЗаписи.Ссылка;	
	//	КонецЕсли;
	//	
	//КонецЕсли;
	//

	
	////Проверка на подразделение Магазин	
	//Если Источник.ХозОперация = Справочники.ХозОперации.РеализацияТоваров 
	//	И НЕ обЗначениеНеЗаполнено(Источник.СкладКомпании) Тогда
	//	
	//	Запрос = Новый Запрос;
	//	Запрос.Текст = 
	//	"ВЫБРАТЬ
	//	|	ПодразделенияКомпании.Ссылка
	//	|ИЗ
	//	|	Справочник.ПодразделенияКомпании КАК ПодразделенияКомпании
	//	|ГДЕ
	//	|	ПодразделенияКомпании.Организация = &Организация
	//	|	И ПодразделенияКомпании.Наименование ПОДОБНО &Наименование
	//	|	И ПодразделенияКомпании.ПометкаУдаления = ЛОЖЬ";
	//	
	//	Запрос.УстановитьПараметр("Наименование", "%Магазин "+ СокрЛП(Источник.СкладКомпании.Подразделение.Префикс)+"%" );
	//	Запрос.УстановитьПараметр("Организация", Источник.Организация);
	//	
	//	РезультатЗапроса = Запрос.Выполнить();
	//	
	//	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();	
	//	Если ВыборкаДетальныеЗаписи.Следующий() И ВыборкаДетальныеЗаписи.Ссылка <> Источник.ПодразделениеКомпании  Тогда 
	//		Источник.ПодразделениеКомпании=ВыборкаДетальныеЗаписи.Ссылка;	
	//	КонецЕсли;
	//	
	//КонецЕсли;
	//
КонецПроцедуры

Процедура ПроверкаЗаполненияЧекНаОплату(Источник, Отказ, РежимЗаписи, РежимПроведения)	
	
	Если Источник.Оплаты.Количество()>0 Тогда
		
		Для каждого СтрокаОплаты из Источник.Оплаты Цикл			
			Если СтрокаОплаты.ТипОплаты=Справочники.ТипыОплат.Наличные Тогда
				Продолжить;
			КонецЕсли;
			
			Если обЗначениеНеЗаполнено(СтрокаОплаты.Контрагент) Тогда
				СтрокаОплаты.Контрагент = обПолучитьПраваИНастройкиПользователя(Источник.ПодразделениеКомпании,"ОсновнаяПлатежнаяСистема");
			КонецЕсли;
			
			Если обЗначениеНеЗаполнено(СтрокаОплаты.ДоговорВзаиморасчетов) 
				ИЛИ СтрокаОплаты.ДоговорВзаиморасчетов.Владелец <> СтрокаОплаты.Контрагент Тогда
				//БИЗТЕХ КОВАЛЬ
				Попытка
					ДоговорВзаиморасчетовКодОплаты = обПолучитьЗначениеСвойства(Источник.ПодразделениеКомпании,"Код договора для оплаты");
					Если ЗначениеЗаполнено(ДоговорВзаиморасчетовКодОплаты) тогда
						ДоговорВзаиморасчетовОплаты	= Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду(ДоговорВзаиморасчетовКодОплаты);
					КонецЕсли;
					Если ЗначениеЗаполнено(ДоговорВзаиморасчетовОплаты) тогда
						СтрокаОплаты.ДоговорВзаиморасчетов = ДоговорВзаиморасчетовОплаты;
					КонецЕсли;
				Исключение;
					СтрокаОплаты.ДоговорВзаиморасчетов = обПолучитьПраваИНастройкиПользователя(Источник.Организация,"ЭквайрингДоговорОПС");		
				КонецПопытки;
				//СтрокаОплаты.ДоговорВзаиморасчетов = обПолучитьПраваИНастройкиПользователя(Источник.Организация,"ЭквайрингДоговорОПС");	
				//БИЗТЕХ КОВАЛЬ --	
			КонецЕсли;				
			
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

//-----------Вспомогательные процедуры-------------
Процедура ДвиженияПоВозмещению(Источник, Отказ, РежимПроведения)
	/////////////////
	//Источник = Документы.РеализацияАвтомобилей.НайтиПоНомеру("").ПолучитьОбъект();
	////////////////
	
	Если Источник.Метаданные().Имя = "РеализацияАвтомобилей" Тогда
		
		Для Каждого Стр Из Источник.Автомобили Цикл
			
			Внутр = ТТ_Общий.ВнутрКонтрагент(Источник.Контрагент);
			
			Если Внутр Тогда Продолжить КонецЕсли; //Исключим внутренних контрагентов
			
			//Исключим все склады кроме основных			
			Если Источник.СкладКомпании.тт_КатегорияСклада.Код <> "000000001" и	//Основной
				Источник.СкладКомпании.тт_КатегорияСклада.Код <> "000000004" и   //Корп
				Источник.СкладКомпании.тт_КатегорияСклада.Код <> "000000002" Тогда //ТестДрайв
				Продолжить;
			КонецЕсли;
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	тт_СкидкиНаАвтомобиль.Скидка,
			|	СУММА(тт_СкидкиНаАвтомобиль.СуммаСкидки) КАК СуммаСкидки,
			|	тт_СкидкиНаАвтомобиль.Одобрено,
			|	СУММА(тт_СкидкиНаАвтомобиль.СуммаВозмещения) КАК СуммаВозмещения
			|ИЗ
			|	РегистрСведений.тт_СкидкиНаАвтомобиль КАК тт_СкидкиНаАвтомобиль
			|ГДЕ
			|	тт_СкидкиНаАвтомобиль.Объект = &Объект
			|	И тт_СкидкиНаАвтомобиль.Одобрено = ИСТИНА
			|	И тт_СкидкиНаАвтомобиль.Скидка.СуммаВозмещения > 0
			|
			|СГРУППИРОВАТЬ ПО
			|	тт_СкидкиНаАвтомобиль.Одобрено,
			|	тт_СкидкиНаАвтомобиль.Скидка";
			
			Запрос.УстановитьПараметр("Объект", Стр.ЗаказНаАвтомобиль);
			
			ТЗСкидок = Запрос.Выполнить().Выгрузить();
			Если ТЗСкидок.Количество() >0 Тогда
				
				Для Каждого СтрТЗ Из ТЗСкидок Цикл
					
					НоваяЗапись=Источник.Движения.тт_Возмещения.Добавить();				
					НоваяЗапись.Автомобиль = Стр.Автомобиль;
					НоваяЗапись.СтатусВозмещения = Справочники.ТТ_СтатусыВозмещений.Продажа;
					НоваяЗапись.Скидка = СтрТЗ.Скидка;
					НоваяЗапись.СуммаВозмещения = СтрТЗ.СуммаВозмещения;
					НоваяЗапись.Регистратор = Источник.Ссылка;
					НоваяЗапись.Период=Источник.Дата;
					Источник.Движения.тт_Возмещения.Записать(Истина);
					
				КонецЦикла;
				
			Иначе
				
				Запрос = Новый Запрос;
				Запрос.Текст = 
				"ВЫБРАТЬ
				|	тт_ВозмещенияСрезПоследних.Автомобиль
				|ИЗ
				|	РегистрСведений.тт_Возмещения.СрезПоследних КАК тт_ВозмещенияСрезПоследних
				|ГДЕ
				|	тт_ВозмещенияСрезПоследних.СтатусВозмещения = &СтатусВозмещения
				|	И тт_ВозмещенияСрезПоследних.Автомобиль = &Автомобиль
				|	И тт_ВозмещенияСрезПоследних.Регистратор <> &Регистратор";
				
				Запрос.УстановитьПараметр("СтатусВозмещения", Справочники.ТТ_СтатусыВозмещений.Продажа);
				Запрос.УстановитьПараметр("Автомобиль", Стр.Автомобиль);
				Запрос.УстановитьПараметр("Регистратор", Источник.Ссылка);
				
				РезультатЗапроса = Запрос.Выполнить().Выбрать();
				
				Если РезультатЗапроса.Количество() = 0 Тогда
					
					НоваяЗапись=Источник.Движения.тт_Возмещения.Добавить();				
					НоваяЗапись.Автомобиль = Стр.Автомобиль;
					НоваяЗапись.СтатусВозмещения = Справочники.ТТ_СтатусыВозмещений.Продажа;
					НоваяЗапись.Скидка = ПолучитьСкидкуБезВозмещения(Источник.Организация);
					НоваяЗапись.Регистратор = Источник.Ссылка;
					НоваяЗапись.Период=Источник.Дата;
					Источник.Движения.тт_Возмещения.Записать(Истина);
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	//Источник.Движения..Очистить();
	//
	//НаборЗаписей = Источник.Движения.ТТ_ФактПоУтвержденнымЗаявкамДС.ДобавитьПриход();
	//
	//Для Каждого Стр Из Источник.Платежи Цикл
	//	НаборЗаписей.Организация = ИСточник.Организация;
	//	НаборЗаписей.Период = Стр.ДатаПлатежа;
	//	НаборЗаписей.Подразделение = Источник.ПодразделениеКомпании;
	//	НаборЗаписей.Регистратор = Источник.Ссылка;
	//	
	//	СтатьяДДС = обПолучитьЗначениеСвойства(Источник,ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("02043"));
	//	НаборЗаписей.СтатьяДДСУпр = СтатьяДДС;
	//	НаборЗаписей.Сумма	= Стр.Сумма;
	//КонецЦикла;
	
КонецПроцедуры

Процедура ОбработкаЗаполненияККМ(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	//Попытка
	//	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ЗаказНаряд") Тогда
	//		Источник.СтатьяДДС = Справочники.СтатьиДДС.НайтиПоКоду("ЦБ0000024");
	//	Иначе
	//		Источник.СтатьяДДС = Справочники.СтатьиДДС.ОплатаОтПокупателя;
	//	КонецЕсли;
	//Исключение
	//КонецПопытки;
	
	Попытка	
		Если Источник.ЭтоНовый() Тогда
			КассаККМ = обПолучитьПраваИНастройкиПользователя(Источник.ПодразделениеКомпании, "ОсновнаяКассаККМ", Источник);
			СкладККМ = обПолучитьПраваИНастройкиПользователя(Источник.ПодразделениеКомпании, "СкладДляККМ", Источник);
			ФРПоУмолчанию = обПолучитьПраваИНастройкиПользователя(Источник.ПодразделениеКомпании, "ФРПоУмолчанию", Источник);
			
			Источник.КассаККМ 				= КассаККМ;
			Источник.СкладКомпании 			= СкладККМ;
			Источник.ФР 					= ФРПоУмолчанию;
			//БИЗТЕХ КОВАЛЬ 01.04.2025 ++
			Источник.СкладКомпании			= Неопределено;
			Источник.ДляПробитияНаФР		= Истина;
			//Источник.ТипСпособаРасчетаККТ=Перечисления.ТипыСпособаРасчетаККТ.Передача;
			//Источник.ТипСпособаРасчетаККТ=Перечисления.ТипыСпособаРасчетаККТ.Предоплата;
			//БИЗТЕХ КОВАЛЬ 01.04.2025 --
		КонецЕсли;
	Исключение
	КонецПопытки;
	
КонецПроцедуры

Процедура ПроверкаНаДубли(Источник, Отказ)
	
	#Если Клиент Тогда	
		
		Если НЕ Источник.ЭтоНовый() 
			ИЛИ Источник.ОбменДанными.Загрузка=Истина
			ИЛИ Источник.ФормаСобственности=Перечисления.ФормыСобственности.ЧастноеЛицо
			Тогда
			Возврат;
		КонецЕсли;
		
		Если РольДоступна("ПолныеПрава") И обЗначениеНеЗаполнено(Источник.ИНН) 
			Тогда
			Возврат;
		КонецЕсли;
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	Контрагенты.Ссылка
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|ГДЕ
		|	Контрагенты.ИНН = &ИНН
		|	И Контрагенты.КПП = &КПП
		|	И Контрагенты.Ссылка <> &Этот";
		
		Запрос.УстановитьПараметр("ИНН", СокрЛП(Источник.ИНН));
		Запрос.УстановитьПараметр("КПП",  СокрЛП(Источник.КПП));
		Запрос.УстановитьПараметр("Этот",  Источник.Ссылка);
		
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Если ВыборкаДетальныеЗаписи.Следующий() Тогда
			Сообщить("Запись прервана! Уже существует контрагент с такими ИНН/КПП: "+ВыборкаДетальныеЗаписи.Ссылка);
			Отказ=Истина;
		КонецЕсли;
		
	#КонецЕсли
	
КонецПроцедуры

Процедура ОбработкаЗаполненияПКО(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	Попытка
		обОбщие.обОпределениеФРСтатьяДДС(Источник);
	Исключение
	КонецПопытки;
	// Ульянов 23,03	
	Если ТипЗнч(Источник.ДокументОснование)=Тип("ДокументСсылка.СтраховойПолис") Тогда
		Источник.Контрагент = Источник.ДокументОснование.Страхователь;
		Источник.ДоговорВзаиморасчетов = Источник.ДокументОснование.ДоговорВзаиморасчетов;
		Источник.СуммаДокумента = Источник.ДокументОснование.СуммаПремии;
		Источник.СтавкаНДС = Справочники.СтавкиНДС.БезНДС;	
		Источник.СтатьяДДС = Справочники.СтатьиДДС.ОплатаОтПокупателя;
	КонецЕСли;	
	
КонецПроцедуры

Процедура УстановитьСтатусОплатыАвтомобиля(Источник, Отказ, РежимПроведения)
	
	Если НЕ Отказ И Источник.СтатусТТ = Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.Оплата Тогда
		Если Источник.Автомобили.Количество() = 0 Тогда
			Возврат;
		КонецЕсли;
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ИзменениеСтатусаВыкупаАвтомобилей.Ссылка
		|ИЗ
		|	Документ.ИзменениеСтатусаВыкупаАвтомобилей КАК ИзменениеСтатусаВыкупаАвтомобилей
		|ГДЕ
		|	ИзменениеСтатусаВыкупаАвтомобилей.ДокументОснование = &ДокументОснование
		|	И ИзменениеСтатусаВыкупаАвтомобилей.ПометкаУдаления = ЛОЖЬ
		|	И ИзменениеСтатусаВыкупаАвтомобилей.Проведен";
		
		Запрос.УстановитьПараметр("ДокументОснование", Источник.Ссылка);			
		РезультатЗапроса = Запрос.Выполнить();
		
		Если РезультатЗапроса.Пустой() Тогда
			
			Док=документы.ИзменениеСтатусаВыкупаАвтомобилей.СоздатьДокумент();
			Док.Дата = КонецДня(Источник.Дата);
			Док.Заполнить(Источник.Ссылка);
			
			Для Каждого Стр ИЗ Док.Автомобили Цикл
				Статус = ПолучитьСтатусПоДоговору(Источник.Контрагент, Источник.ДоговорВзаиморасчетов);
				Если Статус <> Неопределено Тогда
					Стр.Статус=Статус;
				КонецЕсли;
			КонецЦикла;
			
			Если Док.Автомобили.Количество()=0 Тогда
				Возврат;
			КонецЕсли;
			
			Попытка
				Док.Записать(РежимЗаписиДокумента.Проведение);
				Сообщить("Автоматически создан документ установки фин. статуса "+Док.Ссылка);
			Исключение
				Док.ПолучитьФорму("ФормаДокумента").Открыть();
				Сообщить("Не удалось автоматически создать документ изменения фин. статуса по причине: "+ОписаниеОшибки(),СтатусСообщения.Важное);
			КонецПопытки;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьСтатусПоДоговору(Контрагент, ДоговорВзаиморасчетов);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТТ_НастройкиИзмененияСтатусаОплатыАвтомобиля.Статус
	|ИЗ
	|	Справочник.ТТ_НастройкиИзмененияСтатусаОплатыАвтомобиля КАК ТТ_НастройкиИзмененияСтатусаОплатыАвтомобиля
	|ГДЕ
	|	ТТ_НастройкиИзмененияСтатусаОплатыАвтомобиля.ДоговорВзаиморасчетов = &ДоговорВзаиморасчетов
	|	И ТТ_НастройкиИзмененияСтатусаОплатыАвтомобиля.ПометкаУдаления = ЛОЖЬ";
	
	Запрос.УстановитьПараметр("ДоговорВзаиморасчетов", ДоговорВзаиморасчетов);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Возврат ВыборкаДетальныеЗаписи.Статус;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТТ_НастройкиИзмененияСтатусаОплатыАвтомобиля.Статус
	|ИЗ
	|	Справочник.ТТ_НастройкиИзмененияСтатусаОплатыАвтомобиля КАК ТТ_НастройкиИзмененияСтатусаОплатыАвтомобиля
	|ГДЕ
	|	ТТ_НастройкиИзмененияСтатусаОплатыАвтомобиля.ПометкаУдаления = ЛОЖЬ
	|	И ТТ_НастройкиИзмененияСтатусаОплатыАвтомобиля.Контрагент = &Контрагент";
	
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Возврат ВыборкаДетальныеЗаписи.Статус;
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции

Процедура УстановкаДоговораПриЗаписиРабЛистаСтрах(Источник, Отказ) 
	
	// Вставить содержимое обработчика.
	Контрагент=Источник.Страхователь;
	Договор=Источник.ДоговорКСО;
	
	НетДоговора=Ложь;
	
	Если Договор.Организация <> Источник.Организация Тогда 
		
		Запрос = Новый Запрос;
		Запрос.Текст ="ВЫБРАТЬ
		|	ДоговорыВзаиморасчетов.Ссылка
		|ИЗ
		|	Справочник.ДоговорыВзаиморасчетов КАК ДоговорыВзаиморасчетов
		|ГДЕ
		|	ДоговорыВзаиморасчетов.Организация = &Организация
		|	И ДоговорыВзаиморасчетов.Владелец = &Контрагент
		|	И ДоговорыВзаиморасчетов.ПометкаУдаления = ЛОЖЬ" ;
		Запрос.УстановитьПараметр("Организация",Источник.Организация);
		Запрос.УстановитьПараметр("Контрагент",Контрагент);
		Результат=Запрос.Выполнить();
		Если Результат.Пустой() Тогда
			НетДоговора =	Истина;
		Иначе // Нашли договор
			Выборка = Результат.Выбрать();
			Пока Выборка.Следующий() Цикл
				ДоговорСсылка = Выборка.Ссылка;
			КонецЦикла;
			Источник.ДоговорКСО=Выборка.Ссылка;
		КонецЕсли;	
	КонецЕсли;
	
	СвойствоДДС = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Вид договора ДДС");	
	СвойствоСервис = Справочники.ЗначенияСвойств.НайтиПоНаименованию("Фин.продукт", Истина,, СвойствоДДС);
	
	
	Запрос = Новый Запрос;
	Запрос.Текст ="ВЫБРАТЬ
	|ЗначенияСвойствОбъектов.Объект,
	|ЗначенияСвойствОбъектов.Свойство,
	|ЗначенияСвойствОбъектов.Значение
	|ИЗ
	|РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|ГДЕ
	|ЗначенияСвойствОбъектов.Объект = &Объект
	|И ЗначенияСвойствОбъектов.Свойство = &Свойство
	|И ЗначенияСвойствОбъектов.Значение = &Значение";
	Запрос.УстановитьПараметр("Объект",Договор);
	Запрос.УстановитьПараметр("Свойство",СвойствоДДС);
	Запрос.УстановитьПараметр("Значение",СвойствоСервис);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		НетДоговора =	Истина;
	КонецЕсли;	
	
	Если НЕ ЗначениеЗаполнено(Источник.ДоговорКСО) ИЛИ НетДоговора Тогда  //Создадим договор
		
		Права = Неопределено;
		ВидДоговора   = Перечисления.ВидыДоговоров.Продажа;
		ТипЦенПокупки = Справочники.ТипыЦен.ПустаяСсылка();
		ТипЦенПродажи = обПраво("ОсновнойТипЦенПродажи", Права);
		ТипЦенРабот   = обПраво("ОсновнойТипЦенРабот",   Права);
		
		НовыйДоговор = Справочники.ДоговорыВзаиморасчетов.СоздатьЭлемент();
		НовыйДоговор.УстановитьНовыйКод();
		НовыйДоговор.Владелец = Контрагент.Ссылка;
		НовыйДоговор.ВидДоговора = ВидДоговора;
		НовыйДоговор.ТипЦенПокупки = ТипЦенПокупки;
		НовыйДоговор.ТипЦенПродажи = ТипЦенПродажи;
		НовыйДоговор.ВидОплаты = Перечисления.ВидыОплаты.ПроизвольнаяОплата;
		НовыйДоговор.Организация = Источник.Организация;
		НовыйДоговор.Подразделение = Источник.ПодразделениеКомпании;
		НовыйДоговор.Внутренний=Истина;
		НовыйДоговор.Наименование = "Договор КСО";
		НовыйДоговор.ТипДоговора=Перечисления.ТипыДоговоров.ВиртуальныйДоговор;
		НовыйДоговор.ВалютаВзаиморасчетов=Справочники.Валюты.НайтиПоКоду("643");
		НовыйДоговор.тт_ВидДоговора=Справочники.тт_ВидыДоговоров.НайтиПоКоду("000000013");
		НовыйДоговор.ЕдиницаИзмеренияАвтоработВПечатныхФормах= Перечисления.ЕдиницаИзмеренияАвтоработВПечатныхФормах.ЕдиницаИзмеренияЧас;
		НовыйДоговор.ДатаНачала=Источник.Дата;
		НовыйДоговор.НомерДоговора=СокрЛП(Источник.ВариантыСтрахования[0].БланкПолиса.Код);
		НовыйДоговор.Записать();
		
		Источник.ДоговорКСО = НовыйДоговор.Ссылка;	
		
		НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();  //Назначим договору свойство ДДС - Фин.продукт
		НаборЗаписей.Отбор.Объект.Установить(Источник.ДоговорКСО);
		НаборЗаписей.Отбор.Свойство.Установить(СвойствоДДС);
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.Объект = Источник.ДоговорКСО.Ссылка;
		НоваяЗапись.Свойство = СвойствоДДС;
		НоваяЗапись.Значение = СвойствоСервис;
		НаборЗаписей.Записать();
		
	КонецЕсли;	
	
КонецПроцедуры

Процедура ПроверкаДолга(Источник, Отказ, РежимПроведения)
	возврат;	
	Если Источник.СкладКомпании.тт_КатегорияСклада <> Справочники.тт_КатегорияСклада.НайтиПоКоду("000000001") ИЛИ
		ТТ_Общий.ВнутрКонтрагент(Источник.Контрагент) ИЛИ Источник.Дата < Дата(2020,2,25) Тогда
		Возврат;
	КонецЕсли;
	
	СуммаРеализации=0;
	
	Для Каждого Стр из Источник.Автомобили Цикл
		//Проверка на кредитный автомобиль
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	РабочийЛистКредитногоОтдела.Ссылка
		|ИЗ
		|	Документ.РабочийЛистКредитногоОтдела КАК РабочийЛистКредитногоОтдела
		|ГДЕ
		|	РабочийЛистКредитногоОтдела.Автомобиль = &Автомобиль
		|	И РабочийЛистКредитногоОтдела.ПометкаУдаления = ЛОЖЬ
		|	И РабочийЛистКредитногоОтдела.Проведен";
		
		Запрос.УстановитьПараметр("Автомобиль", Стр.Автомобиль);
		
		РезультатЗапроса = Запрос.Выполнить();	
		Если НЕ РезультатЗапроса.Пустой() Тогда
			Продолжить;	
		КонецЕсли;
		
		СуммаРеализации=СуммаРеализации+Стр.СуммаВсего;
		
	КонецЦикла;	
	
	Для Каждого Стр из Источник.Автомобили Цикл
		
		//Получим сумму долга по доп. оборудованию
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаказНаряд.Ссылка,
		|	СУММА(ВЫБОР
		|			КОГДА ВзаиморасчетыКомпании.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|				ТОГДА 0
		|			ИНАЧЕ ЕСТЬNULL(ВзаиморасчетыКомпании.Сумма, 0)
		|		КОНЕЦ) КАК Предоплата,
		|	МАКСИМУМ(ЗаказНаряд.СуммаДокумента) КАК СуммаДокумента
		|ИЗ
		|	Документ.ЗаказНаряд КАК ЗаказНаряд
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВзаиморасчетыКомпании КАК ВзаиморасчетыКомпании
		|		ПО ЗаказНаряд.ДоговорВзаиморасчетов = ВзаиморасчетыКомпании.ДоговорВзаиморасчетов
		|			И ЗаказНаряд.Контрагент = ВзаиморасчетыКомпании.Контрагент
		|ГДЕ
		|	ЗаказНаряд.ВидРемонта = &ВидРемонтаДоп
		|	И НЕ ЗаказНаряд.Состояние В (&СостоянияОтклонен)
		|	И ЗаказНаряд.Автомобиль = &Автомобиль
		|	И ЗаказНаряд.ПометкаУдаления = ЛОЖЬ
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗаказНаряд.Ссылка";
		
		СостоянияОтклонен=Новый СписокЗначений;
		СостоянияОтклонен.Добавить(Справочники.ВидыСостоянийЗаказНарядов.НайтиПоКоду("ЦБ00000001"));
		СостоянияОтклонен.Добавить(Справочники.ВидыСостоянийЗаказНарядов.НайтиПоКоду("ЦБ00000007"));
		
		Запрос.УстановитьПараметр("ВидРемонтаДоп", Справочники.ВидыРемонта.ДополнительноеОборудование);
		Запрос.УстановитьПараметр("СостоянияОтклонен", СостоянияОтклонен);
		Запрос.УстановитьПараметр("Автомобиль", Стр.Автомобиль);
		//Запрос.УстановитьПараметр("МоментВремени", Новый Граница(Источник.Дата, ВидГраницы.Исключая) );
		
		РезультатЗапроса = Запрос.Выполнить();	
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();	
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			Разница=ВыборкаДетальныеЗаписи.СуммаДокумента - ВыборкаДетальныеЗаписи.Предоплата;
			
			Если Разница > 0 Тогда
				Сообщить("Проведение запрещено! Необходимо произвести предоплату по: "+ВыборкаДетальныеЗаписи.Ссылка+" в размере "+Разница+" руб.");
				Отказ=Истина;
			КонецЕсли;	
			
		КонецЦикла;
		
	КонецЦикла;	
	
	
	//получим сумму предоплаты по договору
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(ВзаиморасчетыКомпанииОстатки.СуммаОстаток) КАК СуммаОстаток
	|ИЗ
	|	РегистрНакопления.ВзаиморасчетыКомпании.Остатки(
	|			&МоментВремени,
	|			Контрагент = &Контрагент
	|				И ДоговорВзаиморасчетов = &ДоговорВзаиморасчетов) КАК ВзаиморасчетыКомпанииОстатки
	|ГДЕ
	|	ВзаиморасчетыКомпанииОстатки.СуммаОстаток < 0";
	
	Запрос.УстановитьПараметр("ДоговорВзаиморасчетов", Источник.ДоговорВзаиморасчетов);
	Запрос.УстановитьПараметр("Контрагент",  Источник.Контрагент);
	Запрос.УстановитьПараметр("МоментВремени", Новый Граница(Источник.Дата, ВидГраницы.Исключая) );
	
	РезультатЗапроса = Запрос.Выполнить();
	
	СуммаПредоплатыЗаАвтомобиль=0;	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();		
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		СуммаПредоплатыЗаАвтомобиль = -1 * ?(ВыборкаДетальныеЗаписи.СуммаОстаток=Null,0,ВыборкаДетальныеЗаписи.СуммаОстаток);
	КонецЦикла;
	
	СуммаГарантии = обПолучитьЗначениеСвойства(Источник, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Гарантийное письмо"), 0);
	
	Разница=СуммаРеализации - СуммаГарантии - СуммаПредоплатыЗаАвтомобиль;
	
	Если Разница > 0 Тогда
		Сообщить("Проведение запрещено! Существует долг по предоплате в размере "+Разница+" руб. 
		|Проверьте наличие оплаты или введите сумму банковской гарантии в свойстве ""Гарантийное письмо"".");
		Отказ=Истина;
	КонецЕсли;
	
	
	
КонецПроцедуры

Процедура ДвиженияПоСтатусам(Источник, Отказ)
	
	//Возврат;
	
	Для Каждого Стр ИЗ Источник.Автомобили Цикл
		
		Отбор = Новый Структура("Автомобиль",Стр.Автомобиль);
		РС=РегистрыСведений.ТТ_ТекущиеСтатусыАвтомобилей.ПолучитьПоследнее(Новый Граница(Источник.Дата,ВидГраницы.Исключая), Отбор);
		
		Если РС.Статус.ВидСтатуса <> Перечисления.ТТ_ВидыФинСтатусовАвтомобилей.ВЗалоге И НЕ РС.ПартияЗакрыта И НЕ ТТ_Общий.ВнутрКонтрагент(Источник.Контрагент) Тогда
	
			Движение = Источник.Движения.ТТ_ТекущиеСтатусыАвтомобилей.Добавить();
			Движение.Период = Источник.Дата;
			Движение.Автомобиль = Стр.Автомобиль;
			Движение.Статус = РС.Статус;
			Движение.Организация = РС.Организация;
			Движение.Себестоимость = РС.Себестоимость;
			Движение.Партия = РС.Партия;
			Движение.ПартияЗакрыта = ИСТИНА;
			Источник.Движения.ТТ_ТекущиеСтатусыАвтомобилей.Записать(Истина);
			
		КонецЕсли;
	КонецЦикла;	
	
КонецПроцедуры

Функция ПолучитьСкидкуБезВозмещения(Организация)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТипыСкидокНаАвтомобиль.Ссылка
		|ИЗ
		|	Справочник.ТипыСкидокНаАвтомобиль КАК ТипыСкидокНаАвтомобиль
		|ГДЕ
		|	ТипыСкидокНаАвтомобиль.ПометкаУдаления = ЛОЖЬ
		|	И ТипыСкидокНаАвтомобиль.Ссылка В ИЕРАРХИИ(&Ссылка)
		|	И ТипыСкидокНаАвтомобиль.Организация = &Организация";
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Ссылка", Справочники.ТипыСкидокНаАвтомобиль.НайтиПоКоду("00698"));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Возврат ВыборкаДетальныеЗаписи.Ссылка; 
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции

Процедура ПроверкаПодразделенияТАС(Источник, Отказ)
	
	//<<Павличенко 14.08.2020 : отключено заявка Куновой
	возврат;
	//>>Павличенко 14.08.2020
	Если РольДоступна("ВосстПослед") Тогда
		Возврат;
	КонецЕсли;
	
	Если Источник.КассаКомпании=Справочники.КассыКомпании.НайтиПоКоду("ЦБ000004") И Источник.ПодразделениеКомпании <> Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000127")	Тогда
		Отказ=Истина;
		Сообщить("Для кассы «Касса Темп Авто Сервис ООО» в документе должно стоять подразделение «Сервис 160/3 ТАС»!");
	КонецЕсли;
	
	Если Источник.КассаКомпании=Справочники.КассыКомпании.НайтиПоКоду("ЦБ000007") И Источник.ПодразделениеКомпании <> Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000126")	Тогда
		Отказ=Истина;
		Сообщить("Для кассы «Касса ТАС 160/6 (ГАЗ)» в документе должно стоять подразделение «Сервис 160/6 ТАС»!");
	КонецЕсли;	
	
КонецПроцедуры

Процедура ОбработкаЗаполненияРКО(Источник, ДанныеЗаполнения, ТекстЗаполнения="", СтандартнаяОбработка=Истина)
	
	Попытка
		обОбщие.обОпределениеФРСтатьяДДС(Источник);
	Исключение
	КонецПопытки;
	
КонецПроцедуры

Процедура ПроверкаНаЛизинг(Источник, Отказ) 
	Если РольДоступна("ПолныеПрава") ИЛИ РольДоступна("ВосстПослед") Тогда
		Возврат;
	КонецЕсли;

	Лизинг = обПолучитьЗначениеСвойства(Источник.Контрагент,"Категория контрагента");
	//пробуем получить из документа
	Если ЗначениеЗаполнено(Лизинг) Тогда
		Если Лизинг.Наименование="Лизинговая компания" Тогда
			КонечныйПокупатель = обПолучитьЗначениеСвойства(Источник,"Конечный получатель");
			Если ОбЗначениеНеЗаполнено(КонечныйПокупатель) Тогда
				Сообщить("Не заполнено свойство Конечный покупатель! Заполните свойство и проведите документ заново!");
				Отказ=Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры	

//<<Павличенко 14.09.2020
Функция ПроверкаУсловийДопТАКТАС(Источник) Экспорт
	
	ОргТАС=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");
	ОргТАК=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311093925");
	
	Если Источник.Организация<>ОргТАС И Источник.Организация<>ОргТАК Тогда
		Возврат ложь;
	КонецЕсли;
	
	СписокВР=Новый СписокЗначений;
	СписокВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000017"));   //Комплектация автомобиля К
	СписокВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("00000001"));   //Дополнительное оборудование
	СписокВР.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000016"));   //Комплектация автомобиля для ОПА
	
	Если СписокВР.НайтиПоЗначению(Источник.ВидРемонта) = Неопределено Тогда
		Возврат ложь;
	КонецЕсли;
	
	СписокПодразделений=Новый СписокЗначений;
	СписокПодразделений.Добавить(Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000127"));   //Сервис 160/3
	СписокПодразделений.Добавить(Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000122"));    //Сервис ТАК
	
	Если СписокПодразделений.НайтиПоЗначению(Источник.ПодразделениеКомпании) = Неопределено Тогда
		Возврат ложь;
	КонецЕсли;
	
	
	Возврат Истина;
	
КонецФункции


Процедура ПроверкаДопТАКТАС(Источник, Отказ, РежимПроведения) 
	Если НЕ ПроверкаУсловийДопТАКТАС(Источник) тогда
		Возврат;
	КонецЕсли;	
	
	Если РольДоступна("ВосстПослед") Тогда
		Возврат;
	КонецЕСли;	
	
	РодительТАКТАС = Неопределено;
	
	ЭлементТТ = Справочники.тт_СписокПараметров.НайтиПоКоду("000013707");
	Для каждого СтрокаДанных из ЭлементТТ.СписокПараметров цикл
		РодительТАКТАС = СтрокаДанных.ЗначениеПараметра;
	КонецЦикла;
	
	Если ТИПЗНЧ(РодительТАКТАС) = Тип("СправочникСсылка.Автоработы")  тогда
		Если РодительТАКТАС.ЭтоГруппа тогда
			СообщатьПримечание = Ложь;
			Для каждого АвтоработаСтрока из Источник.Работы цикл
				Если АвтоработаСтрока.Работа.Родитель <> РодительТАКТАС тогда
					СообщатьПримечание = Истина;
					Сообщить("Запись прервана! Авторабота '"+АвтоработаСтрока.Работа+"' не в папке '" + РодительТАКТАС + "'");
					Отказ=Истина;
				КонецЕсли;
			КонецЦикла;
			Если СообщатьПримечание тогда 
				Сообщить("Все работы по ТАК и ТАС (с видами ремонта: 'Доп. оборудование', 'Комплектация автомобиля К', 'Комплектация автомобиля для ОПА') должны быть из папки " + РодительТАКТАС);
			КонецЕсли;	
			
		Иначе
			сообщить("Настройка запрета проведения заказ-нарядов с работами не из определенной папки не закончена!");
			Отказ = Истина;
		КонецЕсли;
	Иначе
		сообщить("Настройка запрета проведения заказ-нарядов с работами не из определенной папки не закончена!");
		Отказ = Истина;
	КонецЕсли;
КонецПроцедуры

//<<Павличенко 21.09.2020
//параметрДействия= 1, если проводить/перезаписывать, 2 - если отменять проведение
Процедура Создать_Записать_Взаимозачет(Источник,ПараметрДействия)
	//Если РольДоступна("ВосстПослед") Тогда   //БизТех 14.10.23г. Убрать потом!
	//	Возврат;
	//КонецЕсли;	
	Если ПараметрДействия = 1 тогда 
		ТТ_Общий.ОбработатьДокументХолдинга(Источник, "ВзаимоЗачетСоСтраховой");
	ИначеЕсли ПараметрДействия = 2 тогда
		ТТ_Общий.ОтменитьДокументХолдинга(Источник, "ВзаимоЗачетСоСтраховой");
	КонецЕсли;	
КонецПроцедуры
//>>Павличенко 21.09.2020

