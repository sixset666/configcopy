
Процедура АвтоматическаяОтправкаСМС(СтруктураПараметров) Экспорт//
	//Если ПолучитьПредставлениеИнформационнойБазы() <> "alfa5" Тогда 
	//	Возврат;
	//КонецЕсли;
	//
	Выборка = Справочники.ВидыАвтоматическихРассылокСМС.Выбрать();
	
	Интервал = 600;
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Использовать Тогда
			Обр = Обработки.АвтоматическаяРассылкаСМС.Создать();
			
			Если Выборка.Ссылка = Справочники.ВидыАвтоматическихРассылокСМС.ОповещениеОЗавтрашнемТО Тогда
				Марки = Новый СписокЗначений;
				Марки.Добавить(Справочники.Модели.НайтиПоНаименованию("ВАЗ"));
				Марки.Добавить(Справочники.Модели.НайтиПоНаименованию("UAZ"));
				Марки.Добавить(Справочники.Модели.НайтиПоНаименованию("SSANG YONG"));
				Марки.Добавить(Справочники.Модели.НайтиПоНаименованию("LADA")); 
				Марки.Добавить(Справочники.Модели.НайтиПоНаименованию("Foton"));
				Получ = обр.ВыбратьТОнаЗавтра(ТекущаяДата(), Марки);
			ИначеЕсли Выборка.Ссылка =  Справочники.ВидыАвтоматическихРассылокСМС.НайтиПоНаименованию("Оповещение о завтрашнем ТО (Фиат)") Тогда
				Марки = Новый СписокЗначений;
				Марки.Добавить(Справочники.Модели.НайтиПоНаименованию("FIAT"));
				Получ = обр.ВыбратьТОнаЗавтра(ТекущаяДата(), Марки);	
			ИначеЕсли Выборка.Ссылка =  Справочники.ВидыАвтоматическихРассылокСМС.НайтиПоНаименованию("Поздравление с Днем рождения") Тогда
				Получ = обр.ВыбратьДниРождения(ТекущаяДата());	
			Иначе
				Продолжить;
			КонецЕсли;
			
			//НоваяСтрока = Получ.Добавить();
			//НоваяСтрока.Контрагент = "Чувин Михаил Сергеевич";
			//НоваяСтрока.КонтактныйТелефон = "89034549495";
			//НоваяСтрока = Получ.Добавить();
			//НоваяСтрока.Контрагент = "Максимов Антон Сергеевич";
			//НоваяСтрока.КонтактныйТелефон = "89094508022";			
			
			Обр.СформироватьРассылку(Получ, Выборка.ТекстСообщения, Выборка.Тема, Интервал);			
			Интервал = Интервал + 600;
			
		КонецЕсли;
	КонецЦикла;

КонецПроцедуры

Процедура ВыгрузкаИзСКД(СтруктураПараметров) Экспорт//
	//Если ПолучитьПредставлениеИнформационнойБазы() <> "alfa5" Тогда 
	//	Возврат;
	//КонецЕсли;
		
	ДатаНачала = ТекущаяДата();
	ДатаОкончания = ТекущаяДата(); 	
	
	Обр = Обработки.ВыгрузкаИзСКД.Создать();
	Обр.Выгрузить(ДатаНачала,ДатаОкончания);

КонецПроцедуры

Процедура ТТ_УстановкаНеликвида(СтруктураПараметров) Экспорт //
	//Если ПолучитьПредставлениеИнформационнойБазы() <> "alfa5" Тогда 
	//	Возврат;
	//КонецЕсли;

	
	ТекДата = ТекущаяДата();
	УстановитьНеликвид75Проц(ТекДата, 180, 2);
	УстановитьНеликвид0Проц(ТекДата, 90, 1);
	СделатьТоварЛиквидным(ТекДата, 90, 1);
	СделатьТоварЛиквиднымНетНаОстатках(ТекДата);
	
	//<< Бизтех_20220412  убираем  этот код, не нужен для определения неликвидности товара

	////Применяемость Номенклатуры
	//Запрос=новый Запрос;
	//Запрос.Текст="
	//|ВЫБРАТЬ
	//|	ЗаказНарядТовары.Номенклатура КАК Номенклатура,
	//|	ЗаказНарядТовары.Ссылка.Автомобиль.Модель
	//|ИЗ
	//|	Документ.ЗаказНаряд.Товары КАК ЗаказНарядТовары
	//|
	//|СГРУППИРОВАТЬ ПО
	//|	ЗаказНарядТовары.Номенклатура,
	//|	ЗаказНарядТовары.Ссылка.Автомобиль.Модель
	//|
	//|УПОРЯДОЧИТЬ ПО
	//|	Номенклатура
	//|";
	//Результат = Запрос.Выполнить();
	//РезультатТаблица = Результат.Выгрузить();
	////ТекПозиция = 0;	
	//Для каждого СтрокаЗапроса из РезультатТаблица Цикл
	//	//ОбработкаПрерыванияПользователя();
	//	//ТекПозиция = ТекПозиция + 1;
	//	//Состояние("Выполнено " + Окр(ТекПозиция / РезультатТаблица.Количество() * 100) + "%");
	//	
	//	Запрос2=новый Запрос;
	//	Запрос2.Текст="
	//	|ВЫБРАТЬ
	//	|	НоменклатураПрименяемость.Номенклатура,
	//	|	НоменклатураПрименяемость.Модель
	//	|ИЗ
	//	|	РегистрСведений.НоменклатураПрименяемость КАК НоменклатураПрименяемость
	//	|ГДЕ
	//	|	НоменклатураПрименяемость.Номенклатура = &Номенклатура
	//	|	И НоменклатураПрименяемость.Модель = &Модель
	//	|";
	//	Запрос2.УстановитьПараметр("Модель",СтрокаЗапроса.АвтомобильМодель);
	//	Запрос2.УстановитьПараметр("Номенклатура",СтрокаЗапроса.Номенклатура);
	//	Результат = Запрос2.Выполнить().Выбрать();
	//	Если Результат.Количество()=0 Тогда
	//		
	//		НаборЗаписей = РегистрыСведений.НоменклатураПрименяемость.СоздатьНаборЗаписей();
	//		
	//		НаборЗаписей.Отбор.Номенклатура.Установить(СтрокаЗапроса.Номенклатура);
	//		НаборЗаписей.Отбор.Модель.Установить(СтрокаЗапроса.АвтомобильМодель);
	//		
	//		НоваяЗапись = НаборЗаписей.Добавить();
	//		
	//		НоваяЗапись.Номенклатура = СтрокаЗапроса.Номенклатура;
	//		НоваяЗапись.Модель = СтрокаЗапроса.АвтомобильМодель;
	//		попытка
	//			НаборЗаписей.Записать();
	//		исключение
	//		конецпопытки;
	//		////Сообщить("Записана номенклатура "+СтрокаЗапроса.Номенклатура);	
	//	КонецЕсли;
	//	
	//КонецЦикла;	
	//>> Бизтех_20220412    
	
КонецПроцедуры

Процедура УстановитьНеликвид75Проц(Период, КолВоДней, ЗначениеНеликвид) Экспорт
	СвойствоНеликвид = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("02047");
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура КАК Номенклатура,
	|	СУММА(ОстаткиТоваровКомпанииОстаткиИОбороты.КоличествоНачальныйОстаток) КАК КоличествоНачальныйОстаток,
	|	СУММА(ЕСТЬNULL(ПродажиОбороты.КоличествоОборот, 0)) КАК Продано,
	|	СУММА(ОстаткиТоваровКомпанииОстаткиИОбороты.КоличествоКонечныйОстаток) КАК КоличествоКонечныйОстаток,
	|	ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании.Подразделение
	|ПОМЕСТИТЬ Рез
	|ИЗ
	|	РегистрНакопления.ОстаткиТоваровКомпании.ОстаткиИОбороты(&Дата90, &Период, Период, , ) КАК ОстаткиТоваровКомпанииОстаткиИОбороты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ПО ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура = ЗначенияСвойствОбъектов.Объект
	|			И (ЗначенияСвойствОбъектов.Свойство = &Свойство)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Продажи.Обороты(&Дата90, &Период, Период, ) КАК ПродажиОбороты
	|		ПО ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура = ПродажиОбороты.Номенклатура
	|ГДЕ
	|	(ЕСТЬNULL(ЗначенияСвойствОбъектов.Значение, 0) = 0
	|			ИЛИ ЕСТЬNULL(ЗначенияСвойствОбъектов.Значение, 0) = 1)
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура,
	|	ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании.Подразделение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Рез.Номенклатура,
	|	Рез.КоличествоНачальныйОстаток,
	|	Рез.Продано,
	|	Рез.КоличествоКонечныйОстаток,
	|	Рез.СкладКомпанииПодразделение КАК Подразделение
	|ИЗ
	|	Рез КАК Рез
	|ГДЕ
	|	Рез.КоличествоКонечныйОстаток > 0
	|	И Рез.КоличествоНачальныйОстаток > 0
	|	И Рез.Продано = 0";
	
	Запрос.УстановитьПараметр("Дата90", НачалоДня(Период-60*60*24*КолВоДней));	
	Запрос.УстановитьПараметр("Период", КонецДня(Период));
	Запрос.УстановитьПараметр("Свойство", СвойствоНеликвид);
	
	ТЗ = Запрос.Выполнить().Выгрузить();
	ТЗБезСклада = ТЗ.Скопировать();
	ТЗБезСклада.Свернуть("Номенклатура", "КоличествоКонечныйОстаток, Продано");
	
	Номер = 1;
	Для Каждого Стр Из ТЗ Цикл
		
		Номер = Номер + 1;
		Склад = Справочники.СкладыКомпании.ПустаяСсылка();
		
		ДобавитьЗаписьВРегСвНеликвидПоДатам(Период, Стр.Номенклатура, стр.Подразделение, 2,склад);	
		
	КонецЦикла;
	Номер = 1;
	Для каждого СтрБез из ТЗБезСклада  цикл
		//Номер = 1;
		Номер = Номер + 1;
		
		ДобавитьЗаписьВРегСвЗначенияСвойствОбъектов(СтрБез.Номенклатура, СвойствоНеликвид, ЗначениеНеликвид);
	конеццикла;
КонецПроцедуры
	
Процедура УстановитьНеликвид0Проц(Период, КолВоДней, ЗначениеНеликвид) Экспорт
	СвойствоНеликвид = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("02047");
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	МИНИМУМ(ОстаткиТоваровКомпанииОстаткиИОбороты.Период) КАК Период,
		|	СУММА(ОстаткиТоваровКомпанииОстаткиИОбороты.КоличествоНачальныйОстаток) КАК КоличествоНачальныйОстаток,
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура,
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании
		|ПОМЕСТИТЬ ПервоеПоступл
		|ИЗ
		|	РегистрНакопления.ОстаткиТоваровКомпании.ОстаткиИОбороты(, &Период, Запись, , ) КАК ОстаткиТоваровКомпанииОстаткиИОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура,
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура КАК Номенклатура,
		|	СУММА(ЕСТЬNULL(ПродажиОбороты.КоличествоОборот, 0)) КАК Продано,
		|	СУММА(ОстаткиТоваровКомпанииОстаткиИОбороты.КоличествоКонечныйОстаток) КАК Остаток,
		|	МАКСИМУМ(ЕСТЬNULL(РАЗНОСТЬДАТ(ПервоеПоступл.Период, &Период, МЕСЯЦ), 1)) КАК МесяцевВПрайсе,
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании
		|ПОМЕСТИТЬ Рез
		|ИЗ
		|	РегистрНакопления.ОстаткиТоваровКомпании.ОстаткиИОбороты(, &Период, Период, , ) КАК ОстаткиТоваровКомпанииОстаткиИОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|		ПО ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура = ЗначенияСвойствОбъектов.Объект
		|			И (ЗначенияСвойствОбъектов.Свойство = &Свойство)
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Продажи.Обороты(, &Период, Период, ) КАК ПродажиОбороты
		|		ПО ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура = ПродажиОбороты.Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПервоеПоступл КАК ПервоеПоступл
		|		ПО ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании = ПервоеПоступл.СкладКомпании
		|			И ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура = ПервоеПоступл.Номенклатура
		|ГДЕ
		|	ЕСТЬNULL(ЗначенияСвойствОбъектов.Значение, 0) = 0
		|
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура,
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Рез.Номенклатура,
		|	Рез.Продано,
		|	Рез.Остаток,
		|	Рез.МесяцевВПрайсе,
		|	Рез.Продано / ВЫБОР
		|		КОГДА Рез.МесяцевВПрайсе = 0
		|			ТОГДА 1
		|		ИНАЧЕ Рез.МесяцевВПрайсе
		|	КОНЕЦ КАК СреднееКолвоПродажЗаМесяц,
		|	Рез.СкладКомпании.Подразделение КАК СкладКомпании
		|ИЗ
		|	Рез КАК Рез
		|ГДЕ
		|	Рез.Остаток > Рез.Продано / ВЫБОР
		|			КОГДА Рез.МесяцевВПрайсе = 0
		|				ТОГДА 1
		|			ИНАЧЕ Рез.МесяцевВПрайсе
		|		КОНЕЦ
		|	И Рез.Продано > 0";

	//Запрос.УстановитьПараметр("Дата90", НачалоДня(Период-60*60*24*КолВоДней));	
	Запрос.УстановитьПараметр("Период", КонецДня(Период));
	Запрос.УстановитьПараметр("Свойство", СвойствоНеликвид);

	ТЗ = Запрос.Выполнить().Выгрузить();
	
	ТЗБезСклада = ТЗ.Скопировать();
	ТЗБезСклада.Свернуть("Номенклатура", "Остаток, Продано, МесяцевВПрайсе, СреднееКолвоПродажЗаМесяц");
	//
	Номер = 1;
	Для Каждого Стр Из ТЗ Цикл
		Номер = Номер + 1;
		Склад = Справочники.СкладыКомпании.ПустаяСсылка();
		ДобавитьЗаписьВРегСвНеликвидПоДатам(Период, Стр.Номенклатура, стр.СкладКомпании, 1,склад);	
	КонецЦикла;
	 Номер = 1;

	 Для каждого стрБез из ТЗБезСклада цикл
		 Номер = Номер + 1;
	ДобавитьЗаписьВРегСвЗначенияСвойствОбъектов(стрБез.Номенклатура, СвойствоНеликвид, ЗначениеНеликвид);
    конецЦикла;
КонецПроцедуры

Процедура ДобавитьЗаписьВРегСвНеликвидПоДатам(Период, Номенклатура, Подразделение, Статус,склад)
		НаборЗаписей = РегистрыСведений.НеликвидПоДатам.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Номенклатура.Установить(Номенклатура); 
		НаборЗаписей.Отбор.Склад.Установить(Склад);
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.Период = Период; 
		НоваяЗапись.Номенклатура = Номенклатура; 
		НоваяЗапись.Склад = Склад;
		НоваяЗапись.Подразделение = Подразделение;
		НоваяЗапись.Статус = Статус;
		попытка
			НаборЗаписей.Записать();					
		исключение
		конецпопытки;
	КонецПроцедуры	
	
Процедура ДобавитьЗаписьВРегСвЗначенияСвойствОбъектов(Объект, Свойство, Значение)
		НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(Объект); 
		НаборЗаписей.Отбор.Свойство.Установить(Свойство);
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.Объект = Объект; 
		НоваяЗапись.Свойство = Свойство; 
		НоваяЗапись.Значение = Значение; 
		попытка
			НаборЗаписей.Записать();			
		исключение
		конецпопытки;
	КонецПроцедуры	
	
Процедура СделатьТоварЛиквидным(Период, КолВоДней, ЗначениеНеликвид) Экспорт
	СвойствоНеликвид = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("02047");
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	МИНИМУМ(ОстаткиТоваровКомпанииОстаткиИОбороты.Период) КАК Период,
		|	СУММА(ОстаткиТоваровКомпанииОстаткиИОбороты.КоличествоНачальныйОстаток) КАК КоличествоНачальныйОстаток,
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура,
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании
		|ПОМЕСТИТЬ ПервоеПоступл
		|ИЗ
		|	РегистрНакопления.ОстаткиТоваровКомпании.ОстаткиИОбороты(, &Период, Запись, , ) КАК ОстаткиТоваровКомпанииОстаткиИОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура,
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура КАК Номенклатура,
		|	СУММА(ЕСТЬNULL(ПродажиОбороты.КоличествоОборот, 0)) КАК Продано,
		|	СУММА(ОстаткиТоваровКомпанииОстаткиИОбороты.КоличествоКонечныйОстаток) КАК Остаток,
		|	МАКСИМУМ(ЕСТЬNULL(РАЗНОСТЬДАТ(ПервоеПоступл.Период, &Период, МЕСЯЦ), 1)) КАК МесяцевВПрайсе,
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании
		|ПОМЕСТИТЬ Рез
		|ИЗ
		|	РегистрНакопления.ОстаткиТоваровКомпании.ОстаткиИОбороты(, &Период, Период, , ) КАК ОстаткиТоваровКомпанииОстаткиИОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|		ПО ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура = ЗначенияСвойствОбъектов.Объект
		|			И (ЗначенияСвойствОбъектов.Свойство = &Свойство)
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Продажи.Обороты(, &Период, Период, ) КАК ПродажиОбороты
		|		ПО ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура = ПродажиОбороты.Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПервоеПоступл КАК ПервоеПоступл
		|		ПО ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании = ПервоеПоступл.СкладКомпании
		|			И ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура = ПервоеПоступл.Номенклатура
		|ГДЕ
		|	ЕСТЬNULL(ЗначенияСвойствОбъектов.Значение, 0) = 1
		|
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.Номенклатура,
		|	ОстаткиТоваровКомпанииОстаткиИОбороты.СкладКомпании
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Рез.Номенклатура,
		|	Рез.Продано,
		|	Рез.Остаток,
		|	Рез.МесяцевВПрайсе,
		|	Рез.Продано / ВЫБОР
		|		КОГДА Рез.МесяцевВПрайсе = 0
		|			ТОГДА 1
		|		ИНАЧЕ Рез.МесяцевВПрайсе
		|	КОНЕЦ КАК СреднееКолвоПродажЗаМесяц,
		|	Рез.СкладКомпании.Подразделение КАК СкладКомпании
		|ИЗ
		|	Рез КАК Рез
		|ГДЕ
		|	(Рез.Остаток < Рез.Продано / ВЫБОР
		|				КОГДА Рез.МесяцевВПрайсе = 0
		|					ТОГДА 1
		|				ИНАЧЕ Рез.МесяцевВПрайсе
		|			КОНЕЦ
		|			ИЛИ Рез.Продано = 0)";

	Запрос.УстановитьПараметр("Дата90", НачалоДня(Период-60*60*24*КолВоДней));	
	Запрос.УстановитьПараметр("Период", КонецДня(Период));
	Запрос.УстановитьПараметр("Свойство", СвойствоНеликвид);

	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл 
		УдалитьИзРегСвНеликвидПоДатам(Выборка.Номенклатура);
		УдалитьИзРегСвЗначенияСвойствОбъектов(Выборка.Номенклатура, СвойствоНеликвид);
	КонецЦикла;	
КонецПроцедуры	

Процедура УдалитьИзРегСвНеликвидПоДатам(Номенклатура)
	НаборЗаписей = РегистрыСведений.НеликвидПоДатам.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Номенклатура.Установить(Номенклатура);
	НаборЗаписей.Записать();
КонецПроцедуры	

Процедура УдалитьИзРегСвЗначенияСвойствОбъектов(Номенклатура, Свойство)
	НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Свойство.Установить(Свойство);
	НаборЗаписей.Отбор.Объект.Установить(Номенклатура);
	НаборЗаписей.Записать();	
КонецПроцедуры

Процедура СделатьТоварЛиквиднымНетНаОстатках(ТекДата)
	
	СвойствоНеликвид = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("02047");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Номенклатура
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|		ПО Номенклатура.Ссылка = ЗначенияСвойствОбъектов.Объект
		|			И (ЗначенияСвойствОбъектов.Свойство = &Свойство)
		|			И (ЗначенияСвойствОбъектов.Значение = 2
		|				ИЛИ ЗначенияСвойствОбъектов.Значение = 1)
		|ГДЕ
		|	НЕ Номенклатура.Ссылка В
		|				(ВЫБРАТЬ
		|					ОстаткиТоваровКомпанииОстатки.Номенклатура
		|				ИЗ
		|					РегистрНакопления.ОстаткиТоваровКомпании.Остатки(&ТекДата, ) КАК ОстаткиТоваровКомпанииОстатки
		|				ГДЕ
		|					ОстаткиТоваровКомпанииОстатки.КоличествоОстаток > 0)";

	Запрос.УстановитьПараметр("Свойство", СвойствоНеликвид);
	Запрос.УстановитьПараметр("ТекДата", ТекущаяДата());
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Запись = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьМенеджерЗаписи();	
		Запись.Объект = Выборка.Номенклатура;
		Запись.Свойство = СвойствоНеликвид;
		Запись.Прочитать();
		Запись.Значение = 0;
		попытка
			Запись.Записать();
		исключение
		конецпопытки;
	КонецЦикла;	
КонецПроцедуры

Процедура ТТ_СофтФонРегЗвонков(СтруктураПараметров) Экспорт//
	//Если ПолучитьПредставлениеИнформационнойБазы() <> "alfa5" Тогда 
	//	Возврат;
	//КонецЕсли;
	
	Обр = Обработки.АвтоРегистрацияЗвонковСофтФон.Создать();
	Обр.ВыполнитьАвтоРегЗвонков();
		
КонецПроцедуры

Процедура ТТ_ОтправкаОтчетовПоПочте(СтруктураПараметров) Экспорт//
	
	Обр = Обработки.ОтправкаПочты.Создать();
	Обр.СформироватьОтправитьОтчетПоНеликвидам();
    Обр.СформироватьОтправитьОтчетПоНеликвидамАвто();
	
КонецПроцедуры

Процедура ТТ_ЗагрузкаЗаявокWWW(СтруктураПараметров) Экспорт//
	//Если ПолучитьПредставлениеИнформационнойБазы() <> "alfa5" Тогда 
	//	Возврат;
	//КонецЕсли;
	
	ПолучитьПочту();
КонецПроцедуры

Функция ПолучитьПрофиль()
	
	Профиль = Новый ИнтернетПочтовыйПрофиль;	
	// SMTP сервер
	Профиль.АдресСервераSMTP = "mail.tempauto.net";	
	// Порт SMTP сервера
	Профиль.ПортSMTP = 25;	
	// POP3 сервер
	Профиль.АдресСервераPOP3 = "mail.tempauto.net";	
	// Порт POP3 сервера
	Профиль.ПортPOP3 = 110;	
	// Пароль к почтовому ящику
	Профиль.Пароль = "Jj333878";	
	// Пароль пользователя для SMTP сервера
	Профиль.ПарольSMTP = "Jj333878";	
	// Логин пользователя
	Профиль.Пользователь = "robot1c@tempauto.net";	
	// Логин пользователя для SMTP сервера
	Профиль.ПользовательSMTP = "robot1c@tempauto.net";	
	// Время ожидания выполнения операции в секундах	
	Профиль.ВремяОжидания = 50; 
	Возврат Профиль;
	
КонецФункции

Процедура ПолучитьПочту() Экспорт
	Почта = Новый ИнтернетПочта;
	
	Попытка
		Почта.Подключиться(ПолучитьПрофиль());
	Исключение
		//Сообщить(ОписаниеОшибки()); 
		Возврат;
	КонецПопытки;
	
	Заголовки=Почта.ПолучитьЗаголовки();
	Если Заголовки.Количество()=0 Тогда
		//Предупреждение("В почтовом ящике нет входящих сообщений!", ,"Нет сообщений");
	КонецЕсли;
	
	// Загрузка сообщений в массив
	Сообщения = Почта.Выбрать(Ложь,Заголовки);
	
	Для каждого Сообщение Из Сообщения Цикл
		Дата = Сообщение.ДатаОтправления;
		Если Дата - НачалоДня(Дата) > 20*60*60 Тогда
			Дата = Дата+6*60*60; 
		КонецЕсли;
		//Сообщить("Дата: "+ Сообщение.ДатаОтправления);
		//Сообщить("От Кого: "+ Сообщение.Отправитель.Пользователь + " <" + Сообщение.Отправитель.Адрес + "> ");
		//Сообщить("Тема: "+ Сообщение.Тема);
		ТекстВходящие=""; 
		Текст = Сообщение.Тексты[0].Текст;
		//Сообщить("ТЕКСТ: "+ Текст);
		
		СтруктураПолей = ПолучитьПоляИзТекста(Сообщение.Тема, Текст, Дата);
		
		ДобавитьЗапись(СтруктураПолей);
		
	КонецЦикла; 
	
	Почта.Отключиться();
КонецПроцедуры

Функция  ПолучитьПоляИзТекста(Тема,Текст,Дата)
	
	СтруктураПолей = Новый структура;	
	СтруктураПолей.Вставить("КатегорияАвто", "");
	СтруктураПолей.Вставить("Модель", "");	
	СтруктураПолей.Вставить("Стоимость", "");
	СтруктураПолей.Вставить("ПервВзнос", "");	
	СтруктураПолей.Вставить("Срок", "");
	СтруктураПолей.Вставить("ПроцСтавка", "");	
	СтруктураПолей.Вставить("Клиент", "");
	СтруктураПолей.Вставить("Телефон", "");
	СтруктураПолей.Вставить("ЭлПочта", "");
	СтруктураПолей.Вставить("Город", "");
	СтруктураПолей.Вставить("ДопИнф", "");
	
	//Разделительстрок=Символ(13)+Символ(10);
	Разделительстрок="<";
	Стр = Текст;	
	
	Если Найти(Тема, "Заявка 2" ) Тогда //Заявка на финансовые услуги
		СтруктураПолей.ДопИнф="";
		НомерЗначения = 1;
		Пока НЕ ПустаяСтрока(Стр) Цикл
			НомерВхождения = Найти(Стр, ";");
			Если НомерВхождения = 0 Тогда
				Значение	= Стр;
				Стр		= "";
			Иначе	
				Значение	= СокрЛП(Лев(Стр, НомерВхождения - 1));
				Стр		= Сред(Стр, НомерВхождения + 1);
			КонецЕсли;
			Если НомерЗначения = 1 Тогда
				СтруктураПолей.ДопИнф = Значение;
			ИначеЕсли НомерЗначения = 2 Тогда
				СтруктураПолей.Клиент = Значение;
			ИначеЕсли НомерЗначения = 3 Тогда
				СтруктураПолей.Телефон = Значение;
			ИначеЕсли НомерЗначения = 4 Тогда
				СтруктураПолей.ЭлПочта = Значение;
			ИначеЕсли НомерЗначения = 5 Тогда
				СтруктураПолей.ДопИнф =СтруктураПолей.ДопИнф +". "+ Значение;
			КонецЕсли;			
			НомерЗначения = НомерЗначения + 1;
		КонецЦикла;		
	ИначеЕсли Найти(Тема, "Заявка 3") Тогда //Заявка на финансовые услуги
		СтруктураПолей.ДопИнф="";
		НомерЗначения = 1;
		Пока НЕ ПустаяСтрока(Стр) Цикл
			НомерВхождения = Найти(Стр, ";");
			Если НомерВхождения = 0 Тогда
				Значение	= Стр;
				Стр		= "";
			Иначе	
				Значение	= СокрЛП(Лев(Стр, НомерВхождения - 1));
				Стр		= Сред(Стр, НомерВхождения + 1);
			КонецЕсли;
			Если НомерЗначения = 1 Тогда
				СтруктураПолей.ДопИнф = Значение;
			ИначеЕсли НомерЗначения = 2 Тогда
				СтруктураПолей.Клиент = Значение;
			ИначеЕсли НомерЗначения = 3 Тогда
				СтруктураПолей.Телефон = Значение;
			ИначеЕсли НомерЗначения = 4 Тогда
				СтруктураПолей.ДопИнф =СтруктураПолей.ДопИнф +". "+ Значение;
			КонецЕсли;		
			НомерЗначения = НомерЗначения + 1;
		КонецЦикла;
	ИначеЕсли Найти(Тема, "Заявка") Тогда //Заявка на финансовые услуги
		
		НомерЗначения = 1;
		Пока НЕ ПустаяСтрока(Стр) Цикл
			НомерВхождения = Найти(Стр, ";");
			Если НомерВхождения = 0 Тогда
				Значение	= Стр;
				Стр		= "";
			Иначе	
				Значение	= СокрЛП(Лев(Стр, НомерВхождения - 1));
				Стр		= Сред(Стр, НомерВхождения + 1);
			КонецЕсли;
			Если НомерЗначения = 1 Тогда
				СтруктураПолей.КатегорияАвто = Значение;
			ИначеЕсли НомерЗначения = 2 Тогда
				СтруктураПолей.Модель = Значение;
			ИначеЕсли НомерЗначения = 3 Тогда
				СтруктураПолей.Стоимость = Значение;
			ИначеЕсли НомерЗначения = 4 Тогда
				СтруктураПолей.ПервВзнос = Значение;
			ИначеЕсли НомерЗначения = 5 Тогда
				СтруктураПолей.Срок = Значение;
			ИначеЕсли НомерЗначения = 6 Тогда
				СтруктураПолей.ПроцСтавка = Значение;
			ИначеЕсли НомерЗначения = 7 Тогда
				СтруктураПолей.Клиент = Значение;
			ИначеЕсли НомерЗначения = 8 Тогда
				Телефон = кмОчиститьТелефонОтРазделителей(Значение);
				СтруктураПолей.Телефон = Телефон;
			ИначеЕсли НомерЗначения = 9 Тогда
				СтруктураПолей.ЭлПочта = Значение;
			ИначеЕсли НомерЗначения = 10 Тогда
				СтруктураПолей.Город = Значение;
			ИначеЕсли НомерЗначения = 11 Тогда
				СтруктураПолей.ДопИнф = Значение;
			КонецЕсли;			
			НомерЗначения = НомерЗначения + 1;
		КонецЦикла;
		
	Иначе    //с Livetex или другое
		Стр= СтрЗаменить(Стр, "<br />", ";. ");
		НомерЗначения = 1;
		Пока НЕ ПустаяСтрока(Стр) Цикл
			НомерВхождения = Найти(Стр, ";");
			Если НомерВхождения = 0 Тогда
				Значение	= Стр;
				Стр		= "";
			Иначе	
				Значение	= СокрЛП(Лев(Стр, НомерВхождения - 1));
				Стр		= Сред(Стр, НомерВхождения + 1);
			КонецЕсли;
			Если НомерЗначения = 1 Тогда
				СтруктураПолей.ДопИнф = СтруктураПолей.ДопИнф + Значение;
			ИначеЕсли НомерЗначения = 2 Тогда   
				СтруктураПолей.ДопИнф = СтруктураПолей.ДопИнф + Значение;
			ИначеЕсли НомерЗначения = 3 Тогда
				СтруктураПолей.ДопИнф = СтруктураПолей.ДопИнф + Значение;;
			ИначеЕсли НомерЗначения = 8 Тогда
				СтруктураПолей.ДопИнф = СтруктураПолей.ДопИнф + Значение;
			ИначеЕсли НомерЗначения = 9 Тогда
				СтруктураПолей.ДопИнф = СтруктураПолей.ДопИнф + Значение;
			КонецЕсли;			
			НомерЗначения = НомерЗначения + 1;
		КонецЦикла;
		
	КонецЕсли;
	
	СтруктураПолей.Вставить("Тема",Тема);
	СтруктураПолей.Вставить("Дата",Дата);
	Возврат СтруктураПолей;
КонецФункции

Процедура ДобавитьЗапись(СтруктураПолей)//
	
		НаборЗаписей = РегистрыСведений.РегистрацияЗвонковИКонтактов.СоздатьНаборЗаписей();
		
		НаборЗаписей.Отбор.ДатаВремя.Установить(СтруктураПолей.Дата);
		НаборЗаписей.Отбор.ДатаДень.Установить(СтруктураПолей.Дата);
		
		НаборЗаписей.Прочитать();		
		
		Если НаборЗаписей.Количество() > 0 Тогда
			//Для каждого Запись из НаборЗаписей Цикл
			//	Если Запись.ВидКонтакта = Перечисления.ВидыСобытий.Прочее Тогда
					Возврат;            //значит уже есть.
			//	КонецЕсли;
			//КонецЦикла;
		КонецЕсли;	
			
		//ДанныеОКлиенте = ПолучитьДанныеОКлиенте(СтруктураПолей.Телефон, СтруктураПолей.Дата);
		Клиент = СтруктураПолей.Клиент;
		Сотрудник = Справочники.Сотрудники.НайтиПоКоду("ЦБ004485");  // АТС
		
		Если Клиент = "" Тогда 
			Клиент = "Неопределено";
		КонецЕсли;
		Если СтруктураПолей.Модель <> "" Тогда 
			Модель = Справочники.Модели.НайтиПоНаименованию(СокрЛП(СтруктураПолей.Модель));
		КонецЕсли;
		
		Брэнд = ВернутьБренд(СтруктураПолей.Тема);
		Автор = Справочники.Пользователи.НайтиПоНаименованию("АТС");
		Организация = Справочники.Организации.НайтиПоКоду("00001");
		Подразделение = Справочники.ПодразделенияКомпании.НайтиПоКоду("00001");
		
		Если Найти(СтруктураПолей.Тема, "Заявка 2" ) Тогда //Заявка на финансовые услуги
			НоваяЗапись = НаборЗаписей.Добавить();
			НоваяЗапись.Автор = Автор;  
			НоваяЗапись.ДатаДень = СтруктураПолей.Дата;
			НоваяЗапись.ДатаВремя = СтруктураПолей.Дата;
			НоваяЗапись.ПредставлениеТелефона = СтруктураПолей.Телефон;  
			НоваяЗапись.Сотрудник = Сотрудник;
			НоваяЗапись.Клиент = Клиент;
			НоваяЗапись.ВидКонтакта = Перечисления.ВидыСобытий.Прочее ;
			НоваяЗапись.Организация = Организация;
			НоваяЗапись.Реклама =  Справочники.ИсточникиИнформации.НайтиПоКоду("ЦБ000004"); //  Интернет
			НоваяЗапись.Подразделение = Подразделение;
			Содержание = Лев("Марка: "+ СокрЛП(СтруктураПолей.Модель)+"; Клиент: "+СокрЛП(СтруктураПолей.Клиент)+"; Телефон: "+СокрЛП(СтруктураПолей.Телефон)+"; Эл.Почта: "+СокрЛП(СтруктураПолей.ЭлПочта)+
			"; Доп. инф.: "+Лев(СокрЛП(СтруктураПолей.ДопИнф),250) ,499) ;
			НоваяЗапись.Комментарий = Содержание;
			НоваяЗапись.Примечание =  Содержание;
			//НоваяЗапись.ВторичныйКонтакт = ДанныеОКлиенте.ВторичныйКонтакт;
			НоваяЗапись.ПредметОбращения = Справочники.ПредметыОбращения.НайтиПоКоду("00000001"); // По умолчанию Автосалон
			Если Брэнд <> Неопределено Тогда 
				НоваяЗапись.Модель = Брэнд;	
			КонецЕсли;	
		ИначеЕсли Найти(СтруктураПолей.Тема, "Заявка 3") Тогда //Заявка на финансовые услуги
			НоваяЗапись = НаборЗаписей.Добавить();
			НоваяЗапись.Автор = Автор;  
			НоваяЗапись.ДатаДень = СтруктураПолей.Дата;
			НоваяЗапись.ДатаВремя = СтруктураПолей.Дата;
			НоваяЗапись.ПредставлениеТелефона = СтруктураПолей.Телефон;  
			НоваяЗапись.Сотрудник = Сотрудник;
			НоваяЗапись.Клиент = Клиент;
			НоваяЗапись.ВидКонтакта = Перечисления.ВидыСобытий.Прочее ;
			НоваяЗапись.Организация = Организация;
			НоваяЗапись.Реклама =  Справочники.ИсточникиИнформации.НайтиПоКоду("ЦБ000004"); //  Интернет
			НоваяЗапись.Подразделение = Подразделение;
			Содержание = Лев("Клиент: "+СокрЛП(СтруктураПолей.Клиент)+"; Телефон: "+СокрЛП(СтруктураПолей.Телефон)+
			"; Доп. инф.: "+Лев(СокрЛП(СтруктураПолей.ДопИнф),250) ,499) ;
			НоваяЗапись.Комментарий = Содержание;
			НоваяЗапись.Примечание =  Содержание;
			//НоваяЗапись.ВторичныйКонтакт = ДанныеОКлиенте.ВторичныйКонтакт;
			НоваяЗапись.ПредметОбращения = Справочники.ПредметыОбращения.НайтиПоКоду("00000001"); // По умолчанию Автосалон	
			Если Брэнд <> Неопределено Тогда 
				НоваяЗапись.Модель = Брэнд;	
			КонецЕсли;	
		ИначеЕсли Найти(СтруктураПолей.Тема, "Заявка") Тогда //Заявка на финансовые услуги
			НоваяЗапись = НаборЗаписей.Добавить();
			НоваяЗапись.Автор = Автор;  
			НоваяЗапись.ДатаДень = СтруктураПолей.Дата;
			НоваяЗапись.ДатаВремя = СтруктураПолей.Дата;
			НоваяЗапись.ПредставлениеТелефона = СтруктураПолей.Телефон;  
			НоваяЗапись.Сотрудник = Сотрудник;
			НоваяЗапись.Клиент = Клиент;
			НоваяЗапись.ВидКонтакта = Перечисления.ВидыСобытий.Прочее ;
			НоваяЗапись.Организация = Организация;
			НоваяЗапись.Реклама =  Справочники.ИсточникиИнформации.НайтиПоКоду("ЦБ000004"); //  Интернет
			НоваяЗапись.Подразделение = Подразделение;
			Содержание = Лев("Марка: "+ СокрЛП(СтруктураПолей.Модель)+"; Категория Авто: "+СокрЛП(СтруктураПолей.КатегорияАвто)+
			"; Стоимость: "+СокрЛП(СтруктураПолей.Стоимость)+"; Перв. Взнос:"+ СокрЛП(СтруктураПолей.ПервВзнос)+
			"; Срок: "+СокрЛП(СтруктураПолей.Срок)+"; ПроцСтавка: "+СокрЛП(СтруктураПолей.ПроцСтавка)+"; Клиент: "+СокрЛП(СтруктураПолей.Клиент)+
			"; Телефон: "+СокрЛП(СтруктураПолей.Телефон)+"; Эл.Почта: "+СокрЛП(СтруктураПолей.ЭлПочта)+"; Город: "+СокрЛП(СтруктураПолей.город) +
			"; Доп. инф.: "+Лев(СокрЛП(СтруктураПолей.ДопИнф),250) ,499) ;
			НоваяЗапись.Комментарий = Содержание;
			НоваяЗапись.Примечание =  Содержание;
			//НоваяЗапись.ВторичныйКонтакт = ДанныеОКлиенте.ВторичныйКонтакт;
			НоваяЗапись.ПредметОбращения = Справочники.ПредметыОбращения.НайтиПоКоду("00000001"); // По умолчанию Автосалон
			Если Брэнд <> Неопределено Тогда 
				НоваяЗапись.Модель = Брэнд;	
			КонецЕсли;		
						
		Иначе    //с Livetex или другое			
			НоваяЗапись = НаборЗаписей.Добавить();
			НоваяЗапись.Автор = Автор;  
			НоваяЗапись.ДатаДень = СтруктураПолей.Дата;
			НоваяЗапись.ДатаВремя = СтруктураПолей.Дата;
			НоваяЗапись.ПредставлениеТелефона = СтруктураПолей.Телефон;  
			НоваяЗапись.Сотрудник = Сотрудник;
			НоваяЗапись.Клиент = Клиент;
			НоваяЗапись.ВидКонтакта = Перечисления.ВидыСобытий.Прочее ;
			НоваяЗапись.Организация = Организация;
			НоваяЗапись.Реклама =  Справочники.ИсточникиИнформации.НайтиПоКоду("ЦБ000004"); //  Интернет
			НоваяЗапись.Подразделение = Подразделение;	
			Содержание = Лев((СокрЛП(СтруктураПолей.ДопИнф)) ,499) ;
			НоваяЗапись.Комментарий = Содержание;
			НоваяЗапись.Примечание = Содержание;
			//НоваяЗапись.ВторичныйКонтакт = ДанныеОКлиенте.ВторичныйКонтакт;
			НоваяЗапись.ПредметОбращения = Справочники.ПредметыОбращения.НайтиПоКоду("00000001"); // По умолчанию Автосалон
			Если Брэнд <> Неопределено Тогда 
				НоваяЗапись.Модель = Брэнд;	
			КонецЕсли;				
		КонецЕсли;
		
		попытка
			НаборЗаписей.Записать();
		исключение
		конецпопытки;
		
		ТекОбъект = Документы.Событие.СоздатьДокумент();
		
		МенеджерЗаписи = РегистрыСведений.РегистрацияЗвонковИКонтактов.СоздатьМенеджерЗаписи();
		ЗаполнитьЗначенияСвойств(МенеджерЗаписи,НоваяЗапись);
		МенеджерЗаписи.Прочитать();
		
		СтруктураСтроки	= Новый Структура();
		СтруктураСтроки.Вставить("Имя",						"РегистрацияЗвонковИКонтактов");
		СтруктураСтроки.Вставить("Автор",					Автор);
		СтруктураСтроки.Вставить("ДатаДень",				МенеджерЗаписи.ДатаДень);
		СтруктураСтроки.Вставить("ДатаВремя",				МенеджерЗаписи.ДатаВремя);
		СтруктураСтроки.Вставить("Сотрудник",				МенеджерЗаписи.Сотрудник);
		СтруктураСтроки.Вставить("Контрагент",				МенеджерЗаписи.Клиент);
		СтруктураСтроки.Вставить("Организация",				МенеджерЗаписи.Организация);
		СтруктураСтроки.Вставить("ПодразделениеКомпании",	МенеджерЗаписи.Подразделение);
		СтруктураСтроки.Вставить("Модель",					МенеджерЗаписи.Модель);
		СтруктураСтроки.Вставить("ВидКонтакта",				МенеджерЗаписи.ВидКонтакта);
		СтруктураСтроки.Вставить("Реклама",					МенеджерЗаписи.Реклама);
		СтруктураСтроки.Вставить("ВторичныйКонтакт",		МенеджерЗаписи.ВторичныйКонтакт);
		СтруктураСтроки.Вставить("ЮридическоеЛицо",			МенеджерЗаписи.ЮридическоеЛицо);
		СтруктураСтроки.Вставить("Примечание",				МенеджерЗаписи.Примечание);
		СтруктураСтроки.Вставить("ПредметОбращения",		МенеджерЗаписи.ПредметОбращения);
		СтруктураСтроки.Вставить("Участник",				МенеджерЗаписи.Участник);
		СтруктураСтроки.Вставить("КодРегиона",				МенеджерЗаписи.КодРегиона);
		СтруктураСтроки.Вставить("КодГорода",				МенеджерЗаписи.КодГорода);
		СтруктураСтроки.Вставить("НомерТелефона",			МенеджерЗаписи.НомерТелефона);
		СтруктураСтроки.Вставить("ВнутреннийНомер",			МенеджерЗаписи.ВнутреннийНомер);
		СтруктураСтроки.Вставить("ПредставлениеТелефона",	МенеджерЗаписи.ПредставлениеТелефона);
		СтруктураСтроки.Вставить("ВидТелефона",				МенеджерЗаписи.ВидТелефона);
		
		ВремяСобытия = НачалоДня(МенеджерЗаписи.ДатаДень) + (МенеджерЗаписи.ДатаВремя - НачалоДня(МенеджерЗаписи.ДатаВремя));
		
		ТекОбъект.Заполнить(СтруктураСтроки);
		ТекОбъект.ДополнительныеСвойства.Вставить("УжеВВодилось", Истина);
		текоБъект.ОбменДанными.Загрузка = ИСТИНА;
		ТекОбъект.Дата = ВремяСобытия;
		ТекОбъект.Автор = Справочники.Пользователи.НайтиПоНаименованию("АТС"); //АТС
		ТекОбъект.Организация = Сотрудник.Организация;
		ТекОбъект.ПодразделениеКомпании = Сотрудник.Подразделение;
		Если Найти(СтруктураПолей.Тема,"Заявка") Тогда //Заявка на финансовые услуги
			ТекОбъект.Тема ="Заявка от "+ВремяСобытия;	
		Иначе    //с Livetex или другое
			ТекОбъект.Тема =СтруктураПолей.Тема+ " от "+ВремяСобытия;	
		КонецЕсли;					
		ТекОбъект.ДатаНачала = ВремяСобытия;
		текОбъект.ДатаОкончания = ВремяСобытия+60*1; 
		ТекОбъект.Состояние = Перечисления.СостоянияСобытий.Завершено;
		ТекОбъект.Приоритет = Перечисления.Важность.Средняя;
		ТекОбъект.Продавец = Сотрудник; 
		ТекОбъект.ФорматТекста = Перечисления.ФорматТекста.ПростойТекст;
		ТекОбъект.ХозОперация = Справочники.ХозОперации.Событие;
		ТекОбъект.ВидСобытия = Перечисления.ВидыСобытий.Прочее; 
		ТекОбъект.Комментарий = МенеджерЗаписи.Комментарий;
		ТекОбъект.Содержание = МенеджерЗаписи.Комментарий;
		ТекОбъект.Записать();
		ТекОбъект.УстановитьНовыйНомер();
		Текобъект.ОбменДанными.Загрузка=Ложь;	
		
		ТекОбъект.Записать(РежимЗаписиДокумента.Проведение);
		МенеджерЗаписи.ДокументСобытие = ТекОбъект.Ссылка;
		
		Попытка 
			МенеджерЗаписи.Записать();
		Исключение
		КонецПопытки;

КонецПроцедуры

Функция ВернутьБренд(тема)
	Если Найти(тема,"ВАЗ") или Найти(тема,"vaz") или Найти(тема,"VAZ") или Найти(тема,"ladakuban") Тогда
		Возврат справочники.Модели.НайтиПоКоду("ЦБ00000031");
	ИначеЕсли Найти(тема,"ssang") ИЛИ Найти(тема,"SSANG") Тогда	
		Возврат справочники.Модели.НайтиПоКоду("ЦБ00000006");
	ИначеЕсли Найти(тема,"gaz") ИЛИ Найти(тема,"ГАЗ") Тогда	
		Возврат справочники.Модели.НайтиПоКоду("ЦБ00000332");	
	ИначеЕсли Найти(тема,"chevrolet") ИЛИ Найти(тема,"CHEVROLET") ИЛИ Найти(тема,"Chevrolet") Тогда	
		Возврат справочники.Модели.НайтиПоКоду("ЦБ00000124");
	ИначеЕсли Найти(тема,"geely") ИЛИ Найти(тема,"Geely") ИЛИ Найти(тема,"GEELY") Тогда	
		Возврат справочники.Модели.НайтиПоКоду("ЦБ00000707");
	ИначеЕсли Найти(тема,"uaz") ИЛИ Найти(тема,"UAZ") ИЛИ Найти(тема,"УАЗ") Тогда	
		Возврат справочники.Модели.НайтиПоКоду("ЦБ00000004");
	Иначе
		Возврат Неопределено;
	КонецЕсли;
КонецФункции

Процедура ТТ_ОтправкаОтчетовМаржаПродажи(СтруктураПараметров) Экспорт
	//Если ПолучитьПредставлениеИнформационнойБазы() <> "alfa5" Тогда 
	//	Возврат;
	//КонецЕсли;
	
	Обр = Обработки.ОтправкаПочты.Создать();
	// ССА 2015-12-08 { по требованию Михаила
	//Обр.СформироватьОтправитьОтчетМаржаИпродажи_DBP();
	// }
	Обр.СформироватьОтправитьОтчетМаржаИпродажи_DBP_GEELY();
	Обр.СформироватьОтправитьОтчетМаржаИпродажи_DBP_ВАЗ();
	Обр.СформироватьОтправитьОтчетМаржаИпродажи_DBP_ГАЗ();	
	Обр.СформироватьОтправитьОтчетМаржаИпродажи_DBP_CHEVROLET();
	Обр.СформироватьОтправитьОтчетМаржаИпродажи_DBP_Корп();
	
КонецПроцедуры

//Получить представление информационной базы.
Функция ПолучитьПредставлениеИнформационнойБазы()
	СтрокаСоединенияСБД =  СтрокаСоединенияИнформационнойБазы();
	
	ЭтоФайловаяИБ = Найти(Врег(СтрокаСоединенияСБД), "FILE=") = 1;
	Если ЭтоФайловаяИБ Тогда
		ПутьКБД = Сред(СтрокаСоединенияСБД, 6, СтрДлина(СтрокаСоединенияСБД) - 6);
		ФайловаяБД = Истина;
	Иначе
		// надо к имени сервера прибавить имя пути информационной базы
		ПозицияПоиска = Найти(Врег(СтрокаСоединенияСБД), "SRVR=");
		
		Если ПозицияПоиска <> 1 Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		ПозицияТочкиСЗапятой = Найти(СтрокаСоединенияСБД, ";");
		НачальнаяПозицияКопирования = 6 + 1;
		КонечнаяПозицияКопирования = ПозицияТочкиСЗапятой - 2; 
		
		ИмяСервера = Сред(СтрокаСоединенияСБД, НачальнаяПозицияКопирования, КонечнаяПозицияКопирования - НачальнаяПозицияКопирования + 1);
		
		СтрокаСоединенияСБД = Сред(СтрокаСоединенияСБД, ПозицияТочкиСЗапятой + 1);
		
		// позиция имени сервера
		ПозицияПоиска = Найти(Врег(СтрокаСоединенияСБД), "REF=");
		
		Если ПозицияПоиска <> 1 Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		НачальнаяПозицияКопирования = 6;
		ПозицияТочкиСЗапятой = Найти(СтрокаСоединенияСБД, ";");
		КонечнаяПозицияКопирования = ПозицияТочкиСЗапятой - 2; 
		
		ИмяИБНаСервере = Сред(СтрокаСоединенияСБД, НачальнаяПозицияКопирования, КонечнаяПозицияКопирования - НачальнаяПозицияКопирования + 1);
		
		//ПутьКБД = ИмяСервера + "/ " + ИмяИБНаСервере;
		ПутьКБД = ИмяИБНаСервере;

		ФайловаяБД = Ложь;
	КонецЕсли;
	Возврат ПутьКБД;
КонецФункции

Процедура ПерепровестиБанкИКассу(СтруктураПараметров) Экспорт
	
	 Запрос = новый запрос;
	 запрос.Текст = "ВЫБРАТЬ
	                |	ПриходныйКассовыйОрдер.Ссылка
	                |ИЗ
	                |	Документ.ПриходныйКассовыйОрдер КАК ПриходныйКассовыйОрдер
	                |ГДЕ
	                |	ПриходныйКассовыйОрдер.Дата МЕЖДУ НАЧАЛОПЕРИОДА(&Дата, ДЕНЬ) И КОНЕЦПЕРИОДА(&Дата, ДЕНЬ)
	                |
	                |ОБЪЕДИНИТЬ ВСЕ
	                |
	                |ВЫБРАТЬ
	                |	РасходныйКассовыйОрдер.Ссылка
	                |ИЗ
	                |	Документ.РасходныйКассовыйОрдер КАК РасходныйКассовыйОрдер
	                |ГДЕ
	                |	РасходныйКассовыйОрдер.Дата МЕЖДУ НАЧАЛОПЕРИОДА(&Дата, ДЕНЬ) И КОНЕЦПЕРИОДА(&Дата, ДЕНЬ)
	                |
	                |ОБЪЕДИНИТЬ ВСЕ
	                |
	                |ВЫБРАТЬ
	                |	Выписка.Ссылка
	                |ИЗ
	                |	Документ.Выписка КАК Выписка
	                |ГДЕ
	                |	Выписка.Дата МЕЖДУ НАЧАЛОПЕРИОДА(&Дата, ДЕНЬ) И КОНЕЦПЕРИОДА(&Дата, ДЕНЬ)";
					
	Запрос.УстановитьПараметр("Дата",ТекущаяДата());
	Выборка = запрос.Выполнить().Выбрать();
	
	если выборка.Количество() > 0 тогда
	пока выборка.Следующий() цикл
		попытка
		док = выборка.ссылка.получитьОбъект();
		
		Док.Записать(РежимЗаписиДокумента.Проведение);
	исключение
		КонецПопытки;
	КонецЦикла;
    конецесли;
	
КонецПроцедуры	

Процедура ТТ_ОтчетПоЗвонкам(СтруктураПараметров) Экспорт
	Обр = Обработки.ОтправкаПочты.Создать();
	Обр.СформироватьОтправитьОтчетПоЗвонкам();
КонецПроцедуры

Процедура ТТ_ОповещениеГарантия(СтруктураПараметров) Экспорт
	Обр = Обработки.ТТ_ОтправкаПочты.Создать();
	//Обр.ОповещениеГарантия();
	Обр.ОповещениеНезакрытыхЗН();
	Обр.ОповещениеДеньВдень();
КонецПроцедуры

Процедура ТТ_ОбменКарт(СтруктураПараметров) Экспорт
	обр= обработки.ОбменДискКарт.Создать();
	Обр.Загрузить(Истина);
	Обр.Выгрузить(Истина);	
КонецПроцедуры

Процедура ТТ_ВыгрузкаЛадаКлиент(СтруктураПараметров) Экспорт
	
	обр = обработки.CRM_Клиент.Создать();
	обр.ЗагрузитьРЛЗаПериод(НачалоДня( ТекущаяДата()- 7*24*60*60 ), КонецДня(ТекущаяДата()), ложь);
	
КонецПроцедуры

Процедура ТТ_ВыгрузкаУпр(СтруктураПараметров) Экспорт
	
	Обр= ВнешниеОтчеты.Создать("\\10.50.19.4\public\IT\ВнешниеОбработки\выг-загр\Технотемп\ВыгрузкаФакта Технотемп.erf",Ложь);
	Обр.СформироватьФон();
	Обр.СформироватьФон(Истина);
	
КонецПроцедуры

Процедура ТТ_ПерерасчетЗП(СтруктураПараметров) Экспорт
	Запрос = Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	|	РасчетЗарплатыМенеджеров.Ссылка
	|ИЗ
	|	Документ.РасчетЗарплатыМенеджеров КАК РасчетЗарплатыМенеджеров
	|ГДЕ
	|	РасчетЗарплатыМенеджеров.Проведен = ИСТИНА
	|	И РасчетЗарплатыМенеджеров.ПериодНачало МЕЖДУ &НачалоПериода И &КонецПериода"	;
	Запрос.УстановитьПараметр("НачалоПериода",НачалоМесяца( ТекущаяДата() ) );
	Запрос.УстановитьПараметр("КонецПериода", КонецМесяца( ТекущаяДата() ) );
	Выборка = запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Док= Выборка.Ссылка.ПолучитьОбъект();
		Попытка
			Док.Записать(РежимЗаписиДокумента.Проведение);		
		Исключение
		КонецПопытки;
	КонецЦикла;
	
КонецПроцедуры

Процедура ТТ_ВыгрузкаОстатковЗЧ(СтруктураПараметров) Экспорт
    Склады = Новый СписокЗначений;
	Склады.Добавить( справочники.СкладыКомпании.НайтиПоКоду("ЦБ000079") );  //ТАС
	Склады.Добавить( справочники.СкладыКомпании.НайтиПоКоду("ЦБ000001") );  //ТТ
	Склады.Добавить( справочники.СкладыКомпании.НайтиПоКоду("ЦБ000099") );  //ГАЗ
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПартииТоваровКомпанииОстатки.Номенклатура.Артикул КАК Артикул,
		|	ПартииТоваровКомпанииОстатки.Номенклатура.Наименование КАК Наименование,
		|	СУММА(ПартииТоваровКомпанииОстатки.КоличествоОстаток) КАК Количество,
		|	СРЕДНЕЕ(ВЫРАЗИТЬ(ВЫБОР
		|				КОГДА ПартииТоваровКомпанииОстатки.КоличествоОстаток = 0
		|					ТОГДА 0
		|				ИНАЧЕ ПартииТоваровКомпанииОстатки.СуммаОстаток / ПартииТоваровКомпанииОстатки.КоличествоОстаток
		|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК СредняяЦена
		|ИЗ
		|	РегистрНакопления.ПартииТоваровКомпании.Остатки(&Период, СкладКомпании В (&Склады)) КАК ПартииТоваровКомпанииОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	ПартииТоваровКомпанииОстатки.Номенклатура.Наименование,
		|	ПартииТоваровКомпанииОстатки.Номенклатура.Артикул";

	Запрос.УстановитьПараметр("Период", НачалоДня(ТекущаяДата()) );
	Запрос.УстановитьПараметр("Склады",Склады);

	Результат = Запрос.Выполнить().Выгрузить();

	ТабДокумент = Новый ТабличныйДокумент;
	Построитель = Новый ПостроительОтчета;
	Построитель.ИсточникДанных=Новый ОписаниеИсточникаДанных(Результат);       
	Построитель.Вывести(ТабДокумент);
	
	ИмяФайла = КаталогВременныхФайлов() + "Остатки ЗЧ. Техно-Темп.xls";

	ТабДокумент.Записать(ИмяФайла, ТипФайлаТабличногоДокумента.XLS);

	Файлы = Новый Массив;
    Файлы.Добавить(ИмяФайла);
		
	//отправка
	Тема = "Остатки зап. частей . Техно-Темп";
	
	Получатели = Новый Массив;
	Получатели.Добавить("dsam@tak.kuban.ru");
		
	СлепыеПолучатели = Новый Массив;
	СлепыеПолучатели.Добавить("1c_prog@tempauto.net");
	
	ТекстПисьма="ООО Техно-Темп. Сформировано автоматически.  " + НачалоДня(ТекущаяДата());
	Обр=Обработки.ОтправкаПочты.Создать();	
	Обр.ОтправитьEmail(Получатели,Тема,ТекстПисьма,Файлы,СлепыеПолучатели);	
			
	
КонецПроцедуры

// ССА 2015-11-17 {
// функция пробует создать объект внешнего отчета, если не получается - объект внутреннего, 
// иначе возвращает неопределено
//
// Параметры -
//  ИмяОтчета - Строка, имя отчета, экземпляр которой пытаемся создать
Функция обПолучитьВнешнийОтчетОбъект(ИмяОтчета)Экспорт
	// попробуем найти обработку в предопределённых элементах справочник Внешние печатные формы
	НайденыйОтчет = Неопределено;
	ИтоговыйОтчет = Неопределено;

	//#Если Клиент Тогда
		//НайденыйОтчет = Справочники.ВнешниеПечатныеФормы[ИмяОтчета];
		НайденыйОтчет = Справочники.ВнешниеПечатныеФормы.НайтиПоНаименованию(ИмяОтчета);

		Если ЗначениеЗаполнено(НайденыйОтчет) Тогда
			// проверим есть ли внешняя обработка
			ЕстьВнешнийОтчет = Ложь;
			Если НайденыйОтчет.ХранитьВоВнешнемФайле Тогда
				// проверим, а есть ли файл?
				ФайлОтчета = Новый Файл(НайденыйОтчет.ПутьКВнешнемуФайлу);
				ЕстьВнешнийОтчет =  Не обЗначениеНеЗаполнено(НайденыйОтчет.ПутьКВнешнемуФайлу) И ФайлОтчета.Существует();
			Иначе
				Если (НайденыйОтчет.Хранилище.Получить() = Неопределено) ИЛИ (НайденыйОтчет.Хранилище.Получить() = "") Тогда
					ЕстьВнешнийОтчет = Ложь
				Иначе
					ЕстьВнешнийОтчет = Истина;
				КонецЕсли;
			КонецЕсли;

			Если ЕстьВнешнийОтчет Тогда
				// найдена внешняя обработка, которая хранится во внешнем файле - используем её
				Если НайденыйОтчет.ХранитьВоВнешнемФайле Тогда
					ИмяФайлаВнешнегоОтчета = НайденыйОтчет.ПутьКВнешнемуФайлу;
				Иначе
					ИмяФайлаВнешнегоОтчета = ПолучитьИмяВременногоФайла();
					НайденыйОтчет.Хранилище.Получить().Записать(ИмяФайлаВнешнегоОтчета);
				КонецЕсли;

				ИтоговыйОтчет = ВнешниеОтчеты.Создать(ИмяФайлаВнешнегоОтчета);
			Иначе
				НайденыйОтчет = Неопределено;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(НайденыйОтчет) Тогда
			// попробуем создать встроенную обработку
			Попытка
				ИтоговыйОтчет = Отчеты[ИмяОтчета].Создать();
			Исключение
				ИтоговыйОтчет = Неопределено;
			КонецПопытки;
		КонецЕсли;
	//#КонецЕсли

	Возврат ИтоговыйОтчет;
КонецФункции

// ССА 2015-11-20 {
// }
Функция ИсправитьСтроку(ИсходнаяСтрока)Экспорт    
    Если ИсходнаяСтрока = "" Тогда
        Возврат "";
	КонецЕсли;
	Результат = ИсходнаяСтрока;
    Пока Истина Цикл
        Позиция = НайтиНедопустимыеСимволыXML(Результат);        
        Если Позиция = 0 Тогда
            Прервать;
        КонецЕсли;
        Результат = Сред(Результат,1, Позиция-1)+Сред(Результат, Позиция+1); 
    КонецЦикла;
    
    Результат = СтрЗаменить(Результат, Символ(13) + Символ(10), Символы.ПС);
    Результат = СтрЗаменить(Результат, Символ(182), Символы.ПС);
    Возврат Результат;
КонецФункции

Процедура ЗаполнитьСписокСкладов(спс)
		//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СкладыКомпании.Ссылка
		|ИЗ
		|	Справочник.СкладыКомпании КАК СкладыКомпании
		|ГДЕ
		|	(СкладыКомпании.Наименование ПОДОБНО ""%подменных%""
		|			ИЛИ СкладыКомпании.Наименование ПОДОБНО ""%собственных%""
		|			ИЛИ СкладыКомпании.Наименование ПОДОБНО ""%тест-драйв%""
		|			ИЛИ СкладыКомпании.Наименование ПОДОБНО ""%комиссионных%""
		|			ИЛИ СкладыКомпании.Наименование ПОДОБНО ""%ТТ Отв/Хр%""
		|			ИЛИ СкладыКомпании.Наименование ПОДОБНО ""%Региональный%""
		|			ИЛИ СкладыКомпании.Наименование ПОДОБНО ""%передача%""
		|			ИЛИ СкладыКомпании.Наименование ПОДОБНО ""%ответ.хранение%"")
		|
		|СГРУППИРОВАТЬ ПО
		|	СкладыКомпании.Ссылка";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		// Вставить обработку выборки ВыборкаДетальныеЗаписи
		спс.Добавить(ВыборкаДетальныеЗаписи.Ссылка);
	КонецЦикла;
	
	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА

КонецПроцедуры

Функция ТТ_СформироватьXMLDBP(СтруктураПараметров) Экспорт

	Период = СтруктураПараметров.Период;
	
	Отчет = обПолучитьВнешнийОтчетОбъект("DBP");
	Если Отчет = Неопределено Тогда
	    Возврат Неопределено;	
	КонецЕсли; 
	
	Организация = ПараметрыСеанса.Организация;

	СписокИсключитьСклDBP = Новый СписокЗначений;
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000171"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000009"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000010"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000011"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000055"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000105"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000107"));
	////СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000146"));	
	////СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000102"));	
	
	ЗаполнитьСписокСкладов(СписокИсключитьСклDBP);

	Брэнд = Справочники.Модели.ПустаяСсылка();	 //Все
	
	//*********** DBP ****************
	
	//Отчет = ВнешниеОтчеты.Создать("\\10.50.19.4\public\IT\ВнешниеОтчеты\DBP.erf", Ложь);
			
	ВременныйФайл = ПолучитьИмяВременногоФайла("xml");	
	Запись =Новый ЗаписьXML;
	Запись.ОткрытьФайл(ВременныйФайл);		
  	
	//Установка стандартных параметров  	
	ТекущаяСхемаКомпоновкиДанных = Отчет.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");	
	Настройки = ТекущаяСхемаКомпоновкиДанных.НастройкиПоУмолчанию;
	
	//редактирую настройки оставляю только одну группировку Бренд+Модель
	Настройки.Структура.Очистить();
	Для каждого Эл из Настройки.Выбор.Элементы Цикл
		Если Строка(Эл.Поле) = "Корп" Или Строка(Эл.Поле) = "РеализацияПоТрейдИн" Тогда
			Эл.Использование = Истина;
		КонецЕсли;	
	КонецЦикла;
	
	ДетальныеЗаписи = Настройки.Структура.Добавить(Тип("ГруппировкаКомпоновкиДанных"));
	ДетальныеЗаписи.Использование = Истина;
	ВыбранныеПоля = ДетальныеЗаписи.Выбор.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
	ВыбранныеПоля.Использование = Истина;

	ВыбранныеПоля = ДетальныеЗаписи.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
	ВыбранныеПоля.Использование = Истина;
	ВыбранныеПоля.Поле = Новый ПолеКомпоновкиДанных("Модель");
	
	ВыбранныеПоля = ДетальныеЗаписи.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
	ВыбранныеПоля.Использование = Истина;
	ВыбранныеПоля.Поле = Новый ПолеКомпоновкиДанных("Автомобиль.Модель");
	

	//--------------
	Модели = новый СписокЗначений;
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000031"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000332"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000004"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000124"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000707"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000353"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000002"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000006"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00001126"));

	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00001166"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00001515"));

	Настройки.ПараметрыДанных.УстановитьЗначениеПараметра("Период",Период);
	
	ТекущаяСхемаКомпоновкиДанных.Параметры["CобстМодели"].Значение =Модели;
	//ТекущаяСхемаКомпоновкиДанных.Параметры["Период"].Значение =Период;
	//ТекущаяСхемаКомпоновкиДанных.Параметры["Период"].ОграничениеИспользования = Истина;
	ТекущаяСхемаКомпоновкиДанных.Параметры["Брэнд"].Значение = Брэнд;
	ТекущаяСхемаКомпоновкиДанных.Параметры["СкладыИскл"].Значение =СписокИсключитьСклDBP;
	
	//ТекущаяСхемаКомпоновкиДанных.НастройкиПоУмолчанию.ПараметрыВывода.Элементы[11].Значение = "Продажи автомобилей за " + Строка(Формат(Период, "ДЛФ=Д")); 
	
	//Установим отбор
	ЭлементОтбора = Настройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("НеВыгружатьУУ");
	ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ЭлементОтбора.ПравоеЗначение = Ложь;
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(ТекущаяСхемаКомпоновкиДанных,Настройки,,,Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));

	
	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки);
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
	
	ДеревоРезультат = Новый ДеревоЗначений;
	ПроцессорВывода.УстановитьОбъект(ДеревоРезультат);
	
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);//вывод без обхода элементов 
	
	//Удалю колонку "Автомобиль" из ДеревоРезультат
	Колонка = ДеревоРезультат.Колонки.Найти("Автомобиль");
	Если не Колонка = Неопределено Тогда 
		ДеревоРезультат.Колонки.Удалить(Колонка);	
	КонецЕсли;
	//Обход значений ДеревоРезультат
	Запись.ЗаписатьНачалоЭлемента("СтрокиОтчета");
	Запись.ЗаписатьНачалоАтрибута("Организация");
	Запись.ЗаписатьТекст(Строка(Организация));
	Запись.ЗаписатьКонецАтрибута();
	Запись.ЗаписатьНачалоАтрибута("Период");
	Запись.ЗаписатьТекст(Формат(Период,"ДФ=yyyyMMdd"));
	Запись.ЗаписатьКонецАтрибута();
	Для Каждого СтрокаОтчета Из ДеревоРезультат.Строки Цикл
		Если СтрокаОтчета["АвтомобильМодель"]<>Неопределено Тогда 
			Запись.ЗаписатьНачалоЭлемента("Строка");
			Для Каждого Колонка Из ДеревоРезультат.Колонки Цикл
				Запись.ЗаписатьНачалоАтрибута(Колонка.Имя);
				Если Колонка.Имя = "Модель" Или Колонка.Имя = "АвтомобильМодель" Или Колонка.Имя = "Корп" Тогда 
					Запись.ЗаписатьТекст(ИсправитьСтроку(Строка(СтрокаОтчета[Колонка.Имя])));
				Иначе	
					Запись.ЗаписатьТекст(Строка(СтрокаОтчета[Колонка.Имя]));
				КонецЕсли;
				Запись.ЗаписатьКонецАтрибута();
			КонецЦикла;
			Запись.ЗаписатьКонецЭлемента();
		КонецЕсли;
	КонецЦикла;
	
	Если ДеревоРезультат.Строки.Количество() = 1 Тогда 
			Запись.ЗаписатьНачалоЭлемента("Строка");
				Запись.ЗаписатьНачалоАтрибута("Модель");
					Запись.ЗаписатьТекст("-");
				Запись.ЗаписатьКонецАтрибута();
			Запись.ЗаписатьКонецЭлемента();
	КонецЕсли;
	
	Запись.ЗаписатьКонецЭлемента();
	Запись.Закрыть();
	
	ДеревоРезультат = Неопределено;

	Возврат ВременныйФайл;
	
КонецФункции

Функция ТТ_СформироватьXMLСкладПродажи(СтруктураПараметров) Экспорт
	
	Период = СтруктураПараметров.Период;

	Отчет = обПолучитьВнешнийОтчетОбъект("Склад и продажи");
	Если Отчет = Неопределено Тогда
	    Возврат Неопределено;	
	КонецЕсли; 
	
	Организация = ПараметрыСеанса.Организация;
	
	ВременныйФайл = ПолучитьИмяВременногоФайла("xml");	
	Запись =Новый ЗаписьXML;
	Запись.ОткрытьФайл(ВременныйФайл);		
  	
	//Установка стандартных параметров  	
	ТекущаяСхемаКомпоновкиДанных = Отчет.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");	
	Настройки = ТекущаяСхемаКомпоновкиДанных.НастройкиПоУмолчанию;
	
	//редактирую настройки
	Настройки.Структура.Очистить();
	Для каждого Эл из Настройки.Выбор.Элементы Цикл
		Если Строка(Эл.Поле) = "Корп" Или Строка(Эл.Поле) = "РеализацияПоТрейдИн" Или Строка(Эл.Поле) = "СобственныйКонтрагент" Тогда
			Эл.Использование = Истина;
		КонецЕсли;	
	КонецЦикла;
	//Группировка ДетальныеЗаписи
	ГруппировкаДетали = Настройки.Структура.Добавить(Тип("ГруппировкаКомпоновкиДанных"));
	ГруппировкаДетали.Использование = Истина;
	
	ВыбранныеПоляДляДетали = ГруппировкаДетали.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
	ВыбранныеПоляДляДетали.Поле = Новый ПолеКомпоновкиДанных("Марка");
	ВыбранныеПоляДляДетали.Использование = Истина;
	
	ВыбранныеПоляДляДетали = ГруппировкаДетали.Выбор.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
	ВыбранныеПоляДляДетали.Использование = Истина;

	
	ТекущаяСхемаКомпоновкиДанных.Параметры["Период"].Значение =КонецДня(Период);
	ТекущаяСхемаКомпоновкиДанных.Параметры["ПериодН"].Значение =НачалоМесяца(Период);
	ТекущаяСхемаКомпоновкиДанных.Параметры["ПериодК"].Значение =КонецМесяца(Период);
    ТекущаяСхемаКомпоновкиДанных.Параметры["Дата"].Значение =НачалоДня(Период);
	//ТекущаяСхемаКомпоновкиДанных.Параметры["Брэнд"].Значение =справочники.Модели.ПустаяСсылка();
	ТекущаяСхемаКомпоновкиДанных.Параметры["ВсеПродажи"].Значение = Ложь;
	
	СписокИсключитьСкл = Новый СписокЗначений;
	//СписокИсключитьСкл.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000171"));
	//СписокИсключитьСкл.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000009"));
	//СписокИсключитьСкл.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000010"));
	//СписокИсключитьСкл.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000011"));
	//СписокИсключитьСкл.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000055"));
	//СписокИсключитьСкл.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000105"));
	//СписокИсключитьСкл.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000107"));
	
	ЗаполнитьСписокСкладов(СписокИсключитьСкл);

    ТекущаяСхемаКомпоновкиДанных.Параметры["СкладыИскл"].Значение = СписокИсключитьСкл;
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(ТекущаяСхемаКомпоновкиДанных,Настройки,,,Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));

	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки);
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
	
	ДеревоРезультат = Новый ДеревоЗначений;
	ПроцессорВывода.УстановитьОбъект(ДеревоРезультат);
	
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);//вывод без обхода элементов 
	
	//Обход значений ДеревоРезультат
	Запись.ЗаписатьНачалоЭлемента("СтрокиОтчета");
	Запись.ЗаписатьНачалоАтрибута("Организация");
	Запись.ЗаписатьТекст(Строка(Организация));
	Запись.ЗаписатьКонецАтрибута();
	Запись.ЗаписатьНачалоАтрибута("Период");
	Запись.ЗаписатьТекст(Формат(Период,"ДФ=yyyyMMdd"));
	Запись.ЗаписатьКонецАтрибута();
	Для Каждого СтрокаОтчета Из ДеревоРезультат.Строки Цикл
		Если СтрокаОтчета["Модель"]<>Неопределено Тогда 
			Запись.ЗаписатьНачалоЭлемента("Строка");
			Для Каждого Колонка Из ДеревоРезультат.Колонки Цикл
				Запись.ЗаписатьНачалоАтрибута(Колонка.Имя);
				Если Колонка.Имя = "Модель" Или Колонка.Имя = "АвтомобильМодель" Или Колонка.Имя = "Корп" Тогда 
					Запись.ЗаписатьТекст(ИсправитьСтроку(Строка(СтрокаОтчета[Колонка.Имя])));
				Иначе	
					Запись.ЗаписатьТекст(Строка(СтрокаОтчета[Колонка.Имя]));
				КонецЕсли;
				Запись.ЗаписатьКонецАтрибута();
			КонецЦикла;
			Запись.ЗаписатьКонецЭлемента();
		КонецЕсли;
	КонецЦикла;
	
	Если ДеревоРезультат.Строки.Количество() = 1 Тогда 
			Запись.ЗаписатьНачалоЭлемента("Строка");
				Запись.ЗаписатьНачалоАтрибута("Марка");
					Запись.ЗаписатьТекст("-");
				Запись.ЗаписатьКонецАтрибута();
			Запись.ЗаписатьКонецЭлемента();
	КонецЕсли;
	
	Запись.ЗаписатьКонецЭлемента();
	Запись.Закрыть();
	
	ДеревоРезультат = Неопределено;

	Возврат ВременныйФайл;

КонецФункции

Функция ТТ_СформироватьXMLНеЗакрытыеЗН(СтруктураПараметров) Экспорт
    Период = СтруктураПараметров.Период;

	Отчет = обПолучитьВнешнийОтчетОбъект("Незакрытые З/Н");
	Если Отчет = Неопределено Тогда
	    Возврат Неопределено;	
	КонецЕсли; 
	
	Организация = ПараметрыСеанса.Организация;
	
	ВременныйФайл = ПолучитьИмяВременногоФайла("xml");	
	Запись =Новый ЗаписьXML;
	Запись.ОткрытьФайл(ВременныйФайл);
	
	//Установка стандартных параметров  	
	ТекущаяСхемаКомпоновкиДанных = Отчет.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");
	Настройки = ТекущаяСхемаКомпоновкиДанных.НастройкиПоУмолчанию;

	Настройки.Структура.Очистить();
	
	Для каждого Эл из Настройки.Выбор.Элементы Цикл
		Эл.Использование = Истина;
	КонецЦикла;

	//Группировка ДетальныеЗаписи
	ГруппировкаДетали = Настройки.Структура.Добавить(Тип("ГруппировкаКомпоновкиДанных"));
	ГруппировкаДетали.Использование = Истина;
	
	ВыбранныеПоляДляДетали = ГруппировкаДетали.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
	ВыбранныеПоляДляДетали.Поле = Новый ПолеКомпоновкиДанных("ВидРемонта");
	ВыбранныеПоляДляДетали.Использование = Истина;
	
	ВыбранныеПоляДляДетали = ГруппировкаДетали.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
	ВыбранныеПоляДляДетали.Поле = Новый ПолеКомпоновкиДанных("Бренд");
	ВыбранныеПоляДляДетали.Использование = Истина;

	ВыбранныеПоляДляДетали = ГруппировкаДетали.Выбор.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
	ВыбранныеПоляДляДетали.Использование = Истина;

	Модели = новый СписокЗначений;
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000031"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000332"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000004"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000124"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000707"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000353"));
	Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000002"));
	
	СписСостояний = новый СписокЗначений;
	СписСостояний.Добавить(Справочники.ВидыСостоянийЗаказНарядов.Закрыт);
	СписСостояний.Добавить(Справочники.ВидыСостоянийЗаказНарядов.НайтиПоКоду("ЦБ00000002"));
	
	ТекущаяСхемаКомпоновкиДанных.Параметры["ДатаОтчета"].Значение     = КонецДня(Период);
	ТекущаяСхемаКомпоновкиДанных.Параметры["CобстМодели"].Значение     = Модели;
	ТекущаяСхемаКомпоновкиДанных.Параметры["СписокСостояний"].Значение = СписСостояний;
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(ТекущаяСхемаКомпоновкиДанных,Настройки,,,Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));

	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки);
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
	
	ДеревоРезультат = Новый ДеревоЗначений;
	ПроцессорВывода.УстановитьОбъект(ДеревоРезультат);
	
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);//вывод без обхода элементов 

		//Обход значений ДеревоРезультат
	Запись.ЗаписатьНачалоЭлемента("СтрокиОтчета");
	Запись.ЗаписатьНачалоАтрибута("Организация");
	Запись.ЗаписатьТекст(Строка(Организация));
	Запись.ЗаписатьКонецАтрибута();
	Запись.ЗаписатьНачалоАтрибута("Период");
	Запись.ЗаписатьТекст(Формат(Период,"ДФ=yyyyMMdd"));
	Запись.ЗаписатьКонецАтрибута();

	Для Каждого СтрокаОтчета Из ДеревоРезультат.Строки Цикл
		Если СтрокаОтчета["ВидРемонта"] = Неопределено Тогда 
			Продолжить;
		КонецЕсли;
		Запись.ЗаписатьНачалоЭлемента("Строка");
		Для Каждого Колонка Из ДеревоРезультат.Колонки Цикл
			Запись.ЗаписатьНачалоАтрибута(Колонка.Имя);
				Запись.ЗаписатьТекст(Строка(СтрокаОтчета[Колонка.Имя]));
			Запись.ЗаписатьКонецАтрибута();
		КонецЦикла;
		Запись.ЗаписатьКонецЭлемента();
	КонецЦикла;

	Запись.ЗаписатьКонецЭлемента();
	Запись.Закрыть();
	
	ДеревоРезультат = Неопределено;
	
	Возврат ВременныйФайл;

КонецФункции

Процедура ТТ_ВыгрузкаXMLОтчетов(СтруктураПараметров) Экспорт
	//Период = СтруктураПараметров.Период;
	
	СтрокаСоединенияСБД =  СтрокаСоединенияИнформационнойБазы();
	Основная = Найти(НРег(СтрокаСоединенияСБД), "alfa5_blank") = 1;
	Если Основная Тогда 
		Возврат;	
	КонецЕсли;
	
	ИспользоватьФТП = Истина;
	
	Период = Неопределено;
	ЕстьПериод = СтруктураПараметров.Свойство("Период",Период);
	Если ЕстьПериод Тогда
		Период = ?(Период=Дата(1,1,1),ТекущаяДата(),Период);
	Иначе
		Период = ТекущаяДата();
	КонецЕсли; 	
	СтруктураПараметров.Вставить("Период",Период);
	
	Организация = ПараметрыСеанса.Организация;
	
	ВременныйФайлDBP = ТТ_СформироватьXMLDBP(СтруктураПараметров);
	ВременныйФайлСкладПродажи = ТТ_СформироватьXMLСкладПродажи(СтруктураПараметров);
	ВременныйФайлНеЗакрытыеЗН = ТТ_СформироватьXMLНеЗакрытыеЗН(СтруктураПараметров);
	
	Если ИспользоватьФТП Тогда
		//АдресСайта = "server" ;
		//Порт = 21;
		//Логин = "exch";
		//Пароль = "meridian";
		
		АдресСайта = "files" ;
		Порт = 21;
		Логин = "";
		Пароль = "";
		
		ИмяКаталога = "/";
		FTPСоединение = Новый FTPСоединение(АдресСайта,Порт,Логин,Пароль);
		FTPСоединение.УстановитьТекущийКаталог(ИмяКаталога);
		
		Если ВременныйФайлDBP<>Неопределено Тогда 
			ИмяФайла="DBP_Report_"+Организация.Префикс+Формат(Период,"ДФ=yyyyMMdd")+".xml";
			FTPСоединение.Записать(ВременныйФайлDBP,ИмяФайла);
			УдалитьФайлы(ВременныйФайлDBP);
		КонецЕсли;
		
		Если ВременныйФайлСкладПродажи<>Неопределено Тогда 
			ИмяФайла="WSales_Report_"+Организация.Префикс+Формат(Период,"ДФ=yyyyMMdd")+".xml";
			FTPСоединение.Записать(ВременныйФайлСкладПродажи,ИмяФайла);
			УдалитьФайлы(ВременныйФайлСкладПродажи);
		КонецЕсли;
		
		Если ВременныйФайлНеЗакрытыеЗН<>Неопределено Тогда 
			ИмяФайла="OpenZak_Report_"+Организация.Префикс+Формат(Период,"ДФ=yyyyMMdd")+".xml";
			FTPСоединение.Записать(ВременныйФайлНеЗакрытыеЗН,ИмяФайла);
			УдалитьФайлы(ВременныйФайлНеЗакрытыеЗН);
		КонецЕсли;

	КонецЕсли;
	
КонецПроцедуры

// ССА 2015-11-16 {
// }
Процедура ТТ_ВыгрузкаXMLОтчетаDBP(СтруктураПараметров) Экспорт
	
	ТТ_ВыгрузкаXMLОтчетов(СтруктураПараметров);
	Возврат;
	
	//ИспользоватьФТП = Истина;
	//Период = Неопределено;
	//ЕстьПериод = СтруктураПараметров.Свойство("Период",Период);
	//Если ЕстьПериод Тогда
	//	Период = ?(Период=Дата(1,1,1),ТекущаяДата(),Период);
	//Иначе
	//	Период = ТекущаяДата();
	//КонецЕсли; 	
	//
	//СтрокаСоединенияСБД =  СтрокаСоединенияИнформационнойБазы();
	//Основная = Найти(НРег(СтрокаСоединенияСБД), "alfa5_blank") = 1;
	//Если Основная Тогда 
	//	Возврат;	
	//КонецЕсли;
	//
	//Отчет = обПолучитьВнешнийОтчетОбъект("DBP");
	//Если Отчет = Неопределено Тогда
	//	Возврат;	
	//КонецЕсли; 
	//
	//Организация = ПараметрыСеанса.Организация;

	//СписокИсключитьСклDBP = Новый СписокЗначений;
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000007"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000009"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000010"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000011"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000055"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000105"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000107"));
	//СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000146"));	
	////СписокИсключитьСклDBP.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000102"));	
	//
	//Брэнд = Справочники.Модели.ПустаяСсылка();	 //Все
	//
	////*********** DBP ****************
	//
	////Отчет = ВнешниеОтчеты.Создать("\\10.50.19.4\public\IT\ВнешниеОтчеты\DBP.erf", Ложь);
	//		
	//ВременныйФайл = ПолучитьИмяВременногоФайла("xml");	
	//Запись =Новый ЗаписьXML;
	//Запись.ОткрытьФайл(ВременныйФайл);		
	//  
	////Установка стандартных параметров  	
	//ТекущаяСхемаКомпоновкиДанных = Отчет.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");	
	//Настройки = ТекущаяСхемаКомпоновкиДанных.НастройкиПоУмолчанию;
	//
	////редактирую настройки оставляю только одну группировку Бренд+Модель
	//Настройки.Структура.Очистить();
	//ГруппировкаМодель = Настройки.Структура.Добавить(Тип("ГруппировкаКомпоновкиДанных"));
	//ГруппировкаМодель.Использование = Истина;
	//ПолеМодель = ГруппировкаМодель.ПоляГруппировки.Элементы.Добавить(тип("ПолеГруппировкиКомпоновкиДанных"));
	//ПолеМодель.Использование = Истина;
	//ПолеМодель.Поле = Новый ПолеКомпоновкиДанных("Модель");
	//ПолеМодель = ГруппировкаМодель.ПоляГруппировки.Элементы.Добавить(тип("ПолеГруппировкиКомпоновкиДанных"));
	//ПолеМодель.Использование = Истина;
	//ПолеМодель.Поле = Новый ПолеКомпоновкиДанных("Автомобиль.Модель");
	//ВыбранныеПоляДляМодели = ГруппировкаМодель.Выбор.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
	//ВыбранныеПоляДляМодели.Использование = Истина;
	////Группировка ДетальныеЗаписи
	//ГруппировкаДетали = Настройки.Структура.Добавить(Тип("ГруппировкаКомпоновкиДанных"));
	//ГруппировкаДетали.Использование = Истина;
	//ВыбранныеПоляДляДетали = ГруппировкаДетали.Выбор.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
	//ВыбранныеПоляДляДетали.Использование = Истина;
	//
	////--------------
	//Модели = новый СписокЗначений;
	//Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000031"));
	//Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000332"));
	//Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000004"));
	//Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000124"));
	//Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000707"));
	//Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000353"));
	//Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000002"));
	//Модели.Добавить(Справочники.Модели.НайтиПоКоду("ЦБ00000006"));
	//
	//ТекущаяСхемаКомпоновкиДанных.Параметры["CобстМодели"].Значение =Модели;
	//ТекущаяСхемаКомпоновкиДанных.Параметры["Период"].Значение =Период;
	//ТекущаяСхемаКомпоновкиДанных.Параметры["Период"].ОграничениеИспользования = Истина;
	//ТекущаяСхемаКомпоновкиДанных.Параметры["Брэнд"].Значение = Брэнд;
	//ТекущаяСхемаКомпоновкиДанных.Параметры["СкладыИскл"].Значение =СписокИсключитьСклDBP;
	//
	////ТекущаяСхемаКомпоновкиДанных.НастройкиПоУмолчанию.ПараметрыВывода.Элементы[11].Значение = "Продажи автомобилей за " + Строка(Формат(Период, "ДЛФ=Д")); 
	//
	//КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	//МакетКомпоновки = КомпоновщикМакета.Выполнить(ТекущаяСхемаКомпоновкиДанных,Настройки,,,Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));

	//
	//ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
	//ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки);
	//ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
	//
	//ДеревоРезультат = Новый ДеревоЗначений;
	//ПроцессорВывода.УстановитьОбъект(ДеревоРезультат);
	//
	//ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);//вывод без обхода элементов 
	//
	////Удалю колонку "Автомобиль" из ДеревоРезультат
	//Колонка = ДеревоРезультат.Колонки.Найти("Автомобиль");
	//Если не Колонка = Неопределено Тогда 
	//	ДеревоРезультат.Колонки.Удалить(Колонка);	
	//КонецЕсли;
	////Обход значений ДеревоРезультат
	//Запись.ЗаписатьНачалоЭлемента("СтрокиОтчета");
	//Запись.ЗаписатьНачалоАтрибута("Организация");
	//Запись.ЗаписатьТекст(Строка(Организация));
	//Запись.ЗаписатьКонецАтрибута();
	//Запись.ЗаписатьНачалоАтрибута("Период");
	//Запись.ЗаписатьТекст(Формат(Период,"ДФ=yyyyMMdd"));
	//Запись.ЗаписатьКонецАтрибута();
	//Для Каждого СтрокаОтчета Из ДеревоРезультат.Строки Цикл
	//	Если СтрокаОтчета["АвтомобильМодель"]<>Неопределено Тогда 
	//		Запись.ЗаписатьНачалоЭлемента("Строка");
	//		Для Каждого Колонка Из ДеревоРезультат.Колонки Цикл
	//			Запись.ЗаписатьНачалоАтрибута(Колонка.Имя);
	//			Если Колонка.Имя = "Модель" Или Колонка.Имя = "АвтомобильМодель" Тогда 
	//				Запись.ЗаписатьТекст(ИсправитьСтроку(Строка(СтрокаОтчета[Колонка.Имя])));
	//			Иначе	
	//				Запись.ЗаписатьТекст(Строка(СтрокаОтчета[Колонка.Имя]));
	//			КонецЕсли;
	//			Запись.ЗаписатьКонецАтрибута();
	//		КонецЦикла;
	//		Запись.ЗаписатьКонецЭлемента();
	//	КонецЕсли;
	//КонецЦикла;
	//Запись.ЗаписатьКонецЭлемента();
	//Запись.Закрыть();
	//
	//ДеревоРезультат = Неопределено;

	//Если ИспользоватьФТП Тогда
	//	АдресСайта = "185.18.110.114" ;
	//	Порт = 21;
	//	Логин = "exch";
	//	Пароль = "meridian";
	//	ИмяКаталога = "/";
	//	FTPСоединение = Новый FTPСоединение(АдресСайта,Порт,Логин,Пароль);
	//	FTPСоединение.УстановитьТекущийКаталог(ИмяКаталога);
	//	ИмяФайла="DBP_Report_"+Организация.Префикс+".xml";
	//	FTPСоединение.Записать(ВременныйФайл,ИмяФайла);
	//	УдалитьФайлы(ВременныйФайл);
	//КонецЕсли;
	
КонецПроцедуры

Процедура ТТ_ВыгрузкаСтока(СтруктураПараметров) Экспорт
	
	Обр= ВнешниеОбработки.Создать("\\files\public\ВнешниеОбработки\ВыгрузкаАвто.epf",Ложь);
	Обр.ВыгрузитьЛада();
	Обр.ВыгрузитьУАЗ();
	
КонецПроцедуры

Процедура ТТ_Шаблон(СтруктураПараметров) Экспорт
	// Вставить содержимое обработчика.
КонецПроцедуры

// ССА 2016-04-04 {
// }
Процедура ТТ_ОтправитьОстаткиГаз(СтруктураПараметров) Экспорт
Период = Неопределено; 
	ЕстьПериод = СтруктураПараметров.Свойство("Период",Период);
	Если ЕстьПериод Тогда
		Период = ?(Период=Дата(1,1,1),ТекущаяДата(),Период); 
	Иначе 
		Период = ТекущаяДата(); 
	КонецЕсли; 
	Отчет = Отчеты.ОстаткиАвтомобилей.Создать(); 
	Если Отчет <> Неопределено Тогда
		Файлы = Новый Массив;
		ТабДок = Новый ТабличныйДокумент;
		ТекущаяСхемаКомпоновкиДанных = Отчет.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");
		КомпоновщикНастроек = Отчет.КомпоновщикНастроек;
		КомпоновщикНастроек.Настройки.ПараметрыДанных.УстановитьЗначениеПараметра("ДатаОкончания",Период);
		Настройки = КомпоновщикНастроек.Настройки;
		Настройки.Структура.Очистить();
		ГруппировкаСклад = Настройки.Структура.Добавить(Тип("ГруппировкаКомпоновкиДанных"));
		ГруппировкаСклад.Использование = Истина;
		ПолеСклад = ГруппировкаСклад.ПоляГруппировки.Элементы.Добавить(тип("ПолеГруппировкиКомпоновкиДанных"));
		ПолеСклад.Использование = Истина;
		ПолеСклад.Поле = Новый ПолеКомпоновкиДанных("СкладКомпании");
		ВыбранныеПоля = ГруппировкаСклад.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
		ВыбранныеПоля.Использование = Истина; ВыбранныеПоля.Поле = Новый ПолеКомпоновкиДанных("СкладКомпании");
		ВыбранныеПоля = ГруппировкаСклад.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
		ВыбранныеПоля.Использование = Истина;
		ВыбранныеПоля.Поле = Новый ПолеКомпоновкиДанных("Количество");
		ГруппировкаДетали = ГруппировкаСклад.Структура.Добавить(Тип("ГруппировкаКомпоновкиДанных"));
		ГруппировкаДетали.Использование = Истина;
		ВыбранныеПоля = ГруппировкаДетали.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
		ВыбранныеПоля.Использование = Истина;
		ВыбранныеПоля.Поле = Новый ПолеКомпоновкиДанных("Автомобиль");
		ВыбранныеПоля = ГруппировкаДетали.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
		ВыбранныеПоля.Использование = Истина; ВыбранныеПоля.Поле = Новый ПолеКомпоновкиДанных("Количество");
		ВыбранныеПоля = ГруппировкаДетали.Выбор.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
		ВыбранныеПоля.Использование = Истина;
		ВыбранныеПоля.Поле = Новый ПолеКомпоновкиДанных("Автомобиль.Комментарий");
		ЭлементОтбора = Настройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Автомобиль.Модель");
		ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.ВИерархии;
		ЭлементОтбора.ПравоеЗначение = Справочники.Модели.НайтиПоКоду("ЦБ00000332");
		Порядок = Настройки.Порядок.Элементы.Добавить(Тип("ЭлементПорядкаКомпоновкиДанных"));
		Порядок.Поле = Новый ПолеКомпоновкиДанных("Автомобиль.Наименование");
		Порядок.Использование = Истина;
		Порядок.ТипУпорядочивания = НаправлениеСортировкиКомпоновкиДанных.Возр;
		ПараметрВывода = Настройки.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных

("РасположениеРеквизитов"));
		ПараметрВывода.Использование = Истина;
		ПараметрВывода.Значение = РасположениеРеквизитовКомпоновкиДанных.Отдельно;
		ПараметрВывода = Настройки.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Заголовок"));
		ПараметрВывода.Использование = Истина; ПараметрВывода.Значение = "Остатки автомобилей";
		ДанныеРасшифровки = Новый ДанныеРасшифровкиКомпоновкиДанных;
		КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
		МакетКомпоновки = КомпоновщикМакета.Выполнить(ТекущаяСхемаКомпоновкиДанных, Настройки, ДанныеРасшифровки);
		ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
		ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки, , ДанныеРасшифровки);
		ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
		ПроцессорВывода.УстановитьДокумент(ТабДок); ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);
		ИмяФайла = КаталогВременныхФайлов() + "ГАЗ ТТ "+Формат(Период,"ДФ=yyyy-MM-dd")+".xls";
		ТабДок.Записать(ИмяФайла,ТипФайлаТабличногоДокумента.XLS);
		Файлы.Добавить(ИмяФайла);
		Тема = "Остатки ГАЗ по ТТ " + Формат(Период,"ДФ=yyyy-MM-dd");
		Получатели = Новый Массив; Получатели.Добавить("s.savkin@tempauto.net");
		СлепыеПолучатели = Новый Массив; ТекстПисьма="Сформировано автоматически.";
		Обр = Обработки.ОтправкаПочты.Создать();
		Обр.ОтправитьEmail(Получатели,Тема,ТекстПисьма,Файлы,СлепыеПолучатели);
	КонецЕсли;
КонецПроцедуры

//-----------Состояние заказов и окраска в списке---------
Процедура ТТ_ПроверитьСостояниеЗаказов(СтруктураПараметров) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЗаказПокупателя.Ссылка
	|ИЗ
	|	Документ.ЗаказПокупателя КАК ЗаказПокупателя
	|ГДЕ
	|	ЗаказПокупателя.Проведен = ИСТИНА
	|	И ЗаказПокупателя.Дата > &Дата";
	
	Запрос.УстановитьПараметр("Дата", (ТекущаяДата() - 120*24*60*60));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выгрузить();
	
	Для Каждого Заказ Из ВыборкаДетальныеЗаписи Цикл
		
		ТаблЗаказа = Заказ.Ссылка.ПолучитьОбъект().ПолучитьДвиженияЗаказа();
		//ТаблЗаказа.Свернуть("","Заказано,Зарезервировано,Распределено,СкладОстаток,СкладЗарезервировано");
		ТекСостояние = 5;
		Если ТаблЗаказа.Количество()>0 Тогда
			Для каждого стрЗаказа ИЗ ТаблЗаказа Цикл
				ТекСтрЗаказ = стрЗаказа;
				//Раскрасим в зависимости от состояния заказа
				Если ТекСтрЗаказ.Заказано = 0 Тогда
					//Номенклатура не отпущена
					Если ТекСостояние > 3 Тогда ТекСостояние = 4 КонецЕсли; //Отпущена  //Серый
				ИначеЕсли (ТекСтрЗаказ.СкладОстаток-ТекСтрЗаказ.СкладЗарезервировано)>0 Тогда
					//Номенклатура есть на складе
					Если ТекСостояние > 2 Тогда ТекСостояние = 3 КонецЕсли;//Есть на складе и собран //ЗеленыйЦвет 
				ИначеЕсли ТекСтрЗаказ.Зарезервировано>0 Тогда
					//Номенклатура зарезервирована на складе
					Если ТекСостояние > 2 Тогда ТекСостояние = 3 КонецЕсли;//Есть на складе и собран //ЗеленыйЦвет
				ИначеЕсли ТекСтрЗаказ.Распределено>0 Тогда
					//Номенклатура распределена по заказам поставщиков
					Если ТекСостояние > 1 Тогда ТекСостояние = 2 КонецЕсли;//Есть ЗАКАЗ, но не собран //ЖелтыйЦвет
				ИначеЕсли ТекСтрЗаказ.Заказано>0 Тогда
					//Номенклатура не отпущена
					Если ТекСостояние > 0 Тогда ТекСостояние = 1 КонецЕсли;;//нет заказа поставщику //КрасныйЦвет
				Иначе
					//Прочие ситуации
					ТекСостояние = 0;
				КонецЕсли; 
			КонецЦикла;
		КонецЕсли; 
		ЗаписатьЗначСвСостояниеЗаказов(Заказ.Ссылка, ТекСостояние);
	КонецЦикла;	
	
КонецПроцедуры

Процедура ЗаписатьЗначСвСостояниеЗаказов(Объект, Значение)
	СвойствоСостояниеЗаказа = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Состояние заказа"); //Состояние заказа
	НАбЗап = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();
	НабЗап.Отбор.Объект.Установить(Объект);
	НАбЗап.Отбор.Свойство.Установить(СвойствоСостояниеЗаказа);
	Набзап.Прочитать();
	Если набзап.Количество() > 0 Тогда
		Набзап[0].Значение = Значение;
	Иначе
		новЗап = набзап.Добавить();
		Новзап.Объект = Объект;
		новзап.Свойство = СвойствоСостояниеЗаказа;
		НовЗап.Значение = Значение;
	КонецЕсли;
	
	Попытка
		набзап.Записать();	
	Исключение
	КонецПопытки;
КонецПроцедуры

Функция ПравильныйАртикул(Стр)
	тмп = "";   
	стрБезПробелов = СокрЛП(стр);
	
	Для сч = 1 по стрДлина(стрБезПробелов) цикл
		Символ = Сред(стр, сч, 1);
		
		Если КодСимвола(Символ) >= КодСимвола("0") и КодСимвола(Символ) <= КодСимвола("9") Тогда
			тмп = тмп + Символ;
		КонецЕсли;	
		
	КонецЦикла;		
	
	Возврат тмп;
КонецФункции	

Процедура БТ_ВыгрузкаОстатковВАА6() Экспорт
	Текст =  Новый ТекстовыйДокумент;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ОстаткиТоваровКомпанииОстатки.Номенклатура.Артикул КАК НоменклатураАртикул,
		|	ОстаткиТоваровКомпанииОстатки.Номенклатура.Производитель КАК НоменклатураПроизводитель,
		|	ОстаткиТоваровКомпанииОстатки.КоличествоОстаток КАК КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.ОстаткиТоваровКомпании.Остатки КАК ОстаткиТоваровКомпанииОстатки
		|ГДЕ
		|	ОстаткиТоваровКомпанииОстатки.КоличествоОстаток > 0";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Текст.ДобавитьСтроку(ПравильныйАртикул(ВыборкаДетальныеЗаписи.НоменклатураАртикул)+";"+ВыборкаДетальныеЗаписи.НоменклатураПроизводитель+";"+ВыборкаДетальныеЗаписи.КоличествоОстаток);
	КонецЦикла;
	
	Если НайтиФайлы("c:\Остатки\").Количество() = 0 Тогда
		СоздатьКаталог("c:\Остатки\");
	КонецЕсли;
	Текст.Записать("c:\Остатки\остатки.txt");

КонецПроцедуры	

//--------Состояние заказов и окраска в списке-----Конец------

//allgk получение почты газ
Процедура ТТ_ПолучениеПочтыСайтГАЗ(ПАР1) Экспорт
	//Обр = Обработки.ТТ_ПолучениеПочтыССайта.Создать();
	//Обр.ПолучитьПочту();
	ПолучитьПочтуГАЗ();
КонецПроцедуры

Процедура ПолучитьПочтуГАЗ() Экспорт
	Почта = Новый ИнтернетПочта;
	Попытка
		Почта.Подключиться(ПолучитьПрофильГАЗ());
	Исключение
		//Сообщить(ОписаниеОшибки()); 
		Возврат;
	КонецПопытки;
	
	Заголовки=Почта.ПолучитьЗаголовки();
	
	// Загрузка сообщений в массив
	Сообщения = Почта.Выбрать(Ложь,Заголовки);
	
	Для каждого Сообщение Из Сообщения Цикл
		Если Строка(Сообщение.тема) = "Заявка на сервис с сайта ГАЗ (Краснодар)" Тогда
			Дата = Сообщение.ДатаОтправления;
			ТекстВходящие=""; 
			Текст = Сообщение.Тексты[0].Текст;
			Текст = СокрЛП(Текст);
			СтруктураПолей = ПолучитьПоляИзТекстаГАЗ(Сообщение.Тема, Текст, Дата);
			ДобавитьЗаписьГАЗ(СтруктураПолей);
		КонецЕсли;
	КонецЦикла; 
	Почта.Отключиться();
	//сообщить("Почта.Отключиться();");	
КонецПроцедуры

Функция ПолучитьПрофильГАЗ()экспорт
	
	Профиль = Новый ИнтернетПочтовыйПрофиль;	
	// SMTP сервер
	Профиль.АдресСервераSMTP = "mail.tempauto.net";	
	// Порт SMTP сервера
	Профиль.ПортSMTP = 25;	
	// POP3 сервер
	Профиль.АдресСервераPOP3 = "mail.tempauto.net";	
	// Порт POP3 сервера
	Профиль.ПортPOP3 = 110;	
	// Пароль к почтовому ящику
	Профиль.Пароль = "qceDEJ";	
	// Пароль пользователя для SMTP сервера
	Профиль.ПарольSMTP = "qceDEJ";	
	// Логин пользователя
	Профиль.Пользователь = "zayavkagaz@tempauto.net";	
	// Логин пользователя для SMTP сервера
	Профиль.ПользовательSMTP = "zayavkagaz@tempauto.net";	
	// Время ожидания выполнения операции в секундах	
	Профиль.ВремяОжидания = 50; 
	Возврат Профиль;
	
КонецФункции

Функция  ПолучитьПоляИзТекстаГАЗ(Тема,Текст,Дата)экспорт
	ФИО = "";
	тел = "";
	почта = "";
	Зап = Ложь;
	ц=0;
	
	Для й=2 по СтрДлина(Текст) Цикл
		Если зап тогда
			Если Сред(Текст, й, 1) = "<" Тогда 
				зап = Ложь;
				Продолжить;
			КонецЕсли;
			
			Если ц=1 тогда //ФИО
				ФИО=ФИО+Сред(Текст, й, 1);
			ИначеЕсли ц=2 Тогда //телефон
				тел=тел+сред(Текст,й,1);
			ИначеЕсли ц=3 Тогда //почта
				почта=почта+сред(Текст,й,1);
			Иначе
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Если Сред(Текст, й-1, 2) = ">:" Тогда
			Зап = Истина;
			ц=ц+1;
		КонецЕсли;
	КонецЦикла;
	СтруктураПолей = Новый структура;	
	СтруктураПолей.Вставить("ФИО", СокрЛП(ФИО));
	СтруктураПолей.Вставить("Телефон", СокрЛП(тел));	
	СтруктураПолей.Вставить("ЭлПочта", СокрЛП(почта));
	СтруктураПолей.Вставить("Тема",Тема);
	СтруктураПолей.Вставить("Дата",Дата);
	
	Возврат СтруктураПолей;
КонецФункции

Процедура ДобавитьЗаписьГАЗ(СтруктураПолей)экспорт
		НаборЗаписей = РегистрыСведений.ТТ_ЗаявкиССайта.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Дата.Установить(СтруктураПолей.Дата);
		НаборЗаписей.Отбор.Тема.Установить(СтруктураПолей.Тема);
		НаборЗаписей.Прочитать();		
		Если НаборЗаписей.Количество() > 0 Тогда
			Возврат;            //значит уже есть.
		КонецЕсли;	
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.Дата = СтруктураПолей.Дата;
		НоваяЗапись.Тема = СтруктураПолей.Тема;
		НоваяЗапись.ФИО = СтруктураПолей.ФИО;
		НоваяЗапись.тел = СтруктураПолей.Телефон;
		НоваяЗапись.почта = СтруктураПолей.ЭлПочта;
		попытка
			НаборЗаписей.Записать();
		исключение
		конецпопытки;
КонецПроцедуры

Процедура ТТ_ПереносДатыПлатежаЗаявокДС(СтруктураПараметров) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаявкаНаРасходДС.Ссылка
		|ИЗ
		|	Документ.ЗаявкаНаРасходДС КАК ЗаявкаНаРасходДС
		|ГДЕ
		|	ЗаявкаНаРасходДС.СтатусТТ = &СтатусТТ
		|	И ЗаявкаНаРасходДС.ПометкаУдаления = ЛОЖЬ";
	
	Запрос.УстановитьПараметр("СтатусТТ", Перечисления.ТТ_СтатусыЗаявкиНаРасходДС.Заявка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	ТекДата=НачалоДня(ТекущаяДата());
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Док=ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект();
		УстанавливатьДату=Ложь;
		Для Каждого Стр Из Док.Платежи Цикл
			Если НЕ обЗначениеНеЗаполнено(Стр.ДатаПлатежа) И ТекДата > Стр.ДатаПлатежа Тогда
				Стр.ДатаПлатежа =ТекДата;
				УстанавливатьДату=Истина;
			КонецЕсли;
		КонецЦикла;
		
		Если УстанавливатьДату Тогда 
			Док.ДатаПлатежа=ТекДата;
			Док.ОбменДанными.Загрузка=Истина;
			Попытка
				Док.Записать();
			Исключение
			КонецПопытки;
		КонецЕсли;
		
	КонецЦикла;

	
КонецПроцедуры






//allgk получение почты газ

