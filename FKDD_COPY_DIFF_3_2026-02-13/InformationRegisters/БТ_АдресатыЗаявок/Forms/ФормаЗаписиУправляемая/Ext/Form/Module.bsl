
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	ГруппаНовыхЗаявок();

	ДанныеДляПроверки = Новый Структура;
	ДанныеДляПроверки.Вставить("Запись", Запись);
	ДоступныеРоли = БТ_БизнесПроцессы.ПолучитьМассивПрименяемыхРолей(Запись.ВидЗаявки);
	Элементы.Роль.СписокВыбора.Очистить();

	Если ДоступныеРоли <> Неопределено Тогда

		Элементы.Роль.СписокВыбора.ЗагрузитьЗначения(ДоступныеРоли);

	КонецЕсли;

	Элементы.Комментарий.Видимость = Истина;
	
	Если НЕ ЗначениеЗаполнено(Параметры.Ключ) Тогда   
		
		Сообщить("Не забудьте Записать/перезаписать Детальную настройку условий!"); 
		
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Процедура НастроитьУсловиеОтбора(Команда)   
	
	ГруппаНовыхЗаявок();     
	
	Если ГруппаНовыхЗаявок Тогда  
		
		КлючУникальности  		= Новый УникальныйИдентификатор;
		ПередаваемаяСтруктура	= Новый Структура("ЗакрыватьПриВыборе, ВидЗаявки, Роль, Согласующий, УсловиеОтбораКомпановка", Истина, Запись.ВидЗаявки, Запись.Роль, Запись.Согласующий, ЗаписьУсловиеОтбораКомпановка());
		
		ОткрытьФорму("РегистрСведений.БТ_АдресатыЗаявок.Форма.ФормаНастройкиОтбораКомпоновка", ПередаваемаяСтруктура, ЭтаФорма); 
		
	Иначе
		
		Форма = ПолучитьФорму("РегистрСведений.БТ_АдресатыЗаявок.Форма.ФормаНастройкиОтбора");
		Форма.ЗакрыватьПриВыборе	= Истина;
		Форма.ВладелецФормы			= ЭтаФорма;
		Форма.ВидЗаявки				= Запись.ВидЗаявки;
		Форма.ИтоговаяСтрока		= Запись.УсловиеОтбора;
		Форма.РазобратьИтоговуюСтрокуНажатие(Неопределено);
		Форма.Открыть();
		
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ГруппаНовыхЗаявок()
	ГруппаНовыхЗаявок = Истина;//Перечисления.БТ_ВидыЗаявок.ГруппаНовыхЗаявок(Запись.ВидЗаявки);
КонецПроцедуры

&НаСервере
Функция ЗаписьУсловиеОтбораКомпановка()
	ЗаписьОб = РегистрыСведений.БТ_АдресатыЗаявок.создатьменеджерзаписи();
	
	Если ЗначениеЗаполнено(Запись.ИсходныйКлючЗаписи.ВидЗаявки) Тогда
		
		ЗаполнитьЗначенияСвойств(ЗаписьОб, Запись.ИсходныйКлючЗаписи);

	Иначе
		
		ЗаполнитьЗначенияСвойств(ЗаписьОб, ДанныеДляПроверки.Запись);

	КонецЕсли;
	
	ЗаписьОб.Прочитать();
	НастройкиАдресата = ЗаписьОб.УсловиеОтбораКомпановка;
	
	Возврат НастройкиАдресата;     
	
КонецФункции // ЗаписьУсловиеОтбораКомпановка()

&НаКлиенте
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	
	Если ТипЗнч(ИсточникВыбора) = Тип("ФормаКлиентскогоПриложения") Тогда 
		
		ПоместитьУсловиеОтбора(ВыбранноеЗначение.Хранилище);	
		УсловияОтбора.ЗагрузитьНастройки(ВыбранноеЗначение.НастройкиОтбора); 
		
	Иначе                             
		
		Если ТипЗнч(ВыбранноеЗначение) = Тип("Строка") Тогда 
			
			Запись.УсловиеОтбора = ВыбранноеЗначение;      
			
		ИначеЕсли ТипЗнч(ВыбранноеЗначение) = Тип("ХранилищеЗначения") Тогда  
			
			Запись.УсловиеОтбораКомпановка = ВыбранноеЗначение;
			Запись.УсловиеКомпановкаЗаполнено = Истина;   
			
		КонецЕсли; 
		
	КонецЕсли;
	
	УсловияСохранены = Истина;
	
КонецПроцедуры

&НаСервере
Процедура ПоместитьУсловиеОтбора(ВыбранноеЗначение)
	
	ЗаписьОб = ДанныеФормыВЗначение(Запись, Тип("РегистрСведенийМенеджерЗаписи.БТ_АдресатыЗаявок"));
	ЗаписьОб.УсловиеОтбораКомпановка 	= ВыбранноеЗначение;
	ЗаписьОб.УсловиеКомпановкаЗаполнено = Истина;
	ЗаписьОб.Записать();                
	
	ЗначениеВДанныеФормы(ЗаписьОб,Запись);
	
КонецПроцедуры	

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	Если ГруппаНовыхЗаявок Тогда
		
		ВидЗаявкиПеречислениеСтрокой = XMLСтрока(Запись.ВидЗаявки);
		ВидРолиСтрокой				 = XMLСтрока(Запись.Роль); 
		
		Если НЕ (ВидЗаявкиПеречислениеСтрокой = "" ИЛИ ВидРолиСтрокой = "") Тогда 
			
			БТ_СлужебныеФункции.ПоставитьОбъектВОчередьНаОбработку(Запись.Согласующий, "ПересчетАдресатов");
			
		Иначе
			
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = НСтр("ru = 'Для пересчета адресатов обратитесь на Helpdesk'; en = 'To recalculate the recipients, contact Helpdesk'");
			Сообщение.Сообщить();   
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПоказатьЗависимыеЗаявкиНаСервере(РасчитатьВсеЗаявки, ПересчитатьОтветственных = Ложь)
	
	ЗаписьОб = ДанныеФормыВЗначение(Запись,Тип("РегистрСведенийМенеджерЗаписи.БТ_АдресатыЗаявок"));
	НастройкиАдресата = ЗаписьОб.УсловиеОтбораКомпановка;
	ОтобранныеЗаявки = РегистрыСведений.БТ_АдресатыЗаявок.ПоискЗаявокДляСогласованияАдресата(Запись.ВидЗаявки, Запись.Роль, Запись.Согласующий, НастройкиАдресата, РасчитатьВсеЗаявки);
	Заявки = Новый СписокЗначений;
	Для Каждого ЭлементМассива Из ОтобранныеЗаявки Цикл
		Заявки.Добавить(ЭлементМассива.Значение.Заявка);
	КонецЦикла;

	СКД		= РегистрыСведений.БТ_АдресатыЗаявок.ПолучитьМакет("ЗависимыеЗаявки");
	СКД.Параметры.Заявка.Значение = Заявки; 
	
	Настройки					= СКД.ВариантыНастроек["Основной"].Настройки;
	ЗаявкаПараметр 				= Настройки.ПараметрыДанных.Элементы.Найти("Заявка");
	ЗаявкаПараметр.Значение 	= Заявки;
	ЗаявкаПараметр.Использование = Истина;
	
	КомпоновщикМакета	= Новый КомпоновщикМакетаКомпоновкиДанных;
	ТабДокРасшифровка	= Новый ДанныеРасшифровкиКомпоновкиДанных;
	МакетКомпоновки		= КомпоновщикМакета.Выполнить(СКД, Настройки, ТабДокРасшифровка);

	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки,,ТабДокРасшифровка);
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ТабДок.Очистить();
	ПроцессорВывода.УстановитьДокумент(ТабДок);
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);
	ТабДок.ОтображатьСетку		= Ложь;
	ТабДок.ОтображатьЗаголовки	= Ложь;	
	АдресДанныхРасшифровки 		= ПоместитьВоВременноеХранилище(ТабДокРасшифровка, ЭтаФорма.УникальныйИдентификатор);
	
	Если ПересчитатьОтветственных Тогда 
		
		РассчитанныеЗаявки = РегистрыСведений.БТ_АдресатыЗаявок.ДобавлениеНовыхЗаписейАдресата(ОтобранныеЗаявки, Запись.ВидЗаявки, Запись.Роль, Запись.Согласующий);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьВсеЗаявки(Команда)
	
	Если Модифицированность Тогда
		
		Сообщить("Перед пересчетом неободимо записать объект");
		
	Иначе
		
		Состояние("Пересчет ответственных по активным задачам");
		ПоставитьЗаданиеНаПересчет();
		
	КонецЕсли;
	
КонецПроцедуры  

Процедура ПоставитьЗаданиеНаПересчет()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	БТ_СогласованиеЗаявокДДС.Ссылка КАК Ссылка
		|ИЗ
		|	БизнесПроцесс.БТ_СогласованиеЗаявокДДС КАК БТ_СогласованиеЗаявокДДС
		|ГДЕ
		|	БТ_СогласованиеЗаявокДДС.Стартован
		|	И НЕ БТ_СогласованиеЗаявокДДС.Завершен
		|	И НЕ БТ_СогласованиеЗаявокДДС.ПометкаУдаления";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл  
		
		БТ_БизнесПроцессы.ЗаписатьТаблицуОтветственныхВРегистр_Нов(ВыборкаДетальныеЗаписи.Ссылка, Запись.Роль);
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьЗависимыеЗаявки(Команда)
	
	ПоказатьЗависимыеЗаявкиНаСервере(Ложь); 
	
КонецПроцедуры

&НаКлиенте
Процедура ТабДокОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	СтруктураДанныхРасшифровки = ПолучитьИзВременногоХранилища(АдресДанныхРасшифровки);
	ЭлементРасшифровки = СтруктураДанныхРасшифровки.Элементы.Получить(Расшифровка).ПолучитьПоля();
	ОткрытьЗначение(ЭлементРасшифровки[0].Значение); 
	
КонецПроцедуры

&НаКлиенте
Процедура ВидЗаявкиПриИзменении(Элемент)
	
	ГруппаНовыхЗаявок();
	ДоступныеРоли = БТ_БизнесПроцессы.ПолучитьМассивПрименяемыхРолей(Запись.ВидЗаявки);
	Элементы.Роль.СписокВыбора.Очистить();

	Если ДоступныеРоли <> Неопределено Тогда

		Элементы.Роль.СписокВыбора.ЗагрузитьЗначения(ДоступныеРоли);

	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	#Если ТонкийКлиент ИЛИ ВебКлиент Тогда
		
		Если (Модифицированность Или НЕ ЗначениеЗаполнено(Запись.Согласующий)) И НЕ УсловияСохранены Тогда
			
			Сообщить("Сохраните условия отбора");
			Отказ = Истина;
			
		КонецЕсли;
		
	#Иначе
		
		Если (Модифицированность Или НЕ ЗначениеЗаполнено(Запись.ИсходныйКлючЗаписи.Согласующий)) И НЕ УсловияСохранены Тогда
			
			Сообщить("Сохраните условия отбора");
			Отказ = Истина;
			
		КонецЕсли;
		
	#КонецЕсли
	
КонецПроцедуры

&НаКлиенте
Процедура СогласующийПриИзменении(Элемент)

КонецПроцедуры

&НаКлиенте
Процедура ПоказатьНезавершенныеЗаявки(Команда)
	
	ПоказатьЗависимыеЗаявкиНаСервере(Истина);
	
КонецПроцедуры