
&НаСервере
Процедура УдалитьЭлементыГруппы(ПодчиненныеЭлементы) Экспорт
	
	КоличествоПодчиненных = ПодчиненныеЭлементы.Количество()-1;
	Пока КоличествоПодчиненных >= 0 Цикл
		Элементы.Удалить(ПодчиненныеЭлементы[КоличествоПодчиненных]);
		КоличествоПодчиненных = КоличествоПодчиненных - 1;
	КонецЦикла;
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ СЕРВЕР

&НаСервере
Процедура ИзменитьПараметрыИзбранного(СтруктураПараметров)
	
	ОтчетОбъект = РеквизитФормыВЗначение("Отчет");
	Менеджер = "Отчеты." + ОтчетОбъект.Метаданные().Имя;
	СтруктураПараметров.Вставить("ИмяОтчета", ОтчетОбъект.Метаданные().Имя);
	
	НаименованиеОтчета = ?(ОтчетОбъект.Метаданные().Синоним = "", ОтчетОбъект.Метаданные().Имя, ОтчетОбъект.Метаданные().Синоним);
	НаименованиеОтчета = "Отчет: " + НаименованиеОтчета;
	
	СтруктураПараметров.Вставить("Наименование", НаименованиеОтчета);
	СтруктураПараметров.Вставить("Менеджер",     Менеджер);
	
КонецПроцедуры	//	ИзменитьПараметрыИзбранного()

&НаСервере
Процедура ОбновитьСписокВариантовОтчета(КлючВарианта)
	
	СписокВыбора = Элементы.ТекстВариантНастройки.СписокВыбора;
	СписокВыбора.Очистить();
	
	СписокВариантов = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьСписок(КлючОтчета);
	Для Каждого ТекЭлемент Из СписокВариантов Цикл
		Элементы.ТекстВариантНастройки.СписокВыбора.Добавить(ТекЭлемент.Значение, ТекЭлемент.Представление);
	КонецЦикла;
	
	ТекПозиция = Элементы.ТекстВариантНастройки.СписокВыбора.НайтиПоЗначению(КлючВарианта);
	Если НЕ ТекПозиция = Неопределено Тогда
		ЭтаФорма.КлючТекущегоВарианта  = ТекПозиция.Значение;
		ЭтаФорма.ТекстВариантНастройки = ТекПозиция.Представление;
	ИначеЕсли ЭтаФорма.ТекстВариантНастройки = "" Тогда
		Если Элементы.ТекстВариантНастройки.СписокВыбора.Количество()>0 Тогда
			ТекПозиция = Элементы.ТекстВариантНастройки.СписокВыбора[0];
			ЭтаФорма.КлючТекущегоВарианта  = ТекПозиция.Значение;
			ЭтаФорма.ТекстВариантНастройки = ТекПозиция.Представление;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
// Процедура сохраняет настройки формы.
//
Процедура СохранитьНастройкиФормы(ИмяФормы, СтруктураНастроек)
	
	ХранилищеНастроекДанныхФорм.Сохранить(ИмяФормы, "СтруктураНастроек", СтруктураНастроек);
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗаполнитьНастройку(Элемент, СтруктураНастроек, ИмяПоля)
	
	Если СтруктураНастроек.Свойство(ИмяПоля) Тогда
		Элемент = СтруктураНастроек[ИмяПоля];
	КонецЕсли;
	
КонецПроцедуры

// Процедура загружает настройки формы.
//
&НаСервере
Процедура ЗагрузитьНастройкиФормы()
	
	СтруктураНастроек = ХранилищеНастроекДанныхФорм.Загрузить(ИмяФормыОтчета, "СтруктураНастроек");
	Если ТипЗнч(СтруктураНастроек) = Тип("Структура") Тогда
		
		ЗаполнитьНастройку(ЭтаФорма.КлючТекущегоВарианта,  СтруктураНастроек, "КлючТекущегоВарианта");
		ЗаполнитьНастройку(ЭтаФорма.ТекстВариантНастройки, СтруктураНастроек, "ТекстВариантНастройки");
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗаполнитьПоляПробнойКомпоновки(ТекСтруктура, ПоляТаблицы)
	
	Если ТипЗнч(ТекСтруктура) = Тип("НастройкиКомпоновкиДанных") Тогда
		
		Для Каждого ТекЭлемент Из ТекСтруктура.Выбор.Элементы Цикл
			Если ТипЗнч(ТекЭлемент) = Тип("АвтоВыбранноеПолеКомпоновкиДанных") Тогда
				
			ИначеЕсли ТипЗнч(ТекЭлемент) = Тип("ГруппаВыбранныхПолейКомпоновкиДанных") Тогда
				
			Иначе
				НовоеПоле = ПоляТаблицы.Добавить(Тип("ПолеНабораДанныхСхемыКомпоновкиДанных"));
				НовоеПоле.Поле        = СтрЗаменить(ТекЭлемент.Поле, ".", "");
				НовоеПоле.ПутьКДанным = Строка(ТекЭлемент.Поле);
				//НовоеПоле.Заголовок   = 
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого ТекЭлемент Из ТекСтруктура.Порядок.Элементы Цикл
			
			Если ТипЗнч(ТекЭлемент) = Тип("ЭлементПорядкаКомпоновкиДанных") Тогда
				НовоеПоле = ПоляТаблицы.Добавить(Тип("ПолеНабораДанныхСхемыКомпоновкиДанных"));
				НовоеПоле.Поле        = СтрЗаменить(ТекЭлемент.Поле, ".", "");
				НовоеПоле.ПутьКДанным = Строка(ТекЭлемент.Поле);
				//НовоеПоле.Заголовок   = 
			КонецЕсли;
			
		КонецЦикла;
		
		Для Каждого Структура Из ТекСтруктура.Структура Цикл
			ЗаполнитьПоляПробнойКомпоновки(Структура, ПоляТаблицы);
		КонецЦикла;
		
	ИначеЕсли ТипЗнч(ТекСтруктура) = Тип("ГруппировкаКомпоновкиДанных") ИЛИ 
			ТипЗнч(ТекСтруктура) = Тип("ГруппировкаТаблицыКомпоновкиДанных") Тогда
		
		Для Каждого ТекЭлемент Из ТекСтруктура.Выбор.Элементы Цикл
			Если ТипЗнч(ТекЭлемент) = Тип("АвтоВыбранноеПолеКомпоновкиДанных") Тогда
				
			ИначеЕсли ТипЗнч(ТекЭлемент) = Тип("ГруппаВыбранныхПолейКомпоновкиДанных") Тогда
				
			Иначе
				НовоеПоле = ПоляТаблицы.Добавить(Тип("ПолеНабораДанныхСхемыКомпоновкиДанных"));
				НовоеПоле.Поле        = СтрЗаменить(ТекЭлемент.Поле, ".", "");
				НовоеПоле.ПутьКДанным = Строка(ТекЭлемент.Поле);
				//НовоеПоле.Заголовок   = 
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого ТекЭлемент Из ТекСтруктура.Порядок.Элементы Цикл
			Если ТипЗнч(ТекЭлемент) = Тип("ЭлементПорядкаКомпоновкиДанных") Тогда
				НовоеПоле = ПоляТаблицы.Добавить(Тип("ПолеНабораДанныхСхемыКомпоновкиДанных"));
				НовоеПоле.Поле        = СтрЗаменить(ТекЭлемент.Поле, ".", "");
				НовоеПоле.ПутьКДанным = Строка(ТекЭлемент.Поле);
			КонецЕсли;
			//НовоеПоле.Заголовок   = 
		КонецЦикла;
		
		Для Каждого ТекЭлемент Из ТекСтруктура.ПоляГруппировки.Элементы Цикл
			НовоеПоле = ПоляТаблицы.Добавить(Тип("ПолеНабораДанныхСхемыКомпоновкиДанных"));
			НовоеПоле.Поле        = СтрЗаменить(ТекЭлемент.Поле, ".", "");
			НовоеПоле.ПутьКДанным = Строка(ТекЭлемент.Поле);
			//НовоеПоле.Заголовок   = 
		КонецЦикла;
		
		Для Каждого Структура Из ТекСтруктура.Структура Цикл
			ЗаполнитьПоляПробнойКомпоновки(Структура, ПоляТаблицы);
		КонецЦикла;
		
	ИначеЕсли ТипЗнч(ТекСтруктура) = Тип("ТаблицаКомпоновкиДанных") Тогда
		
		Для Каждого Структура Из ТекСтруктура.Строки Цикл
			ЗаполнитьПоляПробнойКомпоновки(Структура, ПоляТаблицы);
		КонецЦикла;
		
		Для Каждого Структура Из ТекСтруктура.Колонки Цикл
			ЗаполнитьПоляПробнойКомпоновки(Структура, ПоляТаблицы);
		КонецЦикла;
		
	ИначеЕсли ТипЗнч(ТекСтруктура) = Тип("ДиаграммаКомпоновкиДанных") Тогда
		
		Для Каждого Структура Из ТекСтруктура.Серии Цикл
			ЗаполнитьПоляПробнойКомпоновки(Структура, ПоляТаблицы);
		КонецЦикла;
		
		Для Каждого Структура Из ТекСтруктура.Точки Цикл
			ЗаполнитьПоляПробнойКомпоновки(Структура, ПоляТаблицы);
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьВнешниеНаборы(ПоляТаблицы, ДоступныеПоляВыбора)
	
	ВнешниеНаборы = Новый Структура;
	ТаблицаИсточник = Новый ТаблицаЗначений;
	Для Каждого ТекПоле Из ПоляТаблицы Цикл
		ТаблицаИсточник.Колонки.Добавить(ТекПоле.Поле);
	КонецЦикла;
	
	НоваяСтрока = ТаблицаИсточник.Добавить();
	Для Каждого ТекПоле Из ПоляТаблицы Цикл
		ПолеКомпоновки = Новый ПолеКомпоновкиДанных(ТекПоле.ПутьКДанным);
		НайденноеПоле = ДоступныеПоляВыбора.НайтиПоле(ПолеКомпоновки);
		Если (НЕ НайденноеПоле = Неопределено) И НайденноеПоле.ТипЗначения.Типы()[0]=Тип("Число") Тогда
			НоваяСтрока[ТекПоле.Поле] = "0";
		Иначе
			НоваяСтрока[ТекПоле.Поле] = ТекПоле.ПутьКДанным;
		КонецЕсли;
		
	КонецЦикла;
	
	ВнешниеНаборы.Вставить("ТаблицаИсточник", ТаблицаИсточник);

	Возврат ВнешниеНаборы;
	
КонецФункции

&НаСервере
Процедура ИзменитьВариантОтчета()
	
	Для Каждого ТекПараметр Из ПараметрыКомпоновки Цикл
		ПараметрыКомпоновки.Вставить(ТекПараметр.Ключ, ЭтаФорма[ТекПараметр.Ключ]);
	КонецЦикла;
	
	Настройки = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьНастройки(ЭтаФорма.КлючОтчета, ЭтаФорма.КлючТекущегоВарианта);
	
	Если НЕ Настройки = Неопределено Тогда
		Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
		Для Каждого ТекПараметр Из Отчет.КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы Цикл
			ИмяПараметра = "Параметр" + СокрЛП(ТекПараметр.Параметр);
			ЭлементПараметра = Элементы.Найти(ИмяПараметра);
			Если ЭлементПараметра = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			ЭтаФорма[ЭлементПараметра.ПутьКДанным] = ТекПараметр.Значение;
		КонецЦикла;
		
	КонецЕсли;
	
	ТекущийВариант = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьВариантОтчета(ЭтаФорма.КлючОтчета, ЭтаФорма.КлючТекущегоВарианта);
	Если ТекущийВариант = Неопределено Тогда
		//	
	Иначе
		ВосстановитьНастройкиАРМ();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеФормы(ЗаполнитьНастроки = Истина)
	
	РеквизитыФормы = ПолучитьРеквизиты();
	
	МассивУникальныхЭлементов = Новый Массив;
	Для Каждого ТекРеквизит Из РеквизитыФормы Цикл
		МассивУникальныхЭлементов.Добавить(ТекРеквизит.Имя);
	КонецЦикла;
	
	ПараметрыКомпоновки = Новый Структура;
	
	// Добавление реквизитов для завязки на параметры данных
	МассивНовыхРеквизитов = Новый Массив;
	Для Каждого ТекПараметр Из Отчет.КомпоновщикНастроек.Настройки.ПараметрыДанных.ДоступныеПараметры.Элементы Цикл
		Если НЕ ТекПараметр.Видимость Тогда
			Продолжить;
		КонецЕсли;
		
		ИмяПараметра = "Параметр"+Строка(ТекПараметр.Параметр);
		ПараметрыКомпоновки.Вставить(ИмяПараметра);
		
		Если МассивУникальныхЭлементов.Найти(ИмяПараметра) = Неопределено Тогда
			МассивУникальныхЭлементов.Добавить(ИмяПараметра);
		Иначе
			Продолжить;
		КонецЕсли;
		
		Если ТекПараметр.ДоступенСписокЗначений Тогда
			НовыйРеквизит = Новый РеквизитФормы(ИмяПараметра, Новый ОписаниеТипов("СписокЗначений"));
		Иначе
			НовыйРеквизит = Новый РеквизитФормы(ИмяПараметра, Новый ОписаниеТипов(ТекПараметр.ТипЗначения));
		КонецЕсли;
		
		НовыйРеквизит.Заголовок   = ТекПараметр.Заголовок;
		МассивНовыхРеквизитов.Добавить(НовыйРеквизит);
	КонецЦикла;
	
	Если МассивНовыхРеквизитов.Количество()>0 Тогда
		ЭтаФорма.ИзменитьРеквизиты(МассивНовыхРеквизитов);
	КонецЕсли;
	
	// Заполнение периода
	Элементы.ДатаНачала.Видимость       = Ложь;
	Элементы.ДатаОкончания.Видимость    = Истина;
	Элементы.НастройкиПериода.ПодчиненныеЭлементы.ОтборПредыдущийИнтервал.Видимость = Истина;
	Элементы.НастройкиПериода.ПодчиненныеЭлементы.ОтборСледующийИнтервал.Видимость = Истина;	
	
	//ДатаОкончания = ОтчетыСервер.КомпоновщикПолучитьЗначениеПараметра("ДатаОкончания", Отчет.КомпоновщикНастроек.Настройки);
	Элементы.ДатаОкончания.Заголовок = "На дату";
	
	// Добавление основных параметров
	СтруктураОсновныхПараметров = Неопределено;
	Попытка
		ОтчетОбъект = РеквизитФормыВЗначение("Отчет");
		СтруктураОсновныхПараметров = ОтчетОбъект.ПолучитьОсновныеПараметры();
	Исключение
	КонецПопытки;
	
	Если СтруктураОсновныхПараметров = Неопределено Тогда
		СтруктураОсновныхПараметров = Новый Структура;
	Иначе
		Для Каждого ТекПраметр Из СтруктураОсновныхПараметров Цикл
			Если ТекПраметр.Значение = Неопределено Тогда
				СтруктураОсновныхПараметров.Вставить(ТекПраметр.Ключ, Новый ПараметрКомпоновкиДанных(ТекПраметр.Ключ));
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	//восстановление настроек, сохраненных в варианте отчета
	ВосстановитьНастройкиАРМ();
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьДоступностьУРВНаСервере()
	
	// Доступность подсистемы УРВ
	зфЗащищенныеФункцииСервер.ПроверитьЗащиту();
	ИспользованиеУРВ = обПраво("УРВ_ИспользованиеУРВ");
	АРМЗаписьНаРемонт.ЗапретРедактированияУРВ = НЕ (зфЗащищенныеФункцииСервер.ПроверитьБитМаски(1) И ИспользованиеУРВ);
	Если АРМЗаписьНаРемонт.ЗапретРедактированияУРВ Тогда
		АРМЗаписьНаРемонт.ОтображатьДанныеУРВ = 0;
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ КЛИЕНТ

&НаСервере
Процедура ОбновитьОтображениеФормы()
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// КОМАНДЫ ПАНЕЛЕЙ ФОРМЫ

&НаКлиенте
Процедура Сформировать(Команда)
	
	Настройки = Отчет.КомпоновщикНастроек.Настройки;
	
	СохранитьНастройкиАРМ();
	
	ОтчетыСервер.ЗагрузитьНастройкиВСКД(Настройки, РежимВыводаОтчета, ИзмеренияСтроки, ИзмеренияКолонки,, Ложь);
	//ОтчетыТонкийКлиент.ДействияФормыСформировать(ЭтаФорма);
	
	Если ЭтаФорма.ВладелецФормы = Неопределено Тогда
		
		СтруктураПараметров = Новый Структура();
		СтруктураПараметров.Вставить("КлючВарианта",            КлючТекущегоВарианта);
		СтруктураПараметров.Вставить("ПредставлениеВарианта",   ПредставлениеТекущегоВарианта);
		СтруктураПараметров.Вставить("Вариант",                 ОтчетыСервер.КомпоновщикПолучитьНастройки(Отчет.КомпоновщикНастроек));
		СтруктураПараметров.Вставить("СхемаКомпоновки",         СхемаКомпоновки);
		СтруктураПараметров.Вставить("СформироватьПриОткрытии", Истина);
		
		Модифицированность   = Ложь;
		ВариантМодифицирован = Ложь;
	
		Закрыть(КодВозвратаДиалога.ОК);
		
		ОткрытьФорму(ИмяФормыОтчета, СтруктураПараметров,, ИмяФормы);
		
	Иначе
		
		ФормаРезультат = ЭтаФорма.ВладелецФормы;
		ФормаРезультат.Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(Отчет.КомпоновщикНастроек.Настройки);
		ФормаРезультат.КлючТекущегоВарианта          = КлючТекущегоВарианта;
		ФормаРезультат.ПредставлениеТекущегоВарианта = ПредставлениеТекущегоВарианта;
		ФормаРезультат.НачалоПериода                 = ДатаНачала;
		ФормаРезультат.КонецПериода                  = ДатаОкончания;
		
		Модифицированность   = Ложь;
		ВариантМодифицирован = Ложь;
	
		Закрыть(КодВозвратаДиалога.ОК);
		
		ФормаРезультат.Открыть();
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьВариант(КлючОтчета, КлючВарианта)
	
	Результат = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьВариантОтчета(КлючОтчета, КлючВарианта);
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура КомандаСоздатьРассылку(Команда)
	
	ФормаРассылки = ПолучитьФорму("Справочник.РассылкиОтчетов.Форма.ФормаЭлемента", ,ЭтаФорма);
	ВариантОтчета = ПолучитьВариант(ЭтаФорма.КлючОтчета, ЭтаФорма.КлючТекущегоВарианта);
	ФормаРассылки.ДобавитьНовыйОтчет(ВариантОтчета);
	ФормаРассылки.Открыть();
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ФОРМЫ ОТЧЕТА

&НаКлиенте
Процедура КомпоновщикНастроекНастройкиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Если Поле.Имя = "ДопПоля" ИЛИ Поле.Имя = "Порядок" ИЛИ Поле.Имя = "УсловноеОформление" ИЛИ Поле.Имя = "ПараметрыВывода" Тогда
		
		СтандартнаяОбработка = Ложь;
		
		//СтруктураПараметров = Новый Структура();
		//СтруктураПараметров.Вставить("ВидПолей",        Поле.Имя);
		//СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
		//СтруктураПараметров.Вставить("НастройкиОтчета", ОтчетыСервер.КомпоновщикПолучитьНастройки(Отчет.КомпоновщикНастроек));
		//СтруктураПараметров.Вставить("ТекущаяСтрока",   Элемент.ТекущаяСтрока);
		//
		//ФормаВыбора = ПолучитьФорму("ОбщаяФорма.ОтчетРедактированиеВыбранныхПолей", СтруктураПараметров, Элемент);
		//
		//Рез = ФормаВыбора.ОткрытьМодально();
		//Если Рез = КодВозвратаДиалога.ОК Тогда
		//	Отчет.КомпоновщикНастроек.ЗагрузитьНастройки(ФормаВыбора.КомпоновщикНастроек.Настройки);
		//КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КомпоновщикНастроекНастройкиВыборПередУдалением(Элемент, Отказ)
	
	ТекПоле = Отчет.КомпоновщикНастроек.Настройки.Выбор.ПолучитьОбъектПоИдентификатору(Элемент.ТекущаяСтрока);
	ТипПоля = ТипЗнч(ТекПоле);
	Если ТипПоля = Тип("ВыбранноеПолеКомпоновкиДанных") Тогда
		
		ЭтоПользовательскоеПоле = Ложь;
		ПутьКДанным = Строка(ТекПоле.Поле);
		Для Каждого ТекЭлемент Из Отчет.КомпоновщикНастроек.Настройки.ПользовательскиеПоля.Элементы Цикл
			Если ПутьКДанным = ТекЭлемент.ПутьКДанным Тогда
				ЭтоПользовательскоеПоле = Истина;
			КонецЕсли;
		КонецЦикла;
		
		Отказ = (ЭтоПользовательскоеПоле = Ложь);
		
	ИначеЕсли ТипПоля = Тип("ГруппаВыбранныхПолейКомпоновкиДанных") Тогда
		Отказ = (ТекПоле.Элементы.Количество()>0);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТекстВариантНастройкиНачалоВыбораИзСписка(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ТекПозиция = Элемент.СписокВыбора.НайтиПоЗначению(ЭтаФорма.КлючТекущегоВарианта);
	ВыбранноеЗначение = ВыбратьИзСписка(Элемент.СписокВыбора, Элемент, ТекПозиция);
	Если НЕ ВыбранноеЗначение = Неопределено Тогда
		ЭтаФорма.КлючТекущегоВарианта          = ВыбранноеЗначение.Значение;
		ЭтаФорма.ТекстВариантНастройки         = ВыбранноеЗначение.Представление;
		ЭтаФорма.ПредставлениеТекущегоВарианта = ВыбранноеЗначение.Представление;
		ИзменитьВариантОтчета();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПараметрПриИзменении(Команда)
	
	Если ТипЗнч(Команда) = Тип("Строка") Тогда
		ИмяКоманды = Команда;
	Иначе
		ИмяКоманды = Команда.Имя;
	КонецЕсли;
	
	ЗначениеПараметра = ЭтаФорма[ИмяКоманды];
	ИмяПараметра = СтрЗаменить(ИмяКоманды, "Параметр", "");
	Отчет.КомпоновщикНастроек.Настройки.ПараметрыДанных.УстановитьЗначениеПараметра(ИмяПараметра, ЗначениеПараметра);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборПредыдущийИнтервал(Команда)
	
	ДатаОкончания = НачалоДня(НачалоДня(ДатаОкончания)-1);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборСледующийИнтервал(Команда)
	
	ДатаОкончания = НачалоДня(КонецДня(ДатаОкончания)+1);
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ СЕРВЕР

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	СтруктураСвойств = Неопределено;
	ОтчетОбъект      = РеквизитФормыВЗначение("Отчет");
	КлючОтчета       = ОтчетОбъект.Метаданные().ПолноеИмя();
	
	//Если ИмяФормы = "ОбщаяФорма.ОтчетФормаНастройки" Тогда
		ИмяФормыОтчета = ОтчетОбъект.Метаданные().ПолноеИмя() + ".Форма";
	//Иначе
	//	ИмяФормыОтчета = ИмяФормы;
	//КонецЕсли;
	
	Параметры.Свойство("НачалоПериода", ДатаНачала);
	Параметры.Свойство("КонецПериода",  ДатаОкончания);
	
	Если Параметры.Свойство("СхемаКомпоновки") Тогда
		ВремСхемаКомпоновкиДанных = ПолучитьИзВременногоХранилища(Параметры.СхемаКомпоновки);
	Иначе
		
		Попытка
			ОтчетОбъект.ЗаполнитьНачальныеНастройки();
		Исключение
			ОтчетыСервер.ЗаполнитьНачальныеОстатки(ОтчетОбъект);
		КонецПопытки;
		
		ВремСхемаКомпоновкиДанных = ОтчетОбъект.СхемаКомпоновкиДанных;
	КонецЕсли;
	
	СхемаКомпоновки = ПоместитьВоВременноеХранилище(ВремСхемаКомпоновкиДанных, УникальныйИдентификатор);
	
	Отчет.КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СхемаКомпоновки));
	
	ОбновитьОтображениеФормы();
	
	ЗагрузитьНастройкиФормы();
	
	Если обПраво("ПроверкаДоступаКСправочникамИДокументам") Тогда
		СправочникИмя=Метаданные.Справочники.ВариантыОтчетов.Имя;
		ПравоДоступа = обПраво("Право доступа "+СправочникИмя);
		Если ПравоДоступа=Перечисления.ВидыПравДляСправочников.НетДоступа ИЛИ ПравоДоступа=Перечисления.ВидыПравДляСправочников.Чтение Тогда
			Элементы.ФормаКнопкаСохранитьВариант.Доступность = Ложь;
		КонецЕсли;
		
		СправочникИмя=Метаданные.Справочники.РассылкиОтчетов.Имя;
		ПравоДоступа = обПраво("Право доступа "+СправочникИмя);
		Если ПравоДоступа=Перечисления.ВидыПравДляСправочников.НетДоступа ИЛИ ПравоДоступа=Перечисления.ВидыПравДляСправочников.Чтение Тогда
			Элементы.ФормаКомандаСоздатьРассылку.Доступность = Ложь;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ КЛИЕНТ

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Если СокрЛП(КлючУникальности) = "" Тогда
		КлючУникальности = УникальныйИдентификатор;
	КонецЕсли;
	
	ПараметрыДанных = Отчет.КомпоновщикНастроек.Настройки.ПараметрыДанных;
	Для Каждого ТекПараметр Из ПараметрыКомпоновки Цикл
		ПолеПараметра = Новый ПараметрКомпоновкиДанных(СтрЗаменить(ТекПараметр.Ключ, "Параметр", ""));
		ЭтаФорма[ТекПараметр.Ключ] = ПараметрыДанных.НайтиЗначениеПараметра(ПолеПараметра).Значение;
		ПараметрыКомпоновки.Вставить(ТекПараметр.Ключ, ЭтаФорма[ТекПараметр.Ключ]);
	КонецЦикла;
	
	ПроверитьДоступностьУРВНаСервере();
	
	Если АРМЗаписьНаРемонт.ЗапретРедактированияУРВ Тогда
		Элементы.ОтображатьДанныеУРВ.Доступность = Ложь;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриЗагрузкеВариантаНаСервере(Настройки)
	
	ЗаполнитьНастроки = Истина;
	Если Параметры.Свойство("ЗаполнитьНастроки") Тогда
		ЗаполнитьНастроки = Параметры.ЗаполнитьНастроки;
	КонецЕсли;
	
	ОбновитьСписокВариантовОтчета(Параметры.КлючВарианта);
	
	ОбновитьДанныеФормы(ЗаполнитьНастроки);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии()
	
	СтруктураНастроек = Новый Структура;
	СтруктураНастроек.Вставить("КлючТекущегоВарианта",  ЭтаФорма.КлючТекущегоВарианта);
	СтруктураНастроек.Вставить("ТекстВариантНастройки", ЭтаФорма.ТекстВариантНастройки);
	
	СохранитьНастройкиФормы(ИмяФормыОтчета, СтруктураНастроек);
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	Модифицированность   = Ложь;
	Попытка
		ВариантМодифицирован = Ложь;
	Исключение
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура КомпоновщикНастроекНастройкиПорядокПолеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	//СтруктураПараметров = Новый Структура();
	//СтруктураПараметров.Вставить("СхемаКомпоновки", СхемаКомпоновки);
	//СтруктураПараметров.Вставить("ПоляГруппировки", Неопределено);
	//СтруктураПараметров.Вставить("ТолькоРесурсы",   Истина);
	//СтруктураПараметров.Вставить("ВидПолей",        "Порядок");
	//
	//ФормаВыбора = ПолучитьФорму("ОбщаяФорма.ОтчетВыборПоля", СтруктураПараметров, Элемент);
	//
	//Рез = ФормаВыбора.ОткрытьМодально();
	//Если НЕ Рез = КодВозвратаДиалога.Отмена И НЕ Рез = Неопределено Тогда
	//	СтрокаВыбора = Элементы.КомпоновщикНастроекНастройкиПорядок.ТекущаяСтрока;
	//	Если НЕ СтрокаВыбора = Неопределено Тогда
	//		ЗначениеПорядка = Отчет.КомпоновщикНастроек.Настройки.Порядок.ПолучитьОбъектПоИдентификатору(СтрокаВыбора);
	//		ЗначениеПорядка.Поле = Рез.Поле;
	//	КонецЕсли;
	//КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСправка(Команда)
	
	//ОткрытьСправку(Отчет.
	//СтрЗаменить(ЭтаФорма.ИмяФормыОтчета, ".Форма", "")
	ОткрытьСправку(СтрЗаменить(ЭтаФорма.ИмяФормыОтчета, ".Форма", ""));
	//ава = 3;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаДобавитьВИзбранное(Команда)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("КлючВарианта",          ЭтаФорма.КлючТекущегоВарианта);
	СтруктураПараметров.Вставить("ПредставлениеВарианта", ЭтаФорма.ПредставлениеТекущегоВарианта);
	СтруктураПараметров.Вставить("Вариант",               ОтчетыСервер.КомпоновщикПолучитьНастройки(Отчет.КомпоновщикНастроек));
	СтруктураПараметров.Вставить("ИмяФормыОтчета",        ЭтаФорма.ИмяФормыОтчета);
	ИзменитьПараметрыИзбранного(СтруктураПараметров);
	
	Форма = ПолучитьФорму("Обработка.Избранное.Форма.ДобавитьВИзбранное");
	Форма.ПараметрОбъект   = СтруктураПараметров;
	Форма.ПараметрТип      = СтруктураПараметров.Менеджер;
	Форма.ПараметрИмяФормы = СтруктураПараметров.ИмяФормыОтчета;
	
	Форма.ОткрытьМодально();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если Источник = ИмяФормыОтчета Тогда
		
		Возврат;
		
	КонецЕсли;
	
	Если ИмяСобытия = "ВариантыОтчетов.ИзменениеВарианта" Тогда
		
		Если ТипЗнч(Параметр) = Тип("Структура") И Параметр.Свойство("КлючОтчета") И Параметр.КлючОтчета = КлючОтчета Тогда
			ОбновитьСписокВариантовОтчета(Параметр.КлючВарианта);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура КомпоновщикНастроекНастройкиОтборПравоеЗначениеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	
	
КонецПроцедуры

&НаСервере
Процедура ПриСохраненииВариантаНаСервере(Настройки)
	
	СохранитьНастройкиАРМ();
	
	ОтчетыСервер.ЗагрузитьНастройкиВСКД(Отчет.КомпоновщикНастроек.Настройки, РежимВыводаОтчета, ИзмеренияСтроки, ИзмеренияКолонки,, Ложь);
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьНастройкиПоУмолчаниюНаСервере(КлючВариантаОтчета)
	
	Если КлючВариантаОтчета = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураСвойств = Неопределено;
	ОтчетОбъект      = РеквизитФормыВЗначение("Отчет");
	Настройки        = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьНастройки(ЭтаФорма.КлючОтчета, КлючВариантаОтчета);
	
	Если НЕ Настройки = Неопределено Тогда
		ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
		
		Для Каждого ТекПараметр Из Отчет.КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы Цикл
			ИмяПараметра = "Параметр" + СокрЛП(ТекПараметр.Параметр);
			ЭлементПараметра = Элементы.Найти(ИмяПараметра);
			Если ЭлементПараметра = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			ЭтаФорма[ЭлементПараметра.ПутьКДанным] = ТекПараметр.Значение;
		КонецЦикла;
		
	КонецЕсли;
	
	ВосстановитьНастройкиАРМ(Настройки);
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ВариантПредопределенный(ВариантОтчета)
	
	Возврат ВариантОтчета.ЭтоПредопределенный;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьСписокПредопределенныхВариантовОтчета(КлючОтчета)
	
	Результат = Новый СписокЗначений;
	
	СписокВариантов = ХранилищаНастроек.ХранилищеВариантовОтчетов.ПолучитьСписок(КлючОтчета,,,Истина);
	Для Каждого ТекЭлемент Из СписокВариантов Цикл
		Результат.Добавить(ТекЭлемент.Значение, ТекЭлемент.Представление);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура КомандаЗагрузитьНастройкиПоУмолчанию(Команда)
	
	ВариантОтчета = ПолучитьВариант(ЭтаФорма.КлючОтчета, ЭтаФорма.КлючТекущегоВарианта);
	
	Если ВариантПредопределенный(ВариантОтчета) Тогда
		КлючВариантаОтчета = ВариантОтчета.КлючВарианта;
	Иначе
		СписокВариантов = ПолучитьСписокПредопределенныхВариантовОтчета(ЭтаФорма.КлючОтчета);
		ВариантОтчета = СписокВариантов.ВыбратьЭлемент("Предопределенные настройки");
		Если ВариантОтчета = Неопределено Тогда
			Возврат;
		Иначе
			КлючВариантаОтчета = ВариантОтчета.Значение;
		КонецЕсли;
	КонецЕсли;
	
	ЗагрузитьНастройкиПоУмолчаниюНаСервере(КлючВариантаОтчета);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ ДЛЯ РАБОТЫ С НАСТРОЙКАМИ АРМ ЗАПИСЬ НА РЕМОНТ

&НаСервере
//	Восстановление настроек, сохраненных в варианте отчета
Процедура ВосстановитьНастройкиАРМ(Настройки=Неопределено)
	
	Если Настройки=Неопределено Тогда
		Настройки = Отчет.КомпоновщикНастроек.Настройки;
	КонецЕсли;
	
	ОбъектАРМ = РеквизитФормыВЗначение("АРМЗаписьНаРемонт");
	НастройкиАРМ = ОтчетыСервер.КомпоновщикПолучитьЗначениеПараметра("НастройкиАРМ", Настройки);
	Если ЗначениеЗаполнено(НастройкиАРМ) Тогда
		НастройкиЗначение = НастройкиАРМ.Получить();
		Для Каждого ТекНастройка ИЗ НастройкиЗначение Цикл
			Если ЭтаФорма.АРМЗаписьНаРемонт.Свойство(ТекНастройка.Ключ) Тогда
				ОбъектАРМ[ТекНастройка.Ключ] = ТекНастройка.Значение;
			КонецЕсли;
		КонецЦикла
	Иначе
		ОбъектАРМ.ВосстановитьНастройкиОбщие("Обработка.АРМЗаписьНаРемонт/Общие");
	КонецЕсли;
	ЗначениеВРеквизитФормы(ОбъектАРМ,"АРМЗаписьНаРемонт");
	
КонецПроцедуры

&НаСервере
// Сохранение настроек в варианте отчета
Процедура СохранитьНастройкиАРМ()
	
	СтруктураНастроек = Новый Структура;
	НастройкиПоУмолчанию = Обработки.АРМЗаписьНаРемонт.ПолучитьСписокНастроекАРМ();
	Для Каждого ТекНастройка Из НастройкиПоУмолчанию Цикл
		Попытка
			СтруктураНастроек.Вставить(ТекНастройка.Ключ, ЭтаФорма.АРМЗаписьНаРемонт[ТекНастройка.Ключ])
		Исключение
		КонецПопытки;
	КонецЦикла;
	НастройкиАРМ = Новый ХранилищеЗначения(СтруктураНастроек);
	Отчет.КомпоновщикНастроек.Настройки.ПараметрыДанных.УстановитьЗначениеПараметра("НастройкиАРМ", НастройкиАРМ);
	
КонецПроцедуры

&НаКлиенте
Процедура ПолеВводаФорматПредставленияЗаявкиНаРемонтОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	Форма = Обработки.АРМЗаписьНаРемонт.ПолучитьФорму("ФормаРедактированияПредставления");
	Форма.Представление = ЭтаФорма.АрмЗаписьНаРемонт.ФорматПредставленияЗаявкиНаРемонт;
	Результат = Форма.ОткрытьМодально();
	Если Результат <> Неопределено Тогда
		УстановитьФорматПредставленияЗаявкиНаРемонт(Результат);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьФорматПредставленияЗаявкиНаРемонт(НовыйФорматПредставления)
	
	ОбъектАРМ = РеквизитФормыВЗначение("АРМЗаписьНаРемонт");
	ОбъектАРМ.ФорматПредставленияЗаявкиНаРемонт = НовыйФорматПредставления;
	ЗначениеВРеквизитФормы(ОбъектАРМ,"АРМЗаписьНаРемонт");
	
КонецПроцедуры


