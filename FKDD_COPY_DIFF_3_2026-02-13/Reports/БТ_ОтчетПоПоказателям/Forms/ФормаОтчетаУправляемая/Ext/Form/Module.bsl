
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
КонецПроцедуры

&НаКлиенте
Процедура Сформировать(Команда)
	СкомпоноватьРезультат(РежимКомпоновкиРезультата.Фоновый);
	Элементы.КомпоновщикНастроекПользовательскиеНастройки.Видимость = ложь;
КонецПроцедуры


&НаКлиенте
Процедура Отборы(Команда)
	Элементы.КомпоновщикНастроекПользовательскиеНастройки.Видимость = не Элементы.КомпоновщикНастроекПользовательскиеНастройки.Видимость;
КонецПроцедуры


&НаКлиенте
Процедура РезультатОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка, ДополнительныеПараметры)
	
	СтандартнаяОбработка = ложь;
    СтруктураОтбора = ПолучитьРекурсивноСтруктуруОтбора(,,Расшифровка);
    СтруктураОтбора = ПолучитьДанныеРасшифровкиЯчеекСтроки(Элемент, СтруктураОтбора);
    
	РезультатФормирования = СформироватьПоказатели(СтруктураОтбора);
	Если не РезультатФормирования = Неопределено Тогда
		
		РезультатФормирования.Показать();
		
	КонецЕсли;
КонецПроцедуры

Функция ПолучитьРекурсивноСтруктуруОтбора(ТекущееПоле = Неопределено, СтруктураОтбора = Неопределено,Расшифровка = Неопределено)
	
	Если ТекущееПоле = Неопределено Тогда
		
		ТекущееПоле = ПолучитьИзВременногоХранилища(ДанныеРасшифровки).Элементы[Расшифровка];
		
	КонецЕсли;
    Если СтруктураОтбора = Неопределено Тогда
        СтруктураОтбора = Новый Структура;
    КонецЕсли; 
    
	Если ТипЗнч(ТекущееПоле) = Тип("ЭлементРасшифровкиКомпоновкиДанныхПоля") Тогда
		Поля = ТекущееПоле.ПолучитьПоля();
        Для Каждого ТекЭл Из Поля Цикл
            СтруктураОтбора.Вставить(ТекЭл.Поле, ТекЭл.Значение);
        КонецЦикла;
    КонецЕсли;
	Родители = ТекущееПоле.ПолучитьРодителей();
    Для Каждого ТекЭл Из Родители Цикл
        ПолучитьРекурсивноСтруктуруОтбора(ТекЭл, СтруктураОтбора);
    КонецЦикла; 
    
    Возврат СтруктураОтбора;
КонецФункции 

Функция РаспарситьИмяПоля(ИмяПоля)
    
    ИндексСи = Найти(ИмяПоля, "C");
    БазаИмени = Лев(ИмяПоля, ИндексСи);
    НомерКолонкиСтрокой = СтрЗаменить(ИмяПоля, БазаИмени, "");
    НомерКолонки = Число(НомерКолонкиСтрокой);
    
    Возврат Новый Структура (
        "БазаИмени, НомерКолонки",
        БазаИмени,
        НомерКолонки
        );
        
    
КонецФункции
 
Функция ИмяПредыдущегоПоляВСтроке(ИмяПоля)

    Данные = РаспарситьИмяПоля(ИмяПоля);
    
    Если Данные.НомерКолонки = 1 Тогда
        Возврат "";
    КонецЕсли;
    
    РаботыРезультат = Данные.БазаИмени + (Данные.НомерКолонки - 1);
    
    Возврат РаботыРезультат;
    
КонецФункции
 
Функция ИмяСледующегоПоляВСтроке(ИмяПоля, МаксНомерКолонки = 100)

    Данные = РаспарситьИмяПоля(ИмяПоля);
    
    Если Данные.НомерКолонки = МаксНомерКолонки Тогда
        Возврат "";
    КонецЕсли;
    
    РаботыРезультат = Данные.БазаИмени + (Данные.НомерКолонки + 1);
    
    Возврат РаботыРезультат;
    
КонецФункции

&НаКлиенте
Функция ПолучитьДанныеРасшифровкиПоИмени(Элемент, ИмяПоля, СтруктураОтбора = Неопределено)
    
    Если СтруктураОтбора = Неопределено Тогда
        СтруктураОтбора = Новый Структура;
    КонецЕсли; 

    Расшифровка = Результат.ПолучитьОбласть(ИмяПоля).ТекущаяОбласть.Расшифровка;
    Если Расшифровка = Неопределено тогда
        Возврат СтруктураОтбора;
    КонецЕсли;
    
    СтруктураОтбора = ПолучитьРекурсивноСтруктуруОтбора(Неопределено, СтруктураОтбора,Расшифровка);
    
    Возврат СтруктураОтбора;
    
КонецФункции
 
&НаКлиенте
Функция ПолучитьДанныеРасшифровкиЯчеекСтроки(Элемент, СтруктураОтбора = Неопределено)
    
    Если СтруктураОтбора = Неопределено Тогда
        СтруктураОтбора = Новый Структура;
    КонецЕсли; 

    Если ТипЗнч(Элемент) = Тип("ПолеФормы") Тогда
        
        ТекущееИмя = Элемент.ТекущаяОбласть.Имя;
        
        ИмяСчетчик = ИмяПредыдущегоПоляВСтроке(ТекущееИмя);
        Пока ИмяСчетчик <> "" Цикл
            
            СтруктураОтбора = ПолучитьДанныеРасшифровкиПоИмени(Элемент, ИмяСчетчик, СтруктураОтбора);
            ИмяСчетчик = ИмяПредыдущегоПоляВСтроке(ИмяСчетчик);
            
        КонецЦикла; 
        
        ИмяСчетчик = ИмяСледующегоПоляВСтроке(ТекущееИмя);
        Пока ИмяСчетчик <> "" Цикл
            
            СтруктураОтбора = ПолучитьДанныеРасшифровкиПоИмени(Элемент, ИмяСчетчик, СтруктураОтбора);
            ИмяСчетчик = ИмяСледующегоПоляВСтроке(ИмяСчетчик);
            
        КонецЦикла; 
        
    КонецЕсли;
    
    Возврат СтруктураОтбора;
    
    
КонецФункции

&НаСервере
Функция СформироватьПоказатели(СтруктураЗначений);//Период,Показатель)
	
	 
	Показатель = "";
	Если не СтруктураЗначений.Свойство("Показатель",Показатель) Тогда
		
		Сообщить("Для данного поля, расшифровка не предусмотрена");
		Возврат Неопределено;
		
	КонецЕсли;
	Если ложь тогда 
		Показатель = Справочники.БТ_Показатели.ПустаяСсылка();
	КонецЕсли;
	ОбПоказатель = Показатель.ПолучитьОбъект();
	Период = "";
	Организация = "";	
	Если СтруктураЗначений.Свойство("Организация",Организация) тогда
		
		НОрганизация = ОбПоказатель.Параметры.Найти("Организация","ИмяПараметра");
		
		Если не НОрганизация = Неопределено Тогда
			
			НОрганизация.ЗначениеПараметра = Организация;;
			
		КонецЕсли
		
	КонецЕсли;
	
	НПараметр = Неопределено;
	КПараметр = Неопределено;
	
	Если СтруктураЗначений.Свойство("Период",Период) Тогда

		НПараметр = ОбПоказатель.Параметры.Найти("НачалоПериода","ИмяПараметра");
		
		Если не НПараметр = Неопределено Тогда
			
			НПараметр.ЗначениеПараметра = Период;;
			
		КонецЕсли;
		
		КПараметр = ОбПоказатель.Параметры.Найти("КонецПериода","ИмяПараметра");
		
		Если не КПараметр = Неопределено Тогда
			
			КПараметр.ЗначениеПараметра = КонецДня(Период);
			
		КонецЕсли;
	Иначе
		
		Период = Отчет.КомпоновщикНастроек.ПользовательскиеНастройки.Элементы[0];
		
		
			
		НПараметр = ОбПоказатель.Параметры.Найти("НачалоПериода","ИмяПараметра");
		
		Если не НПараметр = Неопределено Тогда
			
			НПараметр.ЗначениеПараметра = Период.Значение.ДатаНачала;
			
		КонецЕсли;
		

		
		КПараметр = ОбПоказатель.Параметры.Найти("КонецПериода","ИмяПараметра");
		
		Если не КПараметр = Неопределено Тогда
			
			КПараметр.ЗначениеПараметра = Период.Значение.ДатаОкончания;
			
		КонецЕсли;
	КонецЕсли;	
	
	Если не НПараметр = Неопределено Тогда
		
		Если ОбПоказатель.ПериодичностьРасчетов = Перечисления.БТ_Периодичность.Ежедневно Тогда
			
			НПараметр.ЗначениеПараметра = НачалоДня(НПараметр.ЗначениеПараметра);
			
		ИначеЕсли ОбПоказатель.ПериодичностьРасчетов = Перечисления.БТ_Периодичность.Ежегодно Тогда
			
			НПараметр.ЗначениеПараметра = НачалоГода(НПараметр.ЗначениеПараметра);
			
		ИначеЕсли ОбПоказатель.ПериодичностьРасчетов = Перечисления.БТ_Периодичность.Ежемесячно Тогда
			
			НПараметр.ЗначениеПараметра = НачалоМесяца(НПараметр.ЗначениеПараметра);
			
		ИначеЕсли ОбПоказатель.ПериодичностьРасчетов = Перечисления.БТ_Периодичность.Еженедельно Тогда
			
			НПараметр.ЗначениеПараметра = НачалоНедели(НПараметр.ЗначениеПараметра);
			
		ИначеЕсли ОбПоказатель.ПериодичностьРасчетов = Перечисления.БТ_Периодичность.Поквартально Тогда
			
			НПараметр.ЗначениеПараметра = НачалоКвартала(НПараметр.ЗначениеПараметра);
			
		КонецЕсли;
			
	КонецЕсли;
		
	Если не КПараметр = Неопределено Тогда
			
		Если ОбПоказатель.ПериодичностьРасчетов = Перечисления.БТ_Периодичность.Ежедневно Тогда
			
			КПараметр.ЗначениеПараметра = КонецДня(КПараметр.ЗначениеПараметра);
			
		ИначеЕсли ОбПоказатель.ПериодичностьРасчетов = Перечисления.БТ_Периодичность.Ежегодно Тогда
			
			КПараметр.ЗначениеПараметра = КонецГода(КПараметр.ЗначениеПараметра);
			
		ИначеЕсли ОбПоказатель.ПериодичностьРасчетов = Перечисления.БТ_Периодичность.Ежемесячно Тогда
			
			КПараметр.ЗначениеПараметра = КонецМесяца(КПараметр.ЗначениеПараметра);
			
		ИначеЕсли ОбПоказатель.ПериодичностьРасчетов = Перечисления.БТ_Периодичность.Еженедельно Тогда
			
			КПараметр.ЗначениеПараметра = КонецНедели(КПараметр.ЗначениеПараметра);
			
		ИначеЕсли ОбПоказатель.ПериодичностьРасчетов = Перечисления.БТ_Периодичность.Поквартально Тогда
			
			КПараметр.ЗначениеПараметра = КонецКвартала(КПараметр.ЗначениеПараметра);
			
		КонецЕсли;
			
	КонецЕсли;
	
	Возврат Справочники.БТ_Показатели.ПроверитьНаСервере(?(ПустаяСтрока(ОбПоказатель.ТекстЗапросаРасшифровки),Неопределено,ОбПоказатель.ТекстЗапросаРасшифровки),ОбПоказатель);
	
КонецФункции

&НаСервере
Функция РаботаемСРасшифровкойНаСервере(Расшифровка)
 
	РезультатСтруктура = Новый Структура;
	
	//Внимание! Ресурс сумма может быть перезаписан в значение NULL - поэтому его значение лучше получать выше. 
	ЗаполнитьСтруктуруПолейРасшифровки(Расшифровка, РезультатСтруктура,);
	
	Возврат РезультатСтруктура;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПреобразоватьИмяПоляГруппировки(п_Поле)
	
	Возврат СокрЛП(СтрЗаменить(п_Поле,".",""));
	
КонецФункции

&НаСервере
Процедура ЗаполнитьСтруктуруПолейРасшифровки(Знач Расшифровка, СтруктураПолей, Знач Данные = "")
    
	Если Данные = "" Тогда
		
        Данные = ПолучитьИзВременногоХранилища(ДанныеРасшифровки);
        
        Если ТипЗнч(Данные.Элементы[Расшифровка]) = Тип("ЭлементРасшифровкиКомпоновкиДанныхПоля") Тогда
			
			Поля = Данные.Элементы[Расшифровка].ПолучитьПоля();                   
            Для каждого Поле Из Поля Цикл
                СтруктураПолей.Вставить(ПреобразоватьИмяПоляГруппировки(Поле.Поле), Поле.Значение);
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат;
КонецПроцедуры

