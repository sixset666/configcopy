////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

Функция ПолучитьСвойства() Экспорт
	
	СтруктураСвойств = Новый Структура;
	СтруктураСвойств.Вставить("Контрагент");
	СтруктураСвойств.Вставить("ЗаказПоставщику");
	СтруктураСвойств.Вставить("Номенклатура");
	СтруктураСвойств.Вставить("ХарактеристикаНоменклатуры");
	СтруктураСвойств.Вставить("ДокументПоступления");
	
	Возврат СтруктураСвойств;
	
КонецФункции

Процедура ЗаполнитьНачальныеНастройки() Экспорт
	
	ОтчетыСервер.ЗаполнитьНачальныеОстатки(ЭтотОбъект);
	
КонецПроцедуры

// Устанавливает параметр СписокЗаказов в построителе отчета ПостроительОтчета
//
// Без параметров
//
Процедура УстановитьПараметры()
	
	Запрос = Новый Запрос;
	
	ПоляОграничения = Новый Массив;
	ПоляОграничения.Добавить("Контрагент");
	ПоляОграничения.Добавить("ЗаказПоставщику");
	ПоляОграничения.Добавить("Номенклатура");
	ПоляОграничения.Добавить("ХарактеристикаНоменклатуры");
	
	ОтборКомпоновки = КомпоновщикНастроек.Настройки.Отбор;
	
	ТекстОтбора = ОтчетыСервер.КомпоновщикПолучитьТекстОтбора(ОтборКомпоновки.Элементы, ОтборКомпоновки.ДоступныеПоляОтбора, "ЗаказыПоставщикам", Запрос.Параметры, , ПоляОграничения);
	ТекстОтбора = ?(ТекстОтбора = "", "", " И " + Символы.ПС + ТекстОтбора);
	
	ДатаНач = ОтчетыСервер.КомпоновщикПолучитьЗначениеПараметра("ДатаНачала",    КомпоновщикНастроек.Настройки);
	ДатаКон = ОтчетыСервер.КомпоновщикПолучитьЗначениеПараметра("ДатаОкончания", КомпоновщикНастроек.Настройки);
	
	Запрос.УстановитьПараметр("ДатаНач", ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон", ДатаКон);
	
	ВыводитьЗакрытыеЗаказы = ОтчетыСервер.КомпоновщикПолучитьЗначениеПараметра("ВыводитьЗакрытыеЗаказы", КомпоновщикНастроек.Настройки);
	
	Если ВыводитьЗакрытыеЗаказы Тогда
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЗаказыПоставщикам.ЗаказПоставщику КАК ЗаказПоставщику
		|ИЗ
		|	РегистрНакопления.ЗаказыПоставщикам КАК ЗаказыПоставщикам
		|ГДЕ
		|	ЗаказыПоставщикам.Период МЕЖДУ &ДатаНач И &ДатаКон" + ТекстОтбора + "
		|";
	Иначе
		
		ТекстПараметров = ОтчетыСервер.КомпоновщикПолучитьТекстОтбора(ОтборКомпоновки.Элементы, ОтборКомпоновки.ДоступныеПоляОтбора, "", Запрос.Параметры, , ПоляОграничения);
		ТекстПараметров = ?(ТекстПараметров = "", "", " И " + Символы.ПС + ТекстПараметров);
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЗаказыПоставщикам.ЗаказПоставщику КАК ЗаказПоставщику
		|ПОМЕСТИТЬ
		|	ТаблицаЗаказов
		|ИЗ
		|	РегистрНакопления.ЗаказыПоставщикам КАК ЗаказыПоставщикам
		|ГДЕ
		|	ЗаказыПоставщикам.Период МЕЖДУ &ДатаНач И &ДатаКон" + ТекстОтбора + "
		|ИНДЕКСИРОВАТЬ ПО
		|	ЗаказПоставщику
		|;
		|
		|ВЫБРАТЬ
		|	ЗаказыПоставщикамОстатки.ЗаказПоставщику КАК ЗаказПоставщику
		|{ВЫБРАТЬ
		|	ЗаказПоставщику КАК ЗаказПоставщику}
		|ИЗ
		|	РегистрНакопления.ЗаказыПоставщикам.Остатки(&ДатаКон,
		|	ЗаказПоставщику В (ВЫБРАТЬ ЗаказПоставщику ИЗ ТаблицаЗаказов)" + ТекстПараметров + ") КАК ЗаказыПоставщикамОстатки
		|ГДЕ
		|	(НЕ ЗаказыПоставщикамОстатки.ЗаказаноОстаток = 0)
		|";
	КонецЕсли;
	
	МассивЗаказов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ЗаказПоставщику");
	СписокЗаказов = Новый СписокЗначений;
	СписокЗаказов.ЗагрузитьЗначения(МассивЗаказов);
	КомпоновщикНастроек.Настройки.ПараметрыДанных.УстановитьЗначениеПараметра("СписокЗаказов", СписокЗаказов);
	
КонецПроцедуры // УстановитьПараметры()

Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка) Экспорт
	
	УстановитьПараметры();
	ОтчетыСервер.ВывестиОтчет(ЭтотОбъект, СхемаКомпоновкиДанных, КомпоновщикНастроек.Настройки, ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка);
	
	//ОтчетыСервер.СформироватьОтчет(ОтчетОбъект, ТабличныйДокумент, СхемаКомпоновки, Отчет.КомпоновщикНастроек, Заголовок, ДанныеРасшифровки, УникальныйИдентификатор);
	
КонецПроцедуры



//ПоследовательностиОтчета = Новый ТаблицаЗначений();
//ПоследовательностиОтчета.Колонки.Добавить("ИмяГраницы");
//ПоследовательностиОтчета.Колонки.Добавить("Представление");
//ПоследовательностиОтчета.Колонки.Добавить("РегистрыНакопления");
//ПоследовательностиОтчета.Колонки.Добавить("Измерения");
//	
//НоваяСтрока = ПоследовательностиОтчета.Добавить();
//НоваяСтрока.ИмяГраницы = "ГраницыЗаказы";
//НоваяСтрока.Представление = "Заказы";
//СтруктураРегистровНакопления = Новый Структура();
//СтруктураРегистровНакопления.Вставить("ЗаказыПоставщикам",Новый Структура("Заказ","ЗаказПоставщику"));
//СтруктураРегистровНакопления.Вставить("ЗаказыРаспределение",Новый Структура("Заказ","ЗаказПоставщика"));
//НоваяСтрока.РегистрыНакопления = СтруктураРегистровНакопления;
//МассивИзмерений = Новый Массив(); МассивИзмерений.Добавить("Заказ");
//НоваяСтрока.Измерения = МассивИзмерений;
