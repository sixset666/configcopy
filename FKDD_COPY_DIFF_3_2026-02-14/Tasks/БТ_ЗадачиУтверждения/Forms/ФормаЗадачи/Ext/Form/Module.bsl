&НаСервереБезКонтекста
Функция ПолучитьДанныеФайлаИзВременногоХранилища(Расшифровка, АдресДанныхРасшифровки)
	СтруктураДанныхРасшифровки = ПолучитьИзВременногоХранилища(АдресДанныхРасшифровки);
	ЭлементРасшифровки = СтруктураДанныхРасшифровки.Элементы.Получить(Расшифровка).ПолучитьПоля();
	Заявка		= "";
	ИмяФайла	= "";
	Расширение	= "";
	Для каждого ТекЭлемент Из ЭлементРасшифровки Цикл
		Если ТекЭлемент.Поле = "БизнесПроцесс" Тогда
			Заявка	= ТекЭлемент.Значение;
		ИначеЕсли ТекЭлемент.Поле = "ИмяФайла" или  ТекЭлемент.Поле = "ИмяФайлаДоп" Тогда
			ИмяФайла	= ТекЭлемент.Значение;
		ИначеЕсли ТекЭлемент.Поле = "Расширение" или ТекЭлемент.Поле = "РасширениеДоп" Тогда
			Расширение	= ТекЭлемент.Значение;
		ИначеЕсли ТекЭлемент.Поле = "ОсновнойЗначение" ИЛИ ТекЭлемент.Поле = "ЗначениеРеквизита" ИЛИ ТекЭлемент.Поле = "ЗначениеТЧ" ИЛИ ТекЭлемент.Поле = "ПараметрыДанных.Заявка" Тогда
			Возврат ТекЭлемент.Значение;
		ИначеЕсли ТекЭлемент.Поле = "РегистраторОценки" Тогда
			Возврат ТекЭлемент.Значение;
		ИначеЕсли ТекЭлемент.Поле = "ЗаказПокупателяПросрочка" ИЛИ ТекЭлемент.Поле = "ЗаказПокупателя" Тогда
			Возврат ТекЭлемент.Значение;
		ИначеЕсли ТекЭлемент.Поле = "ДатаПомещения" И (ТекЭлемент.Значение = "Добавить" ИЛИ ТекЭлемент.Значение = "Add") Тогда
			Возврат "Добавить вложение в заявку";
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ ПустаяСтрока(ИмяФайла) И НЕ ПустаяСтрока(Расширение) Тогда
			Возврат Новый Структура("ИмяФайла, Расширение",  									
										ИмяФайла,
										Расширение);
	КонецЕсли;
	
КонецФункции
&НаКлиенте
Процедура ОписаниеЗаявкиОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка, ДополнительныеПараметры)
	СтандартнаяОбработка = Ложь;
	ПолученноеЗначение = ПолучитьДанныеФайлаИзВременногоХранилища(Расшифровка, АдресДанныхРасшифровкиОписаниеЗаявки);
	Если ТипЗнч(ПолученноеЗначение) = Тип("Структура") Тогда
		//РаботаСХранилищемКлиент.ВыбратьФайл(Новый Структура("ИмяФайла,Расширение", ПолученноеЗначение.ИмяФайла, ПолученноеЗначение.Расширение), СтруктураЗаявокТабличныхДокументов.Основная,, Истина);
	ИначеЕсли ПолученноеЗначение = "Добавить вложение в заявку" Тогда
			
		Если НЕ ЗначениеЗаполнено(СтруктураЗаявокТабличныхДокументов.Основная) Тогда
			Возврат;
		КонецЕсли;
		
		//РаботаСХранилищемКлиент.ПрикрепитьФайлКЗаявке(СтруктураЗаявокТабличныхДокументов.Основная, Ложь,,,, Новый ОписаниеОповещения("ПослеПомещенияВложенияИзСписка",ЭтотОбъект, Новый Структура("ОбновитьИнфоПанель, Заявка", Истина, СтруктураЗаявокТабличныхДокументов.Основная)));
	ИначеЕсли ПолученноеЗначение <> Неопределено Тогда
		ПоказатьЗначение(, ПолученноеЗначение);
	КонецЕсли
КонецПроцедуры
&НаКлиенте
Процедура ИнфоСтраницыПриСменеСтраницы(Элемент, ТекущаяСтраница)

	ОбновитьСведенияПоТекущейЗаявкеНаКлиенте();

КонецПроцедуры

 &НаКлиенте
Процедура ОчиститьЗначенияЗаявокТабличныхДокументов()
	СтруктураЗаявокТабличныхДокументов = Новый Структура("Основная, ИсторияСогласования, КартаМаршрута");
КонецПроцедуры

&НаКлиенте
Функция ПроверитьНаРавенствоЗаявокТабличногоДокумента(ИмяТЧ)
	Если СтруктураЗаявокТабличныхДокументов[ИмяТЧ] = ЗаявкаПользователя Тогда
		Возврат Ложь;
	КонецЕсли;
	СтруктураЗаявокТабличныхДокументов[ИмяТЧ] = ЗаявкаПользователя;
	Возврат Истина;
КонецФункции

&НаСервереБезКонтекста
Процедура ОбновитьСведенияПоТекущейЗаявке(Заявка, ТабДокОписаниеЗаявки, ТабДокИсторияСогласования, КартаМаршрутаЗаявки,  АдресРасшифровки, АдресДанныхРасшифровкиОписаниеЗаявки)
	БизнесПроцессы.БТ_СогласованиеЗаявокДДС.ОбновитьСведенияПоТекущейЗаявке(Заявка, ТабДокОписаниеЗаявки, ТабДокИсторияСогласования, КартаМаршрутаЗаявки,  АдресРасшифровки, АдресДанныхРасшифровкиОписаниеЗаявки);
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСведенияПоТекущейЗаявкеНаКлиенте(Принудительно = Ложь)
	
	ЗаявкаПользователя = Объект.Заявка;
	
	Если Принудительно Тогда
		ОчиститьЗначенияЗаявокТабличныхДокументов();
	КонецЕсли;
	
	СтруктураТабличныхДокументов = Новый Структура("ТабДокОписаниеЗаявки, ТабДокИсторияСогласования, КартаМаршрутаЗаявки", Неопределено, Неопределено, Неопределено);
	
	Если Элементы.ИнфоСтраницы.ТекущаяСтраница = Элементы.Основная Тогда
		Если НЕ ПроверитьНаРавенствоЗаявокТабличногоДокумента("Основная") Тогда
			Возврат;
		КонецЕсли;
		СтруктураТабличныхДокументов.Вставить("ТабДокОписаниеЗаявки", ОписаниеЗаявки);
	ИначеЕсли Элементы.ИнфоСтраницы.ТекущаяСтраница = Элементы.ИсторияСогласования Тогда
		Если НЕ ПроверитьНаРавенствоЗаявокТабличногоДокумента("ИсторияСогласования") Тогда
			Возврат;
		КонецЕсли;
		СтруктураТабличныхДокументов.Вставить("ТабДокИсторияСогласования", История);
	ИначеЕсли Элементы.ИнфоСтраницы.ТекущаяСтраница = Элементы.КартаМаршрута Тогда
		Если НЕ ПроверитьНаРавенствоЗаявокТабличногоДокумента("КартаМаршрута") Тогда
			Возврат;
		КонецЕсли;
		СтруктураТабличныхДокументов.Вставить("КартаМаршрутаЗаявки", КартаМаршрутаЗаявки);
	КонецЕсли;
	
	ОбновитьСведенияПоТекущейЗаявке(ЗаявкаПользователя, СтруктураТабличныхДокументов.ТабДокОписаниеЗаявки, СтруктураТабличныхДокументов.ТабДокИсторияСогласования, СтруктураТабличныхДокументов.КартаМаршрутаЗаявки, ЭтотОбъект.УникальныйИдентификатор, АдресДанныхРасшифровкиОписаниеЗаявки);
	
	Для Каждого ТЧ ИЗ СтруктураТабличныхДокументов Цикл
		Если ТЧ.Значение = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		Если ТЧ.Ключ = "ТабДокОписаниеЗаявки" Тогда
			ОписаниеЗаявки = ТЧ.Значение;
		ИначеЕсли ТЧ.Ключ = "ТабДокИсторияСогласования" Тогда
			История = ТЧ.Значение;
		ИначеЕсли ТЧ.Ключ = "КартаМаршрутаЗаявки" Тогда
			КартаМаршрутаЗаявки = ТЧ.Значение;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)                         
	
	ОбновитьСведенияПоТекущейЗаявкеНаКлиенте(Истина); 
	
КонецПроцедуры

&НаКлиенте
Процедура Согласовать(Команда)             
	
	СогласоватьНаСервере(Объект.Заявка);  
	Оповестить("ОбновитьФорму");
	
КонецПроцедуры      

&НаСервереБезКонтекста
Процедура СогласоватьНаСервере(Заявка)         
	
	БТ_БизнесПроцессы.СогласоватьЗаявку(Заявка);   
	
КонецПроцедуры

&НаКлиенте
Процедура СогласоватьИЗакрыть(Команда)  
	
	Согласовать(Неопределено);
	Закрыть();

КонецПроцедуры
