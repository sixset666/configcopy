// Модуль документа ПоступлениеДопРасходов

////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ ОБЪЕКТА

Перем Права Экспорт;				// Переменная объекта - ссылка на коллекцию прав, настроек и переменных окружения
Перем РезультатОбработки Экспорт;	// Переменная для накопления результатов проведения по модулям наборов записей
Перем ИмяРеквизитаКода Экспорт;     // Кэш права "РежимВыводаКодаВДокументах". Служит для настройки вывода кода/атрикула в ТЧ
Перем ОбработкаЗначенияСвойствОбъектов Экспорт; // Переменная для хранения значения свойств основания/объекта копирования


////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ДОПОЛНИТЕЛЬНЫХ МЕТОДОВ ОБЪЕКТА

// Возвращает соответствие в котором перечислены виды номенклатуры, которые нельзя вводить
// в таблицу товаров. Если таких нет, то возвращает неопределено
//
// Возвращаемое значение:
//  Результат - соответствие.
//
Функция ПолучитьСоответствиеЗапрещенныхВидовНоменклатуры() Экспорт
	Результат=Неопределено;
	Результат=Новый Соответствие();
	Результат.Вставить(Перечисления.ВидыНоменклатуры.Комплект,0);
	Результат.Вставить(Перечисления.ВидыНоменклатуры.Набор,0);
	Результат.Вставить(Перечисления.ВидыНоменклатуры.Тара,0);
	Результат.Вставить(Перечисления.ВидыНоменклатуры.Товар,0);
	Результат.Вставить(Перечисления.ВидыНоменклатуры.ПрочиеАктивы,0); 
	Возврат Результат;
КонецФункции // ПолучитьСоответствиеЗапрещенныхВидовНоменклатуры()

// Возвращает структуру обязательных / уникальных реквизитов документа
// Возвращаемая структура содержит строковые идентификаторы реквизитов или вложенные структуры для табличных частей
// Для реквизита значение структуры содержит число 1-Обязательный, 2-Уникальный, 3-Уникальный и обязательный
Функция ПолучитьОбязательныеРеквизиты() Экспорт
	// Обязательные поля таблицы товаров
	ОбязательныеАвтомобили=Новый Структура();
	ОбязательныеАвтомобили.Вставить("Автомобиль",3);
	ОбязательныеАвтомобили.Вставить("Количество",1);
	
	// Обязательные реквизиты документа
	ОбязательныеРеквизиты=Новый Структура();
	ОбязательныеРеквизиты.Вставить("Организация",1);
	ОбязательныеРеквизиты.Вставить("ПодразделениеКомпании",1);
	ОбязательныеРеквизиты.Вставить("Автор",1);
	ОбязательныеРеквизиты.Вставить("ВалютаДокумента",1);
	ОбязательныеРеквизиты.Вставить("КурсДокумента",1);
	ОбязательныеРеквизиты.Вставить("Услуга",1);
	ОбязательныеРеквизиты.Вставить("Контрагент",1);
	ОбязательныеРеквизиты.Вставить("ДоговорВзаиморасчетов",1);
	ОбязательныеРеквизиты.Вставить("ТипЦен",1);
	ОбязательныеРеквизиты.Вставить("ХозОперация",1);
	ОбязательныеРеквизиты.Вставить("Автомобили",ОбязательныеАвтомобили);
	
	Возврат ОбязательныеРеквизиты;
КонецФункции // ПолучитьОбязательныеРеквизиты()

// Проверяет корректность заполнения объекта.
// может управляться булевыми флагами выполняемых проверок Заполнение, Уникальность
// (могут быть и другие необязательные)
// Обычно выполняется универсальным обработчиком, но могут быть добавлены доп. проверки
//
// Параметры:
//  Ошибки       - строка, в случае некорректного заполнения содержит описанием возникших ошибок, 
//  ДопРеквизиты - структура, на вход может быть передана структура с дополнительными реквизитами для проверки,
//  Заполнение   - булево, флаг проверки, 
//  Уникальность - булево, флаг проверки.
//
// Возвращаемое значение:
//  Булево - Возвращает Истина если все заполнено корректно и Ложь иначе.
// 
Функция ПроверитьКорректность(Ошибки="", ДопРеквизиты=Неопределено, Заполнение=Истина, Уникальность=Истина) Экспорт 
	// Здесь могут быть определены дополнительные к стандартным обязательным реквизитам условия проверки
	Результат = дкПроверитьКорректность(ЭтотОбъект, Ошибки, ДопРеквизиты, Заполнение, Уникальность);
	
	// У номенклатуры в табличной части, в обязательном порядке должен быть заполнен реквизит "СпособРаспределенияДопРасходов".
	//Для каждого ТекСтрока Из Товары Цикл  	
	//	Если ТекСтрока.Номенклатура.СпособРаспределенияДопРасходов.Пустая() Тогда
	//		дкДобавитьОшибку(Ошибки,"Таблица <Товары>. У номенклатуры не заполнен реквизит ""Способ распределения доп. расходов"". Строка: " + ТекСтрока.НомерСтроки);
	//		Результат = Ложь;	
	//	КонецЕсли;
	//КонецЦикла;
	
	// Проведем проверку соотвествия организации документа организациям некоторых реквизитов документа.
	// Такую проверку необходимо осуществлять, если баланс в системе ведется по организации, или если установлен способ контроля корректности
	// договора и склада документа. Причем, если способ контроля выбран "Контроль по организации и подразделению", то
	// дополнительно осуществляется проверка соотвествия подразделений.
	
	Возврат Результат;
КонецФункции // ПроверитьКорректность()

// Функция проверяет, допустимо ли изменение объекта
//
// Параметры:
//  БлокироватьРеквизиты - структура, структура блокируемых на изменение реквизитов.
//
// Возвращаемое значение:
// Булево - Возвращает Истина, если изменения возможны, ложь иначе
//          Если изменения доступны частично, возвращает ложь и структуру блокируемых на изменение реквизитов.
//
Функция ДоступностьИзменения(БлокироватьРеквизиты=Неопределено) Экспорт
	// Здесь может быть прописано определение наличия ссылок, блокирующих изменение объекта
	Возврат Истина;
КонецФункции // ДоступностьИзменения()

// Возвращает список возможных хозяйственных операций документа
// Вовращаемое значение: 
//  СписокЗначений. 
//  Строка списка: Значение - имя предопределенного элемента; 
//				   Представление - красивое его представление
// 				   "Помеченная" строка - ХО по умолчанию.
Функция ПолучитьСписокХозОпераций() Экспорт
	СписокХозОпераций = Новый СписокЗначений;
	//СписокХозОпераций.Добавить("ПоступлениеДопРасходов","Поступление дополнительных расходов",Истина);
	//СписокХозОпераций.Добавить("ПоступлениеДопРасходовВнутреннее","Поступление внутренних дополнительных расходов",Ложь);
	СписокХозОпераций.Добавить("ПоступлениеДопРасходовНаАвтомобили","Поступление дополнительных расходов на автомобили",истина);
	//СписокХозОпераций.Добавить("ПоступлениеДопРасходовНаАвтомобилиВнутреннее","Поступление внутренних доп. расходов на автомобили",Ложь);
	Возврат СписокХозОпераций;
КонецФункции // ПолучитьСписокХозОпераций()

// формирует движения документа по партионным регистрам
//
// Параметры:
//  Режим           - режим проведения (оперативный/неоперативный)
//  ДокументСсылка  - ссылка на документ который надо допровести по партиям
//
// Возвращаемое значение:
//  Возвращает Истина - все ОК, ложь - чего-то не так
//
Функция ПровестиПоПартиям(Режим,ДокументСсылка) Экспорт
	Отказ = Ложь;
	НаборЗаписейДиР       = Движения.ДоходыИрасходы;
	СуммаДляРаспределения = 0;  // Сумма для распределения по доходам и расходам.
	ВедетсяБалансПоПодразделению = Константы.СпособВеденияБаланса.Получить() = Перечисления.СпособВеденияБаланса.ПоПодразделению;
	
	// получим шапку документа
	ШапкаДокумента = ПолучитьШапкуДокумента(ДокументСсылка);
	
	// проверим, если подразделение проводиться по партиям "отложенно", то дальше не идем
	НаборЗаписейДопроведениеПоПартиям=Движения.ДопроведениеПоПартиям;
	НаборЗаписейДопроведениеПоПартиям.ДокументОбъект=ЭтотОбъект;
	НаборЗаписейДопроведениеПоПартиям.ШапкаДокумента=ШапкаДокумента;
	Отказ=НЕ НаборЗаписейДопроведениеПоПартиям.Зафиксировать() ИЛИ Отказ;
	Если НаборЗаписейДопроведениеПоПартиям.НеПроводитьПартии Тогда
		НаборЗаписейДоходыИРасходы=Движения.ДоходыИРасходы;
		НаборЗаписейДоходыИРасходы.ДокументОбъект=ЭтотОбъект;
		Если ВедетсяБалансПоПодразделению Тогда
			НаборЗаписейДоходыИРасходы.Подразделение = ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение;
		КонецЕсли;
		НаборЗаписейДоходыИРасходы.ШапкаДокумента=ШапкаДокумента;
		НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СебестоимостьНеоприходованныхПартий;
		НаборЗаписейДоходыИРасходы.ВУпрВалюте = Ложь;
		НаборЗаписейДоходыИРасходы.Расход = ШапкаДокумента.СуммаДокумента;
		НаборЗаписейДоходыИРасходы.Приход();
		Возврат НЕ Отказ;
	КонецЕсли;
	
	///////////////////////////////////////////////////////////
	// Секция Альфа-Авто: Начало
	///////////////////////////////////////////////////////////
	Если КонтрольОстаткаПартии Тогда
		//Для "новых" документов проверим остатки партии
		//Проверим, а есть ли услуги, распределяемые на себестоимость
		Запрос=Новый Запрос;
		Запрос.Текст="ВЫБРАТЬ ПЕРВЫЕ 1
		|	ПоступлениеДопРасходовТовары.Номенклатура
		|ИЗ
		|	Документ.ПоступлениеДопРасходов.Товары КАК ПоступлениеДопРасходовТовары
		|ГДЕ
		|	ПоступлениеДопРасходовТовары.Ссылка = &Ссылка
		|	И ПоступлениеДопРасходовТовары.Номенклатура.СпособРаспределенияДопРасходов <> ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияДопРасходов.НаДоходыИРасходы)";
		Запрос.УстановитьПараметр("Ссылка",ШапкаДокумента.Ссылка);
		Выборка=Запрос.Выполнить().Выбрать();
		Если Выборка.Количество()>0 Тогда
			Если ШапкаДокумента.ХозОперация=Справочники.ХозОперации.ПоступлениеДопРасходовНаАвтомобили ИЛИ
				ШапкаДокумента.ХозОперация=Справочники.ХозОперации.ПоступлениеДопРасходовНаАвтомобилиВнутреннее Тогда
				ТекстЗапроса="ВЫБРАТЬ
				|	ПартииОбороты.Автомобиль КАК Номенклатура,
				|	ЕСТЬNULL(СУММА(ПартииОбороты.КоличествоПриход), 0) КАК КоличествоПриход,
				|	ЕСТЬNULL(СУММА(ПартииОстатки.КоличествоОстаток), 0) КАК КоличествоОстаток
				|ИЗ
				|	РегистрНакопления.ОстаткиАвтомобилей.Обороты(, &НаМомент, Регистратор, ) КАК ПартииОбороты
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиАвтомобилей.Остатки(&НаМомент, ) КАК ПартииОстатки
				|		ПО ПартииОбороты.СкладКомпании = ПартииОстатки.СкладКомпании
				|			И ПартииОбороты.Автомобиль = ПартииОстатки.Автомобиль
				|			И ПартииОбороты.СтатусПартии = ПартииОстатки.СтатусПартии
				|			И ПартииОбороты.Партия = ПартииОстатки.Партия
				|ГДЕ
				|	ПартииОбороты.Регистратор В(&Регистратор)
				//      |	И ПартииОбороты.СкладКомпании = &СкладКомпании
				|
				|СГРУППИРОВАТЬ ПО
				|	ПартииОбороты.Автомобиль";
			КонецЕсли;
			Запрос=Новый Запрос;
			Запрос.Текст=ТекстЗапроса;
			Запрос.УстановитьПараметр("НаМомент",ШапкаДокумента.МоментВремени);
			Запрос.УстановитьПараметр("Регистратор",Автомобили.Выгрузить(,"ДокументОснование"));
			//Если ШапкаДокумента.ХозОперация=Справочники.ХозОперации.ПоступлениеДопРасходовВнутреннее ИЛИ
			//	 ШапкаДокумента.ХозОперация=Справочники.ХозОперации.ПоступлениеДопРасходовНаАвтомобилиВнутреннее Тогда
			//	Запрос.УстановитьПараметр("СкладКомпании",ШапкаДокумента.СкладПолучатель);
			//Иначе
			//	Запрос.УстановитьПараметр("СкладКомпании",ШапкаДокумента.СкладКомпании);
			//КонецЕсли;
			Выборка=Запрос.Выполнить().Выбрать();
			Пока Выборка.Следующий() Цикл
				Если Выборка.КоличествоПриход<>Выборка.КоличествоОстаток Тогда
					дкСообщитьРезультат("Дополнительные затраты, распределяемые на себестоимости могут быть введены только ДО СПИСАНИЯ (ПЕРЕМЕЩЕНИЯ) данной партии!","Важное&Партии товаров компании:",ЭтотОбъект);
					Отказ=Истина;
					Прервать;
				КонецЕсли; 
			КонецЦикла;
			Если Отказ Тогда
				Возврат НЕ Отказ;
			КонецЕсли; 
		КонецЕсли; 
	КонецЕсли; 
	///////////////////////////////////////////////////////////
	// Секция Альфа-Авто: Конец
	///////////////////////////////////////////////////////////
	

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ОстаткиАвтомобилейОстатки.Автомобиль,
		|	ОстаткиАвтомобилейОстатки.СкладКомпании,
		|	ОстаткиАвтомобилейОстатки.СтатусПартии,
		|	ОстаткиАвтомобилейОстатки.Партия,
		|	ОстаткиАвтомобилейОстатки.ГТД
		|ИЗ
		|	РегистрНакопления.ОстаткиАвтомобилей.Остатки(&Дата1, Автомобиль В ИЕРАРХИИ (&Авто)) КАК ОстаткиАвтомобилейОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиАвтомобилейОстатки.Автомобиль,
		|	ОстаткиАвтомобилейОстатки.СкладКомпании,
		|	ОстаткиАвтомобилейОстатки.Партия,
		|	ОстаткиАвтомобилейОстатки.ГТД,
		|	ОстаткиАвтомобилейОстатки.СтатусПартии";

	Запрос.УстановитьПараметр("Авто", ЭтотОбъект.Автомобили.ВыгрузитьКолонку("Автомобиль"));
	Запрос.УстановитьПараметр("Дата1", ЭтотОбъект.Дата);

	РезультатЗапроса = Запрос.Выполнить();

	//РезультатЗапроса = ФормированиеТаблицыАвтомобилей();
	
	мСклады=РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("СкладКомпании");
	//)
	ВДокументеТолькоКомиссионныеТовары = РезультатЗапроса.Пустой();
	
	//Если ШапкаДокумента.ХозОперация=Справочники.ХозОперации.ПоступлениеДопРасходовНаАвтомобилиВнутреннее Тогда
	//	СкладДляДвижений = ШапкаДокумента.СкладПолучатель;
	//Иначе
	//	СкладДляДвижений = ШапкаДокумента.СкладКомпании;
	//КонецЕсли;
	
	Если Не ВДокументеТолькоКомиссионныеТовары Тогда
		НаборЗаписейПартии=Движения.ОстаткиАвтомобилей;
		ТЗ = РезультатЗапроса.Выгрузить();
		Для Каждого Стр Из этотОбъект.Автомобили Цикл
			СтрТЗ = ТЗ.Найти(Стр.Автомобиль,"Автомобиль");
			
			Новая =  НаборЗаписейПартии.Добавить();
			новая.Автомобиль = Стр.Автомобиль;
			Новая.Количество = 0;
			//<<Павличенко 25.09.17
			//Новая.Партия = СтрТЗ.Партия;
			Попытка
				Новая.Партия = СтрТЗ.Партия;
			Исключение
				#Если Клиент Тогда
				Предупреждение("Для автомобиля " + Стр.Автомобиль.Наименование + "не обнаружена партия! Реализация автомобиля была проведена раньше данного документа");
				#Иначе
				Сообщить("Для автомобиля " + Стр.Автомобиль.Наименование + "не обнаружена партия! " + Строка(этотОбъект.Ссылка));
				#КонецЕсли
				Отказ = Истина;
			КонецПопытки;
			//>>Павличенко 25.09.17
			Новая.СкладКомпании = СтрТЗ.СкладКомпании;
			Новая.СтатусПартии = СтрТЗ.СтатусПартии;
			Новая.Сумма = Стр.Сумма;
			Новая.ГТД = СтрТЗ.ГТД;
			Новая.СуммаУпр = Стр.Сумма;
			Новая.суммаНДС = Стр.СуммаНДС;
			Новая.ХозОперация = справочники.ХозОперации.ПоступлениеДопРасходовНаАвтомобили;
			Новая.Активность = Истина;
			Новая.ВидДвижения = ВидДвиженияНакопления.Приход;
			Новая.Период = ЭтотОбъект.Дата;
			Новая.Регистратор = ЭтотОбъект.Ссылка;
		КонецЦикла;
		НаборЗаписейПартии.Записать();
	Иначе
		// Значит в документе-основании присутствует только комиссионый товар, тогда
		// придется все списать на расходы
		// Вычислим сумму, которую необходимо списать.
		ТекстЗапроса = 
		"
		|ВЫБРАТЬ
		|	ЕСТЬNULL(СУММА(ДокументТовары.СуммаВсего),0) КАК СуммаВсегоУпр
		|ИЗ
		|	Документ.ПоступлениеДопРасходов.Товары КАК ДокументТовары
		|ГДЕ
		|	  ДокументТовары.Ссылка=&Ссылка
		|	И ДокументТовары.Номенклатура.СпособРаспределенияДопРасходов<>&НаДоходыРасходы
		|	И ДокументТовары.Номенклатура.ВидНоменклатуры=&Услуга
		|";
		Запрос.Текст = ТекстЗапроса;
		Запрос.УстановитьПараметр("Ссылка",          Ссылка);
		Запрос.УстановитьПараметр("НаДоходыРасходы", Перечисления.СпособыРаспределенияДопРасходов.НаДоходыИРасходы);
		Запрос.УстановитьПараметр("Услуга",          Перечисления.ВидыНоменклатуры.Услуга);
		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();
		
		СуммаДляРаспределения = Выборка.СуммаВсегоУпр;
		
		Если СуммаДляРаспределения<>0 Тогда
			НаборЗаписейДиР.ДокументОбъект			= ЭтотОбъект;
			НаборЗаписейДиР.ШапкаДокумента			= ШапкаДокумента;
			Если ВедетсяБалансПоПодразделению Тогда
				//НаборЗаписейДиР.Подразделение			= СкладДляДвижений.Подразделение;
				НаборЗаписейДиР.Подразделение			= ПодразделениеКомпании;
			КонецЕсли;
			НаборЗаписейДиР.СтатьяДоходовИРасходов	= Справочники.СтатьиДоходовИРасходов.ПрочиеРасходы;
			НаборЗаписейДиР.ВУпрВалюте				= Ложь;
			НаборЗаписейДиР.Расход					= СуммаДляРаспределения;
			Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;  			
		КонецЕсли;
	КонецЕсли; 
	
	// если идет допроведение, то надо получить те значения которые были раньше
	Если Режим<>РежимПроведенияДокумента.Оперативный И Ссылка<>ДокументСсылка Тогда
		Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ СкладКомпании ИЗ РегистрНакопления.ОстаткиАвтомобилей ГДЕ Регистратор=&Ссылка");
		Запрос.УстановитьПараметр("Ссылка",ДокументСсылка);
		Результат = Запрос.Выполнить(); АвтомобильСкладКомпанииБыл=Неопределено;
		Если НЕ Результат.Пустой() Тогда
			АвтомобильСкладКомпанииБыл = Результат.Выгрузить().ВыгрузитьКолонку("СкладКомпании");
		КонецЕсли;
		ДополнительныеСвойства.Вставить("АвтомобильСкладКомпанииБыл",АвтомобильСкладКомпанииБыл);
		ДополнительныеСвойства.МоментВремениБыл = ДокументСсылка.МоментВремени();
	КонецЕсли;
	
	// двигаем границу последовательности автомобилей
	
	ДвигаемГраницу = (Режим<>РежимПроведенияДокумента.Оперативный И Движения.ОстаткиАвтомобилей.Количество()>0);
	Если ДвигаемГраницу ИЛИ ЗначениеЗаполнено(ДополнительныеСвойства.АвтомобильСкладКомпанииБыл) Тогда
		НаборЗаписейГраницыАвтомобили = РегистрыСведений.ГраницыАвтомобили.СоздатьНаборЗаписей();
		Если ДвигаемГраницу Тогда
			НаборЗаписейГраницыАвтомобили.СкладКомпании		= мСклады;
			НаборЗаписейГраницыАвтомобили.МоментВремени		= Дата;
			НаборЗаписейГраницыАвтомобили.СкладКомпанииБыл	= ДополнительныеСвойства.АвтомобильСкладКомпанииБыл;
			НаборЗаписейГраницыАвтомобили.МоментВремениБыл	= ДополнительныеСвойства.МоментВремениБыл;
		Иначе
			//НаборЗаписейГраницыАвтомобили.СкладКомпании		= ДополнительныеСвойства.АвтомобильСкладКомпанииБыл;
			НаборЗаписейГраницыАвтомобили.СкладКомпании		= мСклады;
			НаборЗаписейГраницыАвтомобили.МоментВремени		= ДополнительныеСвойства.МоментВремениБыл;
			НаборЗаписейГраницыАвтомобили.СкладКомпанииБыл	= Неопределено;
			НаборЗаписейГраницыАвтомобили.МоментВремениБыл	= Неопределено;
		КонецЕсли;
		НаборЗаписейГраницыАвтомобили.ДокументСсылка = Ссылка;
		НаборЗаписейГраницыАвтомобили.ИзменитьГраницу();
	КонецЕсли;
	
	// если идет допроведение, то надо получить те значения которые были раньше
	Если Режим<>РежимПроведенияДокумента.Оперативный И Ссылка<>ДокументСсылка Тогда
		Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ СкладКомпании ИЗ РегистрНакопления.ПартииТоваровКомпании ГДЕ Регистратор=&Ссылка");
		Запрос.УстановитьПараметр("Ссылка",ДокументСсылка);
		Результат = Запрос.Выполнить(); СкладКомпанииБыл=Неопределено;
		Если НЕ Результат.Пустой() Тогда
			СкладКомпанииБыл = Результат.Выгрузить().ВыгрузитьКолонку("СкладКомпании");
		КонецЕсли;
		//ДополнительныеСвойства.Вставить("СкладКомпанииБыл",СкладКомпанииБыл);
		ДополнительныеСвойства.МоментВремениБыл = ДокументСсылка.МоментВремени();
	КонецЕсли;
	// двигаем границу последовательности партий	
	ДвигаемГраницу = (Режим<>РежимПроведенияДокумента.Оперативный И Движения.ПартииТоваровКомпании.Количество()>0);
	Если ДвигаемГраницу ИЛИ ЗначениеЗаполнено(ДополнительныеСвойства.СкладКомпанииБыл) Тогда
		
		НаборЗаписейГраницыПартий = РегистрыСведений.ГраницыПартий.СоздатьНаборЗаписей();
		Если ДвигаемГраницу Тогда
			НаборЗаписейГраницыПартий.СкладКомпании		= мСклады;
			НаборЗаписейГраницыПартий.МоментВремени		= ШапкаДокумента.Дата;
			//НаборЗаписейГраницыПартий.СкладКомпанииБыл	= ДополнительныеСвойства.СкладКомпанииБыл;
			НаборЗаписейГраницыПартий.МоментВремениБыл	= ДополнительныеСвойства.МоментВремениБыл;
		Иначе
			//НаборЗаписейГраницыПартий.СкладКомпании		= ДополнительныеСвойства.СкладКомпанииБыл;
			НаборЗаписейГраницыПартий.МоментВремени		= ДополнительныеСвойства.МоментВремениБыл;
			НаборЗаписейГраницыПартий.СкладКомпанииБыл	= Неопределено;
			НаборЗаписейГраницыПартий.МоментВремениБыл	= Неопределено;
		КонецЕсли;
		НаборЗаписейГраницыПартий.ДокументСсылка = ШапкаДокумента.Ссылка;
		НаборЗаписейГраницыПартий.ИзменитьГраницу();
	КонецЕсли;
	
	// БАЛАНС: определим необходимость формирования корректирующих проводок по партиям.
	//ПодразделениеСклад                 = обПолучитьБалансовоеПодразделение(СкладДляДвижений.Подразделение);		
	ПодразделениеДоговорВзаиморасчетов = обПолучитьБалансовоеПодразделение(ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение);
	//
	//dmim rarus{
	ЗапросПодразделения	= Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПоступлениеДопРасходовНаАвтомобильАвтомобили.ДокументОснование.СкладКомпании.Подразделение КАК ПодразделениеОснования
	|ИЗ
	|	Документ.ПоступлениеДопРасходовНаАвтомобили.Автомобили КАК ПоступлениеДопРасходовНаАвтомобильАвтомобили
	|ГДЕ
	|	ПоступлениеДопРасходовНаАвтомобильАвтомобили.Ссылка = &Ссылка");
	ЗапросПодразделения.УстановитьПараметр("Ссылка",Ссылка);
	Выборка	= ЗапросПодразделения.Выполнить().Выбрать();
	Если Выборка.Количество()>1 Тогда
		БалансовыеПодразделенияНеРавны=Истина;
	ИначеЕсли Выборка.Количество()=1 Тогда 
		Выборка.Следующий();
		Если  Выборка.ПодразделениеОснования=ПодразделениеДоговорВзаиморасчетов Тогда
			БалансовыеПодразделенияНеРавны=Ложь;
		Иначе
			БалансовыеПодразделенияНеРавны=истина;
		КонецЕсли;
	КонецЕсли;	
	//БалансовыеПодразделенияНеРавны     = (ПодразделениеДоговорВзаиморасчетов<>ПодразделениеСклад);
	//}	
	Если ВедетсяБалансПоПодразделению и БалансовыеПодразделенияНеРавны и ШапкаДокумента.ДокументОснованиеХозОперация<>Справочники.ХозОперации.ПоступлениеТоваровКомиссия И ШапкаДокумента.ДокументОснованиеХозОперация<>Справочники.ХозОперации.ПоступлениеАвтомобилейКомиссия Тогда
		Если Не ВДокументеТолькоКомиссионныеТовары Тогда
			СуммаДляРаспределения = НаборЗаписейПартии.Итог("СуммаУпр");
		КонецЕсли;
		
		Если СуммаДляРаспределения<>0 Тогда
			НаборЗаписейДиР.ДокументОбъект			= ЭтотОбъект;
			НаборЗаписейДиР.ШапкаДокумента			= ШапкаДокумента;						
			//НаборЗаписейДиР.Подразделение			= СкладДляДвижений.Подразделение;
			НаборЗаписейДиР.Подразделение			= ПодразделениеКомпании;
			НаборЗаписейДиР.СтатьяДоходовИРасходов	= Справочники.СтатьиДоходовИРасходов.КорректировкаБалансаПоПодразделениям;
			НаборЗаписейДиР.ВУпрВалюте				= Истина;
			НаборЗаписейДиР.Доход					= СуммаДляРаспределения;
			Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;
		КонецЕсли;
	КонецЕсли;	
	
	//Услуги, распределяемые на доходы и расходы туда и поместим
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ПоступлениеДопРасходовТовары.Номенклатура.СтатьяДопРасходов КАК СтатьяДопРасходов,
	|	СУММА(ПоступлениеДопРасходовТовары.СуммаВсего) КАК Сумма
	|ИЗ
	|	Документ.ПоступлениеДопРасходов.Товары КАК ПоступлениеДопРасходовТовары
	|ГДЕ
	|	ПоступлениеДопРасходовТовары.Ссылка = &Ссылка И
	|	ПоступлениеДопРасходовТовары.Номенклатура.ВидНоменклатуры = &Услуга И
	|	ПоступлениеДопРасходовТовары.Номенклатура.СпособРаспределенияДопРасходов = &СпособРаспределенияДопРасходов
	|СГРУППИРОВАТЬ ПО
	|	ПоступлениеДопРасходовТовары.Номенклатура.СтатьяДопРасходов";
	Запрос.УстановитьПараметр("Ссылка",ШапкаДокумента.Ссылка);
	Запрос.УстановитьПараметр("Услуга",Перечисления.ВидыНоменклатуры.Услуга);
	Запрос.УстановитьПараметр("СпособРаспределенияДопРасходов",Перечисления.СпособыРаспределенияДопРасходов.НаДоходыИРасходы);
	Выборка = Запрос.Выполнить().Выбрать();
	
	ФлагУпрВалюты = (ВалютаДокумента=Константы.ВалютаУправленческогоУчетаКомпании.Получить());
	
	Пока Выборка.Следующий() Цикл
		НаборЗаписейДиР.ДокументОбъект			= ЭтотОбъект;
		НаборЗаписейДиР.ШапкаДокумента			= ШапкаДокумента;
		Если ВедетсяБалансПоПодразделению Тогда
			//НаборЗаписейДиР.Подразделение			= СкладДляДвижений.Подразделение;
			НаборЗаписейДиР.Подразделение			= ПодразделениеКомпании;
		КонецЕсли;
		НаборЗаписейДиР.СтатьяДоходовИРасходов	= Выборка.СтатьяДопРасходов;
		НаборЗаписейДиР.ВУпрВалюте				= ФлагУпрВалюты;
		НаборЗаписейДиР.Расход					= Выборка.Сумма;
		Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;
		
		// БАЛАНС: если нужно создаем корректирующие движения по доходам и расходам.
		Если ВедетсяБалансПоПодразделению и БалансовыеПодразделенияНеРавны Тогда
			НаборЗаписейДиР.ДокументОбъект			= ЭтотОбъект;
			НаборЗаписейДиР.ШапкаДокумента			= ШапкаДокумента;
			//НаборЗаписейДиР.Подразделение			= СкладДляДвижений.Подразделение;
			НаборЗаписейДиР.Подразделение			= ПодразделениеКомпании;
			
			НаборЗаписейДиР.СтатьяДоходовИРасходов	= Справочники.СтатьиДоходовИРасходов.КорректировкаБалансаПоПодразделениям;
			НаборЗаписейДиР.ВУпрВалюте				= ФлагУпрВалюты;
			НаборЗаписейДиР.Доход					= Выборка.Сумма;
			Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;
		КонецЕсли;	
	КонецЦикла;
	Возврат НЕ Отказ;
КонецФункции // ПровестиПоПартиям()

// Обработка изменения реквизитов документа
// Параметры
//  Имя			– Строка			– Имя реквизита документа с полным путем (например Тавары.Номенклатура).
//  ЭтаФорма	– Форма				– Ссылка на форму документа. Если значение неопределено, производится программная обработка реквизитов.
//  ТекСтрока	– СтрокаТабличнойЧасти – Ссылка на строку табличной части документа, реквизит которой обрабатывается.
//										 Имеет смысл только для табличных частей документов.
//  ДопПараметры– Стркутура			– Структура, содержащая дополнительные параметры обработки реквизита.
// Возвращаемое значение:
//   Булево   – Результат выполнения обработки.
Функция ОбработкаРеквизита(Имя,ТекСтрока=Неопределено,ЭтаФорма=Неопределено,ДопПараметры=Неопределено) Экспорт
	Если Имя="Контрагент" Тогда
		Рез = дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма);
		
		//ТаблицаТоваров=ЭтотОбъект.Товары;
		//ОсвобожденОтНДС=ЭтотОбъект.Контрагент.ОсвобожденОтНДС;
		//Для Каждого СтрокаТоваров Из ТаблицаТоваров Цикл
		//	Если ОсвобожденОтНДС Тогда
		//		СтрокаТоваров.СтавкаНДС=Справочники.СтавкиНДС.БезНДС;
		//	Иначе
		//		СтрокаТоваров.СтавкаНДС=СтрокаТоваров.Номенклатура.СтавкаНДС;
		//	КонецЕсли; 
		//	Рез = Рез И ЭтотОбъект.ОбработкаРеквизита("Товары.СтавкаНДС",СтрокаТоваров,ЭтаФорма,ДопПараметры);
		//КонецЦикла;
		
		Возврат Рез;
		//ОБРАБОТКА ТАБЛИЧНОЙ ЧАСТИ "АВТОМОБИЛИ"
	ИначеЕсли Имя="Автомобили.Автомобиль" Тогда
		//Проставим количество
		ТекСтрока.Количество	= 1;
		Если обЗначениеНеЗаполнено(ТекСтрока.СтавкаНДС) Тогда
			ОсвобожденОтНДС=ПодразделениеКомпании.ОсвобожденОтНДС ИЛИ Организация.ОсвобожденОтНДС;
			Если ОсвобожденОтНДС Тогда
				ТекСтрока.СтавкаНДС=Справочники.СтавкиНДС.БезНДС;
			Иначе
				ТекСтрока.СтавкаНДС=Справочники.СтавкиНДС.ОсновнаяСтавкаНДС;
			КонецЕсли; 
		КонецЕсли; 
		
		Результат=ОбработкаРеквизита("Автомобили.Цена",ТекСтрока,ЭтаФорма,ДопПараметры);
		//ДобавитьОборудованиеАвтомобиля(ТекСтрока.Автомобиль,Истина);
		#Если Клиент Тогда
			Если ЭтаФорма<>Неопределено Тогда
				дкВывестиЗаголовокСуммаДокумента(ЭтаФорма);
			КонецЕсли; 
		#КонецЕсли
		
	ИначеЕсли Имя="Автомобили.Цена" Тогда
		ТекСтрока.Сумма=ТекСтрока.Цена*ТекСтрока.Количество;
		ЦенаВключаетНДС=?(обЗначениеНеЗаполнено(ТипЦен),Истина,ТипЦен.ЦенаВключаетНДС);
		Если ЦенаВключаетНДС Тогда
			//Цена уже содержит НДС - Сумма всего равна сумме
			ТекСтрока.СуммаВсего=ТекСтрока.Сумма;
			СуммаБезНДС=(100*ТекСтрока.СуммаВсего)/(100+ТекСтрока.СтавкаНДС.Ставка);
			ТекСтрока.СуммаНДС=ТекСтрока.СуммаВсего-СуммаБезНДС;
		Иначе
			//НДС в цену не включен - Получим сумму НДС
			ТекСтрока.СуммаНДС=(ТекСтрока.Сумма*ТекСтрока.СтавкаНДС.Ставка)/100;
			ТекСтрока.СуммаВсего=ТекСтрока.Сумма+ТекСтрока.СуммаНДС;
		КонецЕсли;
		Возврат Истина;
	ИначеЕсли Имя="Автомобили.Сумма" Тогда
		ТекСтрока.Цена=?(ТекСтрока.Количество=0,0,ТекСтрока.Сумма/ТекСтрока.Количество);
	ИначеЕсли Имя="Автомобили.СтавкаНДС" Тогда
		СуммаВсегоБезСкидки  = ТекСтрока.Сумма;	// База для расчета НДС
		ЦенаВключаетНДС=(обЗначениеНеЗаполнено(ТипЦен) ИЛИ ТипЦен.ЦенаВключаетНДС);
		// Расчет НДС
		Если ЦенаВключаетНДС Тогда
			ТекСтрока.СуммаНДС = Окр((СуммаВсегоБезСкидки * ТекСтрока.СтавкаНДС.Ставка)/(100 + ТекСтрока.СтавкаНДС.Ставка),2);
		Иначе
			ТекСтрока.СуммаНДС =  Окр(СуммаВсегоБезСкидки * ТекСтрока.СтавкаНДС.Ставка / 100,2);
		КонецЕсли; 			
		// В любом случаее идем в секцию "СуммаНДС", т.к. в ней будем произведен расчет суммы всего.
		РезультатОбработки = ЭтотОбъект.ОбработкаРеквизита("Автомобили.СуммаНДС", ТекСтрока, ЭтаФорма, ДопПараметры);
		
	ИначеЕсли Имя="Автомобили.СуммаНДС" Тогда
		// Вычисляем сумму с учетом скидок.
		СуммаВсегоБезСкидки = ТекСтрока.Сумма;
		ЦенаВключаетНДС=(обЗначениеНеЗаполнено(ТипЦен) ИЛИ ТипЦен.ЦенаВключаетНДС);
		Если ЦенаВключаетНДС Тогда			
			ТекСтрока.СуммаВсего = СуммаВсегоБезСкидки;			
		Иначе
			ТекСтрока.СуммаВсего = СуммаВсегоБезСкидки + ТекСтрока.СуммаНДС;			
		КонецЕсли;
		
	ИначеЕсли Имя="Автомобили.СуммаВсего" Тогда
		// Определим включают ли в себя НДС цены документа
		ЦенаВключаетНДС=(обЗначениеНеЗаполнено(ЭтотОбъект.ТипЦен) ИЛИ ЭтотОбъект.ТипЦен.ЦенаВключаетНДС);
		// Рассчитаем значение реквизита "Сумма". Если расчет НДС не ведется, то ЦенаВключаетНДС будет всегда Истина. 
		Если ЦенаВключаетНДС Тогда
			ТекСтрока.Сумма = ТекСтрока.СуммаВсего;
		Иначе
			Сумма = Окр(ТекСтрока.СуммаВсего * 100 / (100 + ТекСтрока.СтавкаНДС.Ставка),2);
			ТекСтрока.Сумма = Сумма;
		КонецЕсли;
		// Пересчитываем цену.
		ТекСтрока.Цена = ?(ТекСтрока.Количество=0,ТекСтрока.Сумма,Окр(ТекСтрока.Сумма/ТекСтрока.Количество,2));
		// Вычисляем новую сумму "шапочной" скидки приходящейся на текущую строку.
		// Расчитываем новую сумму НДС. 		
		Если ЦенаВключаетНДС Тогда			
			ТекСтрока.СуммаНДС = Окр((ТекСтрока.СуммаВсего * ТекСтрока.СтавкаНДС.Ставка)/(100 + ТекСтрока.СтавкаНДС.Ставка),2);
		Иначе
			ТекСтрока.СуммаНДС = Окр(ТекСтрока.СуммаВсего * ТекСтрока.СтавкаНДС.Ставка / 100,2);
		КонецЕсли;
		// Выполним расчет итоговой суммы скидки на документ.
		
	Иначе Возврат дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры);
	КонецЕсли;
КонецФункции // ОбработкаРеквизита()

// заполнение свойств из документа основания
Процедура ЗаполнитьСвойстваНаОсновании(Основание) Экспорт
	//зарезервировано для описания заполнения свойств из свойств основания
КонецПроцедуры


#Если Клиент Тогда
	////////////////////////////////////////////////////////////////////////////////
	// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ПЕЧАТИ ДОКУМЕНТА
	
	//Функция печати этикеток и ценников
	// 
	// Параметры:
	//  ТабДокумент - табличный документ.
	//
	Функция ПечатьЭтикетокИЦенников(ТабДокумент) Экспорт
		дкПечатьЭтикетокИЦенников(ЭтотОбъект);
	КонецФункции // ПечатьЭтикетокИЦенников()
	
	// Формирует печатную форму "ПоступлениеДопРасходов"
	// 
	// Параметры:
	//  ТабДокумент - табличный документ.
	//
	// Возвращаемое значение:
	//  ТабДокумент - возвращает сформированный табличный документ.
	//
	Функция ПечатьПоступлениеДопРасходов(ТабДокумент) Экспорт
		Макет = ПолучитьМакет("ПоступлениеДопРасходов");
		
		//для начала настроим макет
		ОбластьШапкаТаблицы = дкПривестиМакетПечатнойФормы(ЭтотОбъект,Макет);
		ФорматВыводаСуммы = обПраво("ФорматВыводаСуммы",Права);
		
		//вывод заголовка документа
		ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
		ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
		ТекстЗаголовка = дкПолучитьПредставление(ЭтотОбъект);
		ОбластьМакета.Параметры.ТекстЗаголовка			= ТекстЗаголовка;
		Если НЕ обЗначениеНеЗаполнено(ПодразделениеКомпании) И НЕ обЗначениеНеЗаполнено(ПодразделениеКомпании.КПП) Тогда
			СтрокаПредставления = спПолучитьПредставление(Организация);
			ОбластьМакета.Параметры.ПредставлениеПоставщика = СтрЗаменить(СтрокаПредставления, Организация.КПП, ПодразделениеКомпании.КПП);
		Иначе	
			ОбластьМакета.Параметры.ПредставлениеПоставщика	= спПолучитьПредставление(Организация);
		КонецЕсли;
		ОбластьМакета.Параметры.ПредставлениеПокупателя	= спПолучитьПредставление(Контрагент);
		
		//вывод свойств
		СтрокаСвойств = дкПолучитьСтрокуСвойствДокумента(ЭтотОбъект);
		ОбластьМакета.Параметры.СтрокаСвойств = СтрокаСвойств;
		ТабДокумент.Вывести(ОбластьМакета);
		
		НомерСтраницы = 2;
		НомерСтраницыПред = НомерСтраницы;
		
		//теперь выводим шапку
		ТабДокумент.Вывести(ОбластьШапкаТаблицы);
		
		ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
		
		//готовим области строки
		ОбластьМакета = Макет.ПолучитьОбласть("Строка");
		
		ОбластьМакетаИтогоПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице");
		СтруктураИтоговПоСтранице = Новый Структура("ВалютаДокумента,СуммаНДС,СуммаВсего",ВалютаДокумента,0,0);
		
		//заполним параметры шапки таблицы для следующего листа
		ОбластьШапкаТаблицы.Параметры.ТекстЗаголовка = ТекстЗаголовка;
		ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы;
		
		//перебор строк
		ВыборкаТабличнойЧасти = ЭтотОбъект.Автомобили;
		Для каждого СтрокаТабличнойЧасти Из ВыборкаТабличнойЧасти Цикл
			//заполняем данные строки
			СтруктураСтроки = дкПолучитьПредставлениеДанныхТоварнойСтроки(СтрокаТабличнойЧасти,Права);
			ОбластьМакета.Параметры.Заполнить(СтруктураСтроки);
			
			//доп. области
			мсвДопОбластиПодвала = Неопределено;
			Если ВыборкаТабличнойЧасти.Индекс(СтрокаТабличнойЧасти) = ВыборкаТабличнойЧасти.Количество()-1 Тогда
				мсвДопОбластиПодвала = Новый Массив;
				мсвДопОбластиПодвала.Добавить(ОбластьПодвал);
			КонецЕсли;
			
			//выводим строку, делая проверку попадания на лист
			НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьМакета, ОбластьШапкаТаблицы, ОбластьМакетаИтогоПоСтранице,
			НомерСтраницы, СтруктураИтоговПоСтранице, Права, мсвДопОбластиПодвала);
			
			//инициализация итогов по странице
			Если НомерСтраницы <> НомерСтраницыПред Тогда
				СтруктураИтоговПоСтранице = Новый Структура("ВалютаДокумента,СуммаНДС,СуммаВсего",ВалютаДокумента,0,0);
				НомерСтраницыПред = НомерСтраницы;
				ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
			КонецЕсли;
			//добавляем итоги
			дкДобавитьИтогиПоСтранице(СтрокаТабличнойЧасти,СтруктураИтоговПоСтранице);
			
		КонецЦикла;
		
		//довыводим последний подвал, если страниц больше единицы
		Если НомерСтраницы > 2 Тогда
			дкВывестиИтогиПоСтранице(ТабДокумент,ОбластьМакетаИтогоПоСтранице,СтруктураИтоговПоСтранице,Права);
		КонецЕсли;
		
		//итоги
		ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
		ОбластьПодвал.Параметры.ВалютаДокумента = ВалютаДокумента;
		СуммаВсего = ВыборкаТабличнойЧасти.Итог("СуммаВсего");
		ОбластьПодвал.Параметры.СуммаВсего = Формат(СуммаВсего, ФорматВыводаСуммы);
		НДСВсего = ВыборкаТабличнойЧасти.Итог("СуммаНДС");
		ОбластьПодвал.Параметры.НДСВсего = Формат(НДСВсего, ФорматВыводаСуммы);
		ОбластьПодвал.Параметры.СуммаПрописью = "Всего наименований " + ВыборкаТабличнойЧасти.Количество()+ " на сумму "
		+ обЧислоПрописью(СуммаВсего, ВалютаДокумента);
		
		// Выводим представления и расшифровки подписей
		Отпустил = дкОтветственноеЛицо(ЭтотОбъект,"ОтпустилКонтрагент");
		Отпустил.ОтпустилКонтрагентПредставление = ?(обЗначениеНеЗаполнено(Отпустил.ОтпустилКонтрагент),"","/ "+ Отпустил.ОтпустилКонтрагентПредставление);
		ОбластьПодвал.Параметры.Заполнить(Отпустил);
		Получил  = дкОтветственноеЛицо(ЭтотОбъект,"Получил");
		Получил.ПолучилПредставление = ?(обЗначениеНеЗаполнено(Получил.Получил),"","/ "+ Получил.ПолучилПредставление);
		ОбластьПодвал.Параметры.Заполнить(Получил);
		
		НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьПодвал, , , НомерСтраницы,,Права);
		
		Возврат ТабДокумент;
	КонецФункции // ПечатьПоступлениеДопРасходов()
	
	// Формирует печатную форму "ТОРГ-12"
	// 
	// Параметры:
	//  ТабДокумент - табличный документ.
	//
	// Возвращаемое значение:
	//  ТабДокумент - возвращает сформированный табличный документ.
	//
	Функция ПечатьТОРГ12(ТабДокумент) Экспорт
		ФорматВыводаСуммы = обПраво("ФорматВыводаСуммы", Права);
		ФорматВыводаКоличества = обПраво("ФорматВыводаКоличества", Права);
		
		// Зададим параметры макета
		ТабДокумент.ПолеСверху = 0;
		ТабДокумент.ПолеСлева  = 0;
		ТабДокумент.ПолеСнизу  = 0;
		ТабДокумент.ПолеСправа = 0;
		ТабДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
		
		Макет = ПолучитьОбщийМакет("ТОРГ12");
		
		ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
		ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
		
		СтруктураПредставления1=Новый Структура(
		"Наименование,ИНН,АдресЮридический,ТелефонРабочий,БанковскийСчет,Банк,БИК,КоррСчет",
		"","ИНН ","","тел.: ","р/с ","в банке ","БИК ","к/с "
		);
		СтруктураПредставления2=Новый Структура(
		"Наименование,ИНН,АдресФактический,ТелефонРабочий,БанковскийСчет,Банк,БИК,КоррСчет",
		"","ИНН ","","тел.: ","р/с ","в банке ","БИК ","к/с "
		);
		
		// Правим, что автоматом не заполнилось, или заполнилось неправильно
		ОбластьМакета.Параметры.ОрганизацияПредставление= спПолучитьПредставление(ЭтотОбъект.Контрагент,СтруктураПредставления1);
		ОбластьМакета.Параметры.ПодразделениеКомпании	= Неопределено;
		
		ОбластьМакета.Параметры.Поставщик				= обПолучитьЗначениеСвойства(ЭтотОбъект,"ПоставщикКонтрагент",ЭтотОбъект.Контрагент);
		ОбластьМакета.Параметры.ПоставщикПредставление	= спПолучитьПредставление(ОбластьМакета.Параметры.Поставщик,СтруктураПредставления2);
		
		ОбластьМакета.Параметры.Грузополучатель				= обПолучитьЗначениеСвойства(ЭтотОбъект,"Грузополучатель",ЭтотОбъект.Организация);
		ОбластьМакета.Параметры.ГрузополучательПредставление= спПолучитьПредставление(ОбластьМакета.Параметры.Грузополучатель,СтруктураПредставления2);
		ОбластьМакета.Параметры.Плательщик					= обПолучитьЗначениеСвойства(ЭтотОбъект,"Плательщик",ЭтотОбъект.Организация);
		ОбластьМакета.Параметры.ПлательщикПредставление		= спПолучитьПредставление(ОбластьМакета.Параметры.Плательщик,СтруктураПредставления1);
		
		//дальше заполнить Шапку
		ОбластьМакета.Параметры.КодПоОКПО				= ЭтотОбъект.Контрагент.КодПоОКПО;
		//ОбластьМакета.Параметры.ВидДеятельностиПоОКДП	= ЭтотОбъект..КодПоОКДП;
		ОбластьМакета.Параметры.ГрузополучательПоОКПО	= ОбластьМакета.Параметры.Грузополучатель.КодПоОКПО;
		ОбластьМакета.Параметры.ПоставщикПоОКПО			= ОбластьМакета.Параметры.Поставщик.КодПоОКПО;
		ОбластьМакета.Параметры.ПлательщикПоОКПО		= ОбластьМакета.Параметры.Плательщик.КодПоОКПО;
		
		ОбластьМакета.Параметры.ДокументОснованиеПредставление = ДоговорВзаиморасчетов.Наименование;
		ОбластьМакета.Параметры.ДокументОснование = ДоговорВзаиморасчетов;
		ОбластьМакета.Параметры.ОснованиеДата = "";
		ОбластьМакета.Параметры.ОснованиеНомер = ""; 
		
		ОбластьМакета.Параметры.Номер = дкПолучитьНомерДляПечати(ЭтотОбъект);	
		ТабДокумент.Вывести(ОбластьМакета);
		
		НомерСтраницы	= 2;
		НомерСтраницыПред = НомерСтраницы;
		КоличествоСтрокНаТекущейСтранице=0;
		
		ОбластьЗаголовокТаблицы	= Макет.ПолучитьОбласть("ЗаголовокТаблицы");
		ОбластьСтрока			= Макет.ПолучитьОбласть("Строка");
		ОбластьИтоги			= Макет.ПолучитьОбласть("ИтогоПоСтранице");
		ОбластьВсего			= Макет.ПолучитьОбласть("Всего");
		ОбластьВсегоСтавкаНДС	= Макет.ПолучитьОбласть("ВсегоСтавкаНДС");
		
		СтруктураИтоговПоСтранице = Новый Структура("ИтогКоличествоПоСтранице,ИтогСуммыПоСтранице,ИтогНДСПоСтранице,ИтогСуммыСНДСПоСтранице",0,0,0,0);		
		
		ТабДокумент.Вывести(ОбластьЗаголовокТаблицы);	
		
		ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
		
		//заполним параметры шапки таблицы для следующего листа
		ОбластьЗаголовокТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
		
		ВыборкаСтрок = ЭтотОбъект.Товары;
		
		КоличествоСтрок = ВыборкаСтрок.Количество();
		
		// инициализация итогов по документу
		ИтогоКоличество = 0;
		ИтогоСумма      = 0;
		ИтогоНДС        = 0;
		ИтогоСуммаСНДС  = 0;
		
		СоответствиеИтоговПоставкамНДС = Новый Соответствие();
		
		// Выводим многострочную часть докмента
		Для каждого СтрокаТоваров Из ВыборкаСтрок Цикл
			//заполняем данные строки
			СтруктураСтроки = дкПолучитьПредставлениеДанныхТоварнойСтроки(СтрокаТоваров,Права);
			ОбластьСтрока.Параметры.Заполнить(СтруктураСтроки);
			ОбластьСтрока.Параметры.БазоваяЕдиницаНаименование	= СтрокаТоваров.ЕдиницаИзмерения;
			ОбластьСтрока.Параметры.БазоваяЕдиницаКодПоОКЕИ		= СтрокаТоваров.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код;
			ОбластьСтрока.Параметры.Количество					= Формат(СтрокаТоваров.Количество,ФорматВыводаКоличества);
			ОбластьСтрока.Параметры.КоличествоМест				= Формат(СтрокаТоваров.Количество*СтрокаТоваров.Коэффициент,ФорматВыводаКоличества);
			ОбластьСтрока.Параметры.КоличествоВОдномМесте		= Формат(СтрокаТоваров.Коэффициент,ФорматВыводаКоличества);
			
			//доп. области
			мсвДопОбластиПодвала = Неопределено;
			Если ВыборкаСтрок.Индекс(СтрокаТоваров) = ВыборкаСтрок.Количество()-1 Тогда
				мсвДопОбластиПодвала = Новый Массив;
				мсвДопОбластиПодвала.Добавить(ОбластьВсего);
				мсвДопОбластиПодвала.Добавить(ОбластьВсегоСтавкаНДС);
				мсвДопОбластиПодвала.Добавить(ОбластьПодвал);
			КонецЕсли;
			
			Если КоличествоСтрокНаТекущейСтранице=0 Тогда
				ТабДокумент.Вывести(ОбластьСтрока);
			Иначе
				//выводим строку, делая проверку попадания на лист		
				НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьСтрока, ОбластьЗаголовокТаблицы, ОбластьИтоги,
				НомерСтраницы, СтруктураИтоговПоСтранице, Права, мсвДопОбластиПодвала);
			КонецЕсли; 
			
			// увеличим итоги по странице
			СтруктураСтрокиИтогов = Новый Структура("ИтогКоличествоПоСтранице,ИтогСуммыПоСтранице,ИтогНДСПоСтранице,ИтогСуммыСНДСПоСтранице");
			СтруктураСтрокиИтогов.ИтогКоличествоПоСтранице = СтрокаТоваров.Количество;
			СтруктураСтрокиИтогов.ИтогСуммыПоСтранице      = СтрокаТоваров.СуммаВсего-СтрокаТоваров.СуммаНДС;
			СтруктураСтрокиИтогов.ИтогНДСПоСтранице		   = СтрокаТоваров.СуммаНДС;
			СтруктураСтрокиИтогов.ИтогСуммыСНДСПоСтранице   = СтрокаТоваров.СуммаВсего;
			
			//инициализация итогов по странице
			Если НомерСтраницы <> НомерСтраницыПред Тогда
				СтруктураИтоговПоСтранице = Новый Структура("ИтогКоличествоПоСтранице,ИтогСуммыПоСтранице,ИтогНДСПоСтранице,ИтогСуммыСНДСПоСтранице",0,0,0,0);
				НомерСтраницыПред = НомерСтраницы;
				КоличествоСтрокНаТекущейСтранице=0;
				ОбластьЗаголовокТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
			Иначе
				КоличествоСтрокНаТекущейСтранице=КоличествоСтрокНаТекущейСтранице+1;
			КонецЕсли;
			//добавляем итоги
			дкДобавитьИтогиПоСтранице(СтруктураСтрокиИтогов,СтруктураИтоговПоСтранице);
			
			// итоги по ставкам НДС
			Если НЕ обЗначениеНеЗаполнено(СтрокаТоваров.СтавкаНДС) Тогда
				Если СоответствиеИтоговПоставкамНДС[СтрокаТоваров.СтавкаНДС] = Неопределено Тогда
					СоответствиеИтоговПоставкамНДС.Вставить(СтрокаТоваров.СтавкаНДС,0);
				КонецЕсли;
				СоответствиеИтоговПоставкамНДС[СтрокаТоваров.СтавкаНДС] = СоответствиеИтоговПоставкамНДС[СтрокаТоваров.СтавкаНДС] + СтрокаТоваров.СуммаНДС;
			КонецЕсли;
		КонецЦикла;
		
		//довыводим последний подвал, если страниц больше единицы
		Если НомерСтраницы > 2 Тогда
			дкВывестиИтогиПоСтранице(ТабДокумент,ОбластьИтоги,СтруктураИтоговПоСтранице,Права);
		КонецЕсли;
		
		// Выводим итоги по документу в целом
		ОбластьВсего.Параметры.ИтогКоличество = Формат(ВыборкаСтрок.Итог("Количество"), ФорматВыводаКоличества);
		ОбластьВсего.Параметры.ИтогСуммы      = Формат(ВыборкаСтрок.Итог("СуммаВсего")-ВыборкаСтрок.Итог("СуммаНДС"), ФорматВыводаСуммы);
		ОбластьВсего.Параметры.ИтогНДС        = Формат(ВыборкаСтрок.Итог("СуммаНДС"), ФорматВыводаСуммы);
		ОбластьВсего.Параметры.ИтогСуммыСНДС  = Формат(ВыборкаСтрок.Итог("СуммаВсего"), ФорматВыводаСуммы);
		ТабДокумент.Вывести(ОбластьВсего);
		
		// выведем итоги по ставкам НДС
		Для Каждого ЭлементСоответствия Из СоответствиеИтоговПоставкамНДС Цикл
			ОбластьВсегоСтавкаНДС.Параметры.СтавкаНДС = "Итого по ставке НДС: "+дкПолучитьПредставлениеСтавкиНДС(ЭлементСоответствия.Ключ,"%");
			ОбластьВсегоСтавкаНДС.Параметры.ИтогНДС = ЭлементСоответствия.Значение;
			НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьВсегоСтавкаНДС, , , НомерСтраницы,,Права);
		КонецЦикла;
		
		// Выводим подвал документа
		ОбластьПодвал.Параметры.Заполнить(ЭтотОбъект);
		ОбластьПодвал.Параметры.КоличествоПорядковыхНомеровЗаписейПрописью = ЧислоПрописью(КоличествоСтрок, ,",,,,,,,,0");
		ОбластьПодвал.Параметры.СуммаПрописью = обЧислоПрописью(ЭтотОбъект.Товары.Итог("СуммаВсего"),ЭтотОбъект.ВалютаДокумента);
		
		Доверенность = обПолучитьЗначениеСвойства(ЭтотОбъект,"Доверенность");
		Если НЕ обЗначениеНеЗаполнено(Доверенность) Тогда
			ОбластьПодвал.Параметры.ДоверенностьНомер = ?(ПустаяСтрока(Доверенность.Серия),"",Доверенность.Серия + "-") + Доверенность.Номер;
			ОбластьПодвал.Параметры.ДоверенностьДата  = Доверенность.ДатаВыдачи;
			ОбластьПодвал.Параметры.ДоверенностьВыдана= Доверенность.КемВыдан;
		КонецЕсли; 
		
		ДатаОтгрузки=обПолучитьЗначениеСвойства(ЭтотОбъект,"ДатаОтгрузки",Дата('00010101'));
		ДатаОтгрузки=?(обЗначениеНеЗаполнено(ДатаОтгрузки),"""___""____________ 20___",Формат(ДатаОтгрузки,"ДФ=dd.MM.yyyy"));
		ОбластьПодвал.Параметры.ДатаОтгрузки = ДатаОтгрузки;
		
		// Заполним информациию о руководителях организации
		Руководитель = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.Руководитель);
		ОбластьПодвал.Параметры.Заполнить(Руководитель);
		
		ГлавныйБухгалтер = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.ГлавныйБухгалтер);
		ОбластьПодвал.Параметры.Заполнить(ГлавныйБухгалтер);
		
		Отпустил = дкОтветственноеЛицо(ЭтотОбъект,"Отпустил");
		ОбластьПодвал.Параметры.Заполнить(Отпустил);
		
		Получил = дкОтветственноеЛицо(ЭтотОбъект,"Получил");
		ОбластьПодвал.Параметры.Заполнить(Получил);
		
		НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьПодвал, , , НомерСтраницы,,Права);
		
		ТабДокумент.АвтоМасштаб = Истина;
		
		Возврат ТабДокумент;
		
	КонецФункции // ПечатьТОРГ12()
	
	// Функция осуществляет печать произвольного документа.
	// Можно направить печать на экран или принтер, а также распечатать необходмое количество копий.
	//
	// Параметры:
	//	ЭтотОбъект							- ДокументОбъект	- Документ для печати
	//	НазваниеПечатнойФормы 				- Строка			- Название печатной формы, если пусто, то по умолчанию
	//	КоличествоЭкземпляров				- Число				- Количество экземпляров документа
	//	НаПринтер							- Булево			- Признак отправки документа на принтер без отображения его на экране
	//  Документ 	  						- ТабличныйДокумент	- Макет печатной формы
	//
	// Возвращаемое значение:
	//   ТабличныйДокумент	- Сформированная печатная форма
	//
	Функция Печать(НазваниеПечатнойФормы="", КоличествоЭкземпляров=0, НаПринтер=Ложь, Документ=Неопределено) Экспорт
		Возврат дкПечать(ЭтотОбъект, НазваниеПечатнойФормы, КоличествоЭкземпляров, НаПринтер, Документ);
	КонецФункции // Печать()
	
	// Возвращает доступные варианты печати документа
	// Вовращаемое значение: 
	//  Струткура, каждая строка которой
	//  соответствует одному из вариантов печати
	//  Первый элемент структуры - форма по умолчанию
	Функция ПолучитьСписокПечатныхФорм(ДокументСсылка) Экспорт
		СтруктураМакетов=Новый Структура();
		//СтруктураМакетов.Вставить("ПоступлениеДопРасходов", "Поступление доп. расходов");
		//СтруктураМакетов.Вставить("ТОРГ12", "ТОРГ-12 (Товарная накладная за поставщика)");
		//СтруктураМакетов.Вставить("ЭтикетокИЦенников", "Печать этикеток и ценников");
		Возврат СтруктураМакетов;
	КонецФункции // ПолучитьСписокПечатныхФорм()
	
#КонецЕсли
// Если Клиент Тогда - завершена клиентская часть


////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ПриУстановкеНовогоНомера(СтандартнаяОбработка, Префикс)
	Если НЕ дкПриУстановкеНовогоНомера(ЭтотОбъект, СтандартнаяОбработка, Префикс) Тогда Возврат; КонецЕсли;
КонецПроцедуры // ПриУстановкеНовогоНомера()

Процедура ОбработкаЗаполнения(Основание) Экспорт
	
	ОргТАС=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2311152514");
	ТАС=Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2311152514");
	ОргТТ=Справочники.Организации.НайтиПоРеквизиту("ИНН", "2312127750");
	ТТ=Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2312127750");
	ОргКунова= Справочники.Организации.НайтиПоРеквизиту("ИНН", "090103290098");
	Кунова=Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "090103290098");
	
	Если Основание<>Неопределено Тогда
		Если ТипЗнч(Основание)=Тип("ДокументСсылка.ЗаказНаряд") или ТипЗнч(Основание)=Тип("ДокументСсылка.ПоступлениеАвтомобилей") или ТипЗнч(Основание)=Тип("ДокументСсылка.ВводОстатковАвтомобилей") или ТипЗнч(Основание)=Тип("ДокументСсылка.ПеремещениеАвтомобилей") Тогда
			ХозОперация=Справочники.ХозОперации.ПоступлениеДопРасходовНаАвтомобили;
		КонецЕсли;
	КонецЕсли;
		
    ЭтотОбъект.ДокументОснование = Основание.Ссылка;
	// очистим таблицу товаров
	Если Не Основание=Неопределено Тогда
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.ЗаказНаряд") Тогда
			
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
			|	ОстаткиАвтомобилейОбороты.СуммаПриход,
			|	ОстаткиАвтомобилейОбороты.Партия,
			|	ОстаткиАвтомобилейОбороты.Регистратор,
			|	ОстаткиАвтомобилейОбороты.СтатусПартии
			|ИЗ
			|	РегистрНакопления.ОстаткиАвтомобилей.Обороты(
			|			,
			|			,
			|			Регистратор,
			|			Автомобиль = &Автомобиль
			|				И Партия.Организация = &Организация) КАК ОстаткиАвтомобилейОбороты
			|ГДЕ
			|	(ОстаткиАвтомобилейОбороты.Регистратор ССЫЛКА Документ.ПоступлениеАвтомобилей
			|			ИЛИ ОстаткиАвтомобилейОбороты.Регистратор ССЫЛКА Документ.ВводОстатковАвтомобилей)";
			
			Запрос.УстановитьПараметр("Автомобиль",Основание.Автомобиль);
			Запрос.УстановитьПараметр("Организация", ОргТТ);
			Результат = Запрос.Выполнить();
			Если Результат.Пустой() Тогда 
				Сообщить("Операция не выполнена. Автомобиль не оприходован.");
				Возврат;
			КонецЕсли;		
			
			Выборка = Результат.Выбрать();
			СуммаПоступления = Выборка.СуммаПриход;
			Партия =  Выборка.Партия;
						
			Контрагент = Кунова;
			ДоговорВзаиморасчетов = Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ069567");

			Если НЕ дкОбработкаЗаполнения(ЭтотОбъект, Основание) Тогда Возврат; КонецЕсли;
			
			//Организация = Справочники.Организации.НайтиПоКоду("00001");
			ПодразделениеКомпании = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000123");
			Организация=ПодразделениеКомпании.Организация;
			
			Если Основание.Работы.Количество() > 0 Тогда
				СтавкаНДС = Основание.Работы[0].СтавкаНДС;			
			ИначеЕсли Основание.Товары.Количество() > 0 Тогда
				СтавкаНДС = Основание.Товары[0].СтавкаНДС;
			КонецЕсли;
			
			СуммаДокумента =  Основание.СуммаДокумента;
			СуммаНДС =  Основание.Работы.Итог("СуммаНДС") + Основание.Товары.Итог("СуммаНДС") ;
			
			ВхДокНомер = Основание.Номер;
			ВхДокДата = Основание.ДатаЗакрытия;
			
			НоваяСтрокаТЧ = Автомобили.Добавить();
			
			НоваяСтрокаТЧ.Автомобиль = Основание.Автомобиль;
			НоваяСтрокаТЧ.СуммаПоступления = СуммаПоступления;
			НоваяСтрокаТЧ.Цена = СуммаДокумента;
			НоваяСтрокаТЧ.Сумма = СуммаДокумента;
			НоваяСтрокаТЧ.СтавкаНДС = СтавкаНДС;
			НоваяСтрокаТЧ.СуммаНДС = СуммаНДС;
			НоваяСтрокаТЧ.СуммаВсего = СуммаДокумента;
			НоваяСтрокаТЧ.ДокументОснование = Партия;
			НоваяСтрокаТЧ.Количество = 1;
			
			Если Основание.Организация = ОргТАС Тогда // Темп Авто Сервис
				Контрагент = ТАС;
				ДоговорВзаиморасчетов = Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ028629"); // НайтиПоНаименованию("договор ТО и ремонт автомобилей №29 от 10.09.13",,,Контрагент);
			ИначеЕсли Основание.Организация = ОргКунова Тогда // Кунова ИП
				Контрагент = Кунова;
				//<<Павличенко 28.09.17
				ДоговорВзаиморасчетов = Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду("ЦБ069567",,,Контрагент);
				//ДоговорВзаиморасчетов = Справочники.ДоговорыВзаиморасчетов.НайтиПоНаименованию("договор оказания услуг 01.12.2011",,,Контрагент);
				//>>Павличенко 28.09.17
			КонецЕсли;				
			ВидРемонта = Основание.ВидРемонта;
			ТипЦен=Справочники.ТипыЦен.ОсновнойТипЦенПродажи;
			Услуга=НайтиСоздатьВидРемонтаНоменклатура(ВидРемонта);			
				
			Дата = Основание.ДатаЗакрытия;
			
		Иначе
			
			Если НЕ дкОбработкаЗаполнения(ЭтотОбъект, Основание) Тогда Возврат; КонецЕсли;

			Автомобили.Очистить();
			Запрос= Новый Запрос("ВЫБРАТЬ
			|	ПоступлениеАвтомобилейАвтомобили.Автомобиль,
			|   1 КАК Количество,
			|	ПоступлениеАвтомобилейАвтомобили.СуммаВсего как СуммаПоступления,
			|	ПоступлениеАвтомобилейАвтомобили.Ссылка как ДокументОснование
			|ИЗ
			|	Документ." + Основание.Метаданные().Имя + ".Автомобили КАК ПоступлениеАвтомобилейАвтомобили
			|ГДЕ
			|	ПоступлениеАвтомобилейАвтомобили.Ссылка = &Ссылка");
			Запрос.УстановитьПараметр("Ссылка",Основание);
			РезультатЗапроса= Запрос.Выполнить();
			Если НЕ РезультатЗапроса.Пустой() Тогда
				тзАвтомобили	= РезультатЗапроса.Выгрузить();
				Автомобили.Загрузить(тзАвтомобили);
			КонецЕсли;
		КонецЕсли;
	Конецесли;
	

	
КонецПроцедуры // ОбработкаЗаполнения()

Функция НайтиСоздатьВидРемонтаНоменклатура(ВидРемонта)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Наименование = &Наименование
		|	И Номенклатура.ТипНоменклатуры = &ТипНоменклатуры
		|	И Номенклатура.ПометкаУдаления = ЛОЖЬ";
	
	Запрос.УстановитьПараметр("Наименование", СокрЛП(ВидРемонта.Наименование));
	Запрос.УстановитьПараметр("ТипНоменклатуры", Справочники.ТипыНоменклатуры.Услуга);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Возврат ВыборкаДетальныеЗаписи.Ссылка;	
	КонецЦикла;

	Спр=Справочники.Номенклатура.СоздатьЭлемент();
	Спр.Заполнить(неопределено);
	Спр.Наименование=СокрЛП(ВидРемонта.Наименование);
	Спр.НаименованиеПолное=Спр.Наименование;
	Спр.Родитель=Справочники.Номенклатура.НайтиПоНаименованию("Внутренние услуги",Истина);
	Спр.ТипНоменклатуры=Справочники.ТипыНоменклатуры.Услуга;
	Спр.ВидНоменклатуры=Перечисления.ВидыНоменклатуры.Услуга;
	Спр.БазоваяЕдиницаИзмерения	= Спр.ТипНоменклатуры.ОсновнаяБазоваяЕдиницаИзмерения;
	Спр.ОбменДанными.Загрузка=Истина;
	Спр.Записать();
	
	Возврат Спр.Ссылка;
	
КонецФункции

Процедура ПриКопировании(ОбъектКопирования)
	Если НЕ дкПриКопировании(ЭтотОбъект, ОбъектКопирования) Тогда Возврат; КонецЕсли;
КонецПроцедуры // ПриКопировании()

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	ДополнительныеСвойства.Вставить("ДоговорВзаиморасчетовБыл");
	ДополнительныеСвойства.Вставить("АвтомобильСкладКомпанииБыл");
	ДополнительныеСвойства.Вставить("СкладКомпанииБыл");
	ДополнительныеСвойства.Вставить("МоментВремениБыл");
	Если НЕ дкПередЗаписью(ЭтотОбъект, Отказ, РежимЗаписи, РежимПроведения) Тогда Возврат; КонецЕсли;
	
	// получим старые значения, влияющие на границы последовательности
	Если НЕ Отказ И НЕ ЭтоНовый() И РежимЗаписи=РежимЗаписиДокумента.Проведение Тогда
		// прошлый момент времени
		Запрос = Новый Запрос("ВЫБРАТЬ МоментВремени ИЗ Документ."+Метаданные().Имя+" ГДЕ Ссылка=&Ссылка");
		Запрос.УстановитьПараметр("Ссылка",Ссылка);
		ДополнительныеСвойства.Вставить("МоментВремениБыл",Запрос.Выполнить().Выгрузить().Получить(0).МоментВремени);
		
		// взаиморасчеты
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ ДоговорВзаиморасчетов ИЗ РегистрНакопления.ВзаиморасчетыКомпании ГДЕ Регистратор=&Ссылка";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			ДополнительныеСвойства.Вставить("ДоговорВзаиморасчетовБыл", Результат.Выгрузить().ВыгрузитьКолонку("ДоговорВзаиморасчетов"));
		КонецЕсли;
		
		// автомобили
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ СкладКомпании ИЗ РегистрНакопления.ОстаткиАвтомобилей ГДЕ Регистратор=&Ссылка";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			ДополнительныеСвойства.Вставить("АвтомобильСкладКомпанииБыл", Результат.Выгрузить().ВыгрузитьКолонку("СкладКомпании"));
		КонецЕсли;
		
		// партии
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ СкладКомпании ИЗ РегистрНакопления.ПартииТоваровКомпании ГДЕ Регистратор=&Ссылка";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			ДополнительныеСвойства.Вставить("СкладКомпанииБыл", Результат.Выгрузить().ВыгрузитьКолонку("СкладКомпании"));
		КонецЕсли;
	КонецЕсли;
	//dmim rarus{
	Если СуммаДокумента<>Автомобили.Итог("СуммаВсего") Тогда
		Сообщить("Общая сумма не совпадает с суммой табличной части",СтатусСообщения.Внимание);
		Отказ=Истина;
	КонецЕсли;
	//}
КонецПроцедуры // ПередЗаписью()

Процедура ПриЗаписи(Отказ)
	Если НЕ дкПриЗаписи(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
КонецПроцедуры // ПриЗаписи()

Процедура ПередУдалением(Отказ)
	Если НЕ дкПередУдалением(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
КонецПроцедуры // ПередУдалением()

Процедура ОбработкаУдаленияПроведения(Отказ)
	Если НЕ дкОбработкаУдаленияПроведения(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
КонецПроцедуры // ОбработкаУдаленияПроведения()

Процедура ОбработкаПроведения(Отказ, Режим)
	ВедетсяБалансПоПодразделению = Константы.СпособВеденияБаланса.Получить() = Перечисления.СпособВеденияБаланса.ПоПодразделению;
	Если НЕ дкОбработкаПроведения(ЭтотОбъект, Отказ, Режим) Тогда Возврат; КонецЕсли;
	// взаиморасчеты
	НаборЗаписейВзаиморасчеты=Движения.ВзаиморасчетыКомпании;
	НаборЗаписейВзаиморасчеты.ДокументОбъект        = ЭтотОбъект;
	НаборЗаписейВзаиморасчеты.РежимПроведения       = Режим;
	НаборЗаписейВзаиморасчеты.Контрагент            = Контрагент;
	НаборЗаписейВзаиморасчеты.ДоговорВзаиморасчетов = ДоговорВзаиморасчетов;
	НаборЗаписейВзаиморасчеты.Сделка                = Неопределено;
	НаборЗаписейВзаиморасчеты.Сумма                 = СуммаДокумента;
	НаборЗаписейВзаиморасчеты.СуммаДоходаРасходаСуммовыхРазниц = 0;
	Отказ=НЕ НаборЗаписейВзаиморасчеты.Расход() ИЛИ Отказ;
	// доходы и расходы по суммовым разницам
	СуммаДоходаРасходаСуммовыхРазниц=НаборЗаписейВзаиморасчеты.СуммаДоходаРасходаСуммовыхРазниц;
	Если СуммаДоходаРасходаСуммовыхРазниц<>0 Тогда
		НаборЗаписейДиР = Движения.ДоходыИрасходы;
		НаборЗаписейДиР.ДокументОбъект         = ЭтотОбъект;
		Если ВедетсяБалансПоПодразделению Тогда
			НаборЗаписейДиР.Подразделение          = ДоговорВзаиморасчетов.Подразделение;
		КонецЕсли;	
		НаборЗаписейДиР.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СуммовыеРазницы;
		НаборЗаписейДиР.ВУпрВалюте = Истина;
		Если СуммаДоходаРасходаСуммовыхРазниц<0 Тогда
			НаборЗаписейДиР.Расход = -СуммаДоходаРасходаСуммовыхРазниц;
		Иначе
			НаборЗаписейДиР.Доход = СуммаДоходаРасходаСуммовыхРазниц;
		КонецЕсли;
		Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;
	КонецЕсли;
	
	// проведем партии
	Отказ=НЕ ПровестиПоПартиям(Режим,Ссылка) ИЛИ Отказ;
	
	//dmim rarus{
	// БАЛАНС: определим необходимость формирования корректирующих проводок по взаиморасчетам.
	//Если ХозОперация=Справочники.ХозОперации.ПоступлениеДопРасходовВнутреннее Тогда
	//	ПодразделениеСклад = обПолучитьБалансовоеПодразделение(ДокументОснование.СкладПолучатель.Подразделение);
	//Иначе
	//	ПодразделениеСклад = обПолучитьБалансовоеПодразделение(ДокументОснование.СкладКомпании.Подразделение);
	//КонецЕсли;	
	//ПодразделениеДоговорВзаиморасчетов = обПолучитьБалансовоеПодразделение(ДоговорВзаиморасчетов.Подразделение);
	//БалансовыеПодразделенияНеРавны = (ПодразделениеДоговорВзаиморасчетов<>ПодразделениеСклад);
	//Если (ВедетсяБалансПоПодразделению и БалансовыеПодразделенияНеРавны) или (ДокументОснование.ХозОперация=Справочники.ХозОперации.ПоступлениеТоваровКомиссия) Тогда
	//	НаборЗаписейДиР = Движения.ДоходыИрасходы;
	//	НаборЗаписейДиР.ДокументОбъект			= ЭтотОбъект;
	//	Если ХозОперация=Справочники.ХозОперации.ПоступлениеДопРасходовВнутреннее Тогда
	//		ПодразделениеСклад = ДокументОснование.СкладПолучатель.Подразделение;
	//	Иначе
	//		ПодразделениеСклад = ДокументОснование.СкладКомпании.Подразделение;
	//	КонецЕсли;	
	//	НаборЗаписейДиР.Подразделение			= ДоговорВзаиморасчетов.Подразделение;
	//	НаборЗаписейДиР.СтатьяДоходовИРасходов	= Справочники.СтатьиДоходовИРасходов.КорректировкаБалансаПоПодразделениям;
	//	НаборЗаписейДиР.ВУпрВалюте				= Ложь;
	//	НаборЗаписейДиР.Расход					= СуммаДокумента;
	//	Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;  				
	//КонецЕсли;
	//}
	
	// Возможно расхождение баланса на "копейки" из-за округления. Возникшую разницу
	// необходимо списать на доходы и расходы.
	Отказ = НЕ дкСписаниеКопейкиПриОкругленииВалютныхСчетов(ЭтотОбъект) ИЛИ Отказ;
	
	// двигаем границу последовательности взаиморасчетов
	ДвигаемГраницу = (Режим<>РежимПроведенияДокумента.Оперативный И Движения.ВзаиморасчетыКомпании.Количество()>0);
	Если ДвигаемГраницу ИЛИ ЗначениеЗаполнено(ДополнительныеСвойства.ДоговорВзаиморасчетовБыл) Тогда
		НаборЗаписейГраницыВзаиморасчетов = РегистрыСведений.ГраницыВзаиморасчетов.СоздатьНаборЗаписей();
		Если ДвигаемГраницу Тогда
			ТаблицаДоговоров = Движения.ВзаиморасчетыКомпании.Выгрузить();
			ТаблицаДоговоров.Свернуть("ДоговорВзаиморасчетов","");
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетов = ТаблицаДоговоров.ВыгрузитьКолонку("ДоговорВзаиморасчетов");
			НаборЗаписейГраницыВзаиморасчетов.МоментВремени = Дата;
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетовБыл = ДополнительныеСвойства.ДоговорВзаиморасчетовБыл;
			НаборЗаписейГраницыВзаиморасчетов.МоментВремениБыл = ДополнительныеСвойства.МоментВремениБыл;
		Иначе
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетов = ДополнительныеСвойства.ДоговорВзаиморасчетовБыл;
			НаборЗаписейГраницыВзаиморасчетов.МоментВремени = ДополнительныеСвойства.МоментВремениБыл;
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетовБыл = Неопределено;
			НаборЗаписейГраницыВзаиморасчетов.МоментВремениБыл = Неопределено;
		КонецЕсли;
		НаборЗаписейГраницыВзаиморасчетов.ДокументСсылка = Ссылка;
		НаборЗаписейГраницыВзаиморасчетов.ИзменитьГраницу();
	КонецЕсли;
	
	// выведем сообщения об ошибках и предупреждениях
	дкВыводРезультатовОбработки(ЭтотОбъект,Отказ);
КонецПроцедуры // ОбработкаПроведения()

// вовзращает выборку по шапке
//
// Параметры:
//  ДокументСсылка - Документ.Ссылка - Ссылка на документ для которого получаем шапку
//
// Возвращаемое значение:
//  Выборка - вовзращает выборку по шапке
//
Функция ПолучитьШапкуДокумента(ДокументСсылка)
	Запрос=Новый Запрос("
	|ВЫБРАТЬ
	|	Док.Ссылка КАК Ссылка,
	|	Док.Дата КАК Дата,
	|	Док.ВалютаДокумента КАК ВалютаДокумента,
	|	Док.КурсДокумента КАК КурсДокумента,
	|	Док.ТипЦен КАК ТипЦен,
	|	Док.ХозОперация КАК ХозОперация,
	|	Док.КурсВалютыУпр КАК КурсВалютыУпр,
	|	Док.КурсВалютыВзаиморасчетов КАК КурсВалютыВзаиморасчетов,
	|	Док.МоментВремени КАК МоментВремени,
	|	Док.ПодразделениеКомпании КАК ПодразделениеКомпании,
	|	Док.Проект КАК Проект,
	/////////// ПРИВАТ ////////////
	//|	Док.ДокументОснование.СкладКомпании КАК СкладКомпании,
	|	Док.ДоговорВзаиморасчетов КАК ДоговорВзаиморасчетов,
	//|	Док.ДокументОснование.СкладПолучатель КАК СкладПолучатель,
	//|	Док.ДокументОснование КАК ДокументОснование,
	|	Док.ДокументОснование.ХозОперация КАК ДокументОснованиеХозОперация,
	|	Док.СуммаДокумента КАК СуммаДокумента
	|
	|ИЗ
	|	Документ."+Метаданные().Имя+" КАК Док
	|ГДЕ
	|	Док.Ссылка=&Ссылка
	|");
	Запрос.УстановитьПараметр("Ссылка",ДокументСсылка);
	Выборка=Запрос.Выполнить().Выбрать(); Выборка.Следующий();
	
	Возврат Выборка;
КонецФункции // ПолучитьШапкуДокумента()
//dmim rarus{

Функция ФормированиеТаблицыАвтомобилей()Экспорт
	Запрос=Новый Запрос("ВЫБРАТЬ
	|	ОбъединенныйЗапрос.Автомобиль КАК Автомобиль,
	|	ОбъединенныйЗапрос.Партия КАК Партия,
	|	ОбъединенныйЗапрос.СтатусПартии КАК СтатусПартии,
	|	СУММА(ОбъединенныйЗапрос.Количество) КАК Количество,
	|	СУММА(ОбъединенныйЗапрос.СуммаНДС) КАК СуммаНДС,
	|	СУММА(0) КАК Сумма,
	|	СУММА(ОбъединенныйЗапрос.СуммаВсего) КАК СуммаВсего,
	|	ОбъединенныйЗапрос.СкладКомпании
	|ИЗ
	|	(ВЫБРАТЬ
	|		ОстаткиАвтомобилей.Автомобиль КАК Автомобиль,
	|		ОстаткиАвтомобилей.Партия КАК Партия,
	|		ОстаткиАвтомобилей.СтатусПартии КАК СтатусПартии,
	|		ОстаткиАвтомобилей.Количество КАК Количество,
	|		ОстаткиАвтомобилей.СуммаНДС КАК СуммаНДС,
	|		0 КАК Сумма,
	|		ОстаткиАвтомобилей.СуммаУпр КАК СуммаВсего,
	|		ОстаткиАвтомобилей.СкладКомпании КАК СкладКомпании
	|	ИЗ
	|		РегистрНакопления.ОстаткиАвтомобилей КАК ОстаткиАвтомобилей
	|	ГДЕ
	|		ОстаткиАвтомобилей.Регистратор В(&Регистратор)
	|		И ОстаткиАвтомобилей.ВидДвижения = &ВидДвиженияПриход
	|		И ОстаткиАвтомобилей.СтатусПартии = &СтатусПартии
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		КомплектацияАвтомобилей.Автомобиль,
	|		КомплектацияАвтомобилей.Партия,
	|		КомплектацияАвтомобилей.СтатусПартии,
	|		КомплектацияАвтомобилей.Количество,
	|		КомплектацияАвтомобилей.СуммаНДС,
	|		0,
	|		КомплектацияАвтомобилей.СуммаУпр,
	|		КомплектацияАвтомобилей.СкладКомпании
	|	ИЗ
	|		РегистрНакопления.КомплектацияАвтомобилей КАК КомплектацияАвтомобилей
	|	ГДЕ
	|		КомплектацияАвтомобилей.Регистратор В(&Регистратор)
	|		И КомплектацияАвтомобилей.ВидДвижения = &ВидДвиженияПриход
	|		И КомплектацияАвтомобилей.СтатусПартии = &СтатусПартии) КАК ОбъединенныйЗапрос
	|
	|СГРУППИРОВАТЬ ПО
	|	ОбъединенныйЗапрос.Автомобиль,
	|	ОбъединенныйЗапрос.Партия,
	|	ОбъединенныйЗапрос.СтатусПартии,
	|	ОбъединенныйЗапрос.СкладКомпании");
	Запрос.УстановитьПараметр("Регистратор",             Автомобили.Выгрузить(,"ДокументОснование"));
	Запрос.УстановитьПараметр("ВидДвиженияПриход",       ВидДвиженияНакопления.Приход);
	Запрос.УстановитьПараметр("СтатусПартии",            Перечисления.СтатусыПартий.ТоварКупленный);
	//Запрос.УстановитьПараметр("ДокументОснованиеСсылка", ШапкаДокумента.ДокументОснование);
	
	Возврат Запрос.Выполнить();
	
КонецФункции
Процедура РасчетРаспределения(МодифицироватьТЧ=Ложь,СпособРаспределения) Экспорт
	ТаблицаАвтомобилей	= Автомобили.Выгрузить();
	//Попытка
	//	ТаблицаАвтомобилей.Колонки.Добавить("ДопРасходы",Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,2)));
	//	ТаблицаАвтомобилей.Колонки.Добавить("НДСДопРасходов",Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,2)));
	//Исключение
	//КонецПопытки;
	//Запрос	= Новый Запрос();
	//Запрос.МенеджерВременныхТаблиц=Новый МенеджерВременныхТаблиц();
	//
	//
	//Запрос.Текст=("ВЫБРАТЬ
	//					|	СУММА(ЕСТЬNULL(ВЫБОР
	//					|				КОГДА ДокументТовары.Ссылка.СпособРаспределения = &ПоСумме
	//					|					ТОГДА ДокументТовары.СуммаВсего
	//					|				ИНАЧЕ 0
	//					|			КОНЕЦ, 0)) КАК ПоСумме,
	//					|	СУММА(ЕСТЬNULL(ВЫБОР
	//					|				КОГДА ДокументТовары.Ссылка.СпособРаспределения = &ПоСумме
	//					|					ТОГДА ДокументТовары.СуммаНДС
	//					|				ИНАЧЕ 0
	//					|			КОНЕЦ, 0)) КАК ПоСуммеНДС,
	//					|	СУММА(ЕСТЬNULL(ВЫБОР
	//					|				КОГДА ДокументТовары.Ссылка.СпособРаспределения = &ПоКоличеству
	//					|					ТОГДА ДокументТовары.СуммаНДС
	//					|				ИНАЧЕ 0
	//					|			КОНЕЦ, 0)) КАК ПоКоличествуНДС,
	//					|	СУММА(ЕСТЬNULL(ВЫБОР
	//					|				КОГДА ДокументТовары.Ссылка.СпособРаспределения = &ПоКоличеству
	//					|					ТОГДА ДокументТовары.СуммаВсего
	//					|				ИНАЧЕ 0
	//					|			КОНЕЦ, 0)) КАК ПоКоличеству,
	//					|	СУММА(ЕСТЬNULL(ВЫБОР
	//					|				КОГДА ДокументТовары.Ссылка.СпособРаспределения = &ПоВесу
	//					|					ТОГДА ДокументТовары.СуммаНДС
	//					|				ИНАЧЕ 0
	//					|			КОНЕЦ, 0)) КАК ПоВесуНДС,
	//					|	СУММА(ЕСТЬNULL(ВЫБОР
	//					|				КОГДА ДокументТовары.Ссылка.СпособРаспределения = &ПоВесу
	//					|					ТОГДА ДокументТовары.СуммаВсего
	//					|				ИНАЧЕ 0
	//					|			КОНЕЦ, 0)) КАК ПоВесу
	//					|ИЗ
	//					|	Документ.ПоступлениеДопРасходовНаАвтомобиль.Товары КАК ДокументТовары
	//					|ГДЕ
	//					|	ДокументТовары.Ссылка = &Ссылка
	//					|	И ДокументТовары.Номенклатура.СпособРаспределенияДопРасходов <> &НаДоходыРасходы
	//					|	И ДокументТовары.Номенклатура.ВидНоменклатуры = &Услуга");
	//Запрос.УстановитьПараметр("Ссылка",Ссылка);
	//Запрос.УстановитьПараметр("ПоСумме",Перечисления.СпособыРаспределенияДопРасходов.ПоСумме);
	//Запрос.УстановитьПараметр("ПоКоличеству",Перечисления.СпособыРаспределенияДопРасходов.ПоКоличеству);
	//Запрос.УстановитьПараметр("ПоВесу",Перечисления.СпособыРаспределенияДопРасходов.ПоВесу);
	//Запрос.УстановитьПараметр("НаДоходыРасходы",Перечисления.СпособыРаспределенияДопРасходов.НаДоходыИРасходы);
	//Запрос.УстановитьПараметр("Услуга",Перечисления.ВидыНоменклатуры.Услуга);
	//РезультатДопРасходы=Запрос.Выполнить();
	//
	//Если РезультатДопРасходы.Пустой() Тогда Возврат; КонецЕсли;
	//ВыборкаДопРасходы=РезультатДопРасходы.Выбрать(); ВыборкаДопРасходы.Следующий();
	//	
	//ИтогДопРасходы=?(ВыборкаДопРасходы.ПоКоличеству=NULL,0,ВыборкаДопРасходы.ПоКоличеству)+?(ВыборкаДопРасходы.ПоСумме=NULL,0,ВыборкаДопРасходы.ПоСумме)+?(ВыборкаДопРасходы.ПоВесу=NULL,0,ВыборкаДопРасходы.ПоВесу);
	//Если ИтогДопРасходы=0 Тогда Возврат; КонецЕсли;
	//ИтогДопРасходыНДС=?(ВыборкаДопРасходы.ПоКоличествуНДС=NULL,0,ВыборкаДопРасходы.ПоКоличествуНДС)+?(ВыборкаДопРасходы.ПоСуммеНДС=NULL,0,ВыборкаДопРасходы.ПоСуммеНДС)+?(ВыборкаДопРасходы.ПоВесуНДС=NULL,0,ВыборкаДопРасходы.ПоВесуНДС);
	//
	//Если ВыборкаДопРасходы.ПоВесу<>0 Тогда
	//	дкСообщитьРезультат("Поступление допрасходов по весу для автомобилей недопустимо.","Важное&Остатки автомобилей:",ЭтотОбъект);
	//	Отказ=Истина; Возврат;
	//КонецЕсли; 
	//
	
	ИтогДокументКоличество	=ТаблицаАвтомобилей.Итог("Количество");;
	ИтогДокументСумма		= ТаблицаАвтомобилей.Итог("СуммаПоступления");
	ИтогДопРасходы		= СуммаДокумента;
	ИтогДопРасходыНДС	= СуммаНДС;
	Для Каждого СтрокаАвтомобиль Из ТаблицаАвтомобилей Цикл
		СуммаДопРасходов=0; СуммаНДСДопРасходов=0;
		Если СпособРаспределения=Перечисления.СпособыРаспределенияДопРасходов.ПоКоличеству Тогда
			СуммаДопРасходов=СуммаДокумента*?(ИтогДокументКоличество=0,0,СтрокаАвтомобиль.Количество/ИтогДокументКоличество);
			СуммаНДСДопРасходов=СуммаНДС*?(СтрокаАвтомобиль.СуммаПоступления=NULL ИЛИ ИтогДокументСумма=0,0,СтрокаАвтомобиль.Количество/ИтогДокументКоличество);
		ИначеЕсли СпособРаспределения=Перечисления.СпособыРаспределенияДопРасходов.ПоСумме Тогда
			СуммаДопРасходов=СуммаДокумента*?(СтрокаАвтомобиль.СуммаПоступления=NULL ИЛИ ИтогДокументСумма=0,0,СтрокаАвтомобиль.СуммаПоступления/ИтогДокументСумма);
			СуммаНДСДопРасходов=СуммаНДС*?(СтрокаАвтомобиль.СуммаПоступления=NULL ИЛИ ИтогДокументСумма=0,0,СтрокаАвтомобиль.СуммаПоступления/ИтогДокументСумма);
		КонецЕсли;
		стрТовары	= Автомобили.Найти(СтрокаАвтомобиль.Автомобиль,"Автомобиль");
		Если стрТовары<>Неопределено Тогда
			стрТовары.СуммаВсего=СуммаДопРасходов;
			ОбработкаРеквизита("Автомобили.СуммаВсего",стрТовары);
			стрТовары.СуммаНДС= СуммаНДСДопРасходов;
			ИтогДопРасходы = ИтогДопРасходы-(стрТовары.СуммаВсего);
			ИтогДопРасходыНДС = ИтогДопРасходыНДС-(стрТовары.СуммаНДС);
		КонецЕсли;
		
	КонецЦикла;
	
	// если осталась сумма от округления то закинем ее на последний
	Если ИтогДопРасходы<>0  Тогда
		Попытка
			Если стрТовары<>Неопределено Тогда
				Если МодифицироватьТЧ Тогда
					стрТовары.СуммаВсего=стрТовары.СуммаВсего+ИтогДопРасходы;
					ОбработкаРеквизита("Автомобили.СуммаВсего",стрТовары);
					стрТовары.СуммаНДС=стрТовары.СуммаНДС+ИтогДопРасходыНДС;
				Конецесли;
			Конецесли;
		Исключение
		КонецПопытки;
	КонецЕсли;
КонецПроцедуры
//}
Процедура РассчетДополнительныхРасходовНаАвтомобили(ТаблицаАвтомобилей,Ссылка,Отказ)
	// Добавим колонки в таблицу товаров    //
	Попытка
		ТаблицаАвтомобилей.Колонки.Добавить("ДопРасходы",Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,2)));
		ТаблицаАвтомобилей.Колонки.Добавить("НДСДопРасходов",Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,2)));
	Исключение
	КонецПопытки;
	Для Каждого СтрокаАвтомобиль Из ТаблицаАвтомобилей Цикл
		стрТовары	= Автомобили.Найти(СтрокаАвтомобиль.Автомобиль,"Автомобиль");
		Если стрТовары<>Неопределено Тогда
			СтрокаАвтомобиль.ДопРасходы		= стрТовары.СуммаВсего;
			СтрокаАвтомобиль.НДСДопРасходов	= стрТовары.СуммаНДС;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры // РассчетДополнительныхРасходовНаАвтомобили()

////////////////////////////////////////////////////////////////////////////////
// ИСПОЛНЯЕМАЯ ЧАСТЬ МОДУЛЯ

// сохранение ссылки на коллекцию прав, настроек и окружения
Права = Неопределено;
#Если Клиент Тогда
	Права = глПрава;
#КонецЕсли