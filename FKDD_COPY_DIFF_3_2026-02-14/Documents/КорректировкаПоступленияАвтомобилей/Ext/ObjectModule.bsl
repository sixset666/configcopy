// Модуль документа Корректировка поступления автомобилей

////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ ОБЪЕКТА

Перем Права Экспорт;                            // Переменная объекта - ссылка на коллекцию прав, настроек и переменных окружения
Перем РезультатОбработки Экспорт;               // Переменная для накопления результатов проведения по модулям наборов записей
Перем ОбработкаЗначенияСвойствОбъектов Экспорт; // Переменная для хранения значения свойств основания/объекта копирования

Перем ТекущаяВалютаДокумента Экспорт;           // Текущая валюта документа перед изменением
Перем ТекущийКурсДокумента Экспорт;             //Текущий курс документа перед изменением

Перем ИмяРеквизитаКода Экспорт;                 // Кэш права "РежимВыводаКодаВДокументах". Служит для настройки вывода кода/артикула в ТЧ

// Возвращает выборку по шапке
// ДокументСсылка - Ссылка на документ для которого получаем шапку.
Функция ПолучитьШапкуДокумента(ДокументСсылка) Экспорт
	Запрос=Новый Запрос("
	|ВЫБРАТЬ
	|	Док.Ссылка КАК Ссылка,
	|	Док.Дата КАК Дата,
	|	Док.ВалютаДокумента КАК ВалютаДокумента,
	|	Док.КурсДокумента КАК КурсДокумента,
	|	Док.ТипЦен КАК ТипЦен,
	|	Док.ХозОперация КАК ХозОперация,
	|	Док.КурсВалютыУпр КАК КурсВалютыУпр,
	|	Док.КурсВалютыВзаиморасчетов КАК КурсВалютыВзаиморасчетов,
	|	Док.МоментВремени КАК МоментВремени,
	|	Док.ПодразделениеКомпании КАК ПодразделениеКомпании,
	/////////// ПРИВАТ ////////////
	|	Док.СкладКомпании КАК СкладКомпании,
	|	Док.Контрагент КАК Контрагент,
	|	Док.ДоговорВзаиморасчетов КАК ДоговорВзаиморасчетов
	|
	|ИЗ
	|	Документ.КорректировкаПоступленияАвтомобилей КАК Док
	|
	|ГДЕ
	|	Док.Ссылка=&Ссылка
	|");
	Запрос.УстановитьПараметр("Ссылка",ДокументСсылка);
	Выборка=Запрос.Выполнить().Выбрать(); Выборка.Следующий();
	
	Возврат Выборка;
КонецФункции

Функция ПолучитьСписокОснований()
	
	Основания = Новый Массив;
	ТекОснование = ДокументОснование;
	
	Если ТекОснование = Неопределено Тогда
		Возврат Основания;
	КонецЕсли;
	
	Пока ТипЗнч(ТекОснование) <> Тип("ДокументСсылка.ПоступлениеАвтомобилей") Цикл
		Основания.Добавить(ТекОснование);
		ТекОснование = ТекОснование.ДокументОснование;
	КонецЦикла;
	
	Основания.Добавить(ТекОснование);
	
	Возврат Основания;
	
КонецФункции

Функция ПолучитьСделку(СписокОснований = Неопределено)
	
	Если СписокОснований = Неопределено Тогда
		СписокОснований = ПолучитьСписокОснований();
	КонецЕсли;
	
	Для Каждого Основание Из СписокОснований Цикл
		//misha
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.ПоступлениеАвтомобилей") или
			ТипЗнч(Основание) = Тип("ДокументСсылка.ВводОстатковАвтомобилей") Тогда
			Возврат Основание;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Документы.ПоступлениеАвтомобилей.ПустаяСсылка();
	
КонецФункции

Функция ПолучитьТаблицуАвтомобилей()
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КорректировкаПоступленияАвтомобилейАвтомобили.Автомобиль КАК Автомобиль,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоРазница КАК СуммаВсегоРазница,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДСРазница КАК СуммаНДСРазница,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДС КАК СтавкаНДС,
	|	ВЫБОР
	|		КОГДА ОстаткиАвтомобилейОстатки.Автомобиль ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЕстьОстаток,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.Количество КАК Количество,
	|	ОстаткиАвтомобилейОстатки.Партия КАК Партия
	|ИЗ
	|	Документ.КорректировкаПоступленияАвтомобилей.Автомобили КАК КорректировкаПоступленияАвтомобилейАвтомобили
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиАвтомобилей.Остатки(&МоментВремени, Автомобиль В (&СписокАвтомобилей)) КАК ОстаткиАвтомобилейОстатки
	|		ПО КорректировкаПоступленияАвтомобилейАвтомобили.Автомобиль = ОстаткиАвтомобилейОстатки.Автомобиль
	|ГДЕ
	|	КорректировкаПоступленияАвтомобилейАвтомобили.Ссылка = &Ссылка
	|	И (КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоРазница <> 0
	|			ИЛИ КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДСРазница <> 0
	|			ИЛИ КорректировкаПоступленияАвтомобилейАвтомобили.КоличествоРазница <> 0)";          
	
	Запрос.УстановитьПараметр("МоментВремени"     , МоментВремени());
	Запрос.УстановитьПараметр("Ссылка"            , Ссылка);
	Запрос.УстановитьПараметр("СписокАвтомобилей" , Автомобили.ВыгрузитьКолонку("Автомобиль"));  	
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Процедура ВыполнитьДвиженияПоВзаиморасчетам(Отказ, Режим)
	
	// получим сумму различий
	СуммаЗаписи = Автомобили.Итог("СуммаВсегоРазница");
	
	Если СуммаЗаписи = 0 Тогда
		Возврат;
	КонецЕсли;
	
	//misha
	//Если Сделка.ХозОперация = Справочники.ХозОперации.ПоступлениеАвтомобилей ИЛИ
	//	Сделка.ХозОперация = Справочники.ХозОперации.ПереходВСобственностьАвтомобилей Тогда
	Если Сделка.ХозОперация = Справочники.ХозОперации.ПоступлениеАвтомобилей ИЛИ
		Сделка.ХозОперация = Справочники.ХозОперации.ПереходВСобственностьАвтомобилей или
		Сделка.ХозОперация = Справочники.ХозОперации.ВводОстатковАвтомобилей Тогда
		
		НаборЗаписейВзаиморасчеты                       = Движения.ВзаиморасчетыКомпании;
		НаборЗаписейВзаиморасчеты.ДокументОбъект        = ЭтотОбъект;
		НаборЗаписейВзаиморасчеты.РежимПроведения       = Режим;
		НаборЗаписейВзаиморасчеты.Контрагент            = Контрагент;
		НаборЗаписейВзаиморасчеты.ДоговорВзаиморасчетов = ДоговорВзаиморасчетов;
		НаборЗаписейВзаиморасчеты.Сделка                = Сделка;
	
		НаборЗаписейВзаиморасчеты.ВзаиморасчетыСПокупателем        = Истина;
		НаборЗаписейВзаиморасчеты.Сумма                            = СуммаЗаписи;
		НаборЗаписейВзаиморасчеты.СуммаДоходаРасходаСуммовыхРазниц = 0;
		Отказ = НЕ НаборЗаписейВзаиморасчеты.Расход() ИЛИ Отказ;
		
		// доходы и расходы по суммовым разницам
		СуммаДоходаРасходаСуммовыхРазниц = НаборЗаписейВзаиморасчеты.СуммаДоходаРасходаСуммовыхРазниц;
		Если СуммаДоходаРасходаСуммовыхРазниц <> 0 Тогда
			НаборЗаписейДиР                        = Движения.ДоходыИРасходы;
			НаборЗаписейДиР.ДокументОбъект         = ЭтотОбъект;
			НаборЗаписейДиР.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СуммовыеРазницы;
			НаборЗаписейДиР.ВУпрВалюте             = Истина;
			Если СуммаДоходаРасходаСуммовыхРазниц<0 Тогда
				НаборЗаписейДиР.Расход = -СуммаДоходаРасходаСуммовыхРазниц;
			Иначе
				НаборЗаписейДиР.Доход = СуммаДоходаРасходаСуммовыхРазниц;
			КонецЕсли;
			
			Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры

// Обработчик события объекта возникает в момент, когда выполняется установка нового номера.
//
// Параметры:
//  СтандартнаяОбработка - Булево - В данный параметр передается признак выполнения системной обработки события.
//  Префикс              - Строка - Префикс, который будет использоваться для генерации номера.
//
Процедура ПриУстановкеНовогоНомера(СтандартнаяОбработка, Префикс)
	
	// Вызываем общий обработчик события
	Если НЕ дкПриУстановкеНовогоНомера(ЭтотОбъект, СтандартнаяОбработка, Префикс) Тогда
		Возврат;
	КонецЕсли;
	
КонецПроцедуры // ПриУстановкеНовогоНомера()

// Обработчик события заполнения объекта копированием.
//
// Параметры:
//  ОбъектКопирования - ДокументОбъект - Исходный объект, который является источником копирования.
//
Процедура ПриКопировании(ОбъектКопирования)
	
	// Вызываем общий обработчик события
	Если НЕ дкПриКопировании(ЭтотОбъект, ОбъектКопирования) Тогда
		Возврат;
	КонецЕсли;
	
КонецПроцедуры // ПриКопировании()

// Обработчик события возникающего после начала транзакции записи, но до начала записи объекта.
//
// Параметры:
//  Отказ           - Булево                   - Признак отказа от совершения операции.
//  РежимЗаписи     - РежимЗаписиДокумента     - Текущий режим записи документа.
//  РежимПроведения - РежимПроведенияДокумента - Текущий режим проведения.
//
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	// заполним сделку
	Сделка = ПолучитьСделку();
	
	// Проверим хоз. операции
	// составим списко документов движений.
	Если ХозОперация = Справочники.ХозОперации.КорректировкаПоступленияАвтомобилейКорректировкаПоСогласованиюСторон Тогда
		
		// заполним значение до корректировки
		Для Каждого Строка Из Автомобили Цикл
			Строка.СуммаВсегоДоКорректировки = Строка.СуммаВсегоПоДокументуПоступления;
			Строка.СуммаНДСДоКорректировки   = Строка.СуммаНДСПоДокументуПоступления;
		КонецЦикла;
		
	ИначеЕсли ХозОперация = Справочники.ХозОперации.КорректировкаПоступленияАвтомобилейИсправлениеВПервичныхДокументах Тогда
		
		// проверим введенные на основании корректировки
		ТекстЗапроса = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ПодчиненныеДокументы.Ссылка КАК Документ
		|ИЗ
		|	КритерийОтбора.ПодчиненныеДокументы(&Основание) КАК ПодчиненныеДокументы
		|ГДЕ
		|	ПодчиненныеДокументы.Ссылка ССЫЛКА Документ.КорректировкаПоступленияАвтомобилей
		|	И НЕ ПодчиненныеДокументы.Ссылка.ХозОперация = ЗНАЧЕНИЕ(Справочник.ХозОперации.КорректировкаПоступленияАвтомобилейКорректировкаПоСогласованиюСторон)
		|	И НЕ ПодчиненныеДокументы.Ссылка = &Ссылка";
		
		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.УстановитьПараметр("Основание", ДокументОснование);
		Запрос.УстановитьПараметр("Ссылка",    Ссылка);
		ВыполнениеЗапроса = Запрос.Выполнить();
		
		Если НЕ ВыполнениеЗапроса.Пустой() Тогда
			Сообщить("К документу """+Строка(ДокументОснование)+""" введено больше одного корректировочного документа с хоз. операцей ""Исправление первичных документов"". 
					|Каждую последующую корректировку следует вводить на основании предыдущей.");
			Отказ = Истина;
		КонецЕсли;
		
	КонецЕсли;
	
	// Вызываем общий обработчик события
	Если НЕ дкПередЗаписью(ЭтотОбъект, Отказ, РежимЗаписи, РежимПроведения) Тогда
		Возврат;
	КонецЕсли;
	
	// Проверка корректности типа цен.
	Если ТипЦен.Рассчитывается Тогда
		
		Отказ = Истина;
		Сообщить(НСтр("ru = 'Использование расчетных типов цен запрещено.'"));
		
	КонецЕсли;
	
	ДополнительныеСвойства.Вставить("ДоговорВзаиморасчетовБыл");
	ДополнительныеСвойства.Вставить("АвтомобильСкладКомпанииБыл");
	ДополнительныеСвойства.Вставить("АвтомобильБыл");
	ДополнительныеСвойства.Вставить("МоментВремениБыл");
	// получим старые значения, влияющие на границы последовательности
	Если НЕ Отказ И Проведен И РежимЗаписи=РежимЗаписиДокумента.Проведение Тогда
		
		БылиДвижения = Ложь;
		Запрос = Новый Запрос();
		Запрос.УстановитьПараметр("Ссылка",Ссылка);
		
		// взаиморасчеты
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ ДоговорВзаиморасчетов ИЗ РегистрНакопления.ВзаиморасчетыКомпании ГДЕ Регистратор=&Ссылка";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			БылиДвижения = Истина;
			ДополнительныеСвойства.Вставить("ДоговорВзаиморасчетовБыл", Результат.Выгрузить().ВыгрузитьКолонку("ДоговорВзаиморасчетов"));
		КонецЕсли;
		
		// автомобили
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ СкладКомпании ИЗ РегистрНакопления.ОстаткиАвтомобилей ГДЕ Регистратор=&Ссылка";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			БылиДвижения = Истина;
			ДополнительныеСвойства.Вставить("АвтомобильСкладКомпанииБыл", Результат.Выгрузить().ВыгрузитьКолонку("СкладКомпании"));
		КонецЕсли;
		
		// комплектация
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ Автомобиль ИЗ РегистрНакопления.КомплектацияАвтомобилей ГДЕ Регистратор=&Ссылка";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			БылиДвижения = Истина;
			ДополнительныеСвойства.Вставить("АвтомобильБыл", Результат.Выгрузить().ВыгрузитьКолонку("Автомобиль"));
		КонецЕсли;
		
		// прошлый момент времени
		Если БылиДвижения Тогда
			Запрос.Текст = "ВЫБРАТЬ МоментВремени ИЗ Документ."+Метаданные().Имя+" ГДЕ Ссылка=&Ссылка";
			ДополнительныеСвойства.Вставить("МоментВремениБыл",Запрос.Выполнить().Выгрузить().Получить(0).МоментВремени);
		КонецЕсли;
		
	КонецЕсли;
	
	РассчитатьСуммуВсего();
	
КонецПроцедуры

// Обработчик события возникающего после записи объекта в базу данных, но до окончания транзакции записи.
//
// Параметры:
//  Отказ - Булево - Признак отказа от совершения операции.
//
Процедура ПриЗаписи(Отказ)
	
	// Вызываем общий обработчик события
	Если НЕ дкПриЗаписи(ЭтотОбъект, Отказ) Тогда
		Возврат;
	КонецЕсли;
	
КонецПроцедуры // ПриЗаписи()

// Обработчик события возникающего в транзакции удаления перед непосредственным удалением объекта из базы данных.
//
// Параметры:
//  Отказ - Булево - Признак отказа от совершения операции.
//
Процедура ПередУдалением(Отказ)
	
	// Вызываем общий обработчик события
	Если НЕ дкПередУдалением(ЭтотОбъект, Отказ) Тогда
		Возврат;
	КонецЕсли;
	
КонецПроцедуры // ПередУдалением()

// Обработчик события возникающего при отмене проведения документа. Выполняется в транзакции записи.
//
// Параметры:
//  Отказ - Булево - Признак отказа от совершения операции.
//
Процедура ОбработкаУдаленияПроведения(Отказ)
	
	// Вызываем общий обработчик события
	Если НЕ дкОбработкаУдаленияПроведения(ЭтотОбъект, Отказ) Тогда
		Возврат;
	КонецЕсли;

КонецПроцедуры // ОбработкаУдаленияПроведения()

// Обработчик события возникающего в транзакции записи для формирования движений документу по подчиненным регистрам.
//
// Параметры:
//  Отказ           - Булево                   - Признак отказа от совершения операции.
//  РежимПроведения - РежимПроведенияДокумента - Текущий режим проведения.
//
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// Вызываем общий обработчик события
	Если НЕ дкОбработкаПроведения(ЭтотОбъект, Отказ, РежимПроведения) Тогда
		Возврат;
	КонецЕсли;

	Если НЕ ВозможенВВодНаОсновании(Сделка) Тогда
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	ТаблицаДокумента = ПолучитьТаблицуАвтомобилей();
	СписокОснований  = ПолучитьСписокОснований();
	
	// движения по регистру Остатки автомобилей
	НеобходимоСкорректироватьСебестоимость = ВыполнитьДвиженияПоОстаткам(ТаблицаДокумента, СписокОснований, Отказ);
	
	// движения по регистру взаиморасчетов
	ВыполнитьДвиженияПоВзаиморасчетам(Отказ, РежимПроведения);
	
	// движения по продажам
	ВыполнитьДвиженияПоРегистрамРеализации(НеобходимоСкорректироватьСебестоимость, ТаблицаДокумента, Отказ);
	
	ВыполнитьДвиженияПоВозвратуАвтомобилей(ТаблицаДокумента, Отказ, РежимПроведения);
	
	// Проверим налиие прослеживаемых товаров, которые были возвращены из розницы
	ТаблицаПрослеживаемыхТоваров = Документы.КорректировкаПоступленияАвтомобилей.ОперацииСПрослеживаемымиТоварами(
		ЭтотОбъект);
	НаборЗаписейОперацииПрослеживаемости = Движения.ОперацииПрослеживаемыхТоваров;
	НаборЗаписейОперацииПрослеживаемости.ДокументОбъект = ЭтотОбъект;
	НаборЗаписейОперацииПрослеживаемости.ТаблицаПрослеживаемыхТоваров = ТаблицаПрослеживаемыхТоваров;
	Если НЕ НаборЗаписейОперацииПрослеживаемости.ДобавитьОперациюПрослеживаемости() Тогда
		Отказ = Истина;
	КонецЕсли;
	
	// Возможно расхождение баланса на "копейки" из-за округления. Возникшую разницу
	// необходимо списать на доходы и расходы.
	Отказ = НЕ дкСписаниеКопейкиПриОкругленииВалютныхСчетов(ЭтотОбъект) ИЛИ Отказ;
	
	// Границы
	Если РежимПроведения<>РежимПроведенияДокумента.Оперативный ИЛИ ЗначениеЗаполнено(ДополнительныеСвойства.АвтомобильСкладКомпанииБыл) Тогда
		// Двигаем границу последовательности автомобилей
		НаборЗаписейГраницыАвтомобили = РегистрыСведений.ГраницыАвтомобили.СоздатьНаборЗаписей();
		Если РежимПроведения<>РежимПроведенияДокумента.Оперативный Тогда
			НаборЗаписейГраницыАвтомобили.СкладКомпании		= СкладКомпании;
			НаборЗаписейГраницыАвтомобили.МоментВремени		= Дата;
			НаборЗаписейГраницыАвтомобили.СкладКомпанииБыл	= ДополнительныеСвойства.АвтомобильСкладКомпанииБыл;
			НаборЗаписейГраницыАвтомобили.МоментВремениБыл	= ДополнительныеСвойства.МоментВремениБыл;
		Иначе
			НаборЗаписейГраницыАвтомобили.СкладКомпании		= ДополнительныеСвойства.АвтомобильСкладКомпанииБыл;
			НаборЗаписейГраницыАвтомобили.МоментВремени		= ДополнительныеСвойства.МоментВремениБыл;
			НаборЗаписейГраницыАвтомобили.СкладКомпанииБыл	= Неопределено;
			НаборЗаписейГраницыАвтомобили.МоментВремениБыл	= Неопределено;
		КонецЕсли;
		НаборЗаписейГраницыАвтомобили.ДокументСсылка = Ссылка;
		НаборЗаписейГраницыАвтомобили.ИзменитьГраницу();
	КонецЕсли;
	
	ДвигаемГраницу = (РежимПроведения<>РежимПроведенияДокумента.Оперативный И Движения.ВзаиморасчетыКомпании.Количество()>0);
	Если ДвигаемГраницу ИЛИ ЗначениеЗаполнено(ДополнительныеСвойства.ДоговорВзаиморасчетовБыл) Тогда
		НаборЗаписейГраницыВзаиморасчетов = РегистрыСведений.ГраницыВзаиморасчетов.СоздатьНаборЗаписей();
		Если ДвигаемГраницу Тогда
			ТаблицаДоговоров = Движения.ВзаиморасчетыКомпании.Выгрузить();
			ТаблицаДоговоров.Свернуть("ДоговорВзаиморасчетов","");
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетов = ТаблицаДоговоров.ВыгрузитьКолонку("ДоговорВзаиморасчетов");
			НаборЗаписейГраницыВзаиморасчетов.МоментВремени = Дата;
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетовБыл = ДополнительныеСвойства.ДоговорВзаиморасчетовБыл;
			НаборЗаписейГраницыВзаиморасчетов.МоментВремениБыл = ДополнительныеСвойства.МоментВремениБыл;
		Иначе
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетов = ДополнительныеСвойства.ДоговорВзаиморасчетовБыл;
			НаборЗаписейГраницыВзаиморасчетов.МоментВремени = ДополнительныеСвойства.МоментВремениБыл;
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетовБыл = Неопределено;
			НаборЗаписейГраницыВзаиморасчетов.МоментВремениБыл = Неопределено;
		КонецЕсли;
		НаборЗаписейГраницыВзаиморасчетов.ДокументСсылка = Ссылка;
		НаборЗаписейГраницыВзаиморасчетов.ИзменитьГраницу();
	КонецЕсли;

	// выведем сообщения об ошибках и предупреждениях
	дкВыводРезультатовОбработки(ЭтотОбъект,Отказ);
	
КонецПроцедуры // ОбработкаПроведения

Функция ВозможенВВодНаОсновании(ДанныеЗаполнения)
	
	Если ЗначениеЗаполнено(ДанныеЗаполнения)
		И (ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ПоступлениеАвтомобилей")
		Или ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.КорректировкаПоступленияАвтомобилей")) Тогда
		
		Если ДанныеЗаполнения = Ссылка Тогда
			Сообщить("Ввод корректировки поступления автомобилей на основании самой себя запрещен.", СтатусСообщения.Внимание);
			Возврат Ложь;
		КонецЕсли;
		
		Если НЕ ДанныеЗаполнения.Проведен Тогда
			Сообщить("Ввод корректировки реализации автомобилей возможен только на основании проведенного документа.", СтатусСообщения.Внимание);
			Возврат Ложь;
		КонецЕсли;

		ХозОперацияОснования = ДанныеЗаполнения.ХозОперация;    
		//ЧалапАю БизТех 14.02.2025 коммент
		//Если ХозОперацияОснования = Справочники.ХозОперации.ПоступлениеАвтомобилейКомиссия Тогда
		//	Сообщить("Ввод корректировки поступления автомобилей не возможен на основании поступления автомобилей комиссия.", СтатусСообщения.Внимание);
		//	Возврат Ложь;
		//КонецЕсли;
		
		//<<BizTeh 08.08.2023 Ввод корректировки на основании поступления 
		
		//Если ХозОперацияОснования = Справочники.ХозОперации.ПоступлениеАвтомобилейОтветственноеХранение Тогда
		//	Сообщить("Ввод корректировки поступления автомобилей не возможен на основании поступления автомобилей на ответственное хранение.", СтатусСообщения.Внимание);
		//	Возврат Ложь;
		//КонецЕсли;  
		//Если ХозОперацияОснования = Справочники.ХозОперации.ПереходВСобственностьАвтомобилей Тогда
		//	Сообщить("Ввод корректировки поступления автомобилей не возможен на основании перехода автомобилей в собственность.", СтатусСообщения.Внимание);
		//	Возврат Ложь;
		//КонецЕсли;  >>

		
		Если Документы.КорректировкаПоступленияАвтомобилей.КорректировкаНеДоступна(ДанныеЗаполнения) Тогда
			ТекстСообщения = "На основании <"+ДанныеЗаполнения+"> введен возврат автомобилей поставщику. Ввод корректировки поступления автомобилей невозможен.";
			Сообщить(ТекстСообщения, СтатусСообщения.Внимание);
			Возврат Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

Функция ПолучитьСебестоимостьАвтомобиля(Автомобиль, СписокОснований = Неопределено) Экспорт
	Если СписокОснований = Неопределено Тогда
		СписокОснований = ПолучитьСписокОснований();
	КонецЕсли;
	
	Результат = Новый Структура("Сумма,СуммаУпр,СуммаНДС",0,0,0);
	
	// автомобили
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СУММА(ОстаткиАвтомобилей.Сумма) КАК Сумма,
	|	СУММА(ОстаткиАвтомобилей.СуммаУпр) КАК СуммаУпр,
	|	СУММА(ОстаткиАвтомобилей.СуммаНДС) КАК СуммаНДС
	|ИЗ
	|	РегистрНакопления.ОстаткиАвтомобилей КАК ОстаткиАвтомобилей
	|ГДЕ
	|	ОстаткиАвтомобилей.ВидДвижения = &ВидДвижения
	|	И ОстаткиАвтомобилей.Регистратор В(&Регистраторы)
	|	И ОстаткиАвтомобилей.Автомобиль = &Автомобиль
	|	"+?(Сделка.ХозОперация = Справочники.ХозОперации.ПереходВСобственностьАвтомобилей,"И ОстаткиАвтомобилей.СтатусПартии <> &СтатусПартии","")+"";
	
	Запрос.УстановитьПараметр("ВидДвижения"  , ВидДвиженияНакопления.Приход);
	Запрос.УстановитьПараметр("Автомобиль"   , Автомобиль);
	Запрос.УстановитьПараметр("Регистраторы" , СписокОснований);
	Запрос.УстановитьПараметр("СтатусПартии" , Перечисления.СтатусыПартий.ТоварОтветственноеХранение);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат.Сумма    = Результат.Сумма + Выборка.Сумма;
		Результат.СуммаУпр = Результат.СуммаУпр + Выборка.СуммаУпр;
		Результат.СуммаНДС = Результат.СуммаНДС + Выборка.СуммаНДС;
	КонецЕсли;
	
	// получим сумму опций
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СУММА(КомплектацияАвтомобилей.Сумма) КАК Сумма,
	|	СУММА(КомплектацияАвтомобилей.СуммаНДС) КАК СуммаНДС,
	|	СУММА(КомплектацияАвтомобилей.СуммаУпр) КАК СуммаУпр
	|ИЗ
	|	РегистрНакопления.КомплектацияАвтомобилей КАК КомплектацияАвтомобилей
	|ГДЕ
	|	КомплектацияАвтомобилей.Автомобиль = &Автомобиль
	|	И КомплектацияАвтомобилей.ВидДвижения = &ВидДвижения
	|	И КомплектацияАвтомобилей.Регистратор В(&Регистраторы)
	|	И КомплектацияАвтомобилей.Номенклатура ССЫЛКА Справочник.Опции
	|"+?(Сделка.ХозОперация = Справочники.ХозОперации.ПереходВСобственностьАвтомобилей,"И КомплектацияАвтомобилей.СтатусПартии <> &СтатусПартии","")+"";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() И Выборка.Сумма <> null Тогда
		Результат.Сумма    = Результат.Сумма + Выборка.Сумма;
		Результат.СуммаУпр = Результат.СуммаУпр + Выборка.СуммаУпр;
		Результат.СуммаНДС = Результат.СуммаНДС + Выборка.СуммаНДС;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ВыполнитьДвиженияПоОстаткам(ТаблицаДокумента, СписокОснований, Отказ)
	
	НеобходимоСкорректироватьСебестоимость = Новый Массив;
	
	Если ТаблицаДокумента.Количество() = 0 Тогда
		Возврат НеобходимоСкорректироватьСебестоимость;
	КонецЕсли;
	
	ВалютаУпр  = Константы.ВалютаУправленческогоУчетаКомпании.Получить();
	ВалютаРегл = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	
	// получим записи из регистра остатков
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ОстаткиАвтомобилей.Автомобиль КАК Автомобиль,
	|	ОстаткиАвтомобилей.СкладКомпании КАК СкладКомпании,
	|	ОстаткиАвтомобилей.СтатусПартии КАК СтатусПартии,
	|	ОстаткиАвтомобилей.Партия КАК Партия,
	|	ОстаткиАвтомобилей.ГТД КАК ГТД,
	|	СУММА(ОстаткиАвтомобилей.Количество) КАК Количество,
	|	СУММА(ОстаткиАвтомобилей.Сумма) КАК Сумма,
	|	СУММА(ОстаткиАвтомобилей.СуммаНДС) КАК СуммаНДС,
	|	СУММА(ОстаткиАвтомобилей.СуммаУпр) КАК СуммаУпр
	|ИЗ
	|	РегистрНакопления.ОстаткиАвтомобилей КАК ОстаткиАвтомобилей
	|ГДЕ
	|	ОстаткиАвтомобилей.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И ОстаткиАвтомобилей.Регистратор В(&Регистраторы)
	|	И ОстаткиАвтомобилей.Автомобиль В(&Автомобили)
	|	И ОстаткиАвтомобилей.СкладКомпании.Организация = &Организация           //БизТех Аляль 26.08.2024г.
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиАвтомобилей.Партия,
	|	ОстаткиАвтомобилей.СтатусПартии,
	|	ОстаткиАвтомобилей.Автомобиль,
	|	ОстаткиАвтомобилей.СкладКомпании,
	|	ОстаткиАвтомобилей.ГТД";
	
	
	Запрос.УстановитьПараметр("Регистраторы" , СписокОснований);
	Запрос.УстановитьПараметр("Автомобили"   , ТаблицаДокумента.ВыгрузитьКолонку("Автомобиль")); 
	Запрос.УстановитьПараметр("Организация", ЭтотОбъект.СкладКомпании.Организация);
	
	ТаблицаОстатков = Запрос.Выполнить().Выгрузить();
	
	Для Каждого СтрокаАвтомобиля Из ТаблицаДокумента Цикл
		
		Если СтрокаАвтомобиля.Количество = 0 Тогда
			
			// Проверим наличия автомобиля на остатках
			Если НЕ СтрокаАвтомобиля.ЕстьОстаток Тогда
				дкСообщитьРезультат("Автомобиль <"+СтрокаАвтомобиля.Автомобиль+"> отсутствует на складе <"+СкладКомпании+">. Расход невозможен.", , ЭтотОбъект);
				Отказ = Истина;
				Продолжить;
			КонецЕсли;
			
			НайденныеСтроки = ТаблицаОстатков.НайтиСтроки(Новый Структура("Автомобиль", СтрокаАвтомобиля.Автомобиль));
			
			Если НайденныеСтроки.Количество() = 0 Тогда
				дкСообщитьРезультат("Автомобиль <"+СтрокаАвтомобиля.Автомобиль+"> не найденны движения в данной цепочке.", , ЭтотОбъект);
				Отказ = Истина;
				Продолжить;
			КонецЕсли;
			
			// Сторнирование поступления авто
			ОстаткиПоСделке = Ложь;
			Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				ДвижениеОстатки = Движения.ОстаткиАвтомобилей.Добавить();
				ЗаполнитьЗначенияСвойств(ДвижениеОстатки, НайденнаяСтрока);
				
				ДвижениеОстатки.Период         = Дата;
				ДвижениеОстатки.Регистратор    = Ссылка;
				ДвижениеОстатки.ВидДвижения    = ВидДвиженияНакопления.Приход;
				ДвижениеОстатки.Количество     = -ДвижениеОстатки.Количество;
				ДвижениеОстатки.Сумма          = -ДвижениеОстатки.Сумма;
				ДвижениеОстатки.СуммаНДС       = -ДвижениеОстатки.СуммаНДС;
				ДвижениеОстатки.СуммаУпр       = -ДвижениеОстатки.СуммаУпр;
				
				ДвижениеОстатки.СтавкаНДС   = СтрокаАвтомобиля.СтавкаНДС;
				ДвижениеОстатки.ХозОперация = ХозОперация;
				ОстаткиПоСделке = ОстаткиПоСделке ИЛИ (НайденнаяСтрока.Партия = СтрокаАвтомобиля.Партия);
			КонецЦикла;
			
			Если НЕ ОстаткиПоСделке Тогда
				дкСообщитьРезультат("Не удалось откорректировать автомобиль <"+СтрокаАвтомобиля.Автомобиль+"> - партия была расформирована.", , ЭтотОбъект);
				Отказ = Истина;
				Продолжить;
			КонецЕсли;
			
		Иначе
			
			НайденныеСтроки = ТаблицаОстатков.НайтиСтроки(Новый Структура("Автомобиль", СтрокаАвтомобиля.Автомобиль));
			
			СтрокаОстаткаАвтомобиля = Неопределено;
			
			Если НайденныеСтроки.Количество() = 0 Тогда
				СтрокаОстаткаАвтомобиля = Неопределено;
			ИначеЕсли Сделка.ХозОперация = Справочники.ХозОперации.ПереходВСобственностьАвтомобилей Тогда
				Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
					Если НЕ НайденнаяСтрока.СтатусПартии = Перечисления.СтатусыПартий.ТоварОтветственноеХранение Тогда
						СтрокаОстаткаАвтомобиля = НайденнаяСтрока;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			Иначе
				СтрокаОстаткаАвтомобиля = НайденныеСтроки[0];
			КонецЕсли;
			
			Если СтрокаОстаткаАвтомобиля = Неопределено Тогда
				дкСообщитьРезультат("Для автомобиля <"+СтрокаАвтомобиля.Автомобиль+"> не найденны движения в данной цепочке.", , ЭтотОбъект);
				Отказ = Истина;
				Продолжить;
			КонецЕсли;
			
			ДвижениеОстатки = Движения.ОстаткиАвтомобилей.Добавить();  
			//БизТех 07.08.2023г. ГТД не хватало <<
			//ЗаполнитьЗначенияСвойств(ДвижениеОстатки, СтрокаОстаткаАвтомобиля, "Автомобиль,СкладКомпании,СтатусПартии,Партия"); 
			ЗаполнитьЗначенияСвойств(ДвижениеОстатки, СтрокаОстаткаАвтомобиля, "Автомобиль,СкладКомпании,СтатусПартии,Партия,ГТД");  
			//БизТех >>
			
			//ЧалапАЮ БизТех 04.10.2023 <<
			//найдем актуальный склад остатка    
			ЗапросОстатка = Новый Запрос("ВЫБРАТЬ
			                             |	ОстаткиАвтомобилейОстатки.Автомобиль КАК Автомобиль,
			                             |	ОстаткиАвтомобилейОстатки.СкладКомпании КАК СкладКомпании
			                             |ИЗ
			                             |	РегистрНакопления.ОстаткиАвтомобилей.Остатки(&КонецПериода, ) КАК ОстаткиАвтомобилейОстатки
			                             |ГДЕ
			                             |	ОстаткиАвтомобилейОстатки.Автомобиль = &Автомобиль
			                             |	И ОстаткиАвтомобилейОстатки.СкладКомпании.Организация = &Организация");
			
			ЗапросОстатка.УстановитьПараметр("Автомобиль", СтрокаОстаткаАвтомобиля.Автомобиль);
			ЗапросОстатка.УстановитьПараметр("КонецПериода",ЭтотОбъект.Дата);  
			ЗапросОстатка.УстановитьПараметр("Организация", ЭтотОбъект.Организация);
			
			Результат = ЗапросОстатка.Выполнить();
			
			Если не Результат.Пустой() тогда      
				ВыборкаЗаписей = Результат.Выбрать();
				Пока ВыборкаЗаписей.Следующий() цикл
					ДвижениеОстатки.СкладКомпании = ВыборкаЗаписей.СкладКомпании;	
				КонецЦикла;
			КонецЕсли;  //ЧалапАЮ БизТех 04.10.2023>>
			
			ДвижениеОстатки.Период         = Дата;
			ДвижениеОстатки.Регистратор    = Ссылка;
			ДвижениеОстатки.ВидДвижения    = ВидДвиженияНакопления.Приход;
			ДвижениеОстатки.Количество     = 0;
			ДвижениеОстатки.Сумма          = обПересчет(СтрокаАвтомобиля.СуммаВсегоРазница, ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата);
			ДвижениеОстатки.СуммаНДС       = обПересчет(СтрокаАвтомобиля.СуммаНДСРазница  , ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата);
			ДвижениеОстатки.СуммаУпр       = обПересчет(СтрокаАвтомобиля.СуммаВсегоРазница, ВалютаДокумента, КурсДокумента, ВалютаУпр , КурсВалютыУпр);
			
			ДвижениеОстатки.СтавкаНДС   = СтрокаАвтомобиля.СтавкаНДС;
			ДвижениеОстатки.ХозОперация = ХозОперация;
			
			// откорректруем списывающие движение если необходимо
			Если НЕ СтрокаАвтомобиля.ЕстьОстаток ИЛИ Результат.Пустой() Тогда
				ДвижениеОстаткиРасход = Движения.ОстаткиАвтомобилей.Добавить();
				ЗаполнитьЗначенияСвойств(ДвижениеОстаткиРасход, ДвижениеОстатки);
				ДвижениеОстаткиРасход.ВидДвижения = ВидДвиженияНакопления.Расход;
				
				// скорректируем себестоимость на регистре продажи
				Если Сделка.ХозОперация <> Справочники.ХозОперации.ПоступлениеАвтомобилейОтветственноеХранение Тогда
					НеобходимоСкорректироватьСебестоимость.Добавить(СтрокаАвтомобиля.Автомобиль);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Движения.ОстаткиАвтомобилей.Записать();
	
	Возврат НеобходимоСкорректироватьСебестоимость;
	
КонецФункции

Процедура ВыполнитьДвиженияПоРегистрамРеализации(НеобходимоСкорректироватьСебестоимость, ТаблицаДокумента, Отказ)
	
	Если НеобходимоСкорректироватьСебестоимость.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПродажиАвтомобилей.ПодразделениеКомпании,
	|	ПродажиАвтомобилей.Автомобиль,
	|	ПродажиАвтомобилей.ДокументПродажи,
	|	ПродажиАвтомобилей.Поставщик,
	|	ПродажиАвтомобилей.Покупатель,
	|	ПродажиАвтомобилей.СтатусПартии,
	|	ПродажиАвтомобилей.ДоговорВзаиморасчетов,
	|	ПродажиАвтомобилей.СкладКомпании,
	|	ПродажиАвтомобилей.СтавкаНДС,
	|	ПродажиАвтомобилей.Партия,
	|	ПродажиАвтомобилей.ГТД
	|ИЗ
	|	РегистрНакопления.ПродажиАвтомобилей КАК ПродажиАвтомобилей
	|ГДЕ
	|	ПродажиАвтомобилей.Автомобиль В(&Автомобили)
	|	И ПродажиАвтомобилей.Партия = &Партия
	|
	|СГРУППИРОВАТЬ ПО
	|	ПродажиАвтомобилей.ПодразделениеКомпании,
	|	ПродажиАвтомобилей.Автомобиль,
	|	ПродажиАвтомобилей.ДокументПродажи,
	|	ПродажиАвтомобилей.Поставщик,
	|	ПродажиАвтомобилей.Покупатель,
	|	ПродажиАвтомобилей.СтатусПартии,
	|	ПродажиАвтомобилей.ДоговорВзаиморасчетов,
	|	ПродажиАвтомобилей.СкладКомпании,
	|	ПродажиАвтомобилей.СтавкаНДС,
	|	ПродажиАвтомобилей.Партия,
	|	ПродажиАвтомобилей.ГТД";
	
	Запрос.УстановитьПараметр("Автомобили" , НеобходимоСкорректироватьСебестоимость);
	Запрос.УстановитьПараметр("Партия"     , Сделка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВалютаУпр  = Константы.ВалютаУправленческогоУчетаКомпании.Получить();
	ВалютаРегл = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	
	СуммаДоходовИРасходов = 0;
	
	Пока Выборка.Следующий() Цикл
		// получим сумму из документа и откорректируем продажи
		НайденныеСтроки = ТаблицаДокумента.НайтиСтроки(Новый Структура("Автомобиль",Выборка.Автомобиль));
		Если НайденныеСтроки.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		СуммаРазница    = НайденныеСтроки[0].СуммаВсегоРазница;
		СуммаНДСРазница = НайденныеСтроки[0].СуммаНДСРазница;
		
		НоваяЗапись = Движения.ПродажиАвтомобилей.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяЗапись, Выборка, "ПодразделениеКомпании,Автомобиль,ДокументПродажи,Поставщик,Покупатель,СтатусПартии,ДоговорВзаиморасчетов,СкладКомпании,СтавкаНДС,Партия,ГТД");
		
		НоваяЗапись.Период      = Дата;
		НоваяЗапись.Регистратор = Ссылка;
		НоваяЗапись.ХозОперация = ХозОперация;
		
		НоваяЗапись.Себестоимость    = обПересчет(СуммаРазница, ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата);
		НоваяЗапись.СебестоимостьУпр = обПересчет(СуммаРазница, ВалютаДокумента, КурсДокумента, ВалютаУпр , КурсВалютыУпр);
		НоваяЗапись.СуммаНДСВходящий = обПересчет(СуммаНДСРазница, ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата);
		
		// скорректируем доходы
		СуммаДоходовИРасходов = СуммаДоходовИРасходов + НоваяЗапись.СебестоимостьУпр;
		
		// Также откоректируем себестоимость на регистре реализованных авто,
		// если отчет комитенту строится по сумме поступления.
		Если Сделка.ХозОперация = Справочники.ХозОперации.ПоступлениеАвтомобилейКомиссия
				И ДоговорВзаиморасчетов.КомиссияОтчетНаОснованииПродаж Тогда
			ЗаписьРеализованныеАвто                       = Движения.РеализованныеАвтомобили.Добавить();
			ЗаписьРеализованныеАвто.Период                = Дата;
			ЗаписьРеализованныеАвто.Регистратор           = Ссылка;
			ЗаписьРеализованныеАвто.Контрагент            = Контрагент;
			ЗаписьРеализованныеАвто.ДоговорВзаиморасчетов = ДоговорВзаиморасчетов;
			ЗаписьРеализованныеАвто.Автомобиль            = Выборка.Автомобиль;
			ЗаписьРеализованныеАвто.ДокументПередачи      = Сделка;
			ЗаписьРеализованныеАвто.ГТД                   = Выборка.ГТД;
			ЗаписьРеализованныеАвто.СуммаУпр              = НоваяЗапись.СебестоимостьУпр;
			ЗаписьРеализованныеАвто.СуммаРегл             = НоваяЗапись.Себестоимость;
		КонецЕсли;
		
	КонецЦикла;
	
	Движения.ПродажиАвтомобилей.Записать();
	Движения.РеализованныеАвтомобили.Записать();
	
	Если СуммаДоходовИРасходов <> 0 Тогда
		НаборЗаписейДиР = Движения.ДоходыИРасходы;
		НаборЗаписейДиР.ДокументОбъект         = ЭтотОбъект;
		НаборЗаписейДиР.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СебестоимостьАвтомобилей;
		НаборЗаписейДиР.ВУпрВалюте             = Истина;
		Если Сделка.ХозОперация = Справочники.ХозОперации.ПоступлениеАвтомобилейКомиссия Тогда
			НаборЗаписейДиР.Доход = СуммаДоходовИРасходов;
			Отказ = НЕ НаборЗаписейДиР.Расход() ИЛИ Отказ;
		Иначе
			НаборЗаписейДиР.Расход = СуммаДоходовИРасходов;
			Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;
		КонецЕсли;
	КонецЕсли;
	
	Движения.ДоходыИРасходы.Записать();
КонецПроцедуры

Процедура ВыполнитьДвиженияПоВозвратуАвтомобилей(ТаблицаДокумента, Отказ, Режим)
	
	// Сформируем список автомобилей для возврата
	АвтомобилиКВозврату = Новый Массив;
	
	НайденныеСтроки = ТаблицаДокумента.НайтиСтроки(Новый Структура("Количество", 0));
	
	// Автомобилей нет к возврату
	Если НайденныеСтроки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого ТекущаяСтрока Из НайденныеСтроки Цикл
		АвтомобилиКВозврату.Добавить(ТекущаяСтрока.Автомобиль);
	КонецЦикла;
	
	// Проверим наличие незакрытых документов по комплектации автомобилей.
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗаказНаряд.Ссылка) КАК ЗаказНаряд,
	               |	ЗаказНаряд.Автомобиль КАК Автомобиль
	               |ИЗ
	               |	Документ.ЗаказНаряд КАК ЗаказНаряд
	               |ГДЕ
	               |	ЗаказНаряд.Автомобиль В(&Автомобили)
	               |	И ЗаказНаряд.Дата <= &Дата
	               |	И ЗаказНаряд.ВидРемонта = ЗНАЧЕНИЕ(Справочник.ВидыРемонта.КомплектацияАвтомобиля)
	               |	И НЕ ЗаказНаряд.ПометкаУдаления
	               |	И ЗаказНаряд.Состояние <> ЗНАЧЕНИЕ(Справочник.ВидыСостоянийЗаказНарядов.Закрыт)
	               |ИТОГИ ПО
	               |	Автомобиль";
	Запрос.УстановитьПараметр("Автомобили", АвтомобилиКВозврату);
	Запрос.УстановитьПараметр("Дата", Дата);
	
	ВыборкаАвтомобилей = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаАвтомобилей.Следующий() Цикл
		
		СписокЗН = Новый Массив;
		ВыборкаЗН = ВыборкаАвтомобилей.Выбрать();
		
		Пока ВыборкаЗН.Следующий() Цикл
			СписокЗН.Добавить(ВыборкаЗН.ЗаказНаряд);
		КонецЦикла;
		
		дкСообщитьРезультат("У автомобиля <"+ВыборкаАвтомобилей.Автомобиль+"> есть незавершенные документы по комплектации: "+СтрСоединить(СписокЗН, "; "), , ЭтотОбъект);
		Отказ = Истина;
		
	КонецЦикла;
	
	Отказ = ПроверитьЗаказыНаАвтомобиль(АвтомобилиКВозврату) ИЛИ Отказ;
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	ПровестиПоПартиям(Режим, Ссылка, ТаблицаДокумента, АвтомобилиКВозврату);
	
КонецПроцедуры // ВыполнитьДвиженияПоВозвратуАвтомобилей()

// Проверка наличия резервов на автомобиль
//
// Параметры
// Возвращаемое значение:
//   <Булево>   – Заказов на данный автомобиль нет.
//
Функция ПроверитьЗаказыНаАвтомобиль(АвтомобилиКВозврату)
	ДокументОбъектСтруктура = Новый Структура();
	ДокументОбъектСтруктура.Вставить("МоментВремени", МоментВремени());
	ДокументОбъектСтруктура.Вставить("Автомобили", АвтомобилиКВозврату);
	
	Возврат зфЗащищенныеФункцииСервер.РезервыАвтомобиляПроверитьЗаказыНаАвтомобиль(ДокументОбъектСтруктура,РезультатОбработки);
КонецФункции // ПроверитьЗаказыНаАвтомобиль()

// Формирует движения документа по партионным регистрам
// Возвращает Истина - все хорошо, ложь - чего-то не так.
Функция ПровестиПоПартиям(Режим,ДокументСсылка,ТаблицаДокумента,АвтомобилиКВозврату) Экспорт
	Отказ=Ложь;
	
	// получим шапку документа
	ШапкаДокумента=ПолучитьШапкуДокумента(ДокументСсылка);
	
	// Получим способ ведения баланса.
	БалансВедетсяПоПодразделениям = (Константы.СпособВеденияБаланса.Получить() = Перечисления.СпособВеденияБаланса.ПоПодразделению);
		
	// Определим необходимость корректирующих проводок для поддержания баланса по подразделениям.
	ПодразделениеСклад                 = обПолучитьБалансовоеПодразделение(СкладКомпании.Подразделение);
	ПодразделениеДоговорВзаиморасчетов = обПолучитьБалансовоеПодразделение(ДоговорВзаиморасчетов.Подразделение);
	БалансовыеПодразделенияНеРавны     = (ПодразделениеДоговорВзаиморасчетов<>ПодразделениеСклад);
		
	// Если было отложенное проведение по партиям, то :
	// Очистим возможные движения по регистру комплектации автомобилей. 
	НаборЗаписейПартионногоРегистра=РегистрыНакопления.КомплектацияАвтомобилей.СоздатьНаборЗаписей();
	НаборЗаписейПартионногоРегистра.Отбор.Регистратор.Значение=ШапкаДокумента.Ссылка;
	НаборЗаписейПартионногоРегистра.Отбор.Регистратор.Использование=Истина;
	НаборЗаписейПартионногоРегистра.Записать();
	
	// Спишем оборудование автомобиля
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	КомплектацияАвтомобилейОстатки.Автомобиль КАК Автомобиль,
	               |	КомплектацияАвтомобилейОстатки.СкладКомпании КАК СкладКомпании,
	               |	КомплектацияАвтомобилейОстатки.Номенклатура КАК Номенклатура,
	               |	КомплектацияАвтомобилейОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	               |	КомплектацияАвтомобилейОстатки.СтатусПартии КАК СтатусПартии,
	               |	КомплектацияАвтомобилейОстатки.Партия КАК Партия,
	               |	КомплектацияАвтомобилейОстатки.ГТД КАК ГТД,
	               |	КомплектацияАвтомобилейОстатки.КоличествоОстаток КАК Количество,
	               |	КомплектацияАвтомобилейОстатки.СуммаОстаток КАК Сумма,
	               |	КомплектацияАвтомобилейОстатки.СуммаНДСОстаток КАК СуммаНДС,
	               |	КомплектацияАвтомобилейОстатки.СуммаУпрОстаток КАК СуммаУпр,
	               |	КомплектацияАвтомобилейОстатки.СуммаПродажиОстаток КАК СуммаПродажи,
	               |	КомплектацияАвтомобилейОстатки.СуммаПродажиУпрОстаток КАК СуммаПродажиУпр
	               |ИЗ
	               |	РегистрНакопления.КомплектацияАвтомобилей.Остатки(&МоментВремени, Автомобиль В (&СписокАвтомобилей)) КАК КомплектацияАвтомобилейОстатки";
	Запрос.УстановитьПараметр("МоментВремени"     , МоментВремени());
	Запрос.УстановитьПараметр("Ссылка"            , Ссылка);
	Запрос.УстановитьПараметр("СписокАвтомобилей" , АвтомобилиКВозврату);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ДвижениеКомплектации = Движения.КомплектацияАвтомобилей.Добавить();
		ЗаполнитьЗначенияСвойств(ДвижениеКомплектации, Выборка);
		ДвижениеКомплектации.Период          = Дата;
		ДвижениеКомплектации.Регистратор     = Ссылка;
		ДвижениеКомплектации.ВидДвижения     = ВидДвиженияНакопления.Приход;
		ДвижениеКомплектации.Количество      = -ДвижениеКомплектации.Количество;
		ДвижениеКомплектации.Сумма           = -ДвижениеКомплектации.Сумма;
		ДвижениеКомплектации.СуммаНДС        = -ДвижениеКомплектации.СуммаНДС;
		ДвижениеКомплектации.СуммаУпр        = -ДвижениеКомплектации.СуммаУпр;
		ДвижениеКомплектации.СуммаПродажи    = -ДвижениеКомплектации.СуммаПродажи;
		ДвижениеКомплектации.СуммаПродажиУпр = -ДвижениеКомплектации.СуммаПродажиУпр;
		
	КонецЦикла;
	
	Движения.КомплектацияАвтомобилей.Записать();
	
	// двигаем границу последовательности комплектаций автомобилей
	Если Режим<>РежимПроведенияДокумента.Оперативный ИЛИ ЗначениеЗаполнено(ДополнительныеСвойства.АвтомобильБыл) Тогда
		// если идет допроведение, то надо получить те значения которые были раньше
		Если Ссылка<>ДокументСсылка Тогда
			Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ Автомобиль ИЗ РегистрНакопления.КомплектацияАвтомобилей ГДЕ Регистратор=&Ссылка");
			Запрос.УстановитьПараметр("Ссылка",ДокументСсылка);
			Результат = Запрос.Выполнить(); АвтомобильБыл=Неопределено;
			Если НЕ Результат.Пустой() Тогда
				АвтомобильБыл = Результат.Выгрузить().ВыгрузитьКолонку("Автомобиль");
			КонецЕсли;
			ДополнительныеСвойства.Вставить("АвтомобильБыл",АвтомобильБыл);
			ДополнительныеСвойства.МоментВремениБыл = ДокументСсылка.МоментВремени();
		КонецЕсли;
		
		НаборЗаписейГраницыКомплектация = РегистрыСведений.ГраницыКомплектация.СоздатьНаборЗаписей();
		Если Режим<>РежимПроведенияДокумента.Оперативный Тогда
			ТаблицаАвтомобилей = Движения.КомплектацияАвтомобилей.Выгрузить();
			ТаблицаАвтомобилей.Свернуть("Автомобиль","");
			НаборЗаписейГраницыКомплектация.Автомобиль = ТаблицаАвтомобилей.ВыгрузитьКолонку("Автомобиль");
			НаборЗаписейГраницыКомплектация.МоментВремени  = ШапкаДокумента.Дата;
			НаборЗаписейГраницыКомплектация.АвтомобильБыл	 = ДополнительныеСвойства.АвтомобильБыл;
			НаборЗаписейГраницыКомплектация.МоментВремениБыл = ДополнительныеСвойства.МоментВремениБыл;
		Иначе
			НаборЗаписейГраницыКомплектация.Автомобиль		 = ДополнительныеСвойства.АвтомобильБыл;
			НаборЗаписейГраницыКомплектация.МоментВремени	 = ДополнительныеСвойства.МоментВремениБыл;
			НаборЗаписейГраницыКомплектация.АвтомобильБыл	 = Неопределено;
			НаборЗаписейГраницыКомплектация.МоментВремениБыл = Неопределено;
		КонецЕсли;
		НаборЗаписейГраницыКомплектация.ДокументСсылка = ШапкаДокумента.Ссылка;
		НаборЗаписейГраницыКомплектация.ИзменитьГраницу();
	КонецЕсли;
	
	ВалютаРегл=Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить(); 
	СтруктураКурса = обКурсДляВалюты(ВалютаРегл,ШапкаДокумента.МоментВремени);
	КурсРегл = СтруктураКурса.Курс / ?(СтруктураКурса.Кратность = 0, 1, СтруктураКурса.Кратность);
	ВалютаУпр=Константы.ВалютаУправленческогоУчетаКомпании.Получить(); 
	Если НЕ ЗначениеЗаполнено(ШапкаДокумента.КурсВалютыУпр) Тогда
		СтруктураКурса = обКурсДляВалюты(ВалютаУпр,ШапкаДокумента.МоментВремени);
		КурсУпр = СтруктураКурса.Курс / ?(СтруктураКурса.Кратность = 0, 1, СтруктураКурса.Кратность);
	Иначе
		КурсУпр = ШапкаДокумента.КурсВалютыУпр;
	КонецЕсли;	
	
	// спишем реализованное оборудование
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	|	КомплектацияАвтомобилей.Период,
	|	КомплектацияАвтомобилей.Регистратор,
	|	КомплектацияАвтомобилей.НомерСтроки КАК НомерСтроки,
	|	КомплектацияАвтомобилей.Активность,
	|	КомплектацияАвтомобилей.ВидДвижения,
	|	КомплектацияАвтомобилей.Автомобиль,
	|	КомплектацияАвтомобилей.СкладКомпании,
	|	КомплектацияАвтомобилей.Номенклатура,
	|	КомплектацияАвтомобилей.ХарактеристикаНоменклатуры,
	|	КомплектацияАвтомобилей.СтатусПартии,
	|	КомплектацияАвтомобилей.Партия,
	|	КомплектацияАвтомобилей.ГТД,
	|	КомплектацияАвтомобилей.Количество,
	|	КомплектацияАвтомобилей.Сумма,
	|	КомплектацияАвтомобилей.СуммаНДС,
	|	КомплектацияАвтомобилей.СуммаУпр,
	|	КомплектацияАвтомобилей.СуммаПродажи,
	|	КомплектацияАвтомобилей.СуммаПродажиУпр,
	|	КомплектацияАвтомобилей.ХозОперация,
	|	КомплектацияАвтомобилей.СтавкаНДС
	|ИЗ
	|	РегистрНакопления.КомплектацияАвтомобилей КАК КомплектацияАвтомобилей
	|ГДЕ
	|	КомплектацияАвтомобилей.Регистратор = &Регистратор
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Регистратор", ШапкаДокумента.Ссылка);
	РезультатКомплектацияАвтомобилей = Запрос.Выполнить();
	ВыборкаКомплектацияАвтомобилей = РезультатКомплектацияАвтомобилей.Выбрать();
	НаборЗаписейРеализованныеТовары = Движения.РеализованныеТовары;
	НаборЗаписейПродажи = Движения.Продажи;
	СуммаПродажи = 0;
	Пока ВыборкаКомплектацияАвтомобилей.Следующий() Цикл
		Если ТипЗнч(ВыборкаКомплектацияАвтомобилей.Номенклатура)=Тип("СправочникСсылка.Номенклатура") Тогда
			Если ВыборкаКомплектацияАвтомобилей.СтатусПартии=Перечисления.СтатусыПартий.ТоварПринятыйКомиссия Тогда
				НоваяЗапись = НаборЗаписейРеализованныеТовары.Добавить();
				НоваяЗапись.ВидДвижения                = ВидДвиженияНакопления.Приход;
				НоваяЗапись.Период                     = ШапкаДокумента.Дата;
				НоваяЗапись.Регистратор                = ШапкаДокумента.Ссылка;
				НоваяЗапись.Контрагент                 = ШапкаДокумента.Контрагент;
				НоваяЗапись.ДоговорВзаиморасчетов      = ШапкаДокумента.ДоговорВзаиморасчетов;
				НоваяЗапись.Автомобиль                 = ВыборкаКомплектацияАвтомобилей.Автомобиль;
				НоваяЗапись.Номенклатура               = ВыборкаКомплектацияАвтомобилей.Номенклатура;
				НоваяЗапись.ХарактеристикаНоменклатуры = ВыборкаКомплектацияАвтомобилей.ХарактеристикаНоменклатуры;
				НоваяЗапись.ДокументПередачи           = ВыборкаКомплектацияАвтомобилей.Партия;
				НоваяЗапись.ГТД                        = ВыборкаКомплектацияАвтомобилей.ГТД;
				НоваяЗапись.Количество                 = -ВыборкаКомплектацияАвтомобилей.Количество;
				НоваяЗапись.СуммаУпр                   = -ВыборкаКомплектацияАвтомобилей.СуммаУпр;
				НоваяЗапись.СуммаРегл                  = -ВыборкаКомплектацияАвтомобилей.Сумма;
				НоваяЗапись.СуммаБезНДС                = -(НоваяЗапись.СуммаРегл - НоваяЗапись.СуммаНДС);
				НоваяЗапись.СуммаПродажиРегл           = -ВыборкаКомплектацияАвтомобилей.СуммаПродажи;
				НоваяЗапись.СуммаПродажи               = -ВыборкаКомплектацияАвтомобилей.СуммаПродажиУпр;
				// Себестоимость равна продаже.
				Если НЕ НоваяЗапись.ДоговорВзаиморасчетов.КомиссияОтчетНаОснованииПродаж Тогда
					НоваяЗапись.СуммаРегл      = НоваяЗапись.СуммаПродажиРегл;
					НоваяЗапись.СуммаУпр       = НоваяЗапись.СуммаПродажи;
				КонецЕсли;
				НоваяЗапись.ХозОперация                = ШапкаДокумента.ХозОперация;
			КонецЕсли;
			НоваяЗапись = НаборЗаписейПродажи.Добавить();
			НоваяЗапись.Период                     = ШапкаДокумента.Дата;
			НоваяЗапись.Регистратор                = ШапкаДокумента.Ссылка;
			НоваяЗапись.ПодразделениеКомпании      = ШапкаДокумента.ПодразделениеКомпании;
			НоваяЗапись.Автомобиль                 = ВыборкаКомплектацияАвтомобилей.Автомобиль;
			НоваяЗапись.Номенклатура               = ВыборкаКомплектацияАвтомобилей.Номенклатура;
			НоваяЗапись.ДокументПродажи			   = ШапкаДокумента.Ссылка;
			Попытка
				НоваяЗапись.Поставщик              = ВыборкаКомплектацияАвтомобилей.Партия.Контрагент;
			Исключение
			КонецПопытки;
			НоваяЗапись.Покупатель                 = ШапкаДокумента.Контрагент;
			НоваяЗапись.СтатусПартии               = ВыборкаКомплектацияАвтомобилей.СтатусПартии;
			НоваяЗапись.ХозОперация                = ШапкаДокумента.ХозОперация;
			НоваяЗапись.ДоговорВзаиморасчетов      = ШапкаДокумента.ДоговорВзаиморасчетов;
			НоваяЗапись.ХарактеристикаНоменклатуры = ВыборкаКомплектацияАвтомобилей.ХарактеристикаНоменклатуры;
			НоваяЗапись.СкладКомпании              = ШапкаДокумента.СкладКомпании;
			НайденныеСтроки = ТаблицаДокумента.НайтиСтроки(Новый Структура("Автомобиль", ВыборкаКомплектацияАвтомобилей.Автомобиль));
			Если НайденныеСтроки.Количество() > 0 Тогда
				НоваяЗапись.СтавкаНДС              = НайденныеСтроки[0].СтавкаНДС;
			КонецЕсли; 
			НоваяЗапись.Партия                     = ВыборкаКомплектацияАвтомобилей.Партия;
			НоваяЗапись.ГТД                        = ВыборкаКомплектацияАвтомобилей.ГТД;
			НоваяЗапись.Количество                 = -ВыборкаКомплектацияАвтомобилей.Количество;
			НоваяЗапись.Сумма                      = -ВыборкаКомплектацияАвтомобилей.СуммаПродажи;
			НоваяЗапись.СуммаНДС                   = Окр(НоваяЗапись.Сумма*НоваяЗапись.СтавкаНДС.Ставка/100, 2);
			НоваяЗапись.СуммаУпр                   = -ВыборкаКомплектацияАвтомобилей.СуммаПродажиУпр;
			НоваяЗапись.СебестоимостьУпр           = -ВыборкаКомплектацияАвтомобилей.СуммаУпр;
			НоваяЗапись.Себестоимость              = Окр(обПересчет(-ВыборкаКомплектацияАвтомобилей.СуммаУпр,ВалютаУпр,КурсУпр,ВалютаРегл,КурсРегл),2);
			НоваяЗапись.СуммаНДСВходящий           = -ВыборкаКомплектацияАвтомобилей.СуммаНДС;
			СуммаПродажи = СуммаПродажи + НоваяЗапись.Сумма;
		КонецЕсли;
	КонецЦикла; 
	
	Если СуммаПродажи <> 0 И (Сделка.ХозОперация = Справочники.ХозОперации.ПоступлениеАвтомобилей ИЛИ
		Сделка.ХозОперация = Справочники.ХозОперации.ПереходВСобственностьАвтомобилей) Тогда
		
		НаборЗаписейВзаиморасчеты                       = Движения.ВзаиморасчетыКомпании;
		НаборЗаписейВзаиморасчеты.ДокументОбъект        = ЭтотОбъект;
		НаборЗаписейВзаиморасчеты.РежимПроведения       = Режим;
		НаборЗаписейВзаиморасчеты.Контрагент            = Контрагент;
		НаборЗаписейВзаиморасчеты.ДоговорВзаиморасчетов = ДоговорВзаиморасчетов;
		НаборЗаписейВзаиморасчеты.Сделка                = Сделка;
		НаборЗаписейВзаиморасчеты.Валюта                = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
		НаборЗаписейВзаиморасчеты.ВзаиморасчетыСПокупателем        = Истина;
		НаборЗаписейВзаиморасчеты.Сумма                            = -СуммаПродажи;
		НаборЗаписейВзаиморасчеты.СуммаДоходаРасходаСуммовыхРазниц = 0;
		Отказ = НЕ НаборЗаписейВзаиморасчеты.Расход() ИЛИ Отказ;
		
		// доходы и расходы по суммовым разницам
		СуммаДоходаРасходаСуммовыхРазниц = НаборЗаписейВзаиморасчеты.СуммаДоходаРасходаСуммовыхРазниц;
		Если СуммаДоходаРасходаСуммовыхРазниц <> 0 Тогда
			НаборЗаписейДиР                        = Движения.ДоходыИРасходы;
			НаборЗаписейДиР.ДокументОбъект         = ЭтотОбъект;
			НаборЗаписейДиР.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СуммовыеРазницы;
			НаборЗаписейДиР.ВУпрВалюте             = Истина;
			Если СуммаДоходаРасходаСуммовыхРазниц<0 Тогда
				НаборЗаписейДиР.Расход = -СуммаДоходаРасходаСуммовыхРазниц;
			Иначе
				НаборЗаписейДиР.Доход = СуммаДоходаРасходаСуммовыхРазниц;
			КонецЕсли;
			
			Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат НЕ Отказ;
КонецФункции

// Расчет суммы документа
Функция РассчитатьСуммуВсего()Экспорт
	ВремСуммаДокумента=Автомобили.Итог("СуммаВсего");
	Если СуммаДокумента<>ВремСуммаДокумента Тогда
		СуммаДокумента=ВремСуммаДокумента;
	КонецЕсли;
	Возврат СуммаДокумента;
КонецФункции

/// Обработка изменения реквизитов документа
// Параметры
//  Имя			– Строка			– Имя реквизита документа с полным путем (например Товары.Номенклатура).
//  ЭтаФорма	– Форма				– Ссылка на форму документа.
//	Если значение неопределено, производится программная обработка реквизитов.
//  ТекСтрока	– СтрокаТабличнойЧасти – Ссылка на строку табличной части документа, реквизит которой обрабатывается.
//										 Имеет смысл только для табличных частей документов.
//  ДопПараметры– Структура			– Структура, содержащая дополнительные параметры обработки реквизита.
// Возвращаемое значение:
//   Булево   – Результат выполнения обработки.
Функция ОбработкаРеквизита(Имя,ТекСтрока=Неопределено,ЭтаФорма=Неопределено,ДопПараметры=Неопределено) Экспорт
	Если ДопПараметры=Неопределено Тогда
		ДопПараметры=Новый Структура;
	КонецЕсли;
	Если ТипЗнч(ДопПараметры)=Тип("Структура") Тогда
		ДопПараметры.Вставить("НеРассчитыватьСкидки",Истина);
	КонецЕсли; 
	
	// ОБРАБОТКА РЕКВИЗИТОВ ДОКУМЕНТА
	Если Имя="ДокументОснование" Тогда
		Если ДокументОснование <> Неопределено Тогда
			Если ДокументОснование = Ссылка Тогда
				ДокументОснование = Неопределено;
				ОбработкаРеквизита("ДокументОснование");
				Сообщить("Ввод корректировки поступления автомобилей на основании самой себя запрещен.",СтатусСообщения.Внимание);
				Возврат Истина;
			КонецЕсли;
			
			Если НЕ ДокументОснование.Проведен Тогда
				Сообщить("Ввод корректировки поступления автомобилей возможен только на основании проведенного документа.",СтатусСообщения.Внимание);
				ДокументОснование=Неопределено;
				ОбработкаРеквизита("ДокументОснование");
				Возврат Истина;
			КонецЕсли;
			
			Запрос = Новый Запрос;
			Запрос.Текст =
			"ВЫБРАТЬ
			|	КорректировкаПоступленияАвтомобилей.Ссылка
			|ИЗ
			|	Документ.КорректировкаПоступленияАвтомобилей КАК КорректировкаПоступленияАвтомобилей
			|ГДЕ
			|	КорректировкаПоступленияАвтомобилей.ДокументОснование = &ДокументОснование
			|	И КорректировкаПоступленияАвтомобилей.Ссылка <> &Ссылка";
			Запрос.УстановитьПараметр("ДокументОснование", ДокументОснование);
			Запрос.УстановитьПараметр("Ссылка", Ссылка);
			РезЗапроса = Запрос.Выполнить();
			Если НЕ РезЗапроса.Пустой() Тогда
				Выборка = РезЗапроса.Выбрать();
				Выборка.Следующий();
				#Если Клиент Тогда
					Предупреждение("На основании документа " + ДокументОснование + " уже введен" + Выборка.Ссылка);
				#КонецЕсли
				ДокументОснование = Неопределено;
				ОбработкаРеквизита("ДокументОснование");
				Возврат Истина;
			КонецЕсли;
		КонецЕсли;
		
		#Если Клиент Тогда
			Если ЭтаФорма<>Неопределено Тогда 
				Если Вопрос("Заполнить по документу-основания?",РежимДиалогаВопрос.ДаНет)=КодВозвратаДиалога.Да Тогда
					ЭтотОбъект.Заполнить(ДокументОснование);
					ЭтаФорма.УправлениеДиалогом();
					дкВывестиЗаголовокСуммаДокумента(ЭтаФорма);
				КонецЕсли;
			КонецЕсли; 
		#КонецЕсли
		Возврат Ложь;
		
	// ОБРАБОТКА РЕКВИЗИТОВ ТАБЛИЧНОЙ ЧАСТИ "Автомобили"
	ИначеЕсли Имя = "Автомобили.Автомобиль" Тогда
		// подставим VIN
		ТекСтрока.VIN = ТекСтрока.Автомобиль.VIN;
		Если НЕ ЗначениеЗаполнено(ТекСтрока.СтавкаНДС) Тогда
			ТекСтрока.СтавкаНДС = Справочники.СтавкиНДС.ОсновнаяСтавкаНДС;
		КонецЕсли;
		Возврат Истина;
	ИначеЕсли Имя = "Автомобили.Количество" Тогда
		Если ТекСтрока.Количество > 1 Тогда
			Сообщить("Поступление двух и болле автомобилей с одинаковыми VIN номерами невозможно.",СтатусСообщения.Внимание);
			ТекСтрока.Количество = 1;
			Возврат Ложь;
		КонецЕсли;	
		ОбработкаРеквизита("Автомобили.Сумма", ТекСтрока, ЭтаФорма);
	ИначеЕсли Имя = "Автомобили.Цена" Тогда
		ТекСтрока.Сумма = ТекСтрока.Цена;
		ОбработкаРеквизита("Автомобили.Сумма", ТекСтрока, ЭтаФорма);
		Возврат Истина;
	ИначеЕсли Имя = "Автомобили.Сумма" Тогда
		Если ТекСтрока.Количество = 0 Тогда
			ТекСтрока.Сумма = 0;
		КонецЕсли;
		
		ТекСтрока.Цена = ТекСтрока.Сумма;
		
		// расчитаем сумму всего
		Если ?(ЗначениеЗаполнено(ТипЦен),ТипЦен.ЦенаВключаетНДС,Истина) Тогда
			ТекСтрока.СуммаВсего = ТекСтрока.Сумма;
			ТекСтрока.СуммаНДС = ТекСтрока.СуммаВсего - (100*ТекСтрока.СуммаВсего)/(100+ТекСтрока.СтавкаНДС.Ставка);
		Иначе
			ТекСтрока.СуммаНДС=(ТекСтрока.Сумма*ТекСтрока.СтавкаНДС.Ставка)/100;
			ТекСтрока.СуммаВсего=ТекСтрока.Сумма+ТекСтрока.СуммаНДС;
		КонецЕсли;
		Возврат Истина;
	ИначеЕсли Имя = "Автомобили.СуммаВсего" Тогда
		Если ТекСтрока.Количество = 0 Тогда
			ТекСтрока.СуммаВсего = 0;
		КонецЕсли;
		//Получим новую сумму НДС как процент от суммы всего
		Если ?(ЗначениеЗаполнено(ТипЦен),ТипЦен.ЦенаВключаетНДС,Истина)Тогда
			//Цена уже содержит НДС
			ТекСтрока.Сумма    = ТекСтрока.СуммаВсего;
			ТекСтрока.СуммаНДС = ТекСтрока.СуммаВсего - (100*ТекСтрока.СуммаВсего)/(100+ТекСтрока.СтавкаНДС.Ставка);
		Иначе
			//НДС в цену не включен
			ТекСтрока.Сумма    = (100*ТекСтрока.СуммаВсего)/(100+ТекСтрока.СтавкаНДС.Ставка);
			ТекСтрока.СуммаНДС = ТекСтрока.СуммаВсего - ТекСтрока.Сумма;
		КонецЕсли; 
		
		ТекСтрока.Цена = ТекСтрока.Сумма;
		Возврат Истина;
	ИначеЕсли Имя="Автомобили.СтавкаНДС" Тогда
		Возврат ОбработкаРеквизита("Автомобили.Сумма",ТекСтрока,ЭтаФорма,ДопПараметры);
		
	ИначеЕсли Имя="Автомобили.СуммаНДС" Тогда
		Возврат Истина;
	ИначеЕсли Имя="РассчитатьРазницу" Тогда
		ТекСтрока.СуммаРазница      = ТекСтрока.Сумма - ТекСтрока.СуммаПоДокументуПоступления ;
		ТекСтрока.СуммаНДСРазница   = ТекСтрока.СуммаНДС - ТекСтрока.СуммаНДСПоДокументуПоступления;
		ТекСтрока.СуммаВсегоРазница = ТекСтрока.СуммаВсего - ТекСтрока.СуммаВсегоПоДокументуПоступления;
		ТекСтрока.КоличествоРазница = ТекСтрока.Количество - ТекСтрока.КоличествоПоДокументуПоступления;
	Иначе Возврат дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры);
	КонецЕсли;
КонецФункции // ОбработкаРеквизита()

// Заполнение свойств из документа основания
Процедура ЗаполнитьСвойстваНаОсновании(Основание) Экспорт
	//Зарезервировано для описания заполнения свойств из свойств основания
КонецПроцедуры

//////////////////////////////////////////////////////////////////////////////////
//// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ДОПОЛНИТЕЛЬНЫХ МЕТОДОВ ОБЪЕКТА

// Возвращает соответствие в котором перечислены виды номенклатуры, которые нельзя вводить
// в таблицу товаров. Если таких нет, то возвращает неопределено
Функция ПолучитьСоответствиеЗапрещенныхВидовНоменклатуры() Экспорт
	Результат=Неопределено;
	Результат=Новый Соответствие();
	Возврат Результат;
КонецФункции

// Возвращает структуру обязательных / уникальных реквизитов документа
// Возвращаемая структура содержит строковые идентификаторы реквизитов или вложенные структуры для табличных частей
// Для реквизита значение структуры содержит число 1-Обязательный, 2-Уникальный, 3-Уникальный и обязательный
Функция ПолучитьОбязательныеРеквизиты() Экспорт
	// Обязательные реквизиты документа
	ОбязательныеРеквизиты=Новый Структура();
	ОбязательныеРеквизиты.Вставить("Организация",1);
	ОбязательныеРеквизиты.Вставить("ПодразделениеКомпании",1);
	ОбязательныеРеквизиты.Вставить("Автор",1);
	ОбязательныеРеквизиты.Вставить("ДокументОснование",1);
	ОбязательныеРеквизиты.Вставить("ТипЦен",1);
	ОбязательныеРеквизиты.Вставить("ХозОперация",1);
	ОбязательныеРеквизиты.Вставить("ВалютаДокумента",1);
	ОбязательныеРеквизиты.Вставить("КурсДокумента",1);
	ОбязательныеРеквизиты.Вставить("Контрагент",1);
	ОбязательныеРеквизиты.Вставить("ДоговорВзаиморасчетов",1);
	ОбязательныеРеквизиты.Вставить("СкладКомпании",1);
	
	// Обязательные поля таблицы товаров
	ОбязательныеАвтомобили=Новый Структура();
	ОбязательныеАвтомобили.Вставить("Автомобиль",3);
	ОбязательныеАвтомобили.Вставить("ГТД",2);
	ОбязательныеРеквизиты.Вставить("Автомобили",ОбязательныеАвтомобили); 
		
	Возврат ОбязательныеРеквизиты;
КонецФункции

// Проверяет корректность заполнения объекта.
// Возвращает Истина если все заполнено корректно и Ложь иначе.
// В случае некорректного заполнения формирует строку описанием возникших ошибок "Ошибки"
// На вход может быть передана структура ДопРеквизиты с дополнительными реквизитами для проверки
// может управляться булевыми флагами выполняемых проверок Заполнение, Уникальность
// (могут быть и другие необязательные)
// Обычно выполняется универсальным обработчиком, но могут быть добавлены доп. проверки
Функция ПроверитьКорректность(Ошибки="", ДопРеквизиты=Неопределено, Заполнение=Истина, Уникальность=Истина) Экспорт
	// Здесь могут быть определены дополнительные к стандартным обязательным реквизитам условия проверки
	Результат = дкПроверитьКорректность(ЭтотОбъект, Ошибки, ДопРеквизиты, Заполнение, Уникальность);
	
	// Проведем проверку соответствия организации документа организациям некоторых реквизитов документа.
	// Такую проверку необходимо осуществлять, если баланс в системе ведется по организации, 
	// или если установлен способ контроля корректности договора и склада документа. 
	// Причем, если способ контроля выбран "Контроль по организации и подразделению", то
	// дополнительно осуществляется проверка соответствия подразделений.
	Если Результат Тогда
		СпособКонтроляКорректности = обПраво("КонтрольКорректностиДоговораИСкладаДокумента", Права,,ЭтотОбъект);
		КонтрольОтсутствует        = (СпособКонтроляКорректности=Перечисления.СпособКонтроляКорректностиДоговораИСкладаДокумента.КонтрольОтсутствует);
		БалансВедетсяПоОрганизации = (Константы.СпособВеденияБаланса.Получить()=Перечисления.СпособВеденияБаланса.ПоОрганизации);

		Если БалансВедетсяПоОрганизации Или Не КонтрольОтсутствует Тогда
			КонтрольПоПодразделению = (СпособКонтроляКорректности=Перечисления.СпособКонтроляКорректностиДоговораИСкладаДокумента.КонтрольПоОрганизацииИПодразделению);
			
			КонтролируемыеРеквизиты = Новый Структура();
			
			КонтролируемыеРеквизитыШапки = Новый Структура();
			КонтролируемыеРеквизитыШапки.Вставить("ДоговорВзаиморасчетов",КонтрольПоПодразделению);
			КонтролируемыеРеквизиты.Вставить("КонтролируемыеРеквизитыШапки",КонтролируемыеРеквизитыШапки);
		
			Результат = дкПроверитьКорректностьПоОрганизации(ЭтотОбъект,КонтролируемыеРеквизиты,Ошибки) и Результат;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
КонецФункции
 
// Функция проверяет, допустимо ли изменение объекта
// Возвращает Истина, если изменения возможны, ложь иначе
// Если изменения доступны частично, возвращает ложь и структуру блокируемых на изменение реквизитов,
Функция ДоступностьИзменения(БлокироватьРеквизиты=Неопределено) Экспорт
	// Здесь может быть прописано определение наличия ссылок, блокирующих изменение объекта
	Возврат Истина;
КонецФункции

// Возвращает список возможных хозяйственных операций документа
// Возвращаемое значение: СписокЗначений. 
// Строка списка: Значение - имя предопределенного элемента; 
//				  Представление - красивое его представление
// 				  "Помеченная" строка - ХО по умолчанию.
Функция ПолучитьСписокХозОпераций() Экспорт
	СписокХозОпераций = Новый СписокЗначений;
	СписокХозОпераций.Добавить("КорректировкаПоступленияАвтомобилейИсправлениеВПервичныхДокументах","Исправление в первичных документах",Истина);
	СписокХозОпераций.Добавить("КорректировкаПоступленияАвтомобилейКорректировкаПоСогласованиюСторон","Корректировка по согласованию сторон",Ложь);
	Возврат СписокХозОпераций;
КонецФункции

// Получение данных о прослеживаемых товаров
//
// Параметры:
//  Объект	 - ДокументОбъект.КорректировкаПоступленияАвтомобилей - Документ, на основании которого произошла операция с товаром
// 
// Возвращаемое значение:
//  ТаблицаЗначений - Список прослеживаемых товаров
//
Функция ОперацииСПрослеживаемымиТоварами() Экспорт
	
	// TODO: На данный момент сделано только для формирования отчета об операциях
	
	// Получим таблицу для формирования данных по операции
	ТаблицаОперацииПрослеживаемости = ПрослеживаемостьТоваровСервер.ИнициализацияТаблицыОпераций();
	
	// Для контрагентов из ЕАЭС другая форма отчетности
	Если ПрослеживаемостьТоваровСервер.СтранаУчастникЕАЭС(Контрагент.СтранаРегистрации) Тогда
		Возврат ТаблицаОперацииПрослеживаемости;
	КонецЕсли;
	
	ОсвобождентОтНДС = ПодразделениеКомпании.ОсвобожденОтНДС ИЛИ Организация.ОсвобожденОтНДС;
	
	// Проверим есть ли ставка НДС в документе
	ТаблицаНДС = Автомобили.Выгрузить();
	ТаблицаНДС.Свернуть("СтавкаНДС");
	ЕстьНДС = НЕ (ТаблицаНДС.Количество() = 1 И ТаблицаНДС[0].СтавкаНДС = Справочники.СтавкиНДС.БезНДС);
	
	// Операцию об отчете не выводим если есть ставка НДС в документе и организация плательщик НДС
	Если ЕстьНДС И НЕ ОсвобождентОтНДС Тогда
		Возврат ТаблицаОперацииПрослеживаемости;
	КонецЕсли;
	
	Если ХозОперация = Справочники.ХозОперации.КорректировкаПоступленияАвтомобилейИсправлениеВПервичныхДокументах Тогда
		ТекстЗапроса =
		"ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ДокументыОтображенияОпераций.ОтчетОбОперациях) КАК ОтчетностьОперации,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыДокументов.УПД) КАК ВидДокумента,
		|	ЗНАЧЕНИЕ(Справочник.КодыОперацийПрослеживаемости.ПоступлениеТоваров) КАК КодОперации,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.Автомобиль КАК Номенклатура,
		|	СУММА(КорректировкаПоступленияАвтомобилейАвтомобили.Количество) КАК КоличествоПрослеживаемости,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.ГТД КАК РНПТ,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДС КАК СтавкаНДС,
		|	СУММА(КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсего - КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДС) КАК СуммаБезНДС
		|ИЗ
		|	Документ.КорректировкаПоступленияАвтомобилей.Автомобили КАК КорректировкаПоступленияАвтомобилейАвтомобили
		|ГДЕ
		|	КорректировкаПоступленияАвтомобилейАвтомобили.Ссылка = &Ссылка
		|	И КорректировкаПоступленияАвтомобилейАвтомобили.ГТД.РНПТ
		|
		|СГРУППИРОВАТЬ ПО
		|	КорректировкаПоступленияАвтомобилейАвтомобили.Автомобиль,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.ГТД,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДС";
		Документ = Сделка;
		Если ЗначениеЗаполнено(Документ) Тогда
			ПериодОтчета = НачалоКвартала(Документ.Дата);
			НомерДокумента = Документ.ВхДокНомер;
			ДатаДокумента = Документ.ВхДокДата;
			КонтрагентОперации = Документ.Контрагент;
		Иначе
			ПериодОтчета = НачалоКвартала(Дата);
			КонтрагентОперации = Контрагент;
		КонецЕсли;
		
	Иначе
		ТекстЗапроса =
		"ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ДокументыОтображенияОпераций.ОтчетОбОперациях) КАК ОтчетностьОперации,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыДокументов.УКД) КАК ВидДокумента,
		|	ВЫБОР
		|		КОГДА КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоРазница > 0
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.КодыОперацийПрослеживаемости.ПолученнаяКорректировочнаяСчетФактураУвеличение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КодыОперацийПрослеживаемости.ПолученнаяКорректировочнаяСчетФактураУменьшение)
		|	КОНЕЦ КАК КодОперации,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.Автомобиль КАК Номенклатура,
		|	СУММА(КорректировкаПоступленияАвтомобилейАвтомобили.КоличествоРазница * ВЫБОР
		|			КОГДА КорректировкаПоступленияАвтомобилейАвтомобили.КоличествоРазница < 0
		|				ТОГДА -1
		|			ИНАЧЕ 1
		|		КОНЕЦ) КАК КоличествоПрослеживаемости,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.ГТД КАК РНПТ,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДС КАК СтавкаНДС,
		|	СУММА(КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоРазница * ВЫБОР
		|			КОГДА КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоРазница < 0
		|				ТОГДА -1
		|			ИНАЧЕ 1
		|		КОНЕЦ - КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДСРазница * ВЫБОР
		|			КОГДА КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДСРазница < 0
		|				ТОГДА -1
		|			ИНАЧЕ 1
		|		КОНЕЦ) КАК СуммаБезНДС
		|ИЗ
		|	Документ.КорректировкаПоступленияАвтомобилей.Автомобили КАК КорректировкаПоступленияАвтомобилейАвтомобили
		|ГДЕ
		|	КорректировкаПоступленияАвтомобилейАвтомобили.Ссылка = &Ссылка
		|	И КорректировкаПоступленияАвтомобилейАвтомобили.ГТД.РНПТ
		|	И КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоРазница <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоРазница > 0
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.КодыОперацийПрослеживаемости.ПолученнаяКорректировочнаяСчетФактураУвеличение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КодыОперацийПрослеживаемости.ПолученнаяКорректировочнаяСчетФактураУменьшение)
		|	КОНЕЦ,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.Автомобиль,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.ГТД,
		|	КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДС";
		Документ = Ссылка;
		ПериодОтчета = НачалоКвартала(Дата);
		НомерДокумента = ВхДокНомер;
		ДатаДокумента = ВхДокДата;
		КонтрагентОперации = Контрагент;
	КонецЕсли;
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	РезультатЗапроса = Запрос.Выполнить();
	
	// Проверим, что в документе есть РНПТ
	Если РезультатЗапроса.Пустой() Тогда
		Возврат ТаблицаОперацииПрослеживаемости;
	КонецЕсли;
	
	ТаблицаРНПТ = Запрос.Выполнить().Выгрузить();
	
	// Для пересчета валюты в рубли
	ВалютаРегл = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	ВалютаНеРегл = (ВалютаДокумента <> ВалютаРегл);
	
	// Сформируем таблицу
	Для Каждого ТекущаяСтрока Из ТаблицаРНПТ Цикл
		
		НоваяСтрока = ТаблицаОперацииПрослеживаемости.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекущаяСтрока);
		НоваяСтрока.Организация = Организация;
		НоваяСтрока.ПериодОтчета = ПериодОтчета;
		НоваяСтрока.Документ = Документ;
		НоваяСтрока.НомерДокумента = НомерДокумента;
		НоваяСтрока.ДатаДокумента = ДатаДокумента;
		НоваяСтрока.Контрагент = КонтрагентОперации;
		
		Если ВалютаНеРегл Тогда
			НоваяСтрока.СуммаБезНДС = Окр(обПересчет(НоваяСтрока.СуммаБезНДС,ВалютаДокумента,КурсДокумента,ВалютаРегл,Дата), 2);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат ТаблицаОперацииПрослеживаемости;
	
КонецФункции

#Если Клиент Тогда

//////////////////////////////////////////////////////////////////////////////////
//// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ПЕЧАТИ ДОКУМЕНТА


// Процедура осуществляет печать документа. Можно направить печать на 
// экран или принтер, а также распечатать необходимое количество копий.
// Параметры: НазваниеМакета - строка, название макета, если пусто - то по умолчанию,
//   Документ - сюда можно передать уже созданный табличный документ для заполнения
Функция Печать(НазваниеПечатнойФормы="", КоличествоЭкземпляров=0, НаПринтер=Ложь, Документ=Неопределено) Экспорт
	// Вызов конкретно печатной формы и печать результата прописано в общем модуле
	// здесь могут быть вставлены дополнительные механизмы
	Возврат дкПечать(ЭтотОбъект, НазваниеПечатнойФормы, КоличествоЭкземпляров, НаПринтер, Документ);
КонецФункции

// Формирует печатную форму "ПоступлениеАвтомобилей"
// Возвращает сформированный табличный документ:
Функция ПечатьПоступлениеАвтомобилей(ТабДокумент) Экспорт
	Макет = ПолучитьМакет("ПоступлениеАвтомобилей");
	
	//для начала настроим макет
	ОбластьШапкаТаблицы = орПривестиМакетПечатнойФормы(ЭтотОбъект,Макет);
	ФорматВыводаСуммы = обПраво("ФорматВыводаСуммы",Права,,ЭтотОбъект);
	
	//вывод заголовка документа
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
	
	ТекстЗаголовка = "Приходная накладная (автомобили) № " + дкПолучитьНомерДляПечати(ЭтотОбъект)
		+ " от " + Формат(Дата, "ДФ = dd.MM.yyyy");
	
	ОбластьМакета.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	ОбластьМакета.Параметры.ПредставлениеПоставщика = спПолучитьПредставление(Контрагент);
	ДополнительныеПараметры = спСоздатьПараметрыПолученияПредставления();
	ДополнительныеПараметры.Вставить("ИспользоватьКПППодразделения");
	ДополнительныеПараметры.Вставить("ПодразделениеКомпании", ПодразделениеКомпании);
	ОбластьМакета.Параметры.ПредставлениеПокупателя	= спПолучитьПредставление(Организация, , ДополнительныеПараметры);
	ОбластьМакета.Параметры.ПредставлениеСклада		= спПолучитьНаименование(СкладКомпании);
	
	//вывод свойств
	СтрокаСвойств = дкПолучитьСтрокуСвойствДокумента(ЭтотОбъект);
	ОбластьМакета.Параметры.СтрокаСвойств = СтрокаСвойств;
	ТабДокумент.Вывести(ОбластьМакета);
	
	//сразу два, т.к. выводим на второй странице только
	НомерСтраницы = 2;
	НомерСтраницыПред = НомерСтраницы;
	
	//теперь выводим шапку
	ТабДокумент.Вывести(ОбластьШапкаТаблицы);
	
	//готовим области строки
	ОбластьМакета = Макет.ПолучитьОбласть("Строка");
	
	ОбластьМакетаИтогоПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице");
	СтруктураИтоговПоСтранице = Новый Структура("ВалютаДокумента,СуммаНДС,СуммаВсего",ВалютаДокумента,0,0,0);
	
	//заполним параметры шапки таблицы для следующего листа
	ОбластьШапкаТаблицы.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы;
	
	//перебор строк
	ВыборкаТабличнойЧасти = ЭтотОбъект.Автомобили.Выгрузить();
	Для каждого СтрокаТабличнойЧасти Из ВыборкаТабличнойЧасти Цикл
		//заполняем данные строки
		СтруктураСтроки = орПолучитьПредставлениеДанныхТоварнойСтроки(СтрокаТабличнойЧасти,ЭтотОбъект);
		ОбластьМакета.Параметры.Заполнить(СтруктураСтроки);
		
		//выводим строку, делая проверку попадания на лист
		НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьМакета, ОбластьШапкаТаблицы, ОбластьМакетаИтогоПоСтранице, НомерСтраницы, СтруктураИтоговПоСтранице,ЭтотОбъект);
		
		//инициализация итогов по странице
		Если НомерСтраницы <> НомерСтраницыПред Тогда
			СтруктураИтоговПоСтранице = Новый Структура("ВалютаДокумента,СуммаНДС,СуммаВсего",ВалютаДокумента,0,0);
			НомерСтраницыПред = НомерСтраницы;
			ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
		КонецЕсли;
		//добавляем итоги
		дкДобавитьИтогиПоСтранице(СтрокаТабличнойЧасти,СтруктураИтоговПоСтранице);
		
	КонецЦикла;
	
	//довыводим последний подвал, если страниц больше единицы
	Если НомерСтраницы > 2 Тогда
		дкВывестиИтогиПоСтранице(ТабДокумент,ОбластьМакетаИтогоПоСтранице,СтруктураИтоговПоСтранице,ЭтотОбъект);
	КонецЕсли;
	
	//итоги
	ОбластьМакета = Макет.ПолучитьОбласть("Подвал");
	ОбластьМакета.Параметры.ВалютаДокумента = ВалютаДокумента;
	СуммаВсего = ВыборкаТабличнойЧасти.Итог("СуммаВсего");
	ОбластьМакета.Параметры.СуммаВсего = Формат(СуммаВсего,ФорматВыводаСуммы);
	НДСВсего = ВыборкаТабличнойЧасти.Итог("СуммаНДС");
	ОбластьМакета.Параметры.НДСВсего = Формат(НДСВсего,ФорматВыводаСуммы);
	ОбластьМакета.Параметры.СуммаПрописью = "Всего наименований "+ВыборкаТабличнойЧасти.Количество()+" на сумму " + обЧислоПрописью(СуммаВсего,ЭтотОбъект.ВалютаДокумента);
	
	// Выводим представления и расшифровки подписей
	Отпустил = дкОтветственноеЛицо(ЭтотОбъект,"Отпустил");
	Отпустил.ОтпустилПредставление = ?(обЗначениеНеЗаполнено(Отпустил.Отпустил),"","/ "+ Отпустил.ОтпустилПредставление);
	ОбластьМакета.Параметры.Заполнить(Отпустил);
	Получил  = дкОтветственноеЛицо(ЭтотОбъект,"Получил");
	Получил.ПолучилПредставление = ?(обЗначениеНеЗаполнено(Получил.Получил),"","/ "+ Получил.ПолучилПредставление);
	ОбластьМакета.Параметры.Заполнить(Получил);
	
	НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьМакета, , , НомерСтраницы,,ЭтотОбъект);
	
	Возврат ТабДокумент;
КонецФункции

// Формирует печатную форму "УКД"
// Возвращает сформированный табличный документ:
Функция ПечатьУКД(ТабДокумент) Экспорт
	
	ТабДокумент = дкПечатьУКД(ЭтотОбъект, ТабДокумент);
	
	Возврат ТабДокумент;
КонецФункции // ПечатьУКД

// Функция получения данных для УКД.
//
Функция ПолучитьДанныеДляПечатиУКД() Экспорт
	
	ДокументФактура = Документы.СчетФактураПолученный.НайтиПоРеквизиту("ДокументОснование", ЭтотОбъект.Ссылка);
	ДокументОбъект = ДокументФактура;
	ДанныеОбъекта = Новый Структура();
	
	// Сформируем статус документа
	Если ДокументФактура <> Документы.СчетФактураПолученный.ПустаяСсылка() И НЕ ДокументФактура.ПометкаУдаления Тогда
		Статус = 1;
		ДокументОбъект = ДокументФактура;
	Иначе
		Статус = 2;
		ДокументОбъект = ЭтотОбъект;
	КонецЕсли;
	
	Если Дата > Дата('20210701') Тогда
		ТаблицаТоваров = Документы.СчетФактураПолученный.ТоварыДляПечатиУКД(ЭтотОбъект.Ссылка);
	Иначе

	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КорректировкаПоступленияАвтомобилейАвтомобили.Автомобиль КАК Номенклатура,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.Цена КАК Цена,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.Сумма КАК Сумма,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаРазница КАК СуммаРазница,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДС КАК СтавкаНДС,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДС КАК СуммаНДС,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДСРазница КАК СуммаНДСРазница,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсего КАК СуммаВсего,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоРазница КАК СуммаВсегоРазница,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.Количество КАК Количество,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.КоличествоРазница КАК КоличествоРазница,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДСПоДокументуПоступления КАК СуммаНДСПоДокументуПоступления,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоПоДокументуПоступления КАК СуммаВсегоПоДокументуПоступления,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.ГТД КАК ГТД,
	|	КорректировкаПоступленияАвтомобилейАвтомобили.ГТДДоКорректировки КАК ГТДДоКорректировки
	|ИЗ
	|	Документ.КорректировкаПоступленияАвтомобилей.Автомобили КАК КорректировкаПоступленияАвтомобилейАвтомобили
	|ГДЕ
	|	КорректировкаПоступленияАвтомобилейАвтомобили.Ссылка = &Ссылка
	|	И (КорректировкаПоступленияАвтомобилейАвтомобили.Сумма <> КорректировкаПоступленияАвтомобилейАвтомобили.СуммаПоДокументуПоступления
	|			ИЛИ КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДС <> КорректировкаПоступленияАвтомобилейАвтомобили.СтавкаНДСПоДокументуПоступления
	|			ИЛИ КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДС <> КорректировкаПоступленияАвтомобилейАвтомобили.СуммаНДСПоДокументуПоступления
	|			ИЛИ КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсего <> КорректировкаПоступленияАвтомобилейАвтомобили.СуммаВсегоПоДокументуПоступления
	|			ИЛИ КорректировкаПоступленияАвтомобилейАвтомобили.ГТД <> КорректировкаПоступленияАвтомобилейАвтомобили.ГТДДоКорректировки)";
	Запрос.УстановитьПараметр("Ссылка", ЭтотОбъект.Ссылка);
	ТаблицаТоваров = Запрос.Выполнить().Выгрузить();
	КонецЕсли;
	
	// данные документа
	ДанныеОбъекта.Вставить("Дата"                   	, ДокументОбъект.Дата);
	ДанныеОбъекта.Вставить("Номер"                  	, дкПолучитьНомерДляПечати(ДокументОбъект));
	ДанныеОбъекта.Вставить("ХозОперация"            	, ДокументОбъект.ХозОперация);
	ДанныеОбъекта.Вставить("ДокументОснование"      	, ДокументОбъект.ДокументОснование);
	ДанныеОбъекта.Вставить("ВалютаДокумента"      		, ЭтотОбъект.ВалютаДокумента);
	ДанныеОбъекта.Вставить("Поставщик"              	, ДокументОбъект.Контрагент);
	ДанныеОбъекта.Вставить("ПодразделениеКомпании"  	, ДокументОбъект.ПодразделениеКомпании);
	ДанныеОбъекта.Вставить("Покупатель"              	, ДокументОбъект.Организация);
	ДанныеОбъекта.Вставить("Организация"              	, ЭтотОбъект.Организация);
	ДанныеОбъекта.Вставить("ДоговорВзаиморасчетов"     	, ?(ЗначениеЗаполнено(ДокументОбъект.ДоговорВзаиморасчетов), ЭтотОбъект.ДоговорВзаиморасчетов, "--"));
	ДанныеОбъекта.Вставить("Товары"              		, ТаблицаТоваров);
	ДанныеОбъекта.Вставить("Статус"              		, Статус);
	ДанныеОбъекта.Вставить("Ссылка"              		, ДокументОбъект.Ссылка);
	ДанныеОбъекта.Вставить("ИдентификаторГосударственногоКонтракта", Неопределено);
	ДанныеОбъекта.Вставить("ДатаОтгрузки", Неопределено);
	
	Если Статус = 1 Тогда
		ДанныеОбъекта.Вставить("НомерИсходногоДокумента",
			?(ЗначениеЗаполнено(ДокументОбъект.НомерИсходногоДокумента),
				дкПолучитьНомерДляПечати(ДокументОбъект,,"НомерИсходногоДокумента"),
				"--"));
		ДанныеОбъекта.Вставить("ДатаИсходногоДокумента",
			?(ЗначениеЗаполнено(ДокументОбъект.ДатаИсходногоДокумента), ДокументОбъект.ДатаИсходногоДокумента, "--"));
		ДанныеОбъекта.Вставить("ПлатежноРасчетныеДокументы" , Неопределено);
	КонецЕсли;
	
	// Свойства
	ДанныеОбъекта.Вставить("Руководитель"     		, дкОтветственноеЛицо(ЭтотОбъект.ДокументОснование, Перечисления.ВидыОбъектовСведений.Руководитель));
	ДанныеОбъекта.Вставить("ГлавныйБухгалтер" 		, дкОтветственноеЛицо(ЭтотОбъект.ДокументОснование, Перечисления.ВидыОбъектовСведений.ГлавныйБухгалтер));
	ДанныеОбъекта.Вставить("Менеджер" 				, дкОтветственноеЛицо(ДокументОбъект, "Менеджер"));
	
	Возврат ДанныеОбъекта;
	
КонецФункции

#КонецЕсли

//// Процедура - обработчик ввода на основании
Процедура ОбработкаЗаполнения(Основание)
	
	Если ЭтоНовый() Тогда
		Контрагент = Неопределено;
		ДоговорВзаиморасчетов = Неопределено;
	КонецЕсли;

	дкОбработкаЗаполнения(ЭтотОбъект, Основание, , Ложь);

	Если НЕ ВозможенВводНаОсновании(Основание) Тогда
		ДополнительныеСвойства.Вставить("ВводНаОснованииЗапрещен", Истина);
		Возврат;
	КонецЕсли;
	
	Если Основание = Неопределено Тогда
		#Если Клиент Тогда
		Сообщить("Ввод корректировки поступления автомобилей возможен только на основании.",СтатусСообщения.Внимание);
		#КонецЕсли
		дкОтменаВводаДокумента(ЭтотОбъект);
		Возврат;
	КонецЕсли;
	
	Сделка = ПолучитьСделку();
	
	Контрагент = Основание.Контрагент;
	ОбработкаРеквизита("Контрагент");
	
	
	// получим список авто из документа
	Автомобили.Загрузить(Основание.Автомобили.Выгрузить());
	
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.КорректировкаПоступленияАвтомобилей") Тогда
		// Удалим из корректировки возвращенные автомобили
		СтруктураПоиска = Новый Структура();
		СтруктураПоиска.Вставить("Количество", 0);
		
		НайденныеСтроки = Автомобили.НайтиСтроки(СтруктураПоиска);
		
		Для Каждого ТекущаяСтрока Из НайденныеСтроки Цикл
			Автомобили.Удалить(ТекущаяСтрока);
		КонецЦикла;
	КонецЕсли;
	
	Основания = ПолучитьСписокОснований();
	ВалютаУпр = Константы.ВалютаУправленческогоУчетаКомпании.Получить();
	ВалютаРег = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	
	// заполняем суммы автомобилей
	Для Каждого Автомобиль Из Автомобили Цикл
		Суммы = ПолучитьСебестоимостьАвтомобиля(Автомобиль.Автомобиль, Основания);
		
		Если ВалютаРег = ВалютаДокумента Тогда
			Автомобиль.СуммаВсего = Суммы.Сумма;
		Иначе
			Автомобиль.СуммаВсего = обПересчет(Суммы.СуммаУпр, ВалютаУпр, КурсВалютыУпр, ВалютаДокумента, КурсДокумента);
		КонецЕсли;
		ОбработкаРеквизита("Автомобили.СуммаВсего", Автомобиль);
		
		Автомобиль.СуммаНДС = обПересчет(Суммы.СуммаНДС, ВалютаРег, Дата, ВалютаДокумента, КурсДокумента);
		
		// заполним доп реквизиты
		Автомобиль.СуммаВсегоПоДокументуПоступления = Автомобиль.СуммаВсего;
		Автомобиль.СуммаПоДокументуПоступления      = Автомобиль.Сумма;
		Автомобиль.СуммаНДСПоДокументуПоступления   = Автомобиль.СуммаНДС;
		Автомобиль.СтавкаНДСПоДокументуПоступления  = Автомобиль.СтавкаНДС;
		Автомобиль.КоличествоПоДокументуПоступления = Автомобиль.Количество;
		Автомобиль.ГТДДоКорректировки				= Автомобиль.ГТД;
		Автомобиль.ИзДокументаОснования             = Истина;
		
		ОбработкаРеквизита("РассчитатьРазницу", Автомобиль);
	КонецЦикла;
	
КонецПроцедуры 


//<<Павличенко 15.09.2020
Функция ВыполнитьДвиженияПоОстаткам_Типовая(ТаблицаДокумента, СписокОснований, Отказ)

//Функция ВыполнитьДвиженияПоОстаткам(ТаблицаДокумента, СписокОснований, Отказ)
//>>Павличенко 15.09.2020	
	НеобходимоСкорректироватьСебестоимость = Новый Массив;
	
	Если ТаблицаДокумента.Количество() = 0 Тогда
		Возврат НеобходимоСкорректироватьСебестоимость;
	КонецЕсли;
	
	ВалютаУпр  = Константы.ВалютаУправленческогоУчетаКомпании.Получить();
	ВалютаРегл = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	
	
	// получим записи из регистра остатков
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ОстаткиАвтомобилей.Автомобиль КАК Автомобиль,
	|	ОстаткиАвтомобилей.СкладКомпании КАК СкладКомпании,
	|	ОстаткиАвтомобилей.СтатусПартии КАК СтатусПартии,
	|	ОстаткиАвтомобилей.Партия КАК Партия,
	|	ОстаткиАвтомобилей.ГТД КАК ГТД,
	|	СУММА(ОстаткиАвтомобилей.Количество) КАК Количество,
	|	СУММА(ОстаткиАвтомобилей.Сумма) КАК Сумма,
	|	СУММА(ОстаткиАвтомобилей.СуммаНДС) КАК СуммаНДС,
	|	СУММА(ОстаткиАвтомобилей.СуммаУпр) КАК СуммаУпр
	|ИЗ
	|	РегистрНакопления.ОстаткиАвтомобилей КАК ОстаткиАвтомобилей
	|ГДЕ
	|	ОстаткиАвтомобилей.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И ОстаткиАвтомобилей.Регистратор В(&Регистраторы)
	|	И ОстаткиАвтомобилей.Автомобиль В(&Автомобили)
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиАвтомобилей.Партия,
	|	ОстаткиАвтомобилей.СтатусПартии,
	|	ОстаткиАвтомобилей.Автомобиль,
	|	ОстаткиАвтомобилей.СкладКомпании,
	|	ОстаткиАвтомобилей.ГТД";
	
	Запрос.УстановитьПараметр("Регистраторы" , СписокОснований);
	Запрос.УстановитьПараметр("Автомобили"   , ТаблицаДокумента.ВыгрузитьКолонку("Автомобиль"));
	Запрос.УстановитьПараметр("СтатусПартии" , Перечисления.СтатусыПартий.ТоварОтветственноеХранение);
	
	ТаблицаОстатков = Запрос.Выполнить().Выгрузить();
	
	Для Каждого СтрокаАвтомобиля Из ТаблицаДокумента Цикл
		
		Если СтрокаАвтомобиля.Количество = 0 Тогда
			// Проверим наличия автомобиля на остатках
			Если НЕ СтрокаАвтомобиля.ЕстьОстаток Тогда
				дкСообщитьРезультат("Автомобиль <"+СтрокаАвтомобиля.Автомобиль+"> отсутствует на складе <"+СкладКомпании+">. Расход невозможен.", , ЭтотОбъект);
				Отказ = Истина;
				Продолжить;
			КонецЕсли;
			
			НайденныеСтроки = ТаблицаОстатков.НайтиСтроки(Новый Структура("Автомобиль", СтрокаАвтомобиля.Автомобиль));
			
			Если НайденныеСтроки.Количество() = 0 Тогда
				дкСообщитьРезультат("Автомобиль <"+СтрокаАвтомобиля.Автомобиль+"> не найденны движения в данной цепочке.", , ЭтотОбъект);
				Отказ = Истина;
				Продолжить;
			КонецЕсли;
			
			// Сторнирование поступления авто
			ОстаткиПоСделке = Ложь;
			Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				ДвижениеОстатки = Движения.ОстаткиАвтомобилей.Добавить();
				ЗаполнитьЗначенияСвойств(ДвижениеОстатки, НайденнаяСтрока);
				
				ДвижениеОстатки.Период         = Дата;
				ДвижениеОстатки.Регистратор    = Ссылка;
				ДвижениеОстатки.ВидДвижения    = ВидДвиженияНакопления.Приход;
				ДвижениеОстатки.Количество     = -ДвижениеОстатки.Количество;
				ДвижениеОстатки.Сумма          = -ДвижениеОстатки.Сумма;
				ДвижениеОстатки.СуммаНДС       = -ДвижениеОстатки.СуммаНДС;
				ДвижениеОстатки.СуммаУпр       = -ДвижениеОстатки.СуммаУпр;
				
				ДвижениеОстатки.СтавкаНДС   = СтрокаАвтомобиля.СтавкаНДС;
				ДвижениеОстатки.ХозОперация = ХозОперация;
				ОстаткиПоСделке = ОстаткиПоСделке ИЛИ (НайденнаяСтрока.Партия = СтрокаАвтомобиля.Партия);
			КонецЦикла;
			
			Если НЕ ОстаткиПоСделке Тогда
				дкСообщитьРезультат("Не удалось откорректировать автомобиль <"+СтрокаАвтомобиля.Автомобиль+"> - партия была расформирована.", , ЭтотОбъект);
				Отказ = Истина;
				Продолжить;
			КонецЕсли;
			
		Иначе
			
			НайденныеСтроки = ТаблицаОстатков.НайтиСтроки(Новый Структура("Автомобиль", СтрокаАвтомобиля.Автомобиль));
			
			СтрокаОстаткаАвтомобиля = Неопределено;
			
			Если НайденныеСтроки.Количество() = 0 Тогда
				СтрокаОстаткаАвтомобиля = Неопределено;
			ИначеЕсли Сделка.ХозОперация = Справочники.ХозОперации.ПереходВСобственностьАвтомобилей Тогда
				Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
					Если НЕ НайденнаяСтрока.СтатусПартии = Перечисления.СтатусыПартий.ТоварОтветственноеХранение Тогда
						СтрокаОстаткаАвтомобиля = НайденнаяСтрока;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			Иначе
				СтрокаОстаткаАвтомобиля = НайденныеСтроки[0];
			КонецЕсли;
			
			Если СтрокаОстаткаАвтомобиля = Неопределено Тогда
				дкСообщитьРезультат("Для автомобиля <"+СтрокаАвтомобиля.Автомобиль+"> не найденны движения в данной цепочке.", , ЭтотОбъект);
				Отказ = Истина;
				Продолжить;
			КонецЕсли;
			
			ДвижениеОстатки = Движения.ОстаткиАвтомобилей.Добавить();
			
			Если СтрокаАвтомобиля.ЕстьОстаток Тогда
				ЗаполнитьЗначенияСвойств(ДвижениеОстатки, СтрокаАвтомобиля,"Автомобиль,СкладКомпании,СтатусПартии,Партия,ГТД");
			Иначе
				ЗаполнитьЗначенияСвойств(ДвижениеОстатки, СтрокаОстаткаАвтомобиля,"Автомобиль,СкладКомпании,СтатусПартии,Партия,ГТД");
			КонецЕсли;
			
			ДвижениеОстатки.Период      = Дата;
			ДвижениеОстатки.Регистратор = Ссылка;
			ДвижениеОстатки.ВидДвижения = ВидДвиженияНакопления.Приход;
			ДвижениеОстатки.Количество  = 0;
			ДвижениеОстатки.Сумма       = обПересчет(СтрокаАвтомобиля.СуммаВсегоРазница, ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата);
			ДвижениеОстатки.СуммаНДС    = обПересчет(СтрокаАвтомобиля.СуммаНДСРазница  , ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата);
			ДвижениеОстатки.СуммаУпр    = обПересчет(СтрокаАвтомобиля.СуммаВсегоРазница, ВалютаДокумента, КурсДокумента, ВалютаУпр , КурсВалютыУпр);
			ДвижениеОстатки.СтавкаНДС   = СтрокаАвтомобиля.СтавкаНДС;
			ДвижениеОстатки.ХозОперация = ХозОперация;
			
			// откорректруем списывающие движение если необходимо
			Если НЕ СтрокаАвтомобиля.ЕстьОстаток Тогда
				ДвижениеОстаткиРасход = Движения.ОстаткиАвтомобилей.Добавить();
				ЗаполнитьЗначенияСвойств(ДвижениеОстаткиРасход, ДвижениеОстатки);
				ДвижениеОстаткиРасход.ВидДвижения = ВидДвиженияНакопления.Расход;
				
				// скорректируем себестоимость на регистре продажи
				Если Сделка.ХозОперация <> Справочники.ХозОперации.ПоступлениеАвтомобилейОтветственноеХранение Тогда
					НеобходимоСкорректироватьСебестоимость.Добавить(СтрокаАвтомобиля.Автомобиль);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Движения.ОстаткиАвтомобилей.Записать();
	
	Возврат НеобходимоСкорректироватьСебестоимость;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// ИСПОЛНЯЕМАЯ ЧАСТЬ МОДУЛЯ

// сохранение ссылки на коллекцию прав, настроек и окружения
Права = Неопределено;
#Если Клиент Тогда
Права = глПрава;
#КонецЕсли
