// Модуль документа РеализацияАвтомобилей


////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ ОБЪЕКТА

Перем Права Экспорт;				// Переменная объекта - ссылка на коллекцию прав, настроек и переменных окружения
Перем РезультатОбработки Экспорт;	// Переменная для накопления результатов проведения по модулям наборов записей
Перем ОбработкаЗначенияСвойствОбъектов Экспорт; // Переменная для хранения значения свойств основания/объекта копирования
Перем ИмяРеквизитаКода Экспорт;     // Кэш права "РежимВыводаКодаВДокументах". Служит для настройки вывода кода/артикула в ТЧ
Перем ОбработкаРасчетСкидокАвтомобили Экспорт; // Переменная для хранения ссылки на обработку "Расчет скидок". Данная обработка содержит необходимые
                                     // свойства и методы для расчета скидок документа.
Перем ОбработкаРасчетСкидок Экспорт; // Переменная для хранения ссылки на обработку "Расчет скидок". Данная обработка содержит необходимые
                                     // свойства и методы для расчета скидок документа.

Перем ВалютаУправленческогоУчета;  // Переменная для хранения значения валюты управленческого учета
Перем ВалютаРегламентированногоУчета; // Переменная для хранения значения валюты регламентированного учета
Перем КешСебестоимостиАвтомобилейКупленныхУФизЛица; // Переменная для хранения значения валюты регламентированного учета

Перем ТекущаяВалютаДокумента Экспорт; // Текущая валюта документа
Перем ТекущийКурсДокумента Экспорт;   // Текущий курс валюты документа

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

// Функция - Получить доп оборудование
//
// Параметры:
//  Идентификатор	 - Строка	 - Идентификатор авто
// 
// Возвращаемое значение:
//  Массив - Массив найденого оборудования.
//
Функция ПолучитьДопОборудование(Идентификатор)
	Возврат Товары.НайтиСтроки(Новый Структура("ИдентификаторАвтомобиля", Идентификатор));
КонецФункции
// Проверка наличия других заказов на автомобиль с данным VINом
//
// Параметры
//  VINАвтомобиля  – <Строка> – VIN автомобиля, заказы на который проверяются
//  ОбъектПроверки  – <ДокументОбъект> – Документ, который проверяет наличие заказов
//
// Возвращаемое значение:
//   <Булево>   – Заказов на данный автомобиль нет
//
Функция ПроверитьЗаказыНаАвтомобиль()
	ДокументОбъектСтруктура=Новый Структура();
	ДокументОбъектСтруктура.Вставить("Ссылка",Ссылка);
	ДокументОбъектСтруктура.Вставить("МоментВремени",МоментВремени());
	Если ТипЗнч(РезультатОбработки) = Тип("ОбработкаОбъект.ИнформационноеПоле") Тогда
		СтрокаСообщений="";
		Рез=зфЗащищенныеФункцииСервер.РеализацияАвтомобилейПроверитьЗаказыНаАвтомобиль(ДокументОбъектСтруктура,СтрокаСообщений);
		Если НЕ ПустаяСтрока(СтрокаСообщений) Тогда
			Для НомерСтроки=1 По СтрЧислоСтрок(СтрокаСообщений) Цикл
				СообщениеПользователю=СтрПолучитьСтроку(СтрокаСообщений,НомерСтроки);
				РезультатОбработки.ДобавитьСтрокуСообщения(СообщениеПользователю,"Важное",Неопределено,Неопределено);
			КонецЦикла; 
		КонецЕсли; 
	Иначе
		Рез=зфЗащищенныеФункцииСервер.РеализацияАвтомобилейПроверитьЗаказыНаАвтомобиль(ДокументОбъектСтруктура,РезультатОбработки);
	КонецЕсли;
	Возврат Рез;
КонецФункции // ПроверитьЗаказыНаАвтомобиль()

// Функция возвращает положительную себестоимость автомобиля в валюте документа если 
// этот автомобиль был приобретен у физического лица
//
// Параметры:
//  СтрокаТЧ       - строка табличной части Товары
//
// Возвращаемое значение:
//  Себестоимость - Число себестоимость автомобиля в валюте документа
// 
Функция ПолучитьСебестоимостьАвтомобиляКупленногоУФизЛица(СтрокаТЧ)
	ДокументОбъектСтруктура=Новый Структура();
	ДокументОбъектСтруктура.Вставить("Дата",Дата);
	ДокументОбъектСтруктура.Вставить("ХозОперация",ХозОперация);
	ДокументОбъектСтруктура.Вставить("ВалютаДокумента",ВалютаДокумента);
	ДокументОбъектСтруктура.Вставить("КурсДокумента",КурсДокумента);
	Если КешСебестоимостиАвтомобилейКупленныхУФизЛица=Неопределено Тогда
		ДокументОбъектСтруктура.Вставить("КешСебестоимостиАвтомобилейКупленныхУФизЛица",Неопределено);
	Иначе
		ДокументОбъектСтруктура.Вставить("КешСебестоимостиАвтомобилейКупленныхУФизЛица",КешСебестоимостиАвтомобилейКупленныхУФизЛица.Скопировать());
	КонецЕсли; 
	ДокументОбъектСтрока=Новый Структура();
	Для каждого РеквизитТабличнойЧасти Из ЭтотОбъект.Метаданные().ТабличныеЧасти.Автомобили.Реквизиты Цикл
		ДокументОбъектСтрока.Вставить(РеквизитТабличнойЧасти.Имя,СтрокаТЧ[РеквизитТабличнойЧасти.Имя]);
	КонецЦикла; 
	Себестоимость=зфЗащищенныеФункцииСервер.РеализацияАвтомобилейПолучитьСебестоимостьАвтомобиляКупленногоУФизЛица(ДокументОбъектСтруктура,ДокументОбъектСтрока);
	СтрокаТЧ.СебестоимостьАвтомобиля=Себестоимость;
	Если ДокументОбъектСтруктура.КешСебестоимостиАвтомобилейКупленныхУФизЛица<>Неопределено Тогда
		КешСебестоимостиАвтомобилейКупленныхУФизЛица=ДокументОбъектСтруктура.КешСебестоимостиАвтомобилейКупленныхУФизЛица.Скопировать();
	КонецЕсли; 
	Возврат Себестоимость;
КонецФункции // ПолучитьСебестоимостьАвтомобиляКупленногоУФизЛица()

// Функция поиска заказа по автомобилю
Функция НайтиЗаказАвтомобиля(Автомобиль)
	ДокументОбъектСтруктура=Новый Структура();
	ДокументОбъектСтруктура.Вставить("Ссылка",Ссылка);
	ДокументОбъектСтруктура.Вставить("Дата",Дата);
	ДокументОбъектСтруктура.Вставить("Контрагент",Контрагент);
	ДокументОбъектСтруктура.Вставить("ДоговорВзаиморасчетов",ДоговорВзаиморасчетов);
	ДокументОбъектСтруктура.Вставить("СкладКомпании",СкладКомпании);
	Возврат зфЗащищенныеФункцииСервер.РеализацияАвтомобилейНайтиЗаказАвтомобиля(ДокументОбъектСтруктура,Автомобиль);
КонецФункции

// Получение суммы по строке документа без скидки
//
// ЭтотОбъект	– ДокументОбъект	– Документ, для которого требуется получить сумму строки.
// ТекСтрока	– СтрокаТабличнойЧасти – Ссылка на строку табличной части документа.
//
// Возвращаемое значение:
// Число – Сумма строки документа.
//
Функция ПолучитьСуммуСтрокиБезСкидки(ЭтотОбъект,ТекСтрока)
	Сумма = 0;
	
	// Включает ли цена НДС?
	Попытка
		ЦенаВключаетНДС = ЭтотОбъект.ТипЦен.Пустая() ИЛИ ЭтотОбъект.ТипЦен.ЦенаВключаетНДС;
	Исключение
		ЦенаВключаетНДС = Истина;
	КонецПопытки;
	// Пробуем получить ставку НДС. Если ее нет в табличной части, то считаем что ставка = 0.
	Попытка
		СтавкаНДС = ТекСтрока.СтавкаНДС.Ставка;
	Исключение
		СтавкаНДС = 0;
	КонецПопытки; 
	
	Себестоимость = ПолучитьСебестоимостьАвтомобиляКупленногоУФизЛица(ТекСтрока);
	
	Сумма = ТекСтрока.Сумма;
	Если НЕ ЦенаВключаетНДС Тогда
		Если Себестоимость = 0 Тогда
			Сумма = Сумма + Окр(Сумма*СтавкаНДС/100,2);
		Иначе
			Сумма = Сумма + Окр((Сумма-Себестоимость)*СтавкаНДС/100,2);
		КонецЕсли;
	КонецЕсли;
	
	Возврат Сумма;
КонецФункции // ПолучитьСуммуСтрокиБезСкидки()

// Функция перерассчитывает проценты скидок в табличной части документа.
//
// Параметры:
//  ДокументОбъект – "ДокументОбъект" - Произвольный документ, для которого производится поиск подходящей скидки.
//
// Возвращаемое значение:
//   НЕТ
// 
Процедура ПрименитьСкидку(ТекущаяСкидкаНаценка, ТекущаяСуммаСкидки, ТекущееЗначениеСкидки, СуммаДляРасчетаШапочнойСкидки)
	// подготовим данные для сравнения
	РедактируемПроценты = обПраво("СпособВыбораСкидки",Права,, ЭтотОбъект) = Перечисления.СкидкиСпособыВыбора.РучныеСкидкиИРедактированиеПроцентов;
	Попытка
		СкидкаШапкиДок = СкидкаНаценка;
	Исключение
		СкидкаШапкиДок = Неопределено;
	КонецПопытки;
	
	Если Автомобили.Количество()=0 Тогда
		Возврат;
	КонецЕсли;
		
	СкидкаОтносительная = ТекущаяСкидкаНаценка.Пустая() Или (ТекущаяСкидкаНаценка.СпособВычисления=Перечисления.СкидкиСпособВычисления.Относительная);
	СкидкаШапкиВытесняющая = ТекущаяСкидкаНаценка.ФлагВытеснения;
	
	Если СкидкаОтносительная Тогда
		// Скидки более 100% недопустимы.
		ПроцентСкидки = Мин(ТекущееЗначениеСкидки, 100); 		
	Иначе
		// Скидки более 100% недопустимы.
		КоэффициентСкидки = ?(Автомобили.Итог("Сумма")=0, 0, ТекущаяСуммаСкидки / СуммаДляРасчетаШапочнойСкидки);
		КоэффициентСкидки = ?(КоэффициентСкидки>1, 1, КоэффициентСкидки);
	КонецЕсли;
	
	// Проходимся по табличной части. За одно найдем строку с максимальной суммой.
	СтрокаСМаксимальнойСуммой = Автомобили[0];
	СуммаСтрокиСМаксимальнойСуммой = ПолучитьСуммуСтрокиБезСкидки(ЭтотОбъект,СтрокаСМаксимальнойСуммой);
	//СуммаВытеснения = 0;
	Для Каждого ТекСтрока Из Автомобили Цикл
		Сумма = ПолучитьСуммуСтрокиБезСкидки(ЭтотОбъект,ТекСтрока);
		Если СкидкаОтносительная Тогда
			Если НЕ (РедактируемПроценты И НЕ обЗначениеНеЗаполнено(ТекСтрока.ПроцентСкидки) И (СкидкаШапкиДок = ТекущаяСкидкаНаценка))Тогда
				ТекСтрока.ПроцентСкидки = ПроцентСкидки;
			КонецЕсли;
			Если ТекущаяСкидкаНаценка.Пустая() И РедактируемПроценты Тогда
				ТекСтрока.ПроцентСкидки = 0;
			КонецЕсли;
			ТекСтрока.СуммаСкидки	 = ТекСтрока.ПроцентСкидки / 100 * Сумма;
			ТекСтрока.СуммаСкидки	 = дкОкруглитьСуммуСкидки(ТекСтрока.СуммаСкидки,ТекущаяСкидкаНаценка);
		Иначе
			Если ТекущаяСкидкаНаценка.Пустая() И РедактируемПроценты Тогда
				ТекСтрока.СуммаСкидки = 0;
			Иначе
				ТекСтрока.СуммаСкидки = КоэффициентСкидки * Сумма;
				ТекСтрока.СуммаСкидки = дкОкруглитьСуммуСкидки(ТекСтрока.СуммаСкидки,ТекущаяСкидкаНаценка);
			КонецЕсли;
			ТекСтрока.ПроцентСкидки	 = ?(ТекСтрока.СуммаСкидки=0, 0, КоэффициентСкидки * 100);			
		КонецЕсли;
		
		СкидкаНеВытесняется = Истина;
		//СуммаСкидкиСтрокиВрем = ТекСтрока.СуммаСкидки;
		
		Если СкидкаНеВытесняется И Сумма>СуммаСтрокиСМаксимальнойСуммой Тогда
			// Ищем строку с максимальной суммой.
			СтрокаСМаксимальнойСуммой = ТекСтрока;
			СуммаСтрокиСМаксимальнойСуммой = Сумма;
		КонецЕсли;
		
		// Рассчитываем сумму НДС и сумму всего.
		ОбработкаРеквизита("Автомобили.СтавкаНДС", ТекСтрока);
	КонецЦикла;
	
	Если РедактируемПроценты Тогда
		ОстатокСкидки = 0;
	Иначе
		//ived Была ошибка исправляемая данным кодом исправили сейчас не воспроизводится
		//ОстатокСкидки = ТекущаяСуммаСкидки - ТабличнаяЧасть.Итог("СуммаСкидки") - СуммаВытеснения;
		ОстатокСкидки = ТекущаяСуммаСкидки - Автомобили.Итог("СуммаСкидки");
	КонецЕсли;
	Если ОстатокСкидки<>0 Тогда
		СтрокаСМаксимальнойСуммой.СуммаСкидки   = СтрокаСМаксимальнойСуммой.СуммаСкидки + ОстатокСкидки;
		СтрокаСМаксимальнойСуммой.ПроцентСкидки	= ?(СуммаСтрокиСМаксимальнойСуммой=0, 0, 100 * СтрокаСМаксимальнойСуммой.СуммаСкидки / СуммаСтрокиСМаксимальнойСуммой);
		
		ОбработкаРеквизита("Автомобили.СтавкаНДС", СтрокаСМаксимальнойСуммой);
	КонецЕсли;
	
КонецПроцедуры // ПрименитьСкидкуШапки() 

Функция ПолучитьСуммуДокументаБезСкидкиАвтомобилей()
	
	СуммаДокументаБезСкидки = ЭтотОбъект.Автомобили.Итог("Сумма");
	ЦенаВключаетНДС = (обЗначениеНеЗаполнено(ЭтотОбъект.ТипЦен) ИЛИ ЭтотОбъект.ТипЦен.ЦенаВключаетНДС);
	Если НЕ ЦенаВключаетНДС Тогда
		Для каждого ТекСтрока Из ЭтотОбъект.Автомобили Цикл
			Себестоимость = ПолучитьСебестоимостьАвтомобиляКупленногоУФизЛица(ТекСтрока);
			СуммаДокументаБезСкидки = СуммаДокументаБезСкидки + ((ТекСтрока.Сумма - Себестоимость) * ТекСтрока.СтавкаНДС.Ставка)/100;
		КонецЦикла;
	КонецЕсли;
	Возврат СуммаДокументаБезСкидки;
	
КонецФункции // ПолучитьСуммуДокументаБезСкидкиАвтомобилей()

Процедура ПересчетСкидокАвтомобилей()
	
	ЦенаВключаетНДС = (обЗначениеНеЗаполнено(ТипЦен) ИЛИ ТипЦен.ЦенаВключаетНДС);
	
	//Пересчитаем скидки 
	Если НЕ ЦенаВключаетНДС И НЕ ОбработкаРасчетСкидокАвтомобили.КэшСкидок.Количество() = 0 Тогда
		
		ОбработкаРасчетСкидокАвтомобили.СуммаДляРасчетаШапочнойСкидки = ПолучитьСуммуДокументаБезСкидкиАвтомобилей();
		КоэффициентПересчетаВВалютуДокумента = ?((КурсДокумента=0) ИЛИ (ВалютаДокумента=Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить()), 1, КурсДокумента);
		СтруктураВыборки = Новый Структура("Объект,Свойство",Неопределено,Неопределено);
		
		Для Каждого ТекСтрокаКэша Из ОбработкаРасчетСкидокАвтомобили.КэшСкидок Цикл
			ОтказПоНесовпадениюСвойства = Ложь;
			Если ЗначениеЗаполнено(ТекСтрокаКэша.ВидСвойства) И ЗначениеЗаполнено(ТекСтрокаКэша.Свойство) Тогда
				Если ЭтотОбъект.ЭтоНовый() Тогда
					ОтказПоНесовпадениюСвойства = Истина;
				Иначе
					СтруктураВыборки.Объект = Ссылка;
					СтруктураВыборки.Свойство = ТекСтрокаКэша.ВидСвойства;
					СтрСвойств = РегистрыСведений.ЗначенияСвойствОбъектов.Получить(СтруктураВыборки);
					Если СтрСвойств.Значение <> ТекСтрокаКэша.Свойство Тогда
						ОтказПоНесовпадениюСвойства = Истина
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			ОтСуммыЧекаВВалютеДокумента = ТекСтрокаКэша.ОтСуммыЧека / КоэффициентПересчетаВВалютуДокумента;
			
			Если ОтСуммыЧекаВВалютеДокумента>ОбработкаРасчетСкидокАвтомобили.СуммаДляРасчетаШапочнойСкидки Тогда // Сумма документа недостаточна для скидки
				ТекСтрокаКэша.РассчитаннаяСуммаСкидки = 0;	
				ТекСтрокаКэша.НеПодходит             = Истина;
			ИначеЕсли ОтказПоНесовпадениюСвойства Тогда
				ТекСтрокаКэша.РассчитаннаяСуммаСкидки = 0;
				ТекСтрокаКэша.НеПодходит             = Истина;
			Иначе
				ТекСтрокаКэша.НеПодходит = Ложь;
				// Раcсчитываем сумму скидки.
				Если ТекСтрокаКэша.СпособВычисления=Перечисления.СкидкиСпособВычисления.Относительная Тогда
					ТекСтрокаКэша.РассчитаннаяСуммаСкидки = ОбработкаРасчетСкидокАвтомобили.СуммаДляРасчетаШапочнойСкидки * ТекСтрокаКэша.ЗначениеСкидки / 100;
				Иначе
					// Если скидка абсолютная, то ее значение - это сумма в валюте рег. учета.
					// Выполним пересчет в валюту документа.
					ТекСтрокаКэша.РассчитаннаяСуммаСкидки = ТекСтрокаКэша.ЗначениеСкидки / КоэффициентПересчетаВВалютуДокумента;
					
					// Если сумма абсолютной скидки превышает значение базы для расчета скидки (т.е больше суммы документа), 
					// то итоговая сумма уйдет в минус, поэтому такая скидка не подойдет.
					Если ТекСтрокаКэша.РассчитаннаяСуммаСкидки>ОбработкаРасчетСкидокАвтомобили.СуммаДляРасчетаШапочнойСкидки Тогда
						ТекСтрокаКэша.НеПодходит = Истина;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		// Сортируем по убыванию.
		ОбработкаРасчетСкидокАвтомобили.КэшСкидок.Сортировать("НеПодходит ВОЗР, ЭтоПодарок УБЫВ, ФлагВытеснения УБЫВ, РассчитаннаяСуммаСкидки УБЫВ, ЗначениеСкидки УБЫВ");
		
		Если Не ОбработкаРасчетСкидокАвтомобили.КэшСкидок[0].НеПодходит Тогда
			// Подходящая скидка найдена, сразу заполним итоговую сумму скидки на документ.
			НайденноеЗначениеСкидки = ?(ОбработкаРасчетСкидокАвтомобили.КэшСкидок[0].СпособВычисления = Перечисления.СкидкиСпособВычисления.Абсолютная, ОбработкаРасчетСкидокАвтомобили.КэшСкидок[0].РассчитаннаяСуммаСкидки, ОбработкаРасчетСкидокАвтомобили.КэшСкидок[0].ЗначениеСкидки);
			ТекущаяСуммаСкидки = ОбработкаРасчетСкидокАвтомобили.КэшСкидок[0].РассчитаннаяСуммаСкидки;
			Если (СкидкаНаценкаАвтомобили<>ОбработкаРасчетСкидокАвтомобили.КэшСкидок[0].Скидка) ИЛИ (ЗначениеСкидкиНаценкиАвтомобили<>НайденноеЗначениеСкидки) Тогда
				ОбработкаРасчетСкидокАвтомобили.ТекущаяСкидкаНаценка  = ОбработкаРасчетСкидокАвтомобили.КэшСкидок[0].Скидка;
				ОбработкаРасчетСкидокАвтомобили.ТекущееЗначениеСкидки = НайденноеЗначениеСкидки;
			КонецЕсли;
		Иначе 
			Если Не СкидкаНаценкаАвтомобили.РучнаяСкидка Тогда
				СкидкаНаценкаАвтомобили = Справочники.ТипыСкидок.ПустаяСсылка();
			КонецЕсли;			
			Если ОбработкаРасчетСкидокАвтомобили.ТекущееЗначениеСкидки<>0 Тогда
				ОбработкаРасчетСкидокАвтомобили.ТекущееЗначениеСкидки = 0;
				ОбработкаРасчетСкидокАвтомобили.ТекущаяСуммаСкидки    = 0; 
			КонецЕсли;			
		КонецЕсли;
		
		ОбработкаРасчетСкидокАвтомобили.ТекущаяСуммаСкидки=дкОкруглитьСуммуСкидки(ОбработкаРасчетСкидокАвтомобили.ТекущаяСуммаСкидки,ОбработкаРасчетСкидокАвтомобили.ТекущаяСкидкаНаценка);
		
		ЭтотОбъект[ОбработкаРасчетСкидокАвтомобили.ИмяРеквизитаСкидкаНаценка] = ОбработкаРасчетСкидокАвтомобили.ТекущаяСкидкаНаценка;
		ЭтотОбъект[ОбработкаРасчетСкидокАвтомобили.ИмяРеквизитаЗначениеСкидкиНаценки] = ОбработкаРасчетСкидокАвтомобили.ТекущееЗначениеСкидки;
		ЭтотОбъект[ОбработкаРасчетСкидокАвтомобили.ИмяРеквизитаСуммаСкидкиНаценки] = ОбработкаРасчетСкидокАвтомобили.ТекущаяСуммаСкидки;
		
		// Пересчитаем скидки для документа
		ПрименитьСкидку(ОбработкаРасчетСкидокАвтомобили.ТекущаяСкидкаНаценка, ОбработкаРасчетСкидокАвтомобили.ТекущаяСуммаСкидки, ОбработкаРасчетСкидокАвтомобили.ТекущееЗначениеСкидки, ОбработкаРасчетСкидокАвтомобили.СуммаДляРасчетаШапочнойСкидки);
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ДОПОЛНИТЕЛЬНЫХ МЕТОДОВ ОБЪЕКТА

// Возвращает структуру обязательных / уникальных реквизитов документа
// Возвращаемая структура содержит строковые идентификаторы реквизитов или вложенные структуры для табличных частей
// Для реквизита значение структуры содержит число 1-Обязательный, 2-Уникальный, 3-Уникальный и обязательный
Функция ПолучитьОбязательныеРеквизиты() Экспорт
	// Обязательные поля таблицы автомобилей
	ОбязательныеАвтомобили=Новый Структура();
	ОбязательныеАвтомобили.Вставить("Автомобиль",3);
	ОбязательныеАвтомобили.Вставить("ИдентификаторАвтомобиля",1);
	ОбязательныеАвтомобили.Вставить("Количество",1);
	ОбязательныеТовары=Новый Структура();
	ОбязательныеТовары.Вставить("ИдентификаторАвтомобиля",3);
	ОбязательныеТовары.Вставить("Номенклатура",3);
	ОбязательныеТовары.Вставить("Количество",1);
	ОбязательныеТовары.Вставить("ЕдиницаИзмерения",3);
	ОбязательныеТовары.Вставить("Коэффициент",1);
	ОбязательныеТовары.Вставить("ХарактеристикаНоменклатуры",2);

	// Обязательные реквизиты документа
	ОбязательныеРеквизиты=Новый Структура();
	ОбязательныеРеквизиты.Вставить("Организация",1);
	ОбязательныеРеквизиты.Вставить("ПодразделениеКомпании",1);
	ОбязательныеРеквизиты.Вставить("Автор",1);
	ОбязательныеРеквизиты.Вставить("ВалютаДокумента",1);
	ОбязательныеРеквизиты.Вставить("КурсДокумента",1);
	ОбязательныеРеквизиты.Вставить("СкладКомпании",1);
	ОбязательныеРеквизиты.Вставить("Контрагент",1);
	ОбязательныеРеквизиты.Вставить("ДоговорВзаиморасчетов",1);
	ОбязательныеРеквизиты.Вставить("Заказчик",1);
	ОбязательныеРеквизиты.Вставить("ТипЦен",1);
	ОбязательныеРеквизиты.Вставить("ХозОперация",1);
	ОбязательныеРеквизиты.Вставить("Автомобили",ОбязательныеАвтомобили);
	ОбязательныеРеквизиты.Вставить("Товары",ОбязательныеТовары);
	
	Возврат ОбязательныеРеквизиты;
КонецФункции

// Проверяет корректность заполнения объекта.
// Возвращает Истина если все заполнено корректно и Ложь иначе.
// В случае некорректного заполнения формирует строку описанием возникших ошибок "Ошибки"
// На вход может быть передана структура ДопРеквизиты с дополнительными реквизитами для проверки
// может управляться булевыми флагами выполняемых проверок Заполнение, Уникальность
// (могут быть и другие необязательные)
// Обычно выполняется универсальным обработчиком, но могут быть добавлены доп. проверки
Функция ПроверитьКорректность(Ошибки="", ДопРеквизиты=Неопределено, Заполнение=Истина, Уникальность=Истина) Экспорт
	// Здесь могут быть определены дополнительные к стандартным обязательным реквизитам условия проверки
	Результат = дкПроверитьКорректность(ЭтотОбъект, Ошибки, ДопРеквизиты, Заполнение, Уникальность);
	
	// Проведем проверку соответствия организации документа организациям некоторых реквизитов документа.
	// Такую проверку необходимо осуществлять, если баланс в системе ведется по организации,
	// или если установлен способ контроля корректности
	// договора и склада документа. Причем, если способ контроля выбран "Контроль по организации и подразделению", то
	// дополнительно осуществляется проверка соответствия подразделений.
	Если Результат Тогда
		СпособКонтроляКорректности = обПраво("КонтрольКорректностиДоговораИСкладаДокумента", Права,,ЭтотОбъект);	
		КонтрольОтсутствует        = (СпособКонтроляКорректности=Перечисления.СпособКонтроляКорректностиДоговораИСкладаДокумента.КонтрольОтсутствует);
		БалансВедетсяПоОрганизации = (Константы.СпособВеденияБаланса.Получить()=Перечисления.СпособВеденияБаланса.ПоОрганизации);

		Если БалансВедетсяПоОрганизации Или Не КонтрольОтсутствует Тогда
			КонтрольПоПодразделению = (СпособКонтроляКорректности=Перечисления.СпособКонтроляКорректностиДоговораИСкладаДокумента.КонтрольПоОрганизацииИПодразделению);
			
			КонтролируемыеРеквизиты = Новый Структура();
			
			КонтролируемыеРеквизитыШапки = Новый Структура();
			КонтролируемыеРеквизитыШапки.Вставить("СкладКомпании",         КонтрольПоПодразделению);
			КонтролируемыеРеквизитыШапки.Вставить("ДоговорВзаиморасчетов", КонтрольПоПодразделению);
			КонтролируемыеРеквизиты.Вставить("КонтролируемыеРеквизитыШапки",КонтролируемыеРеквизитыШапки);
			
			Результат = дкПроверитьКорректностьПоОрганизации(ЭтотОбъект,КонтролируемыеРеквизиты,Ошибки) и Результат;
		КонецЕсли;  		
	КонецЕсли;
	
	Результат = дкПроверитьКорректностьТоваровКомиссионныхДокументов(ЭтотОбъект,Ошибки,"Автомобили", "Автомобиль", Ложь) И дкПроверитьКорректностьТоваровКомиссионныхДокументов(ЭтотОбъект,Ошибки) И Результат;
	
	Возврат Результат;
КонецФункции
 
// Функция проверяет, допустимо ли изменение объекта
// Возвращает Истина, если изменения возможны, ложь иначе
// Если изменения доступны частично, возвращает ложь и структуру блокируемых на изменение реквизитов,
Функция ДоступностьИзменения(БлокироватьРеквизиты=Неопределено) Экспорт
    // Здесь может быть прописано определение наличия ссылок, блокирующих изменение объекта
	Возврат Истина;
КонецФункции

// Возвращает список возможных хозяйственных операций документа
// Возвращаемое значение: СписокЗначений. 
// Строка списка: Значение - имя предопределенного элемента; 
//				  Представление - красивое его представление
// 				  "Помеченная" строка - ХО по умолчанию.
Функция ПолучитьСписокХозОпераций() Экспорт
	СписокХозОпераций = Новый СписокЗначений;
	СписокХозОпераций.Добавить("РеализацияАвтомобилей","Реализация автомобилей",Истина);
	СписокХозОпераций.Добавить("РеализацияАвтомобилейКомиссия","Реализация автомобилей (комиссия)");
	
	Возврат СписокХозОпераций;
КонецФункции

// возвращает выборку по шапке
// ДокументСсылка - Ссылка на документ для которого получаем шапку
Функция ПолучитьШапкуДокумента(ДокументСсылка) Экспорт
	Запрос=Новый Запрос("
	|ВЫБРАТЬ
	|	СУММА(СуммыТаблиц.СуммаАвтомобилей) КАК СуммаАвтомобилей,
	|	СУММА(СуммыТаблиц.СуммаДопОборудования) КАК СуммаДопОборудования
	|ПОМЕСТИТЬ
	|	СуммыТаблиц
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаАвтомобили.СуммаВсего КАК СуммаАвтомобилей,
	|		0 КАК СуммаДопОборудования
	|	ИЗ
	|		Документ.РеализацияАвтомобилей.Автомобили КАК ТаблицаАвтомобили
	|	ГДЕ
	|		ТаблицаАвтомобили.Ссылка=&Ссылка
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		0,
	|		ТаблицаТовары.СуммаВсего
	|	ИЗ
	|		Документ.РеализацияАвтомобилей.Товары КАК ТаблицаТовары
	|	ГДЕ
	|		ТаблицаТовары.Ссылка=&Ссылка) КАК СуммыТаблиц
	|;
	|
	|ВЫБРАТЬ
	|	Док.Ссылка КАК Ссылка,
	|	Док.Дата КАК Дата,
	|	Док.ВалютаДокумента КАК ВалютаДокумента,
	|	Док.КурсДокумента КАК КурсДокумента,
	|	Док.ТипЦен КАК ТипЦен,
	|	Док.ХозОперация КАК ХозОперация,
	|	Док.КурсВалютыУпр КАК КурсВалютыУпр,
	|	Док.КурсВалютыВзаиморасчетов КАК КурсВалютыВзаиморасчетов,
	|	Док.МоментВремени КАК МоментВремени,
	|	Док.ПодразделениеКомпании КАК ПодразделениеКомпании,
	/////////// ПРИВАТ ////////////
	|	Док.СкладКомпании КАК СкладКомпании,
	|	Док.Ссылка КАК ДокументПродажи,
	|	Док.Контрагент КАК Контрагент,
	|	Док.ДоговорВзаиморасчетов КАК ДоговорВзаиморасчетов,
	|	Док.СуммаДокумента КАК СуммаДокумента,
	|	Док.ДокументОснование КАК ДокументОснование,
	|	ЕСТЬNULL(СуммыТаблиц.СуммаАвтомобилей, 0) КАК СуммаАвтомобилей,
	|	ЕСТЬNULL(СуммыТаблиц.СуммаДопОборудования, 0) КАК СуммаДопОборудования
	|ИЗ
	|	Документ.РеализацияАвтомобилей КАК Док
	|ЛЕВОЕ СОЕДИНЕНИЕ
	|	СуммыТаблиц КАК СуммыТаблиц
	|ПО
	|	ИСТИНА
	|ГДЕ
	|	Док.Ссылка=&Ссылка
	|");
	Запрос.УстановитьПараметр("Ссылка",ДокументСсылка);
	Выборка=Запрос.Выполнить().Выбрать(); Выборка.Следующий();
	
	Возврат Выборка;
КонецФункции

// формирует движения документа по партионным регистрам
// Возвращает Истина - все хорошо, ложь - чего-то не так
Функция ПровестиПоПартиям(Режим,ДокументСсылка) Экспорт
	Отказ=Ложь;
	
	// определим необходимость формирования корректирующих проводок
	ВедетсяБалансПоПодразделению = (Константы.СпособВеденияБаланса.Получить() = Перечисления.СпособВеденияБаланса.ПоПодразделению);
	
	// получим шапку документа
	ШапкаДокумента=ПолучитьШапкуДокумента(ДокументСсылка);
	
	//Если было отложенное проведение по партиям, то :
	//Очистим возможные движения по регистру комплектации автомобилей 
	НаборЗаписейПартионногоРегистра=РегистрыНакопления.КомплектацияАвтомобилей.СоздатьНаборЗаписей();
	НаборЗаписейПартионногоРегистра.Отбор.Регистратор.Значение=ШапкаДокумента.Ссылка;
	НаборЗаписейПартионногоРегистра.Отбор.Регистратор.Использование=Истина;
	НаборЗаписейПартионногоРегистра.Записать();
	
	// проверим, если подразделение проводиться по партиям "отложено", то дальше не идем
	НаборЗаписейДопроведениеПоПартиям=Движения.ДопроведениеПоПартиям;
	НаборЗаписейДопроведениеПоПартиям.ДокументОбъект=ЭтотОбъект;
	НаборЗаписейДопроведениеПоПартиям.ШапкаДокумента=ШапкаДокумента;
	Отказ=НЕ НаборЗаписейДопроведениеПоПартиям.Зафиксировать() ИЛИ Отказ;
	
	//Спишем оборудование автомобиля
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	|	РеализацияАвтомобилейАвтомобили.Автомобиль
	|ИЗ
	|	Документ.РеализацияАвтомобилей.Автомобили КАК РеализацияАвтомобилейАвтомобили
	|ГДЕ
	|	РеализацияАвтомобилейАвтомобили.Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Ссылка",ШапкаДокумента.Ссылка);
	ВыборкаАвтомобили=Запрос.Выполнить().Выбрать();
	НаборЗаписейКомплектацияАвтомобилей=Движения.КомплектацияАвтомобилей;
	Пока ВыборкаАвтомобили.Следующий() Цикл
		//Спишем оборудование по документу
		НаборЗаписейКомплектацияАвтомобилей.РежимПроведения=Режим;
		НаборЗаписейКомплектацияАвтомобилей.ДокументОбъект=ЭтотОбъект;
		НаборЗаписейКомплектацияАвтомобилей.РезультатЗапросаПоТоварам=Неопределено;
		НаборЗаписейКомплектацияАвтомобилей.Автомобиль=ВыборкаАвтомобили.Автомобиль;
		НаборЗаписейКомплектацияАвтомобилей.СкладКомпании=ШапкаДокумента.СкладКомпании;
		НаборЗаписейКомплектацияАвтомобилей.ПериодДвижения=ШапкаДокумента.МоментВремени;
		НаборЗаписейКомплектацияАвтомобилей.ТипОборудования="Номенклатура";
		НаборЗаписейКомплектацияАвтомобилей.ШапкаДокумента=ШапкаДокумента;
		Отказ=НЕ НаборЗаписейКомплектацияАвтомобилей.Расход() ИЛИ Отказ;
		//Спишем опции, установленные производителем
		НаборЗаписейКомплектацияАвтомобилей.РежимПроведения=Режим;
		НаборЗаписейКомплектацияАвтомобилей.ДокументОбъект=ЭтотОбъект;
		НаборЗаписейКомплектацияАвтомобилей.РезультатЗапросаПоТоварам=Неопределено;
		НаборЗаписейКомплектацияАвтомобилей.Автомобиль=ВыборкаАвтомобили.Автомобиль;
		НаборЗаписейКомплектацияАвтомобилей.СкладКомпании=ШапкаДокумента.СкладКомпании;
		НаборЗаписейКомплектацияАвтомобилей.ПериодДвижения=ШапкаДокумента.МоментВремени;
		НаборЗаписейКомплектацияАвтомобилей.ТипОборудования="Опции";
		НаборЗаписейКомплектацияАвтомобилей.ШапкаДокумента=ШапкаДокумента;
		Отказ=НЕ НаборЗаписейКомплектацияАвтомобилей.Расход() ИЛИ Отказ;
	КонецЦикла;
	Если НЕ Отказ Тогда
		НаборЗаписейКомплектацияАвтомобилей.Записать();
	КонецЕсли; 
	
	ВалютаРегл=Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить(); 
	СтруктураКурса = обКурсДляВалюты(ВалютаРегл,ШапкаДокумента.МоментВремени);
	КурсРегл	   = СтруктураКурса.Курс / ?(СтруктураКурса.Кратность = 0, 1, СтруктураКурса.Кратность);
	ВалютаУпр=Константы.ВалютаУправленческогоУчетаКомпании.Получить(); 
	Если обЗначениеНеЗаполнено(ШапкаДокумента.КурсВалютыУпр) Тогда
		СтруктураКурса = обКурсДляВалюты(ВалютаУпр,ШапкаДокумента.МоментВремени);
		КурсУпр		   = СтруктураКурса.Курс / ?(СтруктураКурса.Кратность = 0, 1, СтруктураКурса.Кратность);
	Иначе
		КурсУпр        = ШапкаДокумента.КурсВалютыУпр;
	КонецЕсли;
	
	// комиссия
	Если ХозОперация=Справочники.ХозОперации.РеализацияАвтомобилейКомиссия Тогда
		Если НЕ НаборЗаписейДопроведениеПоПартиям.НеПроводитьПартии Тогда
			//А теперь установленное оборудование оприходуем на "Партии товаров отданные"
			НаборЗаписейПартииОтданные = Движения.ПартииТоваровОтданные;
			НаборЗаписейПартииОтданные.ДокументОбъект        = ЭтотОбъект;
			НаборЗаписейПартииОтданные.Контрагент            = ШапкаДокумента.Контрагент;
			НаборЗаписейПартииОтданные.ДоговорВзаиморасчетов = ШапкаДокумента.ДоговорВзаиморасчетов;
			НаборЗаписейПартииОтданные.ПоБазовомуКоличеству  = Ложь;
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
						|	КомплектацияАвтомобилей.Автомобиль КАК Автомобиль,
						|	КомплектацияАвтомобилей.Номенклатура КАК Номенклатура,
						|	КомплектацияАвтомобилей.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
						|	КомплектацияАвтомобилей.СтатусПартии КАК СтатусПартии,
						|	КомплектацияАвтомобилей.Партия КАК Партия,
						|	КомплектацияАвтомобилей.ГТД КАК ГТД,
						|	СУММА(КомплектацияАвтомобилей.Количество) КАК Количество,
						|	СУММА(КомплектацияАвтомобилей.Сумма) КАК Сумма,
						|	СУММА(КомплектацияАвтомобилей.СуммаНДС) КАК СуммаНДС,
						|	СУММА(КомплектацияАвтомобилей.СуммаУпр) КАК СуммаУпр
						|ИЗ
						|	РегистрНакопления.КомплектацияАвтомобилей КАК КомплектацияАвтомобилей
						|ГДЕ
						|	КомплектацияАвтомобилей.Регистратор = &Регистратор
						|	И КомплектацияАвтомобилей.Номенклатура ССЫЛКА Справочник.Номенклатура
						|
						|СГРУППИРОВАТЬ ПО
						|	КомплектацияАвтомобилей.Автомобиль,
						|	КомплектацияАвтомобилей.СтатусПартии,
						|	КомплектацияАвтомобилей.Номенклатура,
						|	КомплектацияАвтомобилей.ХарактеристикаНоменклатуры,
						|	КомплектацияАвтомобилей.Партия,
						|	КомплектацияАвтомобилей.ГТД
						|";
			Запрос.УстановитьПараметр("Регистратор",ШапкаДокумента.Ссылка);
			НаборЗаписейПартииОтданные.РезультатЗапросаПоПартиям = Запрос.Выполнить().Выгрузить();
			НаборЗаписейПартииОтданные.РезультатЗапросаПоГТД     = НаборЗаписейКомплектацияАвтомобилей.Выгрузить();
			НаборЗаписейПартииОтданные.ШапкаДокумента            = ШапкаДокумента;
			НаборЗаписейПартииОтданные.ЕстьАвтомобиль            = Истина;
			Отказ = НЕ НаборЗаписейПартииОтданные.Приход() ИЛИ Отказ;
			//А теперь оборудование производителя оприходуем на "Партии товаров отданные"
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
						|	КомплектацияАвтомобилей.Автомобиль КАК Автомобиль,
						|	КомплектацияАвтомобилей.Партия КАК Партия,
						|	КомплектацияАвтомобилей.ГТД КАК ГТД,
						|	СУММА(КомплектацияАвтомобилей.Количество) КАК Количество,
						|	СУММА(КомплектацияАвтомобилей.Сумма) КАК Сумма,
						|	СУММА(КомплектацияАвтомобилей.СуммаУпр) КАК СуммаУпр,
						|	СУММА(КомплектацияАвтомобилей.СуммаНДС) КАК СуммаНДС
						|ИЗ
						|	РегистрНакопления.КомплектацияАвтомобилей КАК КомплектацияАвтомобилей
						|ГДЕ
						|	КомплектацияАвтомобилей.Регистратор = &Регистратор И 
						|	КомплектацияАвтомобилей.Номенклатура ССЫЛКА Справочник.Опции
						|
						|СГРУППИРОВАТЬ ПО
						|	КомплектацияАвтомобилей.Автомобиль,
						|	КомплектацияАвтомобилей.Партия,
						|	КомплектацияАвтомобилей.ГТД
						|";
			Запрос.УстановитьПараметр("Регистратор",ШапкаДокумента.Ссылка);
			Выборка=Запрос.Выполнить().Выбрать();
			НаборЗаписейПартииОтданные=Движения.ПартииТоваровОтданные;
			Пока Выборка.Следующий() Цикл
				НоваяЗапись = НаборЗаписейПартииОтданные.Добавить();
				НоваяЗапись.ВидДвижения                = ВидДвиженияНакопления.Приход;
				НоваяЗапись.Период                     = ШапкаДокумента.Дата;
				НоваяЗапись.Регистратор                = ШапкаДокумента.Ссылка;
				НоваяЗапись.ДокументПередачи           = ШапкаДокумента.Ссылка;
				НоваяЗапись.Автомобиль                 = Выборка.Автомобиль;
				НоваяЗапись.Партия                     = Выборка.Партия;
				НоваяЗапись.ГТД                        = Выборка.ГТД;
				НоваяЗапись.Контрагент                 = ШапкаДокумента.Контрагент;
				НоваяЗапись.ДоговорВзаиморасчетов      = ШапкаДокумента.ДоговорВзаиморасчетов;
				НоваяЗапись.Номенклатура               = Справочники.Номенклатура.ОпцияПроизводителя;
				НоваяЗапись.ХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
				НоваяЗапись.ХозОперация                = ШапкаДокумента.ХозОперация;
				НоваяЗапись.Количество                 = Выборка.Количество;
				НоваяЗапись.Сумма                      = Выборка.Сумма;
				НоваяЗапись.СуммаУпр                   = Выборка.СуммаУпр;
				НоваяЗапись.СуммаНДС                   = Выборка.СуммаНДС;
				НоваяЗапись.СуммаСебестоимостиУпр      = Выборка.СуммаУпр;
				НоваяЗапись.СуммаСебестоимостиРегл     = Выборка.Сумма;
			КонецЦикла;
		КонецЕсли;
	Иначе
		Если НЕ НаборЗаписейДопроведениеПоПартиям.НеПроводитьПартии Тогда
			// спишем реализованное комиссионное оборудование, установленное нами
			НаборЗаписейРеализованныеТовары = Движения.РеализованныеТовары;
			НаборЗаписейРеализованныеТовары.ДокументОбъект        = ЭтотОбъект;
			НаборЗаписейРеализованныеТовары.Контрагент            = ШапкаДокумента.Контрагент;
			НаборЗаписейРеализованныеТовары.ДоговорВзаиморасчетов = ШапкаДокумента.ДоговорВзаиморасчетов;
			Запрос=Новый Запрос;
			Запрос.Текст="ВЫБРАТЬ
			             |	КомплектацияАвтомобилей.Автомобиль КАК Автомобиль,
			             |	КомплектацияАвтомобилей.Номенклатура КАК Номенклатура,
			             |	КомплектацияАвтомобилей.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
			             |	КомплектацияАвтомобилей.Партия КАК Партия,
			             |	КомплектацияАвтомобилей.СтатусПартии КАК СтатусПартии,
			             |	СУММА(КомплектацияАвтомобилей.Количество) КАК Количество,
			             |	СУММА(КомплектацияАвтомобилей.Сумма) КАК Сумма,
			             |	СУММА(КомплектацияАвтомобилей.СуммаУпр) КАК СуммаУпр
			             |ИЗ
			             |	РегистрНакопления.КомплектацияАвтомобилей КАК КомплектацияАвтомобилей
			             |ГДЕ
			             |	КомплектацияАвтомобилей.Регистратор = &Регистратор
			             |	И КомплектацияАвтомобилей.СтатусПартии = &СтатусПартииТоварПринятыйКомиссия
			             |	И КомплектацияАвтомобилей.Номенклатура ССЫЛКА Справочник.Номенклатура
			             |
			             |СГРУППИРОВАТЬ ПО
			             |	КомплектацияАвтомобилей.Автомобиль,
			             |	КомплектацияАвтомобилей.Номенклатура,
			             |	КомплектацияАвтомобилей.СтатусПартии,
			             |	КомплектацияАвтомобилей.ХарактеристикаНоменклатуры,
			             |	КомплектацияАвтомобилей.Партия";
			Запрос.УстановитьПараметр("Регистратор",ШапкаДокумента.Ссылка);
			Запрос.УстановитьПараметр("СтатусПартииТоварПринятыйКомиссия",Перечисления.СтатусыПартий.ТоварПринятыйКомиссия);
			НаборЗаписейРеализованныеТовары.РезультатЗапросаПоПартиям = Запрос.Выполнить().Выгрузить();
			НаборЗаписейРеализованныеТовары.РезультатЗапросаПоТоварам = Неопределено;
			НаборЗаписейРеализованныеТовары.ПоБазовомуКоличеству      = Ложь;
			НаборЗаписейРеализованныеТовары.ЕстьАвтомобиль            = Истина;
			НаборЗаписейРеализованныеТовары.РезультатЗапросаПоГТД     = НаборЗаписейКомплектацияАвтомобилей.Выгрузить();
			НаборЗаписейРеализованныеТовары.ШапкаДокумента            = ШапкаДокумента;
			Отказ=НЕ НаборЗаписейРеализованныеТовары.Приход() ИЛИ Отказ;
			// продажи оборудования, установленного нами
			НаборЗаписейПродажи=Движения.Продажи;
			НаборЗаписейПродажи.ДокументОбъект=ЭтотОбъект;
			НаборЗаписейПродажи.СкладКомпании=ШапкаДокумента.СкладКомпании;
			НаборЗаписейПродажи.ДокументПродажи=ШапкаДокумента.ДокументПродажи;
			НаборЗаписейПродажи.Сторно=Ложь;
			НаборЗаписейПродажи.Покупатель=ШапкаДокумента.Контрагент;
			НаборЗаписейПродажи.РезультатЗапросаПоТоварам=Неопределено;
			НаборЗаписейПродажи.ДоговорВзаиморасчетов=ШапкаДокумента.ДоговорВзаиморасчетов;
			НаборЗаписейПродажи.ПодразделениеКомпании=ШапкаДокумента.ПодразделениеКомпании;
			НаборЗаписейПродажи.Комиссия=Ложь;
			НаборЗаписейПродажи.Автомобиль = Неопределено;
			НаборЗаписейПродажи.ЕстьАвтомобиль = Истина;
			НаборЗаписейПродажи.ПоБазовомуКоличеству=Ложь;
			Запрос=Новый Запрос;
			Запрос.Текст="ВЫБРАТЬ
			             |	КомплектацияАвтомобилей.ВидДвижения КАК ВидДвижения,
			             |	КомплектацияАвтомобилей.Автомобиль КАК Автомобиль,
			             |	КомплектацияАвтомобилей.Номенклатура КАК Номенклатура,
			             |	КомплектацияАвтомобилей.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
			             |	КомплектацияАвтомобилей.Партия КАК Партия,
			             |	КомплектацияАвтомобилей.СтатусПартии КАК СтатусПартии,
			             |	КомплектацияАвтомобилей.ГТД КАК ГТД,
			             |	СУММА(КомплектацияАвтомобилей.Количество) КАК Количество,
			             |	СУММА(КомплектацияАвтомобилей.Сумма) КАК Сумма,
			             |	СУММА(КомплектацияАвтомобилей.СуммаУпр) КАК СуммаУпр,
			             |	СУММА(КомплектацияАвтомобилей.СуммаНДС) КАК СуммаНДС
			             |ИЗ
			             |	РегистрНакопления.КомплектацияАвтомобилей КАК КомплектацияАвтомобилей
			             |ГДЕ
			             |	КомплектацияАвтомобилей.Регистратор = &Регистратор
			             |	И КомплектацияАвтомобилей.Номенклатура ССЫЛКА Справочник.Номенклатура
			             |
			             |СГРУППИРОВАТЬ ПО
			             |	КомплектацияАвтомобилей.Автомобиль,
			             |	КомплектацияАвтомобилей.Номенклатура,
			             |	КомплектацияАвтомобилей.ВидДвижения,
			             |	КомплектацияАвтомобилей.ХарактеристикаНоменклатуры,
			             |	КомплектацияАвтомобилей.СтатусПартии,
			             |	КомплектацияАвтомобилей.Партия,
			             |	КомплектацияАвтомобилей.ГТД
						 |";
			Запрос.УстановитьПараметр("Регистратор",ШапкаДокумента.Ссылка);
			НаборЗаписейПродажи.РезультатЗапросаПоПартиям=Запрос.Выполнить().Выгрузить();
			НаборЗаписейПродажи.РезультатЗапросаПоТоварам=Неопределено;
			НаборЗаписейПродажи.ШапкаДокумента=ШапкаДокумента;
			Отказ=НЕ НаборЗаписейПродажи.Приход() ИЛИ Отказ;
		КонецЕсли;
		//Доход от начисления дебиторской задолженности по отгруженным автомобилям
		Если НаборЗаписейДопроведениеПоПартиям.НеПроводитьПартии Тогда
			
			НаборЗаписейДоходыИРасходы = Движения.ДоходыИРасходы;
			НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
			Если ВедетсяБалансПоПодразделению Тогда
				НаборЗаписейДоходыИРасходы.Подразделение      = ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение;
			КонецЕсли;
			НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СебестоимостьНеоприходованныхПартий;
			НаборЗаписейДоходыИРасходы.ВУпрВалюте             = (ШапкаДокумента.ВалютаДокумента=Константы.ВалютаУправленческогоУчетаКомпании.Получить());
			НаборЗаписейДоходыИРасходы.Доход                  = ШапкаДокумента.СуммаДокумента;
			НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
			Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
		Иначе
			Если ШапкаДокумента.СуммаАвтомобилей>0 Тогда
				НаборЗаписейДоходыИРасходы = Движения.ДоходыИРасходы;
				НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
				Если ВедетсяБалансПоПодразделению Тогда
					НаборЗаписейДоходыИРасходы.Подразделение      = ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение;
				КонецЕсли;
				НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.НачислениеДебиторскойЗадолженностиПоАвтомобилям;
				НаборЗаписейДоходыИРасходы.ВУпрВалюте             = (ШапкаДокумента.ВалютаДокумента=Константы.ВалютаУправленческогоУчетаКомпании.Получить());
				НаборЗаписейДоходыИРасходы.Доход                  = ШапкаДокумента.СуммаАвтомобилей;
				НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
				Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
			КонецЕсли;
			Если ШапкаДокумента.СуммаДопОборудования>0 Тогда
				НаборЗаписейДоходыИРасходы = Движения.ДоходыИРасходы;
				НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
				Если ВедетсяБалансПоПодразделению Тогда
					НаборЗаписейДоходыИРасходы.Подразделение      = ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение;
				КонецЕсли;
				НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.НачислениеДебиторскойЗадолженностиПоТовару;
				НаборЗаписейДоходыИРасходы.ВУпрВалюте             = (ШапкаДокумента.ВалютаДокумента=Константы.ВалютаУправленческогоУчетаКомпании.Получить());
				НаборЗаписейДоходыИРасходы.Доход                  = ШапкаДокумента.СуммаДопОборудования;
				НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
				Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если (ХозОперация=Справочники.ХозОперации.РеализацияАвтомобилейКомиссия И
		  НаборЗаписейДопроведениеПоПартиям.НеПроводитьПартии) ИЛИ 
		  ХозОперация=Справочники.ХозОперации.РеализацияАвтомобилей Тогда
		//доходы и расходы
		СебестоимостьАвтомобилейУпр  = 0;
		СебестоимостьОборудованияУпр = 0;
		Запрос=Новый Запрос("ВЫБРАТЬ
							|	ЕСТЬNULL(СУММА(ОстаткиАвтомобилей.СуммаУпр), 0) КАК СуммаУпр
							|ИЗ
							|	РегистрНакопления.ОстаткиАвтомобилей КАК ОстаткиАвтомобилей
							|ГДЕ
							|	ОстаткиАвтомобилей.Регистратор = &Регистратор
							|	И ОстаткиАвтомобилей.СтатусПартии = ЗНАЧЕНИЕ(Перечисление.СтатусыПартий.ТоварКупленный)");
		Запрос.УстановитьПараметр("Регистратор",ШапкаДокумента.Ссылка);
		Выборка=Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			СебестоимостьАвтомобилейУпр = Выборка.СуммаУпр;
		КонецЕсли;
		Запрос=Новый Запрос("ВЫБРАТЬ
		                    |	ЕСТЬNULL(СУММА(КомплектацияАвтомобилей.СуммаУпр), 0) КАК СуммаУпр
		                    |ИЗ
		                    |	РегистрНакопления.КомплектацияАвтомобилей КАК КомплектацияАвтомобилей
		                    |ГДЕ
		                    |	КомплектацияАвтомобилей.Регистратор = &Регистратор
		                    |	И КомплектацияАвтомобилей.СтатусПартии = ЗНАЧЕНИЕ(Перечисление.СтатусыПартий.ТоварКупленный)");
		Запрос.УстановитьПараметр("Регистратор",ШапкаДокумента.Ссылка);
		Выборка=Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			СебестоимостьОборудованияУпр = Выборка.СуммаУпр;
		КонецЕсли;
		Если НаборЗаписейДопроведениеПоПартиям.НеПроводитьПартии Тогда
			СебестоимостьУпр = СебестоимостьАвтомобилейУпр + СебестоимостьОборудованияУпр;
			Если СебестоимостьУпр<>0 Тогда
				//сумма себестоимости списанных автомобилей
				НаборЗаписейДоходыИРасходы=Движения.ДоходыИРасходы;
				НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
				НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
				Если ВедетсяБалансПоПодразделению Тогда
					НаборЗаписейДоходыИРасходы.Подразделение      = ШапкаДокумента.СкладКомпании.Подразделение;
				КонецЕсли;
				НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СебестоимостьНеоприходованныхПартий;
				НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
				НаборЗаписейДоходыИРасходы.Расход                 = СебестоимостьУпр;
				Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
			КонецЕсли;
		Иначе
			
			// определим необходимость формирования корректирующих проводок
			// получим шапку документа
			ПодразделениеСклад = обПолучитьБалансовоеПодразделение(ШапкаДокумента.СкладКомпании.Подразделение);
			ПодразделениеДоговорВзаиморасчетов = обПолучитьБалансовоеПодразделение(ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение);
			БалансовыеПодразделенияНеРавны = (ПодразделениеДоговорВзаиморасчетов<>ПодразделениеСклад);
			
			Если СебестоимостьАвтомобилейУпр<>0 Тогда
				//сумма себестоимости списанных автомобилей
				НаборЗаписейДоходыИРасходы=Движения.ДоходыИРасходы;
				НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
				НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
				Если ВедетсяБалансПоПодразделению Тогда
					НаборЗаписейДоходыИРасходы.Подразделение      = ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение;
				КонецЕсли;
				НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СебестоимостьАвтомобилей;
				НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
				НаборЗаписейДоходыИРасходы.Расход                 = СебестоимостьАвтомобилейУпр;
				Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
				
				//Если балансовые подразделение договора и подразделения склад не равны, то сформируем корректирующие проводки
				Если ВедетсяБалансПоПодразделению и БалансовыеПодразделенияНеРавны Тогда
					НаборЗаписейДоходыИРасходы = Движения.ДоходыИРасходы;
					НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
					НаборЗаписейДоходыИРасходы.Подразделение          = ШапкаДокумента.СкладКомпании.Подразделение;
					НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
					НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.КорректировкаБалансаПоПодразделениям;
					НаборЗаписейДоходыИРасходы.Доход                  = СебестоимостьАвтомобилейУпр;
					Отказ=НЕ НаборЗаписейДоходыИРасходы.Расход() ИЛИ Отказ;
					
					НаборЗаписейДоходыИРасходы = Движения.ДоходыИРасходы;
					НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
					НаборЗаписейДоходыИРасходы.Подразделение          = ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение;
					НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
					НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.КорректировкаБалансаПоПодразделениям;
					НаборЗаписейДоходыИРасходы.Доход                  = СебестоимостьАвтомобилейУпр;
					Отказ = НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
				КонецЕсли;
				
			КонецЕсли;
			
			Если СебестоимостьОборудованияУпр<>0 Тогда
				//сумма себестоимости списанных автомобилей
				НаборЗаписейДоходыИРасходы=Движения.ДоходыИРасходы;
				НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
				НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
				Если ВедетсяБалансПоПодразделению Тогда
					НаборЗаписейДоходыИРасходы.Подразделение      = ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение;
				КонецЕсли;
				НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.Себестоимость;
				НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
				НаборЗаписейДоходыИРасходы.Расход                 = СебестоимостьОборудованияУпр;
				Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
				
				//Если балансовые подразделение договора и подразделения склад не равны, то сформируем корректирующие проводки
				Если ВедетсяБалансПоПодразделению и БалансовыеПодразделенияНеРавны Тогда
					НаборЗаписейДоходыИРасходы = Движения.ДоходыИРасходы;
					НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
					НаборЗаписейДоходыИРасходы.Подразделение          = ШапкаДокумента.СкладКомпании.Подразделение;
					НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
					НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.КорректировкаБалансаПоПодразделениям;
					НаборЗаписейДоходыИРасходы.Доход                  = СебестоимостьОборудованияУпр;
					Отказ=НЕ НаборЗаписейДоходыИРасходы.Расход() ИЛИ Отказ;
					
					НаборЗаписейДоходыИРасходы = Движения.ДоходыИРасходы;
					НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
					НаборЗаписейДоходыИРасходы.Подразделение          = ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение;
					НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
					НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.КорректировкаБалансаПоПодразделениям;
					НаборЗаписейДоходыИРасходы.Доход                  = СебестоимостьОборудованияУпр;
					Отказ = НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	Возврат НЕ Отказ;
КонецФункции

//Добавим оборудование автомобиля
Процедура ДобавитьОборудованиеАвтомобиля(Знач Автомобиль, ИзменятьЦену) Экспорт
	ДокументОбъектСтруктура=Новый Структура();
	ДокументОбъектСтруктура.Вставить("Ссылка",Ссылка);
	ДокументОбъектСтруктура.Вставить("Дата",Дата);
	ДокументОбъектСтруктура.Вставить("Автомобили",Автомобили.Выгрузить());
	ДокументОбъектСтруктура.Вставить("Товары",Товары.Выгрузить());
	зфЗащищенныеФункцииСервер.РеализацияАвтомобилейДобавитьОборудованиеАвтомобиля(ДокументОбъектСтруктура,Автомобиль);
	
	Если НЕ ДокументОбъектСтруктура.Свойство("ТаблицаТоваров") Тогда
		Возврат;
	КонецЕсли; 
	
	Товары.Очистить();
	Товары.Загрузить(ДокументОбъектСтруктура.Товары);
	
	Если ИзменятьЦену Тогда
		ВалютаРегламентированногоУчетаОрганизаций=Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
		Если ВалютаДокумента<>ВалютаРегламентированногоУчетаОрганизаций Тогда
			ВалютаУпр=Константы.ВалютаУправленческогоУчетаКомпании.Получить(); 
			Если обЗначениеНеЗаполнено(КурсВалютыУпр) Тогда
				СтруктураКурса = обКурсДляВалюты(ВалютаУпр,Дата);
				КурсУпр = СтруктураКурса.Курс / ?(СтруктураКурса.Кратность = 0, 1, СтруктураКурса.Кратность);
			Иначе
				КурсУпр = КурсВалютыУпр;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	Для каждого СтрокаТоваров Из ДокументОбъектСтруктура.ТаблицаТоваров Цикл
		СтрокиОборудования=Товары.НайтиСтроки(Новый Структура("ИдентификаторАвтомобиля,Номенклатура,ХарактеристикаНоменклатуры",ДокументОбъектСтруктура.ИдентификаторАвтомобиля,СтрокаТоваров.Номенклатура,СтрокаТоваров.ХарактеристикаНоменклатуры));
		Если СтрокиОборудования.Количество()=0 Тогда 
			НоваяСтрокаТоваров=Товары.Добавить();
			НоваяСтрокаТоваров.ИдентификаторАвтомобиля=ДокументОбъектСтруктура.ИдентификаторАвтомобиля;
			НоваяСтрокаТоваров.Номенклатура=СтрокаТоваров.Номенклатура;
			НоваяСтрокаТоваров.ХарактеристикаНоменклатуры=СтрокаТоваров.ХарактеристикаНоменклатуры;
			ОбработкаРеквизита("Товары.Номенклатура",НоваяСтрокаТоваров);
		Иначе
			НоваяСтрокаТоваров=СтрокиОборудования[0];
		КонецЕсли;
		НоваяСтрокаТоваров.Количество = СтрокаТоваров.Количество/?(обЗначениеНеЗаполнено(НоваяСтрокаТоваров.Коэффициент),1,НоваяСтрокаТоваров.Коэффициент);
		Если ИзменятьЦену Тогда
			Если ВалютаДокумента=ВалютаРегламентированногоУчетаОрганизаций Тогда
				НоваяСтрокаТоваров.СуммаВсего=СтрокаТоваров.СуммаПродажи;
			Иначе
				НоваяСтрокаТоваров.СуммаВсего=обПересчет(СтрокаТоваров.СуммаПродажиУпр,ВалютаУпр,КурсУпр,ВалютаДокумента,КурсДокумента);
			КонецЕсли;
		КонецЕсли;
		ОбработкаРеквизита("Товары.СуммаВсего",НоваяСтрокаТоваров);
	КонецЦикла;
	
КонецПроцедуры

// Расчет суммы документа
Функция РассчитатьСуммуВсего()Экспорт
	Возврат Автомобили.Итог("СуммаВсего")+Товары.Итог("СуммаВсего");
КонецФункции

// Обработка изменения реквизитов документа
// Параметры
//  Имя			– Строка			– Имя реквизита документа с полным путем (например Товары.Номенклатура).
//  ЭтаФорма	– Форма				– Ссылка на форму документа. Если значение неопределено,
//									  производится программная обработка реквизитов.
//  ТекСтрока	– СтрокаТабличнойЧасти – Ссылка на строку табличной части документа, реквизит которой обрабатывается.
//										 Имеет смысл только для табличных частей документов.
//  ДопПараметры– Структура			– Структура, содержащая дополнительные параметры обработки реквизита.
// Возвращаемое значение:
//   Булево   – Результат выполнения обработки.
Функция ОбработкаРеквизита(Имя,ТекСтрока=Неопределено,ЭтаФорма=Неопределено,ДопПараметры=Неопределено) Экспорт
	Результат=Истина;
	
	// ОБРАБОТКА РЕКВИЗИТОВ ДОКУМЕНТА
	Если Имя="ВалютаДокумента" Тогда
		Результат=дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры) И Результат;
		Попытка
			ТребуетсяПересчет=ДопПараметры.ТребуетсяПересчет;
		Исключение
			ТребуетсяПересчет=Ложь;
		КонецПопытки; 
		Если ТребуетсяПересчет И (НЕ обЗначениеНеЗаполнено(ТекущаяВалютаДокумента)) Тогда
			Для каждого СтрокаТЧ Из Автомобили Цикл
				НоваяЦена=обПересчет(СтрокаТЧ.Цена,ТекущаяВалютаДокумента,ТекущийКурсДокумента,ВалютаДокумента,КурсДокумента);
				Если НоваяЦена<>СтрокаТЧ.Цена Тогда
					СтрокаТЧ.Цена=НоваяЦена;
					Результат=ОбработкаРеквизита("Автомобили.Цена",СтрокаТЧ,ЭтаФорма,ДопПараметры) И Результат;
				КонецЕсли;
			КонецЦикла; 
		КонецЕсли; 
		ТекущаяВалютаДокумента=ВалютаДокумента;
		ТекущийКурсДокумента=КурсДокумента;
		Результат = ЭтотОбъект.ОбработкаРеквизита("РассчитатьСкидкиАвтомобили", ТекСтрока, ЭтаФорма, ДопПараметры) И Результат;
		
	ИначеЕсли Имя = "ТипЦен" Тогда
		
		ТребуетсяПересчет = Истина;
		Если ДопПараметры <> Неопределено Тогда
			Если НЕ ДопПараметры.Свойство("ТребуетсяПересчет", ТребуетсяПересчет) Тогда
				ТребуетсяПересчет = Истина;
			КонецЕсли;
		КонецЕсли;
		
		// пересчитываем
		
		Если ТребуетсяПересчет Тогда
			
			Запрос = Новый Запрос();
			Запрос.Текст = "
			|ВЫБРАТЬ
			|	ВЫРАЗИТЬ(ТаблицаАвтомобилей.Автомобиль КАК Справочник.Автомобили) КАК Автомобиль
			|ПОМЕСТИТЬ
			|	ТаблицаАвтомобилей
			|ИЗ
			|	&ТаблицаАвтомобилей КАК ТаблицаАвтомобилей
			|ГДЕ
			|	ТаблицаАвтомобилей.ЗаказНаАвтомобиль = ЗНАЧЕНИЕ(Документ.ЗаказНаАвтомобиль.ПустаяСсылка)
			|ИНДЕКСИРОВАТЬ ПО
			|	Автомобиль
			|;
			|
			|ВЫБРАТЬ
			|	ВЫРАЗИТЬ(ТаблицаАвтомобилей.Автомобиль КАК Справочник.Автомобили) КАК Автомобиль,
			|	ТаблицаАвтомобилей.ЗаказНаАвтомобиль КАК ЗаказНаАвтомобиль
			|ПОМЕСТИТЬ
			|	ТаблицаЗаказанныхАвтомобилей
			|ИЗ
			|	&ТаблицаАвтомобилей КАК ТаблицаАвтомобилей
			|ГДЕ
			|	НЕ (ТаблицаАвтомобилей.ЗаказНаАвтомобиль = ЗНАЧЕНИЕ(Документ.ЗаказНаАвтомобиль.ПустаяСсылка))
			|ИНДЕКСИРОВАТЬ ПО
			|	Автомобиль
			|;
			|
			|ВЫБРАТЬ
			|	0 КАК Источник,
			|	КомплектацияАвтомобилейОстатки.Автомобиль КАК Автомобиль,
			|	КомплектацияАвтомобилейОстатки.Автомобиль.ВариантКомплектации КАК ВариантКомплектации,
			|	КомплектацияАвтомобилейОстатки.Автомобиль.Модель КАК Модель,
			|	NULL КАК ЗаказНаАвтомобиль,
			|	NULL ВалютаДокумента,
			|	1 КАК КурсДокумента,
			|	0 КАК ЦенаАвтомобиля,
			|	КомплектацияАвтомобилейОстатки.Номенклатура КАК Опция,
			|	КомплектацияАвтомобилейОстатки.КоличествоОстаток КАК Количество,
			|	0 КАК Сумма
			|ИЗ
			|	РегистрНакопления.КомплектацияАвтомобилей.Остатки(&НаМомент, Номенклатура ССЫЛКА Справочник.Опции И Автомобиль В (ВЫБРАТЬ Автомобиль ИЗ ТаблицаАвтомобилей)) КАК КомплектацияАвтомобилейОстатки
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	1,
			|	ТаблицаЗаказанныхАвтомобилей.Автомобиль,
			|	ТаблицаЗаказанныхАвтомобилей.Автомобиль.ВариантКомплектации,
			|	ТаблицаЗаказанныхАвтомобилей.Автомобиль.Модель,
			|	ТаблицаЗаказанныхАвтомобилей.ЗаказНаАвтомобиль,
			|	ЗаказыНаАвтомобиль.ВалютаДокумента,
			|	ЗаказыНаАвтомобиль.КурсДокумента,
			|	ЗаказыНаАвтомобиль.ЦенаАвтомобиля,
			|	ЗаказНаАвтомобильОпции.Опция,
			|	ЕСТЬNULL(ЗаказНаАвтомобильОпции.Количество, 0),
			|	ЕСТЬNULL(ЗаказНаАвтомобильОпции.Сумма, 0)
			|
			|ИЗ
			|	ТаблицаЗаказанныхАвтомобилей КАК ТаблицаЗаказанныхАвтомобилей
			|ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаАвтомобиль КАК ЗаказыНаАвтомобиль
			|ПО
			|	ТаблицаЗаказанныхАвтомобилей.ЗаказНаАвтомобиль = ЗаказыНаАвтомобиль.Ссылка
			|ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаАвтомобиль.Опции КАК ЗаказНаАвтомобильОпции
			|ПО
			|	ТаблицаЗаказанныхАвтомобилей.ЗаказНаАвтомобиль = ЗаказНаАвтомобильОпции.Ссылка
			|
			|УПОРЯДОЧИТЬ ПО
			|	Автомобиль
			|
			|ИТОГИ
			|	МАКСИМУМ(ЗаказНаАвтомобиль),
			|	МАКСИМУМ(Источник),
			|	МАКСИМУМ(ЦенаАвтомобиля),
			|	МАКСИМУМ(ВалютаДокумента),
			|	МАКСИМУМ(КурсДокумента),
			|	СУММА(Количество),
			|	СУММА(Сумма)
			|ПО
			|	Автомобиль,
			|	Опция";
			
			Запрос.УстановитьПараметр("ТаблицаАвтомобилей", Автомобили);
			Запрос.УстановитьПараметр("НаМомент", ?(Ссылка.Пустая(),Новый МоментВремени(КонецДня(Дата)),Новый Граница(Дата,ВидГраницы.Исключая)));
			
			ВыборкаАвтомобилей = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаАвтомобилей.Следующий() Цикл
				
				СтруктураОтбора = Новый Структура("Автомобиль", ВыборкаАвтомобилей.Автомобиль);
				Если ВыборкаАвтомобилей.Источник = 1 Тогда
					СтруктураОтбора.Вставить("ЗаказНаАвтомобиль", ВыборкаАвтомобилей.ЗаказНаАвтомобиль);
				КонецЕсли;
				
				СтрокиАвтомобиля = Автомобили.НайтиСтроки(СтруктураОтбора);
				
				Для Каждого СтрокаАвтомобиля Из СтрокиАвтомобиля Цикл
					
					Цена = 0;
					ЦенаОпций = 0;
					Если ВыборкаАвтомобилей.Источник = 1 Тогда
						
						Если ВыборкаАвтомобилей.ЦенаАвтомобиля = 0 Тогда
							Цена = 0;
						Иначе
							Цена = ВыборкаАвтомобилей.ЦенаАвтомобиля;
							Если НЕ ВыборкаАвтомобилей.ВалютаДокумента = ТекущаяВалютаДокумента Тогда
								Цена = обПересчет(Цена, ВыборкаАвтомобилей.ВалютаДокумента, ВыборкаАвтомобилей.КурсДокумента, ТекущаяВалютаДокумента, ТекущийКурсДокумента);
							КонецЕсли;
						КонецЕсли;
						
						Если ВыборкаАвтомобилей.Сумма = 0 Тогда
							ЦенаОпций = 0;
						Иначе
							ЦенаОпций = ВыборкаАвтомобилей.Сумма;
							Если НЕ ВыборкаАвтомобилей.ВалютаДокумента = ТекущаяВалютаДокумента Тогда
								ЦенаОпций = обПересчет(ЦенаОпций, ВыборкаАвтомобилей.ВалютаДокумента, ВыборкаАвтомобилей.КурсДокумента, ТекущаяВалютаДокумента, ТекущийКурсДокумента);
							КонецЕсли; 
						КонецЕсли;
						
					КонецЕсли;
					
					Если Цена = 0 Тогда
						Цена = обПолучитьЦену(ТипЦен, Новый Структура("Автомобиль, ВариантКомплектации", ВыборкаАвтомобилей.Автомобиль, Справочники.ВариантыКомплектации.ПустаяСсылка()), ?(Ссылка.Пустая(), Дата, МоментВремени()),, ТекущаяВалютаДокумента, ТекущийКурсДокумента);
					КонецЕсли;
					
					Если ЦенаОпций = 0 Тогда
						
						ВыборкаОпций = ВыборкаАвтомобилей.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
						Пока ВыборкаОпций.Следующий() Цикл
							Если ВыборкаОпций.Опция = Null Тогда
								Продолжить;
							КонецЕсли;
							ЦенаОпций = ЦенаОпций+(обПолучитьЦену(ТипЦен, Новый Структура("Автомобиль, ВариантКомплектации, Опция", ВыборкаАвтомобилей.Модель, ВыборкаАвтомобилей.ВариантКомплектации, ВыборкаОпций.Опция), ?(Ссылка.Пустая(), Дата, МоментВремени()),,ТекущаяВалютаДокумента, ТекущийКурсДокумента)*ВыборкаОпций.Количество);
						КонецЦикла;
						
					КонецЕсли;
					
					Цена = Цена + ЦенаОпций;
					
					СтрокаАвтомобиля.Цена = Цена;
					ОбработкаРеквизита("Автомобили.Цена", СтрокаАвтомобиля, ЭтаФорма, ДопПараметры);
					
					НайденныеДетали     = Товары.НайтиСтроки(Новый Структура("ИдентификаторАвтомобиля", СтрокаАвтомобиля.ИдентификаторАвтомобиля));
					Модель              = ВыборкаАвтомобилей.Модель;
					ВариантКомплектации = ВыборкаАвтомобилей.ВариантКомплектации;
					ДеталиИзЗаказа = Неопределено;
					Если ВыборкаАвтомобилей.Источник = 1 Тогда
						ДеталиИзЗаказа = ВыборкаАвтомобилей.ЗаказНаАвтомобиль.Товары;
					КонецЕсли;
					
					Для Каждого СтрокаДеталь Из НайденныеДетали Цикл
						
						ТоварИзЗаказа = Неопределено;
						Если ВыборкаАвтомобилей.Источник = 1 Тогда
							ДетальИзЗаказа = ДеталиИзЗаказа.Найти(СтрокаДеталь.Номенклатура, "Номенклатура");
							Если ДетальИзЗаказа = Неопределено Тогда
								СтрокаДеталь.Цена = 0;
							Иначе
								СтрокаДеталь.Цена = ДетальИзЗаказа.Цена;
							КонецЕсли;
						Иначе
							СтрокаДеталь.Цена = 0;
						КонецЕсли;
						
						Если СтрокаДеталь.Цена=0 Тогда
							СтрокаДеталь.Цена = обПолучитьЦену(ТипЦен, СтрокаДеталь.Номенклатура, ?(Ссылка.Пустая(), Дата, МоментВремени()),, ТекущаяВалютаДокумента, ТекущийКурсДокумента);
						КонецЕсли;
						ОбработкаРеквизита("Товары.Цена", СтрокаДеталь, ЭтаФорма, ДопПараметры);
						
					КонецЦикла;
					
				КонецЦикла;
				
			КонецЦикла;
			
		КонецЕсли;
		
	ИначеЕсли Имя="Организация" Тогда
		Результат=дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры);
		// Организация может является плательщиком НДС, а может и нет.. надо обработать ТЧ
		ОсвобожденОтНДС=ПодразделениеКомпании.ОсвобожденОтНДС ИЛИ Организация.ОсвобожденОтНДС;
		Для Каждого СтрокаТЧ Из Автомобили Цикл
			Если ОсвобожденОтНДС Тогда
				СтрокаТЧ.СтавкаНДС=Справочники.СтавкиНДС.БезНДС;
			Иначе
				СтрокаТЧ.СтавкаНДС=Справочники.СтавкиНДС.ОсновнаяСтавкаНДС;
			КонецЕсли; 
			Результат=ОбработкаРеквизита("Автомобили.СтавкаНДС",СтрокаТЧ,ЭтаФорма,ДопПараметры) И Результат;
		КонецЦикла;
		
		ВидимостьПатент = ?(Организация.ВидНалога = Перечисления.ВидыНалогов.ПСН, Истина, Ложь);
		ЭтаФорма.ЭлементыФормы.Патент.Видимость = ВидимостьПатент;
		ЭтаФорма.ЭлементыФормы.ИспользоватьПатент.Видимость = ВидимостьПатент;
		ЭтаФорма.ЭлементыФормы.ИспользоватьПатент.Доступность = ВидимостьПатент;
		ЭтотОбъект.Патент = Неопределено;
		Если ВидимостьПатент Тогда
			ЭтаФорма.ИспользоватьПатент = Ложь;
			ЭтаФорма.ЭлементыФормы.Патент.Доступность = Ложь;
		КонецЕсли;
		
	ИначеЕсли Имя="ПодразделениеКомпании" Тогда
		Результат=дкОбработкаРеквизита(ЭтотОбъект,Имя,,ЭтаФорма,ДопПараметры);
		// Подразделение может является плательщиком НДС, а может и нет.. надо обработать ТЧ
		ОсвобожденОтНДС=ПодразделениеКомпании.ОсвобожденОтНДС ИЛИ Организация.ОсвобожденОтНДС;
		Для Каждого СтрокаТЧ Из Автомобили Цикл
			Если ОсвобожденОтНДС Тогда
				СтрокаТЧ.СтавкаНДС=Справочники.СтавкиНДС.БезНДС;
			Иначе
				СтрокаТЧ.СтавкаНДС=Справочники.СтавкиНДС.ОсновнаяСтавкаНДС;
			КонецЕсли; 
			Результат=ОбработкаРеквизита("Автомобили.СтавкаНДС",СтрокаТЧ,ЭтаФорма,ДопПараметры) И Результат;
		КонецЦикла;
		Результат=ЭтотОбъект.ОбработкаРеквизита("РассчитатьСкидкиАвтомобили",, ЭтаФорма, ДопПараметры) И Результат;
		
	ИначеЕсли Имя="Контрагент" Тогда
		Если ХозОперация = Справочники.ХозОперации.РеализацияАвтомобилейКомиссия Тогда
			//Параметры для подстановки или создания договора контрагента
			Если ДопПараметры=Неопределено Тогда ДопПараметры=Новый Структура; КонецЕсли; 
			ДопПараметры.Вставить("ВидДоговора",Перечисления.ВидыДоговоров.СКомиссионером);
			ДопПараметры.Вставить("ТипЦенПокупки",Справочники.ТипыЦен.ПустаяСсылка());
			ДопПараметры.Вставить("ТипЦенПродажи",ТипЦен);
		КонецЕсли; 
		Результат=дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры);
		Если (НЕ обЗначениеНеЗаполнено(Контрагент)) И (Заказчик<>Контрагент) Тогда
			Заказчик=Контрагент;
			Результат=ОбработкаРеквизита("Заказчик",ТекСтрока,ЭтаФорма,ДопПараметры) И Результат;
		КонецЕсли; 
		
	ИначеЕсли Имя="Заказчик" Тогда
		Если (НЕ обЗначениеНеЗаполнено(Заказчик)) И (обЗначениеНеЗаполнено(Контрагент)) Тогда
			Контрагент=Заказчик;
			Результат=ОбработкаРеквизита("Контрагент",ТекСтрока,ЭтаФорма,ДопПараметры);
		КонецЕсли; 
		
	ИначеЕсли Имя="ДоговорВзаиморасчетов" Тогда
		Результат=дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры) И Результат;
		// проверим вид договора
		Если ДоговорВзаиморасчетов.Пустая() Тогда
		Иначе
			НеверныйДоговор=Ложь;
			Если ХозОперация=Справочники.ХозОперации.РеализацияАвтомобилей Тогда
				Если ДоговорВзаиморасчетов.ВидДоговора<>Перечисления.ВидыДоговоров.Продажа И
					 ДоговорВзаиморасчетов.ВидДоговора<>Перечисления.ВидыДоговоров.Прочее Тогда
					 НеверныйДоговор=Истина;
				КонецЕсли; 
			ИначеЕсли ХозОперация=Справочники.ХозОперации.РеализацияАвтомобилейКомиссия Тогда
				Если ДоговорВзаиморасчетов.ВидДоговора<>Перечисления.ВидыДоговоров.СКомиссионером И
					 ДоговорВзаиморасчетов.ВидДоговора<>Перечисления.ВидыДоговоров.Прочее Тогда
					 НеверныйДоговор=Истина;
				КонецЕсли; 
			КонецЕсли;
			Если НеверныйДоговор Тогда
				#Если Клиент Тогда
				Предупреждение("Неправильный вид договора !");
				#КонецЕсли
				ДоговорВзаиморасчетов=Неопределено;
				ОбработкаРеквизита("ДоговорВзаиморасчетов",,ЭтаФорма);
				Результат=Ложь;
			КонецЕсли; 
		КонецЕсли;
		// Если у документа есть реквизит СкидкаНаценка, заполним его из Договора 
		Если (НЕ обЗначениеНеЗаполнено(ДоговорВзаиморасчетов.ТипСкидкиНаценки)) И 
			 (СкидкаНаценкаАвтомобили<>ДоговорВзаиморасчетов.ТипСкидкиНаценки) Тогда
			 СкидкаНаценкаАвтомобили=ДоговорВзаиморасчетов.ТипСкидкиНаценки;
			 Результат=ОбработкаРеквизита("СкидкаНаценкаАвтомобили",,ЭтаФорма,ДопПараметры);
		КонецЕсли;		
		
	ИначеЕсли Имя="Карточка" Тогда
		Результат=дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры);
		Результат=ОбработкаРеквизита("РассчитатьСкидкиАвтомобили",ТекСтрока,ЭтаФорма,ДопПараметры) И Результат;
		
	ИначеЕсли Имя="СкидкаНаценкаАвтомобили" Тогда
		Результат=ОбработкаРеквизита("РассчитатьСкидкиАвтомобили",ТекСтрока,ЭтаФорма,ДопПараметры);
		
	ИначеЕсли Имя="СкладКомпании" Тогда
		Если НЕ обЗначениеНеЗаполнено(СкладКомпании) Тогда
			Если СкладКомпании.Розничный Тогда
				#Если Клиент Тогда
				Предупреждение("Выбранный склад: """+СкладКомпании+""" является розничным!
				|Выберите оптовый склад",10);
				#КонецЕсли
				СкладКомпании=Неопределено;
			КонецЕсли; 
		КонецЕсли; 
		Результат=дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры);
		Результат=ОбработкаРеквизита("РассчитатьСкидкиАвтомобили",,ЭтаФорма,ДопПараметры) И Результат;
		
	//ОБРАБОТКА ТАБЛИЧНОЙ ЧАСТИ "АВТОМОБИЛИ"
	ИначеЕсли Имя="Автомобили.Автомобиль" Тогда
		
		Если дкПроверитьАвтомобильДляКомиссионныхДокументов(ЭтотОбъект.ХозОперация, ТекСтрока) Тогда
			Возврат Истина;
		КонецЕсли;
		
		//Проставим количество
		Если ТекСтрока.Количество=0 Тогда ТекСтрока.Количество=1 КонецЕсли;
		// Теперь получаем подставим значение скидки
		Попытка // документ может не поддерживать скидки
			Если (НЕ ЭтотОбъект.СкидкаНаценкаАвтомобили.Пустая()) И (ЭтотОбъект.СкидкаНаценкаАвтомобили.СпособВычисления = Перечисления.СкидкиСпособВычисления.Относительная) Тогда
				ТекСтрока.ПроцентСкидки=ЭтотОбъект.ЗначениеСкидкиНаценкиАвтомобили;
			Иначе
				ТекСтрока.ПроцентСкидки=0;
			КонецЕсли;
		Исключение КонецПопытки;
		
		// заметки
		#Если Клиент Тогда
			дкСообщитьОЗаметках(ЭтотОбъект,ТекСтрока.Автомобиль,ЭтаФорма);
		#КонецЕсли
		
		// Заполним ставку НДС
		Если обЗначениеНеЗаполнено(ТекСтрока.СтавкаНДС) Тогда
			ОсвобожденОтНДС=ПодразделениеКомпании.ОсвобожденОтНДС ИЛИ Организация.ОсвобожденОтНДС;
			Если ОсвобожденОтНДС Тогда
				ТекСтрока.СтавкаНДС=Справочники.СтавкиНДС.БезНДС;
			Иначе
				ТекСтрока.СтавкаНДС=Справочники.СтавкиНДС.ОсновнаяСтавкаНДС;
			КонецЕсли; 
		КонецЕсли; 
		Если НЕ обЗначениеНеЗаполнено(ТекСтрока.Автомобиль) Тогда
			Заказ=НайтиЗаказАвтомобиля(ТекСтрока.Автомобиль);
			Если Заказ<>ТекСтрока.ЗаказНаАвтомобиль Тогда
				ТекСтрока.ЗаказНаАвтомобиль=Заказ;
				Результат=ОбработкаРеквизита("Автомобили.ЗаказНаАвтомобиль",ТекСтрока,ЭтаФорма,ДопПараметры) И Результат;
			КонецЕсли;
			Если обЗначениеНеЗаполнено(ТекСтрока.ЗаказНаАвтомобиль) Тогда
				ТекСтрока.Цена=обПолучитьЦену(ТипЦен,Новый Структура("Автомобиль,ВариантКомплектации",ТекСтрока.Автомобиль,Справочники.ВариантыКомплектации.ПустаяСсылка()),?(Ссылка.Пустая(),Дата,МоментВремени()),,ВалютаДокумента,КурсДокумента);
				Запрос=Новый Запрос;
				Запрос.Текст="ВЫБРАТЬ
							|	КомплектацияАвтомобилейОстатки.Номенклатура КАК Опция,
							|	КомплектацияАвтомобилейОстатки.КоличествоОстаток КАК Количество
							|ИЗ
							|	РегистрНакопления.КомплектацияАвтомобилей.Остатки(&НаМомент,Автомобиль=&Автомобиль) КАК КомплектацияАвтомобилейОстатки
							|ГДЕ
							|	КомплектацияАвтомобилейОстатки.Автомобиль = &Автомобиль
							|	И КомплектацияАвтомобилейОстатки.Номенклатура ССЫЛКА Справочник.Опции";
				Запрос.УстановитьПараметр("НаМомент",?(Ссылка.Пустая(),Новый МоментВремени(КонецДня(Дата)),Новый Граница(Дата,ВидГраницы.Исключая)));
				Запрос.УстановитьПараметр("Автомобиль",ТекСтрока.Автомобиль);
				Выборка=Запрос.Выполнить().Выбрать();
				Пока Выборка.Следующий() Цикл
					ТекСтрока.Цена=ТекСтрока.Цена+(обПолучитьЦену(ТипЦен,Новый Структура("Автомобиль,ВариантКомплектации,Опция",ТекСтрока.Автомобиль.Модель,ТекСтрока.Автомобиль.ВариантКомплектации,Выборка.Опция),?(Ссылка.Пустая(),Дата,МоментВремени()),,ВалютаДокумента,КурсДокумента)*Выборка.Количество);
				КонецЦикла;
				Результат = ОбработкаРеквизита("Автомобили.Цена",ТекСтрока,ЭтаФорма,ДопПараметры) И Результат;
			Иначе
				// если авто из заказа, то вычтем оборудование из цены, так как в регистре "ЗаказыАвтомобилей" они вместе
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ
							|	ЗаказыАвтомобилейОстатки.СуммаОстаток КАК Сумма,
							|	ЗаказыАвтомобилейОстатки.СуммаУпрОстаток КАК СуммаУпр,
							|	ЗаказНаАвтомобильОборудование.СуммаВсегоОборудование КАК СуммаВсегоОборудование
							|ИЗ
							|	РегистрНакопления.ЗаказыАвтомобилей.Остатки(&НаДату, Заказ = &Заказ) КАК ЗаказыАвтомобилейОстатки,
							|	(ВЫБРАТЬ
							|		СУММА(ЗаказНаАвтомобильОборудование.СуммаВсего) КАК СуммаВсегоОборудование
							|	ИЗ
							|		Документ.ЗаказНаАвтомобиль.Товары КАК ЗаказНаАвтомобильОборудование
							|	ГДЕ
							|		ЗаказНаАвтомобильОборудование.Ссылка = &Заказ) КАК ЗаказНаАвтомобильОборудование";
				Запрос.УстановитьПараметр("НаДату", ?(Ссылка.Пустая(),Новый МоментВремени(КонецДня(Дата)),Новый Граница(Дата,ВидГраницы.Исключая)));
				Запрос.УстановитьПараметр("Заказ",  ТекСтрока.ЗаказНаАвтомобиль);
				Выборка = Запрос.Выполнить().Выбрать();
				Если Выборка.Следующий() Тогда
					ВалютаВзаиморасчетов = ТекСтрока.ЗаказНаАвтомобиль.ДоговорВзаиморасчетов.ВалютаВзаиморасчетов;
					Если ВалютаДокумента = ВалютаВзаиморасчетов Тогда
						СуммаВсего = Выборка.Сумма - обПересчет(Выборка.СуммаВсегоОборудование, ТекСтрока.ЗаказНаАвтомобиль.ВалютаДокумента, ТекСтрока.ЗаказНаАвтомобиль.КурсДокумента, ВалютаДокумента, КурсДокумента);
					Иначе
						СуммаВсего = обПересчет(Выборка.СуммаУпр, Константы.ВалютаУправленческогоУчетаКомпании.Получить(), КурсВалютыУпр, ВалютаДокумента, КурсДокумента) -
									 обПересчет(Выборка.СуммаВсегоОборудование, ТекСтрока.ЗаказНаАвтомобиль.ВалютаДокумента, ТекСтрока.ЗаказНаАвтомобиль.КурсДокумента, ВалютаДокумента, КурсДокумента);
					КонецЕсли;
				КонецЕсли;
				
				СтавкаНДС = ТекСтрока.ЗаказНаАвтомобиль.СтавкаНДСНаАвтомобиль;
				Если ТекСтрока.ЗаказНаАвтомобиль.СкидкаНаценкаНаАвтомобиль = СкидкаНаценкаАвтомобили И ЗначениеЗаполнено(СкидкаНаценкаАвтомобили) Тогда
					Если СкидкаНаценкаАвтомобили.СпособВычисления = Перечисления.СкидкиСпособВычисления.Абсолютная Тогда
						ТекСтрока.ПроцентСкидки = ТекСтрока.ЗаказНаАвтомобиль.ПроцентСкидкиНаАвтомобиль;
						ТекСтрока.СуммаСкидки   = ТекСтрока.ЗаказНаАвтомобиль.ЗначениеСкидкиНаценкиНаАвтомобиль;
					Иначе
						ТекСтрока.ПроцентСкидки = ТекСтрока.ЗаказНаАвтомобиль.ЗначениеСкидкиНаценкиНаАвтомобиль;
					КонецЕсли;
				КонецЕсли;
				ТекСтрока.СтавкаНДС=СтавкаНДС;
				ТекСтрока.СуммаВсего = СуммаВсего;
				Результат=ОбработкаРеквизита("Автомобили.СуммаВсего",ТекСтрока,ЭтаФорма,ДопПараметры) И Результат;
			КонецЕсли; 
		КонецЕсли; 
		ДобавитьОборудованиеАвтомобиля(ТекСтрока.Автомобиль,Истина);
		#Если Клиент Тогда
		Если ЭтаФорма<>Неопределено Тогда
			дкВывестиЗаголовокСуммаДокумента(ЭтаФорма);
		КонецЕсли; 
		#КонецЕсли
		
	ИначеЕсли Имя="Автомобили.Цена" Тогда
		ТекСтрока.Сумма=ТекСтрока.Цена*ТекСтрока.Количество;
		Результат=ОбработкаРеквизита("РассчитатьСкидкиАвтомобили",ТекСтрока,ЭтаФорма,ДопПараметры);
		
	ИначеЕсли Имя="Автомобили.Сумма" Тогда
		ТекСтрока.Цена=?(ТекСтрока.Количество=0,0,ТекСтрока.Сумма/ТекСтрока.Количество);
		Результат=ОбработкаРеквизита("РассчитатьСкидкиАвтомобили",ТекСтрока,ЭтаФорма,ДопПараметры);

	ИначеЕсли Имя="Автомобили.ПроцентСкидки" Тогда
		СтавкаНДС = ТекСтрока.СтавкаНДС.Ставка;
		ЦенаВключаетНДС=(обЗначениеНеЗаполнено(ТипЦен) ИЛИ ТипЦен.ЦенаВключаетНДС);
		
		// Скидка не может быть выше 100%
		Если ТекСтрока.ПроцентСкидки>100 Тогда
			ТекСтрока.ПроцентСкидки = 100;	
		КонецЕсли;
		
		Себестоимость = ПолучитьСебестоимостьАвтомобиляКупленногоУФизЛица(ТекСтрока);
		
		Если НЕ Себестоимость = 0 И НЕ ЦенаВключаетНДС Тогда
			СуммаРасчетная = Макс(ТекСтрока.Сумма-Себестоимость, 0);
			ТекСтрока.СуммаСкидки = Окр((ТекСтрока.Сумма + (СуммаРасчетная)*СтавкаНДС/100) * ТекСтрока.ПроцентСкидки / 100, 2);
		Иначе
			ТекСтрока.СуммаСкидки = Окр(?(ЦенаВключаетНДС, ТекСтрока.Сумма, ТекСтрока.Сумма+ТекСтрока.Сумма*(СтавкаНДС/100)) * ТекСтрока.ПроцентСкидки / 100, 2);
		КонецЕсли;
		ТекСтрока.СуммаСкидки = дкОкруглитьСуммуСкидки(ТекСтрока.СуммаСкидки,СкидкаНаценкаАвтомобили);
		Если ТипЗнч(ДопПараметры)<>Тип("Структура") Тогда
			ДопПараметры = Новый Структура;
		КонецЕсли;
		ДопПараметры.Вставить("ПересчитыватьПроцент", Ложь);
		РезультатОбработки = ЭтотОбъект.ОбработкаРеквизита("Автомобили.СуммаСкидки", ТекСтрока, ЭтаФорма, ДопПараметры);  			
		
	ИначеЕсли Имя="Автомобили.СуммаСкидки" Тогда
		// Выполним расчет итоговой суммы скидки на документ.
		Попытка	// Определим необходимость обратного расчета процента скидки.
			ПересчитыватьПроцент = ДопПараметры.ПересчитыватьПроцент;
		Исключение 
			ПересчитыватьПроцент = Истина;	
		КонецПопытки;
		Если ПересчитыватьПроцент Тогда
			ТекСтрока.ПроцентСкидки = ?(ТекСтрока.Сумма=0, 0, Окр(ТекСтрока.СуммаСкидки * 100 / ТекСтрока.Сумма, 2));
		КонецЕсли;
		// Выполним расчет итоговой суммы скидки на документ.
		СуммаСкидкиНаценкиАвтомобили = Автомобили.Итог("СуммаСкидки");
		РезультатОбработки = ОбработкаРеквизита("Автомобили.СтавкаНДС", ТекСтрока, ЭтаФорма, ДопПараметры);
		
	ИначеЕсли Имя="Автомобили.СтавкаНДС" Тогда
		
		// Расчет НДС
		СтавкаНДС = ТекСтрока.СтавкаНДС.Ставка;
		ЦенаВключаетНДС=(обЗначениеНеЗаполнено(ТипЦен) ИЛИ ТипЦен.ЦенаВключаетНДС);
		
		// Рассчитываем новую сумму НДС.
		СуммаВсегоБезСкидки = ?(ЦенаВключаетНДС, ТекСтрока.Сумма, ТекСтрока.Сумма*(1+СтавкаНДС/100)) - ТекСтрока.СуммаСкидки;
		
		Себестоимость = ПолучитьСебестоимостьАвтомобиляКупленногоУФизЛица(ТекСтрока);
		
		Если НЕ Себестоимость = 0 И НЕ ЦенаВключаетНДС Тогда
			СуммаВсегоБезСкидки = ТекСтрока.Сумма - ТекСтрока.СуммаСкидки;
			СуммаБезСкидки = Макс(СуммаВсегоБезСкидки - Себестоимость, 0);
			ТекСтрока.СуммаНДС = Окр(СтавкаНДС/100*СуммаБезСкидки,2);
			ТекСтрока.СуммаВсего = СуммаВсегоБезСкидки + ТекСтрока.СуммаНДС;
		Иначе
			ТекСтрока.СуммаВсего = СуммаВсегоБезСкидки;
			Если НЕ Себестоимость = 0 Тогда
				СуммаВсегоБезСкидки = Макс(СуммаВсегоБезСкидки - Себестоимость, 0);
			КонецЕсли;
			ТекСтрока.СуммаНДС = Окр((СуммаВсегоБезСкидки*СтавкаНДС)/(100+СтавкаНДС),2);
		КонецЕсли;
		
		
	ИначеЕсли Имя="Автомобили.СуммаНДС" Тогда
				
	ИначеЕсли Имя="Автомобили.СуммаВсего" Тогда
		
		// Определим включают ли в себя НДС цены документа
		ЦенаВключаетНДС = (обЗначениеНеЗаполнено(ТипЦен) ИЛИ ТипЦен.ЦенаВключаетНДС);
		СтавкаНДС       = ТекСтрока.СтавкаНДС.Ставка;
		
		Себестоимость = ПолучитьСебестоимостьАвтомобиляКупленногоУФизЛица(ТекСтрока);
		
		Если СкидкаНаценкаАвтомобили.СпособВычисления = Перечисления.СкидкиСпособВычисления.Абсолютная Тогда
			СуммаБезСкидки = ТекСтрока.СуммаВсего + ТекСтрока.СуммаСкидки;
		Иначе
			СуммаБезСкидки = ТекСтрока.СуммаВсего*100/(100-ТекСтрока.ПроцентСкидки)
		КонецЕсли;
		
		Если ЦенаВключаетНДС Тогда
			РасчетнаяСумма = СуммаБезСкидки;
		Иначе
			Если Себестоимость = 0 Тогда
				РасчетнаяСумма = СуммаБезСкидки - Окр((СуммаБезСкидки * СтавкаНДС)/(100 + СтавкаНДС),2);
			Иначе
				СуммаНДС       = Окр(((СуммаБезСкидки-Себестоимость)*СтавкаНДС)/(100+СтавкаНДС),2);
				РасчетнаяСумма = Макс(СуммаБезСкидки - СуммаНДС, 0);
			КонецЕсли;
		КонецЕсли;
		
		ТекСтрока.Сумма = РасчетнаяСумма;
		
		Если СкидкаНаценкаАвтомобили.СпособВычисления = Перечисления.СкидкиСпособВычисления.Абсолютная Тогда
			ТекСтрока.ПроцентСкидки = ?(СуммаБезСкидки = 0, 0, ТекСтрока.СуммаСкидки/СуммаБезСкидки)*100;
		Иначе
			ТекСтрока.СуммаСкидки = Окр(?(ЦенаВключаетНДС, ТекСтрока.Сумма, ТекСтрока.Сумма+ТекСтрока.Сумма*(СтавкаНДС/100)) * ТекСтрока.ПроцентСкидки / 100, 2);
			ТекСтрока.СуммаСкидки = дкОкруглитьСуммуСкидки(ТекСтрока.СуммаСкидки,СкидкаНаценкаАвтомобили);
		КонецЕсли;
		
		// Пересчитываем цену.
		ТекСтрока.Цена = ?(ТекСтрока.Количество=0,ТекСтрока.Сумма,Окр(ТекСтрока.Сумма/ТекСтрока.Количество,2));
		
		// Рассчитываем новую сумму НДС.
		СуммаВсегоБезСкидки = ?(ЦенаВключаетНДС, ТекСтрока.Сумма, ТекСтрока.Сумма*(1+СтавкаНДС/100)) - ТекСтрока.СуммаСкидки;
		
		Если НЕ Себестоимость = 0 И НЕ ЦенаВключаетНДС Тогда
			СуммаВсегоБезСкидки = ТекСтрока.Сумма - ТекСтрока.СуммаСкидки;
			СуммаБезСкидки = Макс(СуммаВсегоБезСкидки - Себестоимость, 0);
			ТекСтрока.СуммаНДС = Окр(СтавкаНДС/100*СуммаБезСкидки,2);
		Иначе
			Если НЕ Себестоимость = 0 Тогда
				СуммаВсегоБезСкидки = Макс(СуммаВсегоБезСкидки - Себестоимость, 0);
			КонецЕсли;
			ТекСтрока.СуммаНДС = Окр((СуммаВсегоБезСкидки*СтавкаНДС)/(100+СтавкаНДС),2);
		КонецЕсли;
		
		// Выполним расчет итоговой суммы скидки на документ.
		СуммаСкидкиНаценкиАвтомобили = Автомобили.Итог("СуммаСкидки");
		
	ИначеЕсли Имя="Автомобили.АвтомобильБезЗаказа" Тогда
		Если ТекСтрока.АвтомобильБезЗаказа Тогда
			ТекСтрока.ЗаказНаАвтомобиль=Неопределено;
			Результат=ОбработкаРеквизита("Автомобили.ЗаказНаАвтомобиль",ТекСтрока,ЭтаФорма,ДопПараметры);
		КонецЕсли; 
		
	ИначеЕсли Имя="Автомобили.ЗаказНаАвтомобиль" Тогда
		Если ЗначениеЗаполнено(ТекСтрока.ЗаказНаАвтомобиль) Тогда
			ТекСтрока.АвтомобильБезЗаказа = Ложь;
			Если НЕ ТекСтрока.Автомобиль = ТекСтрока.ЗаказНаАвтомобиль.Автомобиль Тогда
				ТекСтрока.Автомобиль = ТекСтрока.ЗаказНаАвтомобиль.Автомобиль;
				ОбработкаРеквизита("Автомобили.Автомобиль",ТекСтрока,ЭтаФорма,ДопПараметры);
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли Имя="РассчитатьСкидкиАвтомобили" Тогда
		Попытка	
			НеРассчитыватьСкидки = ДопПараметры.НеРассчитыватьСкидки;
		Исключение 
			НеРассчитыватьСкидки = Ложь;
		КонецПопытки;
		
		Попытка
			БлокироватьПерерасчетСкидок = ЭтотОбъект.БлокироватьПерерасчетСкидок;
		Исключение
			БлокироватьПерерасчетСкидок = Ложь;
		КонецПопытки;
		
		ОбработкаРасчетСкидокАвтомобили.СкидкаНаценка=СкидкаНаценкаАвтомобили;
		// Подбираем подходящую скидку. Если скидка не изменилась, то функция вернет Ложь.
		
		Если БлокироватьПерерасчетСкидок Тогда
			Попытка
				Если обЗначениеНеЗаполнено(ЭтотОбъект.СкидкаНаценкаАвтомобили) Тогда
					Для Каждого стрДок Из ЭтотОбъект.Автомобили Цикл
						стрДок.ПроцентСкидки = 0;
						ЭтотОбъект.ОбработкаРеквизита("Автомобили.ПроцентСкидки", стрДок, ЭтаФорма);
					КонецЦикла;
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			Если ТекСтрока = Неопределено Тогда
				Возврат Ложь;
			КонецЕсли;
			
			Если СкидкаНаценкаАвтомобили.СпособВычисления = Перечисления.СкидкиСпособВычисления.Абсолютная Тогда
				ЭтотОбъект.ОбработкаРеквизита("Автомобили.СуммаСкидки", ТекСтрока, ЭтаФорма);
			Иначе
				ЭтотОбъект.ОбработкаРеквизита("Автомобили.ПроцентСкидки", ТекСтрока, ЭтаФорма);
			КонецЕсли;
			Возврат Истина;
		ИначеЕсли (Не НеРассчитыватьСкидки) И ОбработкаРасчетСкидокАвтомобили.ПодобратьСкидку(ЭтотОбъект) Тогда
			ЭтотОбъект[ОбработкаРасчетСкидокАвтомобили.ИмяРеквизитаСкидкаНаценка] = ОбработкаРасчетСкидокАвтомобили.ТекущаяСкидкаНаценка;
			ЭтотОбъект[ОбработкаРасчетСкидокАвтомобили.ИмяРеквизитаЗначениеСкидкиНаценки] = ОбработкаРасчетСкидокАвтомобили.ТекущееЗначениеСкидки;
			ЭтотОбъект[ОбработкаРасчетСкидокАвтомобили.ИмяРеквизитаСуммаСкидкиНаценки] = ОбработкаРасчетСкидокАвтомобили.ТекущаяСуммаСкидки;
			// Подобралась другая "шапочная" скидка, значит, возможно, придется заблокировать работу с некоторыми колонками 
			// в зависимости от типа скидки.
			#Если Клиент Тогда
				Если ЭтаФорма<>Неопределено Тогда
					дкУправлениеДоступностьюКолонокСкидок(ЭтаФорма, ОбработкаРасчетСкидокАвтомобили.ТекущаяСкидкаНаценка, ОбработкаРасчетСкидокАвтомобили.ИмяТабличнойЧасти);	
				КонецЕсли;
			#КонецЕсли
			// Применяем скидку к табличной части. Пересчитваем строчные скидки.
			ОбработкаРасчетСкидокАвтомобили.ПрименитьСкидку(ЭтотОбъект);
			ПересчетСкидокАвтомобилей();
			
			#Если Клиент Тогда					
				Если ЭтаФорма<>Неопределено Тогда
					дкВывестиЗаголовокСуммаДокумента(ЭтаФорма);		
				КонецЕсли;  
			#КонецЕсли 
		Иначе // Просто пересчитываем значение суммы скидки для текущей строки.
			Если ТекСтрока<>Неопределено Тогда									
				// Рассчитываем "шапочную" скидку для текущей строки. За одно рассчитаем общую сумму скидки на документ.
				Если СкидкаНаценкаАвтомобили.СпособВычисления=Перечисления.СкидкиСпособВычисления.Относительная Тогда
					ОбработкаРеквизита("Автомобили.ПроцентСкидки", ТекСтрока, ЭтаФорма, ДопПараметры);				
				Иначе
					ОбработкаРеквизита("Автомобили.СуммаСкидки", ТекСтрока, ЭтаФорма, ДопПараметры);				
				КонецЕсли;
			Иначе
				// Если произошла смена типа скидки, но значение скидки не изменилась, то пересчитывать ТЧ нет необходимости, но
				// сохранить новый тип скидки нужно.
				СкидкаНаценкаАвтомобили = ОбработкаРасчетСкидокАвтомобили.ТекущаяСкидкаНаценка;
				СуммаСкидкиНаценкиАвтомобили = Автомобили.Итог("СуммаСкидки");
			КонецЕсли;			
		КонецЕсли;
		
	// ОБРАБОТКА РЕКВИЗИТОВ ТАБЛИЧНОЙ ЧАСТИ "ТОВАРЫ"
	ИначеЕсли Имя="Товары.Номенклатура" Тогда
		Результат=дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры);
		//А вот тут мы загрузим те цены, которые указаны в регистре комплектации
		СтрокаАвтомобиля=Автомобили.Найти(ТекСтрока.ИдентификаторАвтомобиля,"ИдентификаторАвтомобиля");
		Если СтрокаАвтомобиля=Неопределено Тогда
			Возврат Ложь;
		КонецЕсли;
		Автомобиль=СтрокаАвтомобиля.Автомобиль;
		Запрос=Новый Запрос;
		Запрос.Текст="ВЫБРАТЬ
		             |	СУММА(КомплектацияАвтомобилейОстатки.КоличествоОстаток) КАК Количество,
		             |	СУММА(КомплектацияАвтомобилейОстатки.СуммаПродажиОстаток) КАК СуммаПродажи,
		             |	СУММА(КомплектацияАвтомобилейОстатки.СуммаПродажиУпрОстаток) КАК СуммаПродажиУпр
		             |ИЗ
		             |	РегистрНакопления.КомплектацияАвтомобилей.Остатки(
		             |		&НаДату,
		             |		Автомобиль = &Автомобиль
		             |		    И Номенклатура = &Номенклатура
		             |		    И ХарактеристикаНоменклатуры = &ХарактеристикаНоменклатуры) КАК КомплектацияАвтомобилейОстатки";
		Запрос.УстановитьПараметр("НаДату",?(Ссылка.Пустая(),Новый МоментВремени(КонецДня(Дата)),Новый Граница(Дата,ВидГраницы.Исключая)));
		Запрос.УстановитьПараметр("Автомобиль",Автомобиль);
		Запрос.УстановитьПараметр("Номенклатура",ТекСтрока.Номенклатура);
		Запрос.УстановитьПараметр("ХарактеристикаНоменклатуры",ТекСтрока.ХарактеристикаНоменклатуры);
		ОстаткиОборудования=Запрос.Выполнить().Выгрузить();
		ТекСтрока.Количество=ОстаткиОборудования.Итог("Количество");
		Если обЗначениеНеЗаполнено(ТекСтрока.Количество) Тогда ТекСтрока.Количество=0; КонецЕсли; 
		ВалютаРегламентированногоУчетаОрганизаций=Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
		Если ВалютаДокумента=ВалютаРегламентированногоУчетаОрганизаций Тогда
			ОстатокСуммы=ОстаткиОборудования.Итог("СуммаПродажи");
		Иначе
			ОстатокСуммы=ОстаткиОборудования.Итог("СуммаПродажиУпр");
			ВалютаУпр=Константы.ВалютаУправленческогоУчетаКомпании.Получить(); 
			Если обЗначениеНеЗаполнено(КурсВалютыУпр) Тогда
				СтруктураКурса = обКурсДляВалюты(ВалютаУпр,Дата);
				КурсУпр		   = СтруктураКурса.Курс / ?(СтруктураКурса.Кратность = 0, 1, СтруктураКурса.Кратность);
			Иначе
				КурсУпр        = КурсВалютыУпр;
			КонецЕсли;
		КонецЕсли; 
		Если обЗначениеНеЗаполнено(ОстатокСуммы) Тогда ОстатокСуммы=0; КонецЕсли; 
		Если ВалютаДокумента<>ВалютаРегламентированногоУчетаОрганизаций Тогда
			ОстатокСуммы=обПересчет(ОстатокСуммы,ВалютаУпр,КурсУпр,ВалютаДокумента,КурсДокумента);
		КонецЕсли; 
		Если обЗначениеНеЗаполнено(ЭтотОбъект.ТипЦен) Тогда
			ЦенаВключаетНДС=Истина;
		Иначе
			ЦенаВключаетНДС=ЭтотОбъект.ТипЦен.ЦенаВключаетНДС;
		КонецЕсли; 
		Если НЕ ЦенаВключаетНДС Тогда
			//НДС в цену не включен
			ОстатокСуммы=(100*ОстатокСуммы)/(100+ТекСтрока.СтавкаНДС.Ставка);
		КонецЕсли; 
		ТекСтрока.Сумма=ОстатокСуммы;
		Результат=ОбработкаРеквизита("Товары.Сумма",ТекСтрока,ЭтаФорма,ДопПараметры) И Результат;
		
	Иначе 
		Результат=дкОбработкаРеквизита(ЭтотОбъект,Имя,ТекСтрока,ЭтаФорма,ДопПараметры);
	КонецЕсли;

	Возврат Результат;
КонецФункции // ОбработкаРеквизита()

// БИЗТЕХ Коваль А.Д. 06.06.2023
// Проверка на открытые заказ-наряды по автомобилю
// Параметры - СписокЗначений - Виды ремонта по которым ведется проверка
//
Функция ПроверкаОткрытыхЗНАвтомобиля(ВидыРемонтаДляПроверки) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЗаказНаряд.Ссылка КАК Ссылка,
	               |	ЗаказНаряд.Автомобиль КАК Автомобиль
	               |ИЗ
	               |	Документ.ЗаказНаряд КАК ЗаказНаряд
	               |ГДЕ
	               |	ЗаказНаряд.Дата <= &Дата
	               |	И ЗаказНаряд.Автомобиль В(&Автомобили)
	               |	И ЗаказНаряд.Состояние <> ЗНАЧЕНИЕ(Справочник.ВидыСостоянийЗаказНарядов.Закрыт)
	               |	И НЕ ЗаказНаряд.ПометкаУдаления
	               |	И ЗаказНаряд.Состояние <> ЗНАЧЕНИЕ(Справочник.ВидыСостоянийЗаказНарядов.Заявка)
	               |	И ЗаказНаряд.ВидРемонта В(&ВидыРемонтаДляПроверки)
	               |	И ЗаказНаряд.Состояние <> &ОтказОтРемонта
	               |	И ЗаказНаряд.Состояние <> &ДляИсторииавтомобиля
	               |	И ЗаказНаряд.Состояние <> &ОтказВСогласовании";
	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("Автомобили", Автомобили.ВыгрузитьКолонку("Автомобиль"));
	Запрос.УстановитьПараметр("ВидыРемонтаДляПроверки", ВидыРемонтаДляПроверки);
	Запрос.УстановитьПараметр("ОтказОтРемонта", Справочники.ВидыСостоянийЗаказНарядов.НайтиПоКоду("ЦБ00000001"));
	Запрос.УстановитьПараметр("ДляИсторииавтомобиля", Справочники.ВидыСостоянийЗаказНарядов.НайтиПоКоду("ЦБ00000007"));
	Запрос.УстановитьПараметр("ОтказВСогласовании", Справочники.ВидыСостоянийЗаказНарядов.НайтиПоКоду("ЦБ00000004"));

	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Количество() > 0 Тогда
		Пока Выборка.Следующий() Цикл
			Сообщить("На автомобиль """+СокрЛП(Выборка.Автомобиль)+""" имеется открытый заказ-наряд """+Выборка.Ссылка+""".");
		КонецЦикла;
		Возврат Истина;
	КонецЕсли;
	Возврат Ложь;
КонецФункции

// Проверка на все открытые заказ-наряды и заявки на ремонт до даты реализации
//
Функция ПроверкаОткрытыхДокуменовАвтомобиля() Экспорт
	
	// сформируем массив автомобилей 
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ЗаказНаряд.ДокументОснование,
	|	ЗаказНаряд.Ссылка
	|ПОМЕСТИТЬ ЗакрытыеЗаказНаряды
	|ИЗ
	|	Документ.ЗаказНаряд КАК ЗаказНаряд
	|ГДЕ
	|	ЗаказНаряд.Дата <= &Дата
	|	И ЗаказНаряд.Состояние = ЗНАЧЕНИЕ(Справочник.ВидыСостоянийЗаказНарядов.Закрыт)
	|	И ЗаказНаряд.Автомобиль В(&Автомобили)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаказНаряд.Ссылка,
	|	ЗаказНаряд.Автомобиль
	|ИЗ
	|	Документ.ЗаказНаряд КАК ЗаказНаряд
	|ГДЕ
	|	ЗаказНаряд.Дата <= &Дата
	|	И ЗаказНаряд.Автомобиль В(&Автомобили)
	|	И ЗаказНаряд.Состояние <> ЗНАЧЕНИЕ(Справочник.ВидыСостоянийЗаказНарядов.Закрыт)
	|	И НЕ ЗаказНаряд.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗаявкаНаРемонт.Ссылка,
	|	ЗаявкаНаРемонт.Автомобиль
	|ИЗ
	|	Документ.ЗаявкаНаРемонт КАК ЗаявкаНаРемонт
	|ГДЕ
	|	ЗаявкаНаРемонт.Дата <= &Дата
	|	И ЗаявкаНаРемонт.Автомобиль В(&Автомобили)
	|	И НЕ ЗаявкаНаРемонт.Ссылка В
	|				(ВЫБРАТЬ
	|					ЗакрытыеЗаказНаряды.ДокументОснование
	|				ИЗ
	|					ЗакрытыеЗаказНаряды КАК ЗакрытыеЗаказНаряды)
	|	И ЗаявкаНаРемонт.Состояние <> ЗНАЧЕНИЕ(Перечисление.СостоянияЗаявкиНаРемонт.Отклонено)
	|	И НЕ ЗаявкаНаРемонт.ПометкаУдаления";
	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("Автомобили", Автомобили.ВыгрузитьКолонку("Автомобиль"));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Количество() > 0 Тогда
		
		Пока Выборка.Следующий() Цикл
			
			Сообщить("На автомобиль """+СокрЛП(Выборка.Автомобиль)+""" имеется открытый документ """+Выборка.Ссылка+""".");
			
		КонецЦикла;
		
		Возврат Истина;
		
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

// Получение данных о прослеживаемых товаров
//
// Параметры:
//  Объект	 - ДокументОбъект.РеализацияАвтомобилей - Документ, на основании которого произошла операция с товаром
// 
// Возвращаемое значение:
//  ТаблицаЗначений - Список прослеживаемых товаров
//
Функция ОперацииСПрослеживаемымиТоварами() Экспорт
	
	// TODO: На данный момент сделано только для формирования отчета об операциях
	
	// Получим таблицу для формирования данных по операции
	ТаблицаОперацииПрослеживаемости = ПрослеживаемостьТоваровСервер.ИнициализацияТаблицыОпераций();
	
	ОсвобождентОтНДС = ПодразделениеКомпании.ОсвобожденОтНДС ИЛИ Организация.ОсвобожденОтНДС;
	
	// Проверим есть ли ставка НДС в документе
	ТаблицаНДС = Автомобили.Выгрузить();
	ТаблицаНДС.Свернуть("СтавкаНДС");
	ЕстьНДС = НЕ (ТаблицаНДС.Количество() = 1 И ТаблицаНДС[0].СтавкаНДС = Справочники.СтавкиНДС.БезНДС);
	
	// Операцию об отчете не выводим если есть ставка НДС в документе и организация плательщик НДС
	Если ЕстьНДС И НЕ ОсвобождентОтНДС Тогда
		Возврат ТаблицаОперацииПрослеживаемости;
	КонецЕсли;
	
	// Сформируем запрос из документа
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПродажиАвтомобилей.Автомобиль КАК Номенклатура,
	|	ПродажиАвтомобилей.ГТД КАК РНПТ,
	|	СУММА(ПродажиАвтомобилей.Количество) КАК КоличествоПрослеживаемости,
	|	СУММА(ПродажиАвтомобилей.Сумма - ПродажиАвтомобилей.СуммаНДС) КАК СуммаБезНДС
	|ИЗ
	|	РегистрНакопления.ПродажиАвтомобилей КАК ПродажиАвтомобилей
	|ГДЕ
	|	ПродажиАвтомобилей.Регистратор = &Ссылка
	|	И ПродажиАвтомобилей.ГТД.РНПТ
	|
	|СГРУППИРОВАТЬ ПО
	|	ПродажиАвтомобилей.Автомобиль,
	|	ПродажиАвтомобилей.ГТД
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализацияАвтомобилей.Организация КАК Организация,
	|	НАЧАЛОПЕРИОДА(РеализацияАвтомобилей.Дата, КВАРТАЛ) КАК ПериодОтчета,
	|	ЗНАЧЕНИЕ(Перечисление.ДокументыОтображенияОпераций.ОтчетОбОперациях) КАК ОтчетностьОперации,
	|	ВЫБОР
	|		КОГДА РеализацияАвтомобилей.Контрагент.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.КлассификаторСтранМира.ПустаяСсылка)
	|				И РеализацияАвтомобилей.Контрагент.СтранаРегистрации <> &СтранаРоссия
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.КодыОперацийПрослеживаемости.ВывозЗаПределыРФ)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КодыОперацийПрослеживаемости.РеализацияТоваров)
	|	КОНЕЦ КАК КодОперации,
	|	РеализацияАвтомобилей.Ссылка КАК Документ,
	|	РеализацияАвтомобилей.Дата КАК ДатаДокумента,
	|	РеализацияАвтомобилей.Номер КАК НомерДокумента,
	|	РеализацияАвтомобилей.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыДокументов.Другое) КАК ВидДокумента,
	|	РеализацияАвтомобилей.Контрагент.СтранаРегистрации КАК СтранаРегистрации
	|ИЗ
	|	Документ.РеализацияАвтомобилей КАК РеализацияАвтомобилей
	|ГДЕ
	|	РеализацияАвтомобилей.Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	СтранаРоссия = Справочники.КлассификаторСтранМира.НайтиПоКоду("643");
	Если СтранаРоссия = Неопределено Тогда
		СтранаРоссия = Справочники.КлассификаторСтранМира.ПустаяСсылка();
	КонецЕсли;
	Запрос.УстановитьПараметр("СтранаРоссия", СтранаРоссия);
	
	ПакетЗапросов = Запрос.ВыполнитьПакет();
	
	// Проверим есть РНПТ у документа
	Если ПакетЗапросов[0].Пустой() Тогда
		Возврат ТаблицаОперацииПрослеживаемости;
	КонецЕсли;
	
	ШапкаДокумента = ПакетЗапросов[1].Выбрать();
	ШапкаДокумента.Следующий();
	
	// Указываем для отчета только для контрагентов не из ЕАЭС
	Если ПрослеживаемостьТоваровСервер.СтранаУчастникЕАЭС(ШапкаДокумента.СтранаРегистрации) Тогда
		Возврат ТаблицаОперацииПрослеживаемости;
	КонецЕсли;
	
	РНПТДокумента = ПакетЗапросов[0].Выгрузить();
	НомерДокумента = дкПолучитьНомерДляПечати(ШапкаДокумента.Документ);
	
	Для Каждого ТекущаяСтрока Из РНПТДокумента Цикл
		
		НоваяСтрока = ТаблицаОперацииПрослеживаемости.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ШапкаДокумента);
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекущаяСтрока);
		НоваяСтрока.НомерДокумента = НомерДокумента;
		
	КонецЦикла;
	
	Возврат ТаблицаОперацииПрослеживаемости;
	
КонецФункции

#Если Клиент Тогда
////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ПЕЧАТИ ДОКУМЕНТА

// Формирует печатную форму "Накладная"
// Возвращает сформированный табличный документ:
Функция ПечатьРеализацияАвтомобилей(ТабДокумент) Экспорт
	Макет = ПолучитьМакет("РеализацияАвтомобилей");
	
	//для начала настроим макет
	ОбластьШапкаТаблицы = орПривестиМакетПечатнойФормы(ЭтотОбъект,Макет);
	ФорматВыводаСуммы = обПраво("ФорматВыводаСуммы",Права,,ЭтотОбъект);
	
	//вывод заголовка документа
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
	ТекстЗаголовка = дкПолучитьПредставление(ЭтотОбъект);
	ОбластьМакета.Параметры.ТекстЗаголовка = ТекстЗаголовка;     
	
    ОбластьМакета.Параметры.ПредставлениеПоставщика = спПолучитьПредставление(Организация, 
	Новый Структура("Наименование,ИНН,КПП,АдресЮридический,ТелефонРабочий,ОКПО","","ИНН ","КПП ","","тел.: ","Код по ОКПО "));
	ОбластьМакета.Параметры.ПредставлениеПокупателя = спПолучитьПредставление(Контрагент, 
	Новый Структура("Наименование,ИНН,КПП,АдресЮридический,ТелефонРабочий,ОКПО","","ИНН ","КПП ","","тел.: ","Код по ОКПО "));
	
	//СтруктураПараметров = Новый Структура("Наименование,ИНН,КПП,АдресЮридический,ТелефонРабочий,ОКПО",
	//	"", "ИНН ", "КПП ", "", "тел.: ", "Код по ОКПО ");
	//ДополнительныеПараметры = спСоздатьПараметрыПолученияПредставления();
	//ДополнительныеПараметры.Вставить("ИспользоватьКПППодразделения");
	//ДополнительныеПараметры.Вставить("ПодразделениеКомпании", ПодразделениеКомпании);
	//ОбластьМакета.Параметры.ПредставлениеПоставщика = спПолучитьПредставление(Организация, СтруктураПараметров, ДополнительныеПараметры);
	//ОбластьМакета.Параметры.ПредставлениеПокупателя = спПолучитьПредставление(Контрагент, СтруктураПараметров);
	ОбластьМакета.Параметры.ПредставлениеСклада = спПолучитьНаименование(СкладКомпании);
	//вывод свойств
	СтрокаСвойств = дкПолучитьСтрокуСвойствДокумента(ЭтотОбъект);
	ОбластьМакета.Параметры.СтрокаСвойств = СтрокаСвойств;
	ТабДокумент.Вывести(ОбластьМакета);
	НомерСтраницы = 2;
	НомерСтраницыПред = НомерСтраницы;
	
	//теперь выводим шапку
	ТабДокумент.Вывести(ОбластьШапкаТаблицы);
	
	//готовим области строки
	ОбластьМакета = Макет.ПолучитьОбласть("Строка");
	
	ОбластьМакетаИтогоПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице");
	СтруктураИтоговПоСтранице = Новый Структура("ВалютаДокумента,СуммаСкидки,СуммаНДС,СуммаВсего",ВалютаДокумента,0,0,0);
	//заполним параметры шапки таблицы для следующего листа
	ОбластьШапкаТаблицы.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
	
	//перебор строк
	ВыборкаТабличнойЧасти = ЭтотОбъект.Автомобили.Выгрузить();
	//подготовим дополнительную таблицу
	ТаблицаТоваровПоАвтомобилям = ЭтотОбъект.Товары.Выгрузить();
	ТаблицаТоваровПоАвтомобилям.Свернуть("ИдентификаторАвтомобиля","Сумма,СуммаНДС,СуммаСкидки,СуммаВсего");
	Для каждого СтрокаТабличнойЧасти Из ВыборкаТабличнойЧасти Цикл
		СтрокаТабличнойЧастиТовары = ТаблицаТоваровПоАвтомобилям.Найти(СтрокаТабличнойЧасти.ИдентификаторАвтомобиля,"ИдентификаторАвтомобиля");
		Если СтрокаТабличнойЧастиТовары<>Неопределено Тогда
			СтрокаТабличнойЧасти.Сумма = СтрокаТабличнойЧасти.Сумма + СтрокаТабличнойЧастиТовары.Сумма;
			СтрокаТабличнойЧасти.СуммаНДС = СтрокаТабличнойЧасти.СуммаНДС + СтрокаТабличнойЧастиТовары.СуммаНДС;
			СтрокаТабличнойЧасти.СуммаСкидки = СтрокаТабличнойЧасти.СуммаСкидки + СтрокаТабличнойЧастиТовары.СуммаСкидки;
			СтрокаТабличнойЧасти.СуммаВсего = СтрокаТабличнойЧасти.СуммаВсего + СтрокаТабличнойЧастиТовары.СуммаВсего;
		КонецЕсли;
	
		//заполняем данные строки
		СтруктураСтроки = орПолучитьПредставлениеДанныхТоварнойСтроки(СтрокаТабличнойЧасти,ЭтотОбъект);
		ОбластьМакета.Параметры.Заполнить(СтруктураСтроки);
		
		//выводим строку, делая проверку попадания на лист
		НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьМакета, ОбластьШапкаТаблицы, ОбластьМакетаИтогоПоСтранице, НомерСтраницы, СтруктураИтоговПоСтранице, ЭтотОбъект);
		
		//инициализация итогов по странице
		Если НомерСтраницы <> НомерСтраницыПред Тогда
			СтруктураИтоговПоСтранице = Новый Структура("ВалютаДокумента,СуммаСкидки,СуммаНДС,СуммаВсего",ВалютаДокумента,0,0,0);
			НомерСтраницыПред = НомерСтраницы;
			ОбластьШапкаТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
		КонецЕсли;
		//добавляем итоги
		дкДобавитьИтогиПоСтранице(СтрокаТабличнойЧасти,СтруктураИтоговПоСтранице);
	КонецЦикла;
	//довыводим последний подвал, если страниц больше единицы
	Если НомерСтраницы > 2 Тогда
		дкВывестиИтогиПоСтранице(ТабДокумент,ОбластьМакетаИтогоПоСтранице,СтруктураИтоговПоСтранице,ЭтотОбъект);
	КонецЕсли;
	
	ОбластьМакета = Макет.ПолучитьОбласть("Подвал");
	ОбластьМакета.Параметры.ВалютаДокумента = ВалютаДокумента;
	СуммаВсего = ВыборкаТабличнойЧасти.Итог("СуммаВсего");
	ОбластьМакета.Параметры.СуммаВсего = Формат(СуммаВсего,ФорматВыводаСуммы);
	НДСВсего = ВыборкаТабличнойЧасти.Итог("СуммаНДС");
	ОбластьМакета.Параметры.НДСВсего = Формат(НДСВсего,ФорматВыводаСуммы);
	Если ВыборкаТабличнойЧасти.Итог("СуммаСкидки")>0 Тогда
		СкидкаВсего = ВыборкаТабличнойЧасти.Итог("СуммаСкидки");
		ОбластьМакета.Параметры.СкидкаВсего = Формат(СкидкаВсего,ФорматВыводаСуммы);
	КонецЕсли;
	
	ОбластьМакета.Параметры.СуммаПрописью = "Всего наименований "+ВыборкаТабличнойЧасти.Количество()+" на сумму " + обЧислоПрописью(СуммаВсего,ЭтотОбъект.ВалютаДокумента);
	
	// Выводим представления и расшифровки подписей
	Отпустил = дкОтветственноеЛицо(ЭтотОбъект,"Отпустил");
	Отпустил.ОтпустилПредставление = ?(обЗначениеНеЗаполнено(Отпустил.Отпустил),"","/ "+ Отпустил.ОтпустилПредставление);
	ОбластьМакета.Параметры.Заполнить(Отпустил);
	Получил  = дкОтветственноеЛицо(ЭтотОбъект,"Получил");
	Получил.ПолучилПредставление = ?(обЗначениеНеЗаполнено(Получил.Получил),"","/ "+ Получил.ПолучилПредставление);
	ОбластьМакета.Параметры.Заполнить(Получил);
	
	НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьМакета, , , НомерСтраницы,,ЭтотОбъект);
	
	Возврат ТабДокумент;
КонецФункции

// Формирует печатную форму "ТОРГ-12"
// Возвращает сформированный табличный документ:
Функция ПечатьТОРГ12(ТабДокумент) Экспорт
	Макет = ПолучитьОбщийМакет("ТОРГ12");
	// Зададим параметры макета
	ТабДокумент.ПолеСверху = 0;
	ТабДокумент.ПолеСлева  = 0;
	ТабДокумент.ПолеСнизу  = 0;
	ТабДокумент.ПолеСправа = 0;
	ТабДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	
	// Получим валюту регламентированного учета для перерасчета цены и суммы
	ВалютаРегл = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
	
	СтруктураПредставления1=Новый Структура(
		"Наименование,ИНН,КПП,АдресЮридический,ТелефонРабочий,БанковскийСчет,Банк,БИК,КоррСчет",
		"","ИНН ","КПП ","","тел.: ","р/с ","в банке ","БИК ","к/с "
	);
	СтруктураПредставления2=Новый Структура(
		"Наименование,ИНН,КПП,АдресФактический,ТелефонРабочий,БанковскийСчет,Банк,БИК,КоррСчет",
		"","ИНН ","КПП ","","тел.: ","р/с ","в банке ","БИК ","к/с "
	);
	
	// получим р/с из свойств документа
	РасчетныйСчетДокумента=обПолучитьЗначениеСвойства(ЭтотОбъект, "РасчетныйСчет", Неопределено);
	
	// Правим, что автоматом не заполнилось, или заполнилось неправильно
	//bz++
	// Правим, что автоматом не заполнилось, или заполнилось неправильно
	ОбластьМакета.Параметры.ОрганизацияПредставление= спПолучитьПредставление(ОбластьМакета.Параметры.ПодразделениеКомпании,СтруктураПредставления2,Истина,РасчетныйСчетДокумента);
	//ДополнительныеПараметры = спСоздатьПараметрыПолученияПредставления();
	//ДополнительныеПараметры.ДляПечати = Истина;
	//ДополнительныеПараметры.РасчетныйСчетДокумента = РасчетныйСчетДокумента;
	//ОбластьМакета.Параметры.ОрганизацияПредставление= спПолучитьПредставление(
	//	ОбластьМакета.Параметры.ПодразделениеКомпании, СтруктураПредставления2, ДополнительныеПараметры);
	//bz--
	
	ОбластьМакета.Параметры.Поставщик				= обПолучитьЗначениеСвойства(ЭтотОбъект,"ПоставщикОрганизация",ЭтотОбъект.Организация);
	ОбластьМакета.Параметры.ПоставщикПредставление	= спПолучитьПредставление(ОбластьМакета.Параметры.Поставщик,СтруктураПредставления2);
	
	ОбластьМакета.Параметры.Грузополучатель				= обПолучитьЗначениеСвойства(ЭтотОбъект,"Грузополучатель",ЭтотОбъект.Контрагент);
	ОбластьМакета.Параметры.ГрузополучательПредставление= спПолучитьПредставление(ОбластьМакета.Параметры.Грузополучатель,СтруктураПредставления2);
	ОбластьМакета.Параметры.Плательщик					= обПолучитьЗначениеСвойства(ЭтотОбъект,"Плательщик",ЭтотОбъект.Контрагент);
	ОбластьМакета.Параметры.ПлательщикПредставление		= спПолучитьПредставление(ОбластьМакета.Параметры.Плательщик,СтруктураПредставления1);
	
	//дальше заполнить Шапку
	ОбластьМакета.Параметры.КодПоОКПО				= ЭтотОбъект.Организация.КодПоОКПО;
	ОбластьМакета.Параметры.ВидДеятельностиПоОКДП	= ЭтотОбъект.Организация.КодПоОКДП;
	ОбластьМакета.Параметры.ГрузополучательПоОКПО	= ОбластьМакета.Параметры.Грузополучатель.КодПоОКПО;
	ОбластьМакета.Параметры.ПоставщикПоОКПО			= ОбластьМакета.Параметры.Поставщик.КодПоОКПО;
	ОбластьМакета.Параметры.ПлательщикПоОКПО		= ОбластьМакета.Параметры.Плательщик.КодПоОКПО;
	
	ОбластьМакета.Параметры.ДокументОснованиеПредставление = ДоговорВзаиморасчетов.Наименование;
	ОбластьМакета.Параметры.ДокументОснование = ДоговорВзаиморасчетов;
	ОбластьМакета.Параметры.ОснованиеДата = "";
	ОбластьМакета.Параметры.ОснованиеНомер = ""; 
	
	ОбластьМакета.Параметры.Номер = дкПолучитьНомерДляПечати(ЭтотОбъект);	
	ТабДокумент.Вывести(ОбластьМакета);
	
	ОбластьЗаголовокТаблицы	= Макет.ПолучитьОбласть("ЗаголовокТаблицы");
	ОбластьСтрока			= Макет.ПолучитьОбласть("Строка");
	ОбластьИтоги			= Макет.ПолучитьОбласть("ИтогоПоСтранице");
	ОбластьВсего			= Макет.ПолучитьОбласть("Всего");
	//ОбластьВсегоСтавкаНДС	= Макет.ПолучитьОбласть("ВсегоСтавкаНДС");
	ОбластьПодвал			= Макет.ПолучитьОбласть("Подвал");		

	НомерСтраницы	= 1;
	ОбластьЗаголовокТаблицы.Параметры.Валюта = ВалютаРегл;
	ТабДокумент.Вывести(ОбластьЗаголовокТаблицы);
	КоличествоСтрокНаТекущейСтранице=0;
	ИспользоватьРазбиениеНаСтраницы = обПраво("ИспользоватьРазбиениеНаСтраницы", Права,,ЭтотОбъект);

	ВыборкаСтрок = ЭтотОбъект.Автомобили;
	КоличествоСтрок = ВыборкаСтрок.Количество();
	
	// инициализация итогов по странице
	ИтогоКоличествоНаСтранице = 0;
	ИтогоСуммаНаСтранице      = 0;
	ИтогоНДСНаСтранице        = 0;
	ИтогоСуммаСНДСНаСтранице  = 0;

	// инициализация итогов по документу
	ИтогоКоличество = 0;
	ИтогоСумма      = 0;
	ИтогоНДС        = 0;
	ИтогоСуммаСНДС  = 0;
	
	МакетКлассификаторовЕдиницИзмерения = Справочники.КлассификаторЕдиницИзмерения.ПолучитьМакет("КлассификаторЕдиницИзмерения");
	ОбластьНаименованиеПолное = МакетКлассификаторовЕдиницИзмерения.ПолучитьОбласть("НаименованиеКраткое");
	Ном = 0;
	НайденКод = Ложь;
	Пока Ном<ОбластьНаименованиеПолное.ВысотаТаблицы Цикл
		Если ОбластьНаименованиеПолное.Область(Ном,1,Ном,1).Текст = "шт" Тогда
			НайденКод = Истина;
			Прервать;
		КонецЕсли;
		Ном=Ном+1;
	КонецЦикла;
	
	КодПоОКЕЙ = ?(НайденКод, МакетКлассификаторовЕдиницИзмерения.ПолучитьОбласть("КодЧисловой").Область(Ном,1,Ном,1).Текст, "шт");
	
	СоответствиеИтоговПоставкамНДС = Новый Соответствие();
	
	// Выводим многострочную часть документа
	Для каждого СтрокаТоваров Из ВыборкаСтрок Цикл
		// Для переноса последней страницы необходимо посчитать количество итогов по НДС
		СуммаВсегоАвтомобиля=СтрокаТоваров.СуммаВсего;
		СуммаНДСАвтомобиля=СтрокаТоваров.СуммаНДС;
		Для каждого СтрокаТЧ Из Товары Цикл
			Если СтрокаТЧ.ИдентификаторАвтомобиля=СтрокаТоваров.ИдентификаторАвтомобиля Тогда
				СуммаВсегоАвтомобиля=СуммаВсегоАвтомобиля+СтрокаТЧ.СуммаВсего;
				СуммаНДСАвтомобиля=СуммаНДСАвтомобиля+СтрокаТЧ.СуммаНДС;
			КонецЕсли;
			// итоги по ставкам НДС
			Если НЕ обЗначениеНеЗаполнено(СтрокаТЧ.СтавкаНДС) Тогда
				Если СоответствиеИтоговПоставкамНДС[СтрокаТЧ.СтавкаНДС]=Неопределено Тогда
					СоответствиеИтоговПоставкамНДС.Вставить(СтрокаТЧ.СтавкаНДС,0);
				КонецЕсли;
				СоответствиеИтоговПоставкамНДС[СтрокаТЧ.СтавкаНДС]=СоответствиеИтоговПоставкамНДС[СтрокаТЧ.СтавкаНДС]+СтрокаТЧ.СуммаНДС;
			КонецЕсли;
		КонецЦикла;
		// итоги по ставкам НДС
		Если НЕ обЗначениеНеЗаполнено(СтрокаТоваров.СтавкаНДС) Тогда
			Если СоответствиеИтоговПоставкамНДС[СтрокаТоваров.СтавкаНДС]=Неопределено Тогда
				СоответствиеИтоговПоставкамНДС.Вставить(СтрокаТоваров.СтавкаНДС,0);
			КонецЕсли;
			СоответствиеИтоговПоставкамНДС[СтрокаТоваров.СтавкаНДС]=СоответствиеИтоговПоставкамНДС[СтрокаТоваров.СтавкаНДС]+СуммаНДСАвтомобиля;
		КонецЕсли;
		Если ИспользоватьРазбиениеНаСтраницы И КоличествоСтрокНаТекущейСтранице>0 Тогда
			// Проверим, помещаются ли нужные области на странице
			Если СтрокаТоваров.НомерСтроки = КоличествоСтрок Тогда
				// только на последнем шаге, когда нужно вывести все
				МассивОбластей = Новый Массив();
				МассивОбластей.Добавить(ОбластьСтрока);
				МассивОбластей.Добавить(ОбластьИтоги);
				МассивОбластей.Добавить(ОбластьВсего);
				//Для Каждого СтрокаИтоговНДС Из СоответствиеИтоговПоставкамНДС Цикл
				//	МассивОбластей.Добавить(ОбластьВсегоСтавкаНДС);				
				//КонецЦикла;
	            МассивОбластей.Добавить(ОбластьПодвал);
			Иначе
				МассивОбластей = Новый Массив();			
				МассивОбластей.Добавить(ОбластьСтрока);
				МассивОбластей.Добавить(ОбластьИтоги);
			КонецЕсли;
			Попытка
				Если Не ТабДокумент.ПроверитьВывод(МассивОбластей) Тогда
					ОбластьИтоги.Параметры.ИтогКоличествоПоСтранице = ИтогоКоличествоНаСтранице;
					ОбластьИтоги.Параметры.ИтогСуммыПоСтранице      = ИтогоСуммаНаСтранице;
					ОбластьИтоги.Параметры.ИтогНДСПоСтранице        = ИтогоНДСНаСтранице;
					ОбластьИтоги.Параметры.ИтогСуммыСНДСПоСтранице  = ИтогоСуммаСНДСНаСтранице;
					ТабДокумент.Вывести(ОбластьИтоги);

					// очистим итоги по странице
					ИтогоКоличествоНаСтранице = 0;
					ИтогоСуммаНаСтранице      = 0;
					ИтогоНДСНаСтранице        = 0;
					ИтогоСуммаСНДСНаСтранице  = 0;

					НомерСтраницы = НомерСтраницы + 1;
					ТабДокумент.ВывестиГоризонтальныйРазделительСтраниц();
					ОбластьЗаголовокТаблицы.Параметры.НомерСтраницы = "Страница " + НомерСтраницы;
					ТабДокумент.Вывести(ОбластьЗаголовокТаблицы);
					КоличествоСтрокНаТекущейСтранице=0;
				КонецЕсли;
			Исключение
			КонецПопытки;
		КонецЕсли; 

		//заполняем данные строки
		ОбластьСтрока.Параметры.Заполнить(СтрокаТоваров);
		ОбластьСтрока.Параметры.Номенклатура=СтрокаТоваров.Автомобиль;
		ОбластьСтрока.Параметры.ТоварНаименование=спПолучитьНаименование(СтрокаТоваров.Автомобиль);
		ОбластьСтрока.Параметры.Код = СтрокаТоваров.Автомобиль.VIN;
		ОбластьСтрока.Параметры.БазоваяЕдиницаНаименование="шт";
		ОбластьСтрока.Параметры.БазоваяЕдиницаКодПоОКЕИ=КодПоОКЕЙ;
		ОбластьСтрока.Параметры.КоличествоВОдномМесте=1;
		ОбластьСтрока.Параметры.КоличествоМест=1; 
		
		//ОбластьСтрока.Параметры.СтавкаНДС = СтрокаТоваров.СтавкаНДС.Ставка;
		ОбластьСтрока.Параметры.СтавкаНДС = дкПолучитьПредставлениеСтавкиНДС(СтрокаТоваров.СтавкаНДС);
		
		// Выполним перерасчет суммы и цены по регламентированной валюте
		СуммаВсегоАвтомобиля = Окр(обПересчет(СуммаВсегоАвтомобиля, ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата), 2);
		СуммаНДСАвтомобиля   = Окр(обПересчет(СуммаНДСАвтомобиля, ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата), 2);
		
		СуммаАвтомобиляБезНДС=СуммаВсегоАвтомобиля - СуммаНДСАвтомобиля;
		ОбластьСтрока.Параметры.ЦенаБезНДС = СуммаАвтомобиляБезНДС;
		ОбластьСтрока.Параметры.СуммаБезНДС = СуммаАвтомобиляБезНДС;
		ОбластьСтрока.Параметры.СуммаНДС = ?(СтрокаТоваров.СтавкаНДС = Справочники.СтавкиНДС.БезНДС, "", СуммаНДСАвтомобиля);
		ОбластьСтрока.Параметры.СуммаВсего = СуммаВсегоАвтомобиля;
		
		ТабДокумент.Вывести(ОбластьСтрока);
		КоличествоСтрокНаТекущейСтранице=КоличествоСтрокНаТекущейСтранице+1;

		// увеличим итоги по странице
		ИтогоКоличествоНаСтранице = ИтогоКоличествоНаСтранице + СтрокаТоваров.Количество;
		ИтогоСуммаНаСтранице      = ИтогоСуммаНаСтранице      + СуммаАвтомобиляБезНДС;
		ИтогоНДСНаСтранице        = ИтогоНДСНаСтранице        + СуммаНДСАвтомобиля;
		ИтогоСуммаСНДСНаСтранице  = ИтогоСуммаСНДСНаСтранице  + СуммаВсегоАвтомобиля;
		
		//Сформируем итоги по документу
		ИтогоСумма      = ИтогоСумма + СуммаАвтомобиляБезНДС;
		ИтогоНДС        = ИтогоНДС + СуммаНДСАвтомобиля;
		ИтогоСуммаСНДС  = ИтогоСуммаСНДС + СуммаВсегоАвтомобиля;
		
	КонецЦикла;
	
	// Выводим итоги по последней странице
	ОбластьИтоги.Параметры.ИтогКоличествоПоСтранице = ИтогоКоличествоНаСтранице;
	ОбластьИтоги.Параметры.ИтогСуммыПоСтранице      = ИтогоСуммаНаСтранице;
	ОбластьИтоги.Параметры.ИтогНДСПоСтранице        = ИтогоНДСНаСтранице;
	ОбластьИтоги.Параметры.ИтогСуммыСНДСПоСтранице  = ИтогоСуммаСНДСНаСтранице;
	ТабДокумент.Вывести(ОбластьИтоги);
	
	// Выводим итоги по документу в целом
	ОбластьВсего.Параметры.ИтогКоличество = ВыборкаСтрок.Итог("Количество");
	ОбластьВсего.Параметры.ИтогСуммы      = ИтогоСумма;
	ОбластьВсего.Параметры.ИтогНДС        = ИтогоНДС;
	ОбластьВсего.Параметры.ИтогСуммыСНДС  = ИтогоСуммаСНДС;
	ТабДокумент.Вывести(ОбластьВсего);
	
	//// выведем итоги по ставкам НДС
	//Для Каждого ЭлементСоответствия Из СоответствиеИтоговПоставкамНДС Цикл
	//	ОбластьВсегоСтавкаНДС.Параметры.СтавкаНДС = "Итого по ставке НДС: "+СокрЛП(ЭлементСоответствия.Ключ);
	//	ОбластьВсегоСтавкаНДС.Параметры.ИтогНДС = ЭлементСоответствия.Значение;
	//	ТабДокумент.Вывести(ОбластьВсегоСтавкаНДС);
	//КонецЦикла;
	
	// Выводим подвал документа
	ОбластьМакета = ОбластьПодвал;
	ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
	ОбластьМакета.Параметры.КоличествоПорядковыхНомеровЗаписейПрописью = ЧислоПрописью(КоличествоСтрок, ,",,,,,,,,0");
	ОбластьМакета.Параметры.СуммаПрописью = обЧислоПрописью(ИтогоСуммаСНДС,ВалютаРегл);
	
	Доверенность = обПолучитьЗначениеСвойства(ЭтотОбъект,"Доверенность");
	Если НЕ обЗначениеНеЗаполнено(Доверенность) Тогда
		ОбластьМакета.Параметры.ДоверенностьНомер = ?(ПустаяСтрока(Доверенность.Серия),"",Доверенность.Серия + "-") + Доверенность.Номер;
		ОбластьМакета.Параметры.ДоверенностьДата  = Доверенность.ДатаВыдачи;
		ОбластьМакета.Параметры.ДоверенностьВыдана= Доверенность.КемВыдан;
		ВладелецДоверенности = Доверенность.Владелец;
		Если ТипЗнч(ВладелецДоверенности)=Тип("СправочникСсылка.Контрагенты") ИЛИ
			 ТипЗнч(ВладелецДоверенности)=Тип("СправочникСсылка.Организации") Тогда
			ОбластьМакета.Параметры.ДоверенностьЧерезКого = спПолучитьНаименование(ВладелецДоверенности);
		ИначеЕсли ТипЗнч(ВладелецДоверенности)=Тип("СправочникСсылка.Сотрудники") Тогда
			ОбластьМакета.Параметры.ДоверенностьЧерезКого = ?(обЗначениеНеЗаполнено(ВладелецДоверенности.Должность),"",спПолучитьНаименование(ВладелецДоверенности.Должность)+", ")+спПолучитьНаименование(ВладелецДоверенности);
		КонецЕсли;
	КонецЕсли; 
	
	ДатаОтгрузки=обПолучитьЗначениеСвойства(ЭтотОбъект,"ДатаОтгрузки",Дата('00010101'));
	ДатаОтгрузки=?(обЗначениеНеЗаполнено(ДатаОтгрузки),"""___""____________ 20___",Формат(ДатаОтгрузки,"ДФ=dd.MM.yyyy"));
	ОбластьМакета.Параметры.ДатаОтгрузки = ДатаОтгрузки;
	
	// Заполним информацию о руководителях организации
	Руководитель = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.Руководитель);
	ОбластьМакета.Параметры.Заполнить(Руководитель);
	
	ГлавныйБухгалтер = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.ГлавныйБухгалтер);
	ОбластьМакета.Параметры.Заполнить(ГлавныйБухгалтер);
	
	Отпустил = дкОтветственноеЛицо(ЭтотОбъект,"Отпустил");
	ОбластьМакета.Параметры.Заполнить(Отпустил);
	
	Получил = дкОтветственноеЛицо(ЭтотОбъект,"Получил");
	ОбластьМакета.Параметры.Заполнить(Получил);
	
	ТабДокумент.Вывести(ОбластьМакета);

	Возврат ТабДокумент;
КонецФункции

// Формирует печатную форму "ТОРГ-12" (дооборудование автомобиля)
// Возвращает сформированный табличный документ:
Функция ПечатьТОРГ12Развернутая(ТабДокумент) Экспорт
	Макет = ПолучитьОбщийМакет("ТОРГ12");
	// Зададим параметры макета
	ТабДокумент.ПолеСверху = 0;
	ТабДокумент.ПолеСлева  = 0;
	ТабДокумент.ПолеСнизу  = 0;
	ТабДокумент.ПолеСправа = 0;
	ТабДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	
	// Получим валюту регламентированного учета для перерасчета цены и суммы
	ВалютаРегл = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
	
	СтруктураПредставления1=Новый Структура(
		"Наименование,ИНН,КПП,АдресЮридический,ТелефонРабочий,БанковскийСчет,Банк,БИК,КоррСчет",
		"","ИНН ","КПП ","","тел.: ","р/с ","в банке ","БИК ","к/с "
	);
	СтруктураПредставления2=Новый Структура(
		"Наименование,ИНН,КПП,АдресФактический,ТелефонРабочий,БанковскийСчет,Банк,БИК,КоррСчет",
		"","ИНН ","КПП ","","тел.: ","р/с ","в банке ","БИК ","к/с "
	);
	
	// получим р/с из свойств документа
	РасчетныйСчетДокумента=обПолучитьЗначениеСвойства(ЭтотОбъект, "РасчетныйСчет", Неопределено);
	
	//bz++
	// Правим, что автоматом не заполнилось, или заполнилось неправильно
	ОбластьМакета.Параметры.ОрганизацияПредставление= спПолучитьПредставление(ОбластьМакета.Параметры.ПодразделениеКомпании,СтруктураПредставления2,Истина,РасчетныйСчетДокумента);
	//ДополнительныеПараметры = спСоздатьПараметрыПолученияПредставления();
	//ДополнительныеПараметры.ДляПечати = Истина;
	//ДополнительныеПараметры.РасчетныйСчетДокумента = РасчетныйСчетДокумента;
	//ОбластьМакета.Параметры.ОрганизацияПредставление= спПолучитьПредставление(
	//	ОбластьМакета.Параметры.ПодразделениеКомпании, СтруктураПредставления2, ДополнительныеПараметры);
	//bz--
	
	ОбластьМакета.Параметры.Поставщик				= обПолучитьЗначениеСвойства(ЭтотОбъект,"ПоставщикОрганизация",ЭтотОбъект.Организация);
	ОбластьМакета.Параметры.ПоставщикПредставление	= спПолучитьПредставление(ОбластьМакета.Параметры.Поставщик,СтруктураПредставления2);
	
	ОбластьМакета.Параметры.Грузополучатель				= обПолучитьЗначениеСвойства(ЭтотОбъект,"Грузополучатель",ЭтотОбъект.Контрагент);
	ОбластьМакета.Параметры.ГрузополучательПредставление= спПолучитьПредставление(ОбластьМакета.Параметры.Грузополучатель,СтруктураПредставления2);
	ОбластьМакета.Параметры.Плательщик					= обПолучитьЗначениеСвойства(ЭтотОбъект,"Плательщик",ЭтотОбъект.Контрагент);
	ОбластьМакета.Параметры.ПлательщикПредставление		= спПолучитьПредставление(ОбластьМакета.Параметры.Плательщик,СтруктураПредставления1);
	
	//дальше заполнить Шапку
	ОбластьМакета.Параметры.КодПоОКПО				= ЭтотОбъект.Организация.КодПоОКПО;
	ОбластьМакета.Параметры.ВидДеятельностиПоОКДП	= ЭтотОбъект.Организация.КодПоОКДП;
	ОбластьМакета.Параметры.ГрузополучательПоОКПО	= ОбластьМакета.Параметры.Грузополучатель.КодПоОКПО;
	ОбластьМакета.Параметры.ПоставщикПоОКПО			= ОбластьМакета.Параметры.Поставщик.КодПоОКПО;
	ОбластьМакета.Параметры.ПлательщикПоОКПО		= ОбластьМакета.Параметры.Плательщик.КодПоОКПО;
	
	ОбластьМакета.Параметры.ДокументОснованиеПредставление = ДоговорВзаиморасчетов.Наименование;
	ОбластьМакета.Параметры.ДокументОснование = ДоговорВзаиморасчетов;
	ОбластьМакета.Параметры.ОснованиеДата = "";
	ОбластьМакета.Параметры.ОснованиеНомер = ""; 
	
	ОбластьМакета.Параметры.Номер = дкПолучитьНомерДляПечати(ЭтотОбъект);	
	ТабДокумент.Вывести(ОбластьМакета);
	
	ОбластьЗаголовокТаблицы	= Макет.ПолучитьОбласть("ЗаголовокТаблицы");
	ОбластьСтрока			= Макет.ПолучитьОбласть("Строка");
	ОбластьИтоги			= Макет.ПолучитьОбласть("ИтогоПоСтранице");
	ОбластьВсего			= Макет.ПолучитьОбласть("Всего");
	//ОбластьВсегоСтавкаНДС	= Макет.ПолучитьОбласть("ВсегоСтавкаНДС");
	ОбластьПодвал			= Макет.ПолучитьОбласть("Подвал");		

	НомерСтраницы	= 1;
	ОбластьЗаголовокТаблицы.Параметры.Валюта = ВалютаРегл;
	ТабДокумент.Вывести(ОбластьЗаголовокТаблицы);
	КоличествоСтрокНаТекущейСтранице=0;
	ИспользоватьРазбиениеНаСтраницы = обПраво("ИспользоватьРазбиениеНаСтраницы", Права,,ЭтотОбъект);
	
	// инициализация итогов по странице
	ИтогоКоличествоНаСтранице = 0;
	ИтогоСуммаНаСтранице      = 0;
	ИтогоНДСНаСтранице        = 0;
	ИтогоСуммаСНДСНаСтранице  = 0;

	// инициализация итогов по документу
	ИтогоКоличество = 0;
	ИтогоСумма      = 0;
	ИтогоНДС        = 0;
	ИтогоСуммаСНДС  = 0;
	
	МакетКлассификаторовЕдиницИзмерения = Справочники.КлассификаторЕдиницИзмерения.ПолучитьМакет("КлассификаторЕдиницИзмерения");
	ОбластьНаименованиеПолное = МакетКлассификаторовЕдиницИзмерения.ПолучитьОбласть("НаименованиеКраткое");
	Ном = 0;
	НайденКод = Ложь;
	Пока Ном<ОбластьНаименованиеПолное.ВысотаТаблицы Цикл
		Если ОбластьНаименованиеПолное.Область(Ном,1,Ном,1).Текст = "шт" Тогда
			НайденКод = Истина;
			Прервать;
		КонецЕсли;
		Ном=Ном+1;
	КонецЦикла;
	
	КодПоОКЕЙ = ?(НайденКод, МакетКлассификаторовЕдиницИзмерения.ПолучитьОбласть("КодЧисловой").Область(Ном,1,Ном,1).Текст, "шт");
	
	СоответствиеИтоговПоставкамНДС = Новый Соответствие();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	РеализацияАвтомобилейАвтомобили.Автомобиль КАК Номенклатура,
	               |	РеализацияАвтомобилейАвтомобили.Автомобиль.VIN КАК Код,
	               |	""шт"" КАК БазоваяЕдиницаНаименование,
	               |	&КодПоОКЕЙ КАК БазоваяЕдиницаКодПоОКЕИ,
	               |	1 КАК Количество,
	               |	1 КАК КоличествоВОдномМесте,
	               |	1 КАК КоличествоМест,
	               |	РеализацияАвтомобилейАвтомобили.СтавкаНДС.Ставка КАК СтавкаНДС,
	               |	РеализацияАвтомобилейАвтомобили.СуммаВсего КАК СуммаВсего,
	               |	РеализацияАвтомобилейАвтомобили.СуммаНДС КАК СуммаНДС,
	               |	РеализацияАвтомобилейАвтомобили.СтавкаНДС КАК СтавкаНДССтроки
	               |ИЗ
	               |	Документ.РеализацияАвтомобилей.Автомобили КАК РеализацияАвтомобилейАвтомобили
	               |ГДЕ
	               |	РеализацияАвтомобилейАвтомобили.Ссылка = &Ссылка
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	РеализацияАвтомобилейТовары.Номенклатура,
	               |	"""",
	               |	РеализацияАвтомобилейТовары.ЕдиницаИзмерения,
	               |	РеализацияАвтомобилейТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код,
	               |	РеализацияАвтомобилейТовары.Количество * РеализацияАвтомобилейТовары.Коэффициент,
	               |	РеализацияАвтомобилейТовары.Коэффициент,
	               |	РеализацияАвтомобилейТовары.Количество,
	               |	РеализацияАвтомобилейТовары.СтавкаНДС.Ставка,
	               |	РеализацияАвтомобилейТовары.СуммаВсего,
	               |	РеализацияАвтомобилейТовары.СуммаНДС,
	               |	РеализацияАвтомобилейТовары.СтавкаНДС
	               |ИЗ
	               |	Документ.РеализацияАвтомобилей.Товары КАК РеализацияАвтомобилейТовары
	               |ГДЕ
	               |	РеализацияАвтомобилейТовары.Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Ссылка",    ЭтотОбъект.Ссылка);
	Запрос.УстановитьПараметр("КодПоОКЕЙ", КодПоОКЕЙ);
	ВыборкаСтрок = Запрос.Выполнить().Выгрузить();
	
	КоличествоСтрок = ВыборкаСтрок.Количество();
	
	НомерСтроки = 1;
	
	// Выводим многострочную часть документа
	Для каждого СтрокаТоваров Из ВыборкаСтрок Цикл
		Если ИспользоватьРазбиениеНаСтраницы И КоличествоСтрокНаТекущейСтранице>0 Тогда
			// Проверим, помещаются ли нужные области на странице
			Если НомерСтроки = КоличествоСтрок Тогда
				// только на последнем шаге, когда нужно вывести все
				МассивОбластей = Новый Массив();
				МассивОбластей.Добавить(ОбластьСтрока);
				МассивОбластей.Добавить(ОбластьИтоги);
				МассивОбластей.Добавить(ОбластьВсего);
				//Для Каждого СтрокаИтоговНДС Из СоответствиеИтоговПоставкамНДС Цикл
				//	МассивОбластей.Добавить(ОбластьВсегоСтавкаНДС);				
				//КонецЦикла;
	            МассивОбластей.Добавить(ОбластьПодвал);
			Иначе
				МассивОбластей = Новый Массив();			
				МассивОбластей.Добавить(ОбластьСтрока);
				МассивОбластей.Добавить(ОбластьИтоги);
			КонецЕсли; 
			Попытка
				Если Не ТабДокумент.ПроверитьВывод(МассивОбластей) Тогда
					ОбластьИтоги.Параметры.ИтогКоличествоПоСтранице = ИтогоКоличествоНаСтранице;
					ОбластьИтоги.Параметры.ИтогСуммыПоСтранице      = ИтогоСуммаНаСтранице;
					ОбластьИтоги.Параметры.ИтогНДСПоСтранице        = ИтогоНДСНаСтранице;
					ОбластьИтоги.Параметры.ИтогСуммыСНДСПоСтранице  = ИтогоСуммаСНДСНаСтранице;
					ТабДокумент.Вывести(ОбластьИтоги);

					// очистим итоги по странице
					ИтогоКоличествоНаСтранице = 0;
					ИтогоСуммаНаСтранице      = 0;
					ИтогоНДСНаСтранице        = 0;
					ИтогоСуммаСНДСНаСтранице  = 0;

					НомерСтраницы = НомерСтраницы + 1;
					ТабДокумент.ВывестиГоризонтальныйРазделительСтраниц();
					ОбластьЗаголовокТаблицы.Параметры.НомерСтраницы = "Страница " + НомерСтраницы;
					ТабДокумент.Вывести(ОбластьЗаголовокТаблицы);
					КоличествоСтрокНаТекущейСтранице=0;
				КонецЕсли;
			Исключение
			КонецПопытки;
			
		КонецЕсли; 

		//заполняем данные строки
		ОбластьСтрока.Параметры.Заполнить(СтрокаТоваров);
		ОбластьСтрока.Параметры.НомерСтроки = НомерСтроки;
		ОбластьСтрока.Параметры.ТоварНаименование=спПолучитьНаименование(СтрокаТоваров.Номенклатура);
		ОбластьСтрока.Параметры.Код = ?(ТипЗнч(СтрокаТоваров.Номенклатура) = Тип("СправочникСсылка.Номенклатура"), дкПолучитьЗначениеКолонкиКода(СтрокаТоваров.Номенклатура,, ЭтотОбъект), СтрокаТоваров.Код);
		ОбластьСтрока.Параметры.СтавкаНДС = дкПолучитьПредставлениеСтавкиНДС(СтрокаТоваров.СтавкаНДССтроки);
		
		// Выполним перерасчет суммы и цены по регламентированной валюте
		СуммаВсего = Окр(обПересчет(СтрокаТоваров.СуммаВсего, ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата), 2);
		СуммаНДС   = Окр(обПересчет(СтрокаТоваров.СуммаНДС,   ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата), 2);
		
		СуммаБезНДС = СуммаВсего - СуммаНДС;
		ОбластьСтрока.Параметры.ЦенаБезНДС  = СуммаБезНДС;
		ОбластьСтрока.Параметры.СуммаБезНДС = СуммаБезНДС;
		ОбластьСтрока.Параметры.СуммаНДС    = ?(СтрокаТоваров.СтавкаНДС = Справочники.СтавкиНДС.БезНДС, "", СуммаНДС);
		ОбластьСтрока.Параметры.СуммаВсего  = СуммаВсего;
		
		ТабДокумент.Вывести(ОбластьСтрока);
		КоличествоСтрокНаТекущейСтранице=КоличествоСтрокНаТекущейСтранице+1;

		// увеличим итоги по странице
		ИтогоКоличествоНаСтранице = ИтогоКоличествоНаСтранице + СтрокаТоваров.Количество;
		ИтогоСуммаНаСтранице      = ИтогоСуммаНаСтранице      + СуммаБезНДС;
		ИтогоНДСНаСтранице        = ИтогоНДСНаСтранице        + СуммаНДС;
		ИтогоСуммаСНДСНаСтранице  = ИтогоСуммаСНДСНаСтранице  + СуммаВсего;
		
		//Сформируем итоги по документу
		ИтогоСумма      = ИтогоСумма + СуммаБезНДС;
		ИтогоНДС        = ИтогоНДС + СуммаНДС;
		ИтогоСуммаСНДС  = ИтогоСуммаСНДС + СуммаВсего;
		
		НомерСтроки = НомерСтроки + 1;
		
	КонецЦикла;
	
	// Выводим итоги по последней странице
	ОбластьИтоги.Параметры.ИтогКоличествоПоСтранице = ИтогоКоличествоНаСтранице;
	ОбластьИтоги.Параметры.ИтогСуммыПоСтранице      = ИтогоСуммаНаСтранице;
	ОбластьИтоги.Параметры.ИтогНДСПоСтранице        = ИтогоНДСНаСтранице;
	ОбластьИтоги.Параметры.ИтогСуммыСНДСПоСтранице  = ИтогоСуммаСНДСНаСтранице;
	ТабДокумент.Вывести(ОбластьИтоги);
	
	// Выводим итоги по документу в целом
	ОбластьВсего.Параметры.ИтогКоличество = ВыборкаСтрок.Итог("Количество");
	ОбластьВсего.Параметры.ИтогСуммы      = ИтогоСумма;
	ОбластьВсего.Параметры.ИтогНДС        = ИтогоНДС;
	ОбластьВсего.Параметры.ИтогСуммыСНДС  = ИтогоСуммаСНДС;
	ТабДокумент.Вывести(ОбластьВсего);
	
	//// выведем итоги по ставкам НДС
	//Для Каждого ЭлементСоответствия Из СоответствиеИтоговПоставкамНДС Цикл
	//	ОбластьВсегоСтавкаНДС.Параметры.СтавкаНДС = "Итого по ставке НДС: "+СокрЛП(ЭлементСоответствия.Ключ);
	//	ОбластьВсегоСтавкаНДС.Параметры.ИтогНДС = ЭлементСоответствия.Значение;
	//	ТабДокумент.Вывести(ОбластьВсегоСтавкаНДС);
	//КонецЦикла;
	
	// Выводим подвал документа
	ОбластьМакета = ОбластьПодвал;
	ОбластьМакета.Параметры.Заполнить(ЭтотОбъект);
	ОбластьМакета.Параметры.КоличествоПорядковыхНомеровЗаписейПрописью = ЧислоПрописью(КоличествоСтрок, ,",,,,,,,,0");
	ОбластьМакета.Параметры.СуммаПрописью = обЧислоПрописью(ИтогоСуммаСНДС,ВалютаРегл);
	
	Доверенность = обПолучитьЗначениеСвойства(ЭтотОбъект,"Доверенность");
	Если НЕ обЗначениеНеЗаполнено(Доверенность) Тогда
		ОбластьМакета.Параметры.ДоверенностьНомер = ?(ПустаяСтрока(Доверенность.Серия),"",Доверенность.Серия + "-") + Доверенность.Номер;
		ОбластьМакета.Параметры.ДоверенностьДата  = Доверенность.ДатаВыдачи;
		ОбластьМакета.Параметры.ДоверенностьВыдана= Доверенность.КемВыдан;
		ВладелецДоверенности = Доверенность.Владелец;
		Если ТипЗнч(ВладелецДоверенности)=Тип("СправочникСсылка.Контрагенты") ИЛИ
			 ТипЗнч(ВладелецДоверенности)=Тип("СправочникСсылка.Организации") Тогда
			ОбластьМакета.Параметры.ДоверенностьЧерезКого = спПолучитьНаименование(ВладелецДоверенности);
		ИначеЕсли ТипЗнч(ВладелецДоверенности)=Тип("СправочникСсылка.Сотрудники") Тогда
			ОбластьМакета.Параметры.ДоверенностьЧерезКого = ?(обЗначениеНеЗаполнено(ВладелецДоверенности.Должность),"",спПолучитьНаименование(ВладелецДоверенности.Должность)+", ")+спПолучитьНаименование(ВладелецДоверенности);
		КонецЕсли;
	КонецЕсли; 
	
	ДатаОтгрузки=обПолучитьЗначениеСвойства(ЭтотОбъект,"ДатаОтгрузки",Дата('00010101'));
	ДатаОтгрузки=?(обЗначениеНеЗаполнено(ДатаОтгрузки),"""___""____________ 20___",Формат(ДатаОтгрузки,"ДФ=dd.MM.yyyy"));
	ОбластьМакета.Параметры.ДатаОтгрузки = ДатаОтгрузки;
	
	// Заполним информацию о руководителях организации
	Руководитель = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.Руководитель);
	ОбластьМакета.Параметры.Заполнить(Руководитель);
	
	ГлавныйБухгалтер = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.ГлавныйБухгалтер);
	ОбластьМакета.Параметры.Заполнить(ГлавныйБухгалтер);
	
	Отпустил = дкОтветственноеЛицо(ЭтотОбъект,"Отпустил");
	ОбластьМакета.Параметры.Заполнить(Отпустил);
	
	Получил = дкОтветственноеЛицо(ЭтотОбъект,"Получил");
	ОбластьМакета.Параметры.Заполнить(Получил);
	
	ТабДокумент.Вывести(ОбластьМакета);

	Возврат ТабДокумент;
КонецФункции

// Формирует печатную форму Т-1 "Товарно-транспортная накладная"
// 
// Параметры:
//  ТабДокумент - табличный документ.
//
// Возвращаемое значение:
//  ТабДокумент - возвращает сформированный табличный документ.
//
Функция ПечатьТ1(ТабДокумент) Экспорт
	
	ФорматВыводаСуммы = обПраво("ФорматВыводаСуммы", Права,,ЭтотОбъект);
	ФорматВыводаКоличества = обПраво("ФорматВыводаКоличества", Права,,ЭтотОбъект);
	НомерДляПечати=дкПолучитьНомерДляПечати(ЭтотОбъект);
	
	ВалютаРегл = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	
	// Зададим параметры макета
	ТабДокумент.ПолеСверху = 0;
	ТабДокумент.ПолеСлева  = 0;
	ТабДокумент.ПолеСнизу  = 0;
	ТабДокумент.ПолеСправа = 0;
	ТабДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	
	Макет = ПолучитьОбщийМакет("ТТН");
	
	//дальше заполнить Шапку
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	
	СтруктураПредставления1=Новый Структура(
		"Наименование,ИНН,КПП,АдресЮридический,ТелефонРабочий,БанковскийСчет,Банк,БИК,КоррСчет",
		"","ИНН ","КПП ","","тел.: ","р/с ","в банке ","БИК ","к/с ");
	СтруктураПредставления2=Новый Структура(
		"Наименование,ИНН,КПП,АдресФактический,ТелефонРабочий,БанковскийСчет,Банк,БИК,КоррСчет",
		"","ИНН ","КПП ","","тел.: ","р/с ","в банке ","БИК ","к/с ");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ОбластьМакета.Параметры.НомерДокумента                = НомерДляПечати;
	ОбластьМакета.Параметры.ДатаДокумента                 = Формат(Дата,"ДФ=dd.MM.yyyy");
	ОбластьМакета.Параметры.Грузоотправитель              = ЭтотОбъект.Организация;
	ОбластьМакета.Параметры.Грузополучатель               = обПолучитьЗначениеСвойства(ЭтотОбъект,"Грузополучатель",ЭтотОбъект.Контрагент);
	ОбластьМакета.Параметры.Плательщик                    = обПолучитьЗначениеСвойства(ЭтотОбъект,"Плательщик",ЭтотОбъект.Контрагент);
	ОбластьМакета.Параметры.ГрузоотправительПредставление = спПолучитьПредставление(ОбластьМакета.Параметры.Грузоотправитель,СтруктураПредставления2);
	ОбластьМакета.Параметры.ГрузополучательПредставление  = спПолучитьПредставление(ОбластьМакета.Параметры.Грузополучатель,СтруктураПредставления2);
	ОбластьМакета.Параметры.ПлательщикПредставление       = спПолучитьПредставление(ОбластьМакета.Параметры.Плательщик,СтруктураПредставления1);
	ОбластьМакета.Параметры.ГрузополучательПоОКПО		  = ОбластьМакета.Параметры.Грузополучатель.КодПоОКПО;
	ОбластьМакета.Параметры.ГрузоотправительПоОКПО		  = ОбластьМакета.Параметры.Грузоотправитель.КодПоОКПО;
	ОбластьМакета.Параметры.ПлательщикПоОКПО			  = ОбластьМакета.Параметры.Плательщик.КодПоОКПО;
	ТабДокумент.Вывести(ОбластьМакета);
	
	// Выводим заголовок таблицы
	ОбластьЗаголовокТаблицы = Макет.ПолучитьОбласть("ЗаголовокТаблицы");
	ОбластьЗаголовокТаблицы.Параметры.Валюта=ВалютаРегл;
	ТабДокумент.Вывести(ОбластьЗаголовокТаблицы);
	
	НомерСтраницы	= 2;
	НомерСтраницыПред = НомерСтраницы;	
	
	// инициализация итогов по документу
	Ном            = 0;
	ИтогоМест      = 0;

	ОбластьСтрока	= Макет.ПолучитьОбласть("Строка");
	ОбластьИтоги	= Макет.ПолучитьОбласть("ИтогоПоСтранице");
	ОбластьВсего	= Макет.ПолучитьОбласть("Всего");
	ОбластьПодвал	= Макет.ПолучитьОбласть("Подвал");
	
	// инициализация итогов по странице
	СтруктураИтоговПоСтранице = Новый Структура("Количество, СуммаВсего",0,0);
	
	//заполним параметры шапки таблицы для следующего листа
	ОбластьЗаголовокТаблицы.Параметры.НомерСтраницы  = "Страница: " + НомерСтраницы;
	ОбластьЗаголовокТаблицы.Параметры.ТекстЗаголовка = "Товарно-транспортная накладная товарный раздел";
	
	ВыборкаАвтомобилей = ЭтотОбъект.Автомобили;
	КоличествоСтрок = ВыборкаАвтомобилей.Количество();

	//доп. области
	мсвДопОбластиПодвала = Новый Массив;
	мсвДопОбластиПодвала.Добавить(ОбластьВсего);
	мсвДопОбластиПодвала.Добавить(ОбластьПодвал);
	ИтогСуммаВсего = 0;
	// Выводим многострочную часть документа
	Для Каждого СтрокаАвтомобилей Из ВыборкаАвтомобилей Цикл
		//заполняем данные строки
		Ном = Ном + 1;
		
		СуммаВсего=Окр(обПересчет(СтрокаАвтомобилей.СуммаВсего, ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата), 2);
		СтрокиОпций=ЭтотОбъект.Товары.НайтиСтроки(Новый Структура("ИдентификаторАвтомобиля",СтрокаАвтомобилей.ИдентификаторАвтомобиля));
		Для каждого СтрокаОпций Из СтрокиОпций Цикл
			СуммаВсего=СуммаВсего+Окр(обПересчет(СтрокаОпций.СуммаВсего, ВалютаДокумента, КурсДокумента, ВалютаРегл, Дата), 2);
		КонецЦикла; 

		ОбластьСтрока.Параметры.КодПродукции				= СтрокаАвтомобилей.Автомобиль.VIN;
		//ОбластьСтрока.Параметры.Артикул 					= ;
		ОбластьСтрока.Параметры.Количество					= Формат(СтрокаАвтомобилей.Количество, ФорматВыводаКоличества);
		ОбластьСтрока.Параметры.Цена						= Формат(СуммаВсего, ФорматВыводаСуммы);
		ОбластьСтрока.Параметры.ТоварНаименование			= спПолучитьНаименование(СтрокаАвтомобилей.Автомобиль);
		ОбластьСтрока.Параметры.Номенклатура				= СтрокаАвтомобилей.Автомобиль;
		ОбластьСтрока.Параметры.БазоваяЕдиницаНаименование	= спПолучитьНаименование(Справочники.КлассификаторЕдиницИзмерения.шт);
		ОбластьСтрока.Параметры.ВидУпаковки					= Справочники.КлассификаторЕдиницИзмерения.шт;
		ОбластьСтрока.Параметры.КоличествоМест				= Формат(СтрокаАвтомобилей.Количество, ФорматВыводаКоличества);
		//ОбластьСтрока.Параметры.Масса						= ;
		ОбластьСтрока.Параметры.СуммаВсего					= Формат(СуммаВсего, ФорматВыводаСуммы);
		
		ИтогоМест = ИтогоМест + СтрокаАвтомобилей.Количество;
		
		//выводим строку, делая проверку попадания на лист		
		НомерСтраницы = дкВывестиГоризонтальнуюОбласть(ТабДокумент, ОбластьСтрока, ОбластьЗаголовокТаблицы, ОбластьИтоги, НомерСтраницы, СтруктураИтоговПоСтранице, ЭтотОбъект, ?(Ном=КоличествоСтрок,мсвДопОбластиПодвала,Неопределено));
		
		//инициализация итогов по странице
		Если НомерСтраницы <> НомерСтраницыПред Тогда
			СтруктураИтоговПоСтранице = Новый Структура("Количество, СуммаВсего",0,0);
			НомерСтраницыПред = НомерСтраницы;
			ОбластьЗаголовокТаблицы.Параметры.НомерСтраницы = "Страница: " + НомерСтраницы; 
		КонецЕсли;
				
		//обновим итоги по странице
		СтруктураИтоговПоСтранице.Количество = СтруктураИтоговПоСтранице.Количество + СтрокаАвтомобилей.Количество;
		СтруктураИтоговПоСтранице.СуммаВсего = СтруктураИтоговПоСтранице.СуммаВсего + (СуммаВсего);
		ИтогСуммаВсего = ИтогСуммаВсего + СуммаВсего;
	КонецЦикла;
	
	//довыводим последний подвал, если страниц больше единицы
	Если НомерСтраницы > 2 Тогда
		дкВывестиИтогиПоСтранице(ТабДокумент,ОбластьИтоги,СтруктураИтоговПоСтранице,ЭтотОбъект);
	КонецЕсли;
	
	ИтогоКоличество = ВыборкаАвтомобилей.Итог("Количество");
	ИтогоСуммаСНДС  = ИтогСуммаВсего;
	
	// Выводим итоги по документу в целом
	ОбластьВсего.Параметры.Количество = Формат(ИтогоКоличество, ФорматВыводаКоличества);
	ОбластьВсего.Параметры.СуммаВсего = Формат(ИтогоСуммаСНДС, ФорматВыводаСуммы);
	
	ТабДокумент.Вывести(ОбластьВсего);
	
	// Выводим подвал документа
	Руководитель = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.Руководитель);
	ОбластьПодвал.Параметры.Заполнить(Руководитель);
	ГлавныйБухгалтер = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.ГлавныйБухгалтер);
	ОбластьПодвал.Параметры.Заполнить(ГлавныйБухгалтер);
	Отпустил = дкОтветственноеЛицо(ЭтотОбъект,"Отпустил");
	ОбластьПодвал.Параметры.Заполнить(Отпустил);
	Получил  = дкОтветственноеЛицо(ЭтотОбъект,"Получил");
	ОбластьПодвал.Параметры.Заполнить(Получил);
	ОбластьПодвал.Параметры.КоличествоПорядковыхНомеровЗаписейПрописью = ЧислоПрописью(КоличествоСтрок,,",,,,,,,,0");
	ОбластьПодвал.Параметры.КоличествоСтрок         = КоличествоСтрок;
	ОбластьПодвал.Параметры.ОтпущеноНаСуммуПрописью = обЧислоПрописью(ИтогоСуммаСНДС,ВалютаРегл);
	ОбластьПодвал.Параметры.ВсегоКОплате			 = Формат(ИтогоСуммаСНДС, ФорматВыводаСуммы);
	ОбластьПодвал.Параметры.ВсегоМестПрописью       = ЧислоПрописью(КоличествоСтрок,,",,,,,,,,0");
	ОбластьПодвал.Параметры.ВсегоНаименований       = ЧислоПрописью(КоличествоСтрок,,",,,,,,,,0");
	
	ТабДокумент.Вывести(ОбластьПодвал);
	ТабДокумент.ВывестиГоризонтальныйРазделительСтраниц();

	ОбластьМакета   = Макет.ПолучитьОбласть("ТранспортныйРаздел");
	
	ЛицензионнаяКарточка 		= обПолучитьЗначениеСвойства(ЭтотОбъект, "ЛицензионнаяКарточка");
	СрокДоставки 				= обПолучитьЗначениеСвойства(ЭтотОбъект, "СрокДоставки");
	Перевозчик 					= обПолучитьЗначениеСвойства(ЭтотОбъект, "ОрганизацияПеревозчик");
	МаркаАвтомобиля     	    = обПолучитьЗначениеСвойства(ЭтотОбъект, "МаркаАвтомобиля");
	ГосНомерАвтомобиля	        = обПолучитьЗначениеСвойства(ЭтотОбъект, "ГосНомерАвтомобиля");
	Водитель					= обПолучитьЗначениеСвойства(ЭтотОбъект, "ФИОВодителя");
	ВодительскоеУдостоверение	= обПолучитьЗначениеСвойства(ЭтотОбъект, "ВодительскоеУдостоверение");
	ВидПеревозки	            = обПолучитьЗначениеСвойства(ЭтотОбъект, "ВидПеревозки");
	ПунктПогрузки             	= обПолучитьЗначениеСвойства(ЭтотОбъект, "ПунктПогрузки");
	ПунктРазгрузки            	= обПолучитьЗначениеСвойства(ЭтотОбъект, "ПунктРазгрузки");
	МаркаПрицепа 			  	= обПолучитьЗначениеСвойства(ЭтотОбъект, "Прицеп");
	ГосНомерПрицепа	           	= обПолучитьЗначениеСвойства(ЭтотОбъект, "ГосНомерПрицепа");
	
	Если ТипЗнч(ЛицензионнаяКарточка) = Тип("Булево") Тогда
		ШрифтСтандарт   = Новый Шрифт(ОбластьМакета.Области.Стандарт.Шрифт, , , , , , НЕ ЛицензионнаяКарточка);
		ШрифтОграничено = Новый Шрифт(ОбластьМакета.Области.Стандарт.Шрифт, , , , , , ЛицензионнаяКарточка);
		ОбластьМакета.Области.Стандарт.Шрифт   = ШрифтСтандарт;
		ОбластьМакета.Области.Ограничено.Шрифт = ШрифтОграничено;
	КонецЕсли;

	ОбластьМакета.Параметры.СрокДоставки              = СрокДоставки;
	ОбластьМакета.Параметры.Номер                     = НомерДляПечати;
	ОбластьМакета.Параметры.ОрганизацияПеревозчик     = Перевозчик;
	ОбластьМакета.Параметры.МаркаАвтомобиля           = МаркаАвтомобиля;
	ОбластьМакета.Параметры.ГосНомерАвтомобиля        = ГосНомерАвтомобиля;
	ОбластьМакета.Параметры.ОрганизацияЗаказчик       = Заказчик;
	ОбластьМакета.Параметры.ФИОВодителя               = Водитель;
	ОбластьМакета.Параметры.ВодительскоеУдостоверение = ВодительскоеУдостоверение;
	ОбластьМакета.Параметры.ВидПеревозки              = ВидПеревозки;
	ОбластьМакета.Параметры.ПунктПогрузки             = ПунктПогрузки;
	ОбластьМакета.Параметры.ПунктРазгрузки            = ПунктРазгрузки;
	ОбластьМакета.Параметры.Прицеп                    = МаркаПрицепа;
	ОбластьМакета.Параметры.ГосНомерПрицепа           = ГосНомерПрицепа;
	ТабДокумент.Вывести(ОбластьМакета);

	ОбластьМакета = Макет.ПолучитьОбласть("СведенияОГрузе");
	ТабДокумент.Вывести(ОбластьМакета);
	ОбластьМакета = Макет.ПолучитьОбласть("ПодвалСведенийОГрузе");
	ТабДокумент.Вывести(ОбластьМакета);
	ОбластьМакета = Макет.ПолучитьОбласть("ПогрузочныеОперации");
	ТабДокумент.Вывести(ОбластьМакета);
	ОбластьМакета = Макет.ПолучитьОбласть("ПрочиеСведения");
	ОбластьМакета.Параметры.валюта=ВалютаРегл;
	ТабДокумент.Вывести(ОбластьМакета);

	ТабДокумент.АвтоМасштаб = Истина;
	
	Возврат ТабДокумент;
КонецФункции //ПечатьТ1()

// Формирует печатную форму Приложение №4 "Транспортная накладная"
// 
// Параметры:
//  ТабДокумент - табличный документ.
//
// Возвращаемое значение:
//  ТабДокумент - возвращает сформированный табличный документ.
//
Функция ПечатьПриложение4(ТабДокумент) Экспорт
	ТабДокумент = дкПечатьНовойТТН(ЭтотОбъект,ТабДокумент);
	Возврат ТабДокумент;
КонецФункции // ПечатьПриложение4()

// Формирует печатную форму "Акт приема-передачи ТС"
// 
// Параметры:
//  ТабДокумент - табличный документ.
//
// Возвращаемое значение:
//  ТабДокумент - возвращает сформированный табличный документ.
//
Функция ПечатьАктПриемаПередачиТС( ТабДокумент) Экспорт
	
	//anton
	Если НЕ ЭтотОбъект.Проведен  Тогда
		Сообщить("Документ не проведен. Печать не возможна!");
		Возврат неопределено;
	КонецЕсли;
	//anton
	
	Макет = ПолучитьМакет("АктПриемаПередачиТС");
	
	Паспорт = спПолучитьПодтверждающийДокументОбъектаПоВиду(ЭтотОбъект.Контрагент,Перечисления.ВидыДокументов.Паспорт);
	Сотрудник = обПолучитьЗначениеСвойства(ЭтотОбъект,ПланыВидовХарактеристик.СвойстваОбъектов.Отпустил,Справочники.Сотрудники.ПустаяСсылка());
	Если Сотрудник.Пустая() Тогда
		Руководитель = дкОтветственноеЛицо(ЭтотОбъект,Перечисления.ВидыОбъектовСведений.Руководитель);
		Если ЗначениеЗаполнено(Руководитель) И ТипЗнч(Руководитель)=Тип("Структура") Тогда
			Если ЗначениеЗаполнено(Руководитель.РуководительДолжность) Тогда
				ОрганизацияДолжность = ", в лице " + СокрЛП(нрег(Руководитель.РуководительДолжность));
				ДолжностьПодпись =  СокрЛП(нрег(Руководитель.РуководительДолжность));
			КонецЕсли;
		КонецЕсли;
		ОрганизацияЛицо = " " + СокрЛП(Руководитель.Руководитель);
		ДоверенностьРуководителя = спПолучитьПодтверждающийДокументОбъектаПоВиду(Руководитель.Руководитель,Перечисления.ВидыДокументов.Доверенность);
	Иначе
		ОрганизацияЛицо = " " + СокрЛП(Сотрудник.Наименование);
		Если ЗначениеЗаполнено(Сотрудник.Должность) Тогда
			ОрганизацияДолжность = ", в лице " + СокрЛП(нрег(Сотрудник.Должность));
			ДолжностьПодпись =  СокрЛП(нрег(Сотрудник.Должность));
		КонецЕсли;
		ДоверенностьРуководителя = спПолучитьПодтверждающийДокументОбъектаПоВиду(Сотрудник,Перечисления.ВидыДокументов.Доверенность);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ДоверенностьРуководителя) Тогда
			ОрганизацияДокумент = "Доверенности № " + ДоверенностьРуководителя.Номер + " от "
			+ Формат(ДоверенностьРуководителя.ДатаВыдачи,"ДЛФ=D");
	Иначе
		ОрганизацияДокумент = "Устава";
	КонецЕсли;
	ОрганизацияДокумент = ", действующего  на основании " + ОрганизацияДокумент;
	
	ПаспортныеДанные = "";
	Паспорт = спПолучитьПодтверждающийДокументОбъектаПоВиду(Контрагент,Перечисления.ВидыДокументов.Паспорт);
	Если ЗначениеЗаполнено(Паспорт) Тогда
		ПаспортныеДанные = ", паспорт серии " + Паспорт.Серия + " № "+ Паспорт.Номер + " выдан " + Паспорт.КемВыдан + " " + Формат(Паспорт.ДатаВыдачи,"ДФ='dd MMMM yyyy'") + "г.";
	КонецЕсли;
	
	Для Каждого Строка Из ЭтотОбъект.Автомобили Цикл
		
		ДопОборудованиеАвто = ПолучитьДопОборудование(Строка.ИдентификаторАвтомобиля);
		СуммаДопОборудования = 0;
		
		ОбластьМакетаВерх = Макет.ПолучитьОбласть("ШапкаВверх");
		ОбластьМакетаНиз = Макет.ПолучитьОбласть("ШапкаНиз");
		
		ОбластьМакетаВерх.Параметры.Дата = Формат(?(ЭтотОбъект.ЭтоНовый(),ТекущаяДата(),ЭтотОбъект.Дата),"ДЛФ=DD");
		ОбластьМакетаВерх.Параметры.Организация = ЭтотОбъект.Организация.НаименованиеПолное;
		ОбластьМакетаВерх.Параметры.Город = киПолучитьГород(ЭтотОбъект.ПодразделениеКомпании,Справочники.ВидыКонтактнойИнформации.АдресФактический);
		
		// БВ 16.11.21
		ОбластьМакетаВерх.Параметры.ДоговорНомер = ЭтотОбъект.ДоговорВзаиморасчетов.НомерДоговора;
		ОбластьМакетаВерх.Параметры.ДоговорДатаДень = Формат(ЭтотОбъект.ДоговорВзаиморасчетов.ДатаНачала,"ДФ=дд");
		ОбластьМакетаВерх.Параметры.ДоговорДатаМесяцГод = Сред(Формат(ЭтотОбъект.ДоговорВзаиморасчетов.ДатаНачала,"ДФ=""ддММММ гггг'г.'"""),3);
        // БВ 16.11.21
		
		ОбластьМакетаВерх.Параметры.ОрганизацияДолжность = ОрганизацияДолжность;
		ОбластьМакетаНиз.Параметры.ДолжностьПодпись = ДолжностьПодпись;
		ОбластьМакетаНиз.Параметры.ОрганизацияЛицо = ОрганизацияЛицо;
		ОбластьМакетаВерх.Параметры.ОрганизацияДокумент = ОрганизацияДокумент;
	
		ОбластьМакетаВерх.Параметры.Покупатель = СокрЛП(ЭтотОбъект.Контрагент.НаименованиеПолное);
		ОбластьМакетаВерх.Параметры.ПаспортныеДанные = ПаспортныеДанные;
		
		ОбластьМакетаВерх.Параметры.Модель = "" + спПолучитьНаименование(Строка.Автомобиль.Модель);
		ОбластьМакетаВерх.Параметры.ГодВыпуска = Формат(Строка.Автомобиль.ГодВыпуска,"ДФ=гггг");
		ОбластьМакетаВерх.Параметры.Цвет = Строка.Автомобиль.Цвет;
		ОбластьМакетаВерх.Параметры.VIN = Строка.Автомобиль.VIN;
	
		Если ЗначениеЗаполнено(Строка.Автомобиль.НомерКузова) Тогда
			ОбластьМакетаВерх.Параметры.НомерКузова = Строка.Автомобиль.НомерКузова;
		Иначе
			ОбластьМакетаВерх.Параметры.НомерКузова = "отсутствует";
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Строка.Автомобиль.НомерШасси) Тогда
			ОбластьМакетаВерх.Параметры.НомерШасси = Строка.Автомобиль.НомерШасси;
		Иначе
			ОбластьМакетаВерх.Параметры.НомерШасси = "отсутствует";
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Строка.Автомобиль.НомерКузова) Тогда
			ОбластьМакетаВерх.Параметры.НомерДвигателя = Строка.Автомобиль.НомерДвигателя;
		Иначе
			ОбластьМакетаВерх.Параметры.НомерДвигателя = "отсутствует";
		КонецЕсли;
		
		ПТС =  спПолучитьПодтверждающийДокументОбъектаПоВиду(Строка.Автомобиль ,Перечисления.ВидыДокументов.ПТС);
		Если ЗначениеЗаполнено(ПТС) Тогда
			ОбластьМакетаВерх.Параметры.ПТС = "ПТС " + ПТС.Серия + " № "+ ПТС.Номер + " выдан " + ПТС.КемВыдан + " " + Формат(ПТС.ДатаВыдачи,"ДФ='dd MMMM yyyy'") + "г. ";
		Иначе
			ОбластьМакетаВерх.Параметры.ПТС = "отсутствует";
		КонецЕсли;
		
		ТабДокумент.Вывести(ОбластьМакетаВерх);
		
		// Выведем доп оборудование
		ОбластьДопОборудования = Макет.ПолучитьОбласть("Оборудование");
		КолВоДопОборудования = ДопОборудованиеАвто.Количество();
		Если КолВоДопОборудования = 0 Тогда
			ОбластьДопОборудования.Параметры.ДопОборудование = "отсутствует";
			ТабДокумент.Вывести(ОбластьДопОборудования);
		ИначеЕсли КолВоДопОборудования = 1 Тогда
			Для Каждого СтрокаОборудования Из ДопОборудованиеАвто Цикл
				ОбластьДопОборудования.Параметры.ДопОборудование = НРег(СтрокаОборудования.Номенклатура.Наименование);
				СуммаДопОборудования = СуммаДопОборудования + СтрокаОборудования.СуммаВсего;
				ТабДокумент.Вывести(ОбластьДопОборудования);
			КонецЦикла;
		Иначе
			ОбластьДопОборудования.Параметры.ДопОборудование = НРег(ДопОборудованиеАвто[0].Номенклатура.Наименование)+",";
			СуммаДопОборудования = СуммаДопОборудования + ДопОборудованиеАвто[0].СуммаВсего;
			ТабДокумент.Вывести(ОбластьДопОборудования);
			
			ОбластьДопОборудованияПодч = Макет.ПолучитьОбласть("ОборудованиеДоп");
			Индекс = 1;
			Пока Индекс < КолВоДопОборудования Цикл
				ОбластьДопОборудованияПодч.Параметры.ДопОборудованиеПодч = НРег(ДопОборудованиеАвто[Индекс].Номенклатура.Наименование)+
				?(Индекс = КолВоДопОборудования-1, ".", ",");
				СуммаДопОборудования = СуммаДопОборудования + ДопОборудованиеАвто[Индекс].СуммаВсего;
				ТабДокумент.Вывести(ОбластьДопОборудованияПодч);
				Индекс = Индекс + 1;
			КонецЦикла;

		КонецЕсли;
		
		ОбластьМакетаНиз.Параметры.ЦенаАвтомобиля = Формат(Окр(Строка.СуммаВсего + СуммаДопОборудования),"ЧДЦ=2");
		ОбластьМакетаНиз.Параметры.ЦенаАвтомобиляПрописью = обЧислоПрописью(Строка.СуммаВсего + СуммаДопОборудования,ЭтотОбъект.ВалютаДокумента);
		ОбластьМакетаНиз.Параметры.Валюта = ЭтотОбъект.ВалютаДокумента;
				
		ТабДокумент.Вывести(ОбластьМакетаНиз);
		ТабДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		
	КонецЦикла;
	 
	 Возврат ТабДокумент;
 КонецФункции

// Процедура осуществляет печать документа. Можно направить печать на 
// экран или принтер, а также распечатать необходимое количество копий.
// Параметры: НазваниеМакета - строка, название макета, если пусто - то по умолчанию,
//   Документ - сюда можно передать уже созданный табличный документ для заполнения
Функция Печать(НазваниеПечатнойФормы="", КоличествоЭкземпляров=1, НаПринтер=Ложь, Документ=Неопределено) Экспорт
	// Вызов конкретно печатной формы и печать результата прописано в общем модуле
	// здесь могут быть вставлены дополнительные механизмы
	Возврат дкПечать(ЭтотОбъект, НазваниеПечатнойФормы, КоличествоЭкземпляров, НаПринтер, Документ);
КонецФункции

// Формирует печатную форму "УПД"
// Возвращает сформированный табличный документ:
Функция ПечатьУПД(ТабДокумент) Экспорт
	
	ТабДокумент = дкПечатьУПД(ЭтотОбъект,ТабДокумент);
	Возврат ТабДокумент;	
	
КонецФункции //ПечатьУПД()

#КонецЕсли
// Если Клиент Тогда - завершена клиентская часть

//БИЗТЕХ КОВАЛЬ 25.07.2025 ++
//Создание Взаимозачетов при проведении реализации
Функция ПроверкаСуществованияВзаимозачетов(Основание)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Взаимозачет.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.Взаимозачет КАК Взаимозачет
		|ГДЕ
		|	Взаимозачет.ДокументОснование = &Основание
		|	И Взаимозачет.Проведен";
	
	Запрос.УстановитьПараметр("Основание", Основание);
	
	ЕстьЛиВзаимозачеты = Запрос.Выполнить().Выгрузить().Количество() = 2;
	
	Возврат ЕстьЛиВзаимозачеты;

КонецФункции
Функция ПроверкаСуществованияВзаимозачета(Дебитор,Кредитор, ДоговорВзаиморасчетовДебитор, ДоговорВзаиморасчетовКредитор)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Взаимозачет.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.Взаимозачет КАК Взаимозачет
		|ГДЕ
		|	Взаимозачет.Проведен
		|	И Взаимозачет.Дебитор = &Дебитор
		|	И Взаимозачет.Кредитор = &Кредитор
		|	И Взаимозачет.Состав.ДоговорВзаиморасчетовДебитор = &ДоговорВзаиморасчетовДебитор
		|	И Взаимозачет.Состав.ДоговорВзаиморасчетовКредитор = &ДоговорВзаиморасчетовКредитор";
	
	Запрос.УстановитьПараметр("Дебитор", Дебитор);
	Запрос.УстановитьПараметр("Кредитор", Кредитор);
	Запрос.УстановитьПараметр("ДоговорВзаиморасчетовДебитор", ДоговорВзаиморасчетовДебитор);
	Запрос.УстановитьПараметр("ДоговорВзаиморасчетовКредитор", ДоговорВзаиморасчетовКредитор);

	
	ЕстьЛиВзаимозачет = Запрос.Выполнить().Выгрузить().Количество();
	
	Возврат ЕстьЛиВзаимозачет;

КонецФункции
Функция ПоискСуммыТрейдИн(РеализацияАвтомобиля) Экспорт
	
	ЗапросТрейд = Новый Запрос("ВЫБРАТЬ
	|	ЗначенияСвойствОбъектов.Объект КАК Поступление,
	|	ПоступлениеАвтомобилейАвтомобили.Автомобиль КАК Автомобиль,
	|	СУММА(ЕСТЬNULL(ПоступлениеАвтомобилейАвтомобили.СуммаВсего, 0)) КАК СуммаВсего
	|ИЗ
	|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеАвтомобилей.Автомобили КАК ПоступлениеАвтомобилейАвтомобили
	|		ПО ЗначенияСвойствОбъектов.Объект = ПоступлениеАвтомобилейАвтомобили.Ссылка
	|ГДЕ
	|	ЗначенияСвойствОбъектов.Объект ССЫЛКА Документ.ПоступлениеАвтомобилей
	|	И ЗначенияСвойствОбъектов.Свойство = &Свойство
	|	И ЗначенияСвойствОбъектов.Значение = &Значение
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗначенияСвойствОбъектов.Объект,
	|	ПоступлениеАвтомобилейАвтомобили.Автомобиль");
	ЗапросТрейд.УстановитьПараметр("Свойство",ПланыВидовХарактеристик.СвойстваОбъектов.ЗаказНаАвтомобиль);
	ЗапросТрейд.УстановитьПараметр("Значение",РеализацияАвтомобиля.ДокументОснование);
	РезультатТрейд=ЗапросТрейд.Выполнить().Выгрузить();
	ВрСуммаТрейдИн=0;
	Если РезультатТрейд.Количество() тогда
		ВрСуммаТрейдИн = РезультатТрейд.Итог("СуммаВсего");   
	иначе
		ВрСуммаТрейдИн = 0;
	КонецЕсли;
	
	Возврат ВрСуммаТрейдИн;
	
КонецФункции
Функция ПоискСуммыКредита(РеализацияАвтомобиля, Автомобиль) Экспорт
	
	ЗапросКредит = Новый Запрос( "ВЫБРАТЬ
	|	РабочийЛистКредитногоОтдела.Ссылка КАК Ссылка,
	|	СУММА(РабочийЛистКредитногоОтдела.СуммаКредита) КАК СуммаКредита
	|ИЗ
	|	Документ.РабочийЛистКредитногоОтдела КАК РабочийЛистКредитногоОтдела
	|ГДЕ
	|	РабочийЛистКредитногоОтдела.Автомобиль = &Автомобиль
	|	И РабочийЛистКредитногоОтдела.ДокументОснование = &ДокументОснование
	|	И РабочийЛистКредитногоОтдела.Проведен
	|
	|СГРУППИРОВАТЬ ПО
	|	РабочийЛистКредитногоОтдела.Ссылка");
	
	ЗапросКредит.УстановитьПараметр("ДокументОснование",РеализацияАвтомобиля.ДокументОснование); 
	ЗапросКредит.УстановитьПараметр("Автомобиль",Автомобиль);
	
	РезультатКредит=ЗапросКредит.Выполнить().Выгрузить();  
	ВрСуммаКредит=0;
	Если РезультатКредит.Количество() тогда
		ВрСуммаКредит = РезультатКредит.Итог("СуммаКредита");
	иначе
		ВрСуммаКредит = 0;
	КонецЕсли;
	
	Возврат ВрСуммаКредит;
	
КонецФункции
Функция ПоискОплатБезнал(Контрагент, Договор, Сделка=Неопределено) Экспорт
	
	ЗапросБезнал = Новый Запрос( "ВЫБРАТЬ
	                             |	ВзаиморасчетыКомпании.ХозОперация КАК ХозОперация,
	                             |	ВзаиморасчетыКомпании.Контрагент КАК Контрагент,
	                             |	ВзаиморасчетыКомпании.ДоговорВзаиморасчетов КАК ДоговорВзаиморасчетов,
	                             |	ВзаиморасчетыКомпании.Сумма КАК Сумма
	                             |ИЗ
	                             |	РегистрНакопления.ВзаиморасчетыКомпании КАК ВзаиморасчетыКомпании
	                             |ГДЕ
	                             |	ВзаиморасчетыКомпании.Контрагент = &Контрагент
	                             |	И ВзаиморасчетыКомпании.ДоговорВзаиморасчетов = &ДоговорВзаиморасчетов
	                             |	И ВзаиморасчетыКомпании.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.расход)
	                             |	И ВзаиморасчетыКомпании.ХозОперация = ЗНАЧЕНИЕ(Справочник.ХозОперации.ЧекНаОплату)
	                             |	И ВзаиморасчетыКомпании.Сделка = &Сделка");
	
	ЗапросБезнал.УстановитьПараметр("Контрагент",Контрагент);
	ЗапросБезнал.УстановитьПараметр("ДоговорВзаиморасчетов", Договор);
	
	Если Сделка = Неопределено Тогда
		ЗапросБезнал.Текст = СтрЗаменить(ЗапросБезнал.Текст, "И ВзаиморасчетыКомпании.Сделка = &Сделка","");
	Иначе
		ЗапросБезнал.УстановитьПараметр("Сделка", Сделка);
	КонецЕсли;
	
	РезультатБезнал = ЗапросБезнал.Выполнить().Выгрузить();
	Если РезультатБезнал.Количество() тогда
		Возврат РезультатБезнал.Итог("Сумма");
	иначе
		Возврат 0;
	КонецЕсли;
	
КонецФункции
Функция ПоискОплатНаличные(Контрагент, Договор, Сделка=Неопределено) Экспорт
	
	ЗапросНаличные = Новый Запрос( "ВЫБРАТЬ
	                               |	ВзаиморасчетыКомпании.ХозОперация КАК ХозОперация,
	                               |	ВзаиморасчетыКомпании.Контрагент КАК Контрагент,
	                               |	ВзаиморасчетыКомпании.ДоговорВзаиморасчетов КАК ДоговорВзаиморасчетов,
	                               |	ВзаиморасчетыКомпании.Сумма КАК Сумма
	                               |ИЗ
	                               |	РегистрНакопления.ВзаиморасчетыКомпании КАК ВзаиморасчетыКомпании
	                               |ГДЕ
	                               |	ВзаиморасчетыКомпании.Контрагент = &Контрагент
	                               |	И ВзаиморасчетыКомпании.ДоговорВзаиморасчетов = &ДоговорВзаиморасчетов
	                               |	И ВзаиморасчетыКомпании.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.расход)
	                               |	И ВзаиморасчетыКомпании.ХозОперация = ЗНАЧЕНИЕ(Справочник.ХозОперации.ПриходныйКассовыйОрдер)
	                               |	И ВзаиморасчетыКомпании.Сделка = &Сделка");
	
	ЗапросНаличные.УстановитьПараметр("Контрагент", Контрагент);
	ЗапросНаличные.УстановитьПараметр("ДоговорВзаиморасчетов", Договор);
	
	Если Сделка = Неопределено Тогда
		ЗапросНаличные.Текст = СтрЗаменить(ЗапросНаличные.Текст, "И ВзаиморасчетыКомпании.Сделка = &Сделка","");
	Иначе
		ЗапросНаличные.УстановитьПараметр("Сделка", Сделка);
	КонецЕсли;
	
	РезультатНаличные = ЗапросНаличные.Выполнить().Выгрузить();
	Если РезультатНаличные.Количество() тогда
		Возврат РезультатНаличные.Итог("Сумма");  
	иначе
		Возврат 0;
	КонецЕсли;
	
КонецФункции
Функция ПолучитьКонтрагентаОрганизации(Организация) Экспорт 
	
	Свойство = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Контрагент-организация");
	Если НЕ ЗначениеЗаполнено(Свойство) Тогда
		Сообщить("Отсутствует свойство объектов <Контрагент-организация>!");
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗначенияСвойствОбъектов.Значение КАК Значение
		|ИЗ
		|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|ГДЕ
		|	ЗначенияСвойствОбъектов.Объект = &Организация
		|	И ЗначенияСвойствОбъектов.Свойство = &Свойство";
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Свойство", Свойство);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Возврат ВыборкаДетальныеЗаписи.Значение;
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции
Функция ПолучитьАгентскийДоговорДляТрейдИнОрганизации(Организация) Экспорт 
	
	Свойство = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("КодАгентскийДоговорДляТрейдИн");
	Если НЕ ЗначениеЗаполнено(Свойство) Тогда
		Сообщить("Отсутствует свойство объектов <Контрагент-организация>!");
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗначенияСвойствОбъектов.Значение КАК Значение
		|ИЗ
		|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|ГДЕ
		|	ЗначенияСвойствОбъектов.Объект = &Организация
		|	И ЗначенияСвойствОбъектов.Свойство = &Свойство";
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Свойство", Свойство);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.Значение) Тогда
			Договор = Справочники.ДоговорыВзаиморасчетов.НайтиПоКоду(ВыборкаДетальныеЗаписи.Значение);
			Если ЗначениеЗаполнено(Договор) Тогда
				Возврат Договор;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции
Функция ВЖурналTradeIn(Сообщение)
	ЗаписьЖурналаРегистрации("Создание взаимозачетов Trade In",УровеньЖурналаРегистрации.Информация,"Создание взаимозачетов Trade In",,Сообщение);
КонецФункции
Функция СоздатьВзаимозачетыTradeIn(СсылкаРеализацияАвто) Экспорт
	
	ВЖурналTradeIn("Запуск по реализации " + СсылкаРеализацияАвто);
	
	Если Типзнч(СсылкаРеализацияАвто) = Тип("ДокументСсылка.РеализацияАвтомобилей") И
		ТипЗнч(СсылкаРеализацияАвто.ДокументОснование) = Тип("ДокументСсылка.ЗаказНаАвтомобиль") Тогда
		
		Если ПроверкаСуществованияВзаимозачетов(СсылкаРеализацияАвто.ДокументОснование) = Ложь Тогда
			
			АвтомобильДляРасч = СсылкаРеализацияАвто.Автомобили[0].Автомобиль;
			ТипОплатыКредит =  ПоискСуммыКредита(СсылкаРеализацияАвто, АвтомобильДляРасч);
			ТипОплатыПредоплата = ПоискОплатБезнал(СсылкаРеализацияАвто.Контрагент, СсылкаРеализацияАвто.ДоговорВзаиморасчетов) + ПоискОплатНаличные(СсылкаРеализацияАвто.Контрагент, СсылкаРеализацияАвто.ДоговорВзаиморасчетов);
			СуммаТрейдИнПоПоступлению = ПоискСуммыТрейдИн(СсылкаРеализацияАвто);
			ВЖурналTradeIn("Сумма TradeIn по документу поступление автомобиля = " + Строка(СуммаТрейдИнПоПоступлению));
			Если СуммаТрейдИнПоПоступлению <> 0 Тогда
				ПредварительнаяСуммаТрейдИн = СсылкаРеализацияАвто.СуммаДокумента - (ТипОплатыКредит + ТипОплатыПредоплата);
				ВЖурналTradeIn("Раcчитанная сумма TradeIn = " + Строка(ПредварительнаяСуммаТрейдИн));
				Если ПредварительнаяСуммаТрейдИн <= СуммаТрейдИнПоПоступлению Тогда
					ТипОплатыВстречноеПредоставление = ПредварительнаяСуммаТрейдИн;
				Иначе
					ТипОплатыВстречноеПредоставление = СуммаТрейдИнПоПоступлению;
				КонецЕсли;
				СуммаВзаимозачета = ТипОплатыВстречноеПредоставление;
			Иначе
				ВЖурналTradeIn("Не TradeIn = " + Строка(СсылкаРеализацияАвто));
				Возврат Ложь;
			КонецЕсли;
			
			ЗапросТрейд = Новый Запрос("ВЫБРАТЬ
			|	ЗначенияСвойствОбъектов.Объект КАК Поступление
			|ИЗ
			|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
			|ГДЕ
			|	ЗначенияСвойствОбъектов.Объект ССЫЛКА Документ.ПоступлениеАвтомобилей
			|	И ЗначенияСвойствОбъектов.Свойство = &Свойство
			|	И ЗначенияСвойствОбъектов.Значение = &Значение
			|
			|СГРУППИРОВАТЬ ПО
			|	ЗначенияСвойствОбъектов.Объект");
			ЗапросТрейд.УстановитьПараметр("Свойство",ПланыВидовХарактеристик.СвойстваОбъектов.ЗаказНаАвтомобиль);
			ЗапросТрейд.УстановитьПараметр("Значение",СсылкаРеализацияАвто.ДокументОснование);
			ПоступленияТрейдТабл=ЗапросТрейд.Выполнить().Выгрузить();
			Если ПоступленияТрейдТабл.Количество() Тогда
				
				Для Каждого ПоступлениеТрейд из ПоступленияТрейдТабл Цикл
					
					ПоступлениеСсылка = ПоступлениеТрейд.Поступление;
					
					ВЖурналTradeIn("Поступление автомобилей - " + ПоступлениеСсылка);
					
					ОрганизацияДляПоступления = Справочники.Организации.НайтиПоКоду("ЦБ000024");
					Если ПоступлениеСсылка.Организация <> ОрганизацияДляПоступления Тогда
						ВЖурналTradeIn("Поступление автомобилей не организации " + ОрганизацияДляПоступления);
						Возврат ЛОЖЬ;
					КонецЕсли;
					
					Если НЕ ЗначениеЗаполнено(СуммаВзаимозачета) ИЛИ СуммаВзаимозачета<0 Тогда
						СуммаВзаимозачета = ПоступлениеСсылка.СуммаДокумента;
					КонецЕсли;
					
					Если ТипЗнч(поступлениеСсылка) = Тип("ДокументСсылка.ПоступлениеАвтомобилей") Тогда
						
						ОрганизацияПоступления = ПоступлениеСсылка.Организация;
						ПодразделениеПоступления = ПоступлениеСсылка.ПодразделениеКомпании;
						КонтрагентПоступления = ПолучитьКонтрагентаОрганизации(ОрганизацияПоступления);
						АгентскийДоговорПоступления = ПолучитьАгентскийДоговорДляТрейдИнОрганизации(ОрганизацияПоступления);
						
						ОрганизацияРеализации = СсылкаРеализацияАвто.Организация;
						ПодразделениеРеализации = СсылкаРеализацияАвто.ПодразделениеКомпании;
						КонтрагентРеализации = ПолучитьКонтрагентаОрганизации(ОрганизацияРеализации);
						АгентскийДоговорРеализации = ПолучитьАгентскийДоговорДляТрейдИнОрганизации(ОрганизацияРеализации);
						
						Если НЕ ЗначениеЗаполнено(КонтрагентПоступления) ИЛИ НЕ ЗначениеЗаполнено(КонтрагентРеализации) Тогда
							ВЖурналTradeIn("Не определены контрагенты взаимозачетов");
							Возврат Ложь;
						КонецЕсли;
						
						Контрагент = ПоступлениеСсылка.Контрагент;
						Контрагент2 = СсылкаРеализацияАвто.Контрагент;
						КонтрагентДоговорПоступления = ПоступлениеСсылка.ДоговорВзаиморасчетов;
						КонтрагентДоговорРеализации = СсылкаРеализацияАвто.ДоговорВзаиморасчетов;
						
						Если ПроверкаСуществованияВзаимозачета(КонтрагентРеализации,Контрагент,АгентскийДоговорРеализации,КонтрагентДоговорПоступления) = 0 Тогда
						
							НовыйВзаимозачет1 = Документы.Взаимозачет.СоздатьДокумент();
							НовыйВзаимозачет1.Дата = ТекущаяДатаСеанса();
							НовыйВзаимозачет1.ХозОперация = Справочники.ХозОперации.Взаимозачет;
							НовыйВзаимозачет1.Организация = ОрганизацияПоступления;
							НовыйВзаимозачет1.ПодразделениеКомпании = ПодразделениеПоступления;
							НовыйВзаимозачет1.Автор = ПараметрыСеанса.Пользователь;
							НовыйВзаимозачет1.ДокументОснование = СсылкаРеализацияАвто.ДокументОснование;
							НовыйВзаимозачет1.Дебитор = КонтрагентРеализации;
							НовыйВзаимозачет1.Кредитор = Контрагент;
							НовыйВзаимозачет1.ВалютаДокумента = СсылкаРеализацияАвто.ВалютаДокумента;
							НовыйВзаимозачет1.КурсДокумента = 1;
							НоваяСтрокаВзаимозачет1 = НовыйВзаимозачет1.Состав.Добавить();
							НоваяСтрокаВзаимозачет1.ДоговорВзаиморасчетовДебитор = АгентскийДоговорРеализации;
							НоваяСтрокаВзаимозачет1.ДоговорВзаиморасчетовКредитор = КонтрагентДоговорПоступления;
							НоваяСтрокаВзаимозачет1.СделкаКредитор = ПоступлениеСсылка;
							НоваяСтрокаВзаимозачет1.Сумма = СуммаВзаимозачета;
							НовыйВзаимозачет1.Комментарий = "Создан автоматически после проведения оплаты по документу " + СсылкаРеализацияАвто;
						Иначе
							НовыйВзаимозачет1 = ЛОЖЬ;
						КонецЕсли;
						
						Если ПроверкаСуществованияВзаимозачета(Контрагент2,КонтрагентПоступления,КонтрагентДоговорРеализации,АгентскийДоговорПоступления) = 0 Тогда
							
							НовыйВзаимозачет2 = Документы.Взаимозачет.СоздатьДокумент();
							НовыйВзаимозачет2.Дата = ТекущаяДатаСеанса();
							НовыйВзаимозачет2.ХозОперация = Справочники.ХозОперации.Взаимозачет;
							НовыйВзаимозачет2.Организация = ОрганизацияРеализации;
							НовыйВзаимозачет2.ПодразделениеКомпании = ПодразделениеРеализации;
							НовыйВзаимозачет2.Автор = ПараметрыСеанса.Пользователь;
							НовыйВзаимозачет2.ДокументОснование = СсылкаРеализацияАвто.ДокументОснование;
							НовыйВзаимозачет2.Дебитор = Контрагент2;
							НовыйВзаимозачет2.Кредитор = КонтрагентПоступления;
							НовыйВзаимозачет2.ВалютаДокумента = СсылкаРеализацияАвто.ВалютаДокумента;
							НовыйВзаимозачет2.КурсДокумента = 1;
							НоваяСтрокаВзаимозачет2 = НовыйВзаимозачет2.Состав.Добавить();
							НоваяСтрокаВзаимозачет2.ДоговорВзаиморасчетовДебитор = КонтрагентДоговорРеализации;
							НоваяСтрокаВзаимозачет2.ДоговорВзаиморасчетовКредитор = АгентскийДоговорПоступления;
							НоваяСтрокаВзаимозачет2.СделкаДебитор = СсылкаРеализацияАвто;
							НоваяСтрокаВзаимозачет2.Сумма = СуммаВзаимозачета;
							НовыйВзаимозачет2.Комментарий = "Создан автоматически после проведения оплаты по документу " + СсылкаРеализацияАвто;
						Иначе
							НовыйВзаимозачет2 = Ложь;
						КонецЕсли;
						
						Если НовыйВзаимозачет1 <> Ложь И НовыйВзаимозачет2 <> Ложь Тогда
							
							НачатьТранзакцию();
														
							Попытка
								НовыйВзаимозачет1.Записать(РежимЗаписиДокумента.Проведение,РежимПроведенияДокумента.Оперативный);
								НовыйВзаимозачет2.Записать(РежимЗаписиДокумента.Проведение,РежимПроведенияДокумента.Оперативный);
								
								Сообщить("Созданы и проведены взаимозачеты по Trade In на основании <"+СсылкаРеализацияАвто.ДокументОснование+">!");
								Сообщить("Взаимозачет №1 - <"+НовыйВзаимозачет1.Ссылка+">");
								Сообщить("Взаимозачет №2 - <"+НовыйВзаимозачет2.Ссылка+">");
								
								ВЖурналTradeIn("Созданы и проведены взаимозачеты по Trade In на основании <"+СсылкаРеализацияАвто.ДокументОснование+">!");
								ВЖурналTradeIn("Взаимозачет №1 - <"+НовыйВзаимозачет1.Ссылка+">");
								ВЖурналTradeIn("Взаимозачет №2 - <"+НовыйВзаимозачет2.Ссылка+">");
								
								ЗафиксироватьТранзакцию();
							Исключение
								
								ТекстОшибки = ОписаниеОшибки();
								Сообщить("Произошла ошибка при создании взаимозачетов по Trade In: " + ТекстОшибки);
								Сообщить("Транзакция отменена!");
								ВЖурналTradeIn("Ошибка транзакции - " + ТекстОшибки);
								
								ОтменитьТранзакцию();
							КонецПопытки;
						КонецЕсли;
						Возврат Истина;
					Иначе
						ВЖурналTradeIn("Не соблюдается тип документа");
					КонецЕсли;
				КонецЦикла;
			Иначе
				ВЖурналTradeIn("Не найден Trade In");
				Возврат Ложь;
			КонецЕсли;
		Иначе
			ВЖурналTradeIn("Взаимозачеты уже существуют");
		КОнецЕсли;	 
	Иначе
		ВЖурналTradeIn("Условия не соблюдены - 1");
		Возврат Ложь;
	КонецЕсли;
КонецФункции

//БИЗТЕХ КОВАЛЬ 25.07.2025 --

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ПриУстановкеНовогоНомера(СтандартнаяОбработка, Префикс)
	Если НЕ дкПриУстановкеНовогоНомера(ЭтотОбъект, СтандартнаяОбработка, Префикс) Тогда Возврат; КонецЕсли;
КонецПроцедуры

// Процедура обработчик ввода на основании
Процедура ОбработкаЗаполнения(Основание) Экспорт

	Если НЕ дкОбработкаЗаполнения(ЭтотОбъект, Основание) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ обЗначениеНеЗаполнено(Основание) Тогда
		Если ТипЗнч(Основание)=Тип("ДокументСсылка.ПоступлениеАвтомобилей") Тогда
			
			Контрагент = Справочники.Контрагенты.ПустаяСсылка();
			ДоговорВзаиморасчетов = Справочники.ДоговорыВзаиморасчетов.ПустаяСсылка();
			ОбработкаРеквизита("ДоговорВзаиморасчетов");
			
			Автомобили.Очистить();
			Запрос = Новый Запрос();
			Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ПоступлениеАвтомобилейАвтомобили.Автомобиль КАК Автомобиль
			|ИЗ
			|	Документ.ПоступлениеАвтомобилей.Автомобили КАК ПоступлениеАвтомобилейАвтомобили
			|ГДЕ
			|	ПоступлениеАвтомобилейАвтомобили.Ссылка = &Ссылка";
			Запрос.УстановитьПараметр("Ссылка", Основание);
			Выборка = Запрос.Выполнить().Выбрать();
			Пока Выборка.Следующий() Цикл
				НоваяСтрока = Автомобили.Добавить();
				НоваяСтрока.ИдентификаторАвтомобиля=Новый УникальныйИдентификатор;
				НоваяСтрока.Автомобиль = Выборка.Автомобиль;
				ОбработкаРеквизита("Автомобили.Автомобиль", НоваяСтрока);
			КонецЦикла;
		ИначеЕсли ТипЗнч(Основание)=Тип("ДокументСсылка.ПеремещениеАвтомобилей") Тогда
			СкладКомпании=Основание.СкладПолучатель;
		ИначеЕсли ТипЗнч(Основание)=Тип("ДокументСсылка.СчетНаОплатуЗаАвтомобили") Тогда
			Заказчик=Основание.Контрагент;
		ИначеЕсли ТипЗнч(Основание)=Тип("ДокументСсылка.ВводОстатковАвтомобилей") Тогда
			Контрагент = Справочники.Контрагенты.ПустаяСсылка();
			ДоговорВзаиморасчетов = Справочники.ДоговорыВзаиморасчетов.ПустаяСсылка();
		КонецЕсли;
	КонецЕсли;
	
	Товары.Очистить();
	Для Каждого СтрокаАвтомобиля Из Автомобили Цикл
		Если обЗначениеНеЗаполнено(СтрокаАвтомобиля.ИдентификаторАвтомобиля) Тогда
			СтрокаАвтомобиля.ИдентификаторАвтомобиля = Новый УникальныйИдентификатор;
		КонецЕсли;
		//ОбработкаРеквизита("РассчитатьСкидкиАвтомобили", СтрокаАвтомобиля);
		ДобавитьОборудованиеАвтомобиля(СтрокаАвтомобиля.Автомобиль, Истина);
	КонецЦикла;
	
	// перенесем строчные скидки из заказа
	Если НЕ обЗначениеНеЗаполнено(Основание) И ТипЗнч(Основание) = Тип("ДокументСсылка.ЗаказНаАвтомобиль")Тогда
		ТЗЗаказа = Основание.Товары.Выгрузить();
		
		Для Каждого стрТоваров Из Товары Цикл
			Отбор = Новый Структура("Номенклатура,ХарактеристикаНоменклатуры",стрТоваров.Номенклатура,стрТоваров.ХарактеристикаНоменклатуры);
			МассивНайденных = ТЗЗаказа.НайтиСтроки(Отбор);
			Если МассивНайденных.Количество() = 0 Тогда
				ПроцентСкидкиШапки  = 0;
				ПроцентСкидкиСтроки = 0;
				СкидкаСтроки        = Справочники.ТипыСкидок.ПустаяСсылка();
				СуммаВсего = стрТоваров.СуммаВсего;
			ИначеЕсли МассивНайденных.Количество() > 1 Тогда
				СкидкаСтроки = Справочники.ТипыСкидок.ПустаяСсылка();
				СуммаСкидкиСтрокиВсего = 0;
				СуммаСкидкиШапкиВсего = 0;
				СуммаВсего = 0;
				Для Каждого стрМассива Из МассивНайденных Цикл
					Если обЗначениеНеЗаполнено(СкидкаСтроки) И НЕ обЗначениеНеЗаполнено(стрМассива.СкидкаНаТовар) Тогда
						СкидкаСтроки = стрМассива.СкидкаНаТовар;
					КонецЕсли;
					
					СуммаВсего             = СуммаВсего + стрМассива.СуммаВсего;
					СуммаСкидкиШапкиВсего  = СуммаСкидкиШапкиВсего + стрМассива.СуммаСкидки;
					СуммаСкидкиСтрокиВсего = СуммаСкидкиСтрокиВсего + стрМассива.СуммаСкидкиСтроки;
				КонецЦикла;
				
				СуммаСоСкидкой = СуммаВсего + СуммаСкидкиШапкиВсего + СуммаСкидкиСтрокиВсего;
				
				Если СуммаСоСкидкой = 0 Тогда
					ПроцентСкидкиШапки  = 0;
					ПроцентСкидкиСтроки = 0;
				Иначе
					ПроцентСкидкиШапки  = (СуммаСкидкиШапкиВсего*100)/СуммаСоСкидкой;
					ПроцентСкидкиСтроки = (СуммаСкидкиСтрокиВсего*100)/СуммаСоСкидкой;
				КонецЕсли;
			Иначе
				стрМассива = МассивНайденных[0];
				ПроцентСкидкиШапки  = стрМассива.ПроцентСкидки;
				ПроцентСкидкиСтроки = стрМассива.ПроцентСкидкиСтроки;
				СкидкаСтроки        = стрМассива.СкидкаНаТовар;
				СуммаВсего          = стрМассива.СуммаВсего;
			КонецЕсли;
			
			стрТоваров.СуммаВсего          = СуммаВсего;
			ОбработкаРеквизита("Товары.СуммаВсего",стрТоваров);
			стрТоваров.ПроцентСкидки       = ПроцентСкидкиШапки;
			стрТоваров.ПроцентСкидкиСтроки = ПроцентСкидкиСтроки;
			стрТоваров.СкидкаНаТовар       = СкидкаСтроки;
			ОбработкаРеквизита("Товары.ПроцентСкидки",стрТоваров);
			ОбработкаРеквизита("Товары.ПроцентСкидкиСтроки",стрТоваров);
		КонецЦикла;
	КонецЕсли;
	СуммаДокумента=РассчитатьСуммуВсего();
	
	ТекущаяВалютаДокумента=ВалютаДокумента;
	ТекущийКурсДокумента=КурсДокумента;
	
	ИдентификаторГосударственногоКонтракта = ?(ЗначениеЗаполнено(ИдентификаторГосударственногоКонтракта),
		ИдентификаторГосударственногоКонтракта,
		ДоговорВзаиморасчетов.ИдентификаторГосударственногоКонтракта);
	//<<ЧалапАю БизТех 12.01.2024		
	Если ЭтоНовый() тогда
		БТ_ПодразелениеМенеджераКМ = Менеджер.Подразделение; 
	КонецЕсли; 
	//ЧалапАю БизТех 12.01.2024>>
КонецПроцедуры

Процедура ПриКопировании(ОбъектКопирования)
	Если НЕ дкПриКопировании(ЭтотОбъект, ОбъектКопирования) Тогда Возврат; КонецЕсли;
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	ДополнительныеСвойства.Вставить("ДоговорВзаиморасчетовБыл");
	ДополнительныеСвойства.Вставить("АвтомобильСкладКомпанииБыл");
	ДополнительныеСвойства.Вставить("АвтомобильЗаказБыл");
	ДополнительныеСвойства.Вставить("АвтомобильБыл");
	ДополнительныеСвойства.Вставить("МоментВремениБыл");
	//Обновим оборудование автомобилей
	Для каждого СтрокаАвтомобилей Из Автомобили Цикл
		ДобавитьОборудованиеАвтомобиля(СтрокаАвтомобилей.Автомобиль,Ложь);
	КонецЦикла; 
	
	Если НЕ дкПередЗаписью(ЭтотОбъект, Отказ, РежимЗаписи, РежимПроведения) Тогда Возврат; КонецЕсли;
	
	Если РежимЗаписи=РежимЗаписиДокумента.Проведение Тогда
		//Проверим расстановку флажков, для поступления автомобилей без заказа
		Для каждого СтрокаАвтомобиля Из Автомобили Цикл
			Если обЗначениеНеЗаполнено(СтрокаАвтомобиля.ЗаказНаАвтомобиль) И СтрокаАвтомобиля.АвтомобильБезЗаказа=Ложь Тогда
				Сообщить("Автомобиль <"+СокрЛП(СтрокаАвтомобиля.Автомобиль)+"> отгружается без заказа. Установите признак отгрузки автомобиля без заказа.");
				Отказ=Истина;
			КонецЕсли; 
		КонецЦикла;
	КонецЕсли; 
	
	// получим старые значения, влияющие на границы последовательности
	Если НЕ Отказ И Проведен И РежимЗаписи=РежимЗаписиДокумента.Проведение Тогда
		
		БылиДвижения = Ложь;
		Запрос = Новый Запрос();
		Запрос.УстановитьПараметр("Ссылка",Ссылка);
		
		// взаиморасчеты
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ ДоговорВзаиморасчетов ИЗ РегистрНакопления.ВзаиморасчетыКомпании ГДЕ Регистратор=&Ссылка";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			БылиДвижения = Истина;
			ДополнительныеСвойства.Вставить("ДоговорВзаиморасчетовБыл", Результат.Выгрузить().ВыгрузитьКолонку("ДоговорВзаиморасчетов"));
		КонецЕсли;
		
		// заказы на автомобили
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЗаказыАвтомобилей.Автомобиль КАК Автомобиль
		|ИЗ
		|	РегистрНакопления.ЗаказыАвтомобилей КАК ЗаказыАвтомобилей
		|ГДЕ
		|	ЗаказыАвтомобилей.Регистратор = &Ссылка
		|";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			БылиДвижения = Истина;
			ДополнительныеСвойства.Вставить("АвтомобильЗаказБыл", Результат.Выгрузить().ВыгрузитьКолонку("Автомобиль"));
		КонецЕсли;
		
		// автомобили
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ СкладКомпании ИЗ РегистрНакопления.ОстаткиАвтомобилей ГДЕ Регистратор=&Ссылка";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			БылиДвижения = Истина;
			ДополнительныеСвойства.Вставить("АвтомобильСкладКомпанииБыл", Результат.Выгрузить().ВыгрузитьКолонку("СкладКомпании"));
		КонецЕсли;
		
		// комплектация
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ Автомобиль ИЗ РегистрНакопления.КомплектацияАвтомобилей ГДЕ Регистратор=&Ссылка";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			БылиДвижения = Истина;
			ДополнительныеСвойства.Вставить("АвтомобильБыл", Результат.Выгрузить().ВыгрузитьКолонку("Автомобиль"));
		КонецЕсли;
		
		// прошлый момент времени
		Если БылиДвижения Тогда
			Запрос.Текст = "ВЫБРАТЬ МоментВремени ИЗ Документ."+Метаданные().Имя+" ГДЕ Ссылка=&Ссылка";
			ДополнительныеСвойства.Вставить("МоментВремениБыл",Запрос.Выполнить().Выгрузить().Получить(0).МоментВремени);
		КонецЕсли;
		
	КонецЕсли;
	
	//<<ЧалапАю бизТех 25.03.2025  000802
	Если не отказ тогда
		ЭМ_ПодписалОплату = обПолучитьЗначениеСвойства(ЭтотОбъект, ПланыВидовХарактеристик.СвойстваОбъектов.ЭМ_ПодписалОплату,Справочники.Пользователи.ПустаяСсылка());  
		ЭМ_КнопкаНажата = обПолучитьЗначениеСвойства(ЭтотОбъект, ПланыВидовХарактеристик.СвойстваОбъектов.ЭМ_КнопкаНажата, ложь);        
		
		//не ЗначениеЗаполнено(ЭМ_ПодписалОплату)  - значит подписи оплаты не было
		Если ЗначениеЗаполнено(ЭМ_ПодписалОплату) и ЭМ_КнопкаНажата тогда //или не ЗначениеЗаполнено(ЭМ_ПодписалОплату) Тогда
			ОплатаПодписана = Истина;
		Иначе
			ОплатаПодписана = Ложь;
		КонецЕсли; 
		
		//Если не ОплатаПодписана  тогда 
		Если не ЭтотОбъект.Проведен тогда  //не будем пересчитывать - для восстановления последовательности
			Если ЭтотОбъект.Автомобили.Количество() Тогда //БИЗТЕХ КОВАЛЬ 11.04.2025 Добавил проверку ++
				ПолнаяСтоимость = БТ_ПроцедурыДокументовСервер.НайтиПолнуюСтоимостьАвто(ЭтотОбъект.ДоговорВзаиморасчетов, ЭтотОбъект.Автомобили[0].Автомобиль,ЭтотОбъект);	 //ЧалапАю БизТех 21.03.2025 - ПолнаяСтоимостьАвто    000000802
				БТ_СуммаКредита =  ПолнаяСтоимость.СуммаКСО;
				БТ_СуммаТрейд = ПолнаяСтоимость.СуммаТрейд;
				БТ_СуммаНаличные = ПолнаяСтоимость.СуммаНаличные;
				БТ_СуммаБезнал = ПолнаяСтоимость.СуммаБезнал;
			Иначе
				Сообщить("Не указан автомобиль в табличной части!");
				Отказ = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
    //ЧалапАю бизТех 25.03.2025  000802  >>

КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	Если НЕ дкПриЗаписи(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
КонецПроцедуры

Процедура ПередУдалением(Отказ)
	Если НЕ дкПередУдалением(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ)
	Если НЕ дкОбработкаУдаленияПроведения(ЭтотОбъект, Отказ) Тогда Возврат; КонецЕсли;
	
	////Удалим накопление сумм
	//НаборЗаписейНакоплениеСумм=РегистрыСведений.НакоплениеСумм.СоздатьНаборЗаписей();
	//НаборЗаписейНакоплениеСумм.ДокументОбъект=ЭтотОбъект;
	//НаборЗаписейНакоплениеСумм.ОтменаПроведения();
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, Режим)
	Если НЕ дкОбработкаПроведения(ЭтотОбъект, Отказ, Режим) Тогда Возврат; КонецЕсли;
	
	#Если Клиент Тогда
	//БизТех Коваль А.Д. 03.07.2024 ++
	//Отказ записи если у контрагента присутствует флаг "телефон неактуален"
	Если Контрагент.ТелефонКонтрНеАктуален Тогда
		Предупреждение("Телефон данного контрагента не актуален. Обновите телефон контрагента перед закрытием документа.");
		Отказ = Истина;
		Возврат;
	КонецЕсли;	
	//БизТех Коваль А.Д. 03.07.2024 --
	#КонецЕсли
	
	//БизТех Мамонов 17.07.2025 ++
	//Добавлен запрет проведения реализации с залогового склада
	Если СкладКомпании = Справочники.СкладыКомпании.НайтиПоКоду("ЦБ000620") Тогда // склад "Залоговые автомобили СЕЛЕКТ (Экспобанк)"
		Сообщить("Проведение документа со склада <" + СкладКомпании + ">" + " запрещено! Данный склад предназначен для залоговых автомобилей.");
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	//БизТех Мамонов 17.07.2025 --
	
	//bizteh++
	//23.06.2022г. Склад в реализации обязательно должен быть выкупленный
	Если Не СкладКомпании.БТ_ВидСкладаАвто = Перечисления.БТ_ВидыСкладовАвто.Выкуп и НЕ РольДоступна("ВосстПослед") Тогда  
		Сообщить ("Реализация должна проводиться только со склада выкупленных авто! Документ не проведен. Исправьте склад."); 
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	//bizteh--
	
	ГрупповаяОбработкаДокументов = Ложь;
	Если НЕ ЭтотОбъект.ДополнительныеСвойства.Свойство("ГрупповаяОбработкаДокументов",ГрупповаяОбработкаДокументов) Тогда
		ГрупповаяОбработкаДокументов = Ложь;
	КонецЕсли;
	
	// Проверка закрытия заказ-нарядов с видами ремонта из списка значения.
	ВидыРемонтаДляПроверки = Новый СписокЗначений;
	ВидыРемонтаДляПроверки.Добавить(Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000010")); // Гарантийный заказ
	Отказ = ПроверкаОткрытыхЗНАвтомобиля(ВидыРемонтаДляПроверки);
	

	//<<ЧалапАю БизТех 22.05.2025 000000883
	Если не ГрупповаяОбработкаДокументов и ЭтотОбъект.Дата>= Дата(2025,05,29) 
		и режим = режимпроведениядокумента.Оперативный тогда  
		Если БТ_ПроцедурыДокументовСервер.КонтрагентаНетВИсключенияхКумКаржи(Организация,Контрагент)  тогда    //исключим контрагентов группы холдинга  
			
			//получим список подразделений по кому надо планироватьТО0
			Запрос = Новый Запрос( "ВЫБРАТЬ
			|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение КАК ПодразделениеОПА,
			|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение1 КАК ПодразделениеСервис,
			|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение2 КАК Цех,
			|	БТ_СписокКонстантныхЗначенийТаблицаДанных.Значение3 КАК МастерВЗаявку
			|ИЗ
			|	Справочник.БТ_СписокКонстантныхЗначений.ТаблицаДанных КАК БТ_СписокКонстантныхЗначенийТаблицаДанных
			|ГДЕ
			|	НЕ БТ_СписокКонстантныхЗначенийТаблицаДанных.Ссылка.ПометкаУдаления
			|	И БТ_СписокКонстантныхЗначенийТаблицаДанных.Ссылка.Наименование = &Наименование");
			Запрос.УстановитьПараметр("Наименование", "ПланированиеТО0ПриПродажеАвто");
			РезультатЗапроса = Запрос.Выполнить().Выгрузить();  
			
			Если не РезультатЗапроса.Найти(ПодразделениеКомпании, "ПодразделениеОПА") = Неопределено тогда
				
				Если не ЗначениеЗаполнено(РезультатЗапроса.Найти(ПодразделениеКомпании, "ПодразделениеОПА").ПодразделениеСервис) тогда   //проверим есть ли подразделение сервиса
					Сообщить("В настройках Планирования ТО-0 не указано подразделение сервиса, создание плана ремонта невозможно."); 
					Отказ = Истина; 
				КонецЕсли;  
				
				Если не ЗначениеЗаполнено(РезультатЗапроса.Найти(ПодразделениеКомпании, "ПодразделениеОПА").Цех) тогда
					Сообщить("В настройках Планирования ТО-0 не указан Цех, создание плана ремонта невозможно."); 
					Отказ = Истина; 
				КонецЕсли;  
				
				Если не ЗначениеЗаполнено(РезультатЗапроса.Найти(ПодразделениеКомпании, "ПодразделениеОПА").МастерВЗаявку) тогда
					Сообщить("В настройках Планирования ТО-0 не указан мастер для планирования ТО-0, создание плана ремонта невозможно."); 
					Отказ = Истина; 
				КонецЕсли;
				
				//проверим есть ли уже ЗНР на ТО-0
				ЕстьЗаявка = ложь;
				ЗапросЗНР0 = Новый Запрос("ВЫБРАТЬ
				|	ЗаявкаНаРемонт.Ссылка КАК Ссылка
				|ИЗ
				|	Документ.ЗаявкаНаРемонт КАК ЗаявкаНаРемонт
				|ГДЕ
				|	НЕ ЗаявкаНаРемонт.ПометкаУдаления
				|	И ЗаявкаНаРемонт.Автомобиль в (&Автомобиль)
				|	И ЗаявкаНаРемонт.БТ_НомерТО = ЗНАЧЕНИЕ(Справочник.БТ_НомерТО.ТО0)");
				ЗапросЗНР0.УстановитьПараметр("Автомобиль", Автомобили.ВыгрузитьКолонку("Автомобиль"));
				РезультатЗНР0 = запросЗНР0.Выполнить().Выгрузить();
				
				ЕстьЗаявка = ?(РезультатЗНР0.Количество()= 0, Ложь, истина);
				КлиентИногородний = обПолучитьЗначениеСвойства(ЭтотОбъект, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("БТ_КлиентИногороднийТО0"),Ложь);  
			КонецЕсли;	
			
			Если не РезультатЗапроса.Найти(ПодразделениеКомпании, "ПодразделениеОПА") = Неопределено и не КлиентИногородний и не ЕстьЗаявка и не Отказ тогда   //    и ПодразделениеСервисНайдено 
				ФормаПоиска = ПолучитьФорму("ПредварительнаяЗаписьТО0");
				Результат = ФормаПоиска.ОткрытьМодально();
				Если Результат = Неопределено или не Результат.Количество() Тогда
					Отказ = Истина; 
					Сообщить("Необходимо запланировать ТО-0. Проведение реализации автомобиля невозможно.");
					Возврат;	
				Иначе
					//сначала создаем заявку на ремонт   
					Если не ЕстьЗаявка и не Результат[2].Значение тогда      //поставили флаг ИногороднийКлиент
						Для каждого СтрокаАвтомобили из Автомобили цикл
							НоваяЗНР = Документы.ЗаявкаНаРемонт.СоздатьДокумент();
							НоваяЗНР.Организация = РезультатЗапроса.Найти(ПодразделениеКомпании, "ПодразделениеОПА").ПодразделениеСервис.Организация;
							НоваяЗНР.Дата = ТекущаяДата();
							НоваяЗНР.УстановитьНовыйНомер();
							НоваяЗНР.Заказчик = Контрагент;  
							НоваяЗНР.Контрагент = Контрагент;    
							НоваяЗНР.ТипЦен = Справочники.ТипыЦен.ОсновнойТипЦенПродажи; 
							НоваяЗНР.ТипЦенРабот = Справочники.ТипыЦен.ОсновнойТипЦенПродажи;
							НоваяЗНР.КурсДокумента = 1;
							НоваяЗНР.КурсВалютыУпр = 1;
							НоваяЗНР.ВалютаДокумента = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();    
							НоваяЗНР.БТ_НомерТО = Справочники.БТ_НомерТО.ТО0; 
							НоваяЗНР.Автор = ПараметрыСеанса.Пользователь;
							НоваяЗНР.ХозОперация = Справочники.ХозОперации.ПланРемонта;   
							НоваяЗНР.ДокументОснование = ЭтотОбъект.Ссылка;
							НоваяЗНР.Автомобиль = СтрокаАвтомобили.Автомобиль;
							НоваяЗНР.Цех = РезультатЗапроса.Найти(ПодразделениеКомпании, "ПодразделениеОПА").Цех;   //Цеха ФКДД Чери
							НоваяЗНР.Диспетчер = Автор.Сотрудник;
							НоваяЗНР.ВидРемонта = Справочники.ВидыРемонта.НайтиПоКоду("ЦБ000037");     //Техническое обслуживание (ТО)
							НоваяЗНР.ПодразделениеКомпании = РезультатЗапроса.Найти(ПодразделениеКомпании, "ПодразделениеОПА").ПодразделениеСервис;   
							ВремяОкончания =  Результат[1].Значение + 60*60;
							НоваяЗНР.ДатаНачала = НачалоДня(Результат[0].Значение) + Час(Результат[1].Значение) *60*60 + Минута(Результат[1].Значение)*60+Секунда(Результат[1].Значение); 
							НоваяЗНР.ДатаОкончания = НачалоДня(Результат[0].Значение) + Час(ВремяОкончания) *60*60 + Минута(ВремяОкончания)*60+Секунда(ВремяОкончания);   
							СтрокаПланирования = НоваяЗНР.Планирование.Добавить();
							СтрокаПланирования.Авторабота = Справочники.Автоработы.НайтиПоКоду("ЦБ00011500");//Техническое обслуживание	
							СтрокаПланирования.РабочееМесто = РезультатЗапроса.Найти(ПодразделениеКомпании, "ПодразделениеОПА").Цех;    //Цеха ФКДД Чери
							СтрокаПланирования.Исполнитель = РезультатЗапроса.Найти(ПодразделениеКомпании, "ПодразделениеОПА").МастерВЗаявку;  
							СтрокаПланирования.НачалоВыполнения = НачалоДня(Результат[0].Значение) + Час(Результат[1].Значение) *60*60 + Минута(Результат[1].Значение)*60+Секунда(Результат[1].Значение);   
							СтрокаПланирования.ОкончаниеВыполнения = НачалоДня(Результат[0].Значение) + Час(ВремяОкончания) *60*60 + Минута(ВремяОкончания)*60+Секунда(ВремяОкончания);  
							НоваяЗНР.ОбработкаРеквизита("Планирование.НачалоВыполнения",СтрокаПланирования);                                                          
							СтрокаПланирования.Продолжительность = 1;      
							НоваяЗНР.Комментарий = "Создан автоматически на основании " + ЭтотОбъект.Ссылка;         
							НоваяЗНР.Записать();                    
							ФормаЗНР = НоваяЗНР.Ссылка.ПолучитьФорму("ФормаДокумента");
							ФормаЗНР.ДействияФормыДатаЗаказНаряда(Неопределено);   
							НоваяЗНР.Записать(РежимЗаписиДокумента.Проведение);
							Сообщить("Запланировано ТО-0: " + НоваяЗНР.Ссылка);
						КонецЦикла;    
					иначе
						//ЭтотОбъект.БТ_ИногороднийКлиент = Истина; 
						МенеджерЗаписи = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьМенеджерЗаписи();
						МенеджерЗаписи.Объект = ЭтотОбъект.Ссылка;
						МенеджерЗаписи.Свойство = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("БТ_КлиентИногороднийТО0");
						МенеджерЗаписи.Значение = Истина;
						МенеджерЗаписи.Записать();     
					КонецЕсли;
				КонецЕсли; 
			Иначе
				//Отказ = Ложь; //БизТех Аляль 20.06.2025г. !!!
			КонецЕсли;    
		КонецЕсли;
	КонецЕсли; 
	//ЧалапАю БизТех 22.05.2025 000000883>>
	
	Если Не ГрупповаяОбработкаДокументов Тогда
		ПроверкаЗаписиСФормы = ДополнительныеСвойства.Свойство("ЭтоФормаДокумента");
		
		Если (ПроверкаЗаписиСФормы = Неопределено ИЛИ ПроверкаЗаписиСФормы = Ложь) Тогда
			
			ЗначениеПрава = обПраво("КонтрольОткрытыхЗаказНарядов", Права);
			
			Если ЗначениеПрава <> Перечисления.ВидыКонтроля.НеКонтролировать Тогда
				
				Отказ = ПроверкаОткрытыхДокуменовАвтомобиля();
				
			КонецЕсли;
			
		КонецЕсли;
		
		//bizteh++ saa 07.02.2022   
		//Если СкладКомпании.тт_КатегорияСклада.Наименование = "Трейд-ин" Тогда
		//	РазрешилВыдачу = "";
		//	Запрос = Новый Запрос;
		//	Запрос.Текст = 
		//	"ВЫБРАТЬ
		//	|	ЗначенияСвойствОбъектов.Значение КАК Значение
		//	|ИЗ
		//	|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		//	|ГДЕ
		//	|	ЗначенияСвойствОбъектов.Объект = &Объект
		//	|	И ЗначенияСвойствОбъектов.Свойство = &Свойство";
		//	Запрос.УстановитьПараметр("Объект", Ссылка);
		//	Запрос.УстановитьПараметр("Свойство", ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Разрешил выдачу трейдин"));
		//	РезультатЗапроса = Запрос.Выполнить();
		//	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		//	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		//		РазрешилВыдачу = ВыборкаДетальныеЗаписи.Значение;
		//	КонецЦикла; 
		//	Если НЕ ЗначениеЗаполнено(РазрешилВыдачу) Тогда
		//		Сообщить("Выдача автомобиля не разрешена. Документ не будет проведен.");
		//		Отказ = Истина;
		//	КонецЕсли;
		//КонецЕсли;
		//bizteh-- saa 07.02.2022
		
		//begin Roman'S 27.12.2020  
		УстановитьПривилегированныйРежим(Истина); 
		Если БТ_ПроцедурыДокументовСервер.КонтрагентаНетВИсключенияхКумКаржи(Организация,Контрагент) Тогда
			Запрос = Новый Запрос;
			Запрос.Текст =
			"ВЫБРАТЬ
			|	Автомобили.Автомобиль КАК Автомобиль
			|ПОМЕСТИТЬ ВТАвтомобили
			|ИЗ
			|	&Автомобили КАК Автомобили
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	КумулятивнаяМаржа.Автомобиль КАК Автомобиль,
			|	КумулятивнаяМаржа.Ссылка КАК Документ,
			|	КумулятивнаяМаржа.Проведен КАК Проведен
			|ПОМЕСТИТЬ ВТДокументыКМ
			|ИЗ
			|	Документ.ЭМ_КумулятивнаяМаржа КАК КумулятивнаяМаржа
			|ГДЕ
			|	НЕ КумулятивнаяМаржа.ПометкаУдаления
			|	И КумулятивнаяМаржа.ДокументОснование = &ДокументОснование
			|	И КумулятивнаяМаржа.Автомобиль В
			|			(ВЫБРАТЬ
			|				Автомобили.Автомобиль
			|			ИЗ
			|				ВТАвтомобили КАК Автомобили)
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Автомобили.Автомобиль КАК Автомобиль,
			|	ЕСТЬNULL(ЕСТЬNULL(МАКСИМУМ(ДокументыКМПроведенные.Документ), МАКСИМУМ(ДокументыКМНеПроведенные.Документ)), ЗНАЧЕНИЕ(Документ.ЭМ_КумулятивнаяМаржа.ПустаяСсылка)) КАК Документ,
			|	ЕСТЬNULL(ЕСТЬNULL(МАКСИМУМ(ДокументыКМПроведенные.Проведен), МАКСИМУМ(ДокументыКМНеПроведенные.Проведен)), Ложь) КАК Проведен
			|ИЗ
			|	ВТАвтомобили КАК Автомобили
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыКМ КАК ДокументыКМПроведенные
			|		ПО (ДокументыКМПроведенные.Автомобиль = Автомобили.Автомобиль)
			|			И (ДокументыКМПроведенные.Проведен)
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыКМ КАК ДокументыКМНеПроведенные
			|		ПО (ДокументыКМНеПроведенные.Автомобиль = Автомобили.Автомобиль)
			|			И (НЕ ДокументыКМНеПроведенные.Проведен)
			|
			|СГРУППИРОВАТЬ ПО
			|	Автомобили.Автомобиль";
			Запрос.УстановитьПараметр("ДокументОснование", Ссылка);
			Запрос.УстановитьПараметр("Автомобили", Автомобили);
			Результат = Запрос.Выполнить();
			Если НЕ Результат.Пустой() Тогда
				Выборка = Результат.Выбрать();
				Пока Выборка.Следующий() Цикл
					Если ЗначениеЗаполнено(Выборка.Документ) Тогда
						Если Выборка.Проведен Тогда
							Если Не Документы.ЭМ_КумулятивнаяМаржа.ОбновлениеПоказателей(Выборка.Документ) Тогда
								дкСообщитьРезультат("Для документа """ + Ссылка + """ для автомобиля """+СокрЛП(Выборка.Автомобиль)+""" ошибка при обновлении документа """ + Выборка.Документ + """!","Важное&Кумулятивная маржа:", ЭтотОбъект, Выборка.Документ);
								Отказ = Истина;
							КонецЕсли;
						Иначе
							дкСообщитьРезультат("Для документа """ + Ссылка + """ для автомобиля """+СокрЛП(Выборка.Автомобиль)+""" не проведен документ """ + Выборка.Документ + """!","Важное&Кумулятивная маржа:", ЭтотОбъект, Выборка.Документ);
							Отказ = Истина;
						КонецЕсли;
					Иначе  
						Если БТ_ПроцедурыДокументовСервер.КонтрагентаНетВИсключенияхКумКаржи(Организация,Контрагент) тогда      //ЧалапАю БизТех 15.07.2025 000000930
							дкСообщитьРезультат("Для документа """ + Ссылка + """ для автомобиля """+СокрЛП(Выборка.Автомобиль)+""" не заполнен документ кумулятивной маржи!","Важное&Кумулятивная маржа:", ЭтотОбъект, Выборка.Автомобиль);
							Отказ = Истина; 
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;   
		КонецЕсли;
		УстановитьПривилегированныйРежим(Ложь);

		//end Roman'S 27.12.2020
		
		//begin taty 23.03.2021
		Если НЕ Отказ Тогда
			// получим долг
			СтруктураОтбора=Новый Структура();
			СтруктураОтбора.Вставить("Контрагент",            Контрагент);
			СтруктураОтбора.Вставить("ДоговорВзаиморасчетов", ДоговорВзаиморасчетов);
			тзДолги = РегистрыНакопления.ВзаиморасчетыКомпании.Остатки(,СтруктураОтбора,,"Сумма");
			Долг    = тзДолги.Итог("Сумма");
			СуммаДокументаВВалютеДоговора = обПересчет(СуммаДокумента, ВалютаДокумента, КурсДокумента, ДоговорВзаиморасчетов.ВалютаВзаиморасчетов, Дата);
			ОсталосьОплатить = СуммаДокументаВВалютеДоговора + Долг;
			ЭМ_ПодписалОплату = обПолучитьЗначениеСвойства(ЭтотОбъект, ПланыВидовХарактеристик.СвойстваОбъектов.ЭМ_ПодписалОплату,Справочники.Пользователи.ПустаяСсылка());
			ЭМ_КнопкаНажата = обПолучитьЗначениеСвойства(ЭтотОбъект, ПланыВидовХарактеристик.СвойстваОбъектов.ЭМ_КнопкаНажата, ложь);        //ЧалапАю БизТех  21.03.2025   000000802
			
			Если ЗначениеЗаполнено(ЭМ_ПодписалОплату) и ЭМ_КнопкаНажата Тогда    //ЧалапАю БизТех  25.03.2025   000000802    ЭМ_КнопкаНажата
				ОплатаПодписана = Истина;
			Иначе
				ОплатаПодписана = Ложь;
			КонецЕсли;	
			//<<ЧалапАю БизТех 25.03.2025  000000802
			ПолнаяСтоимостьАвто = 0;
			Если не ОплатаПодписана тогда
				ПолнаяСтоимость = БТ_ПроцедурыДокументовСервер.НайтиПолнуюСтоимостьАвто(Ссылка.ДоговорВзаиморасчетов, Ссылка.Автомобили[0].Автомобиль,Ссылка);	 //ЧалапАю БизТех 21.03.2025 - ПолнаяСтоимостьАвто    000000802
				ПолнаяСтоимостьАвто = ПолнаяСтоимость.СуммаТрейд +  ПолнаяСтоимость.СуммаКСО  +  ПолнаяСтоимость.СуммаНаличные  +  ПолнаяСтоимость.СуммаБезнал;
			КонецЕсли;
			УстановитьАвтоматическиПодпись = ложь;
			Если ОсталосьОплатить = 0 тогда
				//если долга нет, то проводим
			иначе
				Если ПолнаяСтоимостьАвто>=СуммаДокумента и Не ОплатаПодписана  тогда
					ЭМ_ПодписалОплату = Справочники.Пользователи.НайтиПоНаименованию("Робот");
					ЭМ_ДатаУстановки = ТекущаяДата(); 
					ЭМ_КнопкаНажата = Истина;
					ОплатаПодписана = Истина;    
					УстановитьАвтоматическиПодпись = истина;
					Отказ = ложь;
				иначеЕсли ПолнаяСтоимостьАвто < СуммаДокумента и Не ОплатаПодписана тогда
					дкСообщитьРезультат("(Трейд+КСО+кэш+карта+безнал) меньше, чем стоимость автомобиля "+".
									| Необходимо подписать оплату.",СтатусСообщения.Важное,ЭтотОбъект);
			        Отказ=Истина;
				КонецЕсли;
			КонецЕсли;
            //ЧалапАю БизТех 25.03.2025  000000802  >>
			
			Если ОсталосьОплатить > 0 и Не ОплатаПодписана Тогда    
				ОсталосьОплатитьОтПолнойСтоимости = СуммаДокумента-ПолнаяСтоимостьАвто; //ЧалапАю БизТех 25.03.2025  000000802
				ВалютаВзаиморасчетов = СокрЛП(ДоговорВзаиморасчетов.ВалютаВзаиморасчетов.Наименование);
				дкСообщитьРезультат(" Сумма долга по договору составляет "+Формат(ОсталосьОплатитьОтПолнойСтоимости,"ЧДЦ=2; ЧН=0.00")+" "+ВалютаВзаиморасчетов+".
									| Необходимо подписать оплату.",СтатусСообщения.Важное,ЭтотОбъект);        //ЧалапАю БизТех 28.03.2025 000802 - выводилось ОсталосьОплатить
				Отказ=Истина;
			КонецЕсли; 
		КонецЕсли; 
		//end taty 23.03.2021		
	иначе
		УстановитьАвтоматическиПодпись = ложь;
	КонецЕсли;

	КонтрольКомплектацииАвтомобиляПриОтгрузке=обПраво("КонтрольКомплектацииАвтомобиляПриОтгрузке",Права,,ЭтотОбъект);
	Если КонтрольКомплектацииАвтомобиляПриОтгрузке Тогда
		Запрос=Новый Запрос;
		Запрос.Текст="ВЫБРАТЬ
		             |	ЕСТЬNULL(КомплектацияАвтомобилейОстатки.Автомобиль, РеализацияАвтомобилейАвтомобили.Автомобиль) КАК Автомобиль,
		             |	ЕСТЬNULL(КомплектацияАвтомобилейОстатки.ЗаказНаАвтомобиль, ЗаказНаАвтомобильКомплектация.ЗаказНаАвтомобиль) КАК ЗаказНаАвтомобиль,
					 |	ВЫБОР 
					 |		КОГДА ЕСТЬNULL(КомплектацияАвтомобилейОстатки.ДополнительноеОборудование, ЗаказНаАвтомобильКомплектация.ДополнительноеОборудование) ССЫЛКА Справочник.Опции
					 |		ТОГДА 0
					 |		ИНАЧЕ 
					 |			ВЫБОР 
					 |				КОГДА ЕСТЬNULL(КомплектацияАвтомобилейОстатки.ДополнительноеОборудование, ЗаказНаАвтомобильКомплектация.ДополнительноеОборудование) ССЫЛКА Справочник.Номенклатура
					 |				ТОГДА 1
					 |				ИНАЧЕ 2
					 |				КОНЕЦ
					 |		КОНЕЦ
					 |	КАК ТипДополнительногоОборудования,
		             |	ЕСТЬNULL(КомплектацияАвтомобилейОстатки.ДополнительноеОборудование, ЗаказНаАвтомобильКомплектация.ДополнительноеОборудование) КАК ДополнительноеОборудование,
		             |	ЕСТЬNULL(КомплектацияАвтомобилейОстатки.КоличествоОстаток, 0) КАК КоличествоКомплектации,
		             |	ЕСТЬNULL(ЗаказНаАвтомобильКомплектация.Количество, 0) КАК КоличествоПоЗаказу
		             |ИЗ
		             |	(ВЫБРАТЬ
		             |		РеализацияАвтомобилейАвтомобили.Автомобиль КАК Автомобиль,
		             |		РеализацияАвтомобилейАвтомобили.ЗаказНаАвтомобиль КАК ЗаказНаАвтомобиль,
		             |		КомплектацияАвтомобилейОстатки.Номенклатура КАК ДополнительноеОборудование,
		             |		КомплектацияАвтомобилейОстатки.КоличествоОстаток КАК КоличествоОстаток
		             |	ИЗ
		             |		РегистрНакопления.КомплектацияАвтомобилей.Остатки(&НаДату, Автомобиль В (&Автомобиль)) КАК КомплектацияАвтомобилейОстатки
		             |			ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияАвтомобилей.Автомобили КАК РеализацияАвтомобилейАвтомобили
		             |			ПО РеализацияАвтомобилейАвтомобили.Автомобиль = КомплектацияАвтомобилейОстатки.Автомобиль
		             |	ГДЕ
		             |		РеализацияАвтомобилейАвтомобили.Ссылка = &Ссылка
		             |		И РеализацияАвтомобилейАвтомобили.ЗаказНаАвтомобиль <> &ПустойЗаказ) КАК КомплектацияАвтомобилейОстатки
		             |		ПОЛНОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		             |			ЗаказНаАвтомобильОпции.Ссылка КАК ЗаказНаАвтомобиль,
		             |			ЗаказНаАвтомобильОпции.Опция КАК ДополнительноеОборудование,
		             |			ЗаказНаАвтомобильОпции.Количество КАК Количество
		             |		ИЗ
		             |			Документ.ЗаказНаАвтомобиль.Опции КАК ЗаказНаАвтомобильОпции
		             |		ГДЕ
		             |			ЗаказНаАвтомобильОпции.Ссылка В(&ЗаказНаАвтомобиль)
		             |		
		             |		ОБЪЕДИНИТЬ ВСЕ
		             |		
		             |		ВЫБРАТЬ
		             |			ЗаказНаАвтомобильТовары.Ссылка,
		             |			ЗаказНаАвтомобильТовары.Номенклатура,
		             |			ЗаказНаАвтомобильТовары.Количество * ЗаказНаАвтомобильТовары.Коэффициент
		             |		ИЗ
		             |			Документ.ЗаказНаАвтомобиль.Товары КАК ЗаказНаАвтомобильТовары
		             |		ГДЕ
		             |			ЗаказНаАвтомобильТовары.Ссылка В(&ЗаказНаАвтомобиль)) КАК ЗаказНаАвтомобильКомплектация
		             |			ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияАвтомобилей.Автомобили КАК РеализацияАвтомобилейАвтомобили
		             |			ПО РеализацияАвтомобилейАвтомобили.ЗаказНаАвтомобиль = ЗаказНаАвтомобильКомплектация.ЗаказНаАвтомобиль
		             |		ПО КомплектацияАвтомобилейОстатки.ЗаказНаАвтомобиль = ЗаказНаАвтомобильКомплектация.ЗаказНаАвтомобиль
		             |			И КомплектацияАвтомобилейОстатки.ДополнительноеОборудование = ЗаказНаАвтомобильКомплектация.ДополнительноеОборудование
		             |ГДЕ
		             |	ЕСТЬNULL(КомплектацияАвтомобилейОстатки.КоличествоОстаток, 0) <> ЕСТЬNULL(ЗаказНаАвтомобильКомплектация.Количество, 0)
		             |
		             |УПОРЯДОЧИТЬ ПО
		             |	Автомобиль,
					 |	ТипДополнительногоОборудования,
		             |	ДополнительноеОборудование";
		Запрос.УстановитьПараметр("Ссылка",Ссылка);
		Запрос.УстановитьПараметр("ПустойЗаказ",Документы.ЗаказНаАвтомобиль.ПустаяСсылка());
		Запрос.УстановитьПараметр("НаДату",Дата);
		Запрос.УстановитьПараметр("Автомобиль",Автомобили.ВыгрузитьКолонку("Автомобиль"));
		Запрос.УстановитьПараметр("ЗаказНаАвтомобиль",Автомобили.ВыгрузитьКолонку("ЗаказНаАвтомобиль"));
		ВыборкаКомплектации=Запрос.Выполнить().Выбрать();
		Для каждого СтрокаАвтомобиля Из Автомобили Цикл
			Если НЕ обЗначениеНеЗаполнено(СтрокаАвтомобиля.ЗаказНаАвтомобиль) Тогда
				Если СтрокаАвтомобиля.Автомобиль.Модель<>СтрокаАвтомобиля.ЗаказНаАвтомобиль.Модель ИЛИ
					 СтрокаАвтомобиля.Автомобиль.ВариантКомплектации<>СтрокаАвтомобиля.ЗаказНаАвтомобиль.ВариантКомплектации ИЛИ
					 ((НЕ обЗначениеНеЗаполнено(СтрокаАвтомобиля.Автомобиль.Цвет)) И (НЕ обЗначениеНеЗаполнено(СтрокаАвтомобиля.ЗаказНаАвтомобиль.Цвет)) И (СтрокаАвтомобиля.Автомобиль.Цвет<>СтрокаАвтомобиля.ЗаказНаАвтомобиль.Цвет)) Тогда
					 дкСообщитьРезультат(
					 	"Автомобиль """+СокрЛП(СтрокаАвтомобиля.Автомобиль)+
						""", модель """+СокрЛП(СтрокаАвтомобиля.Автомобиль.Модель)+""""+
						?(обЗначениеНеЗаполнено(СтрокаАвтомобиля.Автомобиль.ВариантКомплектации),""," в комплектации """+СокрЛП(СтрокаАвтомобиля.Автомобиль.ВариантКомплектации)+"""")+
						?(обЗначениеНеЗаполнено(СтрокаАвтомобиля.Автомобиль.Цвет),"",", цвет """+СокрЛП(СтрокаАвтомобиля.Автомобиль.Цвет)+"""")+". "+
					 	"По заказу <"+СокрЛП(СтрокаАвтомобиля.ЗаказНаАвтомобиль)+"> заказывалась """+
						СокрЛП(СтрокаАвтомобиля.ЗаказНаАвтомобиль.Модель)+""""+
						?(обЗначениеНеЗаполнено(СтрокаАвтомобиля.ЗаказНаАвтомобиль.ВариантКомплектации),""," в комплектации """+СокрЛП(СтрокаАвтомобиля.ЗаказНаАвтомобиль.ВариантКомплектации)+"""")+
						?(обЗначениеНеЗаполнено(СтрокаАвтомобиля.ЗаказНаАвтомобиль.Цвет),"",", цвет """+СокрЛП(СтрокаАвтомобиля.ЗаказНаАвтомобиль.Цвет)+"""")+"."
						,"Важное&Комплектация автомобилей:",ЭтотОбъект,СтрокаАвтомобиля.Автомобиль);
					 Отказ=Истина;
				КонецЕсли; 
				ВыборкаКомплектации.Сбросить();
				СтруктураПоиска=Новый Структура("Автомобиль,ЗаказНаАвтомобиль",СтрокаАвтомобиля.Автомобиль,СтрокаАвтомобиля.ЗаказНаАвтомобиль);
				Пока ВыборкаКомплектации.НайтиСледующий(СтруктураПоиска) Цикл
					Если ВыборкаКомплектации.ТипДополнительногоОборудования=0 Тогда
						дкСообщитьРезультат("Автомобиль """+СокрЛП(ВыборкаКомплектации.Автомобиль)+""". Опция """+СокрЛП(ВыборкаКомплектации.ДополнительноеОборудование)+""" по заказу <"+СокрЛП(ВыборкаКомплектации.ЗаказНаАвтомобиль)+"> заказывалась в количестве "+Формат(ВыборкаКомплектации.КоличествоПоЗаказу,"ЧЦ=15; ЧДЦ=0; ЧН=0")+", укомплектован в количестве "+Формат(ВыборкаКомплектации.КоличествоКомплектации,"ЧЦ=15; ЧДЦ=0; ЧН=0")+".","Важное&Комплектация автомобилей:",ЭтотОбъект,ВыборкаКомплектации.Автомобиль);
					Иначе
						дкСообщитьРезультат("Автомобиль """+СокрЛП(ВыборкаКомплектации.Автомобиль)+""". Оборудование """+СокрЛП(ВыборкаКомплектации.ДополнительноеОборудование)+""" по заказу <"+СокрЛП(ВыборкаКомплектации.ЗаказНаАвтомобиль)+"> заказывалась в количестве "+Формат(ВыборкаКомплектации.КоличествоПоЗаказу,"ЧЦ=15; ЧДЦ=3; ЧН=0")+", укомплектован в количестве "+Формат(ВыборкаКомплектации.КоличествоКомплектации,"ЧЦ=15; ЧДЦ=3; ЧН=0")+".","Важное&Комплектация автомобилей:",ЭтотОбъект,ВыборкаКомплектации.Автомобиль);
					КонецЕсли; 
					Отказ=Истина;
				КонецЦикла; 
			КонецЕсли; 
		КонецЦикла; 
	КонецЕсли;
	Если Отказ Тогда
		// выведем сообщения об ошибках и предупреждениях
		дкВыводРезультатовОбработки(ЭтотОбъект,Отказ);
		Возврат;
	КонецЕсли; 
	
	// проведем взаиморасчеты
	Если ХозОперация<>Справочники.ХозОперации.РеализацияАвтомобилейКомиссия Тогда
		СуммаВсехАвтомобилейПоЗаказам=0;
		СуммаДоходаРасходаСуммовыхРазниц=0;
		Для каждого СтрокаАвтомобиля Из Автомобили Цикл
			Если НЕ обЗначениеНеЗаполнено(СтрокаАвтомобиля.ЗаказНаАвтомобиль) Тогда
				СуммаАвтомобиля=СтрокаАвтомобиля.СуммаВсего;
				СтрокиОпций=Товары.НайтиСтроки(Новый Структура("ИдентификаторАвтомобиля",СтрокаАвтомобиля.ИдентификаторАвтомобиля));
				Для каждого СтрокаТоваров Из СтрокиОпций Цикл
					СуммаАвтомобиля=СуммаАвтомобиля+СтрокаТоваров.СуммаВсего;
				КонецЦикла; 
				Если СуммаАвтомобиля<>0 Тогда
					НаборЗаписейВзаиморасчеты=Движения.ВзаиморасчетыКомпании;
					НаборЗаписейВзаиморасчеты.ДокументОбъект=ЭтотОбъект;
					НаборЗаписейВзаиморасчеты.РежимПроведения=Режим;
					НаборЗаписейВзаиморасчеты.Контрагент=Контрагент;
					НаборЗаписейВзаиморасчеты.ДоговорВзаиморасчетов=ДоговорВзаиморасчетов;
					НаборЗаписейВзаиморасчеты.Сделка=СтрокаАвтомобиля.ЗаказНаАвтомобиль;
					НаборЗаписейВзаиморасчеты.ВзаиморасчетыСПокупателем=Истина;
					НаборЗаписейВзаиморасчеты.Сумма=СуммаАвтомобиля;
					НаборЗаписейВзаиморасчеты.СуммаДоходаРасходаСуммовыхРазниц=0;
					Отказ = НЕ НаборЗаписейВзаиморасчеты.Приход() ИЛИ Отказ;
					СуммаВсехАвтомобилейПоЗаказам=СуммаВсехАвтомобилейПоЗаказам+СуммаАвтомобиля;
					СуммаДоходаРасходаСуммовыхРазниц=СуммаДоходаРасходаСуммовыхРазниц+НаборЗаписейВзаиморасчеты.СуммаДоходаРасходаСуммовыхРазниц;
				КонецЕсли; 
			КонецЕсли; 
		КонецЦикла;
		СуммаВсехАвтомобилейПоЗаказам=СуммаДокумента-СуммаВсехАвтомобилейПоЗаказам;
		Если СуммаВсехАвтомобилейПоЗаказам<>0 Тогда
			НаборЗаписейВзаиморасчеты=Движения.ВзаиморасчетыКомпании;
			НаборЗаписейВзаиморасчеты.ДокументОбъект=ЭтотОбъект;
			НаборЗаписейВзаиморасчеты.РежимПроведения=Режим;
			НаборЗаписейВзаиморасчеты.Контрагент=Контрагент;
			НаборЗаписейВзаиморасчеты.ДоговорВзаиморасчетов=ДоговорВзаиморасчетов;
			Если (НЕ обЗначениеНеЗаполнено(ДокументОснование)) И (ТипЗнч(ДокументОснование)=Тип("ДокументСсылка.ЗаказНаАвтомобиль")) Тогда
				НаборЗаписейВзаиморасчеты.Сделка=ДокументОснование;
			Иначе
				НаборЗаписейВзаиморасчеты.Сделка=Неопределено;
			КонецЕсли; 
			НаборЗаписейВзаиморасчеты.ВзаиморасчетыСПокупателем=Истина;
			НаборЗаписейВзаиморасчеты.Сумма=СуммаВсехАвтомобилейПоЗаказам;
			НаборЗаписейВзаиморасчеты.СуммаДоходаРасходаСуммовыхРазниц=0;
			Отказ = НЕ НаборЗаписейВзаиморасчеты.Приход() ИЛИ Отказ;
			СуммаДоходаРасходаСуммовыхРазниц=СуммаДоходаРасходаСуммовыхРазниц+НаборЗаписейВзаиморасчеты.СуммаДоходаРасходаСуммовыхРазниц;
		КонецЕсли; 
		
		// доходы и расходы по суммовым разницам
		Если СуммаДоходаРасходаСуммовыхРазниц<>0 Тогда
			НаборЗаписейДиР = Движения.ДоходыИРасходы;
			НаборЗаписейДиР.ДокументОбъект = ЭтотОбъект;
			НаборЗаписейДиР.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СуммовыеРазницы;
			НаборЗаписейДиР.ВУпрВалюте = Истина;
			Если СуммаДоходаРасходаСуммовыхРазниц<0 Тогда
				НаборЗаписейДиР.Расход = -СуммаДоходаРасходаСуммовыхРазниц;
			Иначе
				НаборЗаписейДиР.Доход = СуммаДоходаРасходаСуммовыхРазниц;
			КонецЕсли;
			Отказ = НЕ НаборЗаписейДиР.Приход() ИЛИ Отказ;
		КонецЕсли;
	КонецЕсли;
	
	ВалютаУпр=Константы.ВалютаУправленческогоУчетаКомпании.Получить(); 
	Если обЗначениеНеЗаполнено(КурсВалютыУпр) Тогда
		СтруктураКурса = обКурсДляВалюты(ВалютаУпр,МоментВремени());
		КурсУпр        = СтруктураКурса.Курс / ?(СтруктураКурса.Кратность = 0, 1, СтруктураКурса.Кратность);
	Иначе
		КурсУпр        = КурсВалютыУпр;
	КонецЕсли;
	
	если не РольДоступна("ПолныеПрава") тогда
		Отказ = ПроверитьЗаказыНаАвтомобиль() ИЛИ Отказ;  
	КонецЕсли;
	
	НеПроверятьЗаказ = Ложь;
	Если НЕ ЭтотОбъект.ДополнительныеСвойства.Свойство("НеПроверятьЗаказ",НеПроверятьЗаказ) Тогда
		НеПроверятьЗаказ = Ложь;
	КонецЕсли;
	
	Если НЕ НеПроверятьЗаказ и не РольДоступна("ПолныеПрава") Тогда
		Отказ = ПроверитьЗаказыНаАвтомобиль() ИЛИ Отказ;
	КонецЕсли;
	
	Если НЕ НеПроверятьЗаказ Тогда	
	
	//Для начала закроем заказы покупателя на эти автомобили
	Запрос=Новый Запрос;
	Запрос.Текст="
			|ВЫБРАТЬ
			|	РеализацияАвтомобилейАвтомобили.Автомобиль КАК Автомобиль
			|ПОМЕСТИТЬ
			|	ТаблицаАвтомобили
			|ИЗ
			|	Документ.РеализацияАвтомобилей.Автомобили КАК РеализацияАвтомобилейАвтомобили
			|ГДЕ
			|	РеализацияАвтомобилейАвтомобили.Ссылка = &Ссылка И 
			|	РеализацияАвтомобилейАвтомобили.АвтомобильБезЗаказа = ЛОЖЬ
			|ИНДЕКСИРОВАТЬ ПО
			|	Автомобиль
			|;
			|
			|ВЫБРАТЬ
			|	ЗаказыАвтомобилейОстатки.Автомобиль КАК Автомобиль,
			|	ЗаказыАвтомобилейОстатки.Заказ КАК Заказ,
			|	ЗаказыАвтомобилейОстатки.Заказ.Контрагент КАК Контрагент,
			|	ЗаказыАвтомобилейОстатки.Заказ.ДоговорВзаиморасчетов КАК ДоговорВзаиморасчетов,
			|	ЕСТЬNULL(ЗаказыАвтомобилейОстатки.КоличествоОстаток, 0) КАК Количество,
			|	ЕСТЬNULL(ЗаказыАвтомобилейОстатки.РезервОстаток, 0) КАК Резерв,
			|	ЕСТЬNULL(ЗаказыАвтомобилейОстатки.СуммаОстаток, 0) КАК Сумма,
			|	ЕСТЬNULL(ЗаказыАвтомобилейОстатки.СуммаУпрОстаток, 0) КАК СуммаУпр
			|ИЗ
			|	РегистрНакопления.ЗаказыАвтомобилей.Остатки(
			|	&НаДату,
			|	Автомобиль В (ВЫБРАТЬ Автомобиль ИЗ ТаблицаАвтомобили)) КАК ЗаказыАвтомобилейОстатки
			|";
	Запрос.УстановитьПараметр("Ссылка",      Ссылка);
	Запрос.УстановитьПараметр("ПустойЗаказ", Документы.ЗаказНаАвтомобиль.ПустаяСсылка());
	Запрос.УстановитьПараметр("НаДату",      Дата);
	
	// Наложим блокировку на считываемые данные
	СтруктураПараметровБлокировки = Новый Структура("ТипТаблицы, ИмяТаблицы", "РегистрНакопления", "ЗаказыАвтомобилей");
	ЗначенияБлокировки = Новый Соответствие;
	ЗначенияБлокировки.Вставить("Период", Новый Диапазон(, Дата));
	
	СтруктураПараметровБлокировки.Вставить("ИсточникДанных", Автомобили);
	ОписаниеИсточника = Новый Соответствие;
	ОписаниеИсточника.Вставить("Автомобиль", "Автомобиль");
	обУстановитьУправляемуюБлокировку(СтруктураПараметровБлокировки, ЗначенияБлокировки, ОписаниеИсточника);
	
	ТаблицаЗаказов = Запрос.Выполнить().Выгрузить();
	ТаблицаЗаказов.Индексы.Добавить("Автомобиль");
	НаборЗаписейЗаказыАвтомобилей = Движения.ЗаказыАвтомобилей;
	
	Для Каждого ТекСтрока Из Автомобили Цикл
		
		Если ТекСтрока.АвтомобильБезЗаказа Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаЗаказа = ТаблицаЗаказов.Найти(ТекСтрока.Автомобиль, "Автомобиль");
		
		Если СтрокаЗаказа = Неопределено ИЛИ ТекСтрока.Количество>СтрокаЗаказа.Количество Тогда
			дкСообщитьРезультат("Автомобиль """+СокрЛП(ТекСтрока.Автомобиль)+""" не заказывался. Закрытие заказа невозможно.","Важное&Заказы автомобилей:",ЭтотОбъект,ТекСтрока.Автомобиль);
			Отказ = Истина;
			Продолжить;
		ИначеЕсли СтрокаЗаказа.Заказ <> ТекСтрока.ЗаказНаАвтомобиль Тогда
			дкСообщитьРезультат("Автомобиль """+СокрЛП(СтрокаЗаказа.Автомобиль)+""" заказан документом """+СокрЛП(СтрокаЗаказа.Заказ)+""". Закрытие чужого заказа невозможно.","Важное&Заказы автомобилей:",ЭтотОбъект,СтрокаЗаказа.Автомобиль);
			Отказ=Истина;
			Продолжить;
		ИначеЕсли СтрокаЗаказа.Контрагент<>Контрагент Тогда
			дкСообщитьРезультат("Автомобиль """+СокрЛП(СтрокаЗаказа.Автомобиль)+""" заказан контрагентом """+СокрЛП(СтрокаЗаказа.Контрагент)+""". Закрытие чужого заказа невозможно.","Важное&Заказы автомобилей:",ЭтотОбъект,СтрокаЗаказа.Автомобиль);
			Отказ = Истина;
			Продолжить;
		ИначеЕсли СтрокаЗаказа.ДоговорВзаиморасчетов<>ДоговорВзаиморасчетов Тогда
			дкСообщитьРезультат("Автомобиль """+СокрЛП(СтрокаЗаказа.Автомобиль)+""" заказан контрагентом согласно договора """+СокрЛП(СтрокаЗаказа.ДоговорВзаиморасчетов)+""". Закрытие заказа по другому договору невозможно.","Важное&Заказы автомобилей:",ЭтотОбъект,СтрокаЗаказа.Автомобиль);
			Отказ = Истина;
			Продолжить;
		ИначеЕсли СтрокаЗаказа.Резерв = 0 Тогда
			дкСообщитьРезультат("Автомобиль """+СокрЛП(ТекСтрока.Автомобиль)+""" не зарезервирован. Закрытие заказа невозможно.","Важное&Заказы автомобилей:",ЭтотОбъект,ТекСтрока.Автомобиль);
			Отказ = Истина;
			Продолжить;
		КонецЕсли;
		НоваяЗапись = НаборЗаписейЗаказыАвтомобилей.Добавить();
		НоваяЗапись.ВидДвижения = ВидДвиженияНакопления.Расход;
		НоваяЗапись.Период      = Дата;
		НоваяЗапись.Регистратор = Ссылка;
		НоваяЗапись.Автомобиль  = СтрокаЗаказа.Автомобиль;
		НоваяЗапись.Заказ       = СтрокаЗаказа.Заказ;
		НоваяЗапись.Количество  = СтрокаЗаказа.Количество;
		НоваяЗапись.Резерв      = СтрокаЗаказа.Резерв;
		НоваяЗапись.Сумма       = СтрокаЗаказа.Сумма;
		НоваяЗапись.СуммаУпр    = СтрокаЗаказа.СуммаУпр;
		НоваяЗапись.ХозОперация = ХозОперация;
	КонецЦикла;
	
	Если НЕ Отказ Тогда
		НаборЗаписейЗаказыАвтомобилей.Записать();
	КонецЕсли;
	КонецЕсли;
	
	Если НЕ Отказ Тогда
		//Спишем автомобиль со склада
		ТекстЗапроса="ВЫБРАТЬ
					 |	ДокументАвтомобили.Автомобиль КАК Автомобиль,
					 |	ДокументАвтомобили.Количество КАК Количество,
					 |	ДокументАвтомобили.СуммаВсего КАК СуммаПродажи,
					 |	ДокументАвтомобили.Цена КАК ЦенаАвтомобиля
					 |ИЗ
					 |	Документ.РеализацияАвтомобилей.Автомобили КАК ДокументАвтомобили
					 |ГДЕ
					 |	ДокументАвтомобили.Ссылка = &Ссылка
					 |";
		Запрос=Новый Запрос(ТекстЗапроса);
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		
		НаборЗаписейОстаткиАвтомобилей = Движения.ОстаткиАвтомобилей;
		НаборЗаписейОстаткиАвтомобилей.РежимПроведения               = Режим;
		НаборЗаписейОстаткиАвтомобилей.ДокументОбъект                = ЭтотОбъект;
		НаборЗаписейОстаткиАвтомобилей.РезультатЗапросаПоАвтомобилям = Запрос.Выполнить().Выгрузить();
		НаборЗаписейОстаткиАвтомобилей.СкладКомпании                 = СкладКомпании;
		//НаборЗаписейОстаткиАвтомобилей.Приходовать                   = Истина;
		//НаборЗаписейОстаткиАвтомобилей.Резервировать                 = Истина;
		НаборЗаписейОстаткиАвтомобилей.СуммаПродажи                  = "СуммаПродажи";
		Отказ = НЕ НаборЗаписейОстаткиАвтомобилей.Расход() ИЛИ Отказ;
		Если НЕ Отказ Тогда
			НаборЗаписейОстаткиАвтомобилей.Записать();
		КонецЕсли; 
	КонецЕсли; 
	
	Если НЕ Отказ Тогда
		Отказ=НЕ ПровестиПоПартиям(Режим,Ссылка) ИЛИ Отказ;
	КонецЕсли; 
	
	Если НЕ Отказ Тогда
		ВедетсяБалансПоПодразделению = (Константы.СпособВеденияБаланса.Получить() = Перечисления.СпособВеденияБаланса.ПоПодразделению);
		ШапкаДокумента=ПолучитьШапкуДокумента(Ссылка);
		// комиссия
		Если ХозОперация=Справочники.ХозОперации.РеализацияАвтомобилейКомиссия Тогда
			// проведем партии автомобилей переданные на комиссию
			НаборЗаписейАвтомобилиОтданные=Движения.АвтомобилиОтданные;
			НаборЗаписейАвтомобилиОтданные.ДокументОбъект=ЭтотОбъект;
			НаборЗаписейАвтомобилиОтданные.Контрагент=Контрагент;
			НаборЗаписейАвтомобилиОтданные.ДоговорВзаиморасчетов=ДоговорВзаиморасчетов;
			НаборЗаписейАвтомобилиОтданные.РезультатЗапросаПоАвтомобилям=Неопределено;
			Отказ=НЕ НаборЗаписейАвтомобилиОтданные.Приход() ИЛИ Отказ;
			
			// определим необходимость формирования корректирующих проводок
			// получим шапку документа
			ПодразделениеСклад = обПолучитьБалансовоеПодразделение(ШапкаДокумента.СкладКомпании.Подразделение);
			ПодразделениеДоговорВзаиморасчетов = обПолучитьБалансовоеПодразделение(ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение);
			БалансовыеПодразделенияНеРавны = (ПодразделениеДоговорВзаиморасчетов<>ПодразделениеСклад);
			//Если балансовые подразделение договора и подразделения склад не равны, то сформируем корректирующие проводки
			Если ВедетсяБалансПоПодразделению и БалансовыеПодразделенияНеРавны Тогда
				НаборЗаписейОстаткиАвтомобилей=Движения.ОстаткиАвтомобилей;
				НаборЗаписейКомплектацияАвтомобилей=Движения.КомплектацияАвтомобилей;
				СебестоимостьУпр=НаборЗаписейОстаткиАвтомобилей.Итог("СуммаУпр")+НаборЗаписейКомплектацияАвтомобилей.Итог("СуммаУпр");
				//сумма себестоимости списанных автомобилей
				НаборЗаписейДоходыИРасходы=Движения.ДоходыИРасходы;
				НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
				НаборЗаписейДоходыИРасходы.Подразделение          = ШапкаДокумента.СкладКомпании.Подразделение;
				НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.КорректировкаБалансаПоПодразделениям;
				НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
				НаборЗаписейДоходыИРасходы.Доход                  = СебестоимостьУпр;	
				НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
				Отказ=НЕ НаборЗаписейДоходыИРасходы.Расход() ИЛИ Отказ;
				
				НаборЗаписейАвтомобилиОтданные=Движения.АвтомобилиОтданные;
				НаборЗаписейПартииОтданные=Движения.ПартииТоваровОтданные;
				СебестоимостьУпр=НаборЗаписейАвтомобилиОтданные.Итог("СуммаСебестоимостиУпр")+НаборЗаписейПартииОтданные.Итог("СуммаСебестоимостиУпр");
				//сумма себестоимости списанных товаров
				НаборЗаписейДоходыИРасходы=Движения.ДоходыИРасходы;
				НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
				НаборЗаписейДоходыИРасходы.Подразделение          = ШапкаДокумента.ДоговорВзаиморасчетов.Подразделение;
				НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.КорректировкаБалансаПоПодразделениям;
				НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
				НаборЗаписейДоходыИРасходы.Доход                  = СебестоимостьУпр;	
				НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
				Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
			КонецЕсли;	
		Иначе
			// спишем реализованные комиссионные автомобили
			Запрос=Новый Запрос;
			Запрос.Текст="ВЫБРАТЬ
			             |	ОстаткиАвтомобилей.Автомобиль КАК Автомобиль,
			             |	ОстаткиАвтомобилей.ГТД КАК ГТД,
			             |	ОстаткиАвтомобилей.Количество КАК Количество,
			             |	РеализацияАвтомобилейАвтомобили.СуммаВсего КАК СуммаПродажи
			             |ИЗ
			             |	РегистрНакопления.ОстаткиАвтомобилей КАК ОстаткиАвтомобилей
			             |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияАвтомобилей.Автомобили КАК РеализацияАвтомобилейАвтомобили
			             |		ПО ОстаткиАвтомобилей.Автомобиль = РеализацияАвтомобилейАвтомобили.Автомобиль
						 |			И ОстаткиАвтомобилей.Регистратор = РеализацияАвтомобилейАвтомобили.Ссылка
			             |ГДЕ
			             |	ОстаткиАвтомобилей.Регистратор = &Регистратор
			             |	И ОстаткиАвтомобилей.СтатусПартии = &СтатусПартииТоварПринятыйКомиссия";
			Запрос.УстановитьПараметр("Регистратор",Ссылка);
			Запрос.УстановитьПараметр("СтатусПартииТоварПринятыйКомиссия",Перечисления.СтатусыПартий.ТоварПринятыйКомиссия);
			НаборЗаписейРеализованныеАвтомобили=Движения.РеализованныеАвтомобили;
			НаборЗаписейРеализованныеАвтомобили.ДокументОбъект=ЭтотОбъект;
			НаборЗаписейРеализованныеАвтомобили.Контрагент=Контрагент;
			НаборЗаписейРеализованныеАвтомобили.ДоговорВзаиморасчетов=ДоговорВзаиморасчетов;
			НаборЗаписейРеализованныеАвтомобили.РезультатЗапросаПоАвтомобилям=Запрос.Выполнить();
			НаборЗаписейРеализованныеАвтомобили.ВУпрВалюте=Ложь;
			Отказ=НЕ НаборЗаписейРеализованныеАвтомобили.Приход() ИЛИ Отказ;
			
			// продажи автомобилей
			Если НЕ Отказ Тогда
				НаборЗаписейПродажиАвтомобилей=Движения.ПродажиАвтомобилей;
				НаборЗаписейПродажиАвтомобилей.ДокументОбъект=ЭтотОбъект;
				НаборЗаписейПродажиАвтомобилей.СкладКомпании=СкладКомпании;
				НаборЗаписейПродажиАвтомобилей.ДокументПродажи=Ссылка;
				НаборЗаписейПродажиАвтомобилей.Сторно=Ложь;
				НаборЗаписейПродажиАвтомобилей.Покупатель=Контрагент;
				НаборЗаписейПродажиАвтомобилей.ДоговорВзаиморасчетов=ДоговорВзаиморасчетов;
				НаборЗаписейПродажиАвтомобилей.ПодразделениеКомпании=ПодразделениеКомпании;
				НаборЗаписейПродажиАвтомобилей.Комиссия=Ложь;
				НаборЗаписейПродажиАвтомобилей.РезультатЗапросаПоАвтомобилям=НаборЗаписейПродажиАвтомобилей.ПолучитьТаблицуАвтомобилей().Выгрузить();
				Отказ=НЕ НаборЗаписейПродажиАвтомобилей.Приход() ИЛИ Отказ;
			КонецЕсли;
			
			//доходы и расходы
			НаборЗаписейРеализованныеТовары=Движения.РеализованныеТовары;
			НаборЗаписейРеализованныеТовары.Записать();
			НаборЗаписейРеализованныеАвтомобили.Записать();
			Запрос=Новый Запрос;
			Запрос.Текст="ВЫБРАТЬ
						 |	ОбъединенныйЗапрос.Подразделение КАК Подразделение,
						 |	ЕСТЬNULL(СУММА(ОбъединенныйЗапрос.СуммаАвтомобилейУпр), 0) КАК СуммаАвтомобилейУпр,
						 |	ЕСТЬNULL(СУММА(ОбъединенныйЗапрос.СуммаОборудованияУпр), 0) КАК СуммаОборудованияУпр
						 |ИЗ(
						 |ВЫБРАТЬ
						 |	РеализованныеАвтомобили.ДоговорВзаиморасчетов.Подразделение КАК Подразделение,
						 |	ЕСТЬNULL(СУММА(РеализованныеАвтомобили.СуммаУпр), 0) КАК СуммаАвтомобилейУпр,
						 |	0 КАК СуммаОборудованияУпр
						 |ИЗ
						 |	РегистрНакопления.РеализованныеАвтомобили КАК РеализованныеАвтомобили
						 |ГДЕ
						 |	РеализованныеАвтомобили.Регистратор = &Регистратор
						 |СГРУППИРОВАТЬ ПО
						 |	РеализованныеАвтомобили.ДоговорВзаиморасчетов.Подразделение
						 |
						 |ОБЪЕДИНИТЬ ВСЕ
						 |
						 |ВЫБРАТЬ
						 |	РеализованныеТовары.ДоговорВзаиморасчетов.Подразделение,
						 |	0,
						 |	ЕСТЬNULL(СУММА(РеализованныеТовары.СуммаУпр),0)
						 |ИЗ
						 |	РегистрНакопления.РеализованныеТовары КАК РеализованныеТовары
						 |ГДЕ
						 |	РеализованныеТовары.Регистратор = &Регистратор
						 |СГРУППИРОВАТЬ ПО
						 |	РеализованныеТовары.ДоговорВзаиморасчетов.Подразделение
						 |) КАК ОбъединенныйЗапрос
						 |СГРУППИРОВАТЬ ПО
						 |	ОбъединенныйЗапрос.Подразделение";
			Запрос.УстановитьПараметр("Регистратор",ШапкаДокумента.Ссылка);
			// в случае если ведется баланс по подразделению передадим подразделение соответствующее корреспонденции
			Если ВедетсяБалансПоПодразделению Тогда
				Выборка=Запрос.Выполнить().Выбрать();
				НаборЗаписейДоходыИРасходы=Движения.ДоходыИРасходы;
				Пока Выборка.Следующий() Цикл
					СуммаАвтомобилейУпр  = Выборка.СуммаАвтомобилейУпр;
					СуммаОборудованияУпр = Выборка.СуммаОборудованияУпр;
					Если СуммаАвтомобилейУпр <> 0 Тогда
						НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
						НаборЗаписейДоходыИРасходы.Подразделение          = Выборка.Подразделение;
						НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СебестоимостьАвтомобилей;
						НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
						НаборЗаписейДоходыИРасходы.Расход                 = СуммаАвтомобилейУпр;
						НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
						Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
					КонецЕсли;
					Если СуммаОборудованияУпр <> 0 Тогда
						НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
						НаборЗаписейДоходыИРасходы.Подразделение          = Выборка.Подразделение;
						НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.Себестоимость;
						НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
						НаборЗаписейДоходыИРасходы.Расход                 = СуммаОборудованияУпр;
						НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
						Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
					КонецЕсли;
				КонецЦикла; 
			Иначе
				ТаблицаСебестоимости = Запрос.Выполнить().Выгрузить();
				СуммаАвтомобилейУпр = ТаблицаСебестоимости.Итог("СуммаАвтомобилейУпр");
				СуммаОборудованияУпр = ТаблицаСебестоимости.Итог("СуммаОборудованияУпр");
				Если СуммаАвтомобилейУпр <> 0 Тогда
					НаборЗаписейДоходыИРасходы=Движения.ДоходыИРасходы;
					НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
					НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.СебестоимостьАвтомобилей;
					НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
					НаборЗаписейДоходыИРасходы.Расход                 = СуммаАвтомобилейУпр;
					НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
					Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
				КонецЕсли;
				Если СуммаОборудованияУпр <> 0 Тогда
					НаборЗаписейДоходыИРасходы=Движения.ДоходыИРасходы;
					НаборЗаписейДоходыИРасходы.ДокументОбъект         = ЭтотОбъект;
					НаборЗаписейДоходыИРасходы.СтатьяДоходовИРасходов = Справочники.СтатьиДоходовИРасходов.Себестоимость;
					НаборЗаписейДоходыИРасходы.ВУпрВалюте             = Истина;
					НаборЗаписейДоходыИРасходы.Расход                 = СуммаОборудованияУпр;
					НаборЗаписейДоходыИРасходы.ШапкаДокумента         = ШапкаДокумента;
					Отказ=НЕ НаборЗаписейДоходыИРасходы.Приход() ИЛИ Отказ;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	//Если НЕ Отказ Тогда
	//	//Сформируем сумму накопления
	//	НаборЗаписейНакоплениеСумм=РегистрыСведений.НакоплениеСумм.СоздатьНаборЗаписей();
	//	НаборЗаписейНакоплениеСумм.ДокументОбъект=ЭтотОбъект;
	//	НаборЗаписейНакоплениеСумм.Контрагент=Контрагент;
	//	НаборЗаписейНакоплениеСумм.КоличествоНоменклатуры=Автомобили.Итог("Количество");
	//	НаборЗаписейНакоплениеСумм.Карточка=Неопределено;
	//	НаборЗаписейНакоплениеСумм.Сторно=Ложь;
	//	Отказ=НЕ НаборЗаписейНакоплениеСумм.НакоплениеСуммы() ИЛИ Отказ;
	//КонецЕсли;
	
	Если НЕ Отказ Тогда
		//Запишем историю владельцев автомобилей
		Для Каждого ТекСтрока Из Автомобили Цикл
			Справочники.Автомобили.ЗаписьЗначенияРегистраСведения(ТекСтрока.Автомобиль, Заказчик,Перечисления.ДополнительнаяИнформацияАвтомобилей.Хозяин);
		КонецЦикла; 
	КонецЕсли;
	
	// Проверим налиие прослеживаемых товаров, которые были реализованы
	Если НЕ Отказ Тогда
		Движения.ПродажиАвтомобилей.Записать();
	КонецЕсли;
	НаборЗаписейОперацииПрослеживаемости = Движения.ОперацииПрослеживаемыхТоваров;
	НаборЗаписейОперацииПрослеживаемости.ДокументОбъект = ЭтотОбъект;
	НаборЗаписейОперацииПрослеживаемости.ТаблицаПрослеживаемыхТоваров = ОперацииСПрослеживаемымиТоварами();
	Если НЕ НаборЗаписейОперацииПрослеживаемости.ДобавитьОперациюПрослеживаемости() Тогда
		Отказ = Истина;
	КонецЕсли;
	
	Если Режим<>РежимПроведенияДокумента.Оперативный ИЛИ ЗначениеЗаполнено(ДополнительныеСвойства.АвтомобильСкладКомпанииБыл) Тогда
		// двигаем границу последовательности автомобилей
		НаборЗаписейГраницыАвтомобили = РегистрыСведений.ГраницыАвтомобили.СоздатьНаборЗаписей();
		Если Режим<>РежимПроведенияДокумента.Оперативный Тогда
			НаборЗаписейГраницыАвтомобили.СкладКомпании		= СкладКомпании;
			НаборЗаписейГраницыАвтомобили.МоментВремени		= Дата;
			НаборЗаписейГраницыАвтомобили.СкладКомпанииБыл	= ДополнительныеСвойства.АвтомобильСкладКомпанииБыл;
			НаборЗаписейГраницыАвтомобили.МоментВремениБыл	= ДополнительныеСвойства.МоментВремениБыл;
		Иначе
			НаборЗаписейГраницыАвтомобили.СкладКомпании		= ДополнительныеСвойства.АвтомобильСкладКомпанииБыл;
			НаборЗаписейГраницыАвтомобили.МоментВремени		= ДополнительныеСвойства.МоментВремениБыл;
			НаборЗаписейГраницыАвтомобили.СкладКомпанииБыл	= Неопределено;
			НаборЗаписейГраницыАвтомобили.МоментВремениБыл	= Неопределено;
		КонецЕсли;
		НаборЗаписейГраницыАвтомобили.ДокументСсылка = Ссылка;
		НаборЗаписейГраницыАвтомобили.ИзменитьГраницу();
	КонецЕсли;
	
	ДвигаемГраницу = (Режим<>РежимПроведенияДокумента.Оперативный И Движения.КомплектацияАвтомобилей.Количество()>0);
	// двигаем границу последовательности комплектаций автомобилей
	Если ДвигаемГраницу ИЛИ ЗначениеЗаполнено(ДополнительныеСвойства.АвтомобильБыл) Тогда
		НаборЗаписейГраницыКомплектация = РегистрыСведений.ГраницыКомплектация.СоздатьНаборЗаписей();
		Если ДвигаемГраницу Тогда
			ТаблицаАвтомобилей = Движения.КомплектацияАвтомобилей.Выгрузить();
			ТаблицаАвтомобилей.Свернуть("Автомобиль","");
			НаборЗаписейГраницыКомплектация.Автомобиль = ТаблицаАвтомобилей.ВыгрузитьКолонку("Автомобиль");
			НаборЗаписейГраницыКомплектация.МоментВремени  	 = Дата;
			НаборЗаписейГраницыКомплектация.АвтомобильБыл	 = ДополнительныеСвойства.АвтомобильБыл;
			НаборЗаписейГраницыКомплектация.МоментВремениБыл = ДополнительныеСвойства.МоментВремениБыл;
		Иначе
			НаборЗаписейГраницыКомплектация.Автомобиль		 = ДополнительныеСвойства.АвтомобильБыл;
			НаборЗаписейГраницыКомплектация.МоментВремени	 = ДополнительныеСвойства.МоментВремениБыл;
			НаборЗаписейГраницыКомплектация.АвтомобильБыл	 = Неопределено;
			НаборЗаписейГраницыКомплектация.МоментВремениБыл = Неопределено;
		КонецЕсли;
		НаборЗаписейГраницыКомплектация.ДокументСсылка = Ссылка;
		НаборЗаписейГраницыКомплектация.ИзменитьГраницу();
	КонецЕсли;
	
	// двигаем границу последовательности взаиморасчетов
	ДвигаемГраницу = (Режим<>РежимПроведенияДокумента.Оперативный И Движения.ВзаиморасчетыКомпании.Количество()>0);
	Если ДвигаемГраницу ИЛИ ЗначениеЗаполнено(ДополнительныеСвойства.ДоговорВзаиморасчетовБыл) Тогда
		НаборЗаписейГраницыВзаиморасчетов = РегистрыСведений.ГраницыВзаиморасчетов.СоздатьНаборЗаписей();
		Если ДвигаемГраницу Тогда
			ТаблицаДоговоров = Движения.ВзаиморасчетыКомпании.Выгрузить();
			ТаблицаДоговоров.Свернуть("ДоговорВзаиморасчетов","");
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетов = ТаблицаДоговоров.ВыгрузитьКолонку("ДоговорВзаиморасчетов");
			НаборЗаписейГраницыВзаиморасчетов.МоментВремени = Дата;
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетовБыл = ДополнительныеСвойства.ДоговорВзаиморасчетовБыл;
			НаборЗаписейГраницыВзаиморасчетов.МоментВремениБыл = ДополнительныеСвойства.МоментВремениБыл;
		Иначе
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетов = ДополнительныеСвойства.ДоговорВзаиморасчетовБыл;
			НаборЗаписейГраницыВзаиморасчетов.МоментВремени = ДополнительныеСвойства.МоментВремениБыл;
			НаборЗаписейГраницыВзаиморасчетов.ДоговорВзаиморасчетовБыл = Неопределено;
			НаборЗаписейГраницыВзаиморасчетов.МоментВремениБыл = Неопределено;
		КонецЕсли;
		НаборЗаписейГраницыВзаиморасчетов.ДокументСсылка = Ссылка;
		НаборЗаписейГраницыВзаиморасчетов.ИзменитьГраницу();
	КонецЕсли;
	
	ДвигаемГраницу = (Режим<>РежимПроведенияДокумента.Оперативный И Движения.ЗаказыАвтомобилей.Количество()>0);
	// двигаем границу последовательности заказы на автомобиль
	Если ДвигаемГраницу ИЛИ ЗначениеЗаполнено(ДополнительныеСвойства.АвтомобильЗаказБыл) Тогда
		НаборЗаписейГраницыЗаказы = РегистрыСведений.ГраницыЗаказыНаАвтомобили.СоздатьНаборЗаписей();
		Если ДвигаемГраницу Тогда
			ТаблицаАвтомобилей = Движения.ЗаказыАвтомобилей.Выгрузить();
			ТаблицаАвтомобилей.Свернуть("Автомобиль","");
			НаборЗаписейГраницыЗаказы.Автомобиль       = ТаблицаАвтомобилей.ВыгрузитьКолонку("Автомобиль");
			НаборЗаписейГраницыЗаказы.МоментВремени    = Дата;
			НаборЗаписейГраницыЗаказы.АвтомобильБыл    = ДополнительныеСвойства.АвтомобильЗаказБыл;
			НаборЗаписейГраницыЗаказы.МоментВремениБыл = ДополнительныеСвойства.МоментВремениБыл;
		Иначе
			НаборЗаписейГраницыЗаказы.Автомобиль       = ДополнительныеСвойства.АвтомобильЗаказБыл;
			НаборЗаписейГраницыЗаказы.МоментВремени    = ДополнительныеСвойства.МоментВремениБыл;
			НаборЗаписейГраницыЗаказы.АвтомобильБыл    = Неопределено;
			НаборЗаписейГраницыЗаказы.МоментВремениБыл = Неопределено;
		КонецЕсли;
		НаборЗаписейГраницыЗаказы.ДокументСсылка = Ссылка;
		НаборЗаписейГраницыЗаказы.ИзменитьГраницу();
	КонецЕсли;
	
	//bizteh(САА 23.12.2021)++
	Для каждого текАвто Из Автомобили Цикл
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	тт_РабочийЛистТрейдИн.Ссылка КАК Ссылка,
		|	тт_РабочийЛистТрейдИн.Состояние КАК Состояние
		|ИЗ
		|	Документ.тт_РабочийЛистТрейдИн КАК тт_РабочийЛистТрейдИн
		|ГДЕ
		|	тт_РабочийЛистТрейдИн.Автомобиль = &Автомобиль
		|	И НЕ тт_РабочийЛистТрейдИн.ПометкаУдаления";
		Запрос.УстановитьПараметр("Автомобиль", текАвто.Автомобиль);
		РезультатЗапроса = Запрос.Выполнить();
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			
			ТекСостояние = Перечисления.БТ_ТрейдИнСостояние.Продан;
			
			отт_РабочийЛистТрейдИн = ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект();
			Если ВыборкаДетальныеЗаписи.Состояние <> ТекСостояние Тогда
				отт_РабочийЛистТрейдИн.Состояние = ТекСостояние;  
			КонецЕсли; 
			
			Если НЕ ЗначениеЗаполнено(отт_РабочийЛистТрейдИн.ДокументПродажи) Тогда
				отт_РабочийЛистТрейдИн.ДокументПродажи = Ссылка;	
				отт_РабочийЛистТрейдИн.ЦенаПродажи = текАвто.Цена;
			КонецЕсли;
			
			отт_РабочийЛистТрейдИн.Записать(РежимЗаписиДокумента.Запись); 
			
			НоваяЗапись = РегистрыСведений.БТ_РабочийЛистТрейдИнИсторияСостояний.СоздатьМенеджерЗаписи();
			НоваяЗапись.тт_РабочийЛистТрейдИн = ВыборкаДетальныеЗаписи.Ссылка;
			НоваяЗапись.ДатаИзменения = ТекущаяДата();
			НоваяЗапись.Состояние = ТекСостояние;
			НоваяЗапись.Пользователь = ПараметрыСеанса.Пользователь;
			НоваяЗапись.Записать();			
			
		КонецЦикла; 
	КонецЦикла;
	
	//bizteh(САА 23.12.2021)--
	
	// выведем сообщения об ошибках и предупреждениях
	дкВыводРезультатовОбработки(ЭтотОбъект,Отказ);
	
	//<<БАА 21.11.2023
	Если Проведен И Не Отказ И црмРаботаСсоединением.ПодразделениеЦРМ(ПодразделениеКомпании) Тогда
		
		Для Каждого СтрокаАвтомобиля Из Автомобили Цикл
			
			Обр = Обработки.БТ_црмОтправитьАвтомобиль.Создать();
			Обр.Автомобиль = СтрокаАвтомобиля.Автомобиль;
			Обр.Статус = "SOLD";
			Обр.ДатаСтатуса = Дата;
			
			Обр.ОтправитьАвто();
			
			//БИЗТЕХ КОВАЛЬ 01.11.2024 ++
			Если ЭтотОбъект.ПодразделениеКомпании.Код <> "ЦБ000279" Тогда
				//БИЗТЕХ КОВАЛЬ 12.08.2024 изменение этапа в рабочем листе на "выдан"
				Попытка
					Обр.ЗакрытьРабочийЛистПоVIN(СтрокаАвтомобиля.Автомобиль.VIN,ЭтотОбъект.Номер);
				Исключение
				КонецПопытки;
				//БИЗТЕХ	
			КонецЕсли;
			
		КонецЦикла;	
		
	КонецЕсли;        
	
	//БИЗТЕХ КОВАЛЬ 13.02.2025 ++
	//Выставление статуса "Выбыл" в CME
	Если Проведен И Не Отказ И ПодразделениеКомпании = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000373") И Режим = РежимПроведенияДокумента.Оперативный Тогда
		ОбрCME = Обработки.БТ_ОбменCMExpert.Создать();
		Для Каждого СтрокаАвтомобиля Из Автомобили Цикл
			ОбрCME.УстановитьВыбытиеАвтомобиля(СтрокаАвтомобиля.Автомобиль.VIN,Ссылка,СтрокаАвтомобиля.СуммаВсего,Дата,Автор,Менеджер);
		КонецЦикла;
	КонецЕсли;
	//БИЗТЕХ КОВАЛЬ 13.02.2025 --

	
	//<<ЧалапАю БизТех 25.01.2025
	Если не Отказ тогда
		ЗапросКомиссия = Новый Запрос( "ВЫБРАТЬ ПЕРВЫЕ 1
		                               |	ПоступлениеАвтомобилейАвтомобили.Ссылка КАК Ссылка,
		                               |	ПоступлениеАвтомобилейАвтомобили.Ссылка.ДоговорВзаиморасчетов КАК ДоговорВзаиморасчетов,
		                               |	ПоступлениеАвтомобилейАвтомобили.Автомобиль КАК Автомобиль,
		                               |	ПоступлениеАвтомобилейАвтомобили.Ссылка.Контрагент КАК Контрагент
		                               |ИЗ
		                               |	Документ.ПоступлениеАвтомобилей.Автомобили КАК ПоступлениеАвтомобилейАвтомобили
		                               |ГДЕ
		                               |	ПоступлениеАвтомобилейАвтомобили.Автомобиль = &Автомобиль
		                               |	И ПоступлениеАвтомобилейАвтомобили.Ссылка.Проведен
		                               |	И ПоступлениеАвтомобилейАвтомобили.Ссылка.ХозОперация = &ХозОперация
		                               |	И ПоступлениеАвтомобилейАвтомобили.Ссылка.Контрагент В(&Контрагент)
		                               |
		                               |УПОРЯДОЧИТЬ ПО
		                               |	ПоступлениеАвтомобилейАвтомобили.Ссылка.Дата УБЫВ");
		ЗапросКомиссия.УстановитьПараметр("Автомобиль",Автомобили[0].Автомобиль);
		ЗапросКомиссия.УстановитьПараметр("ХозОперация",Справочники.ХозОперации.ПоступлениеАвтомобилейКомиссия); 
		
		СписокКонтров = Новый СписокЗначений;
		СписокКонтров.Добавить(Справочники.Контрагенты.НайтиПоРеквизиту("ИНН","2312205455"));     //ООО "ОПТИМА КУБАНЬ"
		СписокКонтров.Добавить(Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "3016043809"));   //ООО "ОПТИМА ВОЛГА"
		СписокКонтров.Добавить(Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", "2311336670"));   //ООО "ОПТИМА КАВКАЗ"
		ЗапросКомиссия.УстановитьПараметр("Контрагент",СписокКонтров);   
		
		РезультатКомиссия = ЗапросКомиссия.Выполнить().Выгрузить();
		
		Если РезультатКомиссия.Количество() и не ДоговорВзаиморасчетов.ПризнакАгента = Перечисления.ПризнакиАгента.Агент тогда
        	ДВОбъект = ДоговорВзаиморасчетов.ПолучитьОбъект();
			ДВОбъект.ПризнакАгента = Перечисления.ПризнакиАгента.Агент;
			ДВОбъект.НаименованиеПоставщика = РезультатКомиссия[0].Контрагент.Наименование;
			ДВОбъект.ИННПоставщика =  РезультатКомиссия[0].Контрагент.Инн;  
			Попытка
				ДВОбъект.Записать()
			исключение
				Сообщить("В договор взаиморасчетов не удалось установить признак Агента");
			КонецПопытки;
		КонецЕсли;
	КонецЕсли;
	//ЧалапАю БизТех 25.01.2025>>
	
	//<<ЧалапАю БизТех 25.03.2025 000000802   
	Если не Отказ и УстановитьАвтоматическиПодпись тогда
		МенеджерЗаписи = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Объект = ЭтотОбъект.Ссылка;
		МенеджерЗаписи.Свойство = ПланыВидовХарактеристик.СвойстваОбъектов.ЭМ_ПодписалОплату;
		МенеджерЗаписи.Значение = ЭМ_ПодписалОплату;
		МенеджерЗаписи.Записать();     
		
		МенеджерЗаписи = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Объект = ЭтотОбъект.Ссылка;
		МенеджерЗаписи.Свойство = ПланыВидовХарактеристик.СвойстваОбъектов.ЭМ_ДатаУстановки;
		МенеджерЗаписи.Значение = ЭМ_ДатаУстановки;
		МенеджерЗаписи.Записать(); 
		
		МенеджерЗаписи = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Объект = ЭтотОбъект.Ссылка;
		МенеджерЗаписи.Свойство = ПланыВидовХарактеристик.СвойстваОбъектов.ЭМ_КнопкаНажата;
		МенеджерЗаписи.Значение = ЭМ_КнопкаНажата;
		МенеджерЗаписи.Записать();
	КонецЕсли;                         
	//ЧалапАю БизТех 25.03.2025 000000802>> 
	
	//БИЗТЕХ КОВАЛЬ 25.07.2025 ++
	// Автоматическое создание взаиморасчетов по TRADE IN при проведении реализации
	Если не Отказ И Организация = Справочники.Организации.НайтиПоКоду("ЦБ000009") Тогда
		Попытка
			СоздатьВзаимозачетыTradeIn(Ссылка);
		Исключение
		КонецПопытки;
	КонецЕсли;
	
	//БИЗТЕХ КОВАЛЬ 25.07.2025 --
КонецПроцедуры // ОбработкаПроведения

////////////////////////////////////////////////////////////////////////////////
// ИСПОЛНЯЕМАЯ ЧАСТЬ МОДУЛЯ

// сохранение ссылки на коллекцию прав, настроек и окружения
Права = Неопределено;
#Если Клиент Тогда
Права = глПрава;
#КонецЕсли

ОбработкаРасчетСкидок=Обработки.РасчетСкидок.Создать();
//ОбработкаРасчетСкидок.НеРассчитыватьАвтоматическиеСкидки=Истина;

КешСебестоимостиАвтомобилейКупленныхУФизЛица = Неопределено;

ОбработкаРасчетСкидокАвтомобили=Обработки.РасчетСкидок.Создать();
ОбработкаРасчетСкидокАвтомобили.ИмяРеквизитаСкидкаНаценка="СкидкаНаценкаАвтомобили";
ОбработкаРасчетСкидокАвтомобили.ИмяРеквизитаЗначениеСкидкиНаценки="ЗначениеСкидкиНаценкиАвтомобили";
ОбработкаРасчетСкидокАвтомобили.ИмяРеквизитаСуммаСкидкиНаценки="СуммаСкидкиНаценкиАвтомобили";
ОбработкаРасчетСкидокАвтомобили.НеРассчитыватьСтрочныеСкидки=Истина;
ОбработкаРасчетСкидокАвтомобили.ИмяТабличнойЧасти="Автомобили";
ОбработкаРасчетСкидокАвтомобили.НеРассчитыватьАвтоматическиеСкидки=Истина;
