
Функция РасчитатьKPI(Знач НачПериода,Знач КонПериода,Знач Сотрудник, Знач Должность, Знач ПравилаРасчетаKPI, ТекстОшибки="", ПК=Неопределено,ФормулаСуммаПремии=ложь, Знач ФактПлан=0,Плановая=ложь,НеУчТаб=ложь,КоэфБЧ=1) Экспорт
	
	Если ФактПлан<>0 Тогда
		ФактПлан=ФактПлан*100;
	КонецЕсли;
	
	Если ПравилаРасчетаKPI.СпособРасчета=Перечисления.ВидРасчетаKPI.РучнойВвод Тогда
		
		Запрос=новый Запрос("ВЫБРАТЬ
		|	ФактическиеЗначенияKPI.Факт
		|ИЗ
		|	РегистрСведений.ФактическиеЗначенияKPI КАК ФактическиеЗначенияKPI
		|ГДЕ
		|	ФактическиеЗначенияKPI.Периодичность = &Периодичность
		|	И ФактическиеЗначенияKPI.Сотрудник = &Сотрудник
		|	И ФактическиеЗначенияKPI.KPI = &KPI
		|	И ФактическиеЗначенияKPI.Период МЕЖДУ &НачПериода И &КонПериода
		|	И (ФактическиеЗначенияKPI.ПодразделениеКомпании = &ПодразделениеКомпании или &Все)");
		
		Запрос.УстановитьПараметр("Периодичность",ПравилаРасчетаKPI.Периодичность);
		Запрос.УстановитьПараметр("Сотрудник",Сотрудник);
		Запрос.УстановитьПараметр("KPI",ПравилаРасчетаKPI);
		Запрос.УстановитьПараметр("НачПериода",НачПериода);
		Запрос.УстановитьПараметр("КонПериода",КонПериода); 
		Запрос.УстановитьПараметр("ПодразделениеКомпании",ПК);
		
		Если ПК=Неопределено Тогда
			Запрос.УстановитьПараметр("Все",истина);
		Иначе
			Запрос.УстановитьПараметр("Все",ложь);
		КонецЕсли;
		
		ТЗ=Запрос.Выполнить().Выгрузить();
		
		Если ПравилаРасчетаKPI.СреднееЗаКвартал Тогда
			
			Дел=0;
			Для Каждого ТекЭл из ТЗ Цикл
				Если ТекЭл.Факт<>0 Тогда
					Дел=Дел+1;
				КонецЕсли;
			КонецЦикла;
			
			Если дел=0 Тогда
				Дел=1;
			КонецЕсли;
			
		Иначе
			
			Дел=1;
			
		КонецЕсли;
		
		Попытка	
			РезультатФормулаСумма=ТЗ.Итог("Факт")/Дел;
		Исключение
			РезультатФормулаСумма=0;
		КонецПопытки;
		
		Возврат РезультатФормулаСумма;
		
	Иначе
		
		Если не ФормулаСуммаПремии Тогда 
			ИспФормула=ПравилаРасчетаKPI.Формула;
		Иначе
			Если Плановая Тогда
				ИспФормула=ПравилаРасчетаKPI.ФормулаДляРасчетаПлановойПремии;
			Иначе
				ИспФормула=ПравилаРасчетаKPI.ФормулаДляРасчетаПремии;
			КонецЕсли;
		КонецЕсли;
		
		СпПар=ПолучитьСписокПараметров(ИспФормула);
		СпKPI=ПолучитьСписокKPI(ИспФормула);
		СпДопПар=ПолучитьСписокДопПараметров(ИспФормула);
		
		ВыпФормулаСумма=ИспФормула;
		
		//К
		Сумма=ФактПлан;	
		СуммаСтр=Строка(Сумма);
		СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
		СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
		ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,"[Факт/План]",СуммаСтр);
		
		Для Каждого ТекПар из СпПар Цикл
			
			Попытка
				ЗаписьЖурналаРегистрации("Расчет показателя KPI", УровеньЖурналаРегистрации.Информация, , ТекПар.Значение,Строка(ТекПар.Значение) );
				
				Сумма=Справочники.ПоказателиДляРасчетаМотивации.ВыполнитьРасчетKPI(НачПериода,КонПериода,Сотрудник,Должность,ТекПар.Значение,ПравилаРасчетаKPI.Периодичность,ПК,ПравилаРасчетаKPI.СреднееЗаКвартал);
			Исключение
				Ош=ОписаниеОшибки();
				Попытка             
					Сообщить(ТекПар.Значение+" "+Строка(ТекПар.Значение)+" "+НачПериода+" "+КонПериода+" "+Сотрудник+" "+Должность+" "+ ПравилаРасчетаKPI.Периодичность+" "+Ош);
				Исключение
				КонецПопытки;
				ЗаписьЖурналаРегистрации("Расчет показателя KPI", УровеньЖурналаРегистрации.Ошибка, , ТекПар.Значение,Строка(ТекПар.Значение)+" "+НачПериода+" "+КонПериода+" "+Сотрудник+" "+Должность+" "+ ПравилаРасчетаKPI.Периодичность+" "+Ош);
			КонецПопытки;
			
			СуммаСтр=Строка(Сумма);
			СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
			СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
			ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,ТекПар.Представление,СуммаСтр);
			
		КонецЦикла;
		
		Для Каждого ТекKPI из СпKPI Цикл
			
			Сумма=Справочники.KPI.РасчитатьKPI(НачПериода,КонПериода,Сотрудник,Должность,ТекKPI.Значение,,ПК);
			СуммаСтр=Строка(Сумма);
			СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
			СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
			ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,ТекKPI.Представление,СуммаСтр);
			
		КонецЦикла;
		
		Для Каждого ТекПарKPI из СпДопПар Цикл
			
			Сумма=Справочники.ПараметрыНастройкиKPI.ПолучитьЗначениеПараметраKPI(НачПериода,КонПериода,ТекПарKPI.Значение);	
			
			СуммаСтр=Строка(Сумма);
			СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
			СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
			
			//Если КорректироватьПлан(Сотрудник,ТекПарKPI.Значение) и Не НеУчТаб Тогда
			//	
			//	ДнейПоФакту=0;
			//	ДнейПоПлану=0;
			//	Ставка=1;
			//	Доля=УзнатьДолюОтработанногоВремени(Сотрудник,ДнейПоФакту,ДнейПоПлану,НачПериода,КонПериода,Ставка,Должность);
			//	Доля=Строка(Доля*Ставка);
			//	Доля=СтрЗаменить(Доля,",",".");
			//	Доля=СтрЗаменить(Доля,Символ(160),"");
			//	СуммаСтр="("+СуммаСтр+"*"+Доля+")";
			//	
			//КонецЕсли;
			ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,ТекПарKPI.Представление,СуммаСтр);
			
		КонецЦикла;
		// ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,",",".");
		Если КоэфБЧ<>1 Тогда
			ВыпФормулаСумма=ВыпФормулаСумма+"*"+СтрЗаменить(КоэфБЧ,",",".");
		КонецЕсли;
		
		Попытка	
			РезультатФормулаСумма=Вычислить(ВыпФормулаСумма);
		Исключение
			ТекстОшибки=ПравилаРасчетаKPI.Наименование+" "+ОписаниеОшибки()+" "+ВыпФормулаСумма;
			Сообщить(ПравилаРасчетаKPI.Наименование+" "+ОписаниеОшибки()+" "+ВыпФормулаСумма);
			РезультатФормулаСумма=0;
		КонецПопытки;
		Возврат РезультатФормулаСумма;
	КонецЕсли;
	
КонецФункции

Функция ПоказатьРасчетKPI(Знач НачПериода,Знач КонПериода,Знач Сотрудник, Знач Должность, Знач ПравилаРасчетаKPI,ТекстОшибки="",ФормулаСуммаПремии=ложь,ФактПлан=100,Плановая=ложь,ПК=Неопределено) Экспорт
	
	НеУчТаб=ложь;
	Запрос=Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
	|	РасчетВыполненияKPI.Ставка
	|ИЗ
	|	Документ.РасчетВыполненияKPI.ФОТ КАК РасчетВыполненияKPI
	|ГДЕ
	|	РасчетВыполненияKPI.Ссылка.ПериодПланирования = &Период
	|	И РасчетВыполненияKPI.Сотрудник = &Сотрудник
	|	И РасчетВыполненияKPI.Ссылка.Проведен"); 
	
	Запрос.УстановитьПараметр("Период",началоМесяца(КонПериода));
	Запрос.УстановитьПараметр("Сотрудник",Сотрудник);
	
	Выб=Запрос.Выполнить().Выбрать();
	
	Если Выб.Следующий() и НЕ Документы.СоставKPI.НеУчитыватьСтавку(Должность, Сотрудник.Подразделение) Тогда
		Ставка=Выб.Ставка;
	Иначе
		
		Если Не ПустаяСтрока(Сотрудник) и ПравилаРасчетаKPI.Категория=Перечисления.КатегорияKPI.ЦелевойПоказатель Тогда
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ИнформацияОФОТСрезПоследних.Период КАК Период,
			|	ИнформацияОФОТСрезПоследних.Сотрудник КАК Сотрудник,
			|	ИнформацияОФОТСрезПоследних.Подразделение КАК Подразделение,
			|	ИнформацияОФОТСрезПоследних.Должность КАК Должность,
			|	ИнформацияОФОТСрезПоследних.СуммаОклада КАК СуммаОклада,
			|	ИнформацияОФОТСрезПоследних.Ставка КАК Ставка
			|ИЗ
			|	РегистрСведений.ИнформацияОФОТ.СрезПоследних(
			|			&НаДату,
			|			Сотрудник = &Сотрудник
			|				И Подразделение = &Подразделение
			|				И Должность = &Должность) КАК ИнформацияОФОТСрезПоследних";
			
			Запрос.УстановитьПараметр("НаДату", КонецМесяца(КонПериода));
			Запрос.УстановитьПараметр("Сотрудник", Сотрудник);
			Запрос.УстановитьПараметр("Подразделение", Сотрудник.Подразделение);
			Запрос.УстановитьПараметр("Должность", Сотрудник.Должность);
			
			РезультатЗапроса = Запрос.Выполнить();
			

			Если РезультатЗапроса.Пустой() ИЛИ Документы.СоставKPI.НеУчитыватьСтавку(Должность, Сотрудник.Подразделение) Тогда
				
				Ставка=1;
				
			Иначе
				
				ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
				
				ВыборкаДетальныеЗаписи.Следующий();
				
				Если ВыборкаДетальныеЗаписи.Ставка=0 Тогда
					
					Ставка=1;
					
				Иначе
					
					Ставка=ВыборкаДетальныеЗаписи.Ставка;
					
				КонецЕсли;
				
			КонецЕсли;
			
		Иначе
			Ставка=1;
		КонецЕсли;
		
	КонецЕсли;
	
	Если ПравилаРасчетаKPI.СпособРасчета=Перечисления.ВидРасчетаKPI.РучнойВвод Тогда
		
		Запрос=новый Запрос("ВЫБРАТЬ
		|	ФактическиеЗначенияKPI.Факт
		|ИЗ
		|	РегистрСведений.ФактическиеЗначенияKPI КАК ФактическиеЗначенияKPI
		|ГДЕ
		|	ФактическиеЗначенияKPI.Периодичность = &Периодичность
		|	И ФактическиеЗначенияKPI.Сотрудник = &Сотрудник
		|	И ФактическиеЗначенияKPI.KPI = &KPI
		|	И ФактическиеЗначенияKPI.Период МЕЖДУ &НачПериода И &КонПериода");
		
		Запрос.УстановитьПараметр("Периодичность", ПравилаРасчетаKPI.Периодичность);
		Запрос.УстановитьПараметр("Сотрудник", Сотрудник);
		Запрос.УстановитьПараметр("KPI", ПравилаРасчетаKPI);
		Запрос.УстановитьПараметр("НачПериода",НачПериода);
		Запрос.УстановитьПараметр("КонПериода",КонПериода); 
		
		ТЗ=Запрос.Выполнить().Выгрузить();
		
		Если ПравилаРасчетаKPI.СреднееЗаКвартал Тогда
			
			Дел=0;
			Для Каждого ТекЭл из ТЗ Цикл
				Если ТекЭл.Факт<>0 Тогда
					Дел=Дел+1;
				КонецЕсли;
			КонецЦикла;
			Если дел=0 Тогда
				Дел=1;
			КонецЕсли;
			
		Иначе
			
			Дел=1;
			
		КонецЕсли;
		
		Попытка	
			РезультатФормулаСумма=ТЗ.Итог("Факт")/Дел;
		Исключение
			РезультатФормулаСумма=0;
		КонецПопытки;
		
		Если Ставка<>1 Тогда
			Возврат "("+РезультатФормулаСумма+")*"+Ставка;
		Иначе
			Возврат ""+РезультатФормулаСумма;
		КонецЕсли;
		
	Иначе
		
		Если не ФормулаСуммаПремии Тогда 
			ИспФормула=ПравилаРасчетаKPI.Формула;
		Иначе
			Если Плановая Тогда
				ИспФормула=ПравилаРасчетаKPI.ФормулаДляРасчетаПлановойПремии;
			Иначе
				ИспФормула=ПравилаРасчетаKPI.ФормулаДляРасчетаПремии;
			КонецЕсли;
		КонецЕсли;
		
		//К
		Сумма=ФактПлан;	
		СуммаСтр=Строка(Сумма);
		СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
		СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
		ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,"[Факт/План]",СуммаСтр);
		
		СпПар=ПолучитьСписокПараметров(ИспФормула);
		СпKPI=ПолучитьСписокKPI(ИспФормула);
		СпДопПар=ПолучитьСписокДопПараметров(ИспФормула);
		
		ВыпФормулаСумма=ИспФормула;
		Для Каждого ТекПар из СпПар Цикл
			Если ТекПар.Представление = "[Факт/План]" И НЕ ЗначениеЗаполнено(ТекПар.Значение) тогда
				Сумма = УзнатьФактПлан(Сотрудник,НачПериода,КонПериода,ПравилаРасчетаKPI);
			Иначе	 
				Сумма=Справочники.ПоказателиДляРасчетаМотивации.ВыполнитьРасчетKPI(НачПериода,КонПериода,Сотрудник,Должность,ТекПар.Значение,ПравилаРасчетаKPI.Периодичность,ПК,ПравилаРасчетаKPI.СреднееЗаКвартал);		 
			КонецЕсли; 			 
			СуммаСтр=Строка(Сумма);
			СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
			СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
			ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,ТекПар.Представление,СуммаСтр);
		КонецЦикла;
		
		Для Каждого ТекKPI из СпKPI Цикл
			Сумма=Справочники.KPI.РасчитатьKPI(НачПериода,КонПериода,Сотрудник,Должность,ТекKPI.Значение,,ПК);
			СуммаСтр=Строка(Сумма);
			СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
			СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
			ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,ТекKPI.Представление,СуммаСтр);
		КонецЦикла;
		
		Для Каждого ТекПарKPI из СпДопПар Цикл
			Сумма=Справочники.ПараметрыНастройкиKPI.ПолучитьЗначениеПараметраKPI(НачПериода,КонПериода,ТекПарKPI.Значение);	
			СуммаСтр=Строка(Сумма);
			СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
			СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
			//Если КорректироватьПлан(Сотрудник,ТекПарKPI.Значение) и Не НеУчТаб Тогда
			//	ДнейПоФакту=0;
			//	ДнейПоПлану=0;
			//	Ставка=1;
			//	Доля=УзнатьДолюОтработанногоВремени(Сотрудник,ДнейПоФакту,ДнейПоПлану,НачПериода,КонПериода,Ставка,Должность);
			//	Доля=Строка(Доля*Ставка);
			//	Доля=СтрЗаменить(Доля,",",".");
			//	Доля=СтрЗаменить(Доля,Символ(160),"");
			//	СуммаСтр="("+СуммаСтр+"*"+Доля+")";
			//КонецЕсли;
			ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,ТекПарKPI.Представление,СуммаСтр);
			
		КонецЦикла;
		
		Если Ставка<>1 Тогда
			СтавкаСтр=Строка(Ставка);
			СтавкаСтр=СтрЗаменить(СтавкаСтр,",",".");
			ВыпФормулаСумма="("+ВыпФормулаСумма+")*"+СтавкаСтр;
		КонецЕсли;
		
		Попытка	
			РезультатФормулаСумма=Вычислить(ВыпФормулаСумма);
		Исключение
			ТекстОшибки=ПравилаРасчетаKPI.Наименование+" "+ОписаниеОшибки()+" "+ВыпФормулаСумма;
				Сообщить(ПравилаРасчетаKPI.Наименование+" "+ОписаниеОшибки()+" "+ВыпФормулаСумма);
			РезультатФормулаСумма=0;
		КонецПопытки;
		Ф=УзнатьФормулу(ПравилаРасчетаKPI,ФормулаСуммаПремии,ФактПлан);
		
		Возврат ""+Ф+"
		|
		|"+ВыпФормулаСумма+"="+РезультатФормулаСумма;
	КонецЕсли;
КонецФункции

Функция УзнатьФормулу(Показатель,ФормулаСуммаПремии=ложь,ФактПлан=1)
	
	Если Показатель.СпособРасчета=Перечисления.ВидРасчетаKPI.Автоматический Тогда
		
		Если не ФормулаСуммаПремии Тогда 
			ИспФормула=Показатель.Формула;
		Иначе
			ИспФормула=Показатель.ФормулаДляРасчетаПремии;
		КонецЕсли;
		
		//К
		ИспФормула=СтрЗаменить(ИспФормула,"[Факт/План]","K");
		
		СпПок=ПолучитьСписокПараметров(ИспФормула);
		СпДоп=ПолучитьСписокДопПараметров(ИспФормула);
		
		Ф=ИспФормула;
		Ф=Ф+", где:";
		Если ФормулаСуммаПремии Тогда
			Ф=Ф+"
			|K=Факт/План";
		КонецЕсли;
		Для Каждого ТекЭл из СпПок Цикл
			Ф=Ф+"
			|"+ТекЭл.Представление+"="+ТекЭл.Значение;
		КонецЦикла;
		Для Каждого ТекЭл из СпДоп Цикл
			Ф=Ф+"
			|"+ТекЭл.Представление+"="+ТекЭл.Значение;
		КонецЦикла;
		
		ТекстФормулы=Ф;
		Для Каждого ТекСтр из Показатель.ПоказателиДляРасчета Цикл
			Если ТипЗнч(ТекСтр.Показатель)=ТипЗнч(Справочники.ПоказателиДляРасчетаМотивации.ПустаяСсылка()) Тогда
				ТекстФормулы=СтрЗаменить(ТекстФормулы,"["+ТекСтр.Показатель.Код+"]",СокрЛП(ТекСтр.Переменная));
			ИначеЕсли ТипЗнч(ТекСтр.Показатель)=ТипЗнч(Справочники.KPI.ПустаяСсылка()) Тогда
				ТекстФормулы=СтрЗаменить(ТекстФормулы,"{"+ТекСтр.Показатель.Код+"}",СокрЛП(ТекСтр.Переменная));
			ИначеЕсли ТипЗнч(ТекСтр.Показатель)=ТипЗнч(Справочники.ПараметрыНастройкиKPI.ПустаяСсылка()) Тогда
				ТекстФормулы=СтрЗаменить(ТекстФормулы,"ͼ"+ТекСтр.Показатель.Код+"ͽ",СокрЛП(ТекСтр.Переменная));
			КонецЕсли;
		КонецЦикла;	  
		
		Возврат ТекстФормулы;
	Иначе
		Возврат "Ручной";
	КонецЕсли;
	
КонецФункции

Функция УзнатьФактПлан(Сотр = Неопределено, НачПериода, КонПериода, KPI = Неопределено)
	
	ВозврЗнач = 0;
	
	Если ЗначениеЗаполнено(Сотр) И ЗначениеЗаполнено(KPI) И ТипЗНЧ(KPI) = Тип("СправочникСсылка.KPI") тогда
		
		Запрос = Новый Запрос;		
		Если KPI.Категория = Перечисления.КатегорияKPI.ЦелевойПоказатель тогда
			Запрос.Текст = "ВЫБРАТЬ
			|	РасчетВыполненияKPIРезультатыРасчета.ПроцентВыполнения КАК ВозврЗнач
			|ИЗ
			|	Документ.РасчетВыполненияKPI.РезультатыРасчета КАК РасчетВыполненияKPIРезультатыРасчета
			|ГДЕ
			|	РасчетВыполненияKPIРезультатыРасчета.Ссылка.Дата МЕЖДУ &НачПериода И &КонПериода
			|	И РасчетВыполненияKPIРезультатыРасчета.Ссылка.Проведен
			|	И РасчетВыполненияKPIРезультатыРасчета.Сотрудник = &Сотр
			|	И РасчетВыполненияKPIРезультатыРасчета.ЦелевыеПоказатели = &KPI";				
		Иначе
			Запрос.Текст = "ВЫБРАТЬ
			|	РасчетВыполненияKPIДетализация.ФактПлан КАК ВозврЗнач
			|ИЗ
			|	Документ.РасчетВыполненияKPI.Детализация КАК РасчетВыполненияKPIДетализация
			|ГДЕ
			|	РасчетВыполненияKPIДетализация.Ссылка.Дата МЕЖДУ &НачПериода И &КонПериода
			|	И РасчетВыполненияKPIДетализация.Ссылка.Проведен
			|	И РасчетВыполненияKPIДетализация.KPI = &KPI
			|	И РасчетВыполненияKPIДетализация.Сотрудник = &Сотр";						   
		КонецЕсли;
		
		Запрос.УстановитьПараметр("НачПериода", НачПериода);			   
		Запрос.УстановитьПараметр("КонПериода", КонецДня(КонПериода));
		Запрос.УстановитьПараметр("Сотр", Сотр);
		Запрос.УстановитьПараметр("KPI", KPI);
		Рез = Запрос.Выполнить().Выбрать();
		Если Рез.Следующий() тогда
			ВозврЗнач = Рез.ВозврЗнач;
		КонецЕсли;						 
	КонецЕсли;		
	
	Возврат ВозврЗнач;
	
КонецФункции

Функция ПолучитьСписокПараметров(Знач ТекФормула)
	
	СпПар=Новый СписокЗначений;
	Найден=истина;
	Пока Найден Цикл
		Поз1=стрНайти(ТекФормула,"[");
		Поз2=стрНайти(ТекФормула,"]");
		Если Поз1>0 Тогда
			Найден=истина;
			ТекКод=Сред(ТекФормула,Поз1+1,Поз2-Поз1-1);
			ТекФормула=Сред(ТекФормула,Поз2+1);
			Эл=Справочники.ПоказателиДляРасчетаМотивации.НайтиПоКоду(ТекКод,,,);
			Если СпПар.НайтиПоЗначению(Эл)=Неопределено Тогда
				НовЗн=СпПар.Добавить();
				НовЗн.Значение=Эл;
				НовЗН.Представление="["+ТекКод+"]";
			КонецЕсли;
		Иначе
			Найден=ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат  СпПар;
	
КонецФункции

Функция ПолучитьСписокДопПараметров(Знач ТекФормула)
	
	СпПар=Новый СписокЗначений;
	Найден=истина;
	Пока Найден Цикл
		Поз1=стрНайти(ТекФормула,"ͼ");
		Поз2=стрНайти(ТекФормула,"ͽ");
		Если Поз1>0 Тогда
			Найден=истина;
			ТекКод=Сред(ТекФормула,Поз1+1,Поз2-Поз1-1);
			ТекФормула=Сред(ТекФормула,Поз2+1);
			Эл=Справочники.ПараметрыНастройкиKPI.НайтиПоКоду(ТекКод,,,);
			Если СпПар.НайтиПоЗначению(Эл)=Неопределено Тогда
				НовЗн=СпПар.Добавить();
				НовЗн.Значение=Эл;
				НовЗН.Представление="ͼ"+ТекКод+"ͽ";
			КонецЕсли;
		Иначе
			Найден=ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат  СпПар;
	
КонецФункции

Функция ПолучитьСписокKPI(Знач ТекФормула)
	
	СпKPI=Новый СписокЗначений;
	Найден=истина;
	Пока Найден Цикл
		Поз1=стрНайти(ТекФормула,"{");
		Поз2=стрНайти(ТекФормула,"}");
		Если Поз1>0 Тогда
			Найден=истина;
			ТекКод=Сред(ТекФормула,Поз1+1,Поз2-Поз1-1);
			ТекФормула=Сред(ТекФормула,Поз2+1);
			Эл=Справочники.KPI.НайтиПоКоду(ТекКод,,,);
			Если СпKPI.НайтиПоЗначению(Эл)=Неопределено Тогда
				НовЗн=СпKPI.Добавить();
				НовЗн.Значение=Эл;
				НовЗН.Представление="{"+ТекКод+"}";
			КонецЕсли;
		Иначе
			Найден=ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат СпKPI;
	
КонецФункции

Функция Постобработка(Знач ФактПлан, Знач ПравилаРасчетаKPI, ТекстОшибки="", СтруктураПостобработки = Неопределено) Экспорт
	
	ВыпФормулаСумма = ПолучитьФормулуПостобработки(ФактПлан, ПравилаРасчетаKPI, СтруктураПостобработки);
	 
	 Если ПустаяСтрока(ВыпФормулаСумма) Тогда
		 Если ПравилаРасчетаKPI.Категория=Перечисления.КатегорияKPI.ЦелевойПоказатель Тогда
			 Возврат 0;
		 Иначе
			 Возврат ФактПлан;
		 КонецЕсли;
	 КонецЕсли;
	 
	 Сумма=ФактПлан;
	 СуммаСтр=Строка(Сумма);
	 СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
	 СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
	 ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,"[Факт/План]",СуммаСтр);
	 
	 Попытка	
		 РезультатФормулаСумма=Вычислить(ВыпФормулаСумма);
	 Исключение
		 ТекстОшибки=ПравилаРасчетаKPI.Наименование+" "+ОписаниеОшибки()+" "+ВыпФормулаСумма;
		 Сообщить(ПравилаРасчетаKPI.Наименование+" "+ОписаниеОшибки()+" "+ВыпФормулаСумма);
		 РезультатФормулаСумма=0;
	 КонецПопытки;
	 
	 Возврат РезультатФормулаСумма;
	 
 КонецФункции

 Функция ПолучитьФормулуПостобработки(ФактПлан, ПравилаРасчетаKPI, СтруктураПостобработки)
	 
	ИспФормула=ПравилаРасчетаKPI.ФормулаПостобработки;
	
	Если Не ЗначениеЗаполнено(СтруктураПостобработки) Тогда
		Возврат ИспФормула;
	КонецЕсли;
	
	НачПериода 	= СтруктураПостобработки[0];
	КонПериода 	= СтруктураПостобработки[1];
	Сотрудник 	= СтруктураПостобработки[2];
	Должность 	= СтруктураПостобработки[3];
	ПК 			= СтруктураПостобработки[4];	
	
	СпПар=ПолучитьСписокПараметров(ИспФормула);
	СпKPI=ПолучитьСписокKPI(ИспФормула);
	СпДопПар=ПолучитьСписокДопПараметров(ИспФормула);
	
	ВыпФормулаСумма=ИспФормула;
	
	//К
	Сумма=ФактПлан;	
	СуммаСтр=Строка(Сумма);
	СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
	СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
	ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,"[Факт/План]",СуммаСтр);
	
	Для Каждого ТекПар из СпПар Цикл
		
		Попытка
			ЗаписьЖурналаРегистрации("Расчет показателя KPI", УровеньЖурналаРегистрации.Информация, , ТекПар.Значение,Строка(ТекПар.Значение) );
			
			Сумма=Справочники.ПоказателиДляРасчетаМотивации.ВыполнитьРасчетKPI(НачПериода,КонПериода,Сотрудник,Должность,ТекПар.Значение,ПравилаРасчетаKPI.Периодичность,ПК,ПравилаРасчетаKPI.СреднееЗаКвартал);
		Исключение
			Ош=ОписаниеОшибки();
			Сообщить(ТекПар.Значение,Строка(ТекПар.Значение)+" "+НачПериода+" "+КонПериода+" "+Сотрудник+" "+Должность+" "+ ПравилаРасчетаKPI.Периодичность+" "+Ош);
			ЗаписьЖурналаРегистрации("Расчет показателя KPI", УровеньЖурналаРегистрации.Ошибка, , ТекПар.Значение,Строка(ТекПар.Значение)+" "+НачПериода+" "+КонПериода+" "+Сотрудник+" "+Должность+" "+ ПравилаРасчетаKPI.Периодичность+" "+Ош);
		КонецПопытки;
		
		СуммаСтр=Строка(Сумма);
		СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
		СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
		ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,ТекПар.Представление,СуммаСтр);
		
	КонецЦикла;
	
	Для Каждого ТекKPI из СпKPI Цикл
		
		Сумма=Справочники.KPI.Постобработка(ФактПлан, ТекKPI.Значение, СтруктураПостобработки);
		СуммаСтр=Строка(Сумма);
		СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
		СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
		ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,ТекKPI.Представление,СуммаСтр);
		
	КонецЦикла;
	
	Для Каждого ТекПарKPI из СпДопПар Цикл
		Сумма=Справочники.ПараметрыНастройкиKPI.ПолучитьЗначениеПараметраKPI(НачПериода,КонПериода,ТекПарKPI.Значение);	
		СуммаСтр=Строка(Сумма);
		СуммаСтр=СтрЗаменить(СуммаСтр,",",".");
		СуммаСтр=СтрЗаменить(СуммаСтр,Символ(160),"");
		ВыпФормулаСумма=СтрЗаменить(ВыпФормулаСумма,ТекПарKPI.Представление,СуммаСтр);	
	КонецЦикла;
	
	Возврат ВыпФормулаСумма;

КонецФункции

 Функция РассчитатьКоэффициентБЧ(Знач ФактПлан, Знач ПравилаРасчетаKPI,ТекстОшибки="") Экспорт
	 
	 Если ПравилаРасчетаKPI.КоэффициентыБазовойЧастиОтВыполненияПлана.Количество()=0 Тогда
		 
		 РезультатФормулаСумма=Постобработка(ФактПлан/100, ПравилаРасчетаKPI);  
		 
		 Возврат РезультатФормулаСумма;
		 
	 Иначе
		 
		 ТЗ=ПравилаРасчетаKPI.КоэффициентыБазовойЧастиОтВыполненияПлана.Выгрузить();
		 
		 ТЗ.Сортировать("ПроцентВыполненияПлана Убыв");
		 
		 Для Каждого ТекСтр из ТЗ Цикл
			 Если ФактПлан>=ТекСтр.ПроцентВыполненияПлана Тогда
				 РезультатФормулаСумма=ТекСтр.Коэффициент;  
				 Возврат РезультатФормулаСумма;
			 КонецЕсли;
		 КонецЦикла;
		 
		 Возврат 0;
		 
	 КонецЕсли;
	 
 КонецФункции

