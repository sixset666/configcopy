&НаКлиенте
Процедура Авторизация(Команда)
	
	Если Модифицированность = Истина Тогда
		ВызватьИсключение("Запишите объект перед авторизацией",КатегорияОшибки.ПрочаяОшибка);
	КонецЕсли;
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("РежимВыбора",Истина);
	ПараметрыФормы.Вставить("ClientID",Объект.ClientID);
	ПараметрыФормы.Вставить("ClientSecret",Объект.ClientSecret);
	ПараметрыФормы.Вставить("refresh_token",Объект.refresh_token);
	
	ФормаАвторизации = ПолучитьФорму("Справочник.AB_УчетныеЗаписиАльфабанк.Форма.ФормаАвторизации",ПараметрыФормы,Элементы.access_token);
	//ЭтаФорма.ТолькоПросмотр = Истина;
    ФормаАвторизации.Открыть();
КонецПроцедуры

&НаКлиенте
Процедура access_tokenОбработкаВыбора(Элемент, ВыбранноеЗначение, ДополнительныеДанные, СтандартнаяОбработка)
	
	СтандартнаяОбработка=ложь;
	
	Если ЗначениеЗаполнено(ВыбранноеЗначение) Тогда
		Если ВыбранноеЗначение.Свойство("access_token") Тогда
			Объект.access_token = ВыбранноеЗначение.access_token;
		КонецЕсли;
		Если ВыбранноеЗначение.Свойство("refresh_token") Тогда
			Объект.refresh_token = ВыбранноеЗначение.refresh_token;
		КонецЕсли;
		Если ВыбранноеЗначение.Свойство("expires_in") Тогда
			Объект.expires_in = ВыбранноеЗначение.expires_in;
		КонецЕсли;
		Если ВыбранноеЗначение.Свойство("ClientSecret") Тогда
			Объект.ClientSecret = ВыбранноеЗначение.ClientSecret;
		КонецЕсли;
	КонецЕсли;
	
	ЭтаФорма.ТолькоПросмотр = Ложь;
	
КонецПроцедуры


&НаСервере
Процедура ПолучитьТокенНаСервере()
	Обработка = Обработки.AB_ОбменАльфаБанк.Создать();
	СтрТокен = Обработка.ПолучитьТокен(Объект.ClientID,Объект.ClientSecret,,КодДляВхода);
	Если ЗначениеЗаполнено(СтрТокен) Тогда
		Объект.access_token = СтрТокен.Токен;
		Объект.refresh_token = СтрТокен.ТокенОбновления;
		Объект.expires_in = СтрТокен.СрокЖизни;
	КОнецЕсли;
КонецПроцедуры


&НаКлиенте
Процедура ПолучитьТокен(Команда)
	
	Оповещение = Новый ОписаниеОповещения("ПослеВводаСтроки", 
        ЭтотОбъект);
 
    ПоказатьВводСтроки(
        Оповещение,
        , // пропускаем начальное значение
        "Введите код который вы получили на странице авторизации",
        0, // (необ.) длина
        Ложь // (необ.) многострочность
    );
КонецПроцедуры

&НаКлиенте
Процедура ПослеВводаСтроки(Результат, Параметры) Экспорт
 
    Если Не Результат = Неопределено Тогда
		КодДляВхода = Результат;
		ПолучитьТокенНаСервере();
    КонецЕсли;
 
КонецПроцедуры

