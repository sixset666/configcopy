Перем ДокументОбъект Экспорт;               // Документ объект
Перем ПодразделениеКомпании Экспорт;		// Подразделение компании
Перем ДатаИзмененияАссортимента Экспорт;    // Дата изменения ассортимента
Перем РезультатЗапросаПоТоварам Экспорт;	// РезультатЗапроса или ТаблицаЗначений.
Перем ОперацияСАссортиментом Экспорт;       // Операция с ассортиментом

// ускоряющие переменные
Перем ВалютаДокумента, КурсДокумента, ВалютаРеглУчета, КурсРеглВалюты;

// Функция установки ассортимента
Функция УстановитьАссортимент() Экспорт
	Если ТипЗнч(РезультатЗапросаПоТоварам)=Тип("РезультатЗапроса") Тогда
		РезультатЗапросаПоТоварам=РезультатЗапросаПоТоварам.Выгрузить();
	КонецЕсли;
	
	// ускоряющие переменные
	ВалютаДокумента	= ДокументОбъект.ВалютаДокумента;
	КурсДокумента	= ДокументОбъект.КурсДокумента;
	ВалютаРеглУчета	= Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();
	КурсРеглВалюты	= обКурсДляВалюты(ВалютаРеглУчета, ДокументОбъект.МоментВремени()).Курс;
	
	Для Каждого СтрокаТовар Из РезультатЗапросаПоТоварам Цикл
		ЦенаРозничная = обПересчет(СтрокаТовар.ЦенаРозничная,ВалютаДокумента,КурсДокумента,ВалютаРеглУчета,КурсРеглВалюты);
		
		НоваяЗапись	= Добавить();
		НоваяЗапись.Период					= ДатаИзмененияАссортимента;
		НоваяЗапись.Регистратор				= ДокументОбъект.Ссылка;
		НоваяЗапись.ПодразделениеКомпании	= ПодразделениеКомпании;
		НоваяЗапись.Номенклатура			= СтрокаТовар.Номенклатура;
		НоваяЗапись.Состояние				= ОперацияСАссортиментом;
		НоваяЗапись.Цена					= СтрокаТовар.Цена;
		НоваяЗапись.ПроцентНаценки			= СтрокаТовар.ПроцентНаценки;
		НоваяЗапись.ЦенаРозничная			= ЦенаРозничная;
		НоваяЗапись.СтавкаНДС				= СтрокаТовар.СтавкаНДС;
		НоваяЗапись.БазовыйАссортимент		= СтрокаТовар.БазовыйАссортимент;
	КонецЦикла;
	
	// скинем некоторые переменные
	РезультатЗапросаПоТоварам = Неопределено;
	// убиваем циклическую ссылку
	ДокументОбъект = Неопределено;
	
	Возврат Истина;
КонецФункции

// Предопределенная процедура
Процедура ПриЗаписи(Отказ, Замещение)
	
	// Зарегистрируем изменения для узлов РБД
	орРегистрацияИзменений(ЭтотОбъект);
	
КонецПроцедуры	//	ПриЗаписи()
