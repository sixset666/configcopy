Процедура Сформировать() Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	СегментыКлиентов.Ссылка КАК Ссылка
	                      |ИЗ
	                      |	Справочник.СегментыКлиентов КАК СегментыКлиентов
	                      |ГДЕ
	                      |	СегментыКлиентов.БТ_Актуальный
	                      |	И СегментыКлиентов.БТ_СценарийСегментации <> &Пустой
	                      |	И СегментыКлиентов.БТ_СценарийСегментации.Актуальный");	
	
	Запрос.УстановитьПараметр("Пустой", Справочники.БТ_СценарииСегментации.ПустаяСсылка());
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		РассчитатьСегмент(Выборка.Ссылка);
	КонецЦикла;	
	
КонецПроцедуры	

Процедура РассчитатьСегмент(Сегмент)
	
	Если 1 = 2 Тогда
		Сегмент = Справочники.СегментыКлиентов.ПустаяСсылка();
	КонецЕсли;	
	
	Запрос = Новый Запрос;
	Запрос.Текст = Сегмент.БТ_СценарийСегментации.ТекстЗапроса;
	
	Попытка      
		СписокКонтрагентов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Контрагент");
	Исключение
		Сообщить(ОписаниеОшибки());
		Возврат;
	КонецПопытки;	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Контрагенты.Ссылка КАК Клиент,
		|	СегментацияКлиентовСрезПоследних.СегментКлиента КАК СегментКлиента,
		|	ЕСТЬNULL(СегментацияКлиентовСрезПоследних.Принажлежность, ЛОЖЬ) КАК Принадлежность,
		|	ЕСТЬNULL(СегментацияКлиентовСрезПоследнихТекСегмент.Принажлежность, ЛОЖЬ) КАК ПринадлежностьСегменту
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СегментацияКлиентов.СрезПоследних(, Клиент В (&Ссылка)) КАК СегментацияКлиентовСрезПоследних
		|		ПО (СегментацияКлиентовСрезПоследних.Клиент = Контрагенты.Ссылка)
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СегментацияКлиентов.СрезПоследних(
		|				,
		|				Клиент В (&Ссылка)
		|					И СегментКлиента = &Сегмент) КАК СегментацияКлиентовСрезПоследнихТекСегмент
		|		ПО (СегментацияКлиентовСрезПоследнихТекСегмент.Клиент = Контрагенты.Ссылка)
		|ГДЕ
		|	Контрагенты.Ссылка В(&Ссылка)";
	
	Запрос.УстановитьПараметр("Ссылка", СписокКонтрагентов);
	Запрос.УстановитьПараметр("Сегмент", Сегмент);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Если ВыборкаДетальныеЗаписи.ПринадлежностьСегменту Тогда
			Продолжить;
		КонецЕсли;	   
		
		Менеджер = РегистрыСведений.СегментацияКлиентов.СоздатьМенеджерЗаписи();
		Менеджер.Период = ТекущаяДатаСеанса();
		Менеджер.Клиент = ВыборкаДетальныеЗаписи.Клиент;
		Менеджер.СегментКлиента = Сегмент; 
		Об = ВыборкаДетальныеЗаписи.Клиент.ПолучитьОбъект();
		Об.БТ_Сегмент = Сегмент;
		Об.Записать();
		Менеджер.Принажлежность = Истина;
		Менеджер.Записать();
		
	КонецЦикла; 
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СегментацияКлиентовСрезПоследних.Клиент КАК Клиент
		|ИЗ
		|	РегистрСведений.СегментацияКлиентов.СрезПоследних(
		|			,
		|			СегментКлиента = &Сегмент
		|				И НЕ Клиент В (&Ссылка)) КАК СегментацияКлиентовСрезПоследних
		|ГДЕ
		|	СегментацияКлиентовСрезПоследних.Принажлежность = ИСТИНА";
	
	Запрос.УстановитьПараметр("Сегмент", Сегмент);
	Запрос.УстановитьПараметр("Ссылка", СписокКонтрагентов);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Менеджер = РегистрыСведений.СегментацияКлиентов.СоздатьМенеджерЗаписи();
		Менеджер.Период = ТекущаяДатаСеанса();
		Менеджер.Клиент = ВыборкаДетальныеЗаписи.Клиент;
		Менеджер.СегментКлиента = Сегмент;
		Менеджер.Принажлежность = Ложь;
		Менеджер.Записать();
		
	КонецЦикла;
	
КонецПроцедуры	