Перем Выборка Экспорт;      // данные таблиц
Перем НомерТаблицы Экспорт; // 1 - приемка, 2 - выдача, 3 - невыданные, 4 - в работе
Перем ИмяОбработки Экспорт; // для сохранения настроек

#Если Клиент Тогда
	
//Возвращает строку для заполнения в ячейку HTML таблицы
Функция ПодготовитьСтроку(Строка) 
	Если обЗначениеНеЗаполнено(Строка) Тогда
		Возврат "&nbsp";
	Иначе
		Возврат Строка;
	КонецЕсли;
КонецФункции //	ПодготовитьСтроку()

//Возвращает в виде текста стиль css в зависимости от цветовой схемы 
Функция ПолучитьМакетСSS(НомерЦветовойСхемы) 
	Если НомерЦветовойСхемы = 1 Тогда
		МакетCSS = ПолучитьМакет("CSSBlue");
	ИначеЕсли НомерЦветовойСхемы = 2 Тогда
		МакетCSS = ПолучитьМакет("CSSGreen");
	ИначеЕсли НомерЦветовойСхемы = 3 Тогда
		МакетCSS = ПолучитьМакет("CSSPurple");
	Иначе
		МакетCSS = ПолучитьМакет("CSSGrey");
 	КонецЕсли;
	Возврат МакетCSS.ПолучитьТекст();	
КонецФункции //	ПолучитьМакетCSS()

//Восстановление сохраненных настроек
Функция ВосстановитьНастройки() Экспорт
	Настройка = ВосстановитьЗначение("Настройка_" + ИмяОбработки);
	Если ТипЗнч(Настройка) = Тип("Соответствие") Тогда
		Для Каждого ТекЗначение Из Настройка Цикл
			Если ТекЗначение.Ключ = "ДатаОтчета" Тогда
				Продолжить;
			КонецЕсли;
			Попытка
				ЭтотОбъект[ТекЗначение.Ключ] = ТекЗначение.Значение;
			Исключение
			КонецПопытки;
		КонецЦикла;
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
КонецФункции

//Сохранение настроек
Процедура СохранитьНастройки() Экспорт
	Настройка = Новый Соответствие();
	Для Каждого ТекРекв Из ЭтотОбъект.Метаданные().Реквизиты Цикл
		Настройка.Вставить(ТекРекв.Имя, ЭтотОбъект[ТекРекв.Имя]);
	КонецЦикла;
	СохранитьЗначение("Настройка_" + ИмяОбработки, Настройка);
КонецПроцедуры

//Заполняет начальные настройки
//
//Без параметров
//
Процедура ЗаполнитьНачальныеНастройки() Экспорт
	Если НЕ ПоказыватьПриемку И НЕ ПоказыватьВыдачу И НЕ ПоказыватьНевыданные И НЕ ПоказыватьВРаботе Тогда
		ПоказыватьПриемку = Истина;
		ПоказыватьВыдачу = Истина;
		ПоказыватьНевыданные = Истина;
		ПоказыватьВРаботе = Истина;
	КонецЕсли;
	Если ПериодСменыСтраниц = 0 Тогда
		ПериодСменыСтраниц = 7;
	КонецЕсли;
	Если СтрокНаСтраницу = 0 Тогда
		СтрокНаСтраницу = 10;
	КонецЕсли;
	Если РазмерШрифта = 0 Тогда
		РазмерШрифта = 20;	
	КонецЕсли;
	Если ЦветоваяСхема = 0 Тогда
		ЦветоваяСхема = 1;	
	КонецЕсли;

	// фильтры
	ДоступныеПоляОтбора.Очистить();
	ПолеНастройки=ДоступныеПоляОтбора.Добавить("Организация","Организация",Новый ОписаниеТипов("СправочникСсылка.Организации"));
	ПолеНастройки.Отбор=Истина;
	ПолеНастройки=ДоступныеПоляОтбора.Добавить("Подразделение","Подразделение",Новый ОписаниеТипов("СправочникСсылка.ПодразделенияКомпании"));
	ПолеНастройки.Отбор=Истина;
	ФильтрыОтчета.УстановитьДоступныеПоля(ДоступныеПоляОтбора);
	Если ФильтрыОтчета.Найти("Организация")= Неопределено Тогда
		ФильтрыОтчета.Добавить("Организация","Организация","Организация");
		ФильтрыОтчета.Организация.Значение = ПараметрыСеанса.Пользователь.Организация;
		ФильтрыОтчета.Организация.Использование = Истина;
	КонецЕсли;
	Если ФильтрыОтчета.Найти("Подразделение")= Неопределено Тогда
		ФильтрыОтчета.Добавить("Подразделение","Подразделение","Подразделение");
		ФильтрыОтчета.Подразделение.Значение = ПараметрыСеанса.Пользователь.Подразделение;
		ФильтрыОтчета.Подразделение.Использование = Истина;
	КонецЕсли;
КонецПроцедуры // ЗаполнитьНачальныеНастройки()

//Выполняет запрос и получает данные для таблицы "Приемка"
Процедура ПолучитьВыборкуПриемка() Экспорт
	
	// формируем строку фильтров виртуальной таблицы
	СтрокаУсловия="";
	Для Каждого ЭлементОтбора Из ФильтрыОтчета Цикл
		Если НЕ ЭлементОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		СтрокаУсловия = СтрокаУсловия + " И " + СтрЗаменить(СтрЗаменить(отСформироватьСтрокуВидаСравнения(ЭлементОтбора.ВидСравнения),"#","#ИмяТаблицы#" + ЭлементОтбора.ПутьКДанным),"&","&"+ЭлементОтбора.Имя);
	КонецЦикла;
	
	СтрокаУсловия = СтрЗаменить(СтрокаУсловия, "#ИмяТаблицы#", "ЗаявкаНаРемонт.");
	СтрокаУсловия = СтрЗаменить(СтрокаУсловия, "ЗаявкаНаРемонт.Подразделение", "ЗаявкаНаРемонт.ПодразделениеКомпании");
	
	// 1 пакет: получаем Заявки
	// 2 пакет: получаем Заказ-наряды, на основании заявок
	// 3 пакет: для заявок, где введены заказ-наряды ставим флаг "ЕстьЗН"
	// 4 пакет: выбираем те заявки, по которым нет заказ-нарядов
	
	Запрос = Новый Запрос();
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗаявкаНаРемонт.Ссылка КАК Заявка
	|ПОМЕСТИТЬ Заявки
	|ИЗ
	|	Документ.ЗаявкаНаРемонт КАК ЗаявкаНаРемонт
	|ГДЕ
	|	ЗаявкаНаРемонт.ДатаНачала МЕЖДУ &ДатаНачала И &ДатаКонца" + СтрокаУсловия + "
	|	И НЕ ЗаявкаНаРемонт.ПометкаУдаления
	|	И ЗаявкаНаРемонт.Состояние<>ЗНАЧЕНИЕ(Перечисление.СостоянияЗаявкиНаРемонт.Отклонено)
	|	И ЗаявкаНаРемонт.Проведен	
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаказНаряд.Ссылка КАК ЗаказНаряд
	|ПОМЕСТИТЬ ЗаказНаряды
	|ИЗ
	|	Документ.ЗаказНаряд КАК ЗаказНаряд
	|ГДЕ
	|	ЗаказНаряд.ДокументОснование В
	|			(ВЫБРАТЬ
	|				Заявки.Заявка
	|			ИЗ
	|				Заявки КАК Заявки)
	|	И НЕ ЗаказНаряд.ПометкаУдаления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА ЗаказНаряды.ЗаказНаряд ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЕстьЗН,
	|	Заявки.Заявка КАК Заявка
	|ПОМЕСТИТЬ ЗаявкиИЗаказНаряды
	|ИЗ
	|	Заявки КАК Заявки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ЗаказНаряды КАК ЗаказНаряды
	|		ПО Заявки.Заявка = ЗаказНаряды.ЗаказНаряд.ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаявкиИЗаказНаряды.Заявка
	|ИЗ
	|	ЗаявкиИЗаказНаряды КАК ЗаявкиИЗаказНаряды
	|ГДЕ
	|	НЕ ЗаявкиИЗаказНаряды.ЕстьЗН
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЗаявкиИЗаказНаряды.Заявка.ДатаНачала";
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ДатаОтчета)); 
	Запрос.УстановитьПараметр("ДатаКонца", КонецДня(ДатаОтчета)); 
	
	Для Каждого ЭлементОтбора Из ФильтрыОтчета Цикл
		// не используем элемент отбора
		Если НЕ ЭлементОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		Запрос.УстановитьПараметр(ЭлементОтбора.Имя,ЭлементОтбора.Значение);
	КонецЦикла;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
КонецПроцедуры

//Выполняет запрос и получает данные для таблицы "Выдача"
Процедура ПолучитьВыборкуВыдача() Экспорт
	
	// формируем строку фильтров виртуальной таблицы
	СтрокаУсловия="";
	Для Каждого ЭлементОтбора Из ФильтрыОтчета Цикл
		Если НЕ ЭлементОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		СтрокаУсловия = СтрокаУсловия + " И " + СтрЗаменить(СтрЗаменить(отСформироватьСтрокуВидаСравнения(ЭлементОтбора.ВидСравнения),"#","#ИмяТаблицы#" + ЭлементОтбора.ПутьКДанным),"&","&"+ЭлементОтбора.Имя);
	КонецЦикла;
	
	СтрокаУсловия = СтрЗаменить(СтрокаУсловия, "#ИмяТаблицы#", "ЗаказНаряд.");
	СтрокаУсловия = СтрЗаменить(СтрокаУсловия, "ЗаказНаряд.Подразделение", "ЗаказНаряд.ПодразделениеКомпании");
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	МАКСИМУМ(ЗаказНаряд.Ссылка) КАК ЗаказНаряд,
	               |	МАКСИМУМ(ЗаказНаряд.ПлановаяДатаВыдачи) КАК Время,
	               |	МАКСИМУМ(ЗаказНаряд.Мастер) КАК Мастер,
	               |	ЗаказНаряд.Автомобиль,
	               |	ЗаказНаряд.Заказчик,
	               |	ЗаказНаряд.Состояние
	               |ИЗ
	               |	Документ.ЗаказНаряд КАК ЗаказНаряд
	               |ГДЕ
	               |	ЗаказНаряд.ПлановаяДатаВыдачи МЕЖДУ &ДатаНачала И &ДатаКонца" + СтрокаУсловия + "
	               |	И ЗаказНаряд.Состояние <> &Состояние
	               |	И НЕ ЗаказНаряд.ПометкаУдаления
	               |	И ЗаказНаряд.ДатаОкончания < &ДатаКонца
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ЗаказНаряд.Автомобиль,
	               |	ЗаказНаряд.Заказчик,
	               |	ЗаказНаряд.Состояние
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Время";
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ДатаОтчета)); 
	Запрос.УстановитьПараметр("ДатаКонца", КонецДня(ДатаОтчета)); 
	Запрос.УстановитьПараметр("Состояние", Справочники.ВидыСостоянийЗаказНарядов.Закрыт);
	
	Для Каждого ЭлементОтбора Из ФильтрыОтчета Цикл
		// не используем элемент отбора
		Если НЕ ЭлементОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		Запрос.УстановитьПараметр(ЭлементОтбора.Имя,ЭлементОтбора.Значение);
	КонецЦикла;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
КонецПроцедуры

//Выполняет запрос и получает данные для таблицы "Невыданные"
Процедура ПолучитьВыборкуНевыданные() Экспорт
	
	// формируем строку фильтров виртуальной таблицы
	СтрокаУсловия="";
	Для Каждого ЭлементОтбора Из ФильтрыОтчета Цикл
		Если НЕ ЭлементОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		СтрокаУсловия = СтрокаУсловия + " И " + СтрЗаменить(СтрЗаменить(отСформироватьСтрокуВидаСравнения(ЭлементОтбора.ВидСравнения),"#","#ИмяТаблицы#" + ЭлементОтбора.ПутьКДанным),"&","&"+ЭлементОтбора.Имя);
	КонецЦикла;
	
	СтрокаУсловия = СтрЗаменить(СтрокаУсловия, "#ИмяТаблицы#", "ЗаказНаряд.");
	СтрокаУсловия = СтрЗаменить(СтрокаУсловия, "ЗаказНаряд.Подразделение", "ЗаказНаряд.ПодразделениеКомпании");
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	МАКСИМУМ(ЗаказНаряд.Ссылка) КАК ЗаказНаряд,
	               |	МАКСИМУМ(ЗаказНаряд.ПлановаяДатаВыдачи) КАК Дата,
	               |	МАКСИМУМ(ЗаказНаряд.Мастер) КАК Мастер,
	               |	ЗаказНаряд.Автомобиль,
	               |	ЗаказНаряд.Заказчик,
	               |	ЗаказНаряд.Состояние
	               |ИЗ
	               |	Документ.ЗаказНаряд КАК ЗаказНаряд
	               |ГДЕ
	               |	ЗаказНаряд.ПлановаяДатаВыдачи < &ДатаНачала" + СтрокаУсловия + "
	               |	И ЗаказНаряд.Состояние = &Состояние
	               |	И НЕ ЗаказНаряд.ПометкаУдаления
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ЗаказНаряд.Автомобиль,
	               |	ЗаказНаряд.Заказчик,
	               |	ЗаказНаряд.Состояние
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Дата";
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ДатаОтчета)); 
	Запрос.УстановитьПараметр("Состояние", Справочники.ВидыСостоянийЗаказНарядов.Выполнен);
	
	Для Каждого ЭлементОтбора Из ФильтрыОтчета Цикл
		// не используем элемент отбора
		Если НЕ ЭлементОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		Запрос.УстановитьПараметр(ЭлементОтбора.Имя,ЭлементОтбора.Значение);
	КонецЦикла;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
КонецПроцедуры

//Выполняет запрос и получает данные для таблицы "ВРаботе"
Процедура ПолучитьВыборкуВРаботе() Экспорт
	// формируем строку фильтров виртуальной таблицы
	СтрокаУсловия="";
	Для Каждого ЭлементОтбора Из ФильтрыОтчета Цикл
		Если НЕ ЭлементОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		СтрокаУсловия = СтрокаУсловия + " И " + СтрЗаменить(СтрЗаменить(отСформироватьСтрокуВидаСравнения(ЭлементОтбора.ВидСравнения),"#","#ИмяТаблицы#" + ЭлементОтбора.ПутьКДанным),"&","&"+ЭлементОтбора.Имя);
	КонецЦикла;
	
	СтрокаУсловия = СтрЗаменить(СтрокаУсловия, "#ИмяТаблицы#", "ЗаказНаряд.");
	СтрокаУсловия = СтрЗаменить(СтрокаУсловия, "ЗаказНаряд.Подразделение", "ЗаказНаряд.ПодразделениеКомпании");
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	МАКСИМУМ(ЗаказНаряд.Ссылка) КАК ЗаказНаряд,
	               |	МАКСИМУМ(ЗаказНаряд.ПлановаяДатаВыдачи) КАК Дата,
	               |	МАКСИМУМ(ЗаказНаряд.Мастер) КАК Мастер,
	               |	ЗаказНаряд.Автомобиль,
	               |	ЗаказНаряд.Заказчик,
	               |	ЗаказНаряд.Состояние
	               |ИЗ
	               |	Документ.ЗаказНаряд КАК ЗаказНаряд
	               |ГДЕ
	               |	ЗаказНаряд.ПлановаяДатаВыдачи < &ДатаНачала" + СтрокаУсловия + "
	               |	И ЗаказНаряд.Состояние <> Значение(Справочник.ВидыСостоянийЗаказНарядов.Выполнен)
	               |	И ЗаказНаряд.Состояние <> Значение(Справочник.ВидыСостоянийЗаказНарядов.Заявка)
	               |	И ЗаказНаряд.Состояние <> Значение(Справочник.ВидыСостоянийЗаказНарядов.Закрыт)

	               |	И НЕ ЗаказНаряд.ПометкаУдаления
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ЗаказНаряд.Автомобиль,
	               |	ЗаказНаряд.Заказчик,
	               |	ЗаказНаряд.Состояние
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Дата";
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ДатаОтчета));
	
	Для Каждого ЭлементОтбора Из ФильтрыОтчета Цикл
		// не используем элемент отбора
		Если НЕ ЭлементОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		Запрос.УстановитьПараметр(ЭлементОтбора.Имя,ЭлементОтбора.Значение);
	КонецЦикла;
	
	Выборка = Запрос.Выполнить().Выбрать();
КонецПроцедуры

//Формирует HTML код отчета для таблицы "Приемка"
Процедура СформироватьОтчетПриемка(ПолеHTMLДокумента) Экспорт 
	
	Макет = ПолучитьМакет("МакетHTML");
	Текст = Макет.ПолучитьТекст();
	
	ТекстCSS = ПолучитьМакетСSS(ЦветоваяСхема);
	Текст = СтрЗаменить(Текст, "<!--style-->", ТекстCSS);
	
	Текст = СтрЗаменить(Текст, "font-size:16px;", "font-size:"+РазмерШрифта+"px;");
	
	Текст = СтрЗаменить(Текст, "</body></html>", "");
	Текст = Текст + "<DIV class=PageHeader><span>Приемка автомобилей</span></DIV>";
	Текст = Текст + "<div class=""TableBox"">	
		|<TABLE border=2 cellSpacing=0 cellPadding=5 width=""100%"">
		|<TBODY>
		|<TR>
		|<TH scope=col>Время</TH>
		|<TH scope=col>Мастер-приемщик</TH>
		|<TH scope=col>Модель</TH>
		|<TH scope=col>Гос.номер</TH>
		|<TH scope=col>Клиент</TH>
		|<TH scope=col>Состояние</TH></TR>
		|</TR>";

	Если Выборка.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	СчетчикСтрок = 0;
	
	Пока  Истина  Цикл  
		
		СчетчикСтрок = СчетчикСтрок + 1;
		
		Заявка = Выборка.Заявка;
		
		Если СчетчикСтрок%2=0 Тогда
			Текст = Текст + "<TR class=""even"">";
		Иначе
			Текст = Текст + "<TR >";
		КонецЕсли;
		
		Текст = Текст + "<TD class=""nowrap"">" + ПодготовитьСтроку(Формат(Заявка.ДатаНачала,"ДФ=ЧЧ:мм:сс")) + "</TD>";
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Заявка.Мастер) + "</TD>";
		Если ТипЗнч(Заявка.Автомобиль) = ТипЗнч(Справочники.Автомобили.ПустаяСсылка()) Тогда
			ГосНомер = Справочники.Автомобили.ЧтениеЗначенияРегистраСведения(Заявка.Автомобиль, Перечисления.ДополнительнаяИнформацияАвтомобилей.ГосНомер,ТекущаяДата());
			Текст = Текст + "<TD>" + ПодготовитьСтроку(Заявка.Автомобиль.Модель) + "</TD>";
			Текст = Текст + "<TD class=""nowrap"">" + ПодготовитьСтроку(ГосНомер) + "</TD>";
		Иначе
			Текст = Текст + "<TD>" + ПодготовитьСтроку(Заявка.Автомобиль) + "</TD>";
			Текст = Текст + "<TD> &nbsp </TD>";
		КонецЕсли;
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Заявка.Заказчик) + "</TD>";
		ЗадержкаЧасов = Цел((ТекущаяДата()-Заявка.ДатаНачала)/3600);
		Если ЗадержкаЧасов >=1  Тогда
			Если ЗадержкаЧасов=1 ИЛИ ЗадержкаЧасов=21 Тогда
				Текст = Текст + "<TD>" + "задержка на " + ЗадержкаЧасов +  " час" + "</TD>";
			ИначеЕсли (ЗадержкаЧасов>=2 И ЗадержкаЧасов<=4) ИЛИ (ЗадержкаЧасов>=22 И ЗадержкаЧасов<=24) Тогда
				Текст = Текст + "<TD>" + "задержка на " + ЗадержкаЧасов +  " часа" + "</TD>";
			Иначе
				Текст = Текст + "<TD>" + "задержка на " + ЗадержкаЧасов +  " часов" + "</TD>";
			КонецЕсли;
		Иначе
			Текст = Текст + "<TD> ожидание клиента </TD>";
		КонецЕсли;
		
		Текст = Текст + "</TR>";
			
		Если СчетчикСтрок >= СтрокНаСтраницу Тогда
			Прервать;
		КонецЕсли;

		Если НЕ Выборка.Следующий() Тогда
			Прервать;
		КонецЕсли;

	КонецЦикла;
	
	Текст = Текст + "</TABLE></DIV></BODY></HTML>";
	
	ПолеHTMLДокумента.УстановитьТекст(Текст);
	
КонецПроцедуры

//Формирует HTML код отчета для таблицы "Выдача"
Процедура СформироватьОтчетВыдача(ПолеHTMLДокумента) Экспорт 
	
	Макет = ПолучитьМакет("МакетHTML");
	Текст = Макет.ПолучитьТекст();
	
	ТекстCSS = ПолучитьМакетСSS(ЦветоваяСхема);
	Текст = СтрЗаменить(Текст, "<!--style-->", ТекстCSS);
	
	Текст = СтрЗаменить(Текст, "font-size:16px;", "font-size:"+РазмерШрифта+"px;");
	
	Текст = СтрЗаменить(Текст, "</body></html>", "");
	Текст = Текст + "<DIV class=PageHeader><span>Выдача автомобилей</span></DIV>";
	Текст = Текст + "<div class=""TableBox"">	
		|<TABLE border=2 cellSpacing=0 cellPadding=5 width=""100%"">
		|<TBODY>
		|<TR>
		|<TH scope=col>Время</TH>
		|<TH scope=col>Мастер-приемщик</TH>
		|<TH scope=col>Модель</TH>
		|<TH scope=col>Гос.номер</TH>
		|<TH scope=col>Клиент</TH>
		|<TH scope=col>Состояние</TH></TR>
		|</TR>";
	
	Если Выборка.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	СчетчикСтрок = 0;
	
	Пока  Истина  Цикл  
		
		СчетчикСтрок = СчетчикСтрок + 1;
		
		Если СчетчикСтрок%2=0 Тогда
			Текст = Текст + "<TR class=""even"">";
		Иначе
			Текст = Текст + "<TR >";
		КонецЕсли;
		
		Текст = Текст + "<TD class=""nowrap"">" + ПодготовитьСтроку(Формат(Выборка.Время,"ДФ=ЧЧ:мм:сс")) + "</TD>";
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Мастер) + "</TD>";
		Если ТипЗнч(Выборка.Автомобиль) = ТипЗнч(Справочники.Автомобили.ПустаяСсылка()) Тогда
			ГосНомер = Справочники.Автомобили.ЧтениеЗначенияРегистраСведения(Выборка.Автомобиль, Перечисления.ДополнительнаяИнформацияАвтомобилей.ГосНомер,ТекущаяДата());
			Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Автомобиль.Модель) + "</TD>";
			Текст = Текст + "<TD class=""nowrap"">" + ПодготовитьСтроку(ГосНомер) + "</TD>";
		Иначе
			Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Автомобиль) + "</TD>";
			Текст = Текст + "<TD> &nbsp </TD>";
		КонецЕсли;
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Заказчик) + "</TD>";
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Состояние) + "</TD>";

		Текст = Текст + "</TR>";
			
		Если СчетчикСтрок >= СтрокНаСтраницу Тогда
			Прервать;
		КонецЕсли;

		Если НЕ Выборка.Следующий() Тогда
			Прервать;
		КонецЕсли;

	КонецЦикла;
	
	Текст = Текст + "</TABLE></DIV></BODY></HTML>";
	
	ПолеHTMLДокумента.УстановитьТекст(Текст);

КонецПроцедуры

//Формирует HTML код отчета для таблицы "Невыданные"
Процедура СформироватьОтчетНевыданные(ПолеHTMLДокумента) Экспорт 
	
	Макет = ПолучитьМакет("МакетHTML");
	Текст = Макет.ПолучитьТекст();
	
	ТекстCSS = ПолучитьМакетСSS(ЦветоваяСхема);
	Текст = СтрЗаменить(Текст, "<!--style-->", ТекстCSS);
	
	Текст = СтрЗаменить(Текст, "font-size:16px;", "font-size:"+РазмерШрифта+"px;");
	
	Текст = СтрЗаменить(Текст, "</body></html>", "");
	Текст = Текст + "<DIV class=PageHeader><span>Невыданные автомобили</span></DIV>";
	Текст = Текст + "<div class=""TableBox"">	
		|<TABLE border=2 cellSpacing=0 cellPadding=5 width=""100%"">
		|<TBODY>
		|<TR>
		|<TH scope=col>Дата</TH>
		|<TH scope=col>Мастер-приемщик</TH>
		|<TH scope=col>Модель</TH>
		|<TH scope=col>Гос.номер</TH>
		|<TH scope=col>Клиент</TH>
		|<TH scope=col>Состояние</TH></TR>
		|</TR>";
	
	Если Выборка.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	СчетчикСтрок = 0;
	
	Пока  Истина  Цикл  
		
		СчетчикСтрок = СчетчикСтрок + 1;
		
		Если СчетчикСтрок%2=0 Тогда
			Текст = Текст + "<TR class=""even"">";
		Иначе
			Текст = Текст + "<TR >";
		КонецЕсли;
		
		Текст = Текст + "<TD class=""nowrap"">" + ПодготовитьСтроку(Формат(Выборка.Дата,"ДФ=dd.MM.yyyy")) + "</TD>";
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Мастер) + "</TD>";
		Если ТипЗнч(Выборка.Автомобиль) = ТипЗнч(Справочники.Автомобили.ПустаяСсылка()) Тогда
			ГосНомер = Справочники.Автомобили.ЧтениеЗначенияРегистраСведения(Выборка.Автомобиль, Перечисления.ДополнительнаяИнформацияАвтомобилей.ГосНомер,ТекущаяДата());
			Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Автомобиль.Модель) + "</TD>";
			Текст = Текст + "<TD class=""nowrap"">" + ПодготовитьСтроку(ГосНомер) + "</TD>";
		Иначе
			Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Автомобиль) + "</TD>";
			Текст = Текст + "<TD> &nbsp </TD>";
		КонецЕсли;
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Заказчик) + "</TD>";
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Состояние) + "</TD>";

		Текст = Текст + "</TR>";
			
		Если СчетчикСтрок >= СтрокНаСтраницу Тогда
			Прервать;
		КонецЕсли;

		Если НЕ Выборка.Следующий() Тогда
			Прервать;
		КонецЕсли;

	КонецЦикла;
	
	Текст = Текст + "</TABLE></DIV></BODY></HTML>";
	
	ПолеHTMLДокумента.УстановитьТекст(Текст);

КонецПроцедуры

//Формирует HTML код отчета для таблицы "Невыданные"
Процедура СформироватьОтчетВРаботе(ПолеHTMLДокумента) Экспорт 
	
	Макет = ПолучитьМакет("МакетHTML");
	Текст = Макет.ПолучитьТекст();
	
	ТекстCSS = ПолучитьМакетСSS(ЦветоваяСхема);
	Текст = СтрЗаменить(Текст, "<!--style-->", ТекстCSS);
	
	Текст = СтрЗаменить(Текст, "font-size:16px;", "font-size:"+РазмерШрифта+"px;");
	
	Текст = СтрЗаменить(Текст, "</body></html>", "");
	Текст = Текст + "<DIV class=PageHeader><span>В работе</span></DIV>";
	Текст = Текст + "<div class=""TableBox"">	
		|<TABLE border=2 cellSpacing=0 cellPadding=5 width=""100%"">
		|<TBODY>
		|<TR>
		|<TH scope=col>Дата</TH>
		|<TH scope=col>Мастер-приемщик</TH>
		|<TH scope=col>Модель</TH>
		|<TH scope=col>Гос.номер</TH>
		|<TH scope=col>Клиент</TH>
		|<TH scope=col>Состояние</TH></TR>
		|</TR>";
	
	Если Выборка.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	СчетчикСтрок = 0;
	
	Пока  Истина  Цикл  
		
		СчетчикСтрок = СчетчикСтрок + 1;
		
		Если СчетчикСтрок%2=0 Тогда
			Текст = Текст + "<TR class=""even"">";
		Иначе
			Текст = Текст + "<TR >";
		КонецЕсли;
		
		Текст = Текст + "<TD class=""nowrap"">" + ПодготовитьСтроку(Формат(Выборка.Дата,"ДФ=dd.MM.yyyy")) + "</TD>";
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Мастер) + "</TD>";
		Если ТипЗнч(Выборка.Автомобиль) = ТипЗнч(Справочники.Автомобили.ПустаяСсылка()) Тогда
			ГосНомер = Справочники.Автомобили.ЧтениеЗначенияРегистраСведения(Выборка.Автомобиль, Перечисления.ДополнительнаяИнформацияАвтомобилей.ГосНомер,ТекущаяДата());
			Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Автомобиль.Модель) + "</TD>";
			Текст = Текст + "<TD class=""nowrap"">" + ПодготовитьСтроку(ГосНомер) + "</TD>";
		Иначе
			Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Автомобиль) + "</TD>";
			Текст = Текст + "<TD> &nbsp </TD>";
		КонецЕсли;
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Заказчик) + "</TD>";
		Текст = Текст + "<TD>" + ПодготовитьСтроку(Выборка.Состояние) + "</TD>";

		Текст = Текст + "</TR>";
			
		Если СчетчикСтрок >= СтрокНаСтраницу Тогда
			Прервать;
		КонецЕсли;

		Если НЕ Выборка.Следующий() Тогда
			Прервать;
		КонецЕсли;

	КонецЦикла;
	
	Текст = Текст + "</TABLE></DIV></BODY></HTML>";
	
	ПолеHTMLДокумента.УстановитьТекст(Текст);

КонецПроцедуры


#КонецЕсли

ИмяОбработки = ЭтотОбъект.Метаданные().ПолноеИмя();
ДатаОтчета=ТекущаяДата();