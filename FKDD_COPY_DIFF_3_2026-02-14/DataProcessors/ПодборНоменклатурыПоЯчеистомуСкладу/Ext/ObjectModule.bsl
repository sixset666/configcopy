Перем ДоступностьХарактеристик Экспорт; // Доступность характеристик

// Добавление строки номенклатуры в список
Функция ДобавитьНоменклатуру(ЭтаФорма, СтруктураПараметровПодбора, Номенклатура, Ячейка = Неопределено, СпроситьКоличество = Ложь, Количество=1, 
	УстановитьТекущей=ИСТИНА,ВыводитьВопросПриЗаменеЯчейки = Ложь,СпроситьХарактеристику=ЛОЖЬ) Экспорт
    	
// Если пользователь решил отказаться от продолжения добавления товара
	#Если Клиент Тогда
		ОбработкаПрерыванияПользователя();
	#КонецЕсли
	
	Если НЕ обЗначениеНеЗаполнено(Номенклатура) Тогда
		РезПроверки = дкПроверитьВозможностьОперацийСНоменклатурой(Номенклатура,ЭтаФорма.ВладелецФормы, ЭтаФорма.ВладелецФормы.ЭтотОбъект);
		
		Если (РезПроверки.ЕстьПредупреждение ИЛИ РезПроверки.ЕстьБлок) И НЕ ПустаяСтрока(РезПроверки.Сообщение) Тогда
			Сообщить(РезПроверки.Сообщение,СтатусСообщения.Внимание);
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;
	
	ОткрытаФормаКоличестваГруппы=Неопределено;
	ОткрытаФормаКоличестваСписка=Неопределено;
	СтруктураПараметровПодбора.Свойство("ОткрытаФормаКоличестваГруппы", ОткрытаФормаКоличестваГруппы);
	СтруктураПараметровПодбора.Свойство("ОткрытаФормаКоличестваСписка", ОткрытаФормаКоличестваСписка);
	Если ОткрытаФормаКоличестваГруппы=Неопределено Тогда
		ОткрытаФормаКоличестваГруппы = Ложь;
	КонецЕсли;
	
	Если ОткрытаФормаКоличестваСписка=Неопределено Тогда
		ОткрытаФормаКоличестваСписка = Ложь;
	КонецЕсли;
	
	// Получим имя реквизита табличной части "количество"
	ИмяРеквизитаКоличества = Неопределено;
	СтруктураПараметровПодбора.Свойство("ИмяРеквизитаКоличества",ИмяРеквизитаКоличества);
	Если ИмяРеквизитаКоличества = Неопределено Тогда
		ИмяРеквизитаКоличества = "Количество";
		СтруктураПараметровПодбора.Вставить("ИмяРеквизитаКоличества",ИмяРеквизитаКоличества);
	КонецЕсли;
	
	ЭтоГруппа = Номенклатура.ЭтоГруппа;
	ЭтоНабор  = (НЕ ЭтоГруппа) И (Номенклатура.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Набор);
	СтруктураПараметровПодбора.Вставить("ЭтоГруппа",ЭтоГруппа);
	СтруктураПараметровПодбора.Вставить("ЭтоНабор",	ЭтоНабор);
	СтруктураПараметровПодбора.Вставить("УстановитьТекущей",УстановитьТекущей);

	
	//если группа или набор - нужно развернуть, спросим количество один раз для всех
	Если ЭтоГруппа ИЛИ ЭтоНабор Тогда
		ЭтаФорма.МногострочныйВыбор = Номенклатура.ЭтоГруппа;
		//Если СпроситьКоличество Тогда
		//	ФормаКоличества.ВидПодбора = 1; // подбор номенклатуры по яч.складу
		//	//ЗначенияПолучены = ФормаКоличества.ОткрытьМодально();
		//	//Если ЗначенияПолучены=Неопределено Тогда
		//	//	Возврат;
		//	//КонецЕсли;
		//	//для набора единицу указали, нужно привести количество
		//	//Количество = ФормаКоличества.Количество*?(Номенклатура.ЭтоГруппа,1,ФормаКоличества.ЕдиницаИзмерения.Коэффициент);
		//	
		//	
		//	
		//КонецЕсли;
		
		ФормаКоличества=ПолучитьОбщуюФорму("ВводПараметровПодбора");
		ФормаКоличества.ИмяРеквизитаКоличества	= ИмяРеквизитаКоличества;
		ФормаКоличества.ВладелецФормы			= ЭтаФорма;
		ФормаКоличества.ЗакрыватьПриВыборе		= Ложь;
		ФормаКоличества.Количество				= 1;
		ФормаКоличества.Заголовок				= "Ввод параметров подбора для "+?(Номенклатура.ЭтоГруппа,"группы","набора")+" """ + Номенклатура + """";
		ФормаКоличества.ЕдиницаИзмерения		= ?(Номенклатура.ЭтоГруппа,Неопределено,Номенклатура.ОсновнаяЕдиницаИзмерения);
		ФормаКоличества.ВладелецЕдиницИзмерения = ?(Номенклатура.ТипНоменклатуры.ИспользованиеЕдиницИзмерения=1,Номенклатура.ТипНоменклатуры,Номенклатура);		
		ФормаКоличества.Номенклатура 			= Номенклатура;
		ФормаКоличества.ЗапрашиватьХарактеристикуНоменклатуры = Ложь;
		ФормаКоличества.ВидПодбора = 1;
		ФормаКоличества.СтруктураПараметровПодбора = СтруктураПараметровПодбора;
		
		Если СпроситьКоличество ИЛИ СпроситьХарактеристику Тогда
			//перечисляем случаи, когда открывать количество для группы не надо -
			//уже было введено для списка или должно вводиться отдельно для каждого
			Если СпроситьХарактеристику ИЛИ ОткрытаФормаКоличестваГруппы ИЛИ ОткрытаФормаКоличестваСписка Тогда
				//не спрашиваем количество для всей группы, 
				//вызываем ВыполнитьОбработкуВыбора, чтобы
				//открыть форму отдельно для каждой номенклатуры
				СтруктураВыбор = Новый Структура("Количество,ЕдиницаИзмерения,ХарактеристикаНоменклатуры");
				СтруктураВыбор.Количество 					= 1;
				СтруктураВыбор.ЕдиницаИзмерения       		= ?(ЭтоГруппа,Неопределено,Номенклатура.ОсновнаяЕдиницаИзмерения);
				СтруктураВыбор.ХарактеристикаНоменклатуры  	= Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
				СтруктураВозврата = Новый Структура("СтруктураПараметровПодбора,СтруктураВыбор",СтруктураПараметровПодбора,СтруктураВыбор);
				ВыполнитьОбработкуВыбора(ЭтаФорма,СтруктураВозврата,ФормаКоличества)
			Иначе 
				//спрашиваем только количество для всей группы
				ФормаКоличества.СтруктураПараметровПодбора.Вставить("ОткрытаФормаКоличестваГруппы",Истина);
				ФормаКоличества.Открыть();
			КонецЕсли;
		Иначе
			//если не спрашиваем ни количество, ни цену, ни характеристику, 
			//а просто добавляем каждой номенклатуры из группы по 1 штуке
			// форму не открываем, но оповестить необходимо
			СтруктураВыбор = Новый Структура("Количество,ЕдиницаИзмерения,ХарактеристикаНоменклатуры");
			СтруктураВыбор.Количество 					= Количество;
			СтруктураВыбор.ЕдиницаИзмерения       		= ?(ЭтоГруппа,Неопределено,Номенклатура.ОсновнаяЕдиницаИзмерения);
			СтруктураВыбор.ХарактеристикаНоменклатуры  	= Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
			СтруктураВозврата = Новый Структура("СтруктураПараметровПодбора,СтруктураВыбор",СтруктураПараметровПодбора,СтруктураВыбор);
			ВыполнитьОбработкуВыбора(ЭтаФорма,СтруктураВозврата,ФормаКоличества);
		КонецЕсли;

		//разворачиваем наш список
		//Если Номенклатура.ЭтоГруппа Тогда
		//	Выборка = Справочники.Номенклатура.Выбрать(Номенклатура);
		//	Пока Выборка.Следующий() Цикл
		//		ДобавитьНоменклатуру(ЭтаФорма, СтруктураПараметровПодбора, Выборка.Ссылка, Ячейка, Ложь, Количество);
		//	КонецЦикла; 
		//ИначеЕсли Номенклатура.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Набор Тогда
		//	Для каждого НоменклатураИзНабора Из Номенклатура.СоставНабора Цикл
		//		ЕдиницаНоменклатурыИзНабора = НоменклатураИзНабора.Номенклатура.ОсновнаяЕдиницаИзмерения;
		//		ДобавитьНоменклатуру(ЭтаФорма, НоменклатураИзНабора.Номенклатура,
		//		Ячейка, Ложь, НоменклатураИзНабора.Количество*Количество
		//		?(ЕдиницаНоменклатурыИзНабора.Коэффициент=0,1,ЕдиницаНоменклатурыИзНабора.Коэффициент));
		//	КонецЦикла;
		//КонецЕсли; 
		
	//добавляем одиночный элемент
	Иначе

		ОтображениеУслуг=Неопределено;
		СтруктураПараметровПодбора.Свойство("ОтображениеУслуг",ОтображениеУслуг);
		Если ОтображениеУслуг=Неопределено Тогда
			ОтображениеУслуг=Истина;
			СтруктураПараметровПодбора.Вставить("ОтображениеУслуг",ОтображениеУслуг);
		КонецЕсли;
		
		// получим табличную часть документа
		ФормаДокумента="";
		СтруктураПараметровПодбора.Свойство("ФормаДокумента",ФормаДокумента);
		Если обЗначениеНеЗаполнено(ФормаДокумента) Тогда
			ФормаДокумента=ЭтаФорма.ВладелецФормы;
			СтруктураПараметровПодбора.Вставить("ФормаДокумента",ФормаДокумента);
		КонецЕсли;
		
		ИмяТабличнойЧасти="";
		СтруктураПараметровПодбора.Свойство("ИмяТабличнойЧасти",ИмяТабличнойЧасти);
		Если обЗначениеНеЗаполнено(ИмяТабличнойЧасти) Тогда
			Попытка
				ТабличнаяЧасть=ФормаДокумента["Товары"];
				СтруктураПараметровПодбора.Вставить("ИмяТабличнойЧасти","Товары");
				ИмяТабличнойЧасти = "Товары";
			Исключение
				Возврат Неопределено;
			КонецПопытки;
		Иначе
			ТабличнаяЧасть=ФормаДокумента[ИмяТабличнойЧасти];
		КонецЕсли;
		
		ИмяТабличногоПоля="";
		СтруктураПараметровПодбора.Свойство("ИмяТабличногоПоля",ИмяТабличногоПоля);
		Если обЗначениеНеЗаполнено(ИмяТабличногоПоля) Тогда
			ИмяТабличногоПоля="Товары";
			СтруктураПараметровПодбора.Вставить("ИмяТабличногоПоля",ИмяТабличногоПоля);
		КонецЕсли;
        		
		// получим виды номенклатуры которые нельзя выбирать
		Попытка БлокироватьВидыНоменклатуры=ФормаДокумента.ВладелецФормы.ЭтотОбъект.ПолучитьСоответствиеЗапрещенныхВидовНоменклатуры(); Исключение БлокироватьВидыНоменклатуры=Неопределено; КонецПопытки;
		
		// Игнорируем запрещенную номенклатуру
		Если БлокироватьВидыНоменклатуры<>Неопределено И ТипЗнч(БлокироватьВидыНоменклатуры)=Тип("Соответствие") И БлокироватьВидыНоменклатуры.Количество()>0 Тогда
			Попытка ЕстьОшибка=(БлокироватьВидыНоменклатуры[Номенклатура.ВидНоменклатуры]<>Неопределено); Исключение ЕстьОшибка=Ложь; КонецПопытки;
			Если (НЕ ОтображениеУслуг) И (Номенклатура.ВидНоменклатуры=Перечисления.ВидыНоменклатуры.Услуга) Тогда ЕстьОшибка=Истина; КонецЕсли;
			Если ЕстьОшибка Тогда
				Возврат Неопределено;
			КонецЕсли;
		КонецЕсли;	
		
		// Оповестим о выборе документ, инициировавший подбор.
		ОбработкаВДокументе=Ложь;
		СтруктураПараметровПодбора.Свойство("ОбработкаВДокументе",ОбработкаВДокументе);
		Если ОбработкаВДокументе = Неопределено Тогда
			ОбработкаВДокументе = Ложь;
		КонецЕсли; 
		// если обработка заполнения товара находится в документе, то передадим выбор туда
		Если ОбработкаВДокументе Тогда 
			ЭтаФорма.ОповеститьОВыборе(Номенклатура);
			Возврат Неопределено;
		КонецЕсли;

		ХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
		ЕдиницаИзмерения = Номенклатура.ОсновнаяЕдиницаИзмерения;
				
		// поищем выбранную номенклатуру в таблице товаров
		МассивСтрок=Новый Массив();
		МассивСтрок=ТабличнаяЧасть.НайтиСтроки(Новый Структура("Номенклатура",Номенклатура));
		
		Если СпроситьХарактеристику ИЛИ (СпроситьКоличество И НЕ (ОткрытаФормаКоличестваГруппы ИЛИ ОткрытаФормаКоличестваСписка)) Тогда		
			//если что-то нашли нужно заполнить текущие параметры формы подбора
			Количество = 1;
			КоличествоСтарое=0;
			ЕдиницаИзмеренияСтарая=Неопределено;
			Если МассивСтрок.Количество()>0 Тогда
				//если нашли возьмем первое вхождение, чтоб оттуда утянуть единицу
				Если МассивСтрок.Количество() = 1 Тогда
					ТекущаяСтрока=МассивСтрок[0];
					Попытка КоличествоСтарое=ТекущаяСтрока[ИмяРеквизитаКоличества]; Исключение КонецПопытки;
					Попытка ЕдиницаИзмеренияСтарая=ТекущаяСтрока["ЕдиницаИзмерения"]; Исключение КонецПопытки;
					Попытка ЕдиницаИзмерения=ТекущаяСтрока["ЕдиницаИзмерения"]; Исключение КонецПопытки;
				Иначе //заполним по всем строкам и приведем к основной единице
					КоэффициентОсновнойЕдиницы = ?(Номенклатура.ОсновнаяЕдиницаИзмерения.Коэффициент = 0, 1, Номенклатура.ОсновнаяЕдиницаИзмерения.Коэффициент);
					Для Каждого ТекущаяСтрока Из МассивСтрок Цикл
						Попытка КоличествоСтарое=КоличествоСтарое+ТекущаяСтрока[ИмяРеквизитаКоличества]*ТекущаяСтрока["Коэффициент"]/КоэффициентОсновнойЕдиницы; Исключение КонецПопытки;
					КонецЦикла;
					ЕдиницаИзмеренияСтарая = Номенклатура.ОсновнаяЕдиницаИзмерения;
				КонецЕсли;
			КонецЕсли;
			//открываем форму для ввода значений
			ЭтаФорма.МногострочныйВыбор = Ложь;
			ФормаКоличества=ПолучитьОбщуюФорму("ВводПараметровПодбора");
			ФормаКоличества.ИмяРеквизитаКоличества=ИмяРеквизитаКоличества;
			ФормаКоличества.ВладелецФормы=ЭтаФорма;
			ФормаКоличества.Заголовок = "Ввод параметров подбора для "+ Номенклатура + """";
			ФормаКоличества.Количество=Количество;
			ФормаКоличества.ЕдиницаИзмерения = ЕдиницаИзмерения;
			ФормаКоличества.ЕдиницаИзмеренияСтарая = ЕдиницаИзмеренияСтарая;
			ФормаКоличества.КоличествоСтарое = КоличествоСтарое;
			ФормаКоличества.ВладелецЕдиницИзмерения = ?(Номенклатура.ТипНоменклатуры.ИспользованиеЕдиницИзмерения=1,Номенклатура.ТипНоменклатуры,Номенклатура);
			ФормаКоличества.Номенклатура 			= Номенклатура;
			ФормаКоличества.ЗапрашиватьХарактеристикуНоменклатуры = СпроситьХарактеристику;
			ФормаКоличества.ВидПодбора = 1; // подбор номенклатуры по яч.складу
			СтруктураПараметровПодбора.Вставить("ТекущаяСтрока",ТекущаяСтрока);
			ФормаКоличества.СтруктураПараметровПодбора = СтруктураПараметровПодбора;
			ФормаКоличества.Открыть();
		Иначе
			Если МассивСтрок.Количество()>0 Тогда
				ТекущаяСтрока=МассивСтрок[0];
			КонецЕсли;
			СтруктураВыбСтрока = Новый Структура("Номенклатура,Ячейка,Количество,ЕдиницаИзмерения,ХарактеристикаНоменклатуры",
				Номенклатура,Ячейка,Количество,ЕдиницаИзмерения,ХарактеристикаНоменклатуры);
			СтруктураПараметровПодбора.Вставить("СпроситьКоличество",СпроситьКоличество);
			СтруктураПараметровПодбора.Вставить("УстановитьТекущей",УстановитьТекущей);
			СтруктураПараметровПодбора.Вставить("ВыводитьВопросПриЗаменеЯчейки", ВыводитьВопросПриЗаменеЯчейки);
			ДобавитьСтрокуВДокумент(СтруктураВыбСтрока,СтруктураПараметровПодбора);
		КонецЕсли;
	КонецЕсли;	
	
	Возврат ТекущаяСтрока;

КонецФункции // ДобавитьНоменклатуру()

// Добавление выбранной строки в документ
Процедура ДобавитьСтрокуВДокумент(СтруктураВыбСтрока,СтруктураПараметровПодбора) Экспорт
	
	Номенклатура 				= СтруктураВыбСтрока.Номенклатура;
	Ячейка		 				= СтруктураВыбСтрока.Ячейка;
	Количество	 				= СтруктураВыбСтрока.Количество;
	ЕдиницаИзмерения			= СтруктураВыбСтрока.ЕдиницаИзмерения;
	ХарактеристикаНоменклатуры  = СтруктураВыбСтрока.ХарактеристикаНоменклатуры;
	// все необходимое уже использовалось ранее
	ФормаДокумента			= СтруктураПараметровПодбора.ФормаДокумента;
	ИмяТабличнойЧасти       = СтруктураПараметровПодбора.ИмяТабличнойЧасти;
	ИмяТабличногоПоля       = СтруктураПараметровПодбора.ИмяТабличногоПоля;
	ИмяРеквизитаКоличества  = СтруктураПараметровПодбора.ИмяРеквизитаКоличества;
	СпроситьКоличество      = СтруктураПараметровПодбора.СпроситьКоличество;
	ВыводитьВопросПриЗаменеЯчейки = СтруктураПараметровПодбора.ВыводитьВопросПриЗаменеЯчейки;
	УстановитьТекущей   	= СтруктураПараметровПодбора.УстановитьТекущей;
	ТабличнаяЧасть			= ФормаДокумента[ИмяТабличнойЧасти];

	#Если Клиент Тогда
		Состояние("Добавление элемента: " + Номенклатура);
	#КонецЕсли
	
	//теперь будем пробовать добавлять в документ
	//для начала поищем строку с выбранной единицей чтоб туда добавиться
	ПустаяЯчейка = Справочники.ЯчейкиХранения.ПустаяСсылка();
	Попытка
		МассивСтрок=ТабличнаяЧасть.НайтиСтроки(Новый Структура("Номенклатура,ЕдиницаИзмерения,ХарактеристикаНоменклатуры,Ячейка",Номенклатура,ЕдиницаИзмерения,ХарактеристикаНоменклатуры,Ячейка));
		Если МассивСтрок.Количество() = 0 Тогда
			МассивСтрок=ТабличнаяЧасть.НайтиСтроки(Новый Структура("Номенклатура,ЕдиницаИзмерения,ХарактеристикаНоменклатуры,Ячейка",Номенклатура,ЕдиницаИзмерения,ХарактеристикаНоменклатуры,ПустаяЯчейка));
		КонецЕсли;
	Исключение
		МассивСтрок=ТабличнаяЧасть.НайтиСтроки(Новый Структура("Номенклатура,Ячейка",Номенклатура,Ячейка));
		Если МассивСтрок.Количество() = 0 Тогда
			МассивСтрок=ТабличнаяЧасть.НайтиСтроки(Новый Структура("Номенклатура,Ячейка",Номенклатура,ПустаяЯчейка));
		КонецЕсли;
	КонецПопытки;
	НоваяСтрока = Ложь;
	Если МассивСтрок.Количество() > 0 Тогда
		ТекущаяСтрока=МассивСтрок[0];
		//количество у нас в той единице что искали, можем смело прибавить
		ТекущаяСтрока[ИмяРеквизитаКоличества] = ТекущаяСтрока[ИмяРеквизитаКоличества] + Количество;
		
		//ячейка
		Если Ячейка <> Неопределено Тогда
			Если НЕ обЗначениеНеЗаполнено(ТекущаяСтрока.Ячейка) И ТекущаяСтрока.Ячейка <> Ячейка Тогда
				#Если Клиент Тогда
					Если ВыводитьВопросПриЗаменеЯчейки Тогда
						Ответ = Вопрос("Ячейка " + СокрЛП(ТекущаяСтрока.Ячейка) + " для текущего товара будет заменена на " + СокрЛП(Ячейка) + ".
						|Продолжить?", РежимДиалогаВопрос.ОКОтмена,,КодВозвратаДиалога.ОК);
						Если Ответ = КодВозвратаДиалога.ОК Тогда
							ТекущаяСтрока.Ячейка = Ячейка;	
						КонецЕсли;				
					Иначе
						ТекущаяСтрока.Ячейка = Ячейка; 	
					КонецЕсли;
				#Иначе
					ТекущаяСтрока.Ячейка = Ячейка; 	
				#КонецЕсли
			Иначе
				ТекущаяСтрока.Ячейка = Ячейка;
			КонецЕсли; 
		КонецЕсли; 	
		
		Попытка ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + "." + ИмяРеквизитаКоличества,ТекущаяСтрока,ФормаДокумента); Исключение КонецПопытки;
	Иначе
		НоваяСтрока = Истина;
		ТекущаяСтрока=ТабличнаяЧасть.Добавить();
		ТекущаяСтрока.Номенклатура=Номенклатура;
		Попытка ТекущаяСтрока.ХарактеристикаНоменклатуры=ХарактеристикаНоменклатуры; Исключение КонецПопытки;
		ДопПараметры = Новый Структура("ЕдиницаИзмерения",ЕдиницаИзмерения);
		Попытка 
			ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + ".Номенклатура",ТекущаяСтрока,ФормаДокумента, ДопПараметры); 
		Исключение КонецПопытки;
		Попытка 
			ТекущаяСтрока.ЕдиницаИзмерения=ЕдиницаИзмерения; 
		Исключение КонецПопытки;
		Попытка 
			ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + "." + "ЕдиницаИзмерения",ТекущаяСтрока,ФормаДокумента); 
		Исключение КонецПопытки;
		Попытка 
			ТекущаяСтрока.Коэффициент=ЕдиницаИзмерения.Коэффициент; 
		Исключение КонецПопытки;
		Попытка 
			ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + "." + "Коэффициент",ТекущаяСтрока,ФормаДокумента); 
		Исключение КонецПопытки;
		Попытка 
			ТекущаяСтрока[ИмяРеквизитаКоличества]=Количество; 
		Исключение КонецПопытки;
		Попытка 
			ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + "." + ИмяРеквизитаКоличества,ТекущаяСтрока,ФормаДокумента); 
		Исключение КонецПопытки;
		Попытка 
			ТекущаяСтрока.Ячейка = Ячейка; 
		Исключение КонецПопытки;
	КонецЕсли;
	
	// Установим строку текущей
	#Если Клиент Тогда
		Если УстановитьТекущей Тогда
			ФормаДокумента.ЭлементыФормы[ИмяТабличногоПоля].ТекущаяСтрока=ТекущаяСтрока;
		КонецЕсли;
		ОтменаРедактирования=Ложь;
		дкТоварыПриОкончанииРедактирования(ФормаДокумента,ФормаДокумента.ЭлементыФормы[ИмяТабличногоПоля], НоваяСтрока, ОтменаРедактирования);
		дкВывестиЗаголовокСуммаДокумента(ФормаДокумента);
		Состояние("");
		Попытка
			ФормаДокумента.ВыводДлиныМаршрута();
		Исключение
		КонецПопытки; 		
	#КонецЕсли
	
	
	
	//////////////////////////////////////////////////////////////////////

	////теперь будем пробовать добавлять в документ
	////для начала поищем строку с выбранной единицей чтоб туда добавится
	//Попытка
	//	МассивСтрок=ТабличнаяЧасть.НайтиСтроки(
	//	Новый Структура("Номенклатура,ЕдиницаИзмерения,ХарактеристикаНоменклатуры",
	//	Номенклатура,ЕдиницаИзмерения,ХарактеристикаНоменклатуры));
	//Исключение
	//	Попытка
	//		МассивСтрок=ТабличнаяЧасть.НайтиСтроки(Новый Структура("Номенклатура",Номенклатура));
	//	Исключение
	//		МассивСтрок=ТабличнаяЧасть.НайтиСтроки(
	//		Новый Структура("НоменклатураРасход, ЕдиницаИзмеренияРасход",Номенклатура,ЕдиницаИзмерения));
	//	КонецПопытки;
	//КонецПопытки;
	//
	//НоваяСтрока = (МассивСтрок.Количество() = 0);
	//Если НоваяСтрока Тогда
	//	ТекущаяСтрока = ТабличнаяЧасть.Добавить();
	//	Попытка	
	//		ТекущаяСтрока.Номенклатура = Номенклатура;
	//		Попытка
	//			ТекущаяСтрока.ХарактеристикаНоменклатуры = ХарактеристикаНоменклатуры;
	//		Исключение КонецПопытки;
	//		Попытка
	//			ДопПараметры = Новый Структура("ЕдиницаИзмерения",ЕдиницаИзмерения);
	//			ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + ".Номенклатура",ТекущаяСтрока,ФормаДокумента, ДопПараметры);
	//			//ФормаДокумента.ОбработкаРеквизита("Товары.Номенклатура",ТекущаяСтрока,ФормаДокумента, ДопПараметры);
	//		Исключение КонецПопытки;
	//		Попытка
	//			ТекущаяСтрока[ИмяРеквизитаКоличества] = Количество;
	//			ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + ".Количество",ТекущаяСтрока,ФормаДокумента);
	//			//ФормаДокумента.ОбработкаРеквизита("Товары.Количество",ТекущаяСтрока,ФормаДокумента);
	//		Исключение КонецПопытки;
	//	Исключение
	//		ТекущаяСтрока.НоменклатураРасход = Номенклатура;
	//		Попытка
	//			ТекущаяСтрока.ХарактеристикаНоменклатурыРасход = ХарактеристикаНоменклатуры;
	//		Исключение КонецПопытки;
	//		Попытка
	//			ДопПараметры = Новый Структура("ЕдиницаИзмеренияРасход",ЕдиницаИзмерения);
	//			ФормаДокумента.ОбработкаРеквизита("Товары.НоменклатураРасход",ТекущаяСтрока,ФормаДокумента, ДопПараметры);
	//			ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти
	//			+ ".НоменклатураРасход",ТекущаяСтрока,ФормаДокумента, ДопПараметры);
	//		Исключение КонецПопытки;
	//		Если СпроситьКоличество Тогда
	//			Попытка
	//				ТекущаяСтрока.КоличествоРасход = Количество;
	//				ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + ".Количество",ТекущаяСтрока,ФормаДокумента);
	//				//ФормаДокумента.ОбработкаРеквизита("Товары.Количество",ТекущаяСтрока,ФормаДокумента);
	//			Исключение
	//			КонецПопытки; 
	//		КонецЕсли; 
	//	КонецПопытки;
	//Иначе
	//	ТекущаяСтрока = МассивСтрок[0];
	//	//количество у нас в той единице что искали, можем смело прибавить
	//	Попытка
	//		ТекущаяСтрока[ИмяРеквизитаКоличества] = ТекущаяСтрока[ИмяРеквизитаКоличества] + Количество;
	//		ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + "." + ИмяРеквизитаКоличества,ТекущаяСтрока,ФормаДокумента);
	//		//ФормаДокумента.ОбработкаРеквизита("Товары."+ИмяРеквизитаКоличества,ТекущаяСтрока,ФормаДокумента);
	//	Исключение
	//		Попытка
	//			ТекущаяСтрока.КоличествоРасход = ТекущаяСтрока.КоличествоРасход + Количество;
	//			ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + ".КоличествоРасход",ТекущаяСтрока,ФормаДокумента);
	//			//ФормаДокумента.ОбработкаРеквизита("Товары.КоличествоРасход",ТекущаяСтрока,ФормаДокумента);
	//		Исключение
	//		КонецПопытки; 
	//	КонецПопытки;
	//КонецЕсли;
	//
	//Если СпроситьЦену Тогда
	//	// пересчитаем цену
	//	Попытка 
	//		ТекущаяСтрока.Цена = Цена;
	//		ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + ".Цена",ТекущаяСтрока,ФормаДокумента); 
	//		//ФормаДокумента.ОбработкаРеквизита("Товары.Цена",ТекущаяСтрока,ФормаДокумента); 
	//	Исключение 
	//		Попытка 
	//			ТекущаяСтрока.ЦенаРасход = Цена;
	//			ФормаДокумента.ОбработкаРеквизита(ИмяТабличнойЧасти + ".ЦенаРасход",ТекущаяСтрока,ФормаДокумента); 
	//			//ФормаДокумента.ОбработкаРеквизита("Товары.ЦенаРасход",ТекущаяСтрока,ФормаДокумента); 
	//		Исключение 
	//		КонецПопытки;
	//	КонецПопытки; 	
	//КонецЕсли;
	//
	//// Вызовем обработчики изменения в форме
	//#Если Клиент Тогда
	//	// Проверим заполняется табличная часть документа или таблица значений
	//	// (если таблица значений, то обработчики изменения, нам не нужны)
	//	Если НЕ ТипЗнч(ФормаДокумента[ИмяТабличнойЧасти]) = Тип("ТаблицаЗначений") Тогда
	//		// Установим строку текущей
	//		Если УстановитьТекущей Тогда
	//			ФормаДокумента.ЭлементыФормы[ИмяТабличногоПоля].ТекущаяСтрока=ТекущаяСтрока;
	//		КонецЕсли;
	//		
	//		ОтменаРедактирования=ЛОЖЬ;
	//		дкТоварыПриОкончанииРедактирования(ФормаДокумента,
	//		ФормаДокумента.ЭлементыФормы[ИмяТабличногоПоля], НоваяСтрока, ОтменаРедактирования);
	//		дкВывестиЗаголовокСуммаДокумента(ФормаДокумента);
	//		//Состояние("");
	//	КонецЕсли;
	//#КонецЕсли

КонецПроцедуры

// Обработка выбора
Процедура ВыполнитьОбработкуВыбора(ЭтаФорма,ЗначениеВыбора, Источник) Экспорт
	
	Если ТипЗнч(ЗначениеВыбора) = Тип("Структура") Тогда
		ЭлементыФормы = ЭтаФорма.ЭлементыФормы;
		ФормаКоличества = Источник;
		СтруктураПараметровПодбора = ЗначениеВыбора.СтруктураПараметровПодбора; // входящая структура
		СтруктураВыбор = ЗначениеВыбора.СтруктураВыбор; // выходящая структура
		
		Если ЗначениеВыбора.СтруктураПараметровПодбора.Свойство("ИмяТабличногоПоляИсточника") Тогда
			НоменклатураДляПодбора = ЭлементыФормы[ЗначениеВыбора.СтруктураПараметровПодбора.ИмяТабличногоПоляИсточника];
		Иначе
			НоменклатураДляПодбора = ЭлементыФормы.НоменклатураДляПодбора;
		КонецЕсли;
		
		КоличествоВыделенныхСтрок = НоменклатураДляПодбора.ВыделенныеСтроки.Количество();
		Количество = СтруктураВыбор.Количество;
		ОткрытаФормаКоличестваГруппы=Неопределено;
		ОткрытаФормаКоличестваСписка=Неопределено;
		СтруктураПараметровПодбора.Свойство("ОткрытаФормаКоличестваГруппы", ОткрытаФормаКоличестваГруппы);
		СтруктураПараметровПодбора.Свойство("ОткрытаФормаКоличестваСписка", ОткрытаФормаКоличестваСписка);
		Если ОткрытаФормаКоличестваГруппы=Неопределено Тогда
			ОткрытаФормаКоличестваГруппы = Ложь;
		КонецЕсли;
		
		Если ОткрытаФормаКоличестваСписка=Неопределено Тогда
			ОткрытаФормаКоличестваСписка = Ложь;
		КонецЕсли;
		ВыводитьВопросПриЗаменеЯчейки = неопределено;
		СтруктураПараметровПодбора.Свойство("ВыводитьВопросПриЗаменеЯчейки", ВыводитьВопросПриЗаменеЯчейки);
		Если ВыводитьВопросПриЗаменеЯчейки=Неопределено Тогда
			ВыводитьВопросПриЗаменеЯчейки = Ложь;
		КонецЕсли;
		
		ВыделенныеСтроки = НоменклатураДляПодбора.ВыделенныеСтроки;
		Попытка
			Ячейка = ЭтаФорма.ЭлементыФормы["СписокЯчеек"].ТекущаяСтрока;
		Исключение
			Ячейка = Справочники.ЯчейкиХранения.ПустаяСсылка();
		КонецПопытки;
		
		Если (КоличествоВыделенныхСтрок > 1) И ОткрытаФормаКоличестваСписка И ЗначениеВыбора.СтруктураПараметровПодбора.Флажок Тогда
			//Добавляем по каждой строке
			//тут количество уже было введено для списка, значит не нужно спрашивать ничего больше,
			//формы тоже не будут открываться
			//флажок указывает, что при следующем вызове ВыполнитьОбработкуВыбора данный код не должен
			//выполниться
			Для каждого ВыделеннаяСтрока Из ВыделенныеСтроки Цикл
				СтруктураПараметровПодбора.Вставить("Флажок",Ложь);
				ТекущаяСтрока = ДобавитьНоменклатуру(ЭтаФорма,  СтруктураПараметровПодбора, ВыделеннаяСтрока,Ячейка,ЛОЖЬ,Количество, ЛОЖЬ);
				СтандартнаяОбработка = ЛОЖЬ;
			КонецЦикла; 
		    Флажок = Ложь;
		Иначе 
			Номенклатура = ФормаКоличества.Номенклатура;
			Попытка
				СпроситьКоличество = ЭтаФорма.ЗапрашиватьКоличество;
			Исключение
				СпроситьКоличество = Ложь;
			КонецПопытки;
			Попытка
				СпроситьХарактеристику = ЭтаФорма.ЗапрашиватьХарактеристикуНоменклатуры И Номенклатура.ТипНоменклатуры.ИспользованиеХарактеристик <= 2 И ДоступностьХарактеристик;
			Исключение
				СпроситьХарактеристику = Ложь;
			КонецПопытки;
			// вызов из рекурсии функции ДобавитьНоменклатуру()
			//если группа или набор - нужно развернуть, спросим количество один раз для всех
			ЭтоГруппа = Номенклатура.ЭтоГруппа;
			ЭтоНабор  = СтруктураПараметровПодбора.ЭтоНабор;
			УстановитьТекущей  = СтруктураПараметровПодбора.УстановитьТекущей;
			Если ЭтоГруппа ИЛИ ЭтоНабор Тогда
				ЭтаФорма.МногострочныйВыбор = ЭтоГруппа;
				//разворачиваем наш список
				Если ЭтоГруппа Тогда
					ТекстЗапроса = 
					"ВЫБРАТЬ
					|	ЕСТЬNULL(НоменклатураСоставНабора.Номенклатура, НоменклатураСписок.Ссылка) КАК Ссылка,
					|	СУММА(ВЫБОР
					|			КОГДА НоменклатураСоставНабора.Номенклатура ЕСТЬ NULL 
					|				ТОГДА &Количество
					|			ИНАЧЕ 
					|				ВЫБОР
					|					КОГДА ЕСТЬNULL(НоменклатураСоставНабора.Номенклатура.ОсновнаяЕдиницаИзмерения.Коэффициент, 0) = 0
					|						ТОГДА НоменклатураСоставНабора.Количество * &Количество
					|					ИНАЧЕ НоменклатураСоставНабора.Количество * &Количество / НоменклатураСоставНабора.Номенклатура.ОсновнаяЕдиницаИзмерения.Коэффициент
					|				КОНЕЦ
					|		КОНЕЦ) КАК Количество
					|ИЗ
					|	Справочник.Номенклатура КАК НоменклатураСписок
					|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура.СоставНабора КАК НоменклатураСоставНабора
					|		ПО (НоменклатураСписок.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Набор))
					|			И НоменклатураСоставНабора.Ссылка = НоменклатураСписок.Ссылка
					|ГДЕ
					|	(НЕ НоменклатураСписок.ЭтоГруппа)
					|	И НоменклатураСписок.Родитель В ИЕРАРХИИ(&Родитель)
					|
					|СГРУППИРОВАТЬ ПО
					|	ЕСТЬNULL(НоменклатураСоставНабора.Номенклатура, НоменклатураСписок.Ссылка)";
					Запрос = Новый Запрос(ТекстЗапроса);
					Запрос.УстановитьПараметр("Родитель",Номенклатура);
					Запрос.УстановитьПараметр("Количество",Количество);

					Для Каждого ТекТовар Из Запрос.Выполнить().Выгрузить() Цикл
						ТекущаяСтрока = ДобавитьНоменклатуру(ЭтаФорма,  СтруктураПараметровПодбора, ТекТовар.Ссылка, Ячейка, ЛОЖЬ, 
							ТекТовар.Количество, УстановитьТекущей, ВыводитьВопросПриЗаменеЯчейки, Ложь);
					КонецЦикла;
					
				ИначеЕсли ЭтоНабор Тогда
					Для каждого НоменклатураИзНабора Из Номенклатура.СоставНабора Цикл
						ЕдиницаНоменклатурыИзНабора = НоменклатураИзНабора.Номенклатура.ОсновнаяЕдиницаИзмерения;
						ТекущаяСтрока = ДобавитьНоменклатуру(ЭтаФорма, СтруктураПараметровПодбора, НоменклатураИзНабора.Номенклатура,Ячейка,ЛОЖЬ,
							НоменклатураИзНабора.Количество*Количество/?(ЕдиницаНоменклатурыИзНабора.Коэффициент=0,1,ЕдиницаНоменклатурыИзНабора.Коэффициент),УстановитьТекущей,
							ВыводитьВопросПриЗаменеЯчейки, СпроситьХарактеристику);
					КонецЦикла;
				КонецЕсли;
				//добавляем одиночный элемент
			Иначе
				Если СпроситьКоличество ИЛИ СпроситьХарактеристику Тогда
					// гот. результат
					Количество 					= СтруктураВыбор.Количество;
					ЕдиницаИзмерения 			= СтруктураВыбор.ЕдиницаИзмерения;
					ХарактеристикаНоменклатуры 	= СтруктураВыбор.ХарактеристикаНоменклатуры;
				КонецЕсли;
			КонецЕсли;
			
			// поместим в структуру
			Если НЕ ЭтоНабор И НЕ ЭтоГруппа Тогда
				СтруктураВыбСтрока = Новый Структура("Номенклатура,Ячейка,Количество,ЕдиницаИзмерения,ХарактеристикаНоменклатуры",
					Номенклатура,Ячейка,Количество,ЕдиницаИзмерения,ХарактеристикаНоменклатуры);
				СтруктураПараметровПодбора.Вставить("СпроситьКоличество",СпроситьКоличество);
				СтруктураПараметровПодбора.Вставить("УстановитьТекущей",УстановитьТекущей);
				СтруктураПараметровПодбора.Вставить("ВыводитьВопросПриЗаменеЯчейки",ВыводитьВопросПриЗаменеЯчейки);
				ДобавитьСтрокуВДокумент(СтруктураВыбСтрока,СтруктураПараметровПодбора);
			КонецЕсли; 
			
			// ЗАВЕРШЕНИЕ
			// Покажем текущую строку
			Если ТекущаяСтрока<>Неопределено Тогда
				// Получим табличную часть документа
				ФормаДокумента="";
				Если (НЕ СтруктураПараметровПодбора.Свойство("ФормаДокумента",ФормаДокумента))ИЛИ(обЗначениеНеЗаполнено(ФормаДокумента)) Тогда
					ФормаДокумента=ЭтаФорма.ВладелецФормы;
				КонецЕсли;
				ИмяТабличногоПоля="";
				Если (НЕ СтруктураПараметровПодбора.Свойство("ИмяТабличногоПоля",ИмяТабличногоПоля))ИЛИ(обЗначениеНеЗаполнено(ИмяТабличногоПоля)) Тогда
					ИмяТабличногоПоля="Товары";
				КонецЕсли;
				// Установим текущей новую строку
				ФормаДокумента.ЭлементыФормы[ИмяТабличногоПоля].ТекущаяСтрока=ТекущаяСтрока;
			КонецЕсли;
		КонецЕсли; 
	КонецЕсли;
	
КонецПроцедуры


